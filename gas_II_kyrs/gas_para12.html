<!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 12 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø—ñ—Ä–Ω–æ—ó –∞—Ä–º–∞—Ç—É—Ä–∏ –π —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ñ–≤: –∫–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å, —Ç—Ä–µ–Ω–∞–∂–µ—Ä ‚Äú–æ–±–µ—Ä—Ç—ñ–≤‚Äù, –≥—Ä–∞—Ñ—ñ–∫ —Ç–∏—Å–∫—É P_in/P_out, —Ñ–æ—Ç–æ, –ø—ñ–¥–ø–∏—Å, 58 –º–º, CSV/TXT, QR</title>
<meta name="description" content="–ü—Ä–∞–∫—Ç–∏–∫–∞: –∫–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å –∫—Ä–∞–Ω—ñ–≤ –∑ –º—ñ–∂–∑–∞–º–∫–∞–º–∏, —Ç—Ä–µ–Ω–∞–∂–µ—Ä –æ–±–µ—Ä—Ç—ñ–≤ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ (–∫—Ä–æ–∫–∏/–æ–±–µ—Ä—Ç–∏/–≤—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è), –∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ —Ç–∏—Å–∫—É –¥–æ/–ø—ñ—Å–ª—è, KPI (—Å–µ—Ç–ø–æ–π–Ω—Ç/–¥—Ä—É–ø/—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å), —Ñ–æ—Ç–æ, NFC/ID, –ø—ñ–¥–ø–∏—Å, —á–µ–∫ 58 –º–º, CSV/TXT, QR.">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.scheme{display:block;width:100%;height:220px;background:#0b1220;border:1px dashed var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
.sigWrap{border:1px dashed var(--line);border-radius:12px;padding:8px;background:#0c182a}
#sig{background:#0b1220;border:1px solid var(--line);border-radius:8px;touch-action:none}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.valve{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:2px 10px;margin:3px 3px 0 0}
.valve[data-state="open"]{background:#0f2f1e;border-color:#1d3e2a}
.valve[data-state="closed"]{background:#2a1212;border-color:#5a1f1f}
.dialWrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.dial{width:140px;height:140px;border:1px solid var(--line);border-radius:50%;position:relative;background:#0b1220}
.dial .hand{position:absolute;left:50%;top:50%;width:2px;height:50px;background:#e6eef9;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(0deg);border-radius:2px}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
</style>
<link rel="canonical" href="https://edlab.pp.ua/gas_II_kyrs/gas_para12.html"><meta property="og:type" content="article"><meta property="og:title" content="–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 12"><meta property="og:description" content="–í—ñ–¥–ø—Ä–∞—Ü—å–æ–≤—É—î–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π –ø—É—Å–∫ —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ —Ç–∏—Å–∫—É. –Ñ –∫–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å –∫—Ä–∞–Ω—ñ–≤ —ñ–∑ –º—ñ–∂–∑–∞–º–∫–∞–º–∏ –±–µ–∑–ø–µ–∫–∏, —Ç—Ä–µ–Ω–∞–∂–µ—Ä –æ–±–µ—Ä—Ç—ñ–≤ (–∫—Ä–æ–∫–∏/–æ–±–µ—Ä—Ç–∏, % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è),"><meta property="og:url" content="https://edlab.pp.ua/gas_II_kyrs/gas_para12.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 12","description":"–í—ñ–¥–ø—Ä–∞—Ü—å–æ–≤—É—î–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π –ø—É—Å–∫ —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ —Ç–∏—Å–∫—É. –Ñ –∫–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å –∫—Ä–∞–Ω—ñ–≤ —ñ–∑ –º—ñ–∂–∑–∞–º–∫–∞–º–∏ –±–µ–∑–ø–µ–∫–∏, —Ç—Ä–µ–Ω–∞–∂–µ—Ä –æ–±–µ—Ä—Ç—ñ–≤ (–∫—Ä–æ–∫–∏/–æ–±–µ—Ä—Ç–∏, % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è),","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/gas_II_kyrs/gas_para12.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üß∞‚öôÔ∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 12 ‚Äî –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø—ñ—Ä–Ω–æ—ó –∞—Ä–º–∞—Ç—É—Ä–∏ –π —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ñ–≤</b><br>
        <span class="badge">–ö–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å ‚Üí —Ç—Ä–µ–Ω–∞–∂–µ—Ä –æ–±–µ—Ä—Ç—ñ–≤ ‚Üí –≥—Ä–∞—Ñ—ñ–∫ P_in/P_out ‚Üí KPI ‚Üí —Ñ–æ—Ç–æ ‚Üí NFC/ID ‚Üí –ø—ñ–¥–ø–∏—Å ‚Üí —á–µ–∫ 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –°—Ü–µ–Ω–∞—Ä—ñ–π</h2>
    <p>–í—ñ–¥–ø—Ä–∞—Ü—å–æ–≤—É—î–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π –ø—É—Å–∫ —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ —Ç–∏—Å–∫—É. –Ñ <b>–∫–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å –∫—Ä–∞–Ω—ñ–≤</b> —ñ–∑ –º—ñ–∂–∑–∞–º–∫–∞–º–∏ –±–µ–∑–ø–µ–∫–∏, <b>—Ç—Ä–µ–Ω–∞–∂–µ—Ä –æ–±–µ—Ä—Ç—ñ–≤</b> (–∫—Ä–æ–∫–∏/–æ–±–µ—Ä—Ç–∏, % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è), 
      <b>–∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ —Ç–∏—Å–∫—É</b> (–¥–æ/–ø—ñ—Å–ª—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞), –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ <b>KPI</b>: —Å–µ—Ç–ø–æ–π–Ω—Ç, –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è, <i>droop</i>, —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å. –î–æ–¥–∞—î–º–æ <b>—Ñ–æ—Ç–æ</b>, <b>NFC/ID</b>, <b>–ø—ñ–¥–ø–∏—Å</b>, –¥—Ä—É–∫—É—î–º–æ <b>—á–µ–∫ 58 –º–º</b>, –µ–∫—Å–ø–æ—Ä—Ç—É—î–º–æ <b>CSV/TXT</b>, –≥–µ–Ω–µ—Ä—É—î–º–æ <b>QR</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. ..., –∫–æ—Ç–µ–ª—å–Ω—è/–∫–≤–∞—Ä—Ç–∏—Ä–∞"></label>
      <label style="flex:1">–†–µ–≥—É–ª—è—Ç–æ—Ä
        <select id="regType" class="input">
          <option selected="">RG/2M</option><option>Fisher</option><option>Elster</option><option>–Ü–Ω—à–∏–π</option>
        </select>
      </label>
      <label style="flex:1">DN<input id="dn" class="input" type="number" step="1" value="25"></label>
      <label style="flex:1">–°–µ—Ç–ø–æ–π–Ω—Ç P_out, –º–±–∞—Ä<input id="sp" class="input" type="number" step="0.1" value="20.0"></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."></label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ -->
    <div class="card">
      <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ø–æ–ª–æ–∂–µ–Ω—å –∑–∞–ø—ñ—Ä–Ω–æ—ó –∞—Ä–º–∞—Ç—É—Ä–∏ (–º—ñ–∂–∑–∞–º–∫–∏)</h2>
      <div class="block">
        <div id="valves" class="row"></div>
        <small class="muted">–ü—Ä–∞–≤–∏–ª–æ –±–µ–∑–ø–µ–∫–∏: —Å–ø–µ—Ä—à—É <b>–≤–≤—ñ–¥–Ω–∏–π</b> –∑–∞–∫—Ä–∏—Ç–∏–π, –ø—Ä–æ–¥—É–≤–∫–∞, –ø–æ—Ç—ñ–º –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–∏—Ç–æ–∫—ñ–≤, —Ç–æ–¥—ñ –ø–æ —á–µ—Ä–∑—ñ ‚Äî –¥–æ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, –ø—ñ—Å–ª—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, –ø—Ä–∏–ª–∞–¥.</small>
      </div>

      <h2 style="margin-top:10px">üß≠ –¢—Ä–µ–Ω–∞–∂–µ—Ä ‚Äú–æ–±–µ—Ä—Ç—ñ–≤‚Äù —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞</h2>
      <div class="block">
        <div class="dialWrap">
          <div class="dial"><div id="hand" class="hand"></div></div>
          <div>
            <div class="row">
              <button class="btn" id="turnMinus10">‚ü≤ ‚àí10¬∞</button>
              <button class="btn" id="turnMinus">‚ü≤ ‚àí1 –∫—Ä–æ–∫</button>
              <button class="btn" id="turnPlus">‚ü≥ +1 –∫—Ä–æ–∫</button>
              <button class="btn" id="turnPlus10">‚ü≥ +10¬∞</button>
            </div>
            <div class="row">
              <label>–ö—Ä–æ–∫, ¬∞<input id="stepDeg" class="input" type="number" step="0.1" value="6.0"></label>
              <label>–ú–∞–∫—Å. —Ö—ñ–¥, –æ–±–µ—Ä—Ç—ñ–≤<input id="maxRev" class="input" type="number" step="0.1" value="10.0"></label>
              <button class="btn secondary" id="resetDial">üßπ –°–∫–∏–Ω—É—Ç–∏</button>
            </div>
            <div class="kpi" style="margin-top:6px">
              <span class="tag ok">–ö—Ä–æ–∫—ñ–≤: <b id="stepsCnt">0</b></span>
              <span class="tag warn">–û–±–µ—Ä—Ç–∏: <b id="revCnt">0.00</b></span>
              <span class="tag bad">% –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è: <b id="openPct">0</b>%</span>
            </div>
          </div>
        </div>
      </div>

      <h2 style="margin-top:10px">üõ∞Ô∏è –ï–º—É–ª—è—Ç–æ—Ä–∏ —Ç–∏—Å–∫—É —Ç–∞ –∑–∞–ø–∏—Å–∏</h2>
      <div class="block">
        <div class="row">
          <label style="flex:1">P_in, –º–±–∞—Ä<input id="pin" type="range" class="input" min="0" max="100" step="0.5" value="30.0"></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∏–π P_in: <b id="pinNum">30.0</b></span>
          <button class="btn" id="markPin">üìç –¢–æ—á–∫–∞ P_in</button>
        </div>
        <div class="row">
          <label style="flex:1">P_out, –º–±–∞—Ä<input id="pout" type="range" class="input" min="0" max="60" step="0.1" value="18.5"></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∏–π P_out: <b id="poutNum">18.5</b></span>
          <button class="btn" id="markPout">üìç –¢–æ—á–∫–∞ P_out</button>
          <button class="btn secondary" id="clearSeries">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
        </div>
        <div class="row">
          <label>–ü–æ—Ä—ñ–≥ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ, –º–±–∞—Ä<input id="stab" type="number" class="input" step="0.1" value="0.5"></label>
          <label>–î–æ–≤–∂–∏–Ω–∞ –≤—ñ–∫–Ω–∞ —Å—Ç–∞–±—ñ–ª—å–Ω., —Å<input id="win" type="number" class="input" step="1" value="15"></label>
          <button class="btn secondary" id="applyKPI">‚öôÔ∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ KPI</button>
        </div>
        <div class="kpi" style="margin-top:6px">
          <span class="tag ok">–°–µ—Ç–ø–æ–π–Ω—Ç: <b id="spVal">20.0</b> –º–±–∞—Ä</span>
          <span class="tag warn">Œî –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: <b id="devVal">‚Äî</b> –º–±–∞—Ä</span>
          <span class="tag warn">Droop: <b id="droopVal">‚Äî</b> %</span>
          <span class="tag bad">–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å: <b id="stabVal">‚Äî</b></span>
        </div>
      </div>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ (P_in / P_out)</h2>
      <div class="canvasWrap"><canvas id="chart" class="chart" width="520" height="240"></canvas></div>
      <div class="row">
        <button class="btn" id="autoTune">üéõÔ∏è –Ü–º—ñ—Ç—É–≤–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (10 c)</button>
      </div>

      <h2 style="margin-top:10px">üé• –§–æ—Ç–æ (3 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay="" playsinline="" muted=""></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="overview">üì∑ –ó–∞–≥–∞–ª—å–Ω–∏–π –≤–∏–≥–ª—è–¥</button>
          <button class="btn" data-kind="nameplate">üì∑ –¢–∞–±–ª–∏—á–∫–∞ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞</button>
          <button class="btn" data-kind="gauge">üì∑ –ú–∞–Ω–æ–º–µ—Ç—Ä</button><br>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">‚úçÔ∏è –ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>
      <div class="sigWrap">
        <canvas id="sig" width="520" height="200"></canvas>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="sigClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
          <button class="btn" id="sigSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
          <span class="badge" id="sigStat">–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î</span>
        </div>
      </div>

      <h2 style="margin-top:10px">üì∂ NFC / ID –≤—É–∑–ª–∞</h2>
      <div class="block">
        <div class="row">
          <button class="btn" id="nfcBtn">üì∂ NFC</button>
          <input id="asset" class="input" placeholder="ID —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞/–≤—É–∑–ª–∞ (—è–∫—â–æ NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)">
          <button class="btn secondary" id="saveAsset">üíæ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <span class="badge" id="nfcs">–°—Ç–∞—Ç—É—Å NFC: –æ—á—ñ–∫—É—î—Ç—å—Å—è</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞ —Å—Ç–∞–Ω</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>ID –≤—É–∑–ª–∞</th><td id="mAsset">‚Äî</td></tr>
          <tr><th>–†–µ–≥—É–ª—è—Ç–æ—Ä</th><td id="mReg">‚Äî</td></tr>
          <tr><th>DN</th><td id="mDN">‚Äî</td></tr>
          <tr><th>–°–µ—Ç–ø–æ–π–Ω—Ç</th><td id="mSP">‚Äî</td></tr>
          <tr><th>–ö—Ä–∞–Ω–∏ (–≤–≤—ñ–¥/–¥–æR/–ø—ñ—Å–ª—èR/–ø—Ä–∏–ª–∞–¥)</th><td id="mValves">‚Äî</td></tr>
          <tr><th>–ö—Ä–æ–∫–∏/–æ–±–µ—Ä—Ç–∏/%</th><td id="mDial">0 / 0.00 / 0%</td></tr>
          <tr><th>–¢–æ—á–æ–∫ P_in / P_out</th><td id="mPts">0 / 0</td></tr>
          <tr><th>KPI (Œî, droop, —Å—Ç–∞–±.)</th><td id="mKPI">‚Äî</td></tr>
          <tr><th>–§–æ—Ç–æ (3)</th><td id="mPhotos">0 / 0 / 0</td></tr>
          <tr><th>–ü—ñ–¥–ø–∏—Å</th><td id="mSig">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—Ä–æ–∫–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å + –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ ‚Äî <b>2</b></li>
        <li>–ö–∞—Ä—Ç–∞ –∫—Ä–∞–Ω—ñ–≤ —É –±–µ–∑–ø–µ—á–Ω—ñ–π –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó ‚Äî <b>2</b></li>
        <li>–¢—Ä–µ–Ω–∞–∂–µ—Ä: ‚â•1 –æ–±–µ—Ä—Ç —ñ ‚âß40% –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è ‚Äî <b>1</b></li>
        <li>–ì—Ä–∞—Ñ—ñ–∫: ‚â•8 —Ç–æ—á–æ–∫ —Å—É–º–∞—Ä–Ω–æ ‚Äî <b>1</b></li>
        <li>KPI –≤ –º–µ–∂–∞—Ö (|Œî|‚â§1 –º–±–∞—Ä, droop‚â§10%, —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å=Stable) ‚Äî <b>3</b></li>
        <li>–§–æ—Ç–æ (3) –∞–±–æ –ø—ñ–¥–ø–∏—Å ‚Äî <b>1</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case/Asset)</button>
      </div>
      <div id="rc" class="receipt" hidden=""></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:240px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –°—Ç–∞–Ω –∫–µ–π—Å—É
let CASE_ID=null, ASSET_ID=null;
let photos={overview:null, nameplate:null, gauge:null};
let sigUrl=null;

// ===== –ö–µ–π—Å
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||''); const tech=clean($('#tech').value||''); const day=$('#day').value;
  if(!addr||!tech||!day){ alert('–í–∫–∞–∂–∏ –∞–¥—Ä–µ—Å—É, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ç–∞ –¥–∞—Ç—É'); return; }
  CASE_ID='R-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent='–ö–µ–π—Å: '+CASE_ID;
  log(`–ö–µ–π—Å ${CASE_ID}: ${addr}, ${$('#regType').value}, DN${$('#dn').value}, SP=${$('#sp').value}–º–±–∞—Ä, ${tech}, ${day}`);
  updateMetrics(); computeKPI(); drawChart(); drawScheme();
});

// ===== –ö–∞—Ä—Ç–∞ –∫–ª–∞–ø–∞–Ω—ñ–≤ / –º—ñ–∂–∑–∞–º–∫–∏
const VALVES_DEF=[
  {k:'inlet', name:'–í–≤—ñ–¥–Ω–∏–π –∫—Ä–∞–Ω', state:'closed'},
  {k:'toReg', name:'–ü–µ—Ä–µ–¥ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–º', state:'closed'},
  {k:'afterReg', name:'–ü—ñ—Å–ª—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞', state:'closed'},
  {k:'appliance', name:'–ü—Ä–∏–ª–∞–¥/–ø–∞–ª—å–Ω–∏–∫', state:'closed'}
];
let VALVES = VALVES_DEF.map(v=>({ ...v }));
function renderValves(){
  const box=$('#valves'); box.innerHTML='';
  VALVES.forEach(v=>{
    const el=document.createElement('div');
    el.className='valve'; el.dataset.key=v.k; el.dataset.state=v.state;
    el.innerHTML=`<b>${v.name}</b><span class="badge mono">${v.state==='open'?'OPEN':'CLOSED'}</span><button class="btn secondary">üîÅ –ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏</button>`;
    box.appendChild(el);
  });
}
renderValves();
$('#valves').addEventListener('click',(e)=>{
  const wrap=e.target.closest('.valve'); if(!wrap) return;
  if(!e.target.matches('button')) return;
  const key=wrap.dataset.key; const v=VALVES.find(x=>x.k===key);
  // –ú—ñ–∂–∑–∞–º–∫–∏: –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏ "appliance", —è–∫—â–æ –ø—ñ—Å–ª—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ –∑–∞–∫—Ä–∏—Ç–∏–π; –Ω–µ –º–æ–∂–Ω–∞ "toReg", —è–∫—â–æ "inlet" –∑–∞–∫—Ä–∏—Ç–∏–π (—ñ–º—ñ—Ç–∞—Ü—ñ—è –±–µ–∑–ø–µ–∫–∏)
  if(v.state==='closed'){
    if(key==='toReg' && VALVES.find(x=>x.k==='inlet').state!=='open'){ alert('–°–ø–µ—Ä—à—É –≤—ñ–¥–∫—Ä–∏–π –≤–≤—ñ–¥–Ω–∏–π –∫—Ä–∞–Ω'); return; }
    if(key==='afterReg' && VALVES.find(x=>x.k==='toReg').state!=='open'){ alert('–°–ø–µ—Ä—à—É –≤—ñ–¥–∫—Ä–∏–π –∫—Ä–∞–Ω –ø–µ—Ä–µ–¥ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–º'); return; }
    if(key==='appliance' && VALVES.find(x=>x.k==='afterReg').state!=='open'){ alert('–°–ø–µ—Ä—à—É –≤—ñ–¥–∫—Ä–∏–π –∫—Ä–∞–Ω –ø—ñ—Å–ª—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞'); return; }
    v.state='open';
  }else{
    // –ó–∞–∫—Ä–∏—Ç—Ç—è –¥–æ–∑–≤–æ–ª–µ–Ω–æ –±—É–¥—å-–¥–µ
    v.state='closed';
  }
  wrap.dataset.state=v.state;
  wrap.querySelector('.badge').textContent = v.state==='open'?'OPEN':'CLOSED';
  log(`–ö—Ä–∞–Ω "${v.name}": ${v.state.toUpperCase()}`);
  drawScheme(); updateMetrics();
});
function valvesSummary(){
  return VALVES.map(v => (v.state==='open'?1:0)).join('/');
}

// ===== –°—Ö–µ–º–∞ (—Å–ø—Ä–æ—â–µ–Ω–∞)
const scheme=document.createElement('canvas'); scheme.className='scheme'; scheme.width=520; scheme.height=220;
const schemeWrap=document.createElement('div'); schemeWrap.className='canvasWrap'; schemeWrap.appendChild(scheme);
document.querySelector('.card .block').appendChild(document.createElement('div')); // –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–≤–Ω—é–≤–∞—á
function drawScheme(){
  const c=scheme, g=c.getContext('2d'); const W=c.width,H=c.height; g.clearRect(0,0,W,H);
  g.strokeStyle='#223049'; g.strokeRect(0.5,0.5,W-1,H-1);
  const y=H/2, x1=40, x2=160, x3=300, x4=440;
  // —Ç—Ä—É–±–∞
  g.strokeStyle='#93c5fd'; g.lineWidth=6; g.beginPath(); g.moveTo(x1,y); g.lineTo(x4,y); g.stroke();
  // –≤—É–∑–ª–∏: inlet, toReg, regulator box, afterReg, appliance
  function valve(x,label,key){
    const open=VALVES.find(v=>v.k===key)?.state==='open';
    g.fillStyle=open?'#22c55e':'#f87171';
    g.fillRect(x-8,y-18,16,36);
    g.fillStyle='#e5e7eb'; g.font='11px ui-monospace'; g.fillText(label, x-30, y-24);
  }
  valve(x1+20,'–í–≤—ñ–¥', 'inlet');
  valve(x2-20,'–ü–µ—Ä–µ–¥ R','toReg');
  // —Ä–µ–≥—É–ª—è—Ç–æ—Ä
  g.fillStyle='#0e2a47'; g.strokeStyle='#3b82f6'; g.lineWidth=2;
  g.fillRect(x2,y-28,90,56); g.strokeRect(x2,y-28,90,56);
  g.fillStyle='#e5e7eb'; g.font='12px ui-monospace'; g.fillText('REG', x2+30, y+4);
  valve(x3+20,'–ü—ñ—Å–ª—è R','afterReg');
  g.fillStyle='#eab308'; g.beginPath(); g.arc(x4-10,y,10,0,Math.PI*2); g.fill();
  g.fillStyle='#e5e7eb'; g.fillText('–ü—Ä–∏–ª–∞–¥', x4-26, y-24);
}
drawScheme();
document.querySelectorAll('h2')[1].after(schemeWrap);

// ===== –¢—Ä–µ–Ω–∞–∂–µ—Ä "–æ–±–µ—Ä—Ç—ñ–≤"
let angle=0; // -180..+180
let steps=0;
function updateDial(){
  const stepDeg=parseFloat($('#stepDeg').value)||6.0;
  const maxRev=parseFloat($('#maxRev').value)||10.0;
  const degPerRev=360;
  const rev=steps*stepDeg/degPerRev;
  const pct=Math.max(0, Math.min(100, Math.round( (rev/maxRev)*100 )));
  $('#revCnt').textContent=rev.toFixed(2);
  $('#stepsCnt').textContent=String(steps);
  $('#openPct').textContent=String(pct);
  $('#hand').style.transform=`translate(-50%,-100%) rotate(${angle}deg)`;
  // –ø—Ä–æ—Å—Ç–∞ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å P_out –≤—ñ–¥ % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ç–∞ P_in (–¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è)
  const pin=parseFloat($('#pin').value)||0;
  const sp=parseFloat($('#sp').value)||0;
  const target = Math.min(sp+5, pin*0.9, Math.max(0, pct/100*pin)); // –Ω–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å
  $('#pout').value = target.toFixed(1);
  $('#poutNum').textContent = target.toFixed(1);
  log(`Dial: –∫—Ä–æ–∫—ñ–≤=${steps}, –æ–±–µ—Ä—Ç—ñ–≤=${rev.toFixed(2)}, –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è=${pct}% ‚Üí P_out‚âà${target.toFixed(1)} –º–±–∞—Ä`);
  updateMetrics(); computeKPI();
}
$('#turnPlus').addEventListener('click',()=>{ const d=parseFloat($('#stepDeg').value)||6; steps++; angle=Math.min(180, angle+d); updateDial(); });
$('#turnMinus').addEventListener('click',()=>{ const d=parseFloat($('#stepDeg').value)||6; steps=Math.max(0,steps-1); angle=Math.max(-180, angle-d); updateDial(); });
$('#turnPlus10').addEventListener('click',()=>{ angle=Math.min(180, angle+10); steps+=Math.round(10/((parseFloat($('#stepDeg').value)||6))); updateDial(); });
$('#turnMinus10').addEventListener('click',()=>{ angle=Math.max(-180, angle-10); steps=Math.max(0, steps-Math.round(10/((parseFloat($('#stepDeg').value)||6)))); updateDial(); });
$('#resetDial').addEventListener('click',()=>{ steps=0; angle=0; updateDial(); });

// ===== –ï–º—É–ª—è—Ç–æ—Ä–∏/—Å–µ—Ä—ñ—ó/–≥—Ä–∞—Ñ—ñ–∫
const chart=$('#chart'), gc=chart.getContext('2d');
let t0=null, sPin=[], sPout=[];
function addPoint(series,v){
  const now=Date.now(); if(!t0) t0=now; series.push({t:now,v}); drawChart(); computeKPI(); updateMetrics();
}
$('#pin').addEventListener('input',()=>{ $('#pinNum').textContent=$('#pin').value; });
$('#pout').addEventListener('input',()=>{ $('#poutNum').textContent=$('#pout').value; });
$('#markPin').addEventListener('click',()=>{ const v=parseFloat($('#pin').value); addPoint(sPin,v); log('–¢–æ—á–∫–∞ P_in: '+v.toFixed(1)+' –º–±–∞—Ä'); });
$('#markPout').addEventListener('click',()=>{ const v=parseFloat($('#pout').value); addPoint(sPout,v); log('–¢–æ—á–∫–∞ P_out: '+v.toFixed(1)+' –º–±–∞—Ä'); });
$('#clearSeries').addEventListener('click',()=>{ sPin=[]; sPout=[]; t0=null; drawChart(); computeKPI(); updateMetrics(); log('–û—á–∏—â–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫'); });

function drawChart(){
  const W=chart.width,H=chart.height; gc.clearRect(0,0,W,H);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-50,top=24,bottom=H-30;
  gc.strokeStyle='#1f2a44'; for(let y=0;y<5;y++){ const yy=top+y*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,yy); gc.lineTo(right,yy); gc.stroke(); }
  if((sPin.length+sPout.length)<2){ gc.fillStyle='#94a3b8'; gc.fillText('–î–æ–¥–∞–≤–∞–π —Ç–æ—á–∫–∏ P_in —Ç–∞ P_out –∞–±–æ –∑–∞–ø—É—Å—Ç–∏ —ñ–º—ñ—Ç–∞—Ü—ñ—é', left+8, top+14); return; }
  const all=[...sPin.map(x=>x.t), ...sPout.map(x=>x.t)].sort((a,b)=>a-b);
  const tMin=all[0], tMax=all[all.length-1], span=tMax-tMin||1;
  const pMax=Math.max(60, ...sPin.map(p=>p.v), ...sPout.map(p=>p.v), 10);
  function X(t){ return left + (t - tMin)/span*(right-left); }
  function Yp(v){ return bottom - (v/pMax)*(bottom-top); }
  // P_in ‚Äî —Å–∏–Ω—è
  if(sPin.length){
    gc.beginPath(); gc.strokeStyle='#38bdf8';
    sPin.forEach((p,i)=>{ const x=X(p.t), y=Yp(p.v); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); }); gc.stroke();
    sPin.forEach(p=>{ const x=X(p.t), y=Yp(p.v); gc.fillStyle='#38bdf8'; gc.fillRect(x-2,y-2,4,4); });
  }
  // P_out ‚Äî –∑–µ–ª–µ–Ω–∞
  if(sPout.length){
    gc.beginPath(); gc.strokeStyle='#22c55e';
    sPout.forEach((p,i)=>{ const x=X(p.t), y=Yp(p.v); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); }); gc.stroke();
    sPout.forEach(p=>{ const x=X(p.t), y=Yp(p.v); gc.fillStyle='#22c55e'; gc.fillRect(x-2,y-2,4,4); });
  }
  // SP –ª—ñ–Ω—ñ—è
  const sp=parseFloat($('#sp').value)||0;
  gc.strokeStyle='#fbbf24'; gc.beginPath(); gc.moveTo(left, Yp(sp)); gc.lineTo(right, Yp(sp)); gc.stroke();

  gc.fillStyle='#94a3b8'; gc.font='11px ui-monospace';
  gc.fillText('–º–±–∞—Ä', left, top-6);
  gc.fillStyle='#38bdf8'; gc.fillRect(right+4, top, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('P_in', right+20, top+4);
  gc.fillStyle='#22c55e'; gc.fillRect(right+4, top+16, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('P_out', right+20, top+20);
  gc.fillStyle='#fbbf24'; gc.fillRect(right+4, top+32, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('SP', right+20, top+36);
}

// –Ü–º—ñ—Ç–∞—Ü—ñ—è –∞–≤—Ç–æ-–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
let autoTimer=null, autoI=0;
$('#autoTune').addEventListener('click',()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
  autoI=0; const sp=parseFloat($('#sp').value)||20; let pin=parseFloat($('#pin').value)||30;
  autoTimer=setInterval(()=>{
    autoI++; // –∫—Ä–æ–∫ (1—Å)
    // –∑—Ä–æ–±–∏–º–æ –Ω–µ–≤–µ–ª–∏–∫—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è P_in
    pin += (Math.random()-0.5)*0.6; pin=Math.max(5,Math.min(100,pin));
    $('#pin').value=pin.toFixed(1); $('#pinNum').textContent=pin.toFixed(1); addPoint(sPin, pin);
    // –ø–æ–≤—ñ–ª—å–Ω–æ —Ç—è–≥–Ω–µ–º–æ P_out –¥–æ SP –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é —Ö–∏—Å—Ç–∫—ñ—Å—Ç—é
    const cur=parseFloat($('#pout').value)||0;
    const next = cur + Math.sign(sp-cur)*Math.max(0.2, Math.abs(sp-cur)*0.25) + (Math.random()-0.5)*0.2;
    $('#pout').value=next.toFixed(1); $('#poutNum').textContent=next.toFixed(1); addPoint(sPout, parseFloat(next.toFixed(1)));
    if(autoI>=10){ clearInterval(autoTimer); autoTimer=null; log('–Ü–º—ñ—Ç–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ'); }
  },1000);
});

// ===== KPI
let KPI={stabTol:0.5, winSec:15};
$('#applyKPI').addEventListener('click',()=>{ KPI.stabTol=Math.max(0,parseFloat($('#stab').value)||0.5); KPI.winSec=Math.max(5,parseInt($('#win').value)||15); computeKPI(); updateMetrics(); log(`KPI: —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å ¬±${KPI.stabTol} –º–±–∞—Ä, –≤—ñ–∫–Ω–æ ${KPI.winSec}—Å`); });

function computeKPI(){
  const sp=parseFloat($('#sp').value)||0;
  $('#spVal').textContent=sp.toFixed(1);
  const dev = (sPout.length? sPout[sPout.length-1].v : parseFloat($('#pout').value)||0) - sp;
  $('#devVal').textContent=isFinite(dev)?dev.toFixed(1):'‚Äî';
  // droop = 100*(Pout_avg_recent - Pout_avg_base)/Pout_avg_base (—Å–ø—Ä–æ—â–µ–Ω–æ: –ø—Ä–æ—Ç–∏ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä—à–∏—Ö —Ç–æ—á–æ–∫ —ñ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö)
  let droop='‚Äî';
  if(sPout.length>=6){
    const n=sPout.length;
    const base=sPout.slice(0,Math.max(2,Math.floor(n*0.3))).reduce((a,b)=>a+b.v,0)/Math.max(2,Math.floor(n*0.3));
    const recent=sPout.slice(Math.floor(n*0.7)).reduce((a,b)=>a+b.v,0)/Math.max(1,n-Math.floor(n*0.7));
    droop = base>0? ((recent-base)/base*100).toFixed(1):'‚Äî';
  }
  $('#droopVal').textContent=droop;
  // Stability: —è–∫—â–æ –ø—Ä–æ—Ç—è–≥–æ–º winSec std(P_out) <= stabTol ‚Üí Stable, —ñ–Ω–∞–∫—à–µ Unstable
  let stab='‚Äî';
  if(sPout.length>=3){
    const now=Date.now(); const win = KPI.winSec*1000;
    const arr=sPout.filter(p=> now - p.t <= win).map(p=>p.v);
    if(arr.length>=3){
      const avg=arr.reduce((a,b)=>a+b,0)/arr.length;
      const std=Math.sqrt(arr.reduce((a,b)=>a+(b-avg)*(b-avg),0)/arr.length);
      stab = std<=KPI.stabTol? `Stable (œÉ=${std.toFixed(2)})` : `Unstable (œÉ=${std.toFixed(2)})`;
    }
  }
  $('#stabVal').textContent=stab;
  $('#mKPI').textContent = `${$('#devVal').textContent} –º–±–∞—Ä, ${$('#droopVal').textContent}% , ${stab}`;
  updateState();
}

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ
let stream=null;
async function startCam(){
  try{ stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); $('#vid').srcObject=stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ'); }
  catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);
function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  c.getContext('2d').drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png'); photos[kind]=url; renderGallery(); log(`–§–æ—Ç–æ: ${kind}`); updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));
function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  if(photos.overview){ const i=document.createElement('img'); i.className='photo'; i.src=photos.overview; i.alt='–æ–≥–ª—è–¥'; gal.appendChild(i); }
  if(photos.nameplate){ const i=document.createElement('img'); i.className='photo'; i.src=photos.nameplate; i.alt='—Ç–∞–±–ª–∏—á–∫–∞'; gal.appendChild(i); }
  if(photos.gauge){ const i=document.createElement('img'); i.className='photo'; i.src=photos.gauge; i.alt='–º–∞–Ω–æ–º–µ—Ç—Ä'; gal.appendChild(i); }
}

// ===== –ü—ñ–¥–ø–∏—Å
const sig=$('#sig'), ctx=sig.getContext('2d');
let drawing=false, last=null, hasInk=false;
function xy(e){ const r=sig.getBoundingClientRect(); const t=e.touches? e.touches[0]:e; return {x:(t.clientX-r.left)*sig.width/r.width, y:(t.clientY-r.top)*sig.height/r.height}; }
function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke(); }
sig.addEventListener('pointerdown',e=>{ drawing=true; last=xy(e); hasInk=true; });
sig.addEventListener('pointermove',e=>{ if(!drawing) return; const p=xy(e); line(last,p); last=p; });
sig.addEventListener('pointerup',()=>{ drawing=false; last=null; });
sig.addEventListener('pointerleave',()=>{ drawing=false; last=null; });
$('#sigClear').addEventListener('click',()=>{ ctx.clearRect(0,0,sig.width,sig.height); hasInk=false; $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î'; updateMetrics(); });
$('#sigSave').addEventListener('click',()=>{ if(!hasInk){ alert('–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å—É'); return; } sigUrl=sig.toDataURL('image/png'); $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ'; const a=document.createElement('a'); a.href=sigUrl; a.download='signature_'+(CASE_ID||'case')+'_'+stamp()+'.png'; document.body.appendChild(a); a.click(); a.remove(); log('–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ (png)'); updateMetrics(); });

// ===== NFC / ID
async function tryNFC(){
  if('NDEFReader' in window){
    try{
      const reader=new NDEFReader(); await reader.scan();
      $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
      reader.addEventListener('reading', ({message, serialNumber})=>{
        let text=''; for(const rec of message.records){ if(rec.recordType==='text'){ const dec=new TextDecoder(rec.encoding||'utf-8'); text = dec.decode(rec.data); } }
        ASSET_ID = (text||serialNumber||'NFC-'+Math.random().toString(36).slice(2,7)).toString();
        $('#asset').value=ASSET_ID; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑—á–∏—Ç–∞–Ω–æ';
        log('NFC: '+ASSET_ID); updateMetrics();
      });
    }catch(e){ $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –ø–æ–º–∏–ª–∫–∞'; alert('NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π/–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π'); }
  }else{ alert('Web NFC –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –í–≤–µ–¥–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É.'); }
}
$('#nfcBtn').addEventListener('click', tryNFC);
$('#saveAsset').addEventListener('click',()=>{ const v=clean($('#asset').value||''); if(!v){ alert('–í–≤–µ–¥–∏ ID –≤—É–∑–ª–∞'); return; } ASSET_ID=v; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É'; log('ID –≤—É–∑–ª–∞: '+ASSET_ID); updateMetrics(); });

// ===== –ú–µ—Ç—Ä–∏–∫–∏/—Å—Ç–∞–Ω
function updateState(){
  let score=0;
  const caseOk=!!CASE_ID;
  const vSafe = (VALVES.find(x=>x.k==='inlet').state==='open' && VALVES.find(x=>x.k==='toReg').state==='open' && VALVES.find(x=>x.k==='afterReg').state==='open'); // –ø—Ä–∏–ª–∞–¥ –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–∫—Ä–∏—Ç–∏–º
  const dialOk = parseFloat($('#revCnt').textContent)>=1 || parseInt($('#openPct').textContent)>=40;
  const pointsOk=(sPin.length+sPout.length)>=8;
  const kpiOk = ( Math.abs(parseFloat($('#devVal').textContent)||999)<=1 && (parseFloat($('#droopVal').textContent)||0)<=10 && $('#stabVal').textContent.startsWith('Stable') );
  const photoOrSign = (!!photos.overview && !!photos.nameplate && !!photos.gauge) || !!sigUrl;

  if(caseOk)score+=2;
  if(vSafe)score+=2;
  if(dialOk)score+=1;
  if(pointsOk)score+=1;
  if(kpiOk)score+=3;
  if(photoOrSign)score+=1;

  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML=html;
}
function updateMetrics(){
  $('#mCase').textContent = CASE_ID||'‚Äî';
  $('#mAsset').textContent = ASSET_ID||($('#asset').value||'‚Äî');
  $('#mReg').textContent = $('#regType').value||'‚Äî';
  $('#mDN').textContent = $('#dn').value||'‚Äî';
  $('#mSP').textContent = ($('#sp').value||'‚Äî')+' –º–±–∞—Ä';
  $('#mValves').textContent = valvesSummary();
  $('#mDial').textContent = `${$('#stepsCnt').textContent} / ${$('#revCnt').textContent} / ${$('#openPct').textContent}%`;
  $('#mPts').textContent = `${sPin.length} / ${sPout.length}`;
  $('#mPhotos').textContent = `${photos.overview?1:0} / ${photos.nameplate?1:0} / ${photos.gauge?1:0}`;
  $('#mSig').textContent = sigUrl?'—î':'‚Äî';
  $('#mKPI').textContent = `${$('#devVal').textContent} –º–±–∞—Ä, ${$('#droopVal').textContent}% , ${$('#stabVal').textContent}`;
  computeKPI(); updateState();
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR
function summary(){
  const addr=$('#addr').value||'‚Äî', tech=$('#tech').value||'‚Äî', day=$('#day').value||'‚Äî';
  return {
    case: CASE_ID||'‚Äî', addr, tech, day,
    regulator: {type: $('#regType').value||'‚Äî', dn: parseInt($('#dn').value)||0, setpoint_mbar: parseFloat($('#sp').value)||0},
    asset: ASSET_ID||($('#asset').value||'‚Äî'),
    valves: Object.fromEntries(VALVES.map(v=>[v.k,v.state])),
    dial: {steps: parseInt($('#stepsCnt').textContent)||0, rev: parseFloat($('#revCnt').textContent)||0, open_pct: parseInt($('#openPct').textContent)||0},
    points: {
      pin: sPin.map(p=>({t:new Date(p.t).toISOString(), mbar:p.v})),
      pout: sPout.map(p=>({t:new Date(p.t).toISOString(), mbar:p.v}))
    },
    kpi: {dev_mbar: $('#devVal').textContent, droop_pct: $('#droopVal').textContent, stability: $('#stabVal').textContent},
    photos: {overview:!!photos.overview, nameplate:!!photos.nameplate, gauge:!!photos.gauge},
    signature: !!sigUrl
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const s=summary();
  let csv='field,value\n';
  for(const [k,v] of Object.entries(s)){
    if(k==='points') continue;
    if(typeof v==='object'){ csv+=`${k},${JSON.stringify(v).replace(/,/g,';')}\n`; }
    else csv+=`${k},${String(v).replace(/,/g,';')}\n`;
  }
  csv+='\n# pin_points\niso_time,mbar\n';
  s.points.pin.forEach(p=>{ csv+=`${p.t},${p.mbar}\n`; });
  csv+='\n# pout_points\niso_time,mbar\n';
  s.points.pout.forEach(p=>{ csv+=`${p.t},${p.mbar}\n`; });
  download('gas_para12_regulator_'+stamp()+'.csv', csv, 'text/csv'); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const s=summary();
  const lines=[
    '–ü–∞—Ä–∞ 12 ‚Äî –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø—ñ—Ä–Ω–æ—ó –∞—Ä–º–∞—Ç—É—Ä–∏ –π —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ñ–≤: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${s.case}`, `–ê–¥—Ä–µ—Å–∞: ${s.addr}`, `–†–µ–≥—É–ª—è—Ç–æ—Ä: ${s.regulator.type}, DN ${s.regulator.dn}, SP ${s.regulator.setpoint_mbar} –º–±–∞—Ä`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${s.tech}`, `–î–∞—Ç–∞: ${s.day}`, `ID –≤—É–∑–ª–∞: ${s.asset}`,
    `–ö—Ä–∞–Ω–∏: ${Object.entries(s.valves).map(([k,v])=>k+':'+v).join(', ')}`,
    `–¢—Ä–µ–Ω–∞–∂–µ—Ä: –∫—Ä–æ–∫—ñ–≤=${s.dial.steps}, –æ–±–µ—Ä—Ç–∏=${s.dial.rev}, –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è=${s.dial.open_pct}%`,
    `KPI: Œî=${s.kpi.dev_mbar} –º–±–∞—Ä; droop=${s.kpi.droop_pct}% ; —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å=${s.kpi.stability}`,
    `–§–æ—Ç–æ (overview/nameplate/gauge): ${s.photos.overview?'1':'0'} / ${s.photos.nameplate?'1':'0'} / ${s.photos.gauge?'1':'0'}`,
    `–ü—ñ–¥–ø–∏—Å: ${s.signature?'—î':'‚Äî'}`,
    `--- –¢–æ—á–æ–∫: P_in=${s.points.pin.length}, P_out=${s.points.pout.length} ---`
  ];
  download('gas_para12_regulator_'+stamp()+'.txt', lines.join('\n')); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const s=summary(); const rc=$('#rc'); rc.hidden=false;
  const lines=[
'=== REGULATOR SETUP (58–º–º) ===',
'Case: '+s.case,
'Date: '+s.day,
'Addr: '+s.addr,
'Reg:  '+s.regulator.type+' DN'+s.regulator.dn+' SP:'+s.regulator.setpoint_mbar+'mbar',
'Asset:'+s.asset,
'Valv: '+Object.entries(s.valves).map(([k,v])=>k[0].toUpperCase()+':'+(v==='open'?'O':'C')).join(' '),
'Dial: '+'S'+s.dial.steps+' R'+s.dial.rev+' '+s.dial.open_pct+'%',
'KPI:  Œî'+s.kpi.dev_mbar+' droop '+s.kpi.droop_pct+'% '+s.kpi.stability,
'Pts:  In'+s.points.pin.length+' Out'+s.points.pout.length,
'Photos:'+(s.photos.overview?1:0)+'/'+(s.photos.nameplate?1:0)+'/'+(s.photos.gauge?1:0)+' Sign:'+(s.signature?'Y':'N'),
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para12_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def=CASE_ID||ASSET_ID||'regulator-setup';
  const data=prompt('–í—Å—Ç–∞–≤ URL/ID (Case –∞–±–æ Asset):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –Ü–Ω—ñ—Ç
function initDefaults(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); }
initDefaults(); updateMetrics(); computeKPI(); drawChart(); drawScheme();

// –í–±—É–¥–æ–≤–∞–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Moodle/iFrame)
(function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
</script>


</body></html>