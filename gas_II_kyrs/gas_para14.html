<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 14 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ü–ª–∞–Ω–æ–≤–µ –¢–û –∫–æ—Ç–ª–∞: —á–µ–∫-–ª–∏—Å—Ç, –º–∞–Ω–æ–º–µ—Ç—Ä—ñ—è, –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —Ñ–æ—Ç–æ/–∞—É–¥—ñ–æ, –ø—ñ–¥–ø–∏—Å, 58 –º–º, CSV/TXT, QR</title>
<meta name="description" content="–ü—Ä–∞–∫—Ç–∏–∫–∞ –ø–ª–∞–Ω–æ–≤–æ–≥–æ —Ç–µ—Ö–æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –∫–æ—Ç–ª–∞: —á–µ–∫-–ª–∏—Å—Ç —ñ–∑ —Ç–∞–π–º–µ—Ä–∞–º–∏, –º–∞–Ω–æ–º–µ—Ç—Ä—ñ—è (Pgas_in/Pgas_out, Pwater), KPI-–ø–æ—Ä–æ–≥–∏, –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (Load%, T¬∞), –∫–∞–º–µ—Ä–∞, –∞—É–¥—ñ–æ, –ø—ñ–¥–ø–∏—Å, —á–µ–∫ 58 –º–º, CSV/TXT, QR, –∂—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
.sigWrap{border:1px dashed var(--line);border-radius:12px;padding:8px;background:#0c182a}
#sig{background:#0b1220;border:1px solid var(--line);border-radius:8px;touch-action:none}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.step{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0;background:#0c182a}
.step[data-ok="true"]{border-color:#1d3e2a;background:#0f2f1e22}
.step .num{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#0b1a2f;border:1px solid #223049}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
audio{width:100%}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üõ†Ô∏èüî•</span>
      <div>
        <b>–ü–∞—Ä–∞ 14 ‚Äî –ü–ª–∞–Ω–æ–≤–µ —Ç–µ—Ö–æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –∫–æ—Ç–ª–∞</b><br/>
        <span class="badge">–ß–µ–∫-–ª–∏—Å—Ç –¢–û ‚Üí –º–∞–Ω–æ–º–µ—Ç—Ä—ñ—è ‚Üí KPI ‚Üí –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Üí –∫–∞–º–µ—Ä–∞/–∞—É–¥—ñ–æ ‚Üí –ø—ñ–¥–ø–∏—Å ‚Üí 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –°—Ü–µ–Ω–∞—Ä—ñ–π</h2>
    <p>–í–∏–∫–æ–Ω—É—î–º–æ —Ä—ñ—á–Ω–µ <b>–ø–ª–∞–Ω–æ–≤–µ –¢–û</b> –ø–æ–±—É—Ç–æ–≤–æ–≥–æ/–º–∞–ª–æ–ø–æ—Ç—É–∂–Ω–æ–≥–æ –∫–æ—Ç–ª–∞: –≤—ñ–¥ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –≥–∞–∑—É —Ç–∞ –æ–≥–ª—è–¥—É –¥–æ —á–∏—Å—Ç–∫–∏ –ø–∞–ª—å–Ω–∏–∫–∞ –π —Ç–µ–ø–ª–æ–æ–±–º—ñ–Ω–Ω–∏–∫–∞, 
      –≤–∏–º—ñ—Ä—ñ–≤ <b>P<sub>gas,in</sub>/P<sub>gas,out</sub></b>, <b>P<sub>water</sub></b>, –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –ö–ü–Ü —Ç–∞ —Ñ—ñ–∫—Å–∞—Ü—ñ—ó <b>–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏</b> —É —á–∞—Å—ñ. 
      –†–æ–±–∏–º–æ <b>—Ñ–æ—Ç–æ</b>, –¥–æ–¥–∞—î–º–æ <b>–∞—É–¥—ñ–æ-–∫–æ–º–µ–Ω—Ç–∞—Ä</b>, –±–µ—Ä–µ–º–æ <b>–ø—ñ–¥–ø–∏—Å</b>, –¥—Ä—É–∫—É—î–º–æ <b>—á–µ–∫ 58 –º–º</b>, –µ–∫—Å–ø–æ—Ä—Ç—É—î–º–æ <b>CSV/TXT</b>, –≥–µ–Ω–µ—Ä—É—î–º–æ <b>QR</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. ..., –∫–æ—Ç–µ–ª"/></label>
      <label style="flex:1">–¢–∏–ø –∫–æ—Ç–ª–∞
        <select id="boilType" class="input">
          <option selected>–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π</option><option>–¢—É—Ä–±–æ–≤–∞–Ω–∏–π (–∑–∞–∫—Ä. –∫–∞–º–µ—Ä–∞)</option><option>–ö–æ–Ω–¥–µ–Ω—Å–∞—Ü—ñ–π–Ω–∏–π</option><option>–Ü–Ω—à–∏–π</option>
        </select>
      </label>
      <label style="flex:1">–ú–æ–¥–µ–ª—å<input id="model" class="input" placeholder="–ù–∞–ø—Ä. AOGV 11, Baxi Luna, Vaillant..."/></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."/></label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"/></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞: –ß–µ–∫-–ª–∏—Å—Ç / –ú–∞–Ω–æ–º–µ—Ç—Ä—ñ—è / –ì—Ä–∞—Ñ—ñ–∫ / –ö–∞–º–µ—Ä–∞ / –ê—É–¥—ñ–æ / –ü—ñ–¥–ø–∏—Å -->
    <div class="card">
      <h2>üß≠ –ß–µ–∫-–ª–∏—Å—Ç –ø–ª–∞–Ω–æ–≤–æ–≥–æ –¢–û (–º—ñ–∂–∑–∞–º–∫–∏)</h2>
      <div id="steps"></div>

      <h2 style="margin-top:10px">üß™ –ú–∞–Ω–æ–º–µ—Ç—Ä—ñ—è —Ç–∞ KPI</h2>
      <div class="block">
        <div class="row">
          <label style="flex:1">P<sub>gas,in</sub>, –º–±–∞—Ä<input id="pgin" type="range" class="input" min="5" max="40" step="0.1" value="20.0"/></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∏–π P<sub>gas,in</sub>: <b id="pginNum">20.0</b></span>
          <button class="btn" id="markPgin">üìç –¢–æ—á–∫–∞ P<sub>gas,in</sub></button>
        </div>
        <div class="row">
          <label style="flex:1">P<sub>gas,out</sub>, –º–±–∞—Ä<input id="pgout" type="range" class="input" min="5" max="40" step="0.1" value="12.0"/></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∏–π P<sub>gas,out</sub>: <b id="pgoutNum">12.0</b></span>
          <button class="btn" id="markPgout">üìç –¢–æ—á–∫–∞ P<sub>gas,out</sub></button>
        </div>
        <div class="row">
          <label style="flex:1">P<sub>water</sub>, –±–∞—Ä<input id="pwater" type="range" class="input" min="0.0" max="3.0" step="0.05" value="1.2"/></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∏–π P<sub>water</sub>: <b id="pwaterNum">1.2</b></span>
          <button class="btn" id="markPwater">üìç –¢–æ—á–∫–∞ P<sub>water</sub></button>
          <button class="btn secondary" id="clearPress">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–æ—á–∫–∏</button>
        </div>
        <div class="row">
          <label>–ú—ñ–Ω. P<sub>gas,in</sub>, –º–±–∞—Ä<input id="pginMin" class="input" type="number" step="0.1" value="18.0"/></label>
          <label>–¶—ñ–ª—å P<sub>gas,out</sub>, –º–±–∞—Ä<input id="pgoutTgt" class="input" type="number" step="0.1" value="12.0"/></label>
          <label>P<sub>water</sub> —Ä–æ–±–æ—á–∏–π, –±–∞—Ä<input id="pwaterOk" class="input" type="number" step="0.05" value="1.0"/></label>
          <button class="btn secondary" id="applyKPI">‚öôÔ∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ KPI</button>
        </div>
        <div class="kpi" style="margin-top:6px">
          <span class="tag ok">KPI P<sub>gas,in</sub>: <b id="kPgin">‚Äî</b></span>
          <span class="tag warn">KPI P<sub>gas,out</sub>: <b id="kPgout">‚Äî</b></span>
          <span class="tag bad">KPI P<sub>water</sub>: <b id="kPwater">‚Äî</b></span>
        </div>
      </div>

      <h2 style="margin-top:10px">üìà –î–∏–Ω–∞–º—ñ—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ (Load % / T¬∞ –ø–æ–¥–∞—á—ñ)</h2>
      <div class="block">
        <div class="row">
          <label style="flex:1">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, %<input id="load" type="range" class="input" min="0" max="100" step="1" value="45"/></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: <b id="loadNum">45</b>%</span>
          <button class="btn" id="markLoad">üìç –¢–æ—á–∫–∞ Load</button>
        </div>
        <div class="row">
          <label style="flex:1">T¬∞ –ø–æ–¥–∞—á—ñ, ¬∞C<input id="tflow" type="range" class="input" min="20" max="90" step="0.5" value="55.0"/></label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∞ T¬∞ –ø–æ–¥–∞—á—ñ: <b id="tflowNum">55.0</b> ¬∞C</span>
          <button class="btn" id="markT">üìç –¢–æ—á–∫–∞ T¬∞</button>
          <button class="btn secondary" id="clearSeries">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
        </div>
        <div class="row">
          <button class="btn" id="autoRun">üéõÔ∏è –Ü–º—ñ—Ç—É–≤–∞—Ç–∏ —Ä–µ–∂–∏–º (15 c)</button>
        </div>
      </div>
      <div class="canvasWrap"><canvas id="chart" class="chart" width="520" height="240"></canvas></div>

      <h2 style="margin-top:10px">üé• –§–æ—Ç–æ (3 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay playsinline muted></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="plate">üì∑ –¢–∞–±–ª–∏—á–∫–∞ –∫–æ—Ç–ª–∞</button>
          <button class="btn" data-kind="burner">üì∑ –ü–∞–ª—å–Ω–∏–∫/—Ç–µ–ø–ª–æ–æ–±–º—ñ–Ω–Ω–∏–∫</button>
          <button class="btn" data-kind="gauge">üì∑ –ú–∞–Ω–æ–º–µ—Ç—Ä/–¥–∞—Ç—á–∏–∫</button><br/>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">üéôÔ∏è –ê—É–¥—ñ–æ-–∫–æ–º–µ–Ω—Ç–∞—Ä (—Ä–µ–∑—é–º–µ –¢–û)</h2>
      <div class="block">
        <div class="row">
          <button class="btn" id="audStart">‚è∫Ô∏è –ó–∞–ø–∏—Å</button>
          <button class="btn secondary" id="audStop">‚èπÔ∏è –°—Ç–æ–ø</button>
          <button class="btn" id="audSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <span class="badge" id="audStat">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É</span>
        </div>
        <audio id="audPlay" controls></audio>
      </div>

      <h2 style="margin-top:10px">‚úçÔ∏è –ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>
      <div class="sigWrap">
        <canvas id="sig" width="520" height="200"></canvas>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="sigClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
          <button class="btn" id="sigSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
          <span class="badge" id="sigStat">–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞: –ú–µ—Ç—Ä–∏–∫–∏ / –ï–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞ —Å—Ç–∞–Ω</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>–ö–æ—Ç–µ–ª</th><td id="mBoil">‚Äî</td></tr>
          <tr><th>–ß–µ–∫-–ª–∏—Å—Ç (–û–ö)</th><td id="mRoute">0 / 10</td></tr>
          <tr><th>–¢–æ—á–æ–∫ —Ç–∏—Å–∫—É</th><td id="mPtsP">0 / 0 / 0</td></tr>
          <tr><th>KPI (in/out/water)</th><td id="mKPI">‚Äî</td></tr>
          <tr><th>–¢–æ—á–æ–∫ –≥—Ä–∞—Ñ—ñ–∫–∞</th><td id="mPtsChart">0 / 0</td></tr>
          <tr><th>–§–æ—Ç–æ (plate/burner/gauge)</th><td id="mPhotos">0 / 0 / 0</td></tr>
          <tr><th>–ê—É–¥—ñ–æ</th><td id="mAud">‚Äî</td></tr>
          <tr><th>–ü—ñ–¥–ø–∏—Å</th><td id="mSig">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—Ä–æ–∫–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å + –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–æ—Ç–ª–∞ ‚Äî <b>2</b></li>
        <li>–ß–µ–∫-–ª–∏—Å—Ç: —É—Å—ñ 10 –∫—Ä–æ–∫—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–æ ‚Äî <b>3</b></li>
        <li>–ú–∞–Ω–æ–º–µ—Ç—Ä—ñ—è: ‚â•3 —Ç–æ—á–∫–∏ (in/out/water) —ñ KPI –≤ –º–µ–∂–∞—Ö ‚Äî <b>3</b></li>
        <li>–ì—Ä–∞—Ñ—ñ–∫: ‚â•10 —Ç–æ—á–æ–∫ —Å—É–º–∞—Ä–Ω–æ ‚Äî <b>1</b></li>
        <li>–§–æ—Ç–æ (3) –∞–±–æ –∞—É–¥—ñ–æ + –ø—ñ–¥–ø–∏—Å ‚Äî <b>1</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:240px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –°—Ç–∞–Ω
let CASE_ID=null;
let photos={plate:null, burner:null, gauge:null};
let sigUrl=null;
let audBlob=null, audUrl=null;

// ===== –ö–µ–π—Å
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||''); const tech=clean($('#tech').value||''); const day=$('#day').value;
  if(!addr||!tech||!day){ alert('–í–∫–∞–∂–∏ –∞–¥—Ä–µ—Å—É, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ç–∞ –¥–∞—Ç—É'); return; }
  CASE_ID='S-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent='–ö–µ–π—Å: '+CASE_ID;
  log(`–ö–µ–π—Å ${CASE_ID}: ${addr}, ${$('#boilType').value}, ${$('#model').value||'-'}, ${tech}, ${day}`);
  renderSteps(); drawChart(); updateMetrics(); computeKPI();
});

// ===== –ß–µ–∫-–ª–∏—Å—Ç –¢–û (10 –∫—Ä–æ–∫—ñ–≤, —á–∞—Å—Ç–∏–Ω–∞ –∑ –º—ñ–∂–∑–∞–º–∫–∞–º–∏)
const STEPS_DEF=[
  {k:'gasOff',  name:'–í—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≥–∞–∑ (–≤–≤—ñ–¥–Ω–∏–π –∫—Ä–∞–Ω)'},
  {k:'visInsp', name:'–ó–æ–≤–Ω—ñ—à–Ω—ñ–π –æ–≥–ª—è–¥: –∫–æ—Ä–ø—É—Å, –¥–∏–º–æ—Ö—ñ–¥, –≤–µ–Ω—Ç–∏–ª—è—Ü—ñ—è'},
  {k:'filter',  name:'–ß–∏—Å—Ç–∫–∞ —Ñ—ñ–ª—å—Ç—Ä–∞ –≥–∞–∑—É'},
  {k:'burner',  name:'–ß–∏—Å—Ç–∫–∞ –ø–∞–ª—å–Ω–∏–∫–∞ –π —Ñ–æ—Ä—Å—É–Ω–æ–∫'},
  {k:'hex',     name:'–ß–∏—Å—Ç–∫–∞/–ø—Ä–æ–º–∏–≤–∫–∞ —Ç–µ–ø–ª–æ–æ–±–º—ñ–Ω–Ω–∏–∫–∞'},
  {k:'gasket',  name:'–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥–µ—Ä–º–µ—Ç–∏—á–Ω–æ—Å—Ç—ñ –∑‚Äô—î–¥–Ω–∞–Ω—å'},
  {k:'ign',     name:'–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è/—ñ–æ–Ω—ñ–∑–∞—Ü—ñ—ó'},
  {k:'press',   name:'–ú–∞–Ω–æ–º–µ—Ç—Ä—ñ—è –≥–∞–∑/–≤–æ–¥–∞ (in/out/water)'},
  {k:'load',    name:'–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∂–∏–º—É –ø—ñ–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º (–≥—Ä–∞—Ñ—ñ–∫)'},
  {k:'doc',     name:'–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –∞–∫—Ç–∞ –¢–û'}
];
let STEPS = STEPS_DEF.map(s=>({...s, tsStart:null, tsStop:null, dur:0, ok:false }));

function renderSteps(){
  const box=$('#steps'); box.innerHTML='';
  STEPS.forEach((s,i)=>{
    const el=document.createElement('div'); el.className='step'; el.dataset.key=s.k; el.dataset.ok=s.ok;
    el.innerHTML = `
      <span class="num">${i+1}</span><b>${s.name}</b><span class="badge mono">${s.k}</span>
      <button class="btn btn-start">‚ñ∂Ô∏è Start</button>
      <button class="btn secondary btn-stop">‚èπÔ∏è Stop</button>
      <button class="btn good btn-done">‚úÖ Done</button>
      <span class="badge">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: <b class="dur">0</b> —Å</span>`;
    box.appendChild(el);
  });
}
renderSteps();
function stepByKey(k){ return STEPS.find(x=>x.k===k); }
$('#steps').addEventListener('click',(e)=>{
  const wrap=e.target.closest('.step'); if(!wrap) return; const key=wrap.dataset.key; const s=stepByKey(key); const now=Date.now();
  // –ú—ñ–∂–∑–∞–º–∫–∏: 'press' –¥–æ–∑–≤–æ–ª–µ–Ω–æ –ø—ñ—Å–ª—è 'gasket' Done; 'load' –ø—ñ—Å–ª—è 'press' Done; 'doc' –ø—ñ—Å–ª—è 'load' Done
  if(e.target.classList.contains('btn-start')){
    if(key==='press' && !stepByKey('gasket').ok){ alert('–°–ø–µ—Ä—à—É –∑–∞–≤–µ—Ä—à–∏ "–ì–µ—Ä–º–µ—Ç–∏—á–Ω—ñ—Å—Ç—å"'); return; }
    if(key==='load'  && !stepByKey('press').ok){ alert('–°–ø–µ—Ä—à—É –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –º–∞–Ω–æ–º–µ—Ç—Ä—ñ—é'); return; }
    if(key==='doc'   && !stepByKey('load').ok){ alert('–°–ø–µ—Ä—à—É –ø–µ—Ä–µ–≤—ñ—Ä —Ä–µ–∂–∏–º –ø—ñ–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º'); return; }
    s.tsStart=now; log(`–ö—Ä–æ–∫ ${key}: Start`);
  }
  if(e.target.classList.contains('btn-stop')){
    if(s.tsStart){ s.tsStop=now; s.dur+=Math.max(0,Math.round((s.tsStop-s.tsStart)/1000)); s.tsStart=null; wrap.querySelector('.dur').textContent=String(s.dur); log(`–ö—Ä–æ–∫ ${key}: Stop (+${s.dur}s)`); }
  }
  if(e.target.classList.contains('btn-done')){
    if(s.tsStart){ s.tsStop=now; s.dur+=Math.max(0,Math.round((s.tsStop-s.tsStart)/1000)); s.tsStart=null; wrap.querySelector('.dur').textContent=String(s.dur); }
    s.ok=true; wrap.dataset.ok='true'; log(`–ö—Ä–æ–∫ ${key}: Done`);
  }
  updateMetrics();
});
setInterval(()=>{
  const now=Date.now();
  STEPS.forEach(s=>{ if(s.tsStart){ const curr=Math.max(0,Math.round((now-s.tsStart)/1000)); const wrap=$(`[data-key="${s.k}"]`); if(wrap){ wrap.querySelector('.dur').textContent=String(s.dur+curr);} }});
},1000);

// ===== –ú–∞–Ω–æ–º–µ—Ç—Ä—ñ—è
let Pts={pgin:[], pgout:[], pwater:[]};
$('#pgin').addEventListener('input',()=>{ $('#pginNum').textContent=$('#pgin').value; });
$('#pgout').addEventListener('input',()=>{ $('#pgoutNum').textContent=$('#pgout').value; });
$('#pwater').addEventListener('input',()=>{ $('#pwaterNum').textContent=$('#pwater').value; });
function addP(arr,v,label){ arr.push({t:new Date().toISOString(), v}); log(`–¢–æ—á–∫–∞ ${label}: ${v}`); computeKPI(); updateMetrics(); }
$('#markPgin').addEventListener('click',()=>{ addP(Pts.pgin, parseFloat($('#pgin').value), 'P_gas,in –º–±–∞—Ä'); });
$('#markPgout').addEventListener('click',()=>{ addP(Pts.pgout, parseFloat($('#pgout').value), 'P_gas,out –º–±–∞—Ä'); });
$('#markPwater').addEventListener('click',()=>{ addP(Pts.pwater, parseFloat($('#pwater').value), 'P_water –±–∞—Ä'); });
$('#clearPress').addEventListener('click',()=>{ Pts={pgin:[],pgout:[],pwater:[]}; computeKPI(); updateMetrics(); log('–û—á–∏—â–µ–Ω–æ —Ç–æ—á–∫–∏ —Ç–∏—Å–∫—É'); });

let KPI={pginMin:18.0, pgoutTgt:12.0, pwaterOk:1.0};
$('#applyKPI').addEventListener('click',()=>{
  KPI.pginMin = Math.max(0, parseFloat($('#pginMin').value)||18);
  KPI.pgoutTgt= Math.max(0, parseFloat($('#pgoutTgt').value)||12);
  KPI.pwaterOk= Math.max(0, parseFloat($('#pwaterOk').value)||1.0);
  computeKPI(); updateMetrics(); log(`KPI: P_in‚â•${KPI.pginMin}–º–±–∞—Ä, P_out‚âà${KPI.pgoutTgt}–º–±–∞—Ä, P_water‚âà${KPI.pwaterOk}–±–∞—Ä`);
});
function avg(a){ return a.length? a.reduce((x,y)=>x+y.v,0)/a.length : NaN; }
function computeKPI(){
  const aIn=avg(Pts.pgin), aOut=avg(Pts.pgout), aWat=avg(Pts.pwater);
  const kIn = isFinite(aIn)? (aIn>=KPI.pginMin ? 'OK' : 'LOW') : ((parseFloat($('#pgin').value)||0)>=KPI.pginMin?'OK':'LOW');
  const kOut= isFinite(aOut)? (Math.abs(aOut-KPI.pgoutTgt)<=1.0 ? 'OK' : 'OFF') : (Math.abs((parseFloat($('#pgout').value)||0)-KPI.pgoutTgt)<=1.0?'OK':'OFF');
  const kWat= isFinite(aWat)? (Math.abs(aWat-KPI.pwaterOk)<=0.3 ? 'OK' : 'OFF') : (Math.abs((parseFloat($('#pwater').value)||0)-KPI.pwaterOk)<=0.3?'OK':'OFF');
  $('#kPgin').textContent=kIn; $('#kPgout').textContent=kOut; $('#kPwater').textContent=kWat;
  $('#mKPI').textContent = `${kIn} / ${kOut} / ${kWat}`;
  updateState();
}

// ===== –ì—Ä–∞—Ñ—ñ–∫ (Load %, T¬∞)
const chart=$('#chart'), gc=chart.getContext('2d');
let t0=null, sLoad=[], sTemp=[];
function addPoint(series,v){ const now=Date.now(); if(!t0) t0=now; series.push({t:now, v}); drawChart(); updateMetrics(); }
$('#load').addEventListener('input',()=>{ $('#loadNum').textContent=$('#load').value; });
$('#tflow').addEventListener('input',()=>{ $('#tflowNum').textContent=$('#tflow').value; });
$('#markLoad').addEventListener('click',()=>{ addPoint(sLoad, parseInt($('#load').value)); log('–¢–æ—á–∫–∞ Load: '+$('#load').value+'%'); });
$('#markT').addEventListener('click',()=>{ addPoint(sTemp, parseFloat($('#tflow').value)); log('–¢–æ—á–∫–∞ T¬∞: '+$('#tflow').value+' ¬∞C'); });
$('#clearSeries').addEventListener('click',()=>{ sLoad=[]; sTemp=[]; t0=null; drawChart(); updateMetrics(); log('–û—á–∏—â–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫'); });

function drawChart(){
  const W=chart.width,H=chart.height; gc.clearRect(0,0,W,H);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-50,top=24,bottom=H-30;
  gc.strokeStyle='#1f2a44'; for(let y=0;y<5;y++){ const yy=top+y*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,yy); gc.lineTo(right,yy); gc.stroke(); }
  if((sLoad.length+sTemp.length)<2){ gc.fillStyle='#94a3b8'; gc.fillText('–î–æ–¥–∞–≤–∞–π —Ç–æ—á–∫–∏ –∞–±–æ –∑–∞–ø—É—Å—Ç–∏ —ñ–º—ñ—Ç–∞—Ü—ñ—é', left+8, top+14); return; }
  const all=[...sLoad.map(p=>p.t), ...sTemp.map(p=>p.t)].sort((a,b)=>a-b);
  const tMin=all[0], tMax=all[all.length-1], span=tMax-tMin||1;
  const lMax=100, tMaxV=Math.max(90, ...sTemp.map(p=>p.v), 30);
  const YL=v=> bottom - (v/lMax)*(bottom-top);
  const YT=v=> bottom - (v/tMaxV)*(bottom-top);
  const X=t=> left + (t-tMin)/span*(right-left);
  // Load
  if(sLoad.length){ gc.beginPath(); gc.strokeStyle='#38bdf8'; sLoad.forEach((p,i)=>{ const x=X(p.t), y=YL(p.v); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); }); gc.stroke(); sLoad.forEach(p=>{ const x=X(p.t), y=YL(p.v); gc.fillStyle='#38bdf8'; gc.fillRect(x-2,y-2,4,4); });}
  // Temp
  if(sTemp.length){ gc.beginPath(); gc.strokeStyle='#22c55e'; sTemp.forEach((p,i)=>{ const x=X(p.t), y=YT(p.v); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); }); gc.stroke(); sTemp.forEach(p=>{ const x=X(p.t), y=YT(p.v); gc.fillStyle='#22c55e'; gc.fillRect(x-2,y-2,4,4); });}
  // –õ–µ–≥–µ–Ω–¥–∞
  gc.fillStyle='#94a3b8'; gc.font='11px ui-monospace';
  gc.fillText('% / ¬∞C', left, top-6);
  gc.fillStyle='#38bdf8'; gc.fillRect(right+4, top, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('Load %', right+20, top+4);
  gc.fillStyle='#22c55e'; gc.fillRect(right+4, top+16, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('T¬∞ –ø–æ–¥–∞—á—ñ', right+20, top+20);
}
// –Ü–º—ñ—Ç–∞—Ü—ñ—è 15 —Å
let autoTimer=null, autoI=0;
$('#autoRun').addEventListener('click',()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
  autoI=0; let L=parseInt($('#load').value)||45; let T=parseFloat($('#tflow').value)||55;
  autoTimer=setInterval(()=>{
    autoI++;
    L += Math.round((Math.random()-0.5)*8); L=Math.max(0,Math.min(100,L));
    T += (Math.random()-0.5)*2 + (L-50)*0.02; T=Math.max(20,Math.min(90,T));
    $('#load').value=String(L); $('#tflow').value=T.toFixed(1);
    $('#loadNum').textContent=String(L); $('#tflowNum').textContent=T.toFixed(1);
    addPoint(sLoad, L); addPoint(sTemp, parseFloat(T.toFixed(1)));
    if(autoI>=15){ clearInterval(autoTimer); autoTimer=null; log('–Ü–º—ñ—Ç–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ'); }
  },1000);
});

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ
let stream=null;
async function startCam(){
  try{ stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); $('#vid').srcObject=stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ'); }
  catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);
function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  c.getContext('2d').drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png'); photos[kind]=url; renderGallery(); log(`–§–æ—Ç–æ: ${kind}`); updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));
function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  if(photos.plate){ const i=document.createElement('img'); i.className='photo'; i.src=photos.plate; i.alt='plate'; gal.appendChild(i); }
  if(photos.burner){ const i=document.createElement('img'); i.className='photo'; i.src=photos.burner; i.alt='burner'; gal.appendChild(i); }
  if(photos.gauge){ const i=document.createElement('img'); i.className='photo'; i.src=photos.gauge; i.alt='gauge'; gal.appendChild(i); }
}

// ===== –ê—É–¥—ñ–æ
let mediaStream=null, mediaRec=null, chunks=[];
$('#audStart').addEventListener('click', async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRec = new MediaRecorder(mediaStream); chunks=[];
    mediaRec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
    mediaRec.onstop = ()=>{ audBlob=new Blob(chunks,{type:'audio/webm'}); audUrl=URL.createObjectURL(audBlob); $('#audPlay').src=audUrl; $('#audStat').textContent='–Ñ –∑–∞–ø–∏—Å'; log('–ê—É–¥—ñ–æ: –≥–æ—Ç–æ–≤–æ'); updateMetrics(); };
    mediaRec.start(); $('#audStat').textContent='–ô–¥–µ –∑–∞–ø–∏—Å...'; log('–ê—É–¥—ñ–æ: —Å—Ç–∞—Ä—Ç');
  }catch(e){ alert('–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'); }
});
$('#audStop').addEventListener('click',()=>{
  if(mediaRec && mediaRec.state!=='inactive'){ mediaRec.stop(); mediaStream.getTracks().forEach(t=>t.stop()); $('#audStat').textContent='–ó—É–ø–∏–Ω–µ–Ω–æ'; log('–ê—É–¥—ñ–æ: —Å—Ç–æ–ø'); }
});
$('#audSave').addEventListener('click',()=>{
  if(!audBlob){ alert('–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É'); return; }
  const a=document.createElement('a'); a.href=audUrl; a.download='audio_'+(CASE_ID||'case')+'_'+stamp()+'.webm'; document.body.appendChild(a); a.click(); a.remove(); log('–ê—É–¥—ñ–æ: –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

// ===== –ü—ñ–¥–ø–∏—Å
const sig=$('#sig'), ctx=sig.getContext('2d');
let drawing=false, last=null, hasInk=false;
function xy(e){ const r=sig.getBoundingClientRect(); const t=e.touches? e.touches[0]:e; return {x:(t.clientX-r.left)*sig.width/r.width, y:(t.clientY-r.top)*sig.height/r.height}; }
function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke(); }
sig.addEventListener('pointerdown',e=>{ drawing=true; last=xy(e); hasInk=true; });
sig.addEventListener('pointermove',e=>{ if(!drawing) return; const p=xy(e); line(last,p); last=p; });
sig.addEventListener('pointerup',()=>{ drawing=false; last=null; });
sig.addEventListener('pointerleave',()=>{ drawing=false; last=null; });
$('#sigClear').addEventListener('click',()=>{ ctx.clearRect(0,0,sig.width,sig.height); hasInk=false; $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î'; updateMetrics(); });
$('#sigSave').addEventListener('click',()=>{ if(!hasInk){ alert('–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å—É'); return; } sigUrl=sig.toDataURL('image/png'); $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ'; const a=document.createElement('a'); a.href=sigUrl; a.download='signature_'+(CASE_ID||'case')+'_'+stamp()+'.png'; document.body.appendChild(a); a.click(); a.remove(); log('–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ (png)'); updateMetrics(); });

// ===== –ú–µ—Ç—Ä–∏–∫–∏ / —Å—Ç–∞–Ω
function updateState(){
  let score=0;
  const caseOk=!!CASE_ID;
  const routeOk=STEPS.every(s=>s.ok);
  const pressPtsOk=(Pts.pgin.length>0 && Pts.pgout.length>0 && Pts.pwater.length>0);
  const kpiOk = ($('#kPgin').textContent==='OK' && $('#kPgout').textContent==='OK' && $('#kPwater').textContent==='OK');
  const chartOk = (sLoad.length + sTemp.length) >= 10;
  const mediaOk = (photos.plate && photos.burner && photos.gauge) || !!audBlob;
  const signOk = !!sigUrl;

  if(caseOk)score+=2;
  if(routeOk)score+=3;
  if(pressPtsOk && kpiOk)score+=3;
  if(chartOk)score+=1;
  if(mediaOk && signOk)score+=1;

  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML=html;
}
function updateMetrics(){
  $('#mCase').textContent = CASE_ID||'‚Äî';
  $('#mBoil').textContent = `${$('#boilType').value||'‚Äî'} (${($('#model').value||'‚Äî')})`;
  $('#mRoute').textContent = `${STEPS.filter(s=>s.ok).length} / ${STEPS.length}`;
  $('#mPtsP').textContent = `${Pts.pgin.length} / ${Pts.pgout.length} / ${Pts.pwater.length}`;
  $('#mPtsChart').textContent = `${sLoad.length} / ${sTemp.length}`;
  $('#mPhotos').textContent = `${photos.plate?1:0} / ${photos.burner?1:0} / ${photos.gauge?1:0}`;
  $('#mAud').textContent = audBlob?'—î':'‚Äî';
  $('#mSig').textContent = sigUrl?'—î':'‚Äî';
  computeKPI(); updateState();
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR
function summary(){
  const addr=$('#addr').value||'‚Äî', tech=$('#tech').value||'‚Äî', day=$('#day').value||'‚Äî';
  return {
    case: CASE_ID||'‚Äî', addr, tech, day,
    boiler: {type: $('#boilType').value||'‚Äî', model: $('#model').value||'‚Äî'},
    route: Object.fromEntries(STEPS.map(s=>[s.k,{ok:s.ok,dur_s:s.dur}])),
    pressures: {pgin: Pts.pgin, pgout: Pts.pgout, pwater: Pts.pwater},
    kpi: {pgin: $('#kPgin').textContent, pgout: $('#kPgout').textContent, pwater: $('#kPwater').textContent},
    chart: {load: sLoad.map(p=>({t:new Date(p.t).toISOString(), pct:p.v})), tflow: sTemp.map(p=>({t:new Date(p.t).toISOString(), C:p.v}))},
    media: {photos: {plate:!!photos.plate, burner:!!photos.burner, gauge:!!photos.gauge}, audio: !!audBlob},
    signature: !!sigUrl
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const s=summary(); let csv='field,value\n';
  for(const [k,v] of Object.entries(s)){
    if(k==='chart') continue;
    if(typeof v==='object'){ csv+=`${k},${JSON.stringify(v).replace(/,/g,';')}\n`; }
    else csv+=`${k},${String(v).replace(/,/g,';')}\n`;
  }
  csv+='\n# load_points\niso_time,pct\n'; s.chart.load.forEach(p=>{ csv+=`${p.t},${p.pct}\n`; });
  csv+='\n# tflow_points\niso_time,C\n'; s.chart.tflow.forEach(p=>{ csv+=`${p.t},${p.C}\n`; });
  download('gas_para14_boiler_service_'+stamp()+'.csv', csv, 'text/csv'); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const s=summary();
  const lines=[
    '–ü–∞—Ä–∞ 14 ‚Äî –ü–ª–∞–Ω–æ–≤–µ –¢–û –∫–æ—Ç–ª–∞: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${s.case}`, `–ê–¥—Ä–µ—Å–∞: ${s.addr}`, `–ö–æ—Ç–µ–ª: ${s.boiler.type} (${s.boiler.model})`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${s.tech}`, `–î–∞—Ç–∞: ${s.day}`,
    `–ú–∞—Ä—à—Ä—É—Ç: ${Object.entries(s.route).map(([k,v])=>k+':'+(v.ok?'OK':'‚Äî')).join(', ')}`,
    `KPI: in=${s.kpi.pgin}, out=${s.kpi.pgout}, water=${s.kpi.pwater}`,
    `–§–æ—Ç–æ (plate/burner/gauge): ${s.media.photos.plate?'1':'0'} / ${s.media.photos.burner?'1':'0'} / ${s.media.photos.gauge?'1':'0'}; –ê—É–¥—ñ–æ: ${s.media.audio?'—î':'‚Äî'}`,
    `–ü—ñ–¥–ø–∏—Å: ${s.signature?'—î':'‚Äî'}`,
    `--- –¢–æ—á–æ–∫: P_in=${s.pressures.pgin.length}, P_out=${s.pressures.pgout.length}, P_water=${s.pressures.pwater.length}; Load=${s.chart.load.length}, T=${s.chart.tflow.length} ---`
  ];
  download('gas_para14_boiler_service_'+stamp()+'.txt', lines.join('\n')); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const s=summary(); const rc=$('#rc'); rc.hidden=false;
  const lines=[
'=== BOILER SERVICE (58–º–º) ===',
'Case: '+s.case,
'Date: '+s.day,
'Type: '+s.boiler.type,
'Model:'+s.boiler.model,
'KPI:  in '+s.kpi.pgin+' / out '+s.kpi.pgout+' / w '+s.kpi.pwater,
'Pts:  Pin'+s.pressures.pgin.length+' Pout'+s.pressures.pgout.length+' Pw'+s.pressures.pwater.length,
'Graph: L'+s.chart.load.length+' T'+s.chart.tflow.length,
'Photo:'+(s.media.photos.plate?1:0)+'/'+(s.media.photos.burner?1:0)+'/'+(s.media.photos.gauge?1:0)+' Aud:'+(s.media.audio?'Y':'N')+' Sign:'+(s.signature?'Y':'N'),
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para14_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def=CASE_ID||'boiler-service';
  const data=prompt('–í—Å—Ç–∞–≤ URL/ID (Case):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –Ü–Ω—ñ—Ç
function init(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); }
init(); updateMetrics(); computeKPI(); drawChart();

// –í–±—É–¥–æ–≤–∞–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Moodle/iFrame)
(function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
</script>
</body>
</html>
