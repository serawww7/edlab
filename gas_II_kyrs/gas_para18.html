<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 18 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ë–∞–ª–∞–Ω—Å/–≤—Ç—Ä–∞—Ç–∏: –¥–æ–±–æ–≤—ñ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è/–≤—ñ–¥–±–æ—Ä–∏, –∞–Ω–æ–º–∞–ª—ñ—ó, what-if, –≥—Ä–∞—Ñ—ñ–∫–∏, –µ–∫—Å–ø–æ—Ä—Ç</title>
<meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –±–∞–ª–∞–Ω—Å –≥–∞–∑—É: –¥–æ–±–æ–≤—ñ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è/–≤—ñ–¥–±–æ—Ä–∏, –∫–æ—Ä–µ–∫—Ü—ñ—ó T/P, –ø–æ—Ö–∏–±–∫–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤, —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –≤—Ç—Ä–∞—Ç–∏, –≤–∏—è–≤–ª–µ–Ω–Ω—è –∞–Ω–æ–º–∞–ª—ñ–π (Z-score), –≥—Ä–∞—Ñ—ñ–∫–∏, what-if –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –≤—Ç—Ä–∞—Ç, —Å–∞–Ω–∫—ñ, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:110px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
svg{width:100%;height:auto;display:block;background:#0b1220;border:1px solid var(--line);border-radius:12px}
pre.log{max-height:240px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">‚öñÔ∏èüî•</span>
      <div>
        <b>–ü–∞—Ä–∞ 18 ‚Äî –ë–∞–ª–∞–Ω—Å/–≤—Ç—Ä–∞—Ç–∏ –≥–∞–∑—É</b><br/>
        <span class="badge">–î–æ–±–æ–≤—ñ –¥–∞–Ω—ñ ‚Üí –∫–æ—Ä–µ–∫—Ü—ñ—ó ‚Üí —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –≤—Ç—Ä–∞—Ç–∏ ‚Üí –∞–Ω–æ–º–∞–ª—ñ—ó ‚Üí –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Üí what-if ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–í—Å—Ç–∞–≤ –∞–±–æ –∑–≥–µ–Ω–µ—Ä—É–π <b>–¥–æ–±–æ–≤—ñ</b> –∑–Ω–∞—á–µ–Ω–Ω—è <b>–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è (In)</b> —Ç–∞ <b>–í—ñ–¥–±–æ—Ä—É (Out)</b>, –∑–∞–¥–∞–π –∫–æ—Ä–µ–∫—Ü—ñ—ó <b>—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/—Ç–∏—Å–∫</b> —Ç–∞ <b>–ø–æ—Ö–∏–±–∫–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤</b>. –°–∏—Å—Ç–µ–º–∞ –æ—Ü—ñ–Ω–∏—Ç—å <b>—Ç–µ—Ö–Ω—ñ—á–Ω—ñ –≤—Ç—Ä–∞—Ç–∏</b>, –ø–æ—Ä–∞—Ö—É—î <b>–±–∞–ª–∞–Ω—Å</b> —ñ –≤–∏–¥—ñ–ª–∏—Ç—å <b>–∞–Ω–æ–º–∞–ª—ñ—ó</b> (Z-score). –î–∞–ª—ñ –∑–º–æ–¥–µ–ª—é–π —Å—Ü–µ–Ω–∞—Ä—ñ–π <b>‚Äú—â–æ-—è–∫—â–æ‚Äù</b> –¥–ª—è –º–æ–∂–ª–∏–≤–∏—Ö (–Ω–µ–æ–±–ª—ñ–∫–æ–≤–∞–Ω–∏—Ö) –≤—Ç—Ä–∞—Ç ‚Äî –ø–æ–±–∞—á–∏—à –≤–ø–ª–∏–≤ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫–∏ —Ç–∞ —Å–∞–Ω–∫—ñ-—Å—Ö–µ–º—É.</p>
    <div class="row">
      <button class="btn" id="gen">üß™ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 30 –¥–Ω—ñ–≤</button>
      <button class="btn secondary" id="clr">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
      <button class="btn good" id="an">üîé –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
      <span class="badge">–ó–∞–ø–∏—Å—ñ–≤: <b id="count">0</b></span>
    </div>
    <textarea id="txt" placeholder="–§–æ—Ä–º–∞—Ç: YYYY-MM-DD; In_m3; Out_m3; –ü—Ä–∏–º—ñ—Ç–∫–∞ (–æ–ø—Ü.)
2025-09-01; 12000; 11850; –±–∞–∑–æ–≤–µ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è
2025-09-02; 12150; 12090; –ø–æ—Ö–æ–ª–æ–¥–∞–Ω–Ω—è
..."></textarea>

    <div class="row">
      <label>–ö–æ—Ä–µ–∫—Ü—ñ—è T/P (–∫–æ–µ—Ñ. –¥–æ Out) <input id="kTP" class="input" type="number" step="0.001" value="1.010"><small class="muted">–ù–∞–ø—Ä., +1.0% –¥–æ –≤—ñ–¥–±–æ—Ä—É</small></label>
      <label>–ü–æ—Ö–∏–±–∫–∞ –ª—ñ—á. –≤—É–∑–ª–∞ In, % <input id="errIn" class="input" type="number" step="0.1" value="0.5"></label>
      <label>–ü–æ—Ö–∏–±–∫–∞ –ª—ñ—á. –≤—É–∑–ª–∞ Out, % <input id="errOut" class="input" type="number" step="0.1" value="1.0"></label>
      <label>–ü–æ—Ä—ñ–≥ –∞–Ω–æ–º–∞–ª—ñ—ó (œÉ) <input id="zThr" class="input" type="number" step="0.1" value="2.5"></label>
    </div>

    <div class="row">
      <label style="flex:1">What-if: –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –≤—Ç—Ä–∞—Ç–∏, % –≤—ñ–¥ Out<input id="whatPct" class="input" type="range" min="0" max="5" step="0.1" value="1.2"><small class="muted">–ü—Ä–æ–∫—Ä—É—Ç–∏ –ø–æ–≤–∑—É–Ω–æ–∫ ‚Äî –≤–ø–ª–∏–Ω–µ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫–∏ —ñ —Å–∞–Ω–∫—ñ</small></label>
      <span class="badge">–í—Ç—Ä–∞—Ç–∏ what-if: <b id="whatLbl">1.2%</b></span>
      <button class="btn" id="applyWhat">‚ñ∂Ô∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
      <button class="btn secondary" id="resetWhat">‚Ü©Ô∏è –°–∫–∏–Ω—É—Ç–∏</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üìà –ì—Ä–∞—Ñ—ñ–∫ 1 ‚Äî –î–æ–±–æ–≤–∏–π –±–∞–ª–∞–Ω—Å (In ‚àí Out‚Ä≤), –º¬≥</h2>
      <canvas id="cBal" class="chart" width="560" height="240"></canvas>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ 2 ‚Äî –ö—É–º—É–ª—è—Ç–∏–≤–Ω–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å, —Ç–∏—Å. –º¬≥</h2>
      <canvas id="cCum" class="chart" width="560" height="240"></canvas>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ 3 ‚Äî What-if: –±–∞–ª–∞–Ω—Å –∑—ñ —à—Ç—É—á–Ω–∏–º–∏ –≤—Ç—Ä–∞—Ç–∞–º–∏, –º¬≥</h2>
      <canvas id="cWhat" class="chart" width="560" height="240"></canvas>
    </div>

    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞ –∞–Ω–æ–º–∞–ª—ñ—ó</h2>
      <div class="row">
        <span class="tag ok">Œ£In: <b id="mIn">‚Äî</b> –º¬≥</span>
        <span class="tag ok">Œ£Out‚Ä≤: <b id="mOut">‚Äî</b> –º¬≥</span>
        <span class="tag warn">Œ£–¢–µ—Ö–≤—Ç—Ä–∞—Ç–∏: <b id="mTech">‚Äî</b> –º¬≥</span>
        <span class="tag bad">Œ£–î–∏—Å–±–∞–ª–∞–Ω—Å: <b id="mDiff">‚Äî</b> –º¬≥</span>
      </div>
      <table class="tbl" style="margin-top:8px">
        <thead><tr><th>#</th><th>–î–∞—Ç–∞</th><th>In</th><th>Out‚Ä≤</th><th>–ë–∞–ª–∞–Ω—Å</th><th>Z</th><th>–°—Ç—É–ø—ñ–Ω—å</th></tr></thead>
        <tbody id="tblAnom"><tr><td colspan="7" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr></tbody>
      </table>

      <h2 style="margin-top:10px">üîÄ –°–∞–Ω–∫—ñ (–ø–æ—Ç–æ–∫–∏ –∑–∞ –ø–µ—Ä—ñ–æ–¥)</h2>
      <svg id="sk" viewBox="0 0 520 220" role="img" aria-label="Sankey: In ‚Üí Consumption/Technical/Potential">
        <!-- –ü—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∏ -->
        <rect id="rIn"  x="20"  y="40" width="40" height="140" rx="6" fill="#14532d" stroke="#22c55e"/>
        <rect id="rCons" x="420" y="30" width="40" height="110" rx="6" fill="#0b1a2f" stroke="#93c5fd"/>
        <rect id="rTech" x="420" y="150" width="40" height="40"  rx="6" fill="#1f2937" stroke="#fbbf24"/>
        <rect id="rPot"  x="420" y="195" width="40" height="0"   rx="6" fill="#2a1212" stroke="#f87171"/>
        <!-- –ü—ñ–¥–ø–∏—Å–∏ -->
        <text x="20" y="28" fill="#e5e7eb" font-size="12">–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</text>
        <text x="410" y="20" fill="#e5e7eb" font-size="12">–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è / –í—Ç—Ä–∞—Ç–∏</text>
        <!-- –ü–æ—Ç–æ–∫–∏ (–º–∞–ª—é—î–º–æ —Å–∫—Ä–∏–ø—Ç–æ–º) -->
      </svg>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h2>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (—Ä—è–¥ –∑–∞ –¥–Ω–µ–º + –∞–Ω–æ–º–∞–ª—ñ—ó)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–ó–≥–µ–Ω–µ—Ä—É–π 30 –¥–Ω—ñ–≤ —ñ –∑–Ω–∞–π–¥–∏ <b>—Ç–æ–ø-5 –∞–Ω–æ–º–∞–ª—ñ–π</b>. –ü–æ—è—Å–Ω–∏ –º–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏.</li>
      <li>–ü—ñ–¥—ñ–±—Ä–∞–π –∫–æ—Ä–µ–∫—Ü—ñ—ó T/P —Ç–∞ –ø–æ—Ö–∏–±–∫–∏ —Ç–∞–∫, —â–æ–± <b>Œ£–î–∏—Å–±–∞–ª–∞–Ω—Å ‚Üí –º—ñ–Ω—ñ–º—É–º</b>, –∞–ª–µ <b>–∞–Ω–æ–º–∞–ª—ñ—ó</b> –ª–∏—à–∏–ª–∏—Å—å –≤–∏–¥–∏–º–∏–º–∏.</li>
      <li>–ü–æ—Å—Ç–∞–≤ what-if = <b>2.5%</b> —ñ –ø–æ—Ä—ñ–≤–Ω—è–π –∫—É–º—É–ª—è—Ç–∏–≤–Ω–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –¥–æ/–ø—ñ—Å–ª—è. –û–ø–∏—à–∏ –≤–ø–ª–∏–≤.</li>
      <li>–ï–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT —ñ –∑—Ä–æ–±–∏ –≤–∏—Å–Ω–æ–≤–∫–∏ —â–æ–¥–æ **–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤ –ø–æ—à—É–∫—É –≤—Ç—Ä–∞—Ç** (–¥—ñ–ª—è–Ω–∫–∏/–¥–∞—Ç–∏).</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

/* ===== –î–∂–µ—Ä–µ–ª–æ –¥–∞–Ω–∏—Ö ===== */
$('#txt').addEventListener('input',()=>$('#count').textContent=String(splitRows($('#txt').value).length));
$('#clr').addEventListener('click',()=>{ $('#txt').value=''; $('#count').textContent='0'; resetAll(); });

function splitRows(text){
  return text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
}
function parseRows(text){
  const rows=splitRows(text).map(line=>{
    const [d,inm,outm,...note]=line.split(';').map(s=>s.trim());
    const dt = new Date(d); const In=+inm, Out=+outm;
    if(!isFinite(dt.getTime())||!isFinite(In)||!isFinite(Out)) return null;
    return {date:d, In, Out, note:note.join('; ')||''};
  }).filter(Boolean);
  return rows;
}

function gen30(){
  const today=new Date(); const start=new Date(today); start.setDate(start.getDate()-29);
  const ar=[];
  let base=12000;
  for(let i=0;i<30;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    // —Å–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å/—à—É–º
    const seas = 400*Math.sin(i/6)+ (i>20? 600:0);
    const In = Math.round(base + seas + (Math.random()*300-150));
    let Out = Math.round(In - 80 + (Math.random()*240-120));
    // —ñ–Ω–∂–µ–∫—Ç—É—î–º–æ 4 –∞–Ω–æ–º–∞–ª—ñ—ó
    if([5,12,18,27].includes(i)) Out += (i%2? -800: +900);
    ar.push(`${d.toISOString().slice(0,10)}; ${In}; ${Out}; –∞–≤—Ç–æ–≥–µ–Ω`);
  }
  return ar.join('\n');
}
$('#gen').addEventListener('click',()=>{ $('#txt').value=gen30(); $('#count').textContent='30'; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ 30 –¥–Ω—ñ–≤'); });

/* ===== –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ ===== */
let lastResult=null, whatPct=+$('#whatPct').value;
$('#whatPct').addEventListener('input',()=>$('#whatLbl').textContent=$('#whatPct').value+'%');
$('#applyWhat').addEventListener('click',()=>{ whatPct=+$('#whatPct').value; if(lastResult) { drawAll(lastResult); log('–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ what-if: '+whatPct+'%'); }});
$('#resetWhat').addEventListener('click',()=>{ whatPct=0; $('#whatPct').value='0'; $('#whatLbl').textContent='0%'; if(lastResult){ drawAll(lastResult); log('–°–∫–∏–Ω—É—Ç–æ what-if'); }});

$('#an').addEventListener('click',()=>{
  const rows=parseRows($('#txt').value);
  if(!rows.length){ alert('–ù–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤'); return; }
  const kTP = +$('#kTP').value || 1.0;
  const errIn = (+$('#errIn').value||0)/100;
  const errOut = (+$('#errOut').value||0)/100;
  const zThr = +$('#zThr').value||2.5;

  // –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è In/Out –∑ –ø–æ—Ö–∏–±–∫–∞–º–∏
  const data = rows.map(r=>{
    const InCorr  = r.In * (1 + errIn);
    const OutCorr = r.Out * (1 + errOut) * kTP;
    const TechLoss = Math.max(0, 0.005*OutCorr + 0.00002*OutCorr*OutCorr/20000); // —É–º–æ–≤–Ω–∞ —Ç–µ—Ö–≤—Ç—Ä–∞—Ç–∞ (–Ω–µ–ª—ñ–Ω—ñ–π–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
    const Balance = InCorr - OutCorr - TechLoss; // –ø–æ–∑–∏—Ç–∏–≤–Ω–µ ‚Üí –Ω–∞–¥–ª–∏—à–æ–∫, –≤—ñ–¥‚Äô—î–º–Ω–µ ‚Üí –Ω–µ—Å—Ç–∞—á–∞
    return {...r, InCorr, OutCorr, TechLoss, Balance};
  });

  // Z-score –ø–æ —Ä—è–¥—É Balance
  const mean = data.reduce((a,b)=>a+b.Balance,0)/data.length;
  const sd = Math.sqrt(data.reduce((a,b)=>a+(b.Balance-mean)**2,0)/Math.max(1,data.length-1));
  data.forEach(d=>{
    d.Z = sd>0? (d.Balance-mean)/sd : 0;
    d.level = Math.abs(d.Z)>=zThr? 'P1' : (Math.abs(d.Z)>=zThr*0.6? 'P2':'OK');
  });

  // –ö—É–º—É–ª—è—Ç–∏–≤
  let c=0; data.forEach(d=>{ c+=d.Balance; d.Cum=c; });

  // –ü—ñ–¥—Å—É–º–∫–∏
  const sumIn = data.reduce((a,b)=>a+b.InCorr,0);
  const sumOut= data.reduce((a,b)=>a+b.OutCorr,0);
  const sumTech=data.reduce((a,b)=>a+b.TechLoss,0);
  const sumBal=data.reduce((a,b)=>a+b.Balance,0);

  lastResult={data, mean, sd, sums:{sumIn,sumOut,sumTech,sumBal}};
  drawAll(lastResult);
  log(`–ê–Ω–∞–ª—ñ–∑: Œº=${mean.toFixed(1)} –º¬≥, œÉ=${sd.toFixed(1)} –º¬≥, –∞–Ω–æ–º–∞–ª—ñ–π P1=${data.filter(x=>x.level==='P1').length}`);
});

function resetAll(){
  lastResult=null; ['mIn','mOut','mTech','mDiff'].forEach(id=>$('#'+id).textContent='‚Äî');
  $('#tblAnom').innerHTML='<tr><td colspan="7" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr>';
  [gb, gc, gw].forEach(ctx=>{ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,ctx.canvas.width-1,ctx.canvas.height-1); });
  drawSankey(0,0,0,0);
}

/* ===== –ì—Ä–∞—Ñ—ñ–∫–∏ ===== */
const cBal=$('#cBal'), gb=cBal.getContext('2d');
const cCum=$('#cCum'), gc=cCum.getContext('2d');
const cWhat=$('#cWhat'), gw=cWhat.getContext('2d');

function drawAll(res){
  const {data, sums}=res;
  // –ú–µ—Ç—Ä–∏–∫–∏
  $('#mIn').textContent = Math.round(sums.sumIn).toLocaleString('uk-UA');
  $('#mOut').textContent = Math.round(sums.sumOut).toLocaleString('uk-UA');
  $('#mTech').textContent = Math.round(sums.sumTech).toLocaleString('uk-UA');
  $('#mDiff').textContent = Math.round(sums.sumBal).toLocaleString('uk-UA');

  // –¢–∞–±–ª–∏—Ü—è –∞–Ω–æ–º–∞–ª—ñ–π (—Ç–æ–ø-10 –∑–∞ |Z|)
  const body=$('#tblAnom'); body.innerHTML='';
  data.slice().sort((a,b)=>Math.abs(b.Z)-Math.abs(a.Z)).slice(0,10).forEach((d,i)=>{
    const tr=document.createElement('tr');
    const cls = d.level==='P1'?'bad':(d.level==='P2'?'warn':'');
    tr.innerHTML = `<td>${i+1}</td><td>${d.date}</td><td>${d.InCorr.toFixed(0)}</td><td>${d.OutCorr.toFixed(0)}</td><td class="${cls}">${d.Balance.toFixed(0)}</td><td>${d.Z.toFixed(2)}</td><td><b>${d.level}</b></td>`;
    body.appendChild(tr);
  });

  // –ì—Ä–∞—Ñ—ñ–∫ 1 ‚Äî –¥–æ–±–æ–≤–∏–π –±–∞–ª–∞–Ω—Å
  drawBars(gb, data.map(x=>x.Balance), data.map(x=>x.date), '–º¬≥');

  // –ì—Ä–∞—Ñ—ñ–∫ 2 ‚Äî –∫—É–º—É–ª—è—Ç–∏–≤
  drawLine(gc, data.map(x=>x.Cum/1000), data.map(x=>x.date), '—Ç–∏—Å. –º¬≥');

  // What-if: –¥–æ–¥–∞–º–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –≤—Ç—Ä–∞—Ç–∏ –≤—ñ–¥ Out
  const what = data.map(x=> x.Balance - x.OutCorr*(whatPct/100) );
  drawBars(gw, what, data.map(x=>x.date), '–º¬≥ (what-if)');

  // –°–∞–Ω–∫—ñ
  const sumPot = data.reduce((a,b)=>a + b.OutCorr*(whatPct/100),0);
  drawSankey(sums.sumIn, sums.sumOut, sums.sumTech, sumPot);
}

function drawBars(ctx, vals, labels, unit){
  const W=ctx.canvas.width,H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H); ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  const maxAbs=Math.max(100, ...vals.map(v=>Math.abs(v)));
  const bw=(right-left)/vals.length;
  // —Å—ñ—Ç–∫–∞
  ctx.strokeStyle='#1f2a44';
  for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); }
  // –Ω—É–ª—å
  const y0=bottom - (0.5*(bottom-top)); // –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –Ω–∏–∂—á–µ:
  function Y(v){ return bottom - ((v+maxAbs)/(2*maxAbs))*(bottom-top); } // -max..+max ‚Üí top..bottom
  // —Å—Ç–æ–≤–ø—á–∏–∫–∏
  vals.forEach((v,i)=>{
    const x=left+i*bw+4; const y=Y(v); const yBase=Y(0);
    ctx.fillStyle = v>=0? '#22c55e' : '#f87171';
    ctx.fillRect(x, Math.min(y,yBase), bw-8, Math.abs(y-yBase));
  });
  // –ª–µ–≥–µ–Ω–¥–∞
  ctx.fillStyle='#e5e7eb'; ctx.font='11px ui-monospace';
  ctx.fillText(`–ê–º–ø–ª—ñ—Ç—É–¥–∞ ¬±${maxAbs.toFixed(0)} ${unit}`, right-160, top+12);
}

function drawLine(ctx, vals, labels, unit){
  const W=ctx.canvas.width,H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H); ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  const max=Math.max(1, ...vals.map(v=>Math.abs(v)));
  const X=i=> left + i/(Math.max(1,vals.length-1))*(right-left);
  const Y=v=> bottom - (v/max)*(bottom-top);
  // —Å—ñ—Ç–∫–∞
  ctx.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); }
  // –∫—Ä–∏–≤–∞
  ctx.beginPath(); ctx.strokeStyle='#38bdf8';
  vals.forEach((v,i)=>{ const x=X(i), y=Y(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  ctx.fillStyle='#e5e7eb'; ctx.font='11px ui-monospace';
  ctx.fillText(`–ú–∞–∫—Å ${max.toFixed(2)} ${unit}`, right-120, top+12);
}

/* ===== –°–∞–Ω–∫—ñ (—Å–ø—Ä–æ—â–µ–Ω–∏–π) ===== */
function drawSankey(sumIn, sumOut, sumTech, sumPot){
  const svg=$('#sk');
  // –æ—á–∏—Å—Ç–∏–º–æ –ø–æ—Ç–æ–∫–∏ (–∑–∞–ª–∏—à–∏–º–æ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∏/–ø—ñ–¥–ø–∏—Å–∏)
  [...svg.querySelectorAll('path.flow, text.lbl')].forEach(n=>n.remove());
  const hUnit = 140 / Math.max(1, sumIn); // –≤–∏—Å–æ—Ç–∞ –Ω–∞ –æ–¥–∏–Ω–∏—Ü—é (–Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ —Å—Ç–æ–≤–ø—á–∏–∫–∞ In)
  const hCons = Math.max(2, (sumOut)*hUnit);
  const hTech = Math.max(2, (sumTech)*hUnit);
  const hPot  = Math.max(0, (sumPot)*hUnit);

  // –≤–∏—Å–æ—Ç–∏ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫—ñ–≤ —Å–ø—Ä–∞–≤–∞
  const rCons=$('#rCons'), rTech=$('#rTech'), rPot=$('#rPot');
  rCons.setAttribute('height', hCons); rCons.setAttribute('y', 30 + (110-hCons));
  rTech.setAttribute('height', Math.max(2,hTech));
  rPot.setAttribute('height', hPot>0?hPot:0); rPot.setAttribute('y', 195 - hPot);

  // —Ñ—É–Ω–∫—Ü—ñ—è –º–∞–ª—é–≤–∞–Ω–Ω—è –∫—Ä–∏–≤–æ—ó
  const mk = (y0,y1,color,label,val)=>{
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('class','flow');
    p.setAttribute('fill',color); p.setAttribute('fill-opacity','0.35'); p.setAttribute('stroke',color); p.setAttribute('stroke-opacity','0.8');
    const x0=60, x1=420, w=Math.max(4, val*hUnit); // —Ç–æ–≤—â–∏–Ω–∞ –ø–æ—Ç–æ–∫—É
    const d=`M ${x0},${y0} C ${x0+140},${y0} ${x1-140},${y1} ${x1},${y1} 
             L ${x1},${y1+w} C ${x1-140},${y1+w} ${x0+140},${y0+w} ${x0},${y0+w} Z`;
    p.setAttribute('d', d); svg.appendChild(p);
    const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('class','lbl'); tx.setAttribute('x', (x0+x1)/2); tx.setAttribute('y', (y0+y1)/2 - 6);
    tx.setAttribute('fill','#e5e7eb'); tx.setAttribute('font-size','11'); tx.setAttribute('text-anchor','middle');
    tx.textContent = `${label}: ${Math.round(val).toLocaleString('uk-UA')} –º¬≥`; svg.appendChild(tx);
  };
  // –ø–æ–∑–∏—Ü—ñ—ó –¥–∂–µ—Ä–µ–ª–∞ (–ª—ñ–≤–µ)
  let yStart=40; // –≤–µ—Ä—Ö In
  // —Ä–æ–∑–∫–ª–∞–¥–∞—î–º–æ –Ω–∞ 3 –ø–æ—Ç–æ–∫–∏
  mk(yStart+10, (parseFloat(rCons.getAttribute('y'))||30)+4,  '#93c5fd', '–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è', sumOut);
  mk(yStart+60, (parseFloat(rTech.getAttribute('y'))||150)+4,  '#fbbf24', '–¢–µ—Ö–Ω—ñ—á–Ω—ñ',  sumTech);
  if(sumPot>0) mk(yStart+110, (parseFloat(rPot.getAttribute('y'))||195)+4, '#f87171', '–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ', sumPot);
}

/* ===== –ï–∫—Å–ø–æ—Ä—Ç ===== */
$('#saveCsv').addEventListener('click',()=>{
  if(!lastResult){ alert('–°–ø–µ—Ä—à—É –∞–Ω–∞–ª—ñ–∑'); return; }
  const {data}=lastResult;
  let csv='date,in_corr,out_corr,tech_loss,balance,z,level,cum\n';
  data.forEach(d=>{ csv+=`${d.date},${d.InCorr.toFixed(0)},${d.OutCorr.toFixed(0)},${d.TechLoss.toFixed(0)},${d.Balance.toFixed(0)},${d.Z.toFixed(3)},${d.level},${d.Cum.toFixed(0)}\n`; });
  download('gas_para18_balance_'+stamp()+'.csv', csv, 'text/csv'); log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click',()=>{
  if(!lastResult){ alert('–°–ø–µ—Ä—à—É –∞–Ω–∞–ª—ñ–∑'); return; }
  const {sums, data}=lastResult;
  const top = data.slice().sort((a,b)=>Math.abs(b.Z)-Math.abs(a.Z)).slice(0,5);
  const lines=[
    '–ü–∞—Ä–∞ 18 ‚Äî –ë–∞–ª–∞–Ω—Å/–≤—Ç—Ä–∞—Ç–∏: –ø—ñ–¥—Å—É–º–æ–∫',
    `Œ£In: ${Math.round(sums.sumIn)} –º¬≥`,
    `Œ£Out‚Ä≤: ${Math.round(sums.sumOut)} –º¬≥`,
    `Œ£–¢–µ—Ö–≤—Ç—Ä–∞—Ç–∏: ${Math.round(sums.sumTech)} –º¬≥`,
    `Œ£–î–∏—Å–±–∞–ª–∞–Ω—Å: ${Math.round(sums.sumBal)} –º¬≥`,
    `What-if –≤—Ç—Ä–∞—Ç–∏: ${whatPct}% –≤—ñ–¥ Out`,
    '--- –¢–æ–ø-5 –∞–Ω–æ–º–∞–ª—ñ–π (|Z|) ---',
    ...top.map(x=>`${x.date} Bal=${x.Balance.toFixed(0)} –º¬≥ Z=${x.Z.toFixed(2)} ‚Üí ${x.level}`),
  ];
  download('gas_para18_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

/* ===== –Ü–Ω—ñ—Ç ===== */
function initFrames(){
  [gb, gc, gw].forEach(ctx=>{ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,ctx.canvas.width-1,ctx.canvas.height-1); });
  drawSankey(0,0,0,0);
}
initFrames();
</script>
</body>
</html>
