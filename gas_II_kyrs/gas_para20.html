<!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 20 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –°—Ü–µ–Ω–∞—Ä–Ω–µ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è: –∑–∏–º–∞ vs –º—ñ–∂—Å–µ–∑–æ–Ω–Ω—è, –µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å, —Ç–∞—Ä–∏—Ñ, –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ª—ñ–º—ñ—Ç—ñ–≤</title>
<meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤: –∑–∏–º–æ–≤–∏–π/–º—ñ–∂—Å–µ–∑–æ–Ω–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å, –µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å –ø–æ–ø–∏—Ç—É, —Ç–∞—Ä–∏—Ñ–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó, –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è Vday/Pmax –∑–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—é —ñ —à—Ç—Ä–∞—Ñ–∞–º–∏, –≥—Ä–∞—Ñ—ñ–∫–∏, —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞, –µ–∫—Å–ø–æ—Ä—Ç.">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
h2{margin:.2em 0 .4em}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.map{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
pre.log{max-height:240px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
</style>
<link rel="canonical" href="https://edlab.pp.ua/gas_II_kyrs/gas_para20.html"><meta property="og:type" content="article"><meta property="og:title" content="–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 20"><meta property="og:description" content="–ú–æ–¥–µ–ª—é—î–º–æ –¥–æ–±–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è (24 –≥–æ–¥) –¥–ª—è –¥–≤–æ—Ö —Å–µ–∑–æ–Ω—ñ–≤: –∑–∏–º–∞ —Ç–∞ –º—ñ–∂—Å–µ–∑–æ–Ω–Ω—è. –í—Ä–∞—Ö–æ–≤—É—î–º–æ —Ü—ñ–Ω–æ–≤—É –µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å –ø–æ–ø–∏—Ç—É Œµ (–Ω–∞—Å–∫—ñ–ª—å–∫–∏ –ø–æ–ø–∏—Ç –∑–º—ñ–Ω—é—î—Ç—å—Å—è –≤—ñ–¥"><meta property="og:url" content="https://edlab.pp.ua/gas_II_kyrs/gas_para20.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 20","description":"–ú–æ–¥–µ–ª—é—î–º–æ –¥–æ–±–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è (24 –≥–æ–¥) –¥–ª—è –¥–≤–æ—Ö —Å–µ–∑–æ–Ω—ñ–≤: –∑–∏–º–∞ —Ç–∞ –º—ñ–∂—Å–µ–∑–æ–Ω–Ω—è. –í—Ä–∞—Ö–æ–≤—É—î–º–æ —Ü—ñ–Ω–æ–≤—É –µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å –ø–æ–ø–∏—Ç—É Œµ (–Ω–∞—Å–∫—ñ–ª—å–∫–∏ –ø–æ–ø–∏—Ç –∑–º—ñ–Ω—é—î—Ç—å—Å—è –≤—ñ–¥","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/gas_II_kyrs/gas_para20.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üßÆ‚ùÑÔ∏èüå§Ô∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 20 ‚Äî –°—Ü–µ–Ω–∞—Ä–Ω–µ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è</b><br>
        <span class="badge">–ó–∏–º–∞‚ÜîÔ∏é–ú—ñ–∂—Å–µ–∑–æ–Ω–Ω—è ‚Üí Œµ (–µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å) ‚Üí —Ç–∞—Ä–∏—Ñ ‚Üí –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è Vday/Pmax ‚Üí –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ú–æ–¥–µ–ª—é—î–º–æ –¥–æ–±–æ–≤–∏–π <b>–ø—Ä–æ—Ñ—ñ–ª—å —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è</b> (24 –≥–æ–¥) –¥–ª—è –¥–≤–æ—Ö —Å–µ–∑–æ–Ω—ñ–≤: <b>–∑–∏–º–∞</b> —Ç–∞ <b>–º—ñ–∂—Å–µ–∑–æ–Ω–Ω—è</b>.
      –í—Ä–∞—Ö–æ–≤—É—î–º–æ <b>—Ü—ñ–Ω–æ–≤—É –µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å –ø–æ–ø–∏—Ç—É</b> Œµ (–Ω–∞—Å–∫—ñ–ª—å–∫–∏ –ø–æ–ø–∏—Ç –∑–º—ñ–Ω—é—î—Ç—å—Å—è –≤—ñ–¥ —Ç–∞—Ä–∏—Ñ—É), –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ <b>—Ç–∞—Ä–∏—Ñ–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó</b> —ñ –ø—ñ–¥–±–∏—Ä–∞—î–º–æ <b>–ª—ñ–º—ñ—Ç–∏ V<sub>day</sub>, P<sub>max</sub></b>, —â–æ –º—ñ–Ω—ñ–º—ñ–∑—É—é—Ç—å —Å—É–º–∞—Ä–Ω—É <b>–≤–∞—Ä—Ç—ñ—Å—Ç—å</b> (–∑–∞–∫—É–ø—ñ–≤–ª—è ‚àí –¥–æ—Ö—ñ–¥ + —à—Ç—Ä–∞—Ñ–∏ –∑–∞ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è).</p>
    <div class="row">
      <label>–°–µ–∑–æ–Ω
        <select id="season" class="input">
          <option value="winter" selected="">–ó–∏–º–∞</option>
          <option value="shoulder">–ú—ñ–∂—Å–µ–∑–æ–Ω–Ω—è</option>
        </select>
      </label>
      <label>–ë–∞–∑–æ–≤–∏–π —Ç–∞—Ä–∏—Ñ, –≥—Ä–Ω/–º¬≥ <input id="tariffBase" class="input" type="number" step="0.01" value="10.00"></label>
      <label>–°—Ü–µ–Ω–∞—Ä—ñ–π —Ç–∞—Ä–∏—Ñ—É
        <select id="tariffMode" class="input">
          <option value="flat" selected="">–ü–ª–æ—Å–∫–∏–π (–±–µ–∑ –∑–º—ñ–Ω)</option>
          <option value="raise10">–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è +10%</option>
          <option value="timeOfUse">Time-of-Use (–¥–µ–Ω—å/–Ω—ñ—á)</option>
        </select>
      </label>
      <label>–ï–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å Œµ (–≤—ñ–¥‚Äô—î–º–Ω–∞) <input id="elas" class="input" type="number" step="0.05" value="-0.20"><small class="muted">ŒîQ/Q ‚âà Œµ ¬∑ ŒîP/P</small></label>
    </div>
    <div class="row">
      <label>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –∑–∞–∫—É–ø—ñ–≤–ª—ñ, –≥—Ä–Ω/–º¬≥ <input id="cost" class="input" type="number" step="0.01" value="8.00"></label>
      <label>–õ—ñ–º—ñ—Ç Vday, —Ç–∏—Å. –º¬≥ <input id="Vday" class="input" type="number" step="0.1" value="12.0"></label>
      <label>–õ—ñ–º—ñ—Ç Pmax, –º¬≥/–≥–æ–¥ <input id="Pmax" class="input" type="number" step="10" value="1100"></label>
      <label>–®—Ç—Ä–∞—Ñ –∑–∞ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è Vday, –≥—Ä–Ω/—Ç–∏—Å.–º¬≥ <input id="penDay" class="input" type="number" step="100" value="70000"></label>
      <label>–®—Ç—Ä–∞—Ñ –∑–∞ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è Pmax, –≥—Ä–Ω/–º¬≥/–≥–æ–¥ <input id="penP" class="input" type="number" step="10" value="200"></label>
    </div>
    <div class="row">
      <button class="btn good" id="run">‚ñ∂Ô∏è –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
      <button class="btn" id="opt">üß† –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –ª—ñ–º—ñ—Ç–∏</button>
      <button class="btn secondary" id="reset">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
      <span class="badge">Œ£Vday: <b id="mDay">‚Äî</b> —Ç–∏—Å.–º¬≥</span>
      <span class="badge">Pmax —Ñ–∞–∫—Ç: <b id="mPmax">‚Äî</b> –º¬≥/–≥–æ–¥</span>
      <span class="badge">–í–∞—Ä—Ç—ñ—Å—Ç—å (—á–∏—Å—Ç–∞): <b id="mNet">‚Äî</b> –≥—Ä–Ω</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üìà –ì—Ä–∞—Ñ—ñ–∫ 1 ‚Äî –ü—Ä–æ—Ñ—ñ–ª—å –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (–º¬≥/–≥–æ–¥)</h2>
      <div class="row">
        <label>–ü–æ–∫–∞–∑–∞—Ç–∏ –±–∞–∑–æ–≤–∏–π <input id="shBase" type="checkbox" checked=""></label>
        <label>–ü–æ–∫–∞–∑–∞—Ç–∏ —Å–∫–æ—Ä–∏–≥–æ–≤–∞–Ω–∏–π <input id="shAdj" type="checkbox" checked=""></label>
        <label>–õ—ñ–Ω—ñ—è Pmax <input id="shPmax" type="checkbox" checked=""></label>
        <button class="btn" id="mark">üìç –ó–Ω—è—Ç–∏ —Ç–æ—á–∫—É</button>
        <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
      </div>
      <canvas id="cProfile" class="chart" width="560" height="240"></canvas>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ 2 ‚Äî –ö—É–º—É–ª—è—Ç–∏–≤ –¥–æ–±–∏ vs Vday (—Ç–∏—Å. –º¬≥)</h2>
      <canvas id="cCum" class="chart" width="560" height="240"></canvas>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ 3 ‚Äî –î–æ—Ö—ñ–¥/—à—Ç—Ä–∞—Ñ/—á–∏—Å—Ç–∞ –º–∞—Ä–∂–∞ (–≥—Ä–Ω)</h2>
      <canvas id="cFin" class="chart" width="560" height="240"></canvas>
    </div>

    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ / –∞–ª–µ—Ä—Ç–∏ / —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞</h2>
      <div class="row">
        <span class="tag ok">Œ£–î–æ—Ö—ñ–¥: <b id="mRev">‚Äî</b></span>
        <span class="tag warn">Œ£–ó–∞–∫—É–ø—ñ–≤–ª—è: <b id="mBuy">‚Äî</b></span>
        <span class="tag bad">Œ£–®—Ç—Ä–∞—Ñ: <b id="mPen">‚Äî</b></span>
      </div>

      <table class="tbl" style="margin-top:8px">
        <thead><tr><th>–ì–æ–¥</th><th>–ë–∞–∑–∞</th><th>–ö–æ—Ä–∏–≥.</th><th>Tariff</th><th>ŒîQ, %</th></tr></thead>
        <tbody id="tbl"><tr><td colspan="5" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üó∫Ô∏è –¢–µ–ø–ª–æ–∫–∞—Ä—Ç–∞ –≥–æ–¥–∏–Ω (–∑–∏–º–∞ –ª—ñ–≤–æ—Ä—É—á / –º—ñ–∂—Å–µ–∑–æ–Ω–Ω—è –ø—Ä–∞–≤–æ—Ä—É—á)</h3>
      <canvas id="cHeat" class="map" width="520" height="240"></canvas>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (–ø—Ä–æ—Ñ—ñ–ª—ñ —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å–∏)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–ü–æ—Ä—ñ–≤–Ω—è–π <b>–ó–∏–º–∞ vs –ú—ñ–∂—Å–µ–∑–æ–Ω–Ω—è</b> –¥–ª—è Œµ = ‚àí0.2. –î–µ —ñ —á–æ–º—É –Ω–∞–π–±—ñ–ª—å—à–∏–π –≤–ø–ª–∏–≤ —Ç–∞—Ä–∏—Ñ—É –Ω–∞ –ø—ñ–∫?</li>
      <li>–í–∏–±–µ—Ä–∏ —Ä–µ–∂–∏–º <b>Time-of-Use</b> —ñ –∑–Ω–∞–π–¥–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Œµ, —â–æ–± <b>Pmax</b> –Ω–µ –ø–µ—Ä–µ–≤–∏—â—É–≤–∞–≤ –ª—ñ–º—ñ—Ç –±–µ–∑ –∑–Ω–∞—á—É—â–æ—ó –≤—Ç—Ä–∞—Ç–∏ Œ£Vday (&lt;3%).</li>
      <li>–ó–∞–ø—É—Å—Ç–∏ ¬´üß† –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –ª—ñ–º—ñ—Ç–∏¬ª. –ü–æ—è—Å–Ω–∏, —è–∫ –∑–º—ñ–Ω–∏–ª–∏—Å—è Vday/Pmax —Ç–∞ —â–æ —Å—Ç–∞–ª–æ –∑ —á–∏—Å—Ç–æ—é –º–∞—Ä–∂–µ—é.</li>
      <li>–ï–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT —ñ –ø—ñ–¥–≥–æ—Ç—É–π –∫–æ—Ä–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ –¥–ª—è —Ç–µ—Ö—Ä–∞–¥–∏ (—Ä–∏–∑–∏–∫–∏, –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó —â–æ–¥–æ —Ç–∞—Ä–∏—Ñ—ñ–≤/–ª—ñ–º—ñ—Ç—ñ–≤).</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

/* ===== –ë–∞–∑–æ–≤—ñ –¥–æ–±–æ–≤—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ (24 –≥–æ–¥) ===== */
function baseProfile(season){
  const out=[];
  for(let h=0;h<24;h++){
    let morning = Math.max(0, Math.sin((h-7)/3));
    let evening = Math.max(0, Math.sin((h-19)/3));
    if(season==='winter'){
      const level = 600; // –±–∞–∑–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å –≤–∑–∏–º–∫—É
      out.push(Math.round(level*(0.7 + 0.4*morning + 0.6*evening)));
    }else{
      const level = 380; // –º—ñ–∂—Å–µ–∑–æ–Ω–Ω—è
      out.push(Math.round(level*(0.6 + 0.25*morning + 0.35*evening)));
    }
  }
  return out;
}

/* ===== –¢–∞—Ä–∏—Ñ–Ω—ñ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö ===== */
function tariffArray(mode, base){
  const k=new Array(24).fill(base);
  if(mode==='raise10'){
    for(let h=0;h<24;h++) k[h]=base*1.10;
  } else if(mode==='timeOfUse'){
    for(let h=0;h<24;h++){
      const peak = (h>=7&&h<=10)||(h>=18&&h<=22); // –ø—ñ–∫ ‚Üí +15%; –Ω—ñ—á ‚Üí -10%
      const night = (h>=0&&h<=5);
      k[h]= base*(peak?1.15:(night?0.90:1.00));
    }
  }
  return k;
}

/* ===== –ï–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å: Qadj = Qbase * (1 + Œµ * ŒîP/P) ===== */
function adjustByElasticity(qBase, tariff, baseTariff, epsilon){
  const out=[];
  for(let h=0;h<24;h++){
    const dP = (tariff[h]-baseTariff)/baseTariff; // –≤—ñ–¥–Ω–æ—Å–Ω–∞ –∑–º—ñ–Ω–∞ —Ü—ñ–Ω–∏
    const k = 1 + epsilon * dP;
    out[h] = Math.max(0, Math.round(qBase[h]*k));
  }
  return out;
}

/* ===== –§—ñ–Ω–∞–Ω—Å–∏ —Ç–∞ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è ===== */
function finance(qAdj, tariff, cost, Vday, Pmax, penDay, penP){
  const sumDay = qAdj.reduce((a,b)=>a+b,0)/1000; // —Ç–∏—Å.–º3
  const pmax = Math.max(...qAdj);
  const rev = qAdj.reduce((a,b,i)=>a + b*tariff[i], 0); // –≥—Ä–Ω
  const buy = qAdj.reduce((a,b)=>a + b*cost, 0);
  const overDay = Math.max(0, sumDay - Vday); // —Ç–∏—Å.–º3
  const overP = Math.max(0, pmax - Pmax); // –º3/–≥–æ–¥
  const pen = overDay*penDay + overP*penP;
  const net = rev - buy - pen;
  return {sumDay,pmax,rev,buy,pen,net,overDay,overP};
}

/* ===== –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω ===== */
let BASE_W = baseProfile('winter');
let BASE_S = baseProfile('shoulder');
let series = {base:[], adj:[], tariff:[]};
let histFin = []; // —ñ—Å—Ç–æ—Ä—ñ—è –º–∞—Ä–∫–µ—Ä—ñ–≤

/* ===== –ü–æ–±—É–¥–æ–≤–∞/—Ä–µ–Ω–¥–µ—Ä ===== */
const cProfile=$('#cProfile'), g1=cProfile.getContext('2d');
const cCum=$('#cCum'), g2=cCum.getContext('2d');
const cFin=$('#cFin'), g3=cFin.getContext('2d');
const cHeat=$('#cHeat'), gh=cHeat.getContext('2d');

function drawProfile(showBase, showAdj, showPmax, Pmax){
  const W=cProfile.width,H=cProfile.height; g1.clearRect(0,0,W,H);
  g1.strokeStyle='#223049'; g1.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  const max=Math.max(Pmax, ...series.base, ...series.adj, 100);
  const X=i=> left + i/23*(right-left);
  const Y=v=> bottom - (v/max)*(bottom-top);
  // —Å—ñ—Ç–∫–∞
  g1.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; g1.beginPath(); g1.moveTo(left,y); g1.lineTo(right,y); g1.stroke(); }
  // –∫—Ä–∏–≤—ñ
  if(showBase){
    g1.beginPath(); g1.strokeStyle='#38bdf8';
    series.base.forEach((v,i)=>{ const x=X(i), y=Y(v); if(i===0) g1.moveTo(x,y); else g1.lineTo(x,y); }); g1.stroke();
  }
  if(showAdj){
    g1.beginPath(); g1.strokeStyle='#22c55e';
    series.adj.forEach((v,i)=>{ const x=X(i), y=Y(v); if(i===0) g1.moveTo(x,y); else g1.lineTo(x,y); }); g1.stroke();
  }
  if(showPmax){
    const y=Y(Pmax); g1.strokeStyle='#fbbf24'; g1.beginPath(); g1.moveTo(left,y); g1.lineTo(right,y); g1.stroke();
    g1.fillStyle='#e5e7eb'; g1.font='11px ui-monospace'; g1.fillText('Pmax', right-44, y-4);
  }
}

function drawCum(Vday){
  const W=cCum.width,H=cCum.height; g2.clearRect(0,0,W,H);
  g2.strokeStyle='#223049'; g2.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  const cum=[]; let s=0; for(let h=0;h<24;h++){ s+=series.adj[h]; cum[h]=s/1000; }
  const max=Math.max(Vday, ...cum, 1);
  const X=i=> left + i/23*(right-left);
  const Y=v=> bottom - (v/max)*(bottom-top);
  g2.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; g2.beginPath(); g2.moveTo(left,y); g2.lineTo(right,y); g2.stroke(); }
  g2.beginPath(); g2.strokeStyle='#38bdf8';
  cum.forEach((v,i)=>{ const x=X(i), y=Y(v); if(i===0) g2.moveTo(x,y); else g2.lineTo(x,y); }); g2.stroke();
  const y=Y(Vday); g2.strokeStyle='#fbbf24'; g2.beginPath(); g2.moveTo(left,y); g2.lineTo(right,y); g2.stroke();
  g2.fillStyle='#e5e7eb'; g2.font='11px ui-monospace'; g2.fillText('Vday', right-44, y-4);
}

function drawFin(fin){
  const W=cFin.width,H=cFin.height; g3.clearRect(0,0,W,H);
  g3.strokeStyle='#223049'; g3.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  const bars=[fin.rev, fin.buy, fin.pen, fin.net];
  const labels=['–î–æ—Ö—ñ–¥','–ó–∞–∫—É–ø—ñ–≤–ª—è','–®—Ç—Ä–∞—Ñ','–ß–∏—Å—Ç–∞'];
  const max=Math.max(...bars.map(v=>Math.abs(v)), 1000);
  const bw=(right-left)/bars.length;
  g3.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; g3.beginPath(); g3.moveTo(left,y); g3.lineTo(right,y); g3.stroke(); }
  bars.forEach((v,i)=>{
    const x=left+i*bw+10; const yBase=bottom - (0/max)*(bottom-top);
    const y= bottom - (v/max)*(bottom-top);
    g3.fillStyle = i===0? '#22c55e' : (i===3? '#93c5fd' : '#f87171');
    g3.fillRect(x, Math.min(y,yBase), bw-20, Math.abs(y-yBase));
    g3.fillStyle='#e5e7eb'; g3.font='11px ui-monospace'; g3.fillText(labels[i], x+4, top+12);
  });
}

function drawHeat(){
  const W=cHeat.width,H=cHeat.height; gh.clearRect(0,0,W,H);
  gh.strokeStyle='#223049'; gh.strokeRect(0.5,0.5,W-1,H-1);
  const left=60, top=24, cellW=(W-left-10)/24, cellH=(H-40)/2;
  // –∑–∏–º–∞
  let maxW=Math.max(...BASE_W); let maxS=Math.max(...BASE_S);
  for(let h=0;h<24;h++){
    let t=BASE_W[h]/maxW; const r=Math.floor(80+150*t), gg=Math.floor(100+120*t), b=120;
    gh.fillStyle=`rgb(${r},${gg},${b})`; gh.fillRect(left+h*cellW, top, cellW-1, cellH-2);
  }
  // –º—ñ–∂—Å–µ–∑
  for(let h=0;h<24;h++){
    let t=BASE_S[h]/maxS; const r=Math.floor(80+150*t), gg=Math.floor(100+120*t), b=120;
    gh.fillStyle=`rgb(${r},${gg},${b})`; gh.fillRect(left+h*cellW, top+cellH, cellW-1, cellH-2);
  }
  gh.fillStyle='#94a3b8'; gh.font='11px ui-monospace';
  gh.fillText('–≥–æ–¥–∏–Ω–∏ ‚Üí', left, 16);
  gh.fillText('–ó–∏–º–∞', 10, top+cellH/2);
  gh.fillText('–ú—ñ–∂—Å–µ–∑–æ–Ω–Ω—è', 10, top+cellH+cellH/2);
}

/* ===== –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ü–µ–Ω–∞—Ä—ñ—é ===== */
function recalc(){
  const season=$('#season').value;
  const baseTar= parseFloat($('#tariffBase').value)||10;
  const mode=$('#tariffMode').value;
  const epsilon= parseFloat($('#elas').value)||-0.2;
  const cost= parseFloat($('#cost').value)||8;
  const Vday = parseFloat($('#Vday').value)||12;
  const Pmax = parseFloat($('#Pmax').value)||1100;
  const penDay=parseFloat($('#penDay').value)||70000;
  const penP=parseFloat($('#penP').value)||200;

  const qBase = season==='winter'? BASE_W.slice():BASE_S.slice();
  const tarArr = tariffArray(mode, baseTar);
  const qAdj  = adjustByElasticity(qBase, tarArr, baseTar, epsilon);
  series.base=qBase; series.adj=qAdj; series.tariff=tarArr;

  const fin = finance(qAdj, tarArr, cost, Vday, Pmax, penDay, penP);

  // –ú–µ—Ç—Ä–∏–∫–∏
  $('#mDay').textContent=fin.sumDay.toFixed(3);
  $('#mPmax').textContent=fin.pmax.toFixed(0);
  $('#mRev').textContent=Math.round(fin.rev).toLocaleString('uk-UA');
  $('#mBuy').textContent=Math.round(fin.buy).toLocaleString('uk-UA');
  $('#mPen').textContent=Math.round(fin.pen).toLocaleString('uk-UA');
  $('#mNet').textContent=Math.round(fin.net).toLocaleString('uk-UA');

  // –¢–∞–±–ª–∏—Ü—è
  const tb=$('#tbl'); tb.innerHTML='';
  for(let h=0;h<24;h++){
    const dQ = series.base[h]===0? 0 : (series.adj[h]-series.base[h])/series.base[h]*100;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${String(h).padStart(2,'0')}</td><td>${series.base[h]}</td><td>${series.adj[h]}</td><td>${series.tariff[h].toFixed(2)}</td><td>${dQ.toFixed(1)}</td>`;
    tb.appendChild(tr);
  }

  // –ê–ª—Ä—Ç–∏/–∂—É—Ä–Ω–∞–ª
  const alarms=[];
  if(fin.overP>0) alarms.push(`–ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ Pmax –Ω–∞ ${fin.overP.toFixed(0)} –º¬≥/–≥–æ–¥`);
  if(fin.overDay>0) alarms.push(`–ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ Vday –Ω–∞ ${fin.overDay.toFixed(3)} —Ç–∏—Å.–º¬≥`);
  $('#alog').textContent = (function(){
    const t=new Date().toLocaleTimeString('uk-UA');
    let s=`[${t}] –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫: Œ£=${fin.sumDay.toFixed(3)} —Ç–∏—Å.–º¬≥, Pmax=${fin.pmax.toFixed(0)} –º¬≥/–≥–æ–¥, net=${Math.round(fin.net)} –≥—Ä–Ω\n`;
    if(alarms.length) s+=`[${t}] ‚ö†Ô∏è ${alarms.join('; ')}\n`;
    return s;
  })();

  // –ì—Ä–∞—Ñ—ñ–∫–∏
  drawProfile($('#shBase').checked,$('#shAdj').checked,$('#shPmax').checked,Pmax);
  drawCum(Vday);
  drawFin(fin);
}

/* ===== –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ª—ñ–º—ñ—Ç—ñ–≤ (–≥—Ä—É–±–∏–π –ø–æ—à—É–∫) =====
–ú–µ—Ç–∞: –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ netCost = buy - rev + –ø–µ–Ω—ñ.
–ü–∞—Ä–∞–º–µ—Ç—Ä–∏: Vday ‚àà [minDay..maxDay] —Ç–∏—Å.–º¬≥; Pmax ‚àà [minP..maxP] –º¬≥/–≥–æ–¥.
*/
function optimize(){
  const baseTar= parseFloat($('#tariffBase').value)||10;
  const mode=$('#tariffMode').value;
  const epsilon= parseFloat($('#elas').value)||-0.2;
  const cost= parseFloat($('#cost').value)||8;
  const penDay=parseFloat($('#penDay').value)||70000;
  const penP=parseFloat($('#penP').value)||200;
  const qBase = ($('#season').value==='winter'? BASE_W:BASE_S).slice();
  const tarArr = tariffArray(mode, baseTar);
  const qAdj  = adjustByElasticity(qBase, tarArr, baseTar, epsilon);

  const minDay=Math.max(6, qAdj.reduce((a,b)=>a+b,0)/1000*0.7);
  const maxDay=Math.max(minDay+1, qAdj.reduce((a,b)=>a+b,0)/1000*1.1);
  const minP=Math.max(500, Math.max(...qAdj)*0.7);
  const maxP=Math.max(minP+50, Math.max(...qAdj)*1.1);

  let best={Vday:parseFloat($('#Vday').value), Pmax:parseFloat($('#Pmax').value), net:-1e18, rev:0,buy:0,pen:0,sumDay:0,pmax:0};
  for(let V=minDay; V<=maxDay; V+=0.2){
    for(let P=minP; P<=maxP; P+=10){
      const fin=finance(qAdj, tarArr, cost, V, P, penDay, penP);
      if(fin.net>best.net) best={...fin,Vday:parseFloat(V.toFixed(1)),Pmax:Math.round(P)};
    }
  }
  $('#Vday').value=best.Vday.toFixed(1);
  $('#Pmax').value=String(best.Pmax);
  log(`–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è: Vday=${best.Vday} —Ç–∏—Å.–º¬≥, Pmax=${best.Pmax} –º¬≥/–≥–æ–¥, net=${Math.round(best.net)} –≥—Ä–Ω`);
  recalc();
}

/* ===== –ö–Ω–æ–ø–∫–∏ ===== */
$('#run').addEventListener('click', recalc);
$('#opt').addEventListener('click', optimize);
$('#reset').addEventListener('click', ()=>{
  $('#season').value='winter'; $('#tariffBase').value='10.00'; $('#tariffMode').value='flat'; $('#elas').value='-0.20';
  $('#cost').value='8.00'; $('#Vday').value='12.0'; $('#Pmax').value='1100'; $('#penDay').value='70000'; $('#penP').value='200';
  recalc(); log('–°–∫–∏–¥–∞–Ω–Ω—è –¥–æ –±–∞–∑–æ–≤–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å');
});
$('#shBase').addEventListener('change', ()=>drawProfile($('#shBase').checked,$('#shAdj').checked,$('#shPmax').checked, parseFloat($('#Pmax').value)||1100));
$('#shAdj').addEventListener('change', ()=>drawProfile($('#shBase').checked,$('#shAdj').checked,$('#shPmax').checked, parseFloat($('#Pmax').value)||1100));
$('#shPmax').addEventListener('change',()=>drawProfile($('#shBase').checked,$('#shAdj').checked,$('#shPmax').checked, parseFloat($('#Pmax').value)||1100));
$('#mark').addEventListener('click', ()=>{
  const finText=$('#mNet').textContent.replace(/\s/g,''); const net=isNaN(parseInt(finText))?0:parseInt(finText);
  histFin.push({t:new Date().toISOString(), net});
  log(`–ú–∞—Ä–∫–µ—Ä: —á–∏—Å—Ç–∞ = ${net} –≥—Ä–Ω (–≤—Å—å–æ–≥–æ –º–∞—Ä–∫–µ—Ä—ñ–≤: ${histFin.length})`);
});
$('#clear').addEventListener('click', ()=>{
  const W=cProfile.width,H=cProfile.height; g1.clearRect(0,0,W,H); g1.strokeStyle='#223049'; g1.strokeRect(0.5,0.5,W-1,H-1);
  const W2=cCum.width,H2=cCum.height; g2.clearRect(0,0,W2,H2); g2.strokeStyle='#223049'; g2.strokeRect(0.5,0.5,W2-1,H2-1);
  const W3=cFin.width,H3=cFin.height; g3.clearRect(0,0,W3,H3); g3.strokeStyle='#223049'; g3.strokeRect(0.5,0.5,W3-1,H3-1);
  log('–ì—Ä–∞—Ñ—ñ–∫–∏ –æ—á–∏—â–µ–Ω–æ');
});

/* ===== –ï–∫—Å–ø–æ—Ä—Ç ===== */
$('#saveCsv').addEventListener('click',()=>{
  let csv='hour,q_base,q_adj,tariff\n';
  for(let h=0;h<24;h++){ csv+=`${String(h).padStart(2,'0')},${series.base[h]||0},${series.adj[h]||0},${(series.tariff[h]||0).toFixed(2)}\n`; }
  csv+='\n# summary\nmetric,value\n';
  csv+=`sum_day_km3,${$('#mDay').textContent}\n`;
  csv+=`pmax_m3ph,${$('#mPmax').textContent}\n`;
  csv+=`revenue_uah,${$('#mRev').textContent}\n`;
  csv+=`buy_uah,${$('#mBuy').textContent}\n`;
  csv+=`penalty_uah,${$('#mPen').textContent}\n`;
  csv+=`net_uah,${$('#mNet').textContent}\n`;
  download('gas_para20_scenario_'+stamp()+'.csv', csv, 'text/csv');
  log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click',()=>{
  const lines=[
    '–ü–∞—Ä–∞ 20 ‚Äî –°—Ü–µ–Ω–∞—Ä–Ω–µ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è: –ø—ñ–¥—Å—É–º–æ–∫',
    `–°–µ–∑–æ–Ω: ${$('#season').value}`,
    `–¢–∞—Ä–∏—Ñ: ${$('#tariffMode').value} (–±–∞–∑–∞ ${$('#tariffBase').value} –≥—Ä–Ω/–º¬≥), Œµ=${$('#elas').value}`,
    `–õ—ñ–º—ñ—Ç–∏: Vday=${$('#Vday').value} —Ç–∏—Å.–º¬≥; Pmax=${$('#Pmax').value} –º¬≥/–≥–æ–¥`,
    `Œ£Vday: ${$('#mDay').textContent} —Ç–∏—Å.–º¬≥; Pmax: ${$('#mPmax').textContent} –º¬≥/–≥–æ–¥`,
    `–î–æ—Ö—ñ–¥: ${$('#mRev').textContent} –≥—Ä–Ω; –ó–∞–∫—É–ø—ñ–≤–ª—è: ${$('#mBuy').textContent} –≥—Ä–Ω; –®—Ç—Ä–∞—Ñ: ${$('#mPen').textContent} –≥—Ä–Ω; –ß–∏—Å—Ç–∞: ${$('#mNet').textContent} –≥—Ä–Ω`,
    `–ú–∞—Ä–∫–µ—Ä—ñ–≤ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${histFin.length}`
  ];
  download('gas_para20_summary_'+stamp()+'.txt', lines.join('\n'));
  log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

/* ===== –Ü–Ω—ñ—Ç ===== */
drawHeat(); recalc();
</script>


</body></html>