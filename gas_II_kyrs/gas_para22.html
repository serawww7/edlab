<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 22 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî AI-—Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –ø–æ–∫–∞–∑—ñ–≤: —Ñ–æ—Ç–æ ‚Üí OCR ‚Üí –∞–Ω–æ–º–∞–ª—ñ—ó ‚Üí –∫–≤–∏—Ç–∞–Ω—Ü—ñ—è/CSV/TXT/QR</title>
<meta name="description" content="–ö–∞–º–µ—Ä–∞/—Ñ–æ—Ç–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞, —Ä—É—á–Ω–µ –∫–∞–¥—Ä—É–≤–∞–Ω–Ω—è (ROI), OCR (Tesseract.js), –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó (–¥–æ–≤–∂–∏–Ω–∞/–≤—ñ–¥–∫–∞—Ç/—Å—Ç—Ä–∏–±–æ–∫), –≥—Ä–∞—Ñ—ñ–∫ —ñ—Å—Ç–æ—Ä—ñ—ó, —á–µ–∫ 58 –º–º, CSV/TXT, QR –Ω–∞ –¥–æ–∫–∞–∑–∏."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:110px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.view{display:block;width:100%;height:auto;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
pre.log{max-height:220px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üì∑üî¢</span>
      <div>
        <b>–ü–∞—Ä–∞ 22 ‚Äî AI-—Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –ø–æ–∫–∞–∑—ñ–≤ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞</b><br/>
        <span class="badge">–ö–∞–º–µ—Ä–∞/—Ñ–æ—Ç–æ ‚Üí ROI ‚Üí OCR ‚Üí –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí —á–µ–∫ 58–º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ó–Ω—ñ–º–∏ –∫–∞–¥—Ä —ñ–∑ <b>–≤–µ–±–∫–∞–º–µ—Ä–∏</b> –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂ <b>—Ñ–æ—Ç–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞</b>, –æ–±–≤–µ–¥–∏ –æ–±–ª–∞—Å—Ç—å —Ü–∏—Ñ—Ä (<b>ROI</b>), –Ω–∞—Ç–∏—Å–Ω–∏ <b>OCR</b>. –°–∏—Å—Ç–µ–º–∞ –≤–∏—Ç—è–≥–Ω–µ <b>–ø–æ–∫–∞–∑</b>, –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å <b>–∞–Ω–æ–º–∞–ª—ñ—ó</b> (–≤—ñ–¥–∫–∞—Ç/—Å—Ç—Ä–∏–±–æ–∫/–¥–æ–≤–∂–∏–Ω–∞), –ø–æ–±—É–¥—É—î <b>–≥—Ä–∞—Ñ—ñ–∫ —ñ—Å—Ç–æ—Ä—ñ—ó</b> —ñ –∑–≥–µ–Ω–µ—Ä—É—î <b>–∫–≤–∏—Ç–∞–Ω—Ü—ñ—é 58 –º–º</b>, <b>CSV/TXT</b> —Ç–∞ <b>QR</b> –Ω–∞ –¥–æ–∫–∞–∑–∏.</p>
    <div class="row">
      <button class="btn" id="camOn">üé• –ö–∞–º–µ—Ä–∞</button>
      <button class="btn secondary" id="camShot">üì∏ –ó–Ω—ñ–º–æ–∫</button>
      <input id="file" type="file" accept="image/*" class="input" style="max-width:320px"/>
      <button class="btn good" id="runOcr">üîé OCR (—Ü–∏—Ñ—Ä–∏)</button>
      <span class="badge">–°—Ç–∞—Ç—É—Å: <b id="st">–≥–æ—Ç–æ–≤–æ</b></span>
    </div>
    <div class="row">
      <label>‚Ññ –≤—É–∑–ª–∞/–∞–±–æ–Ω–µ–Ω—Ç–∞ <input id="acc" class="input" placeholder="MTR-0001 / –û—Å–æ–±–æ–≤–∏–π ‚Ññ"></label>
      <label>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑ (–º¬≥) <input id="prev" class="input" type="number" step="0.001" value="1234.000"></label>
      <label>–î–æ–≤–∂–∏–Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (—Ü—ñ–ªi —Ü–∏—Ñ—Ä–∏) <input id="digits" class="input" type="number" step="1" value="7"></label>
      <label>–ú–∞–∫—Å. –¥–æ–±–æ–≤–µ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è, –º¬≥ <input id="maxDay" class="input" type="number" step="1" value="80"></label>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üñºÔ∏è –ö–∞–¥—Ä/ROI/–æ–±—Ä–æ–±–∫–∞</h2>
      <video id="v" width="640" height="360" autoplay playsinline style="width:100%;max-height:320px;border:1px solid var(--line);border-radius:12px;background:#0b1220"></video>
      <canvas id="c" class="view" width="960" height="540"></canvas>
      <small class="muted">–ü–æ—Ä–∞–¥–∞: –≤–∏—Ä—ñ–≤–Ω—è–π –∫–∞–¥—Ä, —â–æ–± —Ü–∏—Ñ—Ä–∏ –±—É–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ; —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Å—è —Ä–∞–º–∫–æ—é ROI –Ω–∏–∂—á–µ.</small>

      <h3 style="margin-top:10px">‚úÇÔ∏è –†–∞–º–∫–∞ ROI (–ø–µ—Ä–µ—Ç—è–≥–Ω–∏/—Ä–æ–∑—Ç—è–≥–Ω–∏)</h3>
      <canvas id="roi" class="view" width="960" height="180"></canvas>
      <div class="row">
        <button class="btn" id="roiFromFull">‚ÜòÔ∏è ROI —ñ–∑ –∫–∞–¥—Ä—É</button>
        <button class="btn secondary" id="roiClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ ROI</button>
        <label>–ë—ñ–Ω–∞—Ä–∏–∑–∞—Ü—ñ—è, –ø–æ—Ä—ñ–≥ (0‚Äì255) <input id="thr" class="input" type="number" step="1" value="160"></label>
        <button class="btn" id="prep">üß™ –ü–µ—Ä–µ–¥–æ–±—Ä–æ–±–∫–∞</button>
      </div>
    </div>

    <div class="card">
      <h2>üî¢ –†–µ–∑—É–ª—å—Ç–∞—Ç OCR —ñ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó</h2>
      <table class="tbl">
        <thead><tr><th>–î–∞—Ç–∞/—á–∞—Å</th><th>–ê–±–æ–Ω–µ–Ω—Ç</th><th>–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ</th><th>–ü–æ–∫–∞–∑, –º¬≥</th><th>Œî –¥–æ –ø–æ–ø–µ—Ä–µ–¥., –º¬≥</th><th>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏</th></tr></thead>
        <tbody id="tbl"><tr><td colspan="6" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ–∫–∞–∑—ñ–≤</h3>
      <canvas id="chart" class="chart" width="520" height="220"></canvas>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–∞–ø–∫–∞ –¥–æ–∫–∞–∑—ñ–≤)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div style="margin-top:8px"><canvas id="qr" width="220" height="220" style="background:#0b1220;border:1px solid var(--line);border-radius:12px"></canvas></div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–ó–Ω—ñ–º–∏ 3 —Ñ–æ—Ç–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ —Ä—ñ–∑–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π. –î–æ–±–∏–π—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ OCR —á–µ—Ä–µ–∑ ROI —ñ ¬´–ë—ñ–Ω–∞—Ä–∏–∑–∞—Ü—ñ—é¬ª.</li>
      <li>–í–≤–µ–¥–∏ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π <b>–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑</b> —ñ –ø–æ—è—Å–Ω–∏, —á–æ–º—É —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–Ω–∞—á–∏–ª–∞/–Ω–µ –ø–æ–∑–Ω–∞—á–∏–ª–∞ <b>–∞–Ω–æ–º–∞–ª—ñ—é</b>.</li>
      <li>–ó–≥–µ–Ω–µ—Ä—É–π <b>–∫–≤–∏—Ç–∞–Ω—Ü—ñ—é 58 –º–º</b>, –µ–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT, —Å—Ç–≤–æ—Ä–∏ QR –Ω–∞ –ø–∞–ø–∫—É –∑ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ –¥–æ–∫–∞–∑–∞–º–∏.</li>
      <li>–ü–æ—Ä—ñ–≤–Ω—è–π —è–∫—ñ—Å—Ç—å OCR –ø—Ä–∏ —Ä—ñ–∑–Ω–∏—Ö –ø–æ—Ä–æ–≥–∞—Ö —Ç–∞ –∫—É—Ç—ñ –∑–π–æ–º–∫–∏. –°—Ñ–æ—Ä–º—É–ª—é–π —Ç–æ–ø-5 –ø–æ—Ä–∞–¥ –¥–ª—è –±—Ä–∏–≥–∞–¥–∏.</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<!-- Tesseract.js (OCR —É –±—Ä–∞—É–∑–µ—Ä—ñ) -->
<script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

/* ===== –ö–∞–º–µ—Ä–∞ / –∑–Ω—ñ–º–æ–∫ / —Ñ–∞–π–ª ===== */
const v=$('#v'), c=$('#c'), gc=c.getContext('2d');
let stream=null, img=new Image();
$('#camOn').addEventListener('click', async ()=>{
  try{ stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false}); v.srcObject=stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ'); }catch(e){ alert('–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏'); }
});
$('#camShot').addEventListener('click', ()=>{
  if(!v.srcObject){ alert('–ö–∞–º–µ—Ä–∞ –Ω–µ —É–≤—ñ–º–∫–Ω–µ–Ω–∞'); return; }
  c.width=v.videoWidth||960; c.height=v.videoHeight||540;
  gc.drawImage(v,0,0,c.width,c.height);
  img.src=c.toDataURL('image/png');
  log('–ó—Ä–æ–±–ª–µ–Ω–æ –∑–Ω—ñ–º–æ–∫ –∑ –∫–∞–º–µ—Ä–∏');
});
$('#file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ img.onload=()=>{ c.width=img.width; c.height=img.height; gc.drawImage(img,0,0); log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ñ–æ—Ç–æ'); }; img.src=r.result; };
  r.readAsDataURL(f);
});

/* ===== ROI –ø–æ–ª–æ—Ç–Ω–æ (—Ä—É—á–Ω–∏–π –∫—Ä—ñ–ø) ===== */
const roi=$('#roi'), gr=roi.getContext('2d');
let roiRect={x:120,y:40,w:720,h:80}, dragging=false, dragOff=[0,0], resizing=false, resizeAnchor=null;
function drawROI(){
  gr.clearRect(0,0,roi.width,roi.height);
  gr.strokeStyle='#223049'; gr.strokeRect(0.5,0.5,roi.width-1,roi.height-1);
  // –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫
  gr.strokeStyle='#38bdf8'; gr.lineWidth=2; gr.strokeRect(roiRect.x,roiRect.y,roiRect.w,roiRect.h);
  // —Ä—É—á–∫–∏
  const hs=[[roiRect.x,roiRect.y],[roiRect.x+roiRect.w,roiRect.y],[roiRect.x,roiRect.y+roiRect.h],[roiRect.x+roiRect.w,roiRect.y+roiRect.h]];
  gr.fillStyle='#38bdf8'; hs.forEach(([x,y])=>gr.fillRect(x-4,y-4,8,8));
}
function hitHandle(x,y){
  const hs=[[roiRect.x,roiRect.y,'tl'],[roiRect.x+roiRect.w,roiRect.y,'tr'],[roiRect.x,roiRect.y+roiRect.h,'bl'],[roiRect.x+roiRect.w,roiRect.y+roiRect.h,'br']];
  for(const [hx,hy,name] of hs){ if(Math.abs(x-hx)<8 && Math.abs(y-hy)<8) return name; }
  return null;
}
roi.addEventListener('mousedown', e=>{
  const r=roi.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const h=hitHandle(x,y);
  if(h){ resizing=true; resizeAnchor=h; return; }
  if(x>roiRect.x && x<roiRect.x+roiRect.w && y>roiRect.y && y<roiRect.y+roiRect.h){
    dragging=true; dragOff=[x-roiRect.x, y-roiRect.y];
  }
});
roi.addEventListener('mousemove', e=>{
  const r=roi.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  if(resizing){
    if(resizeAnchor==='tl'){ roiRect.w+=(roiRect.x-x); roiRect.h+=(roiRect.y-y); roiRect.x=x; roiRect.y=y; }
    if(resizeAnchor==='tr'){ roiRect.w=(x-roiRect.x); roiRect.h+=(roiRect.y-y); roiRect.y=y; }
    if(resizeAnchor==='bl'){ roiRect.w+=(roiRect.x-x); roiRect.x=x; roiRect.h=(y-roiRect.y); }
    if(resizeAnchor==='br'){ roiRect.w=(x-roiRect.x); roiRect.h=(y-roiRect.y); }
    roiRect.w=Math.max(40,roiRect.w); roiRect.h=Math.max(30,roiRect.h);
    drawROI(); return;
  }
  if(dragging){ roiRect.x=x-dragOff[0]; roiRect.y=y-dragOff[1]; drawROI(); }
});
['mouseup','mouseleave'].forEach(ev=>roi.addEventListener(ev,()=>{ dragging=false; resizing=false; resizeAnchor=null; }));
$('#roiFromFull').addEventListener('click', ()=>{
  // —Å–ø—Ä–æ—î–∫—Ç—É—î–º–æ ROI —É –ø—Ä–æ–ø–æ—Ä—Ü—ñ—ó –≤—ñ–¥–Ω–æ—Å–Ω–æ –∫–∞–¥—Ä—É
  roiRect={x:roi.width*0.15,y:roi.height*0.25,w:roi.width*0.7,h:roi.height*0.45};
  drawROI(); log('ROI –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∑ –∫–∞–¥—Ä—É');
});
$('#roiClear').addEventListener('click', ()=>{ roiRect={x:120,y:40,w:720,h:80}; drawROI(); });

/* ===== –ü–µ—Ä–µ–¥–æ–±—Ä–æ–±–∫–∞ ROI (–±—ñ–Ω–∞—Ä–∏–∑–∞—Ü—ñ—è) ===== */
function getRoiImage(){
  if(!c.width||!c.height){ alert('–ù–µ–º–∞—î –∫–∞–¥—Ä—É'); return null; }
  const sx=Math.round(roiRect.x/roi.width*c.width);
  const sy=Math.round(roiRect.y/roi.height*c.height);
  const sw=Math.round(roiRect.w/roi.width*c.width);
  const sh=Math.round(roiRect.h/roi.height*c.height);
  const tmp=document.createElement('canvas'); tmp.width=sw; tmp.height=sh;
  const gt=tmp.getContext('2d'); gt.drawImage(c,sx,sy,sw,sh,0,0,sw,sh);
  return tmp;
}
$('#prep').addEventListener('click', ()=>{
  const thr=+$('#thr').value||160;
  const tmp=getRoiImage(); if(!tmp) return;
  const g=tmp.getContext('2d'), id=g.getImageData(0,0,tmp.width,tmp.height), d=id.data;
  for(let i=0;i<d.length;i+=4){
    const y=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2];
    const v= y>thr? 255:0; d[i]=d[i+1]=d[i+2]=v; d[i+3]=255;
  }
  g.putImageData(id,0,0);
  // –ø–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É –ø–æ–ª–æ—Ç–Ω—ñ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é
  gc.drawImage(tmp, Math.round((c.width-tmp.width)/2), 20);
  log('–ü–µ—Ä–µ–¥–æ–±—Ä–æ–±–∫–∞: –±—ñ–Ω–∞—Ä–∏–∑–∞—Ü—ñ—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞');
});

/* ===== OCR ===== */
async function runOCR(){
  const tmp=getRoiImage(); if(!tmp) return;
  $('#st').textContent='OCR‚Ä¶';
  try{
    const result = await Tesseract.recognize(tmp, 'eng', {
      tessedit_char_whitelist: '0123456789.,',
      preserve_interword_spaces: '1'
    });
    const raw = (result.data.text||'').replace(/\s+/g,'').trim();
    handleOCR(raw);
  }catch(e){
    alert('–ü–æ–º–∏–ª–∫–∞ OCR'); console.error(e);
  }finally{ $('#st').textContent='–≥–æ—Ç–æ–≤–æ'; }
}
$('#runOcr').addEventListener('click', runOCR);

/* ===== –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–∫–∞–∑—É + –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó ===== */
let HISTORY=[]; // {ts, acc, reading, delta, flags[]}
const chart=$('#chart'), gch=chart.getContext('2d');

function normalizeReading(raw, digits){
  // –ø—Ä–∏–∫–ª–∞–¥–∏: "0123456", "123456.78", "1,23456", "  001234 "
  let s=String(raw||'').replace(/[^0-9.,]/g,'');
  s=s.replace(',', '.');
  // —è–∫—â–æ —î –¥–µ—Å—è—Ç–∫–æ–≤–∞ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ, —ñ–Ω–∞–∫—à–µ —Ç—Ä–∞–∫—Ç—É—î–º–æ —è–∫ —Ü—ñ–ª—ñ
  let x=parseFloat(s);
  if(!Number.isFinite(x)) return {ok:false, value:NaN, cleaned:s};
  // —è–∫—â–æ —Ü–∏—Ñ—Ä –¥–æ –∫—Ä–∞–ø–∫–∏ –±—ñ–ª—å—à–µ –∑–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ ‚Äî –æ–±—Ä—ñ–∑–∞—Ç–∏ –∑–ª—ñ–≤–∞
  const parts=s.split('.');
  if(parts[0].length>digits) {
    const cut=parts[0].slice(parts[0].length-digits);
    s = parts.length>1? (cut+'.'+(parts[1]||'')) : cut;
    x=parseFloat(s);
  }
  return {ok:true, value:x, cleaned:s};
}

function validate(current, prev, digits, maxDay){
  const flags=[];
  if(!Number.isFinite(current)) flags.push('–Ω–µ—á–∏—Å–ª–æ');
  if(current<prev) flags.push('–≤—ñ–¥–∫–∞—Ç (–º–µ–Ω—à–µ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ)');
  const d=current-prev;
  if(d<0) flags.push('–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞ —Ä—ñ–∑–Ω–∏—Ü—è');
  if(d>maxDay) flags.push('—Å—Ç—Ä–∏–±–æ–∫ > MaxDay');
  // –¥–æ–≤–∂–∏–Ω–∞ ¬´–ø–∞—Å–ø–æ—Ä—Ç–∞¬ª –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (—Ç—ñ–ª—å–∫–∏ —Ü—ñ–ª—ñ)
  const intLen=String(Math.floor(current)).length;
  if(intLen>digits) flags.push(`–¥–æ–≤–∂–∏–Ω–∞>${digits}`);
  if(intLen<Math.max(2, digits-3)) flags.push('–∑–∞–º–∞–ª–æ —Ü–∏—Ñ—Ä?');
  return flags;
}

function handleOCR(raw){
  const acc=$('#acc').value||'‚Äî';
  const prev=parseFloat($('#prev').value)||0;
  const digits=parseInt($('#digits').value)||7;
  const maxDay=parseFloat($('#maxDay').value)||80;

  const n=normalizeReading(raw, digits);
  const reading = n.value;
  const flags = validate(reading, prev, digits, maxDay);
  const delta = Number.isFinite(reading)? +(reading - prev).toFixed(3) : NaN;

  const ts=new Date().toISOString().slice(0,19).replace('T',' ');
  pushRow({ts, acc, raw:n.cleaned||raw, reading:isFinite(reading)?reading:NaN, delta, flags});
  drawHistory();
  $('#prev').value = isFinite(reading)? reading.toFixed(3) : $('#prev').value;
}

function pushRow({ts,acc,raw,reading,delta,flags}){
  HISTORY.push({ts,acc,reading,delta,flags});
  const tb=$('#tbl');
  if(HISTORY.length===1) tb.innerHTML='';
  const tr=document.createElement('tr');
  const fTxt = flags.length? flags.join(', '): 'OK';
  const cls = flags.some(f=>/–≤—ñ–¥–∫–∞—Ç|—Å—Ç—Ä–∏–±–æ–∫|–¥–æ–≤–∂–∏–Ω–∞|–Ω–µ—á–∏—Å–ª–æ|–Ω–µ–≥–∞—Ç–∏–≤/.test(f))? 'bad' : (flags.length? 'warn':'ok');
  tr.innerHTML = `<td>${ts}</td><td>${acc}</td><td>${raw}</td><td>${Number.isFinite(reading)?reading.toFixed(3):'‚Äî'}</td><td>${Number.isFinite(delta)?delta.toFixed(3):'‚Äî'}</td><td class="${cls}"><b>${fTxt}</b></td>`;
  tb.appendChild(tr);
  log(`OCR: ${raw} ‚Üí ${Number.isFinite(reading)?reading.toFixed(3):'NaN'} (${fTxt})`);
}

/* ===== –ì—Ä–∞—Ñ—ñ–∫ —ñ—Å—Ç–æ—Ä—ñ—ó ===== */
function drawHistory(){
  const W=chart.width,H=chart.height; gch.clearRect(0,0,W,H);
  gch.strokeStyle='#223049'; gch.strokeRect(0.5,0.5,W-1,H-1);
  if(HISTORY.length===0){ gch.fillStyle='#94a3b8'; gch.fillText('–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è', 16, 24); return; }
  const vals=HISTORY.map(h=>h.reading).filter(Number.isFinite);
  if(vals.length===0){ gch.fillStyle='#94a3b8'; gch.fillText('–ù–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å', 16, 24); return; }
  const left=40,right=W-10,top=20,bottom=H-26;
  const max=Math.max(...vals), min=Math.min(...vals);
  const X=i=> left + i/Math.max(1,(HISTORY.length-1))*(right-left);
  const Y=v=> bottom - ((v-min)/(max-min||1))*(bottom-top);
  // —Å—ñ—Ç–∫–∞
  gch.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; gch.beginPath(); gch.moveTo(left,y); gch.lineTo(right,y); gch.stroke(); }
  // –ª—ñ–Ω—ñ—è
  gch.beginPath(); gch.strokeStyle='#38bdf8';
  HISTORY.forEach((h,i)=>{ const v=Number.isFinite(h.reading)?h.reading:NaN; if(!Number.isFinite(v)) return;
    const x=X(i), y=Y(v); if(i===0) gch.moveTo(x,y); else gch.lineTo(x,y); });
  gch.stroke();
  // —Ç–æ—á–∫–∏/–∞–Ω–æ–º–∞–ª—ñ—ó
  HISTORY.forEach((h,i)=>{
    const v=h.reading; if(!Number.isFinite(v)) return;
    const x=X(i), y=Y(v);
    const bad = h.flags.some(f=>/–≤—ñ–¥–∫–∞—Ç|—Å—Ç—Ä–∏–±–æ–∫|–Ω–µ—á–∏—Å–ª–æ|–Ω–µ–≥–∞—Ç–∏–≤/.test(f));
    gch.fillStyle = bad? '#f87171' : '#22c55e';
    gch.fillRect(x-2,y-2,4,4);
  });
}

/* ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR ===== */
$('#saveCsv').addEventListener('click', ()=>{
  let csv='ts,account,reading,delta,flags\n';
  HISTORY.forEach(h=>{ csv+=`${h.ts},${h.acc},${Number.isFinite(h.reading)?h.reading.toFixed(3):''},${Number.isFinite(h.delta)?h.delta.toFixed(3):''},"${h.flags.join('; ')}"\n`; });
  download('gas_para22_ocr_'+stamp()+'.csv', csv, 'text/csv'); log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click', ()=>{
  const last=HISTORY[HISTORY.length-1];
  const lines=[
    '–ü–∞—Ä–∞ 22 ‚Äî OCR –ø–æ–∫–∞–∑—ñ–≤: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ê–±–æ–Ω–µ–Ω—Ç/–≤—É–∑–æ–ª: ${$('#acc').value||'‚Äî'}`,
    `–û—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ–∫–∞–∑: ${last && Number.isFinite(last.reading)? last.reading.toFixed(3):'‚Äî'} –º¬≥`,
    `Œî –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ: ${last && Number.isFinite(last.delta)? last.delta.toFixed(3):'‚Äî'} –º¬≥`,
    `–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏: ${last? last.flags.join(', '):'‚Äî'}`
  ];
  download('gas_para22_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#print58').addEventListener('click', ()=>{
  const last=HISTORY[HISTORY.length-1]||{};
  const rc=$('#rc'); rc.hidden=false;
  const lines=[
'=== METER OCR (58–º–º) ===',
`–ê/‚Ññ: ${($('#acc').value||'‚Äî').slice(0,28)}`,
`–ß–∞—Å: ${last.ts||'‚Äî'}`,
`–ü–æ–∫–∞–∑: ${Number.isFinite(last.reading)? last.reading.toFixed(3):'‚Äî'} –º¬≥`,
`Œî: ${Number.isFinite(last.delta)? last.delta.toFixed(3):'‚Äî'} –º¬≥`,
`–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏: ${(last.flags||[]).slice(0,3).join('|')||'OK'}`,
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para22_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ß–µ–∫ 58 –º–º –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#qrGen').addEventListener('click', ()=>{
  const data=prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –¥–æ–∫–∞–∑–∞–º–∏/—Ñ–æ—Ç–æ):', 'https://');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const imgQ=new Image(); imgQ.crossOrigin='anonymous';
  imgQ.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(imgQ,0,0,220,220); };
  imgQ.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  imgQ.src=url;
  log('QR –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ');
});

/* ===== –ü–æ—á–∞—Ç–∫–æ–≤–µ –≤—ñ–¥–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è ===== */
(function init(){
  // –ø—ñ–¥–≥–∞–Ω—è—î–º–æ ROI –ø—ñ–¥ –ø–æ–ª–æ—Ç–Ω–æ
  roi.width = 960; roi.height=180; drawROI();
  // —Ä–∞–º–∫–∞ –∫–∞–¥—Ä—É
  c.width=960; c.height=540; gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,c.width-1,c.height-1);
  // –≥—Ä–∞—Ñ—ñ–∫
  chart.width=520; chart.height=220; drawHistory();
})();
</script>
</body>
</html>
