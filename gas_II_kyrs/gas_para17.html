<!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 17 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü—ñ—è –∞–≤–∞—Ä—ñ–π: –º–∞–ø–∞, —á–µ—Ä–≥–∏, –º–∞—Ä—à—Ä—É—Ç–∏ –±—Ä–∏–≥–∞–¥, ETA, SLA-–≥—Ä–∞—Ñ—ñ–∫, –µ–∫—Å–ø–æ—Ä—Ç</title>
<meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü—ñ—è: –∫–ª—ñ–∫ –Ω–∞ –º–∞–ø—ñ ‚Üí —ñ–Ω—Ü–∏–¥–µ–Ω—Ç (P1/P2/P3), —á–µ—Ä–≥–∞, –∞–≤—Ç–æ-–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–π–±–ª–∏–∂—á–æ—ó –±—Ä–∏–≥–∞–¥–∏, –º–∞—Ä—à—Ä—É—Ç/ETA, —ñ–º—ñ—Ç–∞—Ü—ñ—è —Ä—É—Ö—É –π —É—Å—É–Ω–µ–Ω–Ω—è, –≥—Ä–∞—Ñ—ñ–∫ SLA, –º–µ—Ç—Ä–∏–∫–∏, –∂—É—Ä–Ω–∞–ª, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT.">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1150px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
h2{margin:.2em 0 .4em}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
canvas.map{display:block;width:100%;height:520px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
pre.log{max-height:240px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
</style>
<link rel="canonical" href="https://edlab.pp.ua/gas_II_kyrs/gas_para17.html"><meta property="og:type" content="article"><meta property="og:title" content="–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 17"><meta property="og:description" content="–ö–ª—ñ–∫–∞–π –Ω–∞ –º–∞–ø—ñ, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç. –û–±–∏—Ä–∞–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (P1/P2/P3) —ñ —Ç–∏–ø (–∑–∞–ø–∞—Ö –≥–∞–∑—É, –≤–∏—Ç—ñ–∫, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–∞–∑—É, –≤–∏–±—É—Ö–æ–Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ —Ä–æ–±–æ—Ç–∏ –ø–æ—Ä—É—á). –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∏–º"><meta property="og:url" content="https://edlab.pp.ua/gas_II_kyrs/gas_para17.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 17","description":"–ö–ª—ñ–∫–∞–π –Ω–∞ –º–∞–ø—ñ, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç. –û–±–∏—Ä–∞–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (P1/P2/P3) —ñ —Ç–∏–ø (–∑–∞–ø–∞—Ö –≥–∞–∑—É, –≤–∏—Ç—ñ–∫, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–∞–∑—É, –≤–∏–±—É—Ö–æ–Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ —Ä–æ–±–æ—Ç–∏ –ø–æ—Ä—É—á). –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∏–º","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/gas_II_kyrs/gas_para17.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üö®üó∫Ô∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 17 ‚Äî –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü—ñ—è –∞–≤–∞—Ä—ñ–π</b><br>
        <span class="badge">–ú–∞–ø–∞ ‚Üí —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏ ‚Üí —á–µ—Ä–≥–∞/–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç ‚Üí –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –±—Ä–∏–≥–∞–¥–∏ ‚Üí –º–∞—Ä—à—Ä—É—Ç/ETA ‚Üí –≥—Ä–∞—Ñ—ñ–∫ SLA ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ö–ª—ñ–∫–∞–π –Ω–∞ –º–∞–ø—ñ, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ <b>—ñ–Ω—Ü–∏–¥–µ–Ω—Ç</b>. –û–±–∏—Ä–∞–π <b>–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</b> (P1/P2/P3) —ñ —Ç–∏–ø (–∑–∞–ø–∞—Ö –≥–∞–∑—É, –≤–∏—Ç—ñ–∫, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–∞–∑—É, –≤–∏–±—É—Ö–æ–Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ —Ä–æ–±–æ—Ç–∏ –ø–æ—Ä—É—á). 
      –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∏–º–∞—î <b>—á–µ—Ä–≥—É</b>, <b>–ø—Ä–∏–∑–Ω–∞—á–∞—î –±—Ä–∏–≥–∞–¥–∏</b> –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–æ–º ¬´–Ω–∞–π–±–ª–∏–∂—á–∞ –≤—ñ–ª—å–Ω–∞ –¥–æ –Ω–∞–π–≤–∏—â–æ–≥–æ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É¬ª, —Ä–∞—Ö—É—î <b>ETA</b>, —ñ–º—ñ—Ç—É—î —Ä—É—Ö —ñ <b>—É—Å—É–Ω–µ–Ω–Ω—è</b>. 
      –ù–∞ –≥—Ä–∞—Ñ—ñ–∫—É ‚Äî —á–∞—Å—Ç–∫–∞ <b>–∑–∞—è–≤ —É SLA</b>. –ü—Ä–æ–±—É–π —Å—Ü–µ–Ω–∞—Ä—ñ—ó ‚Äî —ñ –µ–∫—Å–ø–æ—Ä—Ç—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
    <div class="row">
      <label style="flex:1">SLA P1, —Ö–≤<input id="slaP1" class="input" type="number" step="1" value="30"></label>
      <label style="flex:1">SLA P2, —Ö–≤<input id="slaP2" class="input" type="number" step="1" value="60"></label>
      <label style="flex:1">SLA P3, —Ö–≤<input id="slaP3" class="input" type="number" step="1" value="180"></label>
      <label style="flex:1">–®–≤–∏–¥–∫—ñ—Å—Ç—å –±—Ä–∏–≥–∞–¥–∏, –∫–º/–≥–æ–¥<input id="spd" class="input" type="number" step="1" value="30"><small class="muted" style="display:block;margin-top:-4px">1 –∫–ª—ñ—Ç–∏–Ω–∫–∞ ‚âà 100 –º</small></label>
    </div>
    <div class="row">
      <button class="btn good" id="run">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
      <button class="btn secondary" id="stop">‚èπÔ∏è –°—Ç–æ–ø</button>
      <button class="btn" id="reset">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
      <button class="btn" id="autogen">üß™ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 5 —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤</button>
      <span class="badge">t = <b id="tSim">0</b> —Ö–≤</span>
      <span class="badge">–ê–∫—Ç–∏–≤–Ω—ñ: <b id="actCnt">0</b>, –í —á–µ—Ä–∑—ñ: <b id="qCnt">0</b></span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üó∫Ô∏è –ú–∞–ø–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü—ñ—ó</h2>
      <canvas id="map" class="map" width="860" height="520"></canvas>
      <div class="row" style="margin-top:8px">
        <label>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
          <select id="prio" class="input">
            <option value="P1">P1 (–∫—Ä–∏—Ç–∏—á–Ω–∏–π)</option>
            <option value="P2" selected="">P2 (–≤–∏—Å–æ–∫–∏–π)</option>
            <option value="P3">P3 (–∑–≤–∏—á–∞–π–Ω–∏–π)</option>
          </select>
        </label>
        <label>–¢–∏–ø
          <select id="itype" class="input">
            <option>–ó–∞–ø–∞—Ö –≥–∞–∑—É</option>
            <option>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π –≤–∏—Ç—ñ–∫</option>
            <option>–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–∞–∑—É</option>
            <option>–†–æ–±–æ—Ç–∏ –ø–æ—Ä—É—á (—Ä–∏–∑–∏–∫)</option>
          </select>
        </label>
        <label style="flex:1">–ù–æ—Ç–∞—Ç–∫–∞<input id="inote" class="input" placeholder="–î–µ—Ç–∞–ª—ñ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—É"></label>
        <button class="btn" id="assign">ü§ñ –ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤—Ä—É—á–Ω—É (–æ–ø—Ü.)</button>
      </div>

      <h2 style="margin-top:10px">üìà SLA-–≥—Ä–∞—Ñ—ñ–∫ (–≤–∏–∫–æ–Ω–∞–Ω–æ –≤ –Ω–æ—Ä–º–∞—Ç–∏–≤—ñ, %)</h2>
      <canvas id="chart" class="chart" width="560" height="220"></canvas>
    </div>

    <div class="card">
      <h2>üìä –¢–∞–±–ª–∏—Ü—ñ —Ç–∞ –º–µ—Ç—Ä–∏–∫–∏</h2>
      <div class="row">
        <span class="tag ok">SLA P1 ‚â§ <b id="sla1Tag">30</b> —Ö–≤</span>
        <span class="tag warn">SLA P2 ‚â§ <b id="sla2Tag">60</b> —Ö–≤</span>
        <span class="tag bad">SLA P3 ‚â§ <b id="sla3Tag">180</b> —Ö–≤</span>
      </div>
      <table class="tbl" style="margin-top:8px">
        <thead><tr><th>#</th><th>–ü—Ä—ñ–æ—Ä.</th><th>–¢–∏–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>ETA</th><th>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</th></tr></thead>
        <tbody id="tblInc"><tr><td colspan="6" class="muted">‚Äî —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üöê –ë—Ä–∏–≥–∞–¥–∏</h3>
      <table class="tbl">
        <thead><tr><th>–ë—Ä–∏–≥–∞–¥–∞</th><th>–°—Ç–∞–Ω</th><th>–Ü–Ω—Ü–∏–¥–µ–Ω—Ç</th><th>–ü—Ä–æ–≥—Ä–µ—Å</th></tr></thead>
        <tbody id="tblCrew"></tbody>
      </table>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (—ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏ + —Ç–∞–π–º–ª–∞–π–Ω SLA)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–°—Ç–≤–æ—Ä–∏ 3 —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏ (P1, P2, P3) —É —Ä—ñ–∑–Ω–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ P1 –æ—Ç—Ä–∏–º—É—î –±—Ä–∏–≥–∞–¥—É –ø–µ—Ä—à–∏–º —ñ –º–∞—î –Ω–∞–π–º–µ–Ω—à–∏–π ETA.</li>
      <li>–ü—ñ–¥—ñ–±—Ä–∞–π —à–≤–∏–¥–∫—ñ—Å—Ç—å –±—Ä–∏–≥–∞–¥ —Ç–∞–∫, —â–æ–± **‚â•80% –∑–∞—è–≤** –≤–∏–∫–æ–Ω—É–≤–∞–ª–∏—Å—å —É **SLA**. –ü–æ—è—Å–Ω–∏, –¥–µ ¬´–≤—É–∑—å–∫—ñ –º—ñ—Å—Ü—è¬ª.</li>
      <li>–ó–∞–ø—É—Å—Ç–∏ ¬´üß™ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 5 —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤¬ª, –ø–æ—Ç—ñ–º ¬´–ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤—Ä—É—á–Ω—É¬ª ‚Äî –ø–æ—Ä—ñ–≤–Ω—è–π –≤—ñ–¥—Å–æ—Ç–æ–∫ SLA –¥–æ/–ø—ñ—Å–ª—è.</li>
      <li>–ï–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT —ñ –∑—Ä–æ–±–∏ –≤–∏—Å–Ω–æ–≤–∫–∏ —â–æ–¥–æ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –±—Ä–∏–≥–∞–¥ —Ç–∞ —ó—Ö —Å—Ç–∞—Ä—Ç–æ–≤–∏—Ö –ø–æ–∑–∏—Ü—ñ–π.</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏/—Å—Ç–∞–Ω ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

const map=$('#map'), g=map.getContext('2d');
const W=map.width, H=map.height;
const COLS=43, ROWS=26; // ~100–º –∫–ª—ñ—Ç–∏–Ω–∫–∞ ‚Üí –ø–æ–ª–µ ~4.3x2.6 –∫–º
const CELLW=W/COLS, CELLH=H/ROWS;

let T=0, timer=null;
let crews=[], incidents=[], timeline=[]; // timeline –¥–ª—è SLA –≥—Ä–∞—Ñ—ñ–∫–∞

/* ===== –ü–æ—á–∞—Ç–∫–æ–≤—ñ –±—Ä–∏–≥–∞–¥–∏ (3 —à—Ç.) ===== */
function initCrews(){
  crews=[
    {id:'C1', x:4,  y:20, state:'idle', tgt:null, path:[], dist:0, eta:null, progress:0, color:'#38bdf8'},
    {id:'C2', x:20, y:4,  state:'idle', tgt:null, path:[], dist:0, eta:null, progress:0, color:'#22c55e'},
    {id:'C3', x:36, y:18, state:'idle', tgt:null, path:[], dist:0, eta:null, progress:0, color:'#fbbf24'}
  ];
}
initCrews();

/* ===== –ú–∞–ø–∞ (—Å—ñ—Ç–∫–∞ + —Å—Ç–∏–ª—ñ–∑–æ–≤–∞–Ω—ñ ‚Äú—Ä–∞–π–æ–Ω–∏‚Äù) ===== */
function drawMap(){
  g.clearRect(0,0,W,H);
  // —Ñ–æ–Ω —Ä–∞–π–æ–Ω—ñ–≤
  const blocks=[{x:1,y:1,w:14,h:10,c:'#0b1528'},{x:15,y:1,w:14,h:12,c:'#0b182d'},{x:29,y:1,w:13,h:11,c:'#0b1b32'},
                {x:1,y:12,w:16,h:12,c:'#0b162a'},{x:17,y:13,w:12,h:12,c:'#0b1930'},{x:29,y:12,w:13,h:13,c:'#0b1d35'}];
  blocks.forEach(b=>{ g.fillStyle=b.c; g.fillRect(b.x*CELLW,b.y*CELLH,b.w*CELLW,b.h*CELLH); });
  // —Å—ñ—Ç–∫–∞ –≥—Ä—É–±–∞
  g.strokeStyle='#1f2a44'; g.lineWidth=1;
  for(let i=0;i<=COLS;i++){ g.beginPath(); g.moveTo(i*CELLW,0); g.lineTo(i*CELLW,H); g.stroke(); }
  for(let j=0;j<=ROWS;j++){ g.beginPath(); g.moveTo(0,j*CELLH); g.lineTo(W,j*CELLH); g.stroke(); }
  // –¥–µ–ø–æ (—É–º–æ–≤–Ω—ñ)
  [['DEP1',4,20],['DEP2',20,4],['DEP3',36,18]].forEach(([t,x,y])=>{
    g.fillStyle='#64748b'; g.fillRect(x*CELLW-10,y*CELLH-10,20,20);
    g.fillStyle='#e5e7eb'; g.font='10px ui-monospace'; g.fillText(t, x*CELLW-14, y*CELLH-12);
  });
  // —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏
  incidents.forEach(inc=>{
    const col = inc.prio==='P1'?'#f87171':(inc.prio==='P2'?'#fbbf24':'#38bdf8');
    g.fillStyle=col; g.beginPath(); g.arc((inc.x+0.5)*CELLW,(inc.y+0.5)*CELLH,7,0,Math.PI*2); g.fill();
    g.fillStyle='#0b1220'; g.font='10px ui-monospace'; g.fillText(inc.prio,(inc.x+0.5)*CELLW-9,(inc.y+0.5)*CELLH+3);
  });
  // –º–∞—Ä—à—Ä—É—Ç–∏ + –±—Ä–∏–≥–∞–¥–∏
  crews.forEach(c=>{
    if(c.path.length>0){
      g.strokeStyle=c.color; g.lineWidth=2; g.beginPath();
      const p0={x:(c.x+0.5)*CELLW,y:(c.y+0.5)*CELLH}; g.moveTo(p0.x,p0.y);
      c.path.forEach(p=>{ g.lineTo((p.x+0.5)*CELLW,(p.y+0.5)*CELLH); });
      g.stroke();
    }
    g.fillStyle=c.color; g.beginPath(); g.arc((c.x+0.5)*CELLW,(c.y+0.5)*CELLH,8,0,Math.PI*2); g.fill();
    g.fillStyle='#0b1220'; g.font='10px ui-monospace'; g.fillText(c.id,(c.x+0.5)*CELLW-10,(c.y+0.5)*CELLH+3);
  });
}

/* ===== –Ü–Ω—Ü–∏–¥–µ–Ω—Ç–∏ ===== */
function addIncident(x,y, prio, type, note){
  const id='I'+(Math.random().toString(36).slice(2,6).toUpperCase());
  const sla = getSLAmin(prio);
  const inc={id,x,y,prio,type,note, tCreate:T, tAssign:null, tArrive:null, tFix:null, crew:null, status:'NEW', slaMin:sla};
  incidents.push(inc);
  log(`‚ûï –Ü–Ω—Ü–∏–¥–µ–Ω—Ç ${inc.id} (${prio}/${type}) @ ${x},${y}`);
  tryAssign(); // —Å–ø—Ä–æ–±–∞ –ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏
  refreshTables(); drawMap();
}

function getSLAmin(prio){
  if(prio==='P1') return Math.max(1,parseInt($('#slaP1').value)||30);
  if(prio==='P2') return Math.max(1,parseInt($('#slaP2').value)||60);
  return Math.max(1,parseInt($('#slaP3').value)||180);
}

/* ===== –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –±—Ä–∏–≥–∞–¥ ===== */
function tryAssign(){
  // –≤—ñ–¥—Å–æ—Ä—Ç—É—î–º–æ –≤—ñ–¥–∫—Ä–∏—Ç—ñ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏: P1‚ÜíP2‚ÜíP3, –¥–∞–ª—ñ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à—ñ
  const open = incidents.filter(i=>i.status==='NEW'||i.status==='QUEUED').sort((a,b)=>{
    const pr = {'P1':1,'P2':2,'P3':3};
    if(pr[a.prio]!==pr[b.prio]) return pr[a.prio]-pr[b.prio];
    return a.tCreate-b.tCreate;
  });
  open.forEach(i=>{
    // –∑–Ω–∞–π—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á—É –≤—ñ–ª—å–Ω—É –±—Ä–∏–≥–∞–¥—É
    const free = crews.filter(c=>c.state==='idle');
    if(!free.length){ i.status='QUEUED'; return; }
    let best=null, bestD=1e9;
    free.forEach(c=>{
      const d = Math.abs(c.x-i.x)+Math.abs(c.y-i.y);
      if(d<bestD){bestD=d; best=c;}
    });
    if(best){
      assign(best,i);
    }
  });
}

function assign(c, inc){
  // –º–∞—Ä—à—Ä—É—Ç: –º–∞–Ω—Ö–µ—Ç—Ç–µ–Ω—Å—å–∫–∏–π –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∏–π
  const path=[]; let cx=c.x, cy=c.y;
  while(cx!==inc.x){ cx += (inc.x>cx?1:-1); path.push({x:cx,y:cy}); }
  while(cy!==inc.y){ cy += (inc.y>cy?1:-1); path.push({x:cx,y:cy}); }
  c.tgt=inc.id; c.path=path; c.state='to_site';
  c.dist=path.length; c.progress=0;
  const minPerCell = 6/(Math.max(1, parseFloat($('#spd').value)||30)); // 30 –∫–º/–≥–æ–¥ ‚âà 0.5 –∫–º/—Ö–≤; 100 –º = 0.2 —Ö–≤ ‚Üí 12 —Å. –ú–∏ —Ä–æ–±–∏–º–æ 6/Speed —Ö–≤/–∫–ª—ñ—Ç–∫–∞
  c.eta = T + Math.ceil(c.dist*minPerCell);
  inc.crew=c.id; inc.status='ASSIGNED'; inc.tAssign=T;
  log(`üöê ${c.id} ‚Üí ${inc.id} (ETA ~ ${c.eta-T} —Ö–≤)`);
}

/* ===== –Ü–º—ñ—Ç–∞—Ü—ñ—è –∫—Ä–æ–∫—ñ–≤ ===== */
function tick(){
  T += 1; // 1 –∫—Ä–æ–∫ = 1 —Ö–≤
  $('#tSim').textContent=T;
  // —Ä—É—Ö –±—Ä–∏–≥–∞–¥
  crews.forEach(c=>{
    if(c.state==='to_site' && c.path.length){
      // –∫–æ–∂–Ω—ñ k —Ö–≤ —Ä—É—Ö –Ω–∞ 1 –∫–ª—ñ—Ç–∏–Ω–∫—É
      const minPerCell = 6/(Math.max(1, parseFloat($('#spd').value)||30));
      c.progress += 1;
      while(c.progress>=minPerCell && c.path.length){
        c.progress -= minPerCell;
        const p=c.path.shift(); c.x=p.x; c.y=p.y;
      }
      if(c.path.length===0){
        // –ø—Ä–∏–±—É–ª–∏
        const inc=incById(c.tgt);
        if(inc){ inc.tArrive=T; inc.status='ON_SITE'; log(`‚úÖ ${c.id} –ø—Ä–∏–±—É–≤ –¥–æ ${inc.id}`); }
        c.state='fixing'; c.progress=0;
      }
    } else if(c.state==='fixing'){
      // —Ä–µ–º–æ–Ω—Ç –∑–∞–π–º–∞—î 10‚Äì30 —Ö–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É
      const inc=incById(c.tgt); if(!inc) {c.state='idle'; return;}
      const need = (inc.prio==='P1'?10:(inc.prio==='P2'?15:25));
      c.progress += 1;
      if(c.progress>=need){
        inc.tFix=T; inc.status='DONE'; log(`üß∞ ${c.id} –∑–∞–≤–µ—Ä—à–∞—î ${inc.id} (t=${T-inc.tCreate} —Ö–≤)`);
        // SLA
        const within = (inc.tArrive - inc.tCreate) <= inc.slaMin ? 1:0;
        timeline.push({t:T, within});
        c.state='idle'; c.tgt=null; c.eta=null; c.progress=0;
        tryAssign(); // —è–∫ —Ç—ñ–ª—å–∫–∏ –∑–≤—ñ–ª—å–Ω–∏–ª–∏—Å—å ‚Äî –±–µ—Ä–µ–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π
      }
    }
  });
  // –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–∏–π –∑–∞–ø–∏—Å SLA % (–∫–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ)
  if(T%5===0){
    const pct = slaPct();
    timeline.push({t:T, within:pct}); // –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ –∑—Ä—É—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ % –æ–∫—Ä–µ–º–æ—é —Ç–æ—á–∫–æ—é
  }
  refreshTables(); drawMap(); drawChart();
}

function incById(id){ return incidents.find(i=>i.id===id); }
function slaPct(){
  const done=incidents.filter(i=>i.status==='DONE');
  if(done.length===0) return 0;
  let ok=0; done.forEach(i=>{ if((i.tArrive - i.tCreate) <= i.slaMin) ok++; });
  return Math.round(ok/done.length*100);
}

/* ===== UI: –∫–ª—ñ–∫ –ø–æ –º–∞–ø—ñ = –Ω–æ–≤–∏–π —ñ–Ω—Ü–∏–¥–µ–Ω—Ç ===== */
map.addEventListener('click',(e)=>{
  const r=map.getBoundingClientRect(); const x=Math.floor((e.clientX-r.left)/CELLW); const y=Math.floor((e.clientY-r.top)/CELLH);
  const prio=$('#prio').value; const type=$('#itype').value; const note=$('#inote').value.trim();
  addIncident(x,y, prio, type, note);
});
$('#autogen').addEventListener('click',()=>{
  for(let k=0;k<5;k++){
    const x=Math.floor(Math.random()*COLS), y=Math.floor(Math.random()*ROWS);
    const pr=['P1','P2','P3'][Math.floor(Math.random()*3)];
    const tp=['–ó–∞–ø–∞—Ö –≥–∞–∑—É','–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π –≤–∏—Ç—ñ–∫','–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–∞–∑—É','–†–æ–±–æ—Ç–∏ –ø–æ—Ä—É—á (—Ä–∏–∑–∏–∫)'][Math.floor(Math.random()*4)];
    addIncident(x,y,pr,tp,'auto');
  }
});
$('#assign').addEventListener('click',()=>{ tryAssign(); refreshTables(); drawMap(); });

/* ===== –¢–∞–±–ª–∏—Ü—ñ ===== */
function refreshTables(){
  // —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏
  const body=$('#tblInc'); body.innerHTML='';
  if(incidents.length===0){ body.innerHTML='<tr><td colspan="6" class="muted">‚Äî —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î ‚Äî</td></tr>'; }
  incidents.slice().sort((a,b)=>b.tCreate-a.tCreate).forEach((i,idx)=>{
    const eta = i.status==='ASSIGNED'||i.status==='ON_SITE' ? ((incById(i.id), crewById(i.crew)?.eta - T) : null) : null;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${incidents.length-idx}</td><td>${i.prio}</td><td>${i.type}</td><td>${i.status}</td><td>${eta!=null?Math.max(0,eta):'‚Äî'}</td><td>${i.crew||'‚Äî'}</td>`;
    body.appendChild(tr);
  });
  // –±—Ä–∏–≥–∞–¥–∏
  const bc=$('#tblCrew'); bc.innerHTML='';
  crews.forEach(c=>{
    const inc = c.tgt? incById(c.tgt):null;
    const prog = c.state==='to_site' ? `${Math.max(0,Math.min(100, Math.round((c.dist-(c.path.length))/Math.max(1,c.dist)*100)))}%`
               : c.state==='fixing' ? `${Math.min(100,Math.round((c.progress)/(inc?(inc.prio==='P1'?10:(inc.prio==='P2'?15:25)):15)*100))}%`
               : '‚Äî';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.id}</td><td>${c.state}</td><td>${c.tgt||'‚Äî'}</td><td>${prog}</td>`;
    bc.appendChild(tr);
  });
  // –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏/—Ç–µ–≥–∏
  $('#actCnt').textContent = incidents.filter(i=>i.status!=='DONE').length;
  $('#qCnt').textContent = incidents.filter(i=>i.status==='QUEUED' || i.status==='NEW').length;
  $('#sla1Tag').textContent=$('#slaP1').value; $('#sla2Tag').textContent=$('#slaP2').value; $('#sla3Tag').textContent=$('#slaP3').value;
}

function crewById(id){ return crews.find(c=>c.id===id); }

/* ===== –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å–∏–º—É–ª—è—Ü—ñ—î—é ===== */
$('#run').addEventListener('click',()=>{ if(timer) return; timer=setInterval(tick,1000); log('‚ñ∂Ô∏è –°–∏–º—É–ª—è—Ü—ñ—é –∑–∞–ø—É—â–µ–Ω–æ (1 –∫—Ä–æ–∫ = 1 —Ö–≤)'); });
$('#stop').addEventListener('click',()=>{ if(!timer) return; clearInterval(timer); timer=null; log('‚èπÔ∏è –°–∏–º—É–ª—è—Ü—ñ—é –∑—É–ø–∏–Ω–µ–Ω–æ'); });
$('#reset').addEventListener('click',()=>{
  if(timer){ clearInterval(timer); timer=null; }
  T=0; incidents=[]; timeline=[]; initCrews(); refreshTables(); drawMap(); drawChart(); log('üîÑ –°–∫–∏–¥–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞');
});

/* ===== –ì—Ä–∞—Ñ—ñ–∫ SLA ===== */
const chart=$('#chart'), gc=chart.getContext('2d');
function drawChart(){
  const Wc=chart.width,Hc=chart.height; gc.clearRect(0,0,Wc,Hc);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,Wc-1,Hc-1);
  const left=40,right=Wc-20,top=20,bottom=Hc-28;
  // —Å—ñ—Ç–∫–∞
  gc.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,y); gc.lineTo(right,y); gc.stroke(); }
  // –¥–∞–Ω—ñ
  const pts = timeline.filter(p=>typeof p.within==='number' && p.within>=0);
  if(pts.length<2){ gc.fillStyle='#94a3b8'; gc.fillText('SLA-–ø—Ä–æ—Ü–µ–Ω—Ç –∑‚Äô—è–≤–∏—Ç—å—Å—è –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤', left+8, top+14); return; }
  const tMin=pts[0].t, tMax=pts[pts.length-1].t, span=(tMax-tMin)||1;
  const X=t=> left + (t-tMin)/span*(right-left);
  const Y=v=> bottom - (v/100)*(bottom-top);
  gc.beginPath(); gc.strokeStyle='#22c55e';
  pts.forEach((p,i)=>{ const x=X(p.t), y=Y(p.within); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); });
  gc.stroke();
  gc.fillStyle='#e5e7eb'; gc.font='11px ui-monospace';
  gc.fillText('SLA %', right-56, top+12);
}

/* ===== –ï–∫—Å–ø–æ—Ä—Ç ===== */
function saveCSV(){
  let csv='id,prio,type,status,created_min,assigned_min,arrive_min,fix_min,crew,sla_min,withinSLA\n';
  incidents.forEach(i=>{
    const within = (i.tArrive!=null) ? ((i.tArrive - i.tCreate) <= i.slaMin) : '';
    csv+=`${i.id},${i.prio},${i.type.replace(/,/g,';')},${i.status},${i.tCreate??''},${i.tAssign??''},${i.tArrive??''},${i.tFix??''},${i.crew??''},${i.slaMin},${within}\n`;
  });
  csv+='\n# sla_timeline\nminute,pct\n';
  timeline.forEach(p=>{ if(p.within!=null) csv+=`${p.t},${p.within}\n`; });
  download('gas_para17_dispatch_'+stamp()+'.csv', csv, 'text/csv');
}
function saveTXT(){
  const done=incidents.filter(i=>i.status==='DONE').length;
  const pct = slaPct();
  const lines=[
    '–ü–∞—Ä–∞ 17 ‚Äî –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü—ñ—è –∞–≤–∞—Ä—ñ–π: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ß–∞—Å –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è: ${T} —Ö–≤`,
    `–£—Å—å–æ–≥–æ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤: ${incidents.length}; –í–∏–∫–æ–Ω–∞–Ω–æ: ${done}`,
    `SLA –≤–∏–∫–æ–Ω–∞–Ω–æ: ${pct}%`,
    `–ë—Ä–∏–≥–∞–¥–∏: ${crews.map(c=>`${c.id}@${c.x},${c.y} (${c.state})`).join(' | ')}`,
    '--- –û—Å—Ç–∞–Ω–Ω—ñ 5 —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ ---',
    ...incidents.slice(-5).map(i=>`${i.id} ${i.prio} ${i.type} ‚Äî ${i.status} (crew:${i.crew||'-'}, ETA:${crewById(i.crew)?.eta!=null?Math.max(0,crewById(i.crew).eta-T):'‚Äî'})`),
  ];
  download('gas_para17_summary_'+stamp()+'.txt', lines.join('\n'));
}
$('#saveCsv').addEventListener('click', saveCSV);
$('#saveTxt').addEventListener('click', saveTXT);

/* ===== –Ü–Ω—ñ—Ç ===== */
drawMap(); drawChart(); refreshTables();
</script>


</body></html>