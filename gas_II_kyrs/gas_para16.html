<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 16 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ì—ñ–¥—Ä–∞–≤–ª—ñ—á–Ω—ñ —Ä–µ–∂–∏–º–∏ –º–µ—Ä–µ–∂—ñ: —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ —Å—Ö–µ–º–∞, –ø–æ–ø–∏—Ç/—Ä–µ–≥—É–ª—è—Ç–æ—Ä/–≤–∏—Ç–æ–∫–∏, –≥—Ä–∞—Ñ—ñ–∫, —Ç—Ä–∏–≤–æ–≥–∏, –µ–∫—Å–ø–æ—Ä—Ç</title>
<meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ–π–Ω–∞ —Å—Ö–µ–º–∞ –ì–†–ú: –≤—É–∑–ª–∏/–¥—ñ–ª—è–Ω–∫–∏, —Ä–µ–≥—É–ª—è—Ç–æ—Ä —Ç–∏—Å–∫—É, –Ω–∞—Å–æ—Å, –≤–∏—Ç–æ–∫–∏, –∑–∞—Å—É–≤–∫–∏, –ø–æ–ø–∏—Ç, –≥—Ä–∞—Ñ—ñ–∫ P/Q, —Ç—Ä–∏–≤–æ–≥–∏, –∂—É—Ä–Ω–∞–ª, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1300px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
h2{margin:.2em 0 .4em}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
svg{width:100%;height:auto;display:block;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.node{stroke:#94a3b8;fill:#0f172a}
.edge{stroke:#334155;stroke-width:8;stroke-linecap:round;opacity:.9}
.valve{stroke:#a3a3a3;fill:#0f172a}
.grp{stroke:#22c55e;fill:#0b1a2f}
.pump{stroke:#38bdf8;fill:#0b1220}
label>small{display:block;color:#94a3b8;margin-top:-2px}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
pre.log{max-height:240px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üó∫Ô∏èüå¨Ô∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 16 ‚Äî –ì—ñ–¥—Ä–∞–≤–ª—ñ—á–Ω—ñ —Ä–µ–∂–∏–º–∏ –º–µ—Ä–µ–∂—ñ</b><br/>
        <span class="badge">–°—Ö–µ–º–∞ –ì–†–ú ‚Üí –ø–æ–ø–∏—Ç/–∑–∞—Å—É–≤–∫–∏/–≤–∏—Ç–æ–∫–∏ ‚Üí —Ä–µ–≥—É–ª—è—Ç–æ—Ä —Ç–∏—Å–∫—É ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí —Ç—Ä–∏–≤–æ–≥–∏ ‚Üí –∂—É—Ä–Ω–∞–ª ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ù–∞ —Å—Ö–µ–º—ñ –Ω–∏–∂—á–µ ‚Äî –∑—Ä–∞–∑–∫–æ–≤–∞ **–ª–æ–∫–∞–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞ –Ω–∏–∑—å–∫–æ–≥–æ —Ç–∏—Å–∫—É**: –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—å, –≤—ñ–¥–≥–∞–ª—É–∂–µ–Ω–Ω—è –¥–æ —Ç—Ä—å–æ—Ö —Ä–∞–π–æ–Ω—ñ–≤ <b>N1‚ÄìN3</b>, <b>–ì–†–ü</b> –∑—ñ —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—î—é —Ç–∏—Å–∫—É, <b>–Ω–∞—Å–æ—Å-–ø—ñ–¥–∫–∞—á–∫–∞</b> (—É–º–æ–≤–Ω–∏–π), —Ç—Ä–∏ <b>–∑–∞—Å—É–≤–∫–∏</b> —Ç–∞ –¥–≤–∞ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ <b>–≤–∏—Ç–æ–∫–∏</b>.
    –ó–∞–¥–∞—á–∞: –∫–µ—Ä—É–π <b>–ø–æ–ø–∏—Ç–æ–º</b>, <b>–≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º –∑–∞—Å—É–≤–æ–∫</b>, <b>—à–≤–∏–¥–∫—ñ—Å—Ç—é –Ω–∞—Å–æ—Å–∞</b>, <b>—É—Å—Ç–∞–≤–∫–æ—é —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞</b>, –≤–º–∏–∫–∞–π <b>–≤–∏—Ç–æ–∫–∏/–∞–≤–∞—Ä—ñ—ó</b> ‚Äî —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π –∑–∞ **—Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–æ—é —Ç–∏—Å–∫—É** —Ç–∞ **–≥—Ä–∞—Ñ—ñ–∫–æ–º P/Q**. –õ–æ–≤–∏ <b>—Ç—Ä–∏–≤–æ–≥–∏ KPI</b> —ñ –∑–±–µ—Ä–µ–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
    <div class="row">
      <label style="flex:1">–ü–æ–ø–∏—Ç –±–∞–∑–æ–≤–∏–π, –º¬≥/–≥–æ–¥<input id="dBase" class="input" type="range" min="50" max="600" step="10" value="200"><small>–í–ø–ª–∏–≤–∞—î –Ω–∞ –≤—Å—ñ —Ç—Ä–∏ —Ä–∞–π–æ–Ω–∏</small></label>
      <label style="flex:1">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è N1, %<input id="d1" class="input" type="range" min="50" max="150" step="1" value="100"></label>
      <label style="flex:1">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è N2, %<input id="d2" class="input" type="range" min="50" max="150" step="1" value="100"></label>
      <label style="flex:1">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è N3, %<input id="d3" class="input" type="range" min="50" max="150" step="1" value="100"></label>
    </div>
    <div class="row">
      <label style="flex:1">–ó–∞—Å—É–≤–∫–∞ V1 (–¥–æ N1), % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è<input id="v1" class="input" type="range" min="0" max="100" step="1" value="100"></label>
      <label style="flex:1">–ó–∞—Å—É–≤–∫–∞ V2 (–¥–æ N2), % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è<input id="v2" class="input" type="range" min="0" max="100" step="1" value="100"></label>
      <label style="flex:1">–ó–∞—Å—É–≤–∫–∞ V3 (–¥–æ N3), % –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è<input id="v3" class="input" type="range" min="0" max="100" step="1" value="100"></label>
    </div>
    <div class="row">
      <label style="flex:1">–ù–∞—Å–æ—Å (—á–∞—Å—Ç–æ—Ç–∞), %<input id="pump" class="input" type="range" min="0" max="120" step="1" value="60"><small>–ü—ñ–¥–≤–∏—â—É—î —Ç–∏—Å–∫ —É –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ</small></label>
      <label style="flex:1">–†–µ–≥—É–ª—è—Ç–æ—Ä: —É—Å—Ç–∞–≤–∫–∞ Pout, –∫–ü–∞<input id="sp" class="input" type="number" step="0.5" value="2.0"></label>
      <label style="flex:1">–†–µ–≥—É–ª—è—Ç–æ—Ä: –∫–æ–µ—Ñ. Kp<input id="kp" class="input" type="number" step="0.1" value="1.2"></label>
    </div>
    <div class="row">
      <label><input id="leak1" type="checkbox"> –í–∏—Ç—ñ–∫ L1 –±—ñ–ª—è N2 (~—Ñ—Ç)</label>
      <label><input id="leak2" type="checkbox"> –í–∏—Ç—ñ–∫ L2 –Ω–∞ –≥—ñ–ª—Ü—ñ N3</label>
      <label><input id="valvTrip" type="checkbox"> –ê–≤–∞—Ä—ñ—è: V2 –∑–∞–∫–ª–∏–Ω–∏–ª–æ (‚Üí0%)</label>
      <label><input id="surge" type="checkbox"> –°—Ç—Ä–∏–±–æ–∫ –ø–æ–ø–∏—Ç—É (+40% –Ω–∞ 20 —Å)</label>
    </div>
    <div class="row">
      <button class="btn good" id="run">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
      <button class="btn secondary" id="stop">‚èπÔ∏è –°—Ç–æ–ø</button>
      <button class="btn" id="reset">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
      <span class="badge">t = <b id="tSim">0</b> c</span>
      <span class="badge">Q –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ: <b id="qMain">‚Äî</b> –º¬≥/–≥–æ–¥</span>
      <span class="badge">Pmin –º–µ—Ä–µ–∂—ñ: <b id="pMin">‚Äî</b> –∫–ü–∞</span>
      <span class="badge">Pmax –º–µ—Ä–µ–∂—ñ: <b id="pMax">‚Äî</b> –∫–ü–∞</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üó∫Ô∏è –ê–Ω—ñ–º–∞—Ü—ñ–π–Ω–∞ —Å—Ö–µ–º–∞ –º–µ—Ä–µ–∂—ñ</h2>
      <svg id="net" viewBox="0 0 900 500" role="img" aria-label="–ì–∞–∑–æ–≤–∞ –º–µ—Ä–µ–∂–∞">
        <!-- –ú–∞–≥—ñ—Å—Ç—Ä–∞–ª—å -->
        <line id="e_main" class="edge" x1="80" y1="250" x2="820" y2="250"/>
        <!-- –í—É–∑–ª–∏ -->
        <circle id="n_src" class="node" cx="80" cy="250" r="16"/>
        <rect id="n_grp" class="grp" x="150" y="220" width="60" height="60" rx="8"/>
        <rect id="n_pump" class="pump" x="240" y="220" width="60" height="60" rx="8"/>
        <circle id="n_t1" class="node" cx="380" cy="250" r="14"/>
        <circle id="n_split" class="node" cx="540" cy="250" r="12"/>
        <!-- –í—ñ–¥–≥–∞–ª—É–∂–µ–Ω–Ω—è -->
        <line id="e_n1" class="edge" x1="540" y1="250" x2="540" y2="120"/>
        <line id="e_n2" class="edge" x1="620" y1="250" x2="620" y2="120"/>
        <line id="e_n3" class="edge" x1="700" y1="250" x2="700" y2="120"/>
        <!-- –ù–æ–¥–∏ —Å–ø–æ–∂–∏–≤–∞—á—ñ–≤ -->
        <circle id="n1" class="node" cx="540" cy="100" r="12"/>
        <circle id="n2" class="node" cx="620" cy="100" r="12"/>
        <circle id="n3" class="node" cx="700" cy="100" r="12"/>
        <!-- –ó–∞—Å—É–≤–∫–∏ -->
        <rect id="v1_icon" class="valve" x="536" y="170" width="8" height="24" rx="2"/>
        <rect id="v2_icon" class="valve" x="616" y="170" width="8" height="24" rx="2"/>
        <rect id="v3_icon" class="valve" x="696" y="170" width="8" height="24" rx="2"/>
        <!-- –ü—ñ–¥–ø–∏—Å–∏ -->
        <text x="70" y="235" fill="#94a3b8" font-size="12">SRC</text>
        <text x="154" y="214" fill="#22c55e" font-size="12">–ì–†–ü</text>
        <text x="242" y="214" fill="#38bdf8" font-size="12">PUMP</text>
        <text x="520" y="268" fill="#94a3b8" font-size="12">N_split</text>
        <text x="530" y="92" fill="#e5e7eb" font-size="12">N1</text>
        <text x="610" y="92" fill="#e5e7eb" font-size="12">N2</text>
        <text x="690" y="92" fill="#e5e7eb" font-size="12">N3</text>
      </svg>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫: P –≤—É–∑–ª—ñ–≤ (–∫–ü–∞) —Ç–∞ Q –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ (–º¬≥/–≥–æ–¥)</h2>
      <div class="row">
        <button class="btn" id="mark">üìç –ó–Ω—è—Ç–∏ —Ç–æ—á–∫—É</button>
        <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
      </div>
      <canvas id="chart" class="chart" width="560" height="240"></canvas>
    </div>

    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞ KPI</h2>
      <div class="kpi">
        <span class="tag ok">KPI Pmin ‚â• <b id="kPmin">1.2</b> –∫–ü–∞</span>
        <span class="tag warn">KPI Pmax ‚â§ <b id="kPmax">5.0</b> –∫–ü–∞</span>
        <span class="tag bad">KPI ŒîP (—Ä–æ–∑–∫–∏–¥) ‚â§ <b id="kDelta">2.0</b> –∫–ü–∞</span>
      </div>
      <table class="tbl" style="margin-top:8px">
        <tbody>
          <tr><th>P(N1/N2/N3), –∫–ü–∞</th><td id="pNodes">‚Äî</td></tr>
          <tr><th>Q(N1/N2/N3), –º¬≥/–≥–æ–¥</th><td id="qNodes">‚Äî</td></tr>
          <tr><th>–ù–µ–≤–∏–∫–æ–Ω–∞–Ω–∏–π –ø–æ–ø–∏—Ç, %</th><td id="deficit">‚Äî</td></tr>
          <tr><th>–¢—Ä–∏–≤–æ–≥–∏</th><td id="alarms">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="state"><b class="warn">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h2>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ</pre>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (—Å–µ—Ä—ñ—è P/Q)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–ü—ñ–¥–±–µ—Ä–∏ —Ç–∞–∫–∏–π —Ä–µ–∂–∏–º <b>–Ω–∞—Å–æ—Å–∞</b> —ñ <b>—É—Å—Ç–∞–≤–∫—É –ì–†–ü</b>, —â–æ–± –ø—Ä–∏ –±–∞–∑–æ–≤–æ–º—É –ø–æ–ø–∏—Ç—ñ <b>P(N1..N3) ‚â• 1.2 –∫–ü–∞</b> —Ç–∞ <b>Pmax ‚â§ 5.0 –∫–ü–∞</b>.</li>
      <li>–£–≤—ñ–º–∫–Ω–∏ <b>–≤–∏—Ç—ñ–∫ L1</b> —ñ –ø–æ—è—Å–Ω–∏, —â–æ –∑–º—ñ–Ω–∏—Ç—å—Å—è –ø–æ P —Ç–∞ Q. –°–ø—Ä–æ–±—É–π –∫–æ–º–ø–µ–Ω—Å—É–≤–∞—Ç–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–º/–Ω–∞—Å–æ—Å–æ–º.</li>
      <li>–°–∏–º—É–ª—é–π <b>–∑–∞–∫–ª–∏–Ω—é–≤–∞–Ω–Ω—è V2</b>. –û—Ü—ñ–Ω–∏ <b>–¥–µ—Ñ—ñ—Ü–∏—Ç %</b> —Ç–∞ —Ä–æ–∑–∫–∞–∂–∏, —è–∫ –π–æ–≥–æ –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏.</li>
      <li>–ó–∞–ø—É—Å—Ç–∏ <b>—Å—Ç—Ä–∏–±–æ–∫ –ø–æ–ø–∏—Ç—É</b>. –ó—Ä–æ–±–∏ ‚â•10 —Ç–æ—á–æ–∫ –≥—Ä–∞—Ñ—ñ–∫–∞ —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT.</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

/* ===== –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ KPI ===== */
const KPI={Pmin:1.2, Pmax:5.0, dP:2.0}; // –∫–ü–∞

/* ===== –ú–µ—Ä–µ–∂–∞ (—Å–ø—Ä–æ—â–µ–Ω–∞ –º–æ–¥–µ–ª—å) =====
–í—É–∑–ª–∏: SRC -> –ì–†–ü -> PUMP -> T1 -> SPLIT -> (N1,N2,N3)
–ö–æ–∂–Ω–µ –≤—ñ–¥–≥–∞–ª—É–∂–µ–Ω–Ω—è –º–∞—î –≥—ñ–¥—Ä–∞–≤–ª. –æ–ø—ñ—Ä R ~ 1/(–≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–∞—Å—É–≤–∫–∏)^2.
P –¥–∂–µ—Ä–µ–ª–∞ = Pgrp_out (—Ä–µ–≥—É–ª—è—Ç–æ—Ä) + ŒîP–Ω–∞—Å–æ—Å–∞. –í—Ç—Ä–∞—Ç–∏ –Ω–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ ~ k*Q.
*/
let t=0, timer=null;
const hist=[]; // [{t, P1,P2,P3, Qmain}]
function state(){
  const dBase=+$('#dBase').value; // –º3/–≥–æ–¥
  const d=[+$('#d1').value, +$('#d2').value, +$('#d3').value].map(p=>p/100);
  const demand=[dBase*d[0], dBase*d[1], dBase*d[2]]; // —Ü—ñ–ª—å–æ–≤–∏–π –ø–æ–ø–∏—Ç –≤—É–∑–ª—ñ–≤
  const leak1=$('#leak1').checked? 40:0;
  const leak2=$('#leak2').checked? 30:0;
  const trip=$('#valvTrip').checked;
  const surge=$('#surge').checked;

  // –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–∞—Å—É–≤–æ–∫ (0..100 %)
  let v=[+$('#v1').value, +$('#v2').value, +$('#v3').value];
  if(trip) v[1]=0;
  // –æ–ø–æ—Ä–∏ –≥—ñ–ª–æ–∫ (–º–µ–Ω—à–∏–π –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è -> –±—ñ–ª—å—à–∏–π –æ–ø—ñ—Ä)
  const R=v.map(x=> 200/Math.max(5,x)**2 ); // —É–º–æ–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ

  // –Ω–∞—Å–æ—Å —ñ –ì–†–ü
  const sp=+$('#sp').value;     // –∫–ü–∞ (—É—Å—Ç–∞–≤–∫–∞ –≤–∏—Ö–æ–¥—É –ì–†–ü)
  const kp=+$('#kp').value;     // –∫–æ–µ—Ñ –ø–æ—Å–∏–ª–µ–Ω–Ω—è
  const pump=+$('#pump').value; // % –≤–ø–ª–∏–≤—É
  // –±–∞–∑–æ–≤–∞ –≤–∏—Ö—ñ–¥–Ω–∞ P –ø—ñ—Å–ª—è –ì–†–ü (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º PID-–ª–∞–π—Ç)
  // –†–æ–∑—Ä–∞—Ö—É—î–º–æ –ø–æ–º–∏–ª–∫—É –≤—ñ–¥ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ç–∏—Å–∫—É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫—Ä–æ–∫—É (—è–∫—â–æ —î)
  const last=hist.at(-1);
  const PavgLast = last? (last.P1+last.P2+last.P3)/3 : sp;
  const e = sp - PavgLast;
  const Pgrp = Math.max(0.5, sp + kp*e*0.4); // –æ–±–º–µ–∂–µ–Ω–Ω—è –≤—ñ–¥ ¬´–ø—Ä–æ–≤–∞–ª—É¬ª –Ω–∏–∂—á–µ 0.5 –∫–ü–∞
  const Ppump = pump*0.02; // –∫–ü–∞ –ø—ñ–¥–π–æ–º—É –≤—ñ–¥ –Ω–∞—Å–æ—Å–∞ (–≥—Ä—É–±–æ)

  const Psrc = Pgrp + Ppump; // –∫–ü–∞ –Ω–∞ –≤—Ö–æ–¥—ñ –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ
  const kMain = 0.0008;      // –≤—Ç—Ä–∞—Ç–∏ –Ω–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ

  // –†–æ–∑–ø–æ–¥—ñ–ª –≤–∏—Ç—Ä–∞—Ç: Q_i = (Psrc - Pnode_i)/R_i; —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è ~ demand_i, –≤–∏—Ç—ñ–∫ –¥–æ–¥–∞—î —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è
  // –ü—ñ–¥–±–µ—Ä–µ–º–æ Pnode_i —ñ Qmain —á–µ—Ä–µ–∑ —ñ—Ç–µ—Ä–∞—Ü—ñ—é (2-3 –∫—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –¥–µ–º–æ)
  let P = [Psrc*0.9, Psrc*0.88, Psrc*0.86]; // –ø–æ—á–∞—Ç–∫–æ–≤–µ –ø—Ä–∏–ø—É—â–µ–Ω–Ω—è
  let Q = [0,0,0];
  let leak=[0, leak1, leak2];
  const extra = surge? 0.4:0; // +40% –ø–æ–ø–∏—Ç—É –Ω–∞ 20—Å (—ñ–º—ñ—Ç–∞—Ü—ñ—è): —Ä–µ–∞–ª—ñ–∑—É—î–º–æ —á–µ—Ä–µ–∑ —Ñ–∞–∑—É t%40<20
  const surgeOn = surge && ((t%40)<20);
  for(let it=0; it<3; it++){
    for(let i=0;i<3;i++){
      const Rtot = R[i]+0.001; // –Ω–µ –Ω—É–ª—å
      const need = demand[i]*(surgeOn? (1+extra):1);
      // —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –ª—ñ–º—ñ—Ç—É—î—Ç—å—Å—è –≥—ñ–¥—Ä. –ø—Ä–æ–ø—É—Å–∫–Ω–æ—é –∑–¥–∞—Ç–Ω—ñ—Å—Ç—é: Qcap ~ (Psrc - P[i]) / R
      // –≤—ñ–∑—å–º–µ–º–æ P[i] —è–∫ —á–∞—Å—Ç–∫—É Psrc –º—ñ–Ω—É—Å –≤—Ç—Ä–∞—Ç–∏ –Ω–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ
      const Qcap = Math.max(0, (Psrc - Math.max(0,P[i])) / Rtot);
      const take = Math.min(need + leak[i], Qcap);
      Q[i]=take;
      // –æ–Ω–æ–≤–∏–º–æ P[i] –≤—ñ–¥ –≤—ñ–¥–±–æ—Ä—É
      P[i] = Math.max(0, Psrc - (Rtot*take) - kMain*(Q[0]+Q[1]+Q[2]));
    }
  }
  const Qmain = Q[0]+Q[1]+Q[2];
  return {Psrc,P,Q,Qmain, demand, leaks:[leak1,leak2], sp, kp, pump, v, trip, surgeOn};
}

/* ===== –ú–∞–ª—é–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏: –∫–æ–ª—ñ—Ä –ø–æ —Ç–∏—Å–∫—É ===== */
function colorForP(p){ // 0..6 –∫–ü–∞
  const x=Math.max(0,Math.min(1,p/6));
  const r=Math.floor(120+135*(1-x)); // —á–µ—Ä–≤–æ–Ω–∏–π ‚Üí –∑–µ–ª–µ–Ω–∏–π
  const g=Math.floor(80+160*x);
  const b=120;
  return `rgb(${r},${g},${b})`;
}
function updateSVG(st){
  // —Ñ–∞—Ä–±—É—î–º–æ —Ä–µ–±—Ä–∞ —Ç–∞ –Ω–æ–¥–∏ –ø–æ —Å–µ—Ä–µ–¥–Ω—å–æ–º—É —Ç–∏—Å–∫—É
  const Pavg = (st.P[0]+st.P[1]+st.P[2])/3;
  $('#e_main').setAttribute('stroke', colorForP(Pavg));
  $('#n_t1').setAttribute('fill', colorForP(Pavg));
  $('#n_split').setAttribute('fill', colorForP(Pavg*0.95));
  // –≤—ñ–¥–≥–∞–ª—É–∂–µ–Ω–Ω—è
  const idsE=['#e_n1','#e_n2','#e_n3'], idsN=['#n1','#n2','#n3'];
  for(let i=0;i<3;i++){
    $(idsE[i]).setAttribute('stroke', colorForP(st.P[i]));
    $(idsN[i]).setAttribute('fill', colorForP(st.P[i]));
  }
  // –∑–∞—Å—É–≤–∫–∏ ‚Äî —à–∏—Ä–∏–Ω–∞/–Ω–∞—Ö–∏–ª –ø–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—é
  const vids=['#v1_icon','#v2_icon','#v3_icon'];
  st.v.forEach((v,i)=>{ const el=$(vids[i]); el.setAttribute('transform', `rotate(${(100-v)*0.7}, ${parseFloat(el.getAttribute('x'))+4}, ${parseFloat(el.getAttribute('y'))+12})`); el.setAttribute('stroke', v>0? '#a3a3a3':'#f87171'); });
  // –ì–†–ü/–Ω–∞—Å–æ—Å ‚Äî ¬´—Å–≤—ñ—Ç—è—Ç—å—Å—è¬ª –∑–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é
  $('#n_grp').setAttribute('stroke', st.sp>0? '#22c55e':'#64748b');
  $('#n_pump').setAttribute('stroke', st.pump>0? '#38bdf8':'#64748b');
}

/* ===== –ì—Ä–∞—Ñ—ñ–∫ ===== */
const chart=$('#chart'), gc=chart.getContext('2d');
const series={t:[], P1:[], P2:[], P3:[], Qm:[]};
function drawChart(){
  const W=chart.width,H=chart.height; gc.clearRect(0,0,W,H);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-50,top=24,bottom=H-28;
  gc.strokeStyle='#1f2a44'; for(let i=0;i<5;i++){ const y=top+i*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,y); gc.lineTo(right,y); gc.stroke(); }
  if(series.t.length<2){ gc.fillStyle='#94a3b8'; gc.fillText('–ù–∞—Ç–∏—Å–Ω–∏ ¬´–ó–Ω—è—Ç–∏ —Ç–æ—á–∫—É¬ª –∞–±–æ –∑–∞–ø—É—Å—Ç–∏ —Å–∏–º—É–ª—è—Ü—ñ—é', left+8, top+14); return; }
  const n=series.t.length; const tMin=series.t[0], tMax=series.t[n-1], span=(tMax-tMin)||1;
  const pMax=Math.max(6, ...series.P1, ...series.P2, ...series.P3);
  const qMax=Math.max(200, ...series.Qm);
  const X=t=> left + (t-tMin)/span*(right-left);
  const YP=p=> bottom - (p/pMax)*(bottom-top);
  const YQ=q=> bottom - (q/qMax)*(bottom-top);
  // P1,P2,P3
  [['P1','#38bdf8'],['P2','#22c55e'],['P3','#fbbf24']].forEach(([k,col])=>{
    gc.beginPath(); gc.strokeStyle=col;
    series.t.forEach((tt,i)=>{ const x=X(tt), y=YP(series[k][i]); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); });
    gc.stroke();
  });
  // Qm
  gc.beginPath(); gc.strokeStyle='#e879f9';
  series.t.forEach((tt,i)=>{ const x=X(tt), y=YQ(series.Qm[i]); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); });
  gc.stroke();
  // –ª–µ–≥–µ–Ω–¥–∞
  gc.fillStyle='#94a3b8'; gc.font='11px ui-monospace';
  const key=(y,txt,col)=>{ gc.fillStyle=col; gc.fillRect(right+4,y,12,4); gc.fillStyle='#e5e7eb'; gc.fillText(txt,right+20,y+4); };
  key(top,'P1', '#38bdf8'); key(top+16,'P2','#22c55e'); key(top+32,'P3','#fbbf24'); key(top+48,'Qm','#e879f9');
}

/* ===== –ê–ª–≥–æ—Ä–∏—Ç–º —Å–∏–º—É–ª—è—Ü—ñ—ó ===== */
function step(){
  t+=1;
  const st=state();
  // –ú–µ—Ç—Ä–∏–∫–∏ –π —Ç—Ä–∏–≤–æ–≥–∏
  const Pmin=Math.min(...st.P), Pmax=Math.max(...st.P), dP=Pmax-Pmin;
  $('#tSim').textContent=t.toString();
  $('#qMain').textContent=st.Qmain.toFixed(0);
  $('#pMin').textContent=Pmin.toFixed(2);
  $('#pMax').textContent=Pmax.toFixed(2);
  $('#pNodes').textContent=`${st.P[0].toFixed(2)} / ${st.P[1].toFixed(2)} / ${st.P[2].toFixed(2)}`;
  $('#qNodes').textContent=`${st.Q[0].toFixed(0)} / ${st.Q[1].toFixed(0)} / ${st.Q[2].toFixed(0)}`;
  // –ù–µ–≤–∏–∫–æ–Ω–∞–Ω–∏–π –ø–æ–ø–∏—Ç
  const def = st.demand.map((d,i)=> Math.max(0, 1 - st.Q[i]/Math.max(1,d)) );
  const defPct = (def.reduce((a,b)=>a+b,0)/3)*100;
  $('#deficit').textContent=defPct.toFixed(1);

  // KPI alarms
  const alarms=[];
  if(Pmin<KPI.Pmin) alarms.push(`Pmin ${Pmin.toFixed(2)}<${KPI.Pmin}`);
  if(Pmax>KPI.Pmax) alarms.push(`Pmax ${Pmax.toFixed(2)}>${KPI.Pmax}`);
  if(dP>KPI.dP)     alarms.push(`ŒîP ${dP.toFixed(2)}>${KPI.dP}`);
  if(st.v[1]===0 && $('#valvTrip').checked) alarms.push('V2 –∑–∞–∫–ª–∏–Ω—é–≤. 0%');
  if($('#leak1').checked) alarms.push(`–í–∏—Ç—ñ–∫ L1 ${st.leaks[0]} –º¬≥/–≥–æ–¥`);
  if($('#leak2').checked) alarms.push(`–í–∏—Ç—ñ–∫ L2 ${st.leaks[1]} –º¬≥/–≥–æ–¥`);
  $('#alarms').textContent = alarms.length? alarms.join(', ') : '‚Äî';
  $('#state').innerHTML = alarms.length? `<b class="bad">–ê–≤–∞—Ä—ñ–π–Ω—ñ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</b>` :
                         defPct>5? `<b class="warn">–Ñ –¥–µ—Ñ—ñ—Ü–∏—Ç –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è</b>` :
                                   `<b class="ok">–†–µ–∂–∏–º —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π</b>`;

  // –í—ñ–¥–º–∞–ª—å–æ–≤–∫–∞
  updateSVG(st);

  // –õ–æ–≥ (–∫–æ—Ä–æ—Ç–∫–∏–π)
  if(t%5===0) log(`t=${t}s P=${st.P.map(x=>x.toFixed(2)).join('/')} –∫–ü–∞ Qm=${st.Qmain.toFixed(0)} –º3/–≥–æ–¥`);

  // –ê–≤—Ç–æ–∑–±—ñ—Ä —Ç–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫
  series.t.push(t); series.P1.push(st.P[0]); series.P2.push(st.P[1]); series.P3.push(st.P[2]); series.Qm.push(st.Qmain);
  if(series.t.length>240){ ['t','P1','P2','P3','Qm'].forEach(k=>series[k].shift()); }
  drawChart();
}

/* ===== –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è ===== */
$('#run').addEventListener('click',()=>{ if(timer) return; timer=setInterval(step,1000); log('–°–∏–º—É–ª—è—Ü—ñ—é –∑–∞–ø—É—â–µ–Ω–æ'); });
$('#stop').addEventListener('click',()=>{ if(timer){ clearInterval(timer); timer=null; log('–°–∏–º—É–ª—è—Ü—ñ—é –∑—É–ø–∏–Ω–µ–Ω–æ'); }});
$('#reset').addEventListener('click',()=>{ t=0; if(timer){clearInterval(timer); timer=null;} ['t','P1','P2','P3','Qm'].forEach(k=>series[k]=[]); drawChart(); log('–°–∫–∏–¥–∞–Ω–Ω—è'); });

$('#mark').addEventListener('click',()=>{ step(); });
$('#clear').addEventListener('click',()=>{ ['t','P1','P2','P3','Qm'].forEach(k=>series[k]=[]); drawChart(); log('–ì—Ä–∞—Ñ—ñ–∫ –æ—á–∏—â–µ–Ω–æ'); });

/* ===== –ï–∫—Å–ø–æ—Ä—Ç ===== */
function summary(){
  return {
    time:t,
    lastP: series.t.length? {P1:series.P1.at(-1),P2:series.P2.at(-1),P3:series.P3.at(-1)} : null,
    points: series.t.length,
    kpi: KPI,
    controls:{
      dBase:+$('#dBase').value, d1:+$('#d1').value, d2:+$('#d2').value, d3:+$('#d3').value,
      v1:+$('#v1').value, v2:+$('#v2').value, v3:+$('#v3').value,
      pump:+$('#pump').value, sp:+$('#sp').value, kp:+$('#kp').value,
      leak1:$('#leak1').checked, leak2:$('#leak2').checked, trip:$('#valvTrip').checked, surge:$('#surge').checked
    }
  };
}
$('#saveCsv').addEventListener('click',()=>{
  let csv='t_s,P1_kPa,P2_kPa,P3_kPa,Qmain_m3h\n';
  series.t.forEach((tt,i)=>{ csv+=`${tt},${series.P1[i].toFixed(3)},${series.P2[i].toFixed(3)},${series.P3[i].toFixed(3)},${series.Qm[i].toFixed(1)}\n`;});
  download('gas_para16_hydraulics_'+stamp()+'.csv', csv, 'text/csv'); log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click',()=>{
  const s=summary();
  const lines=[
    '–ü–∞—Ä–∞ 16 ‚Äî –ì—ñ–¥—Ä–∞–≤–ª—ñ—á–Ω—ñ —Ä–µ–∂–∏–º–∏ –º–µ—Ä–µ–∂—ñ: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ß–∞—Å –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è: ${s.time} c`,
    `–¢–æ—á–æ–∫ —Å–µ—Ä—ñ—ó: ${s.points}`,
    `–û—Å—Ç–∞–Ω–Ω—ñ P (–∫–ü–∞): ${s.lastP? `${s.lastP.P1.toFixed(2)} / ${s.lastP.P2.toFixed(2)} / ${s.lastP.P3.toFixed(2)}`:'‚Äî'}`,
    `KPI: Pmin‚â•${KPI.Pmin}, Pmax‚â§${KPI.Pmax}, ŒîP‚â§${KPI.dP}`,
    `–ö–µ—Ä—É–≤–∞–Ω–Ω—è: ${JSON.stringify(s.controls).replace(/,/g,', ')}`,
  ];
  download('gas_para16_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

/* ===== –Ü–Ω—ñ—Ç ===== */
drawChart(); updateSVG({P:[2,2,2], v:[100,100,100], sp:2, pump:60});
log('–ì–æ—Ç–æ–≤–æ. –ó–∞–ø—É—Å–∫–∞–π —Å–∏–º—É–ª—è—Ü—ñ—é –∞–±–æ –∑–Ω—ñ–º–∞–π —Ç–æ—á–∫–∏ –≤—Ä—É—á–Ω—É.');
</script>
</body>
</html>
