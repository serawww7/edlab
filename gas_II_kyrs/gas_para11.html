<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 11 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –†–µ–≤—ñ–∑—ñ—è –≥–∞–∑–æ–≤–∏—Ö –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤: —Å–µ—Ä—ñ–π–Ω–∏–π ‚Ññ/—Ñ–æ—Ç–æ, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –æ–±‚Äô—î–º, –ø–æ—Ö–∏–±–∫–∞, –≥—Ä–∞—Ñ—ñ–∫, 58 –º–º, CSV/TXT, QR</title>
<meta name="description" content="–ü—Ä–∞–∫—Ç–∏–∫–∞ —Ä–µ–≤—ñ–∑—ñ—ó –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤: —Ñ–æ—Ç–æ —Å–µ—Ä—ñ–π–Ω–æ–≥–æ ‚Ññ —Ç–∞ –ø–æ–∫–∞–∑–∞–Ω—å, –µ–º—É–ª—å–æ–≤–∞–Ω–∏–π –≤–∏—Ç—Ä–∞—Ç–æ–º—ñ—Ä, —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –æ–±‚Äô—î–º—É, –ø–æ—Ö–∏–±–∫–∞ –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–º –æ–±‚Äô—î–º–æ–º —ñ –ø–æ–∫–∞–∑–∞–Ω–Ω—è–º–∏, –∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫, NFC/ID, –ø—ñ–¥–ø–∏—Å, —á–µ–∫ 58 –º–º, CSV/TXT, QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
.sigWrap{border:1px dashed var(--line);border-radius:12px;padding:8px;background:#0c182a}
#sig{background:#0b1220;border:1px solid var(--line);border-radius:8px;touch-action:none}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üßÆüîß</span>
      <div>
        <b>–ü–∞—Ä–∞ 11 ‚Äî –†–µ–≤—ñ–∑—ñ—è –≥–∞–∑–æ–≤–∏—Ö –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤</b><br/>
        <span class="badge">–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ/—Ñ–æ—Ç–æ ‚Üí –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –æ–±‚Äô—î–º ‚Üí —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è V ‚Üí –ø–æ—Ö–∏–±–∫–∞ ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí NFC/ID ‚Üí –ø—ñ–¥–ø–∏—Å ‚Üí —á–µ–∫ 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –°—Ü–µ–Ω–∞—Ä—ñ–π</h2>
    <p>–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ–±—É—Ç–æ–≤–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ (G1.6/G2.5 —Ç–æ—â–æ). –§—ñ–∫—Å—É—î–º–æ <b>—Å–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä</b> —ñ <b>–ø–æ–∫–∞–∑–∞–Ω–Ω—è</b> (—Å—Ç–∞—Ä—Ç/—Ñ—ñ–Ω—ñ—à) –∑ —Ñ–æ—Ç–æ. 
      –ü—Ä–æ–≤–æ–¥–∏–º–æ —Ç–µ—Å—Ç –∑–∞ <b>–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–º –æ–±‚Äô—î–º–æ–º</b> (<span class="mono">Vref</span>): –ø–æ–¥–∞—î–º–æ —Å—Ç–∞–±—ñ–ª—å–Ω—É –≤–∏—Ç—Ä–∞—Ç—É, —Ç–∞–π–º–µ—Ä —ñ–Ω—Ç–µ–≥—Ä—É—î <b>–æ–±‚Äô—î–º</b> —Ç–∞ –æ–±—á–∏—Å–ª—é—î <b>–ø–æ—Ö–∏–±–∫—É</b>. 
      –î–∞–ª—ñ –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ –∑ <b>–¥–æ–ø—É—Å–∫–æ–º</b> —ñ —Ñ–æ—Ä–º—É—î–º–æ <b>—á–µ–∫ 58 –º–º</b>, <b>CSV/TXT</b>, <b>QR</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. ..., –∫–≤. ..."/></label>
      <label style="flex:1">–¢–∏–ø –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞
        <select id="meterType" class="input">
          <option>G1.6</option><option selected>G2.5</option><option>G4</option><option>–Ü–Ω—à–∏–π</option>
        </select>
      </label>
      <label style="flex:1">–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ<input id="serial" class="input" placeholder="–ù–∞–ø—Ä. 21-1234567"/></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."/></label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"/></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞: —á–µ–∫-–ª–∏—Å—Ç / –≤–∏–º—ñ—Ä–∏ / –≥—Ä–∞—Ñ—ñ–∫ / –∫–∞–º–µ—Ä–∞ / –ø—ñ–¥–ø–∏—Å / NFC -->
    <div class="card">
      <h2>üìù –ß–µ–∫-–ª–∏—Å—Ç —ñ–∑ —Ç–∞–π–º–µ—Ä–∞–º–∏</h2>
      <div id="steps"></div>

      <h2 style="margin-top:10px">üõ∞Ô∏è –ï–º—É–ª—è—Ç–æ—Ä –≤–∏—Ç—Ä–∞—Ç–∏ —Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è V</h2>
      <div class="block">
        <div class="row">
          <label style="flex:1">–í–∏—Ç—Ä–∞—Ç–∞, –º¬≥/–≥–æ–¥
            <input id="flow" type="range" class="input" min="0" max="6" step="0.1" value="1.2"/>
          </label>
          <span class="badge">–ü–æ—Ç–æ—á–Ω–∞: <b id="flowNum">1.2</b> –º¬≥/–≥–æ–¥</span>
          <button class="btn" id="markFlow">üìç –¢–æ—á–∫–∞ Q</button>
        </div>
        <div class="row">
          <label>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –æ–±‚Äô—î–º Vref, –º¬≥<input id="vref" type="number" class="input" step="0.001" value="0.010"/></label>
          <label>–î–æ–ø—É—Å–∫, % (¬±)<input id="tol" type="number" class="input" step="0.1" value="2.0"/></label>
          <label>–ü–æ–∫–∞–∑–∞–Ω–Ω—è —Å—Ç–∞—Ä—Ç, –º¬≥<input id="idxStart" type="number" class="input" step="0.001" value="1234.000"/></label>
          <label>–ü–æ–∫–∞–∑–∞–Ω–Ω—è —Ñ—ñ–Ω—ñ—à, –º¬≥<input id="idxEnd" type="number" class="input" step="0.001" value="1234.010"/></label>
          <button class="btn secondary" id="applyCfg">‚öôÔ∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
        </div>
        <div class="row">
          <button class="btn good" id="testStart">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç —Ç–µ—Å—Ç—É</button>
          <button class="btn secondary" id="testStop">‚èπÔ∏è –°—Ç–æ–ø</button>
          <button class="btn" id="testReset">üßπ –°–∫–∏–Ω—É—Ç–∏</button>
          <span class="badge">–ß–∞—Å: <b id="tSec">0</b> —Å</span>
          <span class="badge">–Ü–Ω—Ç–µ–≥—Ä. –æ–±‚Äô—î–º Vm: <b id="vMeas">0.000</b> –º¬≥</span>
        </div>
        <div class="kpi" style="margin-top:6px">
          <span class="tag ok">–ü–æ—Ö–∏–±–∫–∞ (–∑–∞ Vref): <b id="errRef">‚Äî</b> %</span>
          <span class="tag warn">–ü–æ—Ö–∏–±–∫–∞ (–∑–∞ –ø–æ–∫–∞–∑.): <b id="errIdx">‚Äî</b> %</span>
          <span class="tag bad">–°—Ç–∞—Ç—É—Å: <b id="statusAll">‚Äî</b></span>
        </div>
      </div>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ (Q, –º¬≥/–≥–æ–¥ / Vcum, –º¬≥)</h2>
      <div class="canvasWrap"><canvas id="chart" class="chart" width="520" height="240"></canvas></div>
      <div class="row">
        <button class="btn secondary" id="clearSeries">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
      </div>

      <h2 style="margin-top:10px">üé• –§–æ—Ç–æ (4 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay playsinline muted></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="plate">üì∑ –¢–∞–±–ª–∏—á–∫–∞/—Å–µ—Ä—ñ–π–Ω–∏–π</button>
          <button class="btn" data-kind="idxStart">üì∑ –ü–æ–∫–∞–∑–∞–Ω–Ω—è —Å—Ç–∞—Ä—Ç</button>
          <button class="btn" data-kind="idxEnd">üì∑ –ü–æ–∫–∞–∑–∞–Ω–Ω—è —Ñ—ñ–Ω—ñ—à</button>
          <button class="btn" data-kind="setup">üì∑ –°—Ö–µ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</button><br/>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">‚úçÔ∏è –ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>
      <div class="sigWrap">
        <canvas id="sig" width="520" height="200"></canvas>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="sigClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
          <button class="btn" id="sigSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
          <span class="badge" id="sigStat">–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î</span>
        </div>
      </div>

      <h2 style="margin-top:10px">üì∂ NFC / ID –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞</h2>
      <div class="block">
        <div class="row">
          <button class="btn" id="nfcBtn">üì∂ NFC</button>
          <input id="asset" class="input" placeholder="ID –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (—è–∫—â–æ NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)"/>
          <button class="btn secondary" id="saveAsset">üíæ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <span class="badge" id="nfcs">–°—Ç–∞—Ç—É—Å NFC: –æ—á—ñ–∫—É—î—Ç—å—Å—è</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞: –º–µ—Ç—Ä–∏–∫–∏/–æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è/–µ–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞ —Å—Ç–∞–Ω</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>ID –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞</th><td id="mAsset">‚Äî</td></tr>
          <tr><th>–¢–∏–ø</th><td id="mType">‚Äî</td></tr>
          <tr><th>–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ</th><td id="mSerial">‚Äî</td></tr>
          <tr><th>–ü–æ–∫–∞–∑–∞–Ω–Ω—è (—Å—Ç–∞—Ä—Ç ‚Üí —Ñ—ñ–Ω—ñ—à)</th><td id="mIdx">‚Äî</td></tr>
          <tr><th>Vm / Vref</th><td id="mV">‚Äî</td></tr>
          <tr><th>–ü–æ—Ö–∏–±–∫–∞ (Vref / –ø–æ–∫–∞–∑.)</th><td id="mErr">‚Äî</td></tr>
          <tr><th>–¢–æ—á–æ–∫ Q</th><td id="mPts">0</td></tr>
          <tr><th>–§–æ—Ç–æ (plate/start/end/setup)</th><td id="mPhotos">0 / 0 / 0 / 0</td></tr>
          <tr><th>–ü—ñ–¥–ø–∏—Å</th><td id="mSig">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—Ä–æ–∫–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å + —Å–µ—Ä—ñ–π–Ω–∏–π ‚Ññ + —Ç–∏–ø ‚Äî <b>2</b></li>
        <li>ID (NFC/–∫–æ–¥) ‚Äî <b>2</b></li>
        <li>–§–æ—Ç–æ (–≤—Å—ñ 4) ‚Äî <b>2</b></li>
        <li>–¢–µ—Å—Ç –æ–±‚Äô—î–º—É (Vm) —ñ –ø–æ—Ö–∏–±–∫–∞ ‚Äî <b>2</b></li>
        <li>–ì—Ä–∞—Ñ—ñ–∫: ‚â•8 —Ç–æ—á–æ–∫ ‚Äî <b>1</b></li>
        <li>–ü—ñ–¥–ø–∏—Å ‚Äî <b>1</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case/Asset)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:240px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –°—Ç–∞–Ω –∫–µ–π—Å—É
let CASE_ID=null, ASSET_ID=null;
let photos={plate:null, idxStart:null, idxEnd:null, setup:null};
let sigUrl=null;

// ===== –ö–µ–π—Å
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||''); const tech=clean($('#tech').value||''); const day=$('#day').value; const serial=clean($('#serial').value||'');
  if(!addr||!tech||!day||!serial){ alert('–í–∫–∞–∂–∏ –∞–¥—Ä–µ—Å—É, —Å–µ—Ä—ñ–π–Ω–∏–π ‚Ññ, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ç–∞ –¥–∞—Ç—É'); return; }
  CASE_ID='M-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent='–ö–µ–π—Å: '+CASE_ID;
  log(`–ö–µ–π—Å ${CASE_ID}: ${addr}, ${$('#meterType').value}, SN ${serial}, ${tech}, ${day}`);
  updateMetrics(); computeAll(); drawChart();
});

// ===== –ß–µ–∫-–ª–∏—Å—Ç
const STEPS_DEF=[
  {k:'verify', name:'–ó–æ–≤–Ω—ñ—à–Ω—ñ–π –æ–≥–ª—è–¥ (–ø–ª–æ–º–±–∏/–∫–æ—Ä–ø—É—Å)'},
  {k:'serial', name:'–§—ñ–∫—Å–∞—Ü—ñ—è —Å–µ—Ä—ñ–π–Ω–æ–≥–æ ‚Ññ + —Ñ–æ—Ç–æ —Ç–∞–±–ª–∏—á–∫–∏'},
  {k:'idx0',   name:'–§–æ—Ç–æ –ø–æ–∫–∞–∑–∞–Ω—å (—Å—Ç–∞—Ä—Ç) + –∑–∞–ø–∏—Å'},
  {k:'run',    name:'–ü–æ–¥–∞—á–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó –≤–∏—Ç—Ä–∞—Ç–∏ / —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è V'},
  {k:'idx1',   name:'–§–æ—Ç–æ –ø–æ–∫–∞–∑–∞–Ω—å (—Ñ—ñ–Ω—ñ—à) + –∑–∞–ø–∏—Å'},
  {k:'seal',   name:'–ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è/–∞–∫—Ç —Ä–µ–≤—ñ–∑—ñ—ó'}
];
let STEPS=STEPS_DEF.map(s=>({...s, tsStart:null, tsStop:null, dur:0, ok:false}));

function renderSteps(){
  const box=$('#steps'); box.innerHTML='';
  STEPS.forEach((s,i)=>{
    const div=document.createElement('div'); div.className='block'; div.dataset.key=s.k;
    div.innerHTML=`
      <b>${i+1}. ${s.name}</b> <span class="badge mono">${s.k}</span>
      <div class="row" style="margin-top:6px">
        <button class="btn btn-start">‚ñ∂Ô∏è Start</button>
        <button class="btn secondary btn-stop">‚èπÔ∏è Stop</button>
        <button class="btn good btn-done">‚úÖ Done</button>
        <span class="badge">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: <b class="dur">0</b> —Å</span>
      </div>`;
    box.appendChild(div);
  });
}
renderSteps();

function stepByKey(k){ return STEPS.find(x=>x.k===k); }
$('#steps').addEventListener('click',(e)=>{
  const wrap=e.target.closest('.block'); if(!wrap) return; const key=wrap.dataset.key; const s=stepByKey(key); const now=Date.now();
  if(e.target.classList.contains('btn-start')){ s.tsStart=now; s.tsStop=null; s.ok=false; log(`–ö—Ä–æ–∫ ${key}: Start`); }
  if(e.target.classList.contains('btn-stop')){ if(s.tsStart){ s.tsStop=now; s.dur+=Math.max(0,Math.round((s.tsStop-s.tsStart)/1000)); s.tsStart=null; wrap.querySelector('.dur').textContent=String(s.dur); log(`–ö—Ä–æ–∫ ${key}: Stop (+${s.dur}s)`);} }
  if(e.target.classList.contains('btn-done')){ if(s.tsStart){ s.tsStop=now; s.dur+=Math.max(0,Math.round((s.tsStop-s.tsStart)/1000)); s.tsStart=null; wrap.querySelector('.dur').textContent=String(s.dur);} s.ok=true; log(`–ö—Ä–æ–∫ ${key}: Done (total ${s.dur}s)`); }
  updateMetrics();
});
setInterval(()=>{
  const now=Date.now();
  STEPS.forEach(s=>{ if(s.tsStart){ const curr=Math.max(0,Math.round((now-s.tsStart)/1000)); const wrap=$(`[data-key="${s.k}"]`); if(wrap){ wrap.querySelector('.dur').textContent=String(s.dur+curr); } }});
},1000);

// ===== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è/–æ–±—á–∏—Å–ª–µ–Ω–Ω—è
let CFG={vref:0.010, tol:2.0, idxStart:1234.000, idxEnd:1234.010};
$('#applyCfg').addEventListener('click',()=>{
  CFG.vref   = Math.max(0, parseFloat($('#vref').value)||0.010);
  CFG.tol    = Math.max(0, parseFloat($('#tol').value)||2.0);
  CFG.idxStart = Math.max(0, parseFloat($('#idxStart').value)||0);
  CFG.idxEnd   = Math.max(0, parseFloat($('#idxEnd').value)||0);
  log(`–ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ: Vref ${CFG.vref} –º¬≥, –¥–æ–ø—É—Å–∫ ¬±${CFG.tol}% ; –ø–æ–∫–∞–∑–∞–Ω–Ω—è ${CFG.idxStart}‚Üí${CFG.idxEnd} –º¬≥`);
  computeAll();
});

// ===== –°–µ—Ä—ñ—ó/–≥—Ä–∞—Ñ—ñ–∫/—ñ–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä
const chart=$('#chart'), gc=chart.getContext('2d');
let t0=null, timer=null, elapsed=0; // —Å
let sQ=[], sV=[]; // {t,v} –¥–µ Q –º¬≥/–≥–æ–¥, V –º¬≥
let Vcum=0;

function drawChart(){
  const W=chart.width,H=chart.height; gc.clearRect(0,0,W,H);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-50,top=24,bottom=H-30;
  // —Å—ñ—Ç–∫–∞
  gc.strokeStyle='#1f2a44'; for(let y=0;y<5;y++){ const yy=top+y*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,yy); gc.lineTo(right,yy); gc.stroke(); }
  if((sQ.length+sV.length)<2){ gc.fillStyle='#94a3b8'; gc.fillText('–ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç –∞–±–æ –¥–æ–¥–∞–≤–∞–π —Ç–æ—á–∫–∏ Q', left+8, top+14); return; }
  const all=[...sQ.map(x=>x.t), ...sV.map(x=>x.t)].sort((a,b)=>a-b);
  const tMin=all[0], tMax=all[all.length-1], span=tMax-tMin||1;
  const qMax=Math.max(6, ...sQ.map(p=>p.v), 1);
  const vMax=Math.max(Math.max(CFG.vref*1.2, 0.02), ...sV.map(p=>p.v), 0.01);
  function X(t){ return left + (t - tMin)/span*(right-left); }
  function Yq(v){ return bottom - (v/qMax)*(bottom-top); }
  function Yv(v){ return bottom - (v/vMax)*(bottom-top); }

  // Q ‚Äî —Å–∏–Ω—è
  if(sQ.length){
    gc.beginPath(); gc.strokeStyle='#38bdf8';
    sQ.forEach((p,i)=>{ const x=X(p.t), y=Yq(p.v); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); }); gc.stroke();
    sQ.forEach(p=>{ const x=X(p.t), y=Yq(p.v); gc.fillStyle='#38bdf8'; gc.fillRect(x-2,y-2,4,4); });
  }
  // Vcum ‚Äî –∑–µ–ª–µ–Ω–∞
  if(sV.length){
    gc.beginPath(); gc.strokeStyle='#22c55e';
    sV.forEach((p,i)=>{ const x=X(p.t), y=Yv(p.v); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); }); gc.stroke();
    sV.forEach(p=>{ const x=X(p.t), y=Yv(p.v); gc.fillStyle='#22c55e'; gc.fillRect(x-2,y-2,4,4); });
  }
  // –õ—ñ–Ω—ñ—è Vref
  gc.strokeStyle='#fbbf24'; gc.beginPath(); gc.moveTo(left, Yv(CFG.vref)); gc.lineTo(right, Yv(CFG.vref)); gc.stroke();

  // –ª–µ–≥–µ–Ω–¥–∞
  gc.fillStyle='#94a3b8'; gc.font='11px ui-monospace';
  gc.fillText('–º¬≥/–≥–æ–¥ (–ª—ñ–≤–∞) / –º¬≥ (–ø—Ä–∞–≤–∞)', left, top-6);
  gc.fillStyle='#38bdf8'; gc.fillRect(right+4, top, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('Q', right+20, top+4);
  gc.fillStyle='#22c55e'; gc.fillRect(right+4, top+16, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('Vcum', right+20, top+20);
  gc.fillStyle='#fbbf24'; gc.fillRect(right+4, top+32, 12, 4); gc.fillStyle='#e5e7eb'; gc.fillText('Vref', right+20, top+36);
}

function addPointQ(q){
  const now=Date.now(); if(!t0) t0=now;
  sQ.push({t:now, v:q});
  drawChart(); updateMetrics();
}
$('#flow').addEventListener('input',()=>{ $('#flowNum').textContent=$('#flow').value; });
$('#markFlow').addEventListener('click',()=>{ const v=parseFloat($('#flow').value); addPointQ(v); log('–¢–æ—á–∫–∞ Q: '+v.toFixed(2)+' –º¬≥/–≥–æ–¥'); });

function integrateTick(){
  const q=parseFloat($('#flow').value)||0; // –º¬≥/–≥–æ–¥
  elapsed += 1; $('#tSec').textContent=String(elapsed);
  const dV = q/3600; // –º¬≥ –∑–∞ 1 —Å
  Vcum += dV; $('#vMeas').textContent=Vcum.toFixed(3);
  const now=Date.now(); sV.push({t:now, v:Vcum});
  if(sQ.length===0 || sQ[sQ.length-1].t!==now){ sQ.push({t:now, v:q}); }
  drawChart(); computeAll(); updateMetrics();
}
$('#testStart').addEventListener('click',()=>{ if(timer) return; timer=setInterval(integrateTick,1000); log('–°—Ç–∞—Ä—Ç —Ç–µ—Å—Ç—É'); });
$('#testStop').addEventListener('click',()=>{ if(timer){ clearInterval(timer); timer=null; log('–°—Ç–æ–ø —Ç–µ—Å—Ç—É'); }});
$('#testReset').addEventListener('click',()=>{ if(timer){ clearInterval(timer); timer=null; } elapsed=0; Vcum=0; sQ=[]; sV=[]; t0=null; $('#tSec').textContent='0'; $('#vMeas').textContent='0.000'; drawChart(); computeAll(); updateMetrics(); log('–°–∫–∏–Ω—É—Ç–æ'); });
$('#clearSeries').addEventListener('click',()=>{ sQ=[]; sV=[]; t0=null; drawChart(); updateMetrics(); log('–û—á–∏—â–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫'); });

// ===== –û–±—á–∏—Å–ª–µ–Ω–Ω—è –ø–æ—Ö–∏–±–æ–∫/—Å—Ç–∞—Ç—É—Å—É
function computeAll(){
  const Vm = Vcum; // —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∏–π –æ–±‚Äô—î–º
  const Vref = Math.max(0, parseFloat($('#vref').value)||CFG.vref);
  const tol = Math.max(0, parseFloat($('#tol').value)||CFG.tol);
  const idxS = Math.max(0, parseFloat($('#idxStart').value)||CFG.idxStart);
  const idxE = Math.max(0, parseFloat($('#idxEnd').value)||CFG.idxEnd);
  const Vidx = Math.max(0, idxE - idxS);

  const errRef = (Vref>0)? ((Vm - Vref)/Vref*100) : NaN;
  const errIdx = (Vidx>0)? ((Vm - Vidx)/Vidx*100) : NaN;

  $('#errRef').textContent = isFinite(errRef)? errRef.toFixed(2): '‚Äî';
  $('#errIdx').textContent = isFinite(errIdx)? errIdx.toFixed(2): '‚Äî';

  const passRef = isFinite(errRef)? Math.abs(errRef)<=tol : false;
  const passIdx = isFinite(errIdx)? Math.abs(errIdx)<=tol : true; // —è–∫—â–æ –Ω–µ–º–∞—î ‚Äî –Ω–µ –±–ª–æ–∫—É—î
  const status = (passRef && passIdx)? '–£ –¥–æ–ø—É—Å–∫—É' : (passRef||passIdx)? '–ß–∞—Å—Ç–∫–æ–≤–æ –û–ö' : '–ü–æ–∑–∞ –¥–æ–ø—É—Å–∫–æ–º';
  $('#statusAll').textContent=status;

  $('#mV').textContent = `${Vm.toFixed(3)} / ${Vref.toFixed(3)} –º¬≥`;
  $('#mErr').textContent = `${isFinite(errRef)?errRef.toFixed(2)+'%':'‚Äî'} / ${isFinite(errIdx)?errIdx.toFixed(2)+'%':'‚Äî'}`;
  updateState();
}

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ
let stream=null;
async function startCam(){
  try{ stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); $('#vid').srcObject=stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ'); }
  catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);
function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  c.getContext('2d').drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png'); photos[kind]=url; renderGallery(); log(`–§–æ—Ç–æ: ${kind}`); updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));
function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  if(photos.plate){ const i=document.createElement('img'); i.className='photo'; i.src=photos.plate; i.alt='plate'; gal.appendChild(i); }
  if(photos.idxStart){ const i=document.createElement('img'); i.className='photo'; i.src=photos.idxStart; i.alt='idxStart'; gal.appendChild(i); }
  if(photos.idxEnd){ const i=document.createElement('img'); i.className='photo'; i.src=photos.idxEnd; i.alt='idxEnd'; gal.appendChild(i); }
  if(photos.setup){ const i=document.createElement('img'); i.className='photo'; i.src=photos.setup; i.alt='setup'; gal.appendChild(i); }
}

// ===== –ü—ñ–¥–ø–∏—Å
const sig=$('#sig'); const ctx=sig.getContext('2d');
let drawing=false, last=null, hasInk=false;
function xy(e){ const r=sig.getBoundingClientRect(); const t=e.touches? e.touches[0]:e; return {x:(t.clientX-r.left)*sig.width/r.width, y:(t.clientY-r.top)*sig.height/r.height}; }
function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke(); }
sig.addEventListener('pointerdown',e=>{ drawing=true; last=xy(e); hasInk=true; });
sig.addEventListener('pointermove',e=>{ if(!drawing) return; const p=xy(e); line(last,p); last=p; });
sig.addEventListener('pointerup',()=>{ drawing=false; last=null; });
sig.addEventListener('pointerleave',()=>{ drawing=false; last=null; });
$('#sigClear').addEventListener('click',()=>{ ctx.clearRect(0,0,sig.width,sig.height); hasInk=false; $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î'; updateMetrics(); });
$('#sigSave').addEventListener('click',()=>{ if(!hasInk){ alert('–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å—É'); return; } sigUrl=sig.toDataURL('image/png'); $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ'; const a=document.createElement('a'); a.href=sigUrl; a.download='signature_'+(CASE_ID||'case')+'_'+stamp()+'.png'; document.body.appendChild(a); a.click(); a.remove(); log('–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ (png)'); updateMetrics(); });

// ===== NFC / ID
async function tryNFC(){
  if('NDEFReader' in window){
    try{
      const reader=new NDEFReader(); await reader.scan();
      $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
      reader.addEventListener('reading', ({message, serialNumber})=>{
        let text=''; for(const rec of message.records){ if(rec.recordType==='text'){ const dec=new TextDecoder(rec.encoding||'utf-8'); text = dec.decode(rec.data); } }
        ASSET_ID = (text||serialNumber||'NFC-'+Math.random().toString(36).slice(2,7)).toString();
        $('#asset').value=ASSET_ID; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑—á–∏—Ç–∞–Ω–æ';
        log('NFC: '+ASSET_ID); updateMetrics();
      });
    }catch(e){ $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –ø–æ–º–∏–ª–∫–∞'; alert('NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π/–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π'); }
  }else{ alert('Web NFC –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –í–≤–µ–¥–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É.'); }
}
$('#nfcBtn').addEventListener('click', tryNFC);
$('#saveAsset').addEventListener('click',()=>{ const v=clean($('#asset').value||''); if(!v){ alert('–í–≤–µ–¥–∏ ID –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞'); return; } ASSET_ID=v; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É'; log('ID –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞: '+ASSET_ID); updateMetrics(); });

// ===== –ú–µ—Ç—Ä–∏–∫–∏/—Å—Ç–∞–Ω
function updateState(){
  let score=0;
  const caseOk=!!CASE_ID; 
  const serialOk=!!clean($('#serial').value||'');
  const assetOk=!!(ASSET_ID||clean($('#asset').value||''));
  const photosOk=!!photos.plate && !!photos.idxStart && !!photos.idxEnd && !!photos.setup;
  const pointsOk = (sQ.length + sV.length) >= 8;
  const status = $('#statusAll').textContent;
  const sigOk=!!sigUrl;

  if(caseOk && serialOk)score+=2;
  if(assetOk)score+=2;
  if(photosOk)score+=2;
  if(pointsOk)score+=1;
  if(status && status!=='–ü–æ–∑–∞ –¥–æ–ø—É—Å–∫–æ–º')score+=2;
  if(sigOk)score+=1;

  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML=html;
}
function updateMetrics(){
  $('#mCase').textContent = CASE_ID||'‚Äî';
  $('#mAsset').textContent = ASSET_ID||($('#asset').value||'‚Äî');
  $('#mType').textContent = $('#meterType').value||'‚Äî';
  $('#mSerial').textContent = $('#serial').value||'‚Äî';
  $('#mIdx').textContent = `${($('#idxStart').value||'‚Äî')} ‚Üí ${($('#idxEnd').value||'‚Äî')}`;
  $('#mPts').textContent = `${sQ.length}`;
  $('#mPhotos').textContent = `${photos.plate?1:0} / ${photos.idxStart?1:0} / ${photos.idxEnd?1:0} / ${photos.setup?1:0}`;
  $('#mSig').textContent = sigUrl?'—î':'‚Äî';
  computeAll();
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR
function summary(){
  const addr=$('#addr').value||'‚Äî', tech=$('#tech').value||'‚Äî', day=$('#day').value||'‚Äî';
  const serial=$('#serial').value||'‚Äî', type=$('#meterType').value||'‚Äî';
  const Vm=parseFloat($('#vMeas').textContent)||0, Vref=parseFloat($('#vref').value)||0;
  const tol=parseFloat($('#tol').value)||0, errR=$('#errRef').textContent, errI=$('#errIdx').textContent;
  const idxS=parseFloat($('#idxStart').value)||0, idxE=parseFloat($('#idxEnd').value)||0;
  return {
    case: CASE_ID||'‚Äî', addr, type, serial, tech, day,
    asset: ASSET_ID||($('#asset').value||'‚Äî'),
    config: {Vref, tol_pct: tol},
    readings: {index_start: idxS, index_end: idxE},
    volume: {measured: Vm, by_index: Math.max(0, idxE-idxS)},
    error_pct: {vs_vref: errR, vs_index: errI},
    status: $('#statusAll').textContent,
    points: {Q: sQ.map(p=>({t:new Date(p.t).toISOString(), m3h:p.v})), V: sV.map(p=>({t:new Date(p.t).toISOString(), m3:p.v}))},
    photos: {plate:!!photos.plate, idxStart:!!photos.idxStart, idxEnd:!!photos.idxEnd, setup:!!photos.setup},
    signature: !!sigUrl
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const s=summary();
  let csv='field,value\n';
  for(const [k,v] of Object.entries(s)){
    if(k==='points') continue;
    if(typeof v==='object'){ csv+=`${k},${JSON.stringify(v).replace(/,/g,';')}\n`; }
    else csv+=`${k},${String(v).replace(/,/g,';')}\n`;
  }
  csv+='\n# flow_points\niso_time,m3h\n';
  s.points.Q.forEach(p=>{ csv+=`${p.t},${p.m3h}\n`; });
  csv+='\n# volume_points\niso_time,m3\n';
  s.points.V.forEach(p=>{ csv+=`${p.t},${p.m3}\n`; });
  download('gas_para11_meter_'+stamp()+'.csv', csv, 'text/csv'); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const s=summary();
  const lines=[
    '–ü–∞—Ä–∞ 11 ‚Äî –†–µ–≤—ñ–∑—ñ—è –≥–∞–∑–æ–≤–∏—Ö –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${s.case}`, `–ê–¥—Ä–µ—Å–∞: ${s.addr}`, `–¢–∏–ø: ${s.type}`, `–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ: ${s.serial}`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${s.tech}`, `–î–∞—Ç–∞: ${s.day}`, `ID/Asset: ${s.asset}`,
    `Vref: ${s.config.Vref} –º¬≥, –¥–æ–ø—É—Å–∫: ¬±${s.config.tol_pct}%`,
    `–ü–æ–∫–∞–∑–∞–Ω–Ω—è: ${s.readings.index_start} ‚Üí ${s.readings.index_end} –º¬≥ (Œî=${(s.readings.index_end-s.readings.index_start).toFixed(3)} –º¬≥)`,
    `Vm: ${s.volume.measured.toFixed(3)} –º¬≥`,
    `–ü–æ—Ö–∏–±–∫–∞ vs Vref: ${s.error_pct.vs_vref}% ; vs —ñ–Ω–¥–µ–∫—Å: ${s.error_pct.vs_index}%`,
    `–°—Ç–∞—Ç—É—Å: ${s.status}`,
    `–§–æ—Ç–æ (plate/start/end/setup): ${s.photos.plate?'1':'0'} / ${s.photos.idxStart?'1':'0'} / ${s.photos.idxEnd?'1':'0'} / ${s.photos.setup?'1':'0'}`,
    `–ü—ñ–¥–ø–∏—Å: ${s.signature?'—î':'‚Äî'}`,
    `--- –¢–æ—á–æ–∫: Q=${s.points.Q.length}, V=${s.points.V.length} ---`
  ];
  download('gas_para11_meter_'+stamp()+'.txt', lines.join('\n')); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const s=summary(); const rc=$('#rc'); rc.hidden=false;
  const lines=[
'=== METER REVISION (58–º–º) ===',
'Case: '+s.case,
'Date: '+s.day,
'Addr: '+s.addr,
'Type: '+s.type+' SN:'+s.serial,
'Asset:'+s.asset,
'Idx:  '+s.readings.index_start+'->'+s.readings.index_end,
'Vref: '+s.config.Vref+' Vm:'+s.volume.measured.toFixed(3),
'Err:  '+s.error_pct.vs_vref+'% / '+s.error_pct.vs_index+'%',
'Pts:  Q'+s.points.Q.length+' V'+s.points.V.length,
'Photos:'+(s.photos.plate?1:0)+'/'+(s.photos.idxStart?1:0)+'/'+(s.photos.idxEnd?1:0)+'/'+(s.photos.setup?1:0)+' Sign:'+(s.signature?'Y':'N'),
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para11_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def=CASE_ID||ASSET_ID||'meter-revision';
  const data=prompt('–í—Å—Ç–∞–≤ URL/ID (Case –∞–±–æ Asset):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –Ü–Ω—ñ—Ç
function initDefaults(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); }
initDefaults(); updateMetrics(); computeAll(); drawChart();

// –í–±—É–¥–æ–≤–∞–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Moodle/iFrame)
(function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
</script>
</body>
</html>
