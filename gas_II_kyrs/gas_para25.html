<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 25 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî AI-–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –ø—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∏: —ñ—Å—Ç–æ—Ä—ñ—è ‚Üí –ø—Ä–∞–≤–∏–ª–∞ ‚Üí —Ç–∏–∂–Ω–µ–≤—ñ –º–∞—Ä—à—Ä—É—Ç–∏ ‚Üí –µ—Ñ–µ–∫—Ç</title>
<meta name="description" content="–ó–∞–≤–∞–Ω—Ç–∞–∂ —ñ—Å—Ç–æ—Ä—ñ—é –∞–≤–∞—Ä—ñ–π, –Ω–∞–≤—á–∏ –ø—Ä–æ—Å—Ç—ñ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∏–∑–∏–∫—É, —Å—Ñ–æ—Ä–º—É–π —Ç–∏–∂–Ω–µ–≤–∏–π –ø–ª–∞–Ω –ø—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∏ –∑ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ –¥–ª—è –±—Ä–∏–≥–∞–¥, –ø–æ–¥–∏–≤–∏—Å—å –¥–∞—à–±–æ—Ä–¥ –µ—Ñ–µ–∫—Ç—É, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, —á–µ–∫ 58 –º–º, QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:110px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
pre.log{max-height:220px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
canvas.chart,canvas.map{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.map{height:360px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.progress{height:14px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0b1220}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#38bdf8);width:0%}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üß†üó∫Ô∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 25 ‚Äî AI-–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –ø—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∏</b><br/>
        <span class="badge">–Ü—Å—Ç–æ—Ä—ñ—è ‚Üí –ø—Ä–∞–≤–∏–ª–∞ —Ä–∏–∑–∏–∫—É ‚Üí —Ç–∏–∂–Ω–µ–≤—ñ –º–∞—Ä—à—Ä—É—Ç–∏ ‚Üí –µ—Ñ–µ–∫—Ç ‚Üí –µ–∫—Å–ø–æ—Ä—Ç/QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç / –≤—Ö—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂ <b>CSV —ñ—Å—Ç–æ—Ä—ñ—ó</b> –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ <b>üß™ –ü—Ä–∏–∫–ª–∞–¥–∏</b>. AI –æ–±—á–∏—Å–ª–∏—Ç—å <b>–≤–∞–≥–∏ –æ–∑–Ω–∞–∫</b>, —Å—Ñ–æ—Ä–º—É—î <b>–ø—Ä–∞–≤–∏–ª–∞ —Ä–∏–∑–∏–∫—É</b> –¥–ª—è —Å–µ–∫—Ç–æ—Ä—ñ–≤, –ø–æ–±—É–¥—É—î <b>—Ç–µ–ø–ª–æ–≤—É –∫–∞—Ä—Ç—É</b>, –∞ –ø–æ—Ç—ñ–º –∑–≥–µ–Ω–µ—Ä—É—î <b>–ø–ª–∞–Ω —Ç–∏–∂–Ω—è</b> –∑ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ –¥–ª—è N –±—Ä–∏–≥–∞–¥ —Ç–∞ –æ—Ü—ñ–Ω–∏—Ç—å <b>–æ—á—ñ–∫—É–≤–∞–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—É</b>.</p>
    <div class="row">
      <input id="file" type="file" accept=".csv" class="input" style="max-width:380px"/>
      <button class="btn" id="ex">üß™ –ü—Ä–∏–∫–ª–∞–¥–∏ (200 —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤)</button>
      <button class="btn good" id="train">üß† –ù–∞–≤—á–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞</button>
      <button class="btn" id="plan">üóìÔ∏è –°–ø–ª–∞–Ω—É–≤–∞—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å</button>
      <button class="btn secondary" id="reset">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
      <span class="badge">–ó–∞–ø–∏—Å—ñ–≤: <b id="nRec">0</b></span>
      <span class="badge">–°–µ–∫—Ç–æ—Ä–∏: <b id="nSect">0</b></span>
      <span class="badge">–û—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç: <b id="eff">‚Äî</b></span>
    </div>
    <div class="row">
      <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±—Ä–∏–≥–∞–¥ <input id="nCrews" class="input" type="number" step="1" value="3"></label>
      <label>–õ—ñ–º—ñ—Ç –∑–∞–≤–¥–∞–Ω—å/–¥–µ–Ω—å –Ω–∞ –±—Ä–∏–≥–∞–¥—É <input id="limDay" class="input" type="number" step="1" value="6"></label>
      <label>–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è (–¥–Ω—ñ–≤) <input id="hDays" class="input" type="number" step="1" value="7"></label>
      <label>–ó–Ω–∏–∂–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—É –Ω–∞ –≤—ñ–∑–∏—Ç, % <input id="dropPct" class="input" type="number" step="1" value="35"></label>
      <label>–ú–∞–∫—Å. –¥–æ–≤–∂–∏–Ω–∞ —Ä–µ–π—Å—É (–∫–º) <input id="maxKm" class="input" type="number" step="1" value="40"></label>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞: –Ω–∞–≤—á–∞–Ω–Ω—è/–ø—Ä–∞–≤–∏–ª–∞/–∫–∞—Ä—Ç–∞ -->
    <div class="card">
      <h2>üß† –ù–∞–≤—á–µ–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∏–∑–∏–∫—É</h2>
      <div class="row">
        <div class="tag bad">P(–∞–≤–∞—Ä—ñ—è) ‚àù –í—ñ–∫ –º–µ—Ä–µ–∂—ñ</div>
        <div class="tag warn">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/—Å–µ–∑–æ–Ω</div>
        <div class="tag ok">–û—Å—Ç–∞–Ω–Ω—ñ–π —Å–µ—Ä–≤—ñ—Å</div>
      </div>
      <table class="tbl" id="rulesTbl">
        <thead><tr><th>#</th><th>–ü—Ä–∞–≤–∏–ª–æ</th><th>–í–∞–≥–∞</th><th>–ü–æ–∫—Ä–∏—Ç—Ç—è</th><th>Œî–†–∏–∑–∏–∫—É</th></tr></thead>
        <tbody><tr><td colspan="5" class="muted">‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ù–∞–≤—á–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞¬ª ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üó∫Ô∏è –¢–µ–ø–ª–æ–≤–∞ –∫–∞—Ä—Ç–∞ —Ä–∏–∑–∏–∫—É (—Å–µ–∫—Ç–æ—Ä–∏ –º—ñ—Å—Ç–∞)</h3>
      <canvas id="map" class="map" width="820" height="360"></canvas>
      <small class="muted">–ü—ñ–¥–∫–∞–∑–∫–∞: –∫–ª–∞—Ü–Ω–∏ —Å–µ–∫—Ç–æ—Ä ‚Äî –¥–æ–¥–∞—Å—Ç—å—Å—è –≤ ¬´–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ¬ª –≤—Ä—É—á–Ω—É.</small>
    </div>

    <!-- –ü—Ä–∞–≤–∞: –ø–ª–∞–Ω/–º–∞—Ä—à—Ä—É—Ç–∏/–µ—Ñ–µ–∫—Ç -->
    <div class="card">
      <h2>üóìÔ∏è –ü–ª–∞–Ω —Ç–∏–∂–Ω—è / –º–∞—Ä—à—Ä—É—Ç–∏</h2>
      <table class="tbl" id="planTbl">
        <thead><tr><th>–î–µ–Ω—å</th><th>–ë—Ä–∏–≥–∞–¥–∞</th><th>–ú–∞—Ä—à—Ä—É—Ç (—Å–µ–∫—Ç–æ—Ä–∏ ‚Üí –∫–º)</th><th>–ó–∞–≤–¥–∞–Ω—å</th><th>–û—á—ñ–∫—É–≤–∞–Ω–µ Œî–†–∏–∑–∏–∫—É</th></tr></thead>
        <tbody><tr><td colspan="5" class="muted">‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–°–ø–ª–∞–Ω—É–≤–∞—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å¬ª ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üìà –û—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç (–∞–Ω—ñ–º.)</h3>
      <div class="progress"><span id="bar" style="width:0%"></span></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveCsv">üìÑ CSV (–ø–ª–∞–Ω)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º (–±—Ä–∏–≥–∞–¥–∞)</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–∞–ø–∫–∞ –∑ –ø–ª–∞–Ω–æ–º)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div style="margin-top:8px"><canvas id="qr" width="220" height="220" style="background:#0b1220;border:1px solid var(--line);border-radius:12px"></canvas></div>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–ó–∞–≤–∞–Ω—Ç–∞–∂ –≤–ª–∞—Å–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ (CSV) –∞–±–æ –∑–≥–µ–Ω–µ—Ä—É–π –ø—Ä–∏–∫–ª–∞–¥ —ñ –Ω–∞—Ç–∏—Å–Ω–∏ <b>¬´–ù–∞–≤—á–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞¬ª</b>. –Ø–∫—ñ 3 –ø—Ä–∞–≤–∏–ª–∞ –º–∞—é—Ç—å –Ω–∞–π–±—ñ–ª—å—à—É –≤–∞–≥—É?</li>
      <li>–ó–º—ñ–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (<b>–∫—ñ–ª—å–∫—ñ—Å—Ç—å –±—Ä–∏–≥–∞–¥</b>, <b>–ª—ñ–º—ñ—Ç –∑–∞–≤–¥–∞–Ω—å</b>, <b>–º–∞–∫—Å. –∫–º</b>) —ñ –ø–µ—Ä–µ—Ä–∞—Ö—É–π –ø–ª–∞–Ω. –Ø–∫ —Ü–µ –≤–ø–ª–∏–Ω—É–ª–æ –Ω–∞ –æ—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç?</li>
      <li>–ö–ª—ñ–∫–Ω–∏ 2‚Äì3 ¬´—Å–∫–ª–∞–¥–Ω–∏—Ö¬ª —Å–µ–∫—Ç–æ—Ä–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –¥–æ–¥–∞—Ç–∏ —ó—Ö –≤ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç. –ü–µ—Ä–µ–±—É–¥—É–π –ø–ª–∞–Ω —Ç–∞ –ø–æ—Ä—ñ–≤–Ω—è–π –º–∞—Ä—à—Ä—É—Ç–∏.</li>
      <li>–ó–±–µ—Ä–µ–∂–∏ CSV/TXT, –Ω–∞–¥—Ä—É–∫—É–π —á–µ–∫ 58 –º–º –¥–ª—è –æ–¥–Ω—ñ—î—ó –±—Ä–∏–≥–∞–¥–∏, –∑–≥–µ–Ω–µ—Ä—É–π QR –Ω–∞ –ø–∞–ø–∫—É –∑ –ø–ª–∞–Ω–æ–º —ñ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞–º–∏ –∫–∞—Ä—Ç–∏.</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫. <span class="muted">–ö–ª–∞–≤—ñ—à—ñ: <kbd>T</kbd> ‚Äî –Ω–∞–≤—á–∏—Ç–∏, <kbd>P</kbd> ‚Äî –ø–ª–∞–Ω—É–≤–∞—Ç–∏.</span>
  </div>
</div>

<script>
/* ====== –£—Ç–∏–ª—ñ—Ç–∏/UI ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

/* ====== –î–∞–Ω—ñ/—Å—Ç–∞–Ω ====== */
let HIST=[]; // —ñ—Å—Ç–æ—Ä—ñ—è —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤: {ts, sector, age, soil, temp, season, service_days, leak, cost}
let SECTORS=[]; // {id,x,y,baseRisk}
let RULES=[]; // {text,weight,cover,delta}
let PRIORITY_SET=new Set(); // –≤—Ä—É—á–Ω—É –¥–æ–¥–∞–Ω—ñ –ø—Ä—ñ–æ—Ä–∏—Ç–Ω—ñ
let PLAN=[]; // –∑–∞–ø–∏—Å–∏ –ø–ª–∞–Ω—É –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ

/* ====== –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ–∫—Ç–æ—Ä—ñ–≤ (—à—Ç—É—á–Ω–µ –º—ñ—Å—Ç–æ 6x4) ====== */
const map=$('#map'), gm=map.getContext('2d');
const GRID_W=6, GRID_H=4;
function initSectors(){
  SECTORS=[];
  const cellW=map.width/(GRID_W+1), cellH=map.height/(GRID_H+1);
  let id=1;
  for(let r=0;r<GRID_H;r++){
    for(let c=0;c<GRID_W;c++){
      const x=Math.round((c+1)*cellW), y=Math.round((r+1)*cellH);
      const base = 10 + Math.round(Math.random()*30);
      SECTORS.push({id, x, y, baseRisk:base});
      id++;
    }
  }
}
initSectors();

/* ====== –ú–∞–ª—é–≤–∞–Ω–Ω—è –º–∞–ø–∏/heatmap ====== */
function riskColor(val){
  // 0..100 -> –∑–µ–ª–µ–Ω–∏–π..—á–µ—Ä–≤–æ–Ω–∏–π
  const r=Math.min(255, Math.round(2.55*val));
  const g=Math.min(255, Math.round(2.55*(100-val)));
  return `rgb(${r},${g},80)`;
}
function drawMap(highlight=[]){
  gm.clearRect(0,0,map.width,map.height);
  gm.strokeStyle='#223049'; gm.strokeRect(0.5,0.5,map.width-1,map.height-1);
  // –ª—ñ–Ω—ñ—ó —Å—ñ—Ç–∫–∏
  gm.strokeStyle='#1f2a44';
  for(let r=1;r<=GRID_H;r++){ const y=Math.round(r*map.height/(GRID_H+1)); gm.beginPath(); gm.moveTo(20,y); gm.lineTo(map.width-20,y); gm.stroke(); }
  for(let c=1;c<=GRID_W;c++){ const x=Math.round(c*map.width/(GRID_W+1)); gm.beginPath(); gm.moveTo(x,20); gm.lineTo(x,map.height-20); gm.stroke(); }

  // –∫–≤–∞–¥—Ä–∞—Ç–∏ —Å–µ–∫—Ç–æ—Ä—ñ–≤
  const size=40;
  SECTORS.forEach(s=>{
    const risk = currentRiskForSector(s.id);
    gm.fillStyle=riskColor(Math.min(100,Math.max(0,Math.round(risk))));
    gm.fillRect(s.x-size/2, s.y-size/2, size, size);
    // —Ä–∞–º–∫–∞/–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
    if(PRIORITY_SET.has(s.id) || highlight.includes(s.id)){
      gm.strokeStyle='#e5e7eb'; gm.lineWidth=2; gm.strokeRect(s.x-size/2-2, s.y-size/2-2, size+4, size+4);
    }
    // —Ç–µ–∫—Å—Ç
    gm.fillStyle='#0b1220'; gm.font='11px ui-monospace';
    gm.fillText('S'+s.id, s.x-12, s.y+4);
  });
}
map.addEventListener('click', e=>{
  const r=map.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const hit = SECTORS.find(s=> Math.abs(s.x-x)<=20 && Math.abs(s.y-y)<=20 );
  if(hit){ if(PRIORITY_SET.has(hit.id)) PRIORITY_SET.delete(hit.id); else PRIORITY_SET.add(hit.id); drawMap([hit.id]); log(`–°–µ–∫—Ç–æ—Ä S${hit.id} ${PRIORITY_SET.has(hit.id)?'–¥–æ–¥–∞–Ω–æ –≤ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç':'–∑–Ω—è—Ç–æ –∑ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É'}`); }
});

/* ====== –í–≤—ñ–¥ CSV –∞–±–æ –ø—Ä–∏–∫–ª–∞–¥–∏ ====== */
$('#file').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const text = await f.text();
  HIST = parseCSV(text);
  afterHistLoaded();
  log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ CSV: ${f.name}, —Ä—è–¥–∫—ñ–≤: ${HIST.length}`);
});
$('#ex').addEventListener('click', ()=>{
  HIST = synthHistory(200);
  afterHistLoaded();
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ 200 –ø—Ä–∏–∫–ª–∞–¥–Ω–∏—Ö —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤');
});
function afterHistLoaded(){
  $('#nRec').textContent=String(HIST.length);
  const sectIds=[...new Set(HIST.map(h=>h.sector))]; $('#nSect').textContent=String(sectIds.length);
  drawMap();
}

/* ====== CSV –ø–∞—Ä—Å–µ—Ä/—Å–∏–Ω—Ç–µ–∑–∞ ====== */
function parseCSV(t){
  const lines=t.split(/\r?\n/).filter(Boolean);
  const head=lines.shift().split(',').map(s=>s.trim());
  const idx=(k)=>head.indexOf(k);
  const res=[];
  lines.forEach(line=>{
    const parts=line.split(','); // –ø—Ä–æ—Å—Ç–∏–π CSV (–±–µ–∑ –∫–æ–º)
    res.push({
      ts: parts[idx('ts')]||'',
      sector: +parts[idx('sector')]||1,
      age: +parts[idx('age')],
      soil: parts[idx('soil')]||'loam',
      temp: +parts[idx('temp')],
      season: parts[idx('season')]||'winter',
      service_days: +parts[idx('service_days')],
      leak: +(parts[idx('leak')]||0),
      cost: +(parts[idx('cost')]||0)
    });
  });
  return res;
}
function synthHistory(n){
  const soils=['loam','sand','clay']; const seasons=['winter','spring','summer','autumn'];
  const arr=[];
  for(let i=0;i<n;i++){
    const sector = 1 + Math.floor(Math.random()*(GRID_W*GRID_H));
    const age = 5 + Math.floor(Math.random()*55); // —Ä–æ–∫—ñ–≤
    const soil = soils[Math.floor(Math.random()*soils.length)];
    const temp = -15 + Math.floor(Math.random()*50);
    const season = seasons[Math.floor(Math.random()*seasons.length)];
    const service_days = Math.floor(Math.random()*720); // –¥–Ω—ñ–≤ –≤—ñ–¥ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É
    // –±–∞–∑–æ–≤–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –≤–∏—Ç–æ–∫—É
    let p=0.02 + age*0.002 + (service_days>365?0.04:0) + (soil==='clay'?0.02:soil==='sand'?0.01:0);
    p += (temp<-5?0.03:temp>30?0.01:0) + (season==='winter'?0.02:0);
    if(Math.random()<0.15) p+=0.05; // –ª–∞—Ç–µ–Ω—Ç–Ω—ñ —Ñ–∞–∫—Ç–æ—Ä–∏
    const leak = Math.random()<p?1:0;
    const cost = leak? (200+Math.random()*800): 0;
    const day = 1+Math.floor(Math.random()*28);
    const month= 1+Math.floor(Math.random()*12);
    const ts = `2025-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')} ${String(8+Math.floor(Math.random()*10)).padStart(2,'0')}:${String(Math.floor(Math.random()*60)).padStart(2,'0')}`;
    arr.push({ts, sector, age, soil, temp, season, service_days, leak, cost});
  }
  return arr;
}

/* ====== –ù–∞–≤—á–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–∏—Ö –ø—Ä–∞–≤–∏–ª ======
  - –ë—ñ–Ω–Ω—ñ–Ω–≥ —á–∏—Å–ª–æ–≤–∏—Ö –æ–∑–Ω–∞–∫ (age, temp, service_days) —É –∫–≤–∞–Ω—Ç—ñ–ª—ñ
  - –í–∞–≥–∞ = log-odds (–π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –≤–∏—Ç–æ–∫—É —É –ø—ñ–¥–º–Ω–æ–∂–∏–Ω—ñ vs –∑–∞–≥–∞–ª—å–Ω–∞)
  - –ü—ñ–¥–±—ñ—Ä —Ç–æ–ø-–ø—Ä–∞–≤–∏–ª –∑–∞ Œî–†–∏–∑–∏–∫—É * –ø–æ–∫—Ä–∏—Ç—Ç—è
*/
function quantiles(arr, qs){ const a=arr.slice().sort((x,y)=>x-y); return qs.map(q=>a[Math.floor(q*(a.length-1))]); }
function binEdges(values){ const qs=quantiles(values,[0.2,0.4,0.6,0.8]); return [...new Set(qs)]; }
function ruleWeight(mask){
  const total=HIST.length, pos=HIST.filter(h=>h.leak).length;
  const sub=HIST.filter(mask), subPos=sub.filter(h=>h.leak).length;
  if(sub.length<8) return null;
  const pAll= (pos+1)/(total+2), pSub=(subPos+1)/(sub.length+2);
  const w = Math.log(pSub/(1-pSub)) - Math.log(pAll/(1-pAll));
  const delta=(pSub - pAll)*100; // —É –≤—ñ–¥—Å–æ—Ç–∫–æ–≤–∏—Ö –ø—É–Ω–∫—Ç–∞—Ö
  return {w, cover:sub.length, delta};
}
function trainRules(){
  if(HIST.length===0){ alert('–ù–µ–º–∞—î —ñ—Å—Ç–æ—Ä—ñ—ó'); return; }
  RULES=[];
  // –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
  const soils=[...new Set(HIST.map(h=>h.soil))];
  const seasons=[...new Set(HIST.map(h=>h.season))];
  // –±—ñ–Ω–Ω—ñ–Ω–≥
  const eAge=binEdges(HIST.map(h=>h.age));
  const eTemp=binEdges(HIST.map(h=>h.temp));
  const eServ=binEdges(HIST.map(h=>h.service_days));
  const bins=(edges,val)=>{ let k=0; while(k<edges.length && val>edges[k]) k++; return k; };

  // –∫–∞–Ω–¥–∏–¥–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª
  const cand=[];
  soils.forEach(s=>{
    const r=ruleWeight(h=>h.soil===s); if(r) cand.push({text:`SOIL=${s}`,...r});
  });
  seasons.forEach(s=>{
    const r=ruleWeight(h=>h.season===s); if(r) cand.push({text:`SEASON=${s}`,...r});
  });
  // —á–∏—Å–ª–æ–≤—ñ –±—ñ–Ω–æ–≤—ñ
  for(let i=0;i<eAge.length;i++){
    const r=ruleWeight(h=>bins(eAge,h.age)>=i); if(r) cand.push({text:`AGE‚â•Q${i+1} (${eAge[i]}+)`,...r});
  }
  for(let i=0;i<eTemp.length;i++){
    const r=ruleWeight(h=>bins(eTemp,h.temp)<=i); if(r) cand.push({text:`TEMP‚â§Q${i+1} (${eTemp[i]}-)`,...r});
  }
  for(let i=0;i<eServ.length;i++){
    const r=ruleWeight(h=>bins(eServ,h.service_days)>=i); if(r) cand.push({text:`SERVICE GAP‚â•Q${i+1} (${eServ[i]}–¥+)`,...r});
  }

  // –≤—ñ–¥—Å–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—é
  cand.sort((a,b)=> (b.delta*Math.abs(b.w))*b.cover - (a.delta*Math.abs(a.w))*a.cover );
  RULES = cand.slice(0,12);
  renderRules();
  drawMap();
  log(`–ù–∞–≤—á–µ–Ω–æ –ø—Ä–∞–≤–∏–ª: ${RULES.length}`);
}
$('#train').addEventListener('click', trainRules);
document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='t') trainRules(); });

function renderRules(){
  const tb=$('#rulesTbl tbody'); tb.innerHTML='';
  RULES.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const w = r.w.toFixed(2), cov=r.cover, d=(r.delta>=0?'+':'')+r.delta.toFixed(1)+' –ø.–ø.';
    tr.innerHTML=`<td>${i+1}</td><td>${r.text}</td><td>${w}</td><td>${cov}</td><td class="${r.delta>0?'bad':r.delta<0?'ok':'warn'}"><b>${d}</b></td>`;
    tb.appendChild(tr);
  });
}

/* ====== –û—Ü—ñ–Ω–∫–∞ —Ä–∏–∑–∏–∫—É —Å–µ–∫—Ç–æ—Ä–∞ ====== */
function currentRiskForSector(sectorId){
  const base = (SECTORS.find(s=>s.id===sectorId)?.baseRisk)||20;
  // —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è –æ–∑–Ω–∞–∫ –ø–æ —Å–µ–∫—Ç–æ—Ä—É –∑ HIST (–∞–±–æ —Å–∏–Ω—Ç–µ—Ç–∏–∫–∞)
  const sub = HIST.filter(h=>h.sector===sectorId);
  if(sub.length===0) return base;
  const avgAge = sub.reduce((a,b)=>a+b.age,0)/sub.length;
  const avgServ = sub.reduce((a,b)=>a+b.service_days,0)/sub.length;
  const freqLeak = sub.filter(h=>h.leak).length/sub.length;
  // –∑–∞—Å—Ç–æ—Å—É—î–º–æ –≤–∞–≥–∏ –ø—Ä–∞–≤–∏–ª —è–∫ –±–æ–Ω—É—Å/—à—Ç—Ä–∞—Ñ
  let adj=0;
  RULES.forEach(r=>{
    if(r.text.startsWith('AGE') && /(\d+)/.test(r.text)){ const t=parseInt(r.text.match(/(\d+)/)[1]); if(avgAge>=t) adj+= r.w*3; }
    if(r.text.startsWith('SERVICE GAP') && /(\d+)/.test(r.text)){ const t=parseInt(r.text.match(/(\d+)/)[1]); if(avgServ>=t) adj+= r.w*2.5; }
    if(r.text.startsWith('TEMP') ){ /* —Å–µ–∑–æ–Ω/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –±–µ—Ä–µ–º–æ –∑ —á–∞—Å—Ç–æ—Ç–∏ –≤–∏—Ç–æ–∫—ñ–≤ */ adj+= r.w* (freqLeak>0.1?2:0.5); }
    if(r.text.startsWith('SOIL=')){ const soil=r.text.split('=')[1]; const share=sub.filter(h=>h.soil===soil).length/sub.length; adj+= r.w*share*2; }
    if(r.text.startsWith('SEASON=')){ const season=r.text.split('=')[1]; const share=sub.filter(h=>h.season===season).length/sub.length; adj+= r.w*share; }
  });
  const risk = Math.max(0, Math.min(100, base + adj*8 + freqLeak*100*0.2));
  return risk;
}

/* ====== –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Ç–∏–∂–Ω—è ======
   1) –°–æ—Ä—Ç—É—î–º–æ —Å–µ–∫—Ç–æ—Ä–∏ –∑–∞ —Ä–∏–∑–∏–∫–æ–º (—ñ –≤—Ä—É—á–Ω—É –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ ‚Äî –≤–∏—â–µ)
   2) –†–æ–∑–∫–ª–∞–¥–∞—î–º–æ –ø–æ –¥–Ω—è—Ö —ñ –±—Ä–∏–≥–∞–¥–∞—Ö, –æ–±–º–µ–∂—É—é—á–∏ –∑–∞–≤–¥–∞–Ω–Ω—è/–¥–µ–Ω—å
   3) –ë—É–¥—É—î–º–æ –º–∞—Ä—à—Ä—É—Ç ¬´–Ω–∞–π–±–ª–∏–∂—á–∏–π —Å—É—Å—ñ–¥¬ª –∑ –ø—Å–µ–≤–¥–æ–≤—ñ–¥—Å—Ç–∞–Ω—è–º–∏ –º—ñ–∂ —Ü–µ–Ω—Ç—Ä–∞–º–∏ —Å–µ–∫—Ç–æ—Ä—ñ–≤
   4) –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –æ—á—ñ–∫—É–≤–∞–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—É = dropPct% * risk –¥–ª—è –≤—ñ–¥–≤—ñ–¥–∞–Ω–∏—Ö —Å–µ–∫—Ç–æ—Ä—ñ–≤
*/
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y)/10; } // —É–º–æ–≤–Ω—ñ –∫–º
function planWeek(){
  if(RULES.length===0) trainRules();
  const nCrews=Math.max(1, parseInt($('#nCrews').value)||3);
  const limDay=Math.max(1, parseInt($('#limDay').value)||6);
  const hDays=Math.max(1, parseInt($('#hDays').value)||7);
  const maxKm=Math.max(5, parseFloat($('#maxKm').value)||40);
  const dropPct=Math.max(0, Math.min(100, parseFloat($('#dropPct').value)||35));

  // —Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è —Å–µ–∫—Ç–æ—Ä—ñ–≤
  const ranked = SECTORS.map(s=>({s, risk: currentRiskForSector(s.id), prio: PRIORITY_SET.has(s.id)?1:0}))
                        .sort((a,b)=> (b.prio - a.prio) || (b.risk - a.risk));
  // –ø–æ—Ä–æ–∂–Ω—ñ–π –ø–ª–∞–Ω
  PLAN=[];
  let totalDrop=0;

  for(let d=0; d<hDays; d++){
    for(let c=0; c<nCrews; c++){
      // –ø—ñ–¥–±–∏—Ä–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ ranked (—â–µ –Ω–µ –≤—ñ–¥–≤—ñ–¥–∞–Ω—ñ)
      const route=[]; let km=0; let tasks=0;
      // –ø–æ—á–∞—Ç–∫–æ–≤–∞ —Ç–æ—á–∫–∞ ‚Äî –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –î–ï–ü–û —É —Ü–µ–Ω—Ç—Ä—ñ –ø–æ–ª–æ—Ç–Ω–∞
      let cur={x:map.width/2, y:map.height/2};

      while(tasks<limDay){
        const candidate = ranked.find(rc=> !rc.taken && (route.length===0 || dist(cur, rc.s)<8) );
        if(!candidate) break;
        const addKm = dist(cur, candidate.s);
        if(km+addKm>maxKm) break;
        route.push(candidate.s.id); candidate.taken=true; km+=addKm; cur=candidate.s; tasks++;
      }
      if(route.length>0){
        const drop = route.reduce((acc,id)=> acc + currentRiskForSector(id)*(dropPct/100), 0);
        totalDrop += drop;
        PLAN.push({day:d+1, crew:c+1, route, km:km.toFixed(1), tasks:route.length, drop:Math.round(drop)});
      }
    }
  }
  renderPlan();
  drawMap();
  animateEffect(totalDrop);
  log(`–°—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ –ø–ª–∞–Ω: –∑–∞–ø–∏—Å—ñ–≤ ${PLAN.length}, –æ—á—ñ–∫—É–≤–∞–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—É ‚âà ${Math.round(totalDrop)}`);
}
$('#plan').addEventListener('click', planWeek);
document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='p') planWeek(); });

function renderPlan(){
  const tb=$('#planTbl tbody'); tb.innerHTML='';
  PLAN.forEach(p=>{
    const sectors=p.route.map(id=>'S'+id).join(' ‚Üí ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>–î–µ–Ω—å ${p.day}</td><td>–ë—Ä–∏–≥–∞–¥–∞ ${p.crew}</td><td>${sectors} ¬∑ ${p.km} –∫–º</td><td>${p.tasks}</td><td class="ok"><b>‚àí${p.drop}</b></td>`;
    tb.appendChild(tr);
  });
  const eff = PLAN.reduce((a,b)=>a+b.drop,0);
  $('#eff').textContent = `‚àí${eff}`;
}

function animateEffect(val){
  const bar=$('#bar'); let t=0, target=Math.max(0,Math.min(100, Math.round(val/ (SECTORS.length*100) * 100)));
  clearInterval(bar._timer);
  bar._timer=setInterval(()=>{ t++; bar.style.width=Math.min(t,target)+'%'; if(t>=target) clearInterval(bar._timer); }, 12);
}

/* ====== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR ====== */
$('#saveCsv').addEventListener('click', ()=>{
  let csv='day,crew,route,km,tasks,drop\n';
  PLAN.forEach(p=>{ csv+=`${p.day},${p.crew},"${p.route.join('-')}",${p.km},${p.tasks},${p.drop}\n`; });
  download('gas_para25_plan_'+stamp()+'.csv', csv, 'text/csv'); log('CSV (–ø–ª–∞–Ω) –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click', ()=>{
  const eff=PLAN.reduce((a,b)=>a+b.drop,0);
  const lines=[
    '–ü–∞—Ä–∞ 25 ‚Äî AI-–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –ø—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∏: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ë—Ä–∏–≥–∞–¥: ${$('#nCrews').value}, –õ—ñ–º—ñ—Ç/–¥–µ–Ω—å: ${$('#limDay').value}, –ì–æ—Ä–∏–∑–æ–Ω—Ç: ${$('#hDays').value}`,
    `–û—á—ñ–∫—É–≤–∞–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Å—É–º–∞—Ä–Ω–æ–≥–æ —Ä–∏–∑–∏–∫—É: ‚àí${eff}`,
    '',
    ...PLAN.map(p=>`–î–µ–Ω—å ${p.day} ‚Ä¢ –ë—Ä-${p.crew} ‚Ä¢ ${p.route.map(id=>'S'+id).join(' ‚Üí ')} ‚Ä¢ ${p.km} –∫–º ‚Ä¢ –∑–∞–≤–¥–∞–Ω—å ${p.tasks} ‚Ä¢ Œî‚àí${p.drop}`)
  ];
  download('gas_para25_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#print58').addEventListener('click', ()=>{
  if(PLAN.length===0){ alert('–ù–µ–º–∞—î –ø–ª–∞–Ω—É'); return; }
  const p=PLAN[0]; // –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É ‚Äî –ø–µ—Ä—à–∏–π –º–∞—Ä—à—Ä—É—Ç
  const rc=$('#rc'); rc.hidden=false;
  const lines=[
'=== PREVENTIVE PLAN (58–º–º) ===',
`–î–µ–Ω—å: ${p.day}  –ë—Ä–∏–≥–∞–¥–∞: ${p.crew}`,
`–õ—ñ–º—ñ—Ç/–¥–µ–Ω—å: ${$('#limDay').value}  –ì–æ—Ä: ${$('#hDays').value}`,
`–ú–∞—Ä—à—Ä—É—Ç:`,
...p.route.map(id=>('S'+id)).slice(0,6),
`~${p.km} –∫–º`,
`–û—á—ñ–∫. Œî—Ä–∏–∑–∏–∫—É: -${p.drop}`,
'------------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para25_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ß–µ–∫ 58 –º–º –∑–±–µ—Ä–µ–∂–µ–Ω–æ (–ø–µ—Ä—à–∏–π –º–∞—Ä—à—Ä—É—Ç)');
});
$('#qrGen').addEventListener('click', ()=>{
  const data=prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –ø–ª–∞–Ω–æ–º/–∫–∞—Ä—Ç–∞–º–∏):', 'https://');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const imgQ=new Image(); imgQ.crossOrigin='anonymous';
  imgQ.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(imgQ,0,0,220,220); };
  imgQ.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  imgQ.src=url;
  log('QR –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ');
});

/* ====== –°–∫–∏–¥–∞–Ω–Ω—è ====== */
$('#reset').addEventListener('click', ()=>{
  HIST=[]; RULES=[]; PLAN=[]; PRIORITY_SET.clear(); initSectors(); drawMap();
  $('#nRec').textContent='0'; $('#nSect').textContent='0'; $('#eff').textContent='‚Äî';
  $('#rulesTbl tbody').innerHTML='<tr><td colspan="5" class="muted">‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ù–∞–≤—á–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞¬ª ‚Äî</td></tr>';
  $('#planTbl tbody').innerHTML='<tr><td colspan="5" class="muted">‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–°–ø–ª–∞–Ω—É–≤–∞—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å¬ª ‚Äî</td></tr>';
  $('#rc').hidden=true; $('#qr').getContext('2d').clearRect(0,0,220,220);
  animateEffect(0);
  log('–°–∫–∏–Ω—É—Ç–æ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É');
});

/* ====== –ü–æ—á–∞—Ç–∫–æ–≤–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ====== */
drawMap();
</script>
</body>
</html>
