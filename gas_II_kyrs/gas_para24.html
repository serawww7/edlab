<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 24 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî AI-–¥–∏—Å–ø–µ—Ç—á–µ—Ä: —Ä–æ–∑–ø–æ–¥—ñ–ª –≤–∏–∫–ª–∏–∫—ñ–≤, ETA, —á–µ—Ä–≥–∏, —Å–∏–º—É–ª—è—Ç–æ—Ä –∑–∞—Ç—Ä–∏–º–æ–∫</title>
<meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä: –º–∞–ø–∞-–≥—Ä–∞—Ñ, P1/P2/P3 –≤–∏–∫–ª–∏–∫–∏, –∞–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ –±—Ä–∏–≥–∞–¥–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º ETA/—á–µ—Ä–≥–∏, —Å–∏–º—É–ª—è—Ç–æ—Ä —Ä—É—Ö—É, SLA, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.3fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:#94a3b8}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.map{display:block;width:100%;height:420px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
pre.log{max-height:220px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üó∫Ô∏èüöê</span>
      <div>
        <b>–ü–∞—Ä–∞ 24 ‚Äî AI-–¥–∏—Å–ø–µ—Ç—á–µ—Ä</b><br/>
        <span class="badge">P1/P2/P3 ‚Üí –∞–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ETA/—á–µ—Ä–≥–∏ ‚Üí —Å–∏–º—É–ª—è—Ü—ñ—è —Ä—É—Ö—É ‚Üí SLA ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ú—ñ—Å—Ç–æ –∑–º–æ–¥–µ–ª—å–æ–≤–∞–Ω–µ —è–∫ <b>–≥—Ä–∞—Ñ</b> –≤—É–∑–ª—ñ–≤/–¥–æ—Ä—ñ–≥. –î–æ–¥–∞–≤–∞–π –≤–∏–∫–ª–∏–∫–∏ (–∞–¥—Ä–µ—Å–Ω—ñ –≤—É–∑–ª–∏), –∑–∞–ø—É—Å–∫–∞–π <b>–ê–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</b>: –∞–ª–≥–æ—Ä–∏—Ç–º –º—ñ–Ω—ñ–º—ñ–∑—É—î <b>–æ—á—ñ–∫—É–≤–∞–Ω–Ω—è</b> –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º <b>–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É</b> —ñ –≤–∂–µ –≤–∑—è—Ç–∏—Ö –∑–∞–≤–¥–∞–Ω—å —É —á–µ—Ä–∑—ñ –±—Ä–∏–≥–∞–¥–∏. –ü—ñ—Å–ª—è ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ <b>–°—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü—ñ—ó</b> —ñ —Å–ª—ñ–¥–∫—É–π –∑–∞ ETA, —á–µ—Ä–≥–∞–º–∏ —ñ <b>SLA</b> (P1‚â§15 —Ö–≤, P2‚â§60 —Ö–≤, P3‚â§180 —Ö–≤).</p>
    <div class="row">
      <label>–í—É–∑–æ–ª –∞–¥—Ä–µ—Å–∏
        <select id="node" class="input"></select>
      </label>
      <label>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
        <select id="prio" class="input">
          <option value="P1">P1 (–∞–≤–∞—Ä—ñ—è)</option>
          <option value="P2" selected>P2 (—Ç–µ—Ä–º—ñ–Ω–æ–≤–æ)</option>
          <option value="P3">P3 (–ø–ª–∞–Ω–æ–≤–æ)</option>
        </select>
      </label>
      <label>–û—Ä—ñ—î–Ω—Ç. —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ä–æ–±—ñ—Ç, —Ö–≤ <input id="dur" class="input" type="number" step="5" value="30"></label>
      <button class="btn" id="addCall">‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏–∫–ª–∏–∫</button>
      <button class="btn secondary" id="randomCall">üé≤ –†–∞–Ω–¥–æ–º (√ó3)</button>
      <span class="badge">–£ —á–µ—Ä–∑—ñ –≤–∏–∫–ª–∏–∫—ñ–≤: <b id="qCalls">0</b></span>
    </div>
    <div class="row">
      <button class="btn good" id="assign">ü§ñ –ê–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</button>
      <button class="btn" id="start">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü—ñ—ó</button>
      <button class="btn secondary" id="pause">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
      <button class="btn secondary" id="reset">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
      <label>–°–µ—Ä–µ–¥–Ω—è —à–≤–∏–¥–∫—ñ—Å—Ç—å, –∫–º/–≥–æ–¥ <input id="speed" class="input" type="number" step="5" value="30"></label>
      <label>–î–æ–¥. –∑–∞—Ç—Ä–∏–º–∫–∞ (0‚Äì1) <input id="delay" class="input" type="number" step="0.05" value="0.15"><small class="muted">–π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö –∑–∞—Ç—Ä–∏–º–æ–∫</small></label>
      <span class="badge">SLA: <b id="sla">‚Äî</b></span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üó∫Ô∏è –ú–∞–ø–∞-–≥—Ä–∞—Ñ, –±—Ä–∏–≥–∞–¥–∏ —Ç–∞ –≤–∏–∫–ª–∏–∫–∏</h2>
      <canvas id="map" class="map" width="860" height="420"></canvas>
      <small class="muted">–ü—ñ–¥–∫–∞–∑–∫–∞: –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –±—Ä–∏–≥–∞–¥—É –º–∏—à–∫–æ—é –Ω–∞ —ñ–Ω—à–∏–π –≤—É–∑–æ–ª –ø–µ—Ä–µ–¥ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º (–º–∞–Ω–µ–≤—Ä –ø–µ—Ä–µ–∫—Ä–∏—Ç—Ç—è —Ä–∞–π–æ–Ω—É).</small>

      <h3 style="margin-top:10px">üìà –ß–µ—Ä–≥–∏ –±—Ä–∏–≥–∞–¥ / –≤–∏–∫–æ–Ω–∞–Ω–Ω—è</h3>
      <canvas id="chart" class="chart" width="520" height="220"></canvas>
    </div>

    <div class="card">
      <h2>üë• –ë—Ä–∏–≥–∞–¥–∏ —Ç–∞ –≤–∏–∫–ª–∏–∫–∏</h2>
      <table class="tbl">
        <thead><tr><th>#</th><th>–ë—Ä–∏–≥–∞–¥–∞</th><th>–ü–æ–∑–∏—Ü—ñ—è</th><th>–ß–µ—Ä–≥–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
        <tbody id="crewTbl"><tr><td colspan="5" class="muted">‚Äî —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üìã –í–∏–∫–ª–∏–∫–∏ (–æ—á—ñ–∫—É—é—Ç—å/–≤ —Ä–æ–±–æ—Ç—ñ/–∑–∞–≤–µ—Ä—à–µ–Ω—ñ)</h3>
      <table class="tbl">
        <thead><tr><th>#</th><th>–ê–¥—Ä–µ—Å–∞</th><th>–ü—Ä—ñ–æ—Ä</th><th>ETA, —Ö–≤</th><th>–ë—Ä–∏–≥–∞–¥–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
        <tbody id="callTbl"><tr><td colspan="6" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (—Ç–∞–π–º–ª–∞–π–Ω)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–°—Ç–≤–æ—Ä–∏ 8‚Äì12 –≤–∏–∫–ª–∏–∫—ñ–≤ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤; –ø–æ—Ä—ñ–≤–Ω—è–π –∞–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ —à–≤–∏–¥–∫–æ—Å—Ç—ñ 30/50 –∫–º/–≥–æ–¥.</li>
      <li>–ó–±—ñ–ª—å—à –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –∑–∞—Ç—Ä–∏–º–æ–∫ –¥–æ 0.4 ‚Äî —è–∫ –∑–º—ñ–Ω–∏—Ç—å—Å—è %SLA –¥–ª—è P1/P2/P3?</li>
      <li>–ü–µ—Ä–µ—Ç—è–≥–Ω–∏ –æ–¥–Ω—É –±—Ä–∏–≥–∞–¥—É –Ω–∞ —ñ–Ω—à–∏–π –≤—É–∑–æ–ª –ø–µ—Ä–µ–¥ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º: —á–∏ –∑–º–µ–Ω—à–∏—Ç—å—Å—è —Å–µ—Ä–µ–¥–Ω—ñ–π ETA?</li>
      <li>–ó–∞–ø—É—Å—Ç–∏ —Å–∏–º—É–ª—è—Ü—ñ—é —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT –¥–ª—è –∑–≤—ñ—Ç—É (–≤–∏—Å–Ω–æ–≤–∫–∏, –¥–µ –≤—É–∑—å–∫—ñ –º—ñ—Å—Ü—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó).</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫. <span class="muted">–ö–ª–∞–≤—ñ—à—ñ: <kbd>A</kbd> ‚Äî –∞–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è, <kbd>Space</kbd> ‚Äî —Å—Ç–∞—Ä—Ç/–ø–∞—É–∑–∞.</span>
  </div>
</div>

<script>
/* ========= –£—Ç–∏–ª—ñ—Ç–∏/UI ========= */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');

/* ========= –ú–æ–¥–µ–ª—å –º—ñ—Å—Ç–∞ —è–∫ –≥—Ä–∞—Ñ =========
 –í—É–∑–ª–∏ –∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (–ø—Å–µ–≤–¥–æ-—Ä–∞–π–æ–Ω–∏), –¥–æ—Ä–æ–≥–∏ (–Ω–µ–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω—ñ) –∑ –¥–æ–≤–∂–∏–Ω–∞–º–∏ –≤ –∫–º.
*/
const NODES = {
  A:{x:80,y:60, name:'A ‚Ä¢ –î–ï–ü–û'},
  B:{x:200,y:60, name:'B'},
  C:{x:340,y:70, name:'C'},
  D:{x:480,y:60, name:'D'},
  E:{x:620,y:80, name:'E'},
  F:{x:760,y:60, name:'F'},
  G:{x:120,y:180, name:'G'},
  H:{x:280,y:180, name:'H'},
  I:{x:440,y:180, name:'I'},
  J:{x:600,y:180, name:'J'},
  K:{x:760,y:200, name:'K'},
  L:{x:160,y:320, name:'L'},
  M:{x:320,y:320, name:'M'},
  N:{x:520,y:320, name:'N'},
  O:{x:720,y:320, name:'O'}
};
const EDGES = [
 ['A','B',3],['B','C',2],['C','D',2],['D','E',2.5],['E','F',3],
 ['A','G',2.5],['B','H',2.5],['C','I',2.5],['D','J',2.5],['E','K',3],
 ['G','H',2],['H','I',2],['I','J',2],['J','K',2.5],
 ['G','L',2.5],['H','M',2.5],['I','N',2.5],['J','O',2.5],
 ['L','M',2],['M','N',2],['N','O',2.2],
 ['B','G',2.2],['C','H',2.0],['D','I',2.0],['E','J',2.0]
];
const NEI={}; EDGES.forEach(([u,v,d])=>{ (NEI[u]??=[]).push([v,d]); (NEI[v]??=[]).push([u,d]); });

/* ========= –°—Ç–∞–Ω —Å–∏–º—É–ª—è—Ü—ñ—ó ========= */
let CREWS=[
  {id:1, name:'–ê–≤–∞—Ä—ñ–π–Ω–∞-1', node:'A', q:[], busy:false, progress:null, color:'#38bdf8'},
  {id:2, name:'–ê–≤–∞—Ä—ñ–π–Ω–∞-2', node:'D', q:[], busy:false, progress:null, color:'#22c55e'},
  {id:3, name:'–ê–≤–∞—Ä—ñ–π–Ω–∞-3', node:'J', q:[], busy:false, progress:null, color:'#fbbf24'}
];
let CALLS=[]; // {id,node,prio,dur,status:'new'|'assigned'|'enroute'|'work'|'done', crewId:null, eta:null, tCreate: nowMin, tArr:null, tDone:null}
let NOW_MIN=0; // —Ö–≤–∏–ª–∏–Ω–∏ –≤—ñ–¥ —Å—Ç–∞—Ä—Ç—É —Å–∏–º—É–ª—è—Ü—ñ—ó
let RUN=false;
let TL=[];    // —Ç–∞–π–º–ª–∞–π–Ω –ø–æ–¥—ñ–π –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É

/* ========= –î–æ–ø–æ–º—ñ–∂–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ–∞ ========= */
function dijkstra(start){
  const dist={}, prev={}, Q=new Set(Object.keys(NODES));
  Object.keys(NODES).forEach(n=>dist[n]=Infinity); dist[start]=0;
  while(Q.size){
    let u=null, best=Infinity; for(const n of Q){ if(dist[n]<best){best=dist[n];u=n;} }
    Q.delete(u); if(u===undefined||u===null) break;
    for(const [v,w] of (NEI[u]||[])){
      if(!Q.has(v)) continue;
      const alt=dist[u]+w; if(alt<dist[v]){ dist[v]=alt; prev[v]=u; }
    }
  }
  return {dist, prev};
}
function path(u,v){ const {dist,prev}=dijkstra(u); if(!isFinite(dist[v])) return {km:Infinity, nodes:[]}; const nodes=[v]; let t=v; while(prev[t]){ t=prev[t]; nodes.push(t); } return {km:dist[v], nodes:nodes.reverse()}; }

/* ========= ETA –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —á–µ—Ä–≥–∏ –±—Ä–∏–≥–∞–¥–∏ ========= */
const W_PRIO={P1:-15, P2:0, P3:10}; // —à—Ç—Ä–∞—Ñ/–±–æ–Ω—É—Å –¥–æ –æ—Ü—ñ–Ω–∫–∏ (–º–µ–Ω—à–∏–π ‚Äî –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—à–µ)
function etaForCrew(crew, call, speed){
  let kmToFirst=0, from=crew.node;
  // —è–∫—â–æ –±—Ä–∏–≥–∞–¥–∞ –≤–∂–µ —â–æ—Å—å –≤–∏–∫–æ–Ω—É—î ‚Äî –æ—Å—Ç–∞–Ω–Ω—ñ–π –≤—É–∑–æ–ª —á–µ—Ä–≥–∏
  if(crew.busy && crew.progress){ from = crew.progress.to; }
  // –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º—ñ—Å—Ü—è/–∫—ñ–Ω—Ü—è —á–µ—Ä–≥–∏ –¥–æ –Ω–æ–≤–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
  const p=path(from, call.node); kmToFirst=p.km;
  let travelMin = kmToFirst/(speed/60);
  // –ø–ª—é—Å –Ω–∞–∫–æ–ø–∏—á–µ–Ω–∞ —Ä–æ–±–æ—Ç–∞ —É —á–µ—Ä–∑—ñ
  let waitMin = 0;
  if(crew.busy && crew.progress){ waitMin += Math.max(0, crew.progress.left); }
  crew.q.forEach(id=>{ const c=CALLS.find(x=>x.id===id); if(c && c.status!=='done') waitMin += c.dur; });
  const eta = Math.round(travelMin + waitMin);
  const score = eta + W_PRIO[call.prio];
  return {eta, score, km:kmToFirst, route:p.nodes};
}

/* ========= UI –ø–æ–±—É–¥–æ–≤–∞ —Å–ø–∏—Å–∫—ñ–≤ ========= */
function refreshNodeSelect(){
  const s=$('#node'); s.innerHTML='';
  Object.keys(NODES).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=`${k}`; s.appendChild(o); });
  s.value='H';
}
function renderCrews(){
  const tb=$('#crewTbl'); tb.innerHTML='';
  CREWS.forEach((c,i)=>{
    const qtxt=c.q.map(id=>'#'+id).join(', ')||'‚Äî';
    const st = c.busy? (c.progress?.mode==='drive'?'–≤ –¥–æ—Ä–æ–∑—ñ':'–≤ —Ä–æ–±–æ—Ç—ñ') : '–≤—ñ–ª—å–Ω–∞';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td><span style="display:inline-block;width:10px;height:10px;background:${c.color};border-radius:50%;margin-right:6px"></span>${c.name}</td><td>${c.node}</td><td>${qtxt}</td><td>${st}</td>`;
    tb.appendChild(tr);
  });
}
function renderCalls(){
  const tb=$('#callTbl'); tb.innerHTML='';
  if(CALLS.length===0){ tb.innerHTML='<tr><td colspan="6" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr>'; return; }
  CALLS.slice().sort((a,b)=>a.id-b.id).forEach((c,i)=>{
    const cls = c.prio==='P1'?'bad': c.prio==='P2'?'warn':'ok';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.id}</td><td>${c.node}</td><td class="${cls}"><b>${c.prio}</b></td><td>${c.eta!=null?c.eta:'‚Äî'}</td><td>${c.crewId?('–ë—Ä-'+c.crewId):'‚Äî'}</td><td>${c.status}</td>`;
    tb.appendChild(tr);
  });
  $('#qCalls').textContent = String(CALLS.filter(c=>c.status==='new').length);
}

/* ========= –ú–∞–ø–∞ —Ç–∞ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –±—Ä–∏–≥–∞–¥ ========= */
const map=$('#map'), gm=map.getContext('2d');
let dragCrew=null;
function drawMap(){
  const W=map.width,H=map.height; gm.clearRect(0,0,W,H);
  // —Å—ñ—Ç–∫–∞/—Ä–∞–º–∫–∞
  gm.strokeStyle='#223049'; gm.strokeRect(0.5,0.5,W-1,H-1);
  // –¥–æ—Ä–æ–≥–∏
  gm.strokeStyle='#334155'; gm.lineWidth=2;
  EDGES.forEach(([u,v,d])=>{
    const a=NODES[u], b=NODES[v]; gm.beginPath(); gm.moveTo(a.x,a.y); gm.lineTo(b.x,b.y); gm.stroke();
    const mx=(a.x+b.x)/2, my=(a.y+b.y)/2; gm.fillStyle='#64748b'; gm.font='10px ui-monospace'; gm.fillText(d.toFixed(1)+'–∫–º', mx-12, my-4);
  });
  // –≤—É–∑–ª–∏
  Object.entries(NODES).forEach(([k,p])=>{
    gm.fillStyle='#0b1a2f'; gm.beginPath(); gm.arc(p.x,p.y,10,0,2*Math.PI); gm.fill(); gm.strokeStyle='#38bdf8'; gm.stroke();
    gm.fillStyle='#e5e7eb'; gm.font='11px ui-monospace'; gm.fillText(k, p.x-3, p.y+3);
  });
  // –≤–∏–∫–ª–∏–∫–∏
  CALLS.filter(c=>c.status!=='done').forEach(c=>{
    const p=NODES[c.node]; gm.fillStyle = c.prio==='P1'?'#f87171': c.prio==='P2'?'#fbbf24':'#22c55e';
    gm.fillRect(p.x-6,p.y-20,12,12); gm.fillStyle='#e5e7eb'; gm.font='10px ui-monospace'; gm.fillText('#'+c.id, p.x-12, p.y-26);
  });
  // –±—Ä–∏–≥–∞–¥–∏
  CREWS.forEach(cr=>{
    const p=NODES[cr.node];
    gm.fillStyle=cr.color; gm.beginPath(); gm.arc(p.x,p.y,7,0,2*Math.PI); gm.fill(); gm.strokeStyle='#e5e7eb'; gm.stroke();
    gm.fillStyle='#e5e7eb'; gm.font='10px ui-monospace'; gm.fillText('–ë'+cr.id, p.x-10, p.y+18);
    // —è–∫—â–æ –≤ —Ä—É—Å—ñ ‚Äî –ø—Ä–æ–º–∞–ª—é–≤–∞—Ç–∏ ¬´–ø—Ä–∏–º–∞—Ä—É¬ª –º–∞—Ä—à—Ä—É—Ç—É
    if(cr.progress && cr.progress.route && cr.progress.mode==='drive'){
      gm.strokeStyle=cr.color; gm.setLineDash([6,4]); gm.beginPath();
      let prevNode=cr.progress.routeIdx; for(let i=prevNode;i<cr.progress.route.length-1;i++){
        const a=NODES[cr.progress.route[i]], b=NODES[cr.progress.route[i+1]];
        if(i===prevNode) gm.moveTo(a.x,a.y); gm.lineTo(b.x,b.y);
      }
      gm.stroke(); gm.setLineDash([]);
    }
  });
}
map.addEventListener('mousedown',e=>{
  const r=map.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  // —è–∫—â–æ –∫–ª—ñ–∫ –±–ª–∏–∑—å–∫–æ –¥–æ –±—Ä–∏–≥–∞–¥–∏ ‚Äî –≤–∑—è—Ç–∏ —ó—ó
  for(const c of CREWS){
    const p=NODES[c.node]; const dx=x-p.x, dy=y-p.y; if(dx*dx+dy*dy<12*12){ dragCrew=c; break; }
  }
});
map.addEventListener('mousemove',e=>{
  if(!dragCrew) return;
  const r=map.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  // –∑–Ω–∞–π—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–π –≤—É–∑–æ–ª
  let best=null,bestD=1e9;
  Object.entries(NODES).forEach(([k,p])=>{
    const d=(p.x-x)**2+(p.y-y)**2; if(d<bestD){ bestD=d; best=k; }
  });
  if(best) { dragCrew.node=best; drawMap(); renderCrews(); }
});
map.addEventListener('mouseup',()=>{ dragCrew=null; });

/* ========= –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∏–∫–ª–∏–∫—ñ–≤ ========= */
let nextCallId=1;
$('#addCall').addEventListener('click', ()=>{
  const node=$('#node').value, prio=$('#prio').value, dur=Math.max(5, parseInt($('#dur').value)||30);
  CALLS.push({id:nextCallId++, node, prio, dur, status:'new', crewId:null, eta:null, tCreate:NOW_MIN, tArr:null, tDone:null});
  log(`–ù–æ–≤–∏–π –≤–∏–∫–ª–∏–∫ #${nextCallId-1} @${node} (${prio}, ${dur} —Ö–≤)`);
  renderCalls(); drawMap();
});
$('#randomCall').addEventListener('click', ()=>{
  const keys=Object.keys(NODES);
  for(let i=0;i<3;i++){
    const node=keys[Math.floor(Math.random()*keys.length)];
    const pr=['P1','P2','P3'][Math.floor(Math.random()*3)];
    const dur=[20,30,45,60][Math.floor(Math.random()*4)];
    CALLS.push({id:nextCallId++, node, prio:pr, dur, status:'new', crewId:null, eta:null, tCreate:NOW_MIN, tArr:null, tDone:null});
  }
  renderCalls(); drawMap(); log('–î–æ–¥–∞–Ω–æ 3 –≤–∏–ø–∞–¥–∫–æ–≤—ñ –≤–∏–∫–ª–∏–∫–∏');
});

/* ========= –ê–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è ========= */
function autoAssign(){
  const speed=parseFloat($('#speed').value)||30;
  const free = CALLS.filter(c=>c.status==='new');
  if(!free.length){ log('–ù–µ–º–∞—î –≤—ñ–ª—å–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤'); return; }
  free.forEach(c=>{
    let best=null;
    CREWS.forEach(cr=>{
      const m=etaForCrew(cr,c,speed);
      if(!best || m.score<best.score) best={crew:cr, ...m};
    });
    if(best){
      c.status='assigned'; c.crewId=best.crew.id; c.eta=best.eta;
      // –¥–æ–¥–∞—Ç–∏ –≤ —á–µ—Ä–≥—É –±—Ä–∏–≥–∞–¥–∏
      best.crew.q.push(c.id);
      log(`–í–∏–∫–ª–∏–∫ #${c.id} ‚Üí ${best.crew.name} (ETA‚âà${best.eta} —Ö–≤, –ø—Ä—ñ–æ—Ä ${c.prio})`);
      TL.push({t:NOW_MIN, type:'assign', call:c.id, crew:best.crew.id, eta:best.eta});
    }
  });
  // SLA –ø–æ—Ç–æ—á–Ω–∏–π (–ø–ª–∞–Ω–æ–≤–∏–π)
  recalcSLA();
  renderCalls(); renderCrews(); drawMap();
}
$('#assign').addEventListener('click', autoAssign);
document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='a') autoAssign(); });

/* ========= –°–∏–º—É–ª—è—Ü—ñ—è —Ä—É—Ö—É/—Ä–æ–±—ñ—Ç ========= */
function step(){
  const speed=parseFloat($('#speed').value)||30;
  const delayProb=Math.min(1, Math.max(0, parseFloat($('#delay').value)||0));
  // –¥–ª—è –∫–æ–∂–Ω–æ—ó –±—Ä–∏–≥–∞–¥–∏: —è–∫—â–æ –Ω–µ –∑–∞–π–Ω—è—Ç–∞ ‚Äî –≤–∑—è—Ç–∏ –∑ —á–µ—Ä–≥–∏
  CREWS.forEach(cr=>{
    if(!cr.busy){
      const nextId=cr.q.shift();
      if(nextId!=null){
        const c=CALLS.find(x=>x.id===nextId);
        if(!c) return;
        // –º–∞—Ä—à—Ä—É—Ç
        const p=path(cr.node, c.node);
        c.status='enroute';
        cr.busy=true;
        cr.progress={mode:'drive', route:p.nodes, routeIdx:0, from:cr.node, to:c.node, left: Math.max(1, Math.round(p.km/(speed/60))) };
        TL.push({t:NOW_MIN, type:'depart', call:c.id, crew:cr.id});
        // —à–∞–Ω—Å –∑–∞—Ç—Ä–∏–º–∫–∏ –≤ –¥–æ—Ä–æ–∑—ñ
        if(Math.random()<delayProb) cr.progress.left += Math.ceil(5+Math.random()*10);
      }
    }else{
      // —Ä—É—Ö/—Ä–æ–±–æ—Ç–∏
      cr.progress.left--;
      if(cr.progress.left<=0){
        if(cr.progress.mode==='drive'){
          // –ø—Ä–∏–±—É–ª–∏
          const c=CALLS.find(x=>x.id=== (cr.q[0]?? null) || x=>false); // –Ω–µ —Ç–æ–π
          const cArr = CALLS.find(x=>x.crewId===cr.id && x.status==='enroute' && x.node===cr.progress.to);
          if(cArr){
            cArr.status='work'; cArr.tArr=NOW_MIN;
            // —Ä–æ–±–æ—Ç–∏
            cr.node=cr.progress.to;
            cr.progress={mode:'work', to:cArr.node, left:cArr.dur};
            TL.push({t:NOW_MIN, type:'arrive', call:cArr.id, crew:cr.id});
            // –≤–∏–ø–∞–¥–∫–æ–≤–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –Ω–∞ —Ä–æ–±–æ—Ç–∞—Ö
            if(Math.random()<delayProb) cr.progress.left += Math.ceil(5+Math.random()*10);
          }else{
            // —Ä–µ–∑–µ—Ä–≤: —è–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑—É–ø–∏–Ω–∏–ª–∏—Å—è –≤ —Ç–æ—á—Ü—ñ
            cr.node=cr.progress.to; cr.busy=false; cr.progress=null;
          }
        }else if(cr.progress.mode==='work'){
          // –∑–∞–≤–µ—Ä—à–µ–Ω–æ
          const c=CALLS.find(x=>x.crewId===cr.id && x.status==='work' && x.node===cr.progress.to);
          if(c){ c.status='done'; c.tDone=NOW_MIN; TL.push({t:NOW_MIN, type:'done', call:c.id, crew:cr.id}); }
          cr.busy=false; cr.progress=null;
        }
      }else{
        // –æ–Ω–æ–≤–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å –º–∞—Ä—à—Ä—É—Ç—É –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ ¬´—Ö–≤–æ—Å—Ç–∞¬ª
        if(cr.progress.mode==='drive' && cr.progress.routeIdx < cr.progress.route.length-2 && cr.progress.left % 3 === 0){
          cr.progress.routeIdx++;
        }
      }
    }
  });
  NOW_MIN++;
  if(NOW_MIN%1===0){ drawMap(); renderCrews(); renderCalls(); drawChart(); recalcSLA(); }
}
let timer=null;
function start(){ if(!RUN){ RUN=true; timer=setInterval(step, 300); log('–°–∏–º—É–ª—è—Ü—ñ—è —Å—Ç–∞—Ä—Ç—É–≤–∞–ª–∞'); } }
function pause(){ if(RUN){ RUN=false; clearInterval(timer); log('–°–∏–º—É–ª—è—Ü—ñ—é –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–∞—É–∑—É'); } }
$('#start').addEventListener('click', start);
$('#pause').addEventListener('click', pause);
document.addEventListener('keydown',e=>{ if(e.code==='Space'){ e.preventDefault(); RUN?pause():start(); } });

$('#reset').addEventListener('click', ()=>{
  pause();
  NOW_MIN=0; CALLS=[]; CREWS.forEach(c=>{ c.q=[]; c.busy=false; c.progress=null; });
  CREWS[0].node='A'; CREWS[1].node='D'; CREWS[2].node='J';
  TL=[]; nextCallId=1;
  drawMap(); renderCrews(); renderCalls(); drawChart(); $('#sla').textContent='‚Äî';
  log('–°–∫–∏–¥–∞–Ω–Ω—è –¥–æ –±–∞–∑–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É');
});

/* ========= –î—ñ–∞–≥—Ä–∞–º–∞ —á–µ—Ä–≥/–≤–∏–∫–æ–Ω–∞–Ω–Ω—è ========= */
const chart=$('#chart'), gc=chart.getContext('2d');
function drawChart(){
  const W=chart.width,H=chart.height; gc.clearRect(0,0,W,H);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,W-1,H-1);
  // –∑–Ω–∞—á–µ–Ω–Ω—è: –¥–æ–≤–∂–∏–Ω–∞ —á–µ—Ä–≥–∏ + (busy?1:0)
  const vals=CREWS.map(c=> (c.q.length + (c.busy?1:0)));
  const left=40,right=W-10,top=20,bottom=H-26;
  const max=Math.max(...vals,1);
  const bw=(right-left)/CREWS.length;
  gc.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,y); gc.lineTo(right,y); gc.stroke(); }
  CREWS.forEach((c,i)=>{
    const x=left+i*bw+8; const h=(vals[i]/max)*(bottom-top);
    gc.fillStyle=c.color; gc.fillRect(x, bottom-h, bw-16, h);
    gc.fillStyle='#e5e7eb'; gc.font='11px ui-monospace'; gc.fillText(c.name, x-6, top+12);
  });
}

/* ========= SLA ========= */
function recalcSLA(){
  const done = CALLS.filter(c=>c.tArr!=null);
  const byP={P1:[],P2:[],P3:[]};
  done.forEach(c=>byP[c.prio].push(c.tArr - c.tCreate));
  const lim={P1:15,P2:60,P3:180};
  const pct=(arr,limit)=> arr.length? Math.round(100*arr.filter(v=>v<=limit).length/arr.length): 100;
  const s=`P1 ${pct(byP.P1,lim.P1)}% ¬∑ P2 ${pct(byP.P2,lim.P2)}% ¬∑ P3 ${pct(byP.P3,lim.P3)}%`;
  $('#sla').textContent=s;
}

/* ========= –ï–∫—Å–ø–æ—Ä—Ç ========= */
$('#saveCsv').addEventListener('click', ()=>{
  let csv='t_min,type,call,crew,extra\n';
  TL.forEach(e=>{ csv+=`${e.t},${e.type},${e.call??''},${e.crew??''},${e.eta??''}\n`; });
  download('gas_para24_timeline_'+stamp()+'.csv', csv, 'text/csv'); log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click', ()=>{
  const lines=[
    '–ü–∞—Ä–∞ 24 ‚Äî AI-–¥–∏—Å–ø–µ—Ç—á–µ—Ä: –ø—ñ–¥—Å—É–º–æ–∫',
    `–í–∏–∫–ª–∏–∫—ñ–≤ –∑–∞–≥–∞–ª–æ–º: ${CALLS.length}`,
    `–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${CALLS.filter(c=>c.status==='done').length}`,
    `SLA: ${$('#sla').textContent}`,
    '',
    ...CALLS.map(c=>`#${c.id} ${c.prio} @${c.node} ‚Äî —Å—Ç–∞—Ç—É—Å ${c.status}${c.tArr!=null?`, ETA=${c.eta} —Ö–≤, –ø—Ä–∏–±—É—Ç—Ç—è t=${c.tArr}`:''}${c.tDone!=null?`, –∑–∞–≤–µ—Ä—à–µ–Ω–æ t=${c.tDone}`:''}`)
  ];
  download('gas_para24_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

/* ========= –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ========= */
function init(){
  refreshNodeSelect(); renderCrews(); renderCalls(); drawMap(); drawChart();
  log('–ì–æ—Ç–æ–≤–æ: –¥–æ–¥–∞–π –≤–∏–∫–ª–∏–∫–∏ ‚Üí –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ê–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è¬ª ‚Üí ¬´–°—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü—ñ—ó¬ª.');
}
init();
</script>
</body>
</html>
