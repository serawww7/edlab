<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 3 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞: —Å–µ—Ä—ñ–π–Ω–∏–∫, –ø–ª–æ–º–±–∞, —Ñ–æ—Ç–æ, –ø–æ–∫–∞–∑–Ω–∏–∫, —á–µ–∫ 58 –º–º, CSV/QR</title>
<meta name="description" content="–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –≥–∞–∑–æ–≤–æ–≥–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞: —Å–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä, –º–æ–¥–µ–ª—å, –º—ñ—Å—Ü–µ, NFC/ID, —Ñ–æ—Ç–æ –∫—Ä—É–ø–Ω–∏–º –ø–ª–∞–Ω–æ–º —ñ –≤—É–∑–ª–∞, –ø–ª–æ–º–±–∞ (‚Ññ —ñ —Å—Ç–∞—Ç—É—Å), –ø–æ–∫–∞–∑–Ω–∏–∫, –∞—É–¥—ñ–æ-–Ω–æ—Ç–∞—Ç–∫–∞, —á–µ–∫ 58 –º–º, CSV/TXT, QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üßæ</span>
      <div>
        <b>–ü–∞—Ä–∞ 3 ‚Äî –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞</b><br/>
        <span class="badge">–°–µ—Ä—ñ–π–Ω–∏–∫/–º–æ–¥–µ–ª—å/–º—ñ—Å—Ü–µ ‚Üí NFC/ID ‚Üí —Ñ–æ—Ç–æ —Å–µ—Ä—ñ–π–Ω–∏–∫–∞ —ñ –≤—É–∑–ª–∞ ‚Üí –ø–ª–æ–º–±–∞ ‚Üí –ø–æ–∫–∞–∑–Ω–∏–∫ ‚Üí —á–µ–∫ 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –©–æ —Ä–æ–±–∏–º–æ</h2>
    <p>–í–Ω–æ—Å–∏–º–æ –¥–∞–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (<b>—Å–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä</b>, <b>–º–æ–¥–µ–ª—å</b>, <b>–º—ñ—Å—Ü–µ</b>), –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ <b>ID –æ–±‚Äô—î–∫—Ç–∞ (NFC –∞–±–æ –∫–æ–¥)</b>, —Ä–æ–±–∏–º–æ <b>2 —Ñ–æ—Ç–æ</b> (—Å–µ—Ä—ñ–π–Ω–∏–∫ –∫—Ä—É–ø–Ω–æ + –≤—É–∑–æ–ª –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è), –≤—ñ–¥–º—ñ—á–∞—î–º–æ <b>–ø–ª–æ–º–±—É</b> (–≥–µ–Ω–µ—Ä—É—î–º–æ ‚Ññ, –æ–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ç—É—Å, –¥–æ–¥–∞—î–º–æ —Ñ–æ—Ç–æ –ø–ª–æ–º–±–∏), –∑–Ω—ñ–º–∞—î–º–æ <b>–ø–æ–∫–∞–∑–Ω–∏–∫</b> (–º¬≥), –ª–∏—à–∞—î–º–æ <b>–∞—É–¥—ñ–æ-–Ω–æ—Ç–∞—Ç–∫—É</b>, –±—É–¥—É—î–º–æ <b>—à–∫–∞–ª—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ—Å—Ç—ñ</b> —ñ —Ñ–æ—Ä–º—É—î–º–æ <b>—á–µ–∫ 58 –º–º</b>, <b>CSV/TXT</b>, <b>QR</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, 10, –∫–≤. 12"/></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."/></label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"/></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –î–∞–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞, –ö–∞–º–µ—Ä–∞, –ê—É–¥—ñ–æ -->
    <div class="card">
      <h2>üÜî –î–∞–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞</h2>
      <div class="row">
        <label style="flex:1">–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ<input id="ser" class="input" placeholder="–ù–∞–ø—Ä.: G4-12345678"/></label>
        <label style="flex:1">–ú–æ–¥–µ–ª—å
          <select id="model" class="input">
            <option>G1.6</option><option selected>G2.5</option><option>G4</option><option>G6</option>
          </select>
        </label>
        <label style="flex:1">–ú—ñ—Å—Ü–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è<input id="place" class="input" placeholder="–ö—É—Ö–Ω—è, —à–∞—Ñ–∞, —â–∏—Ç..."/></label>
      </div>

      <div class="block">
        <div class="row">
          <button class="btn" id="nfcBtn">üì∂ NFC</button>
          <input id="asset" class="input" placeholder="ID –æ–±‚Äô—î–∫—Ç–∞ (—è–∫—â–æ NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)"/>
          <button class="btn secondary" id="saveAsset">üíæ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <span class="badge" id="nfcs">–°—Ç–∞—Ç—É—Å NFC: –æ—á—ñ–∫—É—î—Ç—å—Å—è</span>
        </div>
      </div>

      <h2 style="margin-top:10px">üé• –ö–∞–º–µ—Ä–∞ —Ç–∞ —Ñ–æ—Ç–æ (3 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay playsinline muted></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="ser">üì∑ –°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ (–∫—Ä—É–ø–Ω–æ)</button>
          <button class="btn" data-kind="node">üì∑ –í—É–∑–æ–ª –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</button>
          <button class="btn" data-kind="seal">üì∑ –ü–ª–æ–º–±–∞</button><br/>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">üîí –ü–ª–æ–º–±–∞</h2>
      <div class="row">
        <label style="flex:1">‚Ññ –ø–ª–æ–º–±–∏<input id="sealNo" class="input" placeholder="–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∞–±–æ —Å–≤—ñ–π –Ω–æ–º–µ—Ä"/></label>
        <label style="flex:1">–°—Ç–∞—Ç—É—Å
          <select id="sealState" class="input">
            <option value="sealed" selected>–ü–ª–æ–º–±–æ–≤–∞–Ω–æ</option>
            <option value="unsealed">–†–æ–∑–ø–ª–æ–º–±–æ–≤–∞–Ω–æ</option>
            <option value="replaced">–ó–∞–º—ñ–Ω–∞ –ø–ª–æ–º–±–∏</option>
          </select>
        </label>
        <button class="btn" id="genSeal">üé≤ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ ‚Ññ</button>
      </div>

      <h2 style="margin-top:10px">üî¢ –ü–æ–∫–∞–∑–Ω–∏–∫ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (–º¬≥)</h2>
      <div class="row">
        <input type="number" id="reading" class="input" min="0" step="0.001" placeholder="–ù–∞–ø—Ä.: 01234.567"/>
        <button class="btn" id="markRead">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–æ–∫–∞–∑–Ω–∏–∫</button>
        <span class="badge" id="rOk">‚Äî</span>
      </div>

      <h2 style="margin-top:10px">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
      <div class="row">
        <button class="btn" id="recStart">‚è∫Ô∏è –ó–∞–ø–∏—Å</button>
        <button class="btn secondary" id="recStop" disabled>‚èπÔ∏è –°—Ç–æ–ø</button>
        <span class="badge" id="rstat">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É</span>
      </div>
      <audio id="player" controls style="margin-top:8px;max-width:100%"></audio>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–æ–≥—Ä–µ—Å-–¥—ñ–∞–≥—Ä–∞–º–∞, –ú–µ—Ç—Ä–∏–∫–∏, –ï–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üìà –®–∫–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ—Å—Ç—ñ (–∫—Ä–æ–∫–∏)</h2>
      <div class="canvasWrap"><canvas id="progress" class="chart" width="520" height="220"></canvas></div>

      <table class="tbl" style="margin-top:8px">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>ID –æ–±‚Äô—î–∫—Ç–∞</th><td id="mAsset">‚Äî</td></tr>
          <tr><th>–§–æ—Ç–æ (—Å–µ—Ä—ñ–π–Ω–∏–∫/–≤—É–∑–æ–ª/–ø–ª–æ–º–±–∞)</th><td id="mPhotos">0 / 0 / 0</td></tr>
          <tr><th>–ü–ª–æ–º–±–∞</th><td id="mSeal">‚Äî</td></tr>
          <tr><th>–ü–æ–∫–∞–∑–Ω–∏–∫</th><td id="mRead">‚Äî</td></tr>
          <tr><th>–ê—É–¥—ñ–æ</th><td id="mAudio">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—Ä–æ–∫–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ (–∞–¥—Ä–µ—Å–∞/–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å/–¥–∞—Ç–∞) ‚Äî <b>2</b></li>
        <li>ID –æ–±‚Äô—î–∫—Ç–∞ (NFC/–∫–æ–¥) ‚Äî <b>2</b></li>
        <li>–§–æ—Ç–æ (—É—Å—ñ —Ç—Ä–∏ —Ç–∏–ø–∏) ‚Äî <b>3</b></li>
        <li>–ü–ª–æ–º–±–∞ (‚Ññ —ñ —Å—Ç–∞—Ç—É—Å) ‚Äî <b>1</b></li>
        <li>–ü–æ–∫–∞–∑–Ω–∏–∫ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ ‚Äî <b>1</b></li>
        <li>–ê—É–¥—ñ–æ-–Ω–æ—Ç–∞—Ç–∫–∞ ‚Äî <b>1</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case/Asset)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:220px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}
$('#upd').textContent = new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –°—Ç–∞–Ω –∫–µ–π—Å—É =====
let CASE_ID=null, ASSET_ID=null;
let photos={ser:null,node:null,seal:null};
let audioUrl=null;
let seal={no:'', state:'sealed'};
let reading=null;

function updateMetrics(){
  $('#mCase').textContent = CASE_ID || '‚Äî';
  $('#mAsset').textContent = ASSET_ID || ($('#asset').value||'‚Äî');
  $('#mPhotos').textContent = `${photos.ser?1:0} / ${photos.node?1:0} / ${photos.seal?1:0}`;
  $('#mSeal').textContent = (seal.no?`‚Ññ ${seal.no}, `:'') + (seal.state==='sealed'?'–ü–ª–æ–º–±–æ–≤–∞–Ω–æ':seal.state==='unsealed'?'–†–æ–∑–ø–ª–æ–º–±–æ–≤–∞–Ω–æ':'–ó–∞–º—ñ–Ω–∞ –ø–ª–æ–º–±–∏');
  $('#mRead').textContent = (reading!=null? reading.toFixed(3)+' –º¬≥' : '‚Äî');
  $('#mAudio').textContent = audioUrl?'—î':'‚Äî';
  drawProgress();
  // –æ—Ü—ñ–Ω–∫–∞
  let score=0;
  if(CASE_ID) score+=2;
  if(ASSET_ID || clean($('#asset').value||'')) score+=2;
  if(photos.ser && photos.node && photos.seal) score+=3;
  if(seal.no && seal.state) score+=1;
  if(reading!=null) score+=1;
  if(audioUrl) score+=1;
  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML = html;
}

// ===== –ö–µ–π—Å =====
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||'');
  const tech=clean($('#tech').value||'');
  const day=$('#day').value;
  if(!addr||!tech||!day){ alert('–í–∫–∞–∂–∏ –∞–¥—Ä–µ—Å—É, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —ñ –¥–∞—Ç—É'); return; }
  CASE_ID = 'C-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent = '–ö–µ–π—Å: '+CASE_ID;
  log(`–°—Ç–≤–æ—Ä–µ–Ω–æ –∫–µ–π—Å ${CASE_ID} (${addr}, ${tech}, ${day})`);
  updateMetrics();
});

// ===== NFC / —Ä—É—á–Ω–∏–π ID =====
async function tryNFC(){
  if('NDEFReader' in window){
    try{
      const reader=new NDEFReader(); await reader.scan();
      $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
      reader.addEventListener('reading', ({message, serialNumber})=>{
        let text=''; for(const rec of message.records){ if(rec.recordType==='text'){ const dec=new TextDecoder(rec.encoding||'utf-8'); text = dec.decode(rec.data); } }
        ASSET_ID = (text||serialNumber||'NFC-'+Math.random().toString(36).slice(2,7)).toString();
        $('#asset').value = ASSET_ID;
        $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑—á–∏—Ç–∞–Ω–æ';
        log('NFC –ø—Ä–æ—á–∏—Ç–∞–Ω–æ: '+ASSET_ID);
        updateMetrics();
      });
    }catch(e){ $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –ø–æ–º–∏–ª–∫–∞'; alert('NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π'); }
  }else{ alert('Web NFC –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –í–≤–µ–¥–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É.'); }
}
$('#nfcBtn').addEventListener('click', tryNFC);
$('#saveAsset').addEventListener('click',()=>{
  const v=clean($('#asset').value||'');
  if(!v){ alert('–í–≤–µ–¥–∏ ID –æ–±‚Äô—î–∫—Ç–∞'); return; }
  ASSET_ID=v; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É';
  log('–†—É—á–Ω–∏–π ID –æ–±‚Äô—î–∫—Ç–∞: '+ASSET_ID);
  updateMetrics();
});

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ =====
let stream=null;
async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    $('#vid').srcObject = stream;
    log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ');
  }catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);

function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  const g=c.getContext('2d'); g.drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png');
  photos[kind]=url;
  renderGallery();
  log(`–ó—Ä–æ–±–ª–µ–Ω–æ —Ñ–æ—Ç–æ: ${kind}`);
  updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));

function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  ['ser','node','seal'].forEach(k=>{
    if(photos[k]){ const img=document.createElement('img'); img.className='photo'; img.src=photos[k]; img.alt=k; gal.appendChild(img); }
  });
}

// ===== –ü–ª–æ–º–±–∞ =====
function genSealNo(){ return 'PL-'+Math.random().toString(36).slice(2,10).toUpperCase(); }
$('#genSeal').addEventListener('click',()=>{
  $('#sealNo').value = genSealNo();
  seal.no = $('#sealNo').value.trim();
  seal.state = $('#sealState').value;
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ ‚Ññ –ø–ª–æ–º–±–∏: '+seal.no);
  updateMetrics();
});
$('#sealNo').addEventListener('input',()=>{ seal.no = $('#sealNo').value.trim(); updateMetrics(); });
$('#sealState').addEventListener('change',()=>{ seal.state = $('#sealState').value; updateMetrics(); });

// ===== –ü–æ–∫–∞–∑–Ω–∏–∫ =====
$('#markRead').addEventListener('click',()=>{
  const val = parseFloat($('#reading').value);
  if(!Number.isFinite(val) || val<0 ){ alert('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫'); return; }
  reading = Math.round(val*1000)/1000;
  $('#rOk').textContent='–ó–±–µ—Ä–µ–∂–µ–Ω–æ';
  log('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ –ø–æ–∫–∞–∑–Ω–∏–∫: '+reading.toFixed(3)+' –º¬≥');
  updateMetrics();
});

// ===== –ê—É–¥—ñ–æ =====
let mediaRec=null; let chunks=[];
$('#recStart').addEventListener('click', async ()=>{
  try{
    const st = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    mediaRec = new MediaRecorder(st);
    chunks=[];
    mediaRec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
    mediaRec.onstop = ()=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      audioUrl = URL.createObjectURL(blob);
      $('#player').src=audioUrl;
      $('#rstat').textContent='–ó–∞–ø–∏—Å –≥–æ—Ç–æ–≤–∏–π';
      const a=document.createElement('a'); a.href=audioUrl; a.download='voice_'+(CASE_ID||'case')+'_'+stamp()+'.webm'; document.body.appendChild(a); a.click(); a.remove();
      log('–ê—É–¥—ñ–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ (webm)');
      updateMetrics();
    };
    mediaRec.start();
    $('#recStart').disabled=true; $('#recStop').disabled=false;
    $('#rstat').textContent='–ô–¥–µ –∑–∞–ø–∏—Å...';
    log('–ü–æ—á–∞—Ç–æ –∞—É–¥—ñ–æ–∑–∞–ø–∏—Å');
  }catch(e){ alert('–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'); }
});
$('#recStop').addEventListener('click', ()=>{
  if(mediaRec && mediaRec.state!=='inactive'){ mediaRec.stop(); }
  $('#recStart').disabled=false; $('#recStop').disabled=true;
});

// ===== –ü—Ä–æ–≥—Ä–µ—Å-–¥—ñ–∞–≥—Ä–∞–º–∞ =====
const pc=$('#progress'), pg=pc.getContext('2d');
function drawProgress(){
  const W=pc.width,H=pc.height; pg.clearRect(0,0,W,H);
  pg.strokeStyle='#223049'; pg.strokeRect(0.5,0.5,W-1,H-1);
  const steps = [
    {k:'case', ok:!!CASE_ID, label:'–ö–µ–π—Å'},
    {k:'asset', ok:!!(ASSET_ID || clean($('#asset').value||'')), label:'ID –æ–±‚Äô—î–∫—Ç–∞'},
    {k:'ser', ok:!!photos.ser, label:'–§–æ—Ç–æ —Å–µ—Ä—ñ–π–Ω–∏–∫–∞'},
    {k:'node', ok:!!photos.node, label:'–§–æ—Ç–æ –≤—É–∑–ª–∞'},
    {k:'seal', ok:!!photos.seal && !!seal.no, label:'–ü–ª–æ–º–±–∞'},
    {k:'read', ok:(reading!=null), label:'–ü–æ–∫–∞–∑–Ω–∏–∫'},
    {k:'aud', ok:!!audioUrl, label:'–ê—É–¥—ñ–æ'}
  ];
  // —à–∫–∞–ª–∞ –∑–≤–µ—Ä—Ö—É
  const left=40,right=W-10,top=24,bottom=H-30;
  const done = steps.filter(s=>s.ok).length;
  const frac = done/steps.length;
  // —Ñ–æ–Ω
  pg.fillStyle='#0b1220'; pg.fillRect(left, top, right-left, 24);
  // –ø—Ä–æ–≥—Ä–µ—Å
  pg.fillStyle='#38bdf8'; pg.fillRect(left, top, (right-left)*frac, 24);
  pg.fillStyle='#e5e7eb'; pg.font='12px ui-monospace';
  pg.fillText(`–ì–æ—Ç–æ–≤–æ: ${done}/${steps.length}`, left+8, top+16);
  // —Å–ø–∏—Å–æ–∫
  let y=top+50;
  steps.forEach((s,i)=>{
    pg.fillStyle=s.ok?'#22c55e':'#94a3b8';
    pg.fillText((s.ok?'‚úî ':'‚Ä¢ ')+s.label, left+8, y);
    y+=18;
  });
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR =====
function header(){
  return {
    case: CASE_ID||'‚Äî',
    addr: $('#addr').value||'‚Äî',
    tech: $('#tech').value||'‚Äî',
    day: $('#day').value||'‚Äî',
    ser: $('#ser').value||'‚Äî',
    model: $('#model').value||'‚Äî',
    place: $('#place').value||'‚Äî',
    asset: ASSET_ID||($('#asset').value||'‚Äî'),
    seal_no: seal.no||'‚Äî',
    seal_state: seal.state,
    reading: (reading!=null? reading.toFixed(3):'‚Äî'),
    photos: {ser:!!photos.ser,node:!!photos.node,seal:!!photos.seal},
    audio: !!audioUrl
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const h=header();
  let csv='field,value\n';
  Object.entries(h).forEach(([k,v])=>{
    if(typeof v==='object'){ csv+=`${k},${JSON.stringify(v).replace(/,/g,';')}\n`; }
    else { csv+=`${k},${String(v).replace(/,/g,';')}\n`; }
  });
  download('gas_para03_meter_'+stamp()+'.csv', csv, 'text/csv');
  log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const h=header();
  const lines=[
    '–ü–∞—Ä–∞ 3 ‚Äî –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${h.case}`,
    `–ê–¥—Ä–µ—Å–∞: ${h.addr}`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${h.tech}`,
    `–î–∞—Ç–∞: ${h.day}`,
    `–õ—ñ—á–∏–ª—å–Ω–∏–∫: ${h.model}, —Å–µ—Ä—ñ–π–Ω–∏–π: ${h.ser}`,
    `–ú—ñ—Å—Ü–µ: ${h.place}`,
    `–û–±‚Äô—î–∫—Ç (ID): ${h.asset}`,
    `–ü–ª–æ–º–±–∞: ‚Ññ ${h.seal_no}, —Å—Ç–∞–Ω: ${h.seal_state}`,
    `–ü–æ–∫–∞–∑–Ω–∏–∫: ${h.reading} –º¬≥`,
    `–§–æ—Ç–æ (ser/node/seal): ${h.photos.ser?'1':'0'} / ${h.photos.node?'1':'0'} / ${h.photos.seal?'1':'0'}`,
    `–ê—É–¥—ñ–æ: ${h.audio?'—î':'‚Äî'}`
  ];
  download('gas_para03_meter_'+stamp()+'.txt', lines.join('\n'));
  log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const rc=$('#rc'); rc.hidden=false;
  const h=header();
  const lines=[
'=== GAS METER ID (58–º–º) ===',
'Case: '+h.case,
'Date: '+h.day,
'Addr: '+h.addr,
'Tech: '+h.tech,
'Meter: '+h.model,
'S/N:  '+h.ser,
'Place:'+h.place,
'Asset:'+h.asset,
'Seal: #'+h.seal_no+' '+h.seal_state,
'Read: '+h.reading+' m3',
'Photos:'+ (h.photos.ser?1:0)+'/'+(h.photos.node?1:0)+'/'+(h.photos.seal?1:0),
'Audio: '+(h.audio?'yes':'no'),
'--------------------------'
  ];
  rc.textContent = lines.join('\n');
  download('gas_para03_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def = CASE_ID || ASSET_ID || 'gas-meter';
  const data = prompt('–í—Å—Ç–∞–≤ URL/ID (Case –∞–±–æ Asset):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url;
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –Ü–Ω—ñ—Ç –ø—Ä–æ–≥—Ä–µ—Å—É =====
drawProgress();
</script>
</body>
</html>
