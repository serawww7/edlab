<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 5 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è/—Ä–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è: ‚Ññ –ø–ª–æ–º–±–∏, —Ñ–æ—Ç–æ, –ø—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞, —á–µ–∫ 58 –º–º, CSV/TXT, QR</title>
<meta name="description" content="–ü—Ä–∞–∫—Ç–∏–∫–∞ –ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è/—Ä–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è: –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è ‚Ññ –ø–ª–æ–º–±–∏, —Ñ–æ—Ç–æ –∑ –∫–∞–º–µ—Ä–∏, –ø—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞ –º–∏—à–µ—é, NFC/ID –æ–±‚Äô—î–∫—Ç–∞, —á–µ–∫ 58 –º–º, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
.sigWrap{border:1px dashed var(--line);border-radius:12px;padding:8px;background:#0c182a}
#sig{background:#0b1220;border:1px solid var(--line);border-radius:8px;touch-action:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üîí</span>
      <div>
        <b>–ü–∞—Ä–∞ 5 ‚Äî –ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è/—Ä–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è</b><br/>
        <span class="badge">‚Ññ –ø–ª–æ–º–±–∏ ‚Üí —Ñ–æ—Ç–æ –ø–ª–æ–º–±–∏ ‚Üí –ø—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞ ‚Üí NFC/ID ‚Üí —á–µ–∫ 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –°—Ü–µ–Ω–∞—Ä—ñ–π</h2>
    <p>–û–ø–µ—Ä–∞—Ü—ñ—ó: <b>–ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è</b> / <b>–†–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è</b> / <b>–ó–∞–º—ñ–Ω–∞ –ø–ª–æ–º–±–∏</b>. –°—Ç–≤–æ—Ä—é—î–º–æ –∫–µ–π—Å, —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î–º–æ –æ–±‚Äô—î–∫—Ç (<b>NFC –∞–±–æ –∫–æ–¥</b>), –≥–µ–Ω–µ—Ä—É—î–º–æ <b>‚Ññ –ø–ª–æ–º–±–∏</b> (–∞–±–æ –≤–≤–æ–¥–∏–º–æ), —Ä–æ–±–∏–º–æ <b>—Ñ–æ—Ç–æ</b> (–¥–æ/–∫—Ä—É–ø–Ω–∏–π –ø–ª–∞–Ω/–ø—ñ—Å–ª—è), –æ—Ç—Ä–∏–º—É—î–º–æ <b>–ø—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</b>, —Ñ–æ—Ä–º—É—î–º–æ <b>—á–µ–∫ 58 –º–º</b>, <b>CSV/TXT</b> —ñ <b>QR</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, 10, –∫–≤. 12"/></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."/></label>
      <label style="flex:1">–û–ø–µ—Ä–∞—Ü—ñ—è
        <select id="op" class="input">
          <option value="sealed" selected>–ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è</option>
          <option value="unsealed">–†–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è</option>
          <option value="replaced">–ó–∞–º—ñ–Ω–∞ –ø–ª–æ–º–±–∏</option>
        </select>
      </label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"/></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ü–ª–æ–º–±–∞/–ö–∞–º–µ—Ä–∞/–ü—ñ–¥–ø–∏—Å/NFC -->
    <div class="card">
      <h2>üîë –ü–ª–æ–º–±–∞</h2>
      <div class="row">
        <label style="flex:1">‚Ññ –ø–æ—Ç–æ—á–Ω–æ—ó –ø–ª–æ–º–±–∏ (—è–∫—â–æ —î)<input id="sealOld" class="input" placeholder="–ù–∞–ø—Ä.: PL-OLD-1234"/></label>
        <label style="flex:1">‚Ññ –Ω–æ–≤–æ—ó –ø–ª–æ–º–±–∏<input id="sealNew" class="input" placeholder="–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä—É—î–º–æ –∞–±–æ —Å–≤—ñ–π"/></label>
        <button class="btn" id="genSeal">üé≤ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ ‚Ññ</button>
      </div>

      <h2 style="margin-top:10px">üé• –§–æ—Ç–æ (3 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay playsinline muted></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="before">üì∑ –î–æ</button>
          <button class="btn" data-kind="closeup">üì∑ –ö—Ä—É–ø–Ω–∏–π –ø–ª–∞–Ω –ø–ª–æ–º–±–∏</button>
          <button class="btn" data-kind="after">üì∑ –ü—ñ—Å–ª—è</button><br/>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª —Ç–∞ –ø—ñ–¥—É—Ç—å —É –∑–≤—ñ—Ç.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">‚úçÔ∏è –ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>
      <div class="sigWrap">
        <canvas id="sig" width="520" height="200"></canvas>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="sigClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
          <button class="btn" id="sigSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
          <span class="badge" id="sigStat">–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î</span>
        </div>
      </div>

      <h2 style="margin-top:10px">üì∂ NFC / ID –æ–±‚Äô—î–∫—Ç–∞</h2>
      <div class="block">
        <div class="row">
          <button class="btn" id="nfcBtn">üì∂ NFC</button>
          <input id="asset" class="input" placeholder="ID –æ–±‚Äô—î–∫—Ç–∞ (—è–∫—â–æ NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)"/>
          <button class="btn secondary" id="saveAsset">üíæ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <span class="badge" id="nfcs">–°—Ç–∞—Ç—É—Å NFC: –æ—á—ñ–∫—É—î—Ç—å—Å—è</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ú–µ—Ç—Ä–∏–∫–∏/–û—Ü—ñ–Ω–∫–∞/–ï–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ / —Å—Ç–∞–Ω</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>ID –æ–±‚Äô—î–∫—Ç–∞</th><td id="mAsset">‚Äî</td></tr>
          <tr><th>–û–ø–µ—Ä–∞—Ü—ñ—è</th><td id="mOp">‚Äî</td></tr>
          <tr><th>–ü–ª–æ–º–±–∞ (—Å—Ç–∞—Ä–∞/–Ω–æ–≤–∞)</th><td id="mSeal">‚Äî</td></tr>
          <tr><th>–§–æ—Ç–æ (–¥–æ/–∫—Ä—É–ø–Ω–∏–π/–ø—ñ—Å–ª—è)</th><td id="mPhotos">0 / 0 / 0</td></tr>
          <tr><th>–ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</th><td id="mSig">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—Ä–æ–∫–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ (–∞–¥—Ä–µ—Å–∞/–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å/–æ–ø–µ—Ä–∞—Ü—ñ—è/–¥–∞—Ç–∞) ‚Äî <b>2</b></li>
        <li>ID –æ–±‚Äô—î–∫—Ç–∞ (NFC/–∫–æ–¥) ‚Äî <b>2</b></li>
        <li>–ü–ª–æ–º–±–∞ (‚Ññ —Å—Ç–∞—Ä–æ—ó/–Ω–æ–≤–æ—ó –∑–∞ –ø–æ—Ç—Ä–µ–±–∏) ‚Äî <b>2</b></li>
        <li>–§–æ—Ç–æ (–≤—Å—ñ —Ç—Ä–∏) ‚Äî <b>2</b></li>
        <li>–ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞ ‚Äî <b>2</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case/Asset)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:240px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}

$('#upd').textContent = new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –°—Ç–∞–Ω –∫–µ–π—Å—É =====
let CASE_ID=null, ASSET_ID=null;
let op='sealed';
let seal={old:'', new:''};
let photos={before:null, closeup:null, after:null};
let sigUrl=null;

// ===== –ö–µ–π—Å =====
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||''); const tech=clean($('#tech').value||''); const day=$('#day').value;
  op = $('#op').value;
  if(!addr||!tech||!day){ alert('–í–∫–∞–∂–∏ –∞–¥—Ä–µ—Å—É, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ç–∞ –¥–∞—Ç—É'); return; }
  CASE_ID='S-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent='–ö–µ–π—Å: '+CASE_ID;
  log(`–ö–µ–π—Å ${CASE_ID}: ${addr}, ${tech}, ${day}, –æ–ø–µ—Ä–∞—Ü—ñ—è ${op}`);
  updateMetrics();
});

// ===== NFC / ID =====
async function tryNFC(){
  if('NDEFReader' in window){
    try{
      const reader=new NDEFReader(); await reader.scan();
      $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
      reader.addEventListener('reading', ({message, serialNumber})=>{
        let text=''; for(const rec of message.records){ if(rec.recordType==='text'){ const dec=new TextDecoder(rec.encoding||'utf-8'); text = dec.decode(rec.data); } }
        ASSET_ID = (text||serialNumber||'NFC-'+Math.random().toString(36).slice(2,7)).toString();
        $('#asset').value=ASSET_ID;
        $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑—á–∏—Ç–∞–Ω–æ';
        log('NFC: '+ASSET_ID);
        updateMetrics();
      });
    }catch(e){ $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –ø–æ–º–∏–ª–∫–∞'; alert('NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π/–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π'); }
  }else{ alert('Web NFC –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –í–≤–µ–¥–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É.'); }
}
$('#nfcBtn').addEventListener('click', tryNFC);
$('#saveAsset').addEventListener('click',()=>{ const v=clean($('#asset').value||''); if(!v){ alert('–í–≤–µ–¥–∏ ID –æ–±‚Äô—î–∫—Ç–∞'); return; } ASSET_ID=v; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É'; log('ID –æ–±‚Äô—î–∫—Ç–∞: '+ASSET_ID); updateMetrics(); });

// ===== –ü–ª–æ–º–±–∞ =====
function genSealNo(){ return 'PL-'+Math.random().toString(36).slice(2,10).toUpperCase(); }
$('#genSeal').addEventListener('click',()=>{ $('#sealNew').value=genSealNo(); seal.new=$('#sealNew').value.trim(); log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ ‚Ññ –Ω–æ–≤–æ—ó –ø–ª–æ–º–±–∏: '+seal.new); updateMetrics(); });
$('#sealOld').addEventListener('input',()=>{ seal.old=$('#sealOld').value.trim(); updateMetrics(); });
$('#sealNew').addEventListener('input',()=>{ seal.new=$('#sealNew').value.trim(); updateMetrics(); });
$('#op').addEventListener('change',()=>{ op=$('#op').value; updateMetrics(); });

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ =====
let stream=null;
async function startCam(){
  try{ stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); $('#vid').srcObject=stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ'); }
  catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);
function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  const g=c.getContext('2d'); g.drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png'); photos[kind]=url; renderGallery(); log(`–§–æ—Ç–æ: ${kind}`); updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));
function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  if(photos.before){ const i=document.createElement('img'); i.className='photo'; i.src=photos.before; i.alt='–¥–æ'; gal.appendChild(i); }
  if(photos.closeup){ const i=document.createElement('img'); i.className='photo'; i.src=photos.closeup; i.alt='–∫—Ä—É–ø–Ω–∏–π –ø–ª–∞–Ω'; gal.appendChild(i); }
  if(photos.after){ const i=document.createElement('img'); i.className='photo'; i.src=photos.after; i.alt='–ø—ñ—Å–ª—è'; gal.appendChild(i); }
}

// ===== –ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞ =====
const sig=$('#sig'); const ctx=sig.getContext('2d');
let drawing=false, last=null, hasInk=false;
function xy(e){ const r=sig.getBoundingClientRect(); const t=e.touches? e.touches[0]:e; return {x:(t.clientX-r.left)*sig.width/r.width, y:(t.clientY-r.top)*sig.height/r.height}; }
function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke(); }
sig.addEventListener('pointerdown',e=>{ drawing=true; last=xy(e); hasInk=true; });
sig.addEventListener('pointermove',e=>{ if(!drawing) return; const p=xy(e); line(last,p); last=p; });
sig.addEventListener('pointerup',()=>{ drawing=false; last=null; });
sig.addEventListener('pointerleave',()=>{ drawing=false; last=null; });
$('#sigClear').addEventListener('click',()=>{ ctx.clearRect(0,0,sig.width,sig.height); hasInk=false; $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î'; updateMetrics(); });
$('#sigSave').addEventListener('click',()=>{ if(!hasInk){ alert('–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å—É'); return; } sigUrl=sig.toDataURL('image/png'); $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ'; const a=document.createElement('a'); a.href=sigUrl; a.download='signature_'+(CASE_ID||'case')+'_'+stamp()+'.png'; document.body.appendChild(a); a.click(); a.remove(); log('–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ (png)'); updateMetrics(); });

// ===== –ú–µ—Ç—Ä–∏–∫–∏ / —Å–∫–æ—Ä–∏–Ω–≥ =====
function updateMetrics(){
  $('#mCase').textContent=CASE_ID||'‚Äî';
  $('#mAsset').textContent=ASSET_ID||($('#asset').value||'‚Äî');
  $('#mOp').textContent= op==='sealed'?'–ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è':op==='unsealed'?'–†–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è':'–ó–∞–º—ñ–Ω–∞ –ø–ª–æ–º–±–∏';
  $('#mSeal').textContent= (seal.old?('—Å—Ç–∞—Ä–∞ '+seal.old):'‚Äî') + ' / ' + (seal.new?('–Ω–æ–≤–∞ '+seal.new):'‚Äî');
  $('#mPhotos').textContent= `${photos.before?1:0} / ${photos.closeup?1:0} / ${photos.after?1:0}`;
  $('#mSig').textContent= sigUrl?'—î':'‚Äî';
  let score=0;
  const caseOk=!!CASE_ID, assetOk=!!(ASSET_ID||clean($('#asset').value||'')), sealOk=((op==='sealed' && seal.new)|| (op==='unsealed' && (seal.old||seal.new)) || (op==='replaced' && (seal.old && seal.new)));
  const photosOk=!!photos.before && !!photos.closeup && !!photos.after;
  const sigOk=!!sigUrl;
  if(caseOk)score+=2; if(assetOk)score+=2; if(sealOk)score+=2; if(photosOk)score+=2; if(sigOk)score+=2;
  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML=html;
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR =====
function header(){
  return {
    case: CASE_ID||'‚Äî',
    date: $('#day').value||'‚Äî',
    addr: $('#addr').value||'‚Äî',
    tech: $('#tech').value||'‚Äî',
    op,
    asset: ASSET_ID||($('#asset').value||'‚Äî'),
    seal_old: seal.old||'‚Äî',
    seal_new: seal.new||'‚Äî',
    photos: {before:!!photos.before, closeup:!!photos.closeup, after:!!photos.after},
    signature: !!sigUrl
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const h=header();
  let csv='field,value\n';
  Object.entries(h).forEach(([k,v])=>{
    if(typeof v==='object'){ csv+=`${k},${JSON.stringify(v).replace(/,/g,';')}\n`; }
    else { csv+=`${k},${String(v).replace(/,/g,';')}\n`; }
  });
  download('gas_para05_seal_'+stamp()+'.csv', csv, 'text/csv'); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const h=header();
  const lines=[
    '–ü–∞—Ä–∞ 5 ‚Äî –ü–ª–æ–º–±—É–≤–∞–Ω–Ω—è/—Ä–æ–∑–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${h.case}`,
    `–î–∞—Ç–∞: ${h.date}`,
    `–ê–¥—Ä–µ—Å–∞: ${h.addr}`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${h.tech}`,
    `–û–ø–µ—Ä–∞—Ü—ñ—è: ${h.op}`,
    `–û–±‚Äô—î–∫—Ç (ID): ${h.asset}`,
    `–ü–ª–æ–º–±–∞: —Å—Ç–∞—Ä–∞=${h.seal_old}, –Ω–æ–≤–∞=${h.seal_new}`,
    `–§–æ—Ç–æ (–¥–æ/–∫—Ä—É–ø–Ω–∏–π/–ø—ñ—Å–ª—è): ${h.photos.before?'1':'0'} / ${h.photos.closeup?'1':'0'} / ${h.photos.after?'1':'0'}`,
    `–ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞: ${h.signature?'—î':'‚Äî'}`
  ];
  download('gas_para05_seal_'+stamp()+'.txt', lines.join('\n')); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const h=header(); const rc=$('#rc'); rc.hidden=false;
  const opTxt = h.op==='sealed'?'SEAL':'UNSEAL/REPL';
  const lines=[
'=== GAS SEAL (58–º–º) ===',
'Case: '+h.case,
'Date: '+h.date,
'Addr: '+h.addr,
'Tech: '+h.tech,
'Op:   '+opTxt,
'Asset:'+h.asset,
'Old:  '+h.seal_old,
'New:  '+h.seal_new,
'Photos:'+(h.photos.before?1:0)+'/'+(h.photos.closeup?1:0)+'/'+(h.photos.after?1:0),
'Signed:'+(h.signature?'Y':'N'),
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para05_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def = CASE_ID || ASSET_ID || 'gas-seal';
  const data = prompt('–í—Å—Ç–∞–≤ URL/ID (Case –∞–±–æ Asset):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –Ü–Ω—ñ—Ç
updateMetrics();
(function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
</script>
</body>
</html>
