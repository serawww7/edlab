<!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 4 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –û–≥–ª—è–¥ –≤–∏—Ç–æ–∫—ñ–≤: —Å–µ–Ω—Å–æ—Ä CH‚ÇÑ (–µ–º—É–ª—è—Ç–æ—Ä), –ø–æ—Ä–æ–≥–∏, –≥—Ä–∞—Ñ—ñ–∫, SOAP-—Ç–µ—Å—Ç, —Ñ–æ—Ç–æ/–∞—É–¥—ñ–æ, —á–µ–∫ 58 –º–º, CSV/QR</title>
<meta name="description" content="–ü—Ä–∞–∫—Ç–∏–∫–∞ –æ–≥–ª—è–¥—É –≤–∏—Ç–æ–∫—ñ–≤: –µ–º—É–ª—å–æ–≤–∞–Ω–∏–π –¥–∞—Ç—á–∏–∫ –º–µ—Ç–∞–Ω—É (ppm) –∑ –ø–æ—Ä–æ–≥–∞–º–∏, –∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫, SOAP-—Ç–µ—Å—Ç, —Ñ–æ—Ç–æ/–∞—É–¥—ñ–æ, NFC/ID, –∂—É—Ä–Ω–∞–ª, —á–µ–∫ 58 –º–º, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, QR.">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
</style>
<link rel="canonical" href="https://edlab.pp.ua/gas_II_kyrs/gas_para4.html"><meta property="og:type" content="article"><meta property="og:title" content="–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 4"><meta property="og:description" content="–Ü–Ω—Å–ø–µ–∫—Ç—É—î–º–æ –º–æ–∂–ª–∏–≤–∏–π –≤–∏—Ç—ñ–∫ –±—ñ–ª—è –∑‚Äô—î–¥–Ω–∞–Ω—å/–∫—Ä–∞–Ω—ñ–≤/—à–ª–∞–Ω–≥—ñ–≤. –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î–º–æ –æ–±‚Äô—î–∫—Ç, –≤–∏–º—ñ—Ä—é—î–º–æ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—é –º–µ—Ç–∞–Ω—É (ppm) –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –µ–º—É–ª—è—Ç–æ—Ä–∞ (—Å–ª–∞–π–¥–µ—Ä ‚Üí –ª–µ–≥–∫–æ"><meta property="og:url" content="https://edlab.pp.ua/gas_II_kyrs/gas_para4.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"–ì–∞–∑–æ–≤–∏–∫–∏ ‚Äî –ü–∞—Ä–∞ 4","description":"–Ü–Ω—Å–ø–µ–∫—Ç—É—î–º–æ –º–æ–∂–ª–∏–≤–∏–π –≤–∏—Ç—ñ–∫ –±—ñ–ª—è –∑‚Äô—î–¥–Ω–∞–Ω—å/–∫—Ä–∞–Ω—ñ–≤/—à–ª–∞–Ω–≥—ñ–≤. –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î–º–æ –æ–±‚Äô—î–∫—Ç, –≤–∏–º—ñ—Ä—é—î–º–æ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—é –º–µ—Ç–∞–Ω—É (ppm) –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –µ–º—É–ª—è—Ç–æ—Ä–∞ (—Å–ª–∞–π–¥–µ—Ä ‚Üí –ª–µ–≥–∫–æ","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/gas_II_kyrs/gas_para4.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">ü´ß</span>
      <div>
        <b>–ü–∞—Ä–∞ 4 ‚Äî –û–≥–ª—è–¥ –≤–∏—Ç–æ–∫—ñ–≤ –≥–∞–∑—É</b><br>
        <span class="badge">–°–µ–Ω—Å–æ—Ä CH‚ÇÑ (–µ–º—É–ª—è—Ç–æ—Ä) ‚Üí –ø–æ—Ä–æ–≥–∏ ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí SOAP-—Ç–µ—Å—Ç ‚Üí —Ñ–æ—Ç–æ/–∞—É–¥—ñ–æ ‚Üí —á–µ–∫ 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –°—Ü–µ–Ω–∞—Ä—ñ–π</h2>
    <p>–Ü–Ω—Å–ø–µ–∫—Ç—É—î–º–æ –º–æ–∂–ª–∏–≤–∏–π –≤–∏—Ç—ñ–∫ –±—ñ–ª—è –∑‚Äô—î–¥–Ω–∞–Ω—å/–∫—Ä–∞–Ω—ñ–≤/—à–ª–∞–Ω–≥—ñ–≤. –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î–º–æ –æ–±‚Äô—î–∫—Ç, –≤–∏–º—ñ—Ä—é—î–º–æ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—é –º–µ—Ç–∞–Ω—É (<b>ppm</b>) 
      –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –µ–º—É–ª—è—Ç–æ—Ä–∞ (—Å–ª–∞–π–¥–µ—Ä ‚Üí –ª–µ–≥–∫–æ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ <b>Arduino/MQ-4</b>), —Ñ—ñ–∫—Å—É—î–º–æ <b>–≥—Ä–∞—Ñ—ñ–∫</b> —ñ —á–∞—Å –≤–∏—â–µ –ø–æ—Ä–æ–≥—ñ–≤, 
      —Ä–æ–±–∏–º–æ <b>SOAP-—Ç–µ—Å—Ç</b> (–±—É–ª—å–±–∞—à–∫–∏/–Ω–µ–º–∞—î), –¥–æ–¥–∞—î–º–æ <b>—Ñ–æ—Ç–æ</b> —ñ <b>–∞—É–¥—ñ–æ-–∫–æ–º–µ–Ω—Ç–∞—Ä</b>, —Ñ–æ—Ä–º—É—î–º–æ <b>—á–µ–∫ 58 –º–º</b>, <b>CSV/TXT</b>, <b>QR</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. ..., –ø—ñ–¥‚Äô—ó–∑–¥/–∫–≤–∞—Ä—Ç–∏—Ä–∞"></label>
      <label style="flex:1">–ó–æ–Ω–∞/–≤—É–∑–æ–ª<input id="zone" class="input" placeholder="–ö—Ä–∞–Ω –ø–µ—Ä–µ–¥ –ø–ª–∏—Ç–æ—é / —Ä—ñ–∑—å–±–æ–≤–µ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è"></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."></label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –°–µ–Ω—Å–æ—Ä/–¢–µ—Å—Ç–∏/–ö–∞–º–µ—Ä–∞/–ê—É–¥—ñ–æ -->
    <div class="card">
      <h2>üõ∞Ô∏è –°–µ–Ω—Å–æ—Ä CH‚ÇÑ (–µ–º—É–ª—è—Ç–æ—Ä)</h2>
      <div class="row">
        <input type="range" id="ppm" class="input" min="0" max="1000" step="5" value="25" style="flex:1">
        <span class="badge">–ü–æ—Ç–æ—á–Ω–µ: <b id="ppmNum">25</b> ppm</span>
        <button class="btn" id="ppmMark">üìç –î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</button>
        <button class="btn secondary" id="ppmClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
      </div>
      <div class="row">
        <label>Info (ppm)<input id="thInfo" type="number" class="input" min="0" step="5" value="50"></label>
        <label>Warning (ppm)<input id="thWarn" type="number" class="input" min="0" step="5" value="200"></label>
        <label>Alarm (ppm)<input id="thAlarm" type="number" class="input" min="0" step="5" value="500"></label>
        <button class="btn secondary" id="applyTh">‚öôÔ∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–æ—Ä–æ–≥–∏</button>
      </div>
      <div class="kpi" style="margin-top:6px">
        <span class="tag ok">‚è±Ô∏è –ß–∞—Å &gt;Info: <b id="tInfo">0</b> —Å</span>
        <span class="tag warn">‚è±Ô∏è –ß–∞—Å &gt;Warn: <b id="tWarn">0</b> —Å</span>
        <span class="tag bad">‚è±Ô∏è –ß–∞—Å &gt;Alarm: <b id="tAlarm">0</b> —Å</span>
      </div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="chart" class="chart" width="520" height="220"></canvas></div>

      <h2 style="margin-top:10px">ü´ß SOAP-—Ç–µ—Å—Ç (–ø—ñ–Ω–∞)</h2>
      <div class="row">
        <select id="soap" class="input" style="max-width:260px">
          <option value="none" selected="">‚Äî –û–±–µ—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî</option>
          <option value="bubbles">–í–∏–¥–∏–º—ñ –±—É–ª—å–±–∞—à–∫–∏</option>
          <option value="no-bubbles">–ë—É–ª—å–±–∞—à–æ–∫ –Ω–µ–º–∞—î</option>
        </select>
        <button class="btn" id="soapMark">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        <span class="badge" id="soapState">‚Äî</span>
      </div>

      <h2 style="margin-top:10px">üé• –§–æ—Ç–æ (2 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay="" playsinline="" muted=""></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="area">üì∑ –ú—ñ—Å—Ü–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</button>
          <button class="btn" data-kind="manometer">üì∑ –ü—Ä–∏–ª–∞–¥/–º–∞–Ω–æ–º–µ—Ç—Ä</button><br>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">üéôÔ∏è –ê—É–¥—ñ–æ-–∫–æ–º–µ–Ω—Ç–∞—Ä</h2>
      <div class="row">
        <button class="btn" id="recStart">‚è∫Ô∏è –ó–∞–ø–∏—Å</button>
        <button class="btn secondary" id="recStop" disabled="">‚èπÔ∏è –°—Ç–æ–ø</button>
        <span class="badge" id="rstat">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É</span>
      </div>
      <audio id="player" controls="" style="margin-top:8px;max-width:100%"></audio>

      <h2 style="margin-top:10px">üì∂ NFC / ID –æ–±‚Äô—î–∫—Ç–∞</h2>
      <div class="block">
        <div class="row">
          <button class="btn" id="nfcBtn">üì∂ NFC</button>
          <input id="asset" class="input" placeholder="ID –æ–±‚Äô—î–∫—Ç–∞ (—è–∫—â–æ NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)">
          <button class="btn secondary" id="saveAsset">üíæ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <span class="badge" id="nfcs">–°—Ç–∞—Ç—É—Å NFC: –æ—á—ñ–∫—É—î—Ç—å—Å—è</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ú–µ—Ç—Ä–∏–∫–∏/–°—Ç–∞—Ç—É—Å/–ï–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ / —Å—Ç–∞–Ω</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>ID –æ–±‚Äô—î–∫—Ç–∞</th><td id="mAsset">‚Äî</td></tr>
          <tr><th>–¢–æ—á–æ–∫ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É</th><td id="mPts">0</td></tr>
          <tr><th>SOAP-—Ç–µ—Å—Ç</th><td id="mSoap">‚Äî</td></tr>
          <tr><th>–§–æ—Ç–æ (area/manometer)</th><td id="mPhotos">0 / 0</td></tr>
          <tr><th>–ê—É–¥—ñ–æ</th><td id="mAudio">‚Äî</td></tr>
          <tr><th>–ü–æ—Ä—É—à–µ–Ω–Ω—è –ø–æ—Ä–æ–≥—ñ–≤</th><td id="mThresh">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—Ä–æ–∫–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ (–∞–¥—Ä–µ—Å–∞/–∑–æ–Ω–∞/–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å/–¥–∞—Ç–∞) ‚Äî <b>2</b></li>
        <li>ID –æ–±‚Äô—î–∫—Ç–∞ (NFC/–∫–æ–¥) ‚Äî <b>2</b></li>
        <li>–ì—Ä–∞—Ñ—ñ–∫: ‚â•8 —Ç–æ—á–æ–∫ + –ø–æ—Ä–æ–≥–∏ ‚Äî <b>2</b></li>
        <li>SOAP-—Ç–µ—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ ‚Äî <b>1</b></li>
        <li>–§–æ—Ç–æ (–æ–±–∏–¥–≤–∞) ‚Äî <b>2</b></li>
        <li>–ê—É–¥—ñ–æ-–∫–æ–º–µ–Ω—Ç–∞—Ä ‚Äî <b>1</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (—Å–µ—Ä—ñ—è –≤–∏–º—ñ—Ä—ñ–≤ + –ø–æ–¥—ñ—ó)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case/Asset)</button>
      </div>
      <div id="rc" class="receipt" hidden=""></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:240px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}
$('#upd').textContent = new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –ö–µ–π—Å / —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è =====
let CASE_ID=null, ASSET_ID=null;
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||''); const zone=clean($('#zone').value||''); const tech=clean($('#tech').value||''); const day=$('#day').value;
  if(!addr||!zone||!tech||!day){ alert('–ó–∞–ø–æ–≤–Ω–∏ –∞–¥—Ä–µ—Å—É, –∑–æ–Ω—É, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —ñ –¥–∞—Ç—É'); return; }
  CASE_ID = 'L-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent = '–ö–µ–π—Å: '+CASE_ID;
  log(`–ö–µ–π—Å ${CASE_ID}: ${addr} (${zone}), ${tech}, ${day}`);
  updateMetrics();
});
async function tryNFC(){
  if('NDEFReader' in window){
    try{
      const reader=new NDEFReader(); await reader.scan();
      $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
      reader.addEventListener('reading', ({message, serialNumber})=>{
        let text=''; for(const rec of message.records){ if(rec.recordType==='text'){ const dec=new TextDecoder(rec.encoding||'utf-8'); text = dec.decode(rec.data); } }
        ASSET_ID = (text||serialNumber||'NFC-'+Math.random().toString(36).slice(2,7)).toString();
        $('#asset').value = ASSET_ID;
        $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑—á–∏—Ç–∞–Ω–æ';
        log('NFC: '+ASSET_ID);
        updateMetrics();
      });
    }catch(e){ $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –ø–æ–º–∏–ª–∫–∞'; alert('NFC –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π'); }
  }else{ alert('Web NFC –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –í–≤–µ–¥–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É.'); }
}
$('#nfcBtn').addEventListener('click', tryNFC);
$('#saveAsset').addEventListener('click',()=>{
  const v=clean($('#asset').value||''); if(!v){ alert('–í–≤–µ–¥–∏ ID –æ–±‚Äô—î–∫—Ç–∞'); return; }
  ASSET_ID=v; $('#nfcs').textContent='–°—Ç–∞—Ç—É—Å NFC: –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É'; log('ID –æ–±‚Äô—î–∫—Ç–∞: '+ASSET_ID); updateMetrics();
});

// ===== –°–µ–Ω—Å–æ—Ä CH4: –¥–∞–Ω—ñ/–ø–æ—Ä–æ–≥–∏/—Ç–∞–π–º–µ—Ä–∏ =====
const chart=$('#chart'), gc=chart.getContext('2d');
let series=[]; // {t, ppm}
let t0=null;
let thresh={info:50, warn:200, alarm:500};
let over={info:0, warn:0, alarm:0}; // —Å–µ–∫
let overFlags={info:false,warn:false,alarm:false};
function applyThresh(){
  thresh.info = Math.max(0, parseFloat($('#thInfo').value)||50);
  thresh.warn  = Math.max(thresh.info, parseFloat($('#thWarn').value)||200);
  thresh.alarm = Math.max(thresh.warn, parseFloat($('#thAlarm').value)||500);
  log(`–ü–æ—Ä–æ–≥–∏: Info ${thresh.info} / Warn ${thresh.warn} / Alarm ${thresh.alarm} ppm`);
  updateMetrics();
  drawChart();
}
$('#applyTh').addEventListener('click', applyThresh);
applyThresh();

function fmtSec(s){return Math.round(s);}
function updateOver(ppm, dt){
  const p=ppm;
  const info=p>thresh.info, warn=p>thresh.warn, alarm=p>thresh.alarm;
  if(info) over.info += dt; if(warn) over.warn += dt; if(alarm) over.alarm += dt;
  overFlags={info, warn, alarm};
  $('#tInfo').textContent=fmtSec(over.info);
  $('#tWarn').textContent=fmtSec(over.warn);
  $('#tAlarm').textContent=fmtSec(over.alarm);
}
function drawChart(){
  const W=chart.width,H=chart.height; gc.clearRect(0,0,W,H);
  gc.strokeStyle='#223049'; gc.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-24;
  // —Å—ñ—Ç–∫–∞
  gc.strokeStyle='#1f2a44';
  for(let y=0;y<5;y++){ const yy=top+y*(bottom-top)/4; gc.beginPath(); gc.moveTo(left,yy); gc.lineTo(right,yy); gc.stroke(); }
  // –æ—Å—å —á–∞—Å—É
  gc.strokeStyle='#334155'; gc.beginPath(); gc.moveTo(left,bottom); gc.lineTo(right,bottom); gc.stroke();
  if(series.length<2){ gc.fillStyle='#94a3b8'; gc.fillText('–î–æ–¥–∞–π —Ç–æ—á–∫–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å', left+8, top+14); return; }
  const tMin=series[0].t, tMax=series[series.length-1].t; const span=(tMax-tMin)||1;
  const ppmMax=Math.max(thresh.alarm, ...series.map(s=>s.ppm), 50);
  function X(t){ return left + (t - tMin)/span*(right-left); }
  function Y(v){ return bottom - (v/ppmMax)*(bottom-top); }
  // –ª—ñ–Ω—ñ—è
  gc.beginPath(); gc.strokeStyle='#38bdf8';
  series.forEach((p,i)=>{ const x=X(p.t), y=Y(p.ppm); if(i===0) gc.moveTo(x,y); else gc.lineTo(x,y); });
  gc.stroke();
  // —Ç–æ—á–∫–∏
  series.forEach(p=>{ const x=X(p.t), y=Y(p.ppm); gc.fillStyle='#38bdf8'; gc.fillRect(x-2,y-2,4,4); });
  // –ø–æ—Ä–æ–≥–∏
  gc.strokeStyle='#22c55e'; gc.beginPath(); gc.moveTo(left, Y(thresh.info)); gc.lineTo(right, Y(thresh.info)); gc.stroke();
  gc.strokeStyle='#fbbf24'; gc.beginPath(); gc.moveTo(left, Y(thresh.warn)); gc.lineTo(right, Y(thresh.warn)); gc.stroke();
  gc.strokeStyle='#f87171'; gc.beginPath(); gc.moveTo(left, Y(thresh.alarm)); gc.lineTo(right, Y(thresh.alarm)); gc.stroke();
  // –ø—ñ–¥–ø–∏—Å–∏
  gc.fillStyle='#94a3b8'; gc.font='11px ui-monospace';
  gc.fillText('ppm', 8, top+12);
  gc.fillStyle='#22c55e'; gc.fillText('Info', right-50, Y(thresh.info)-4);
  gc.fillStyle='#fbbf24'; gc.fillText('Warn', right-50, Y(thresh.warn)-4);
  gc.fillStyle='#f87171'; gc.fillText('Alarm', right-50, Y(thresh.alarm)-4);
}
function addPoint(ppm){
  const now=Date.now(); if(!t0) t0=now;
  series.push({t:now, ppm});
  const dt = series.length>1 ? (series[series.length-1].t - series[series.length-2].t)/1000 : 0;
  updateOver(ppm, Math.max(0,dt));
  drawChart();
  $('#mPts').textContent = String(series.length);
  updateMetrics();
}
$('#ppm').addEventListener('input',()=>{ $('#ppmNum').textContent=$('#ppm').value; });
$('#ppmMark').addEventListener('click',()=>{ const v=parseFloat($('#ppm').value); addPoint(v); log(`–¢–æ—á–∫–∞: ${v} ppm`); });
$('#ppmClear').addEventListener('click',()=>{ series=[]; t0=null; over={info:0,warn:0,alarm:0}; $('#tInfo').textContent='0';$('#tWarn').textContent='0';$('#tAlarm').textContent='0'; drawChart(); $('#mPts').textContent='0'; log('–û—á–∏—â–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫'); updateMetrics(); });

// ===== SOAP-—Ç–µ—Å—Ç =====
let soapResult=null;
$('#soapMark').addEventListener('click',()=>{
  const val=$('#soap').value;
  if(val==='none'){ alert('–û–±–µ—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç SOAP-—Ç–µ—Å—Ç—É'); return; }
  soapResult = val;
  $('#soapState').textContent = (val==='bubbles'?'–ë—É–ª—å–±–∞—à–∫–∏ –í–ò–Ø–í–õ–ï–ù–û':'–ë—É–ª—å–±–∞—à–æ–∫ –Ω–µ–º–∞—î');
  log('SOAP-—Ç–µ—Å—Ç: '+$('#soapState').textContent);
  updateMetrics();
});

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ =====
let stream=null; let photos={area:null, manometer:null};
async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    $('#vid').srcObject = stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ');
  }catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);
function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  const g=c.getContext('2d'); g.drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png'); photos[kind]=url; renderGallery();
  log(`–§–æ—Ç–æ: ${kind}`); updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));
function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  if(photos.area){ const i=document.createElement('img'); i.className='photo'; i.src=photos.area; i.alt='area'; gal.appendChild(i); }
  if(photos.manometer){ const i=document.createElement('img'); i.className='photo'; i.src=photos.manometer; i.alt='manometer'; gal.appendChild(i); }
}

// ===== –ê—É–¥—ñ–æ =====
let mediaRec=null; let chunks=[]; let audioUrl=null;
$('#recStart').addEventListener('click', async ()=>{
  try{
    const st = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    mediaRec = new MediaRecorder(st);
    chunks=[];
    mediaRec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
    mediaRec.onstop = ()=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      audioUrl = URL.createObjectURL(blob);
      $('#player').src=audioUrl;
      $('#rstat').textContent='–ó–∞–ø–∏—Å –≥–æ—Ç–æ–≤–∏–π';
      const a=document.createElement('a'); a.href=audioUrl; a.download='voice_'+(CASE_ID||'case')+'_'+stamp()+'.webm'; document.body.appendChild(a); a.click(); a.remove();
      log('–ê—É–¥—ñ–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ (webm)'); updateMetrics();
    };
    mediaRec.start();
    $('#recStart').disabled=true; $('#recStop').disabled=false;
    $('#rstat').textContent='–ô–¥–µ –∑–∞–ø–∏—Å...'; log('–ü–æ—á–∞—Ç–æ –∞—É–¥—ñ–æ–∑–∞–ø–∏—Å');
  }catch(e){ alert('–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'); }
});
$('#recStop').addEventListener('click', ()=>{
  if(mediaRec && mediaRec.state!=='inactive'){ mediaRec.stop(); }
  $('#recStart').disabled=false; $('#recStop').disabled=true;
});

// ===== –ú–µ—Ç—Ä–∏–∫–∏ / —Å—Ç–∞—Ç—É—Å =====
function updateMetrics(){
  $('#mCase').textContent = CASE_ID || '‚Äî';
  $('#mAsset').textContent = ASSET_ID || ($('#asset').value||'‚Äî');
  $('#mSoap').textContent = soapResult? (soapResult==='bubbles'?'–ë—É–ª—å–±–∞—à–∫–∏ –í–ò–Ø–í–õ–ï–ù–û':'–ù–µ–º–∞—î') : '‚Äî';
  $('#mPhotos').textContent = `${photos.area?1:0} / ${photos.manometer?1:0}`;
  $('#mAudio').textContent = audioUrl?'—î':'‚Äî';
  // –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø–æ—Ä–æ–≥—ñ–≤
  const anyInfo = series.some(s=>s.ppm>thresh.info);
  const anyWarn = series.some(s=>s.ppm>thresh.warn);
  const anyAlarm= series.some(s=>s.ppm>thresh.alarm);
  $('#mThresh').textContent = anyAlarm? 'ALARM' : anyWarn? 'WARNING' : anyInfo? 'INFO' : '‚Äî';
  // —Å–∫–æ—Ä–∏–Ω–≥
  let score=0;
  const caseOk=!!CASE_ID, assetOk=!!(ASSET_ID||clean($('#asset').value||'')); 
  const chartOk=series.length>=8;
  const soapOk=!!soapResult && soapResult!=='none';
  const photosOk=!!photos.area && !!photos.manometer;
  const audioOk=!!audioUrl;
  if(caseOk)score+=2; if(assetOk)score+=2; if(chartOk)score+=2; if(soapOk)score+=1; if(photosOk)score+=2; if(audioOk)score+=1;
  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML = html;
}
drawChart();

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR =====
function summary(){
  const addr=$('#addr').value||'‚Äî', zone=$('#zone').value||'‚Äî', tech=$('#tech').value||'‚Äî', day=$('#day').value||'‚Äî';
  const pt = series.map(p=>({t:new Date(p.t).toISOString(), ppm:p.ppm}));
  return {
    case: CASE_ID||'‚Äî', addr, zone, tech, day,
    asset: ASSET_ID||($('#asset').value||'‚Äî'),
    thresholds: {...thresh},
    over_seconds: {...over},
    soap: soapResult||'‚Äî',
    photos: {area:!!photos.area, manometer:!!photos.manometer},
    audio: !!audioUrl,
    points: pt
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const s=summary();
  let csv='field,value\n';
  Object.entries(s).forEach(([k,v])=>{
    if(Array.isArray(v)){} else if(typeof v==='object'){ csv+=`${k},${JSON.stringify(v).replace(/,/g,';')}\n`; }
    else { csv+=`${k},${String(v).replace(/,/g,';')}\n`; }
  });
  csv+='\n# points\niso_time,ppm\n';
  s.points.forEach(p=>{ csv+=`${p.t},${p.ppm}\n`; });
  download('gas_para04_leak_'+stamp()+'.csv', csv, 'text/csv'); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const s=summary();
  const lines=[
    '–ü–∞—Ä–∞ 4 ‚Äî –û–≥–ª—è–¥ –≤–∏—Ç–æ–∫—ñ–≤: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${s.case}`, `–ê–¥—Ä–µ—Å–∞: ${s.addr}`, `–ó–æ–Ω–∞: ${s.zone}`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${s.tech}`, `–î–∞—Ç–∞: ${s.day}`,
    `–û–±‚Äô—î–∫—Ç (ID): ${s.asset}`,
    `–ü–æ—Ä–æ–≥–∏ (ppm): Info ${s.thresholds.info} / Warn ${s.thresholds.warn} / Alarm ${s.thresholds.alarm}`,
    `–ß–∞—Å –≤–∏—â–µ –ø–æ—Ä–æ–≥—ñ–≤ (—Å): Info ${Math.round(s.over_seconds.info)} / Warn ${Math.round(s.over_seconds.warn)} / Alarm ${Math.round(s.over_seconds.alarm)}`,
    `SOAP-—Ç–µ—Å—Ç: ${s.soap==='bubbles'?'–±—É–ª—å–±–∞—à–∫–∏ –í–ò–Ø–í–õ–ï–ù–û':s.soap==='no-bubbles'?'–±—É–ª—å–±–∞—à–æ–∫ –Ω–µ–º–∞—î':'‚Äî'}`,
    `–§–æ—Ç–æ area/manometer: ${s.photos.area?'1':'0'} / ${s.photos.manometer?'1':'0'}`,
    `–ê—É–¥—ñ–æ: ${s.audio?'—î':'‚Äî'}`,
    `–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫: ${s.points.length}`
  ];
  download('gas_para04_leak_'+stamp()+'.txt', lines.join('\n')); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const s=summary(); const rc=$('#rc'); rc.hidden=false;
  const lines=[
'=== GAS LEAK CHECK (58–º–º) ===',
'Case: '+s.case,
'Date: '+s.day,
'Addr: '+s.addr,
'Zone: '+s.zone,
'Tech: '+s.tech,
'Asset:'+s.asset,
'Pts:  '+s.points.length,
'SOAP: '+(s.soap==='bubbles'?'BUBBLES':'NO'),
'Thr:  I'+s.thresholds.info+'/W'+s.thresholds.warn+'/A'+s.thresholds.alarm,
'Over: I'+Math.round(s.over_seconds.info)+'s W'+Math.round(s.over_seconds.warn)+'s A'+Math.round(s.over_seconds.alarm)+'s',
'Photos:'+(s.photos.area?1:0)+'/'+(s.photos.manometer?1:0)+' Audio:'+(s.audio?'Y':'N'),
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para04_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def = CASE_ID || ASSET_ID || 'gas-leak';
  const data = prompt('–í—Å—Ç–∞–≤ URL/ID (Case –∞–±–æ Asset):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –ü—ñ–¥–∫–∞–∑–∫–∞ –¥–ª—è Arduino (–æ—Ñ–ª–∞–π–Ω –Ω–æ—Ç–∞—Ç–∫–∞ —É –∫–æ–¥—ñ)
// –Ø–∫—â–æ –ø—ñ–¥–∫–ª—é—á–∏—à MQ-4/—ñ–Ω—à–∏–π –¥–∞—Ç—á–∏–∫, –∑–∞–º—ñ–Ω–∏ addPoint(parseFloat($('#ppm').value))
// –Ω–∞ –∑–Ω–∞—á–µ–Ω–Ω—è, —â–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —ñ–∑ —Å–µ—Ä—ñ–π–Ω–æ–≥–æ –ø–æ—Ä—Ç—É/–≤–µ–±-—Å–æ–∫–µ—Ç–∞. –í–∞–ª—ñ–¥—É–π 0..10000 ppm.

// ===== –í–±—É–¥–æ–≤–∞–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
(function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
</script>


</body></html>