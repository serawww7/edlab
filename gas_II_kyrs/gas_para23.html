<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 23 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî AI-–∞—Ä—Ö—ñ–≤ –∞–∫—Ç—ñ–≤: PDF/JPEG ‚Üí —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ ‚Üí –ø–æ—à—É–∫ ‚Üí –¥—É–±–ª—ñ–∫–∞—Ç–∏ ‚Üí –¥–∞—à–±–æ—Ä–¥ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</title>
<meta name="description" content="AI-–∞—Ä—Ö—ñ–≤: –∑–∞–≤–∞–Ω—Ç–∞–∂ PDF/JPEG –∞–∫—Ç—ñ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏—Ç—è–≥ —Ä–µ–∫–≤—ñ–∑–∏—Ç—ñ–≤ (‚Ññ, –¥–∞—Ç–∞, –∞–¥—Ä–µ—Å–∞, –∞–±–æ–Ω–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç, –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π), –ø–æ—à—É–∫/—Ñ—ñ–ª—å—Ç—Ä–∏, –¥—É–±–ª—ñ–∫–∞—Ç–∏, –¥–∞—à–±–æ—Ä–¥, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:100px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
pre.log{max-height:220px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
canvas.chart{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.pie{display:block;width:100%;height:220px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
.kpi .card{margin-top:0}
@media(max-width:900px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üóÇÔ∏èü§ñ</span>
      <div>
        <b>–ü–∞—Ä–∞ 23 ‚Äî AI-–∞—Ä—Ö—ñ–≤ –∞–∫—Ç—ñ–≤</b><br/>
        <span class="badge">PDF/JPEG ‚Üí —Ç–µ–∫—Å—Ç ‚Üí —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ ‚Üí —Ñ—ñ–ª—å—Ç—Ä–∏/–ø–æ—à—É–∫ ‚Üí –¥—É–±–ª—ñ–∫–∞—Ç–∏ ‚Üí –¥–∞—à–±–æ—Ä–¥ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥ / –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂ <b>PDF</b> –∞–±–æ <b>–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</b> –∞–∫—Ç—ñ–≤ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –≤–∏—Ç—è–≥–Ω–µ —Ç–µ–∫—Å—Ç, —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç—å <b>‚Ññ –∞–∫—Ç–∞, –¥–∞—Ç—É/—á–∞—Å, –∞–¥—Ä–µ—Å—É, –∞–±–æ–Ω–µ–Ω—Ç–∞, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (P1/P2/P3), –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ–≥–æ</b>, 
    –ø–æ–∑–Ω–∞—á–∏—Ç—å <b>–¥—É–±–ª—ñ–∫–∞—Ç–∏</b>, –Ω–∞–¥–∞—Å—Ç—å <b>–ø–æ—à—É–∫</b> —ñ <b>—Ñ—ñ–ª—å—Ç—Ä–∏</b>, –ø–æ–±—É–¥—É—î <b>–¥–∞—à–±–æ—Ä–¥</b>, –∑–±–µ—Ä–µ–∂–µ —É <b>CSV/TXT</b> —ñ –∑–≥–µ–Ω–µ—Ä—É—î <b>QR</b> –Ω–∞ –ø–∞–ø–∫—É –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª–∞–º–∏.</p>
    <div class="row">
      <input id="files" type="file" accept=".pdf,image/*" multiple class="input" style="max-width:420px"/>
      <button class="btn" id="run">‚ñ∂Ô∏è –û–±—Ä–æ–±–∏—Ç–∏</button>
      <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
      <span class="badge">–§–∞–π–ª—ñ–≤: <b id="nFiles">0</b></span>
      <span class="badge">–ê–∫—Ç—ñ–≤: <b id="nActs">0</b></span>
      <span class="badge">–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤: <b id="nDup">0</b></span>
    </div>
    <div class="row">
      <label>–ü–æ—à—É–∫ (—Ç–µ–∫—Å—Ç/–∞–¥—Ä–µ—Å–∞/‚Ññ/—Ç–µ–ª) <input id="q" class="input" placeholder="–ù–∞–ø—Ä.: –°–∏–º–∏—Ä–µ–Ω–∫–∞ 12 –∞–±–æ ACT-2025-001"></label>
      <label>–í—ñ–¥ <input id="from" class="input" type="date"></label>
      <label>–î–æ <input id="to" class="input" type="date"></label>
      <label>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
        <select id="prio" class="input">
          <option value="">–≤—Å—ñ</option>
          <option>P1</option><option>P2</option><option>P3</option>
        </select>
      </label>
      <label>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π <input id="resp" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ/–±—Ä–∏–≥–∞–¥–∞"></label>
      <button class="btn good" id="apply">üîé –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
      <button class="btn secondary" id="reset">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: —Ç–∞–±–ª–∏—Ü—è -->
    <div class="card">
      <h2>üßæ –ê–∫—Ç–∏ (–≤–∏—Ç—è–≥–Ω—É—Ç—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏)</h2>
      <table class="tbl" id="tbl">
        <thead>
          <tr>
            <th>#</th><th>–§–∞–π–ª</th><th>‚Ññ –∞–∫—Ç–∞</th><th>–î–∞—Ç–∞/—á–∞—Å</th><th>–ê–¥—Ä–µ—Å–∞</th><th>–ê–±–æ–Ω–µ–Ω—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ü—Ä—ñ–æ—Ä</th><th>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</th><th>–î—É–±–ª—å?</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="10" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / QR</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–∞–ø–∫–∞ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª–∞–º–∏)</button>
      </div>
      <div style="margin-top:8px"><canvas id="qr" width="220" height="220" style="background:#0b1220;border:1px solid var(--line);border-radius:12px"></canvas></div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –¥–∞—à–±–æ—Ä–¥ -->
    <div class="card">
      <h2>üìä –î–∞—à–±–æ—Ä–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ</h2>

      <div class="kpi">
        <div class="card"><span class="tag ok">–í—Å—å–æ–≥–æ –∞–∫—Ç—ñ–≤: <b id="kAll">0</b></span></div>
        <div class="card"><span class="tag bad">P1: <b id="kP1">0</b></span></div>
        <div class="card"><span class="tag warn">P2: <b id="kP2">0</b></span></div>
        <div class="card"><span class="tag ok">P3: <b id="kP3">0</b></span></div>
      </div>

      <h3 style="margin-top:10px">üìà –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ –ø–æ –¥–∞—Ç–∞—Ö</h3>
      <canvas id="cBar" class="chart" width="520" height="220"></canvas>

      <h3 style="margin-top:10px">üèÖ –¢–æ–ø-–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ (–∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –∞–∫—Ç—ñ–≤)</h3>
      <canvas id="cTop" class="chart" width="520" height="220"></canvas>

      <h3 style="margin-top:10px">‚òÄÔ∏è ¬´–°–æ–Ω–µ—á–∫–æ¬ª –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤</h3>
      <canvas id="cPie" class="pie" width="520" height="220"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–ó–∞–≤–∞–Ω—Ç–∞–∂ 5‚Äì10 –∞–∫—Ç—ñ–≤ —É PDF/JPEG. –ü–µ—Ä–µ–≤—ñ—Ä, —â–æ AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏—Ç—è–≥–Ω—É–≤ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏, —ñ –≤–∏–ø—Ä–∞–≤–∏ –ø–æ–º–∏–ª–∫–∏ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ —Ç–∞–±–ª–∏—Ü—ñ (–ø–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –ø–æ –∫–ª—ñ—Ç–∏–Ω—Ü—ñ).</li>
      <li>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π —Ñ—ñ–ª—å—Ç—Ä–∏ (–¥–∞—Ç–∞/–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç/–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π), —Å—Ñ–æ—Ä–º—É–π –≤–∏–±—ñ—Ä–∫—É ¬´—Ä–∏–∑–∏–∫–æ–≤–∏—Ö¬ª —ñ –µ–∫—Å–ø–æ—Ä—Ç—É–π —É CSV/TXT.</li>
      <li>–£–≤—ñ–º–∫–Ω–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ (—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ): –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π, —á–æ–º—É –≤–æ–Ω–∏ –≤–∏–Ω–∏–∫–ª–∏, —ñ —è–∫ —É–Ω–∏–∫–∞—Ç–∏ –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ.</li>
      <li>–ü–æ–∫–∞–∂–∏ –¥–∞—à–±–æ—Ä–¥ –±—Ä–∏–≥–∞–¥–∏—Ä—É: —Ä–æ–∑–ø–æ–¥—ñ–ª P1/P2/P3, –ø—ñ–∫–æ–≤—ñ –¥–Ω—ñ, —Ç–æ–ø –≤—ñ–¥–≤–æ–≤—ñ–¥–∞–ª—å–Ω—ñ. –°—Ñ–æ—Ä–º—É–ª—é–π –≤–∏—Å–Ω–æ–≤–∫–∏ –π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó.</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<!-- –õ—ñ–±–∏ –¥–ª—è –≤–∏—Ç—è–≥—É —Ç–µ–∫—Å—Ç—É -->
<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
<script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏/UI ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');
function norm(s){return String(s||'').normalize('NFKC').replace(/\s+/g,' ').trim();}
function onlyDigits(s){return String(s||'').replace(/\D+/g,'');}

/* ===== –°—Ç–∞–Ω ===== */
let FILES=[];           // {name,type,blob}
let RECORDS=[];         // {id,name,actNo,date,address,abonent,phone,priority,responsible,dupKey,dupFlag,text}
let FILTERS={q:'',from:'',to:'',prio:'',resp:''};

/* ===== –ü–æ–¥—ñ—ó –∫–µ—Ä—É–≤–∞–Ω–Ω—è ===== */
$('#files').addEventListener('change', (e)=>{
  FILES = Array.from(e.target.files||[]);
  $('#nFiles').textContent=String(FILES.length);
  log(`–û–±—Ä–∞–Ω–æ —Ñ–∞–π–ª—ñ–≤: ${FILES.length}`);
});
$('#clear').addEventListener('click', ()=>{
  FILES=[]; RECORDS=[]; $('#files').value=''; $('#nFiles').textContent='0'; $('#nActs').textContent='0'; $('#nDup').textContent='0';
  $('#tbody').innerHTML='<tr><td colspan="10" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr>';
  drawBar([]); drawTop([]); drawPie(0,0,0);
  kpis(0,0,0,0);
  log('–°–∫–∏–Ω—É—Ç–æ —Å—Ç–∞–Ω');
});
$('#run').addEventListener('click', processAll);
$('#apply').addEventListener('click', ()=>{
  FILTERS={ q:$('#q').value.trim(), from:$('#from').value, to:$('#to').value, prio:$('#prio').value, resp:$('#resp').value.trim() };
  renderTable(); renderDash();
});
$('#reset').addEventListener('click', ()=>{
  $('#q').value=''; $('#from').value=''; $('#to').value=''; $('#prio').value=''; $('#resp').value='';
  FILTERS={q:'',from:'',to:'',prio:'',resp:''}; renderTable(); renderDash();
});

/* ===== –í–∏—Ç—è–≥ —Ç–µ–∫—Å—Ç—É –∑ PDF/JPEG ===== */
async function extractFromPDF(file){
  const array = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:array}).promise;
  let text=''; 
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    text += content.items.map(it=>it.str).join(' ') + '\n';
  }
  return text;
}
async function extractFromImage(file){
  const data = await file.arrayBuffer();
  const blob = new Blob([data], {type:file.type});
  const url = URL.createObjectURL(blob);
  const img = new Image(); img.src=url; await img.decode();
  // downscale –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
  const W=Math.min(img.naturalWidth, 1800), H=Math.round(img.naturalHeight*(W/img.naturalWidth));
  const c=document.createElement('canvas'); c.width=W; c.height=H; const g=c.getContext('2d');
  g.drawImage(img,0,0,W,H);
  URL.revokeObjectURL(url);
  const { data: { text } } = await Tesseract.recognize(c, 'uk+eng', { preserve_interword_spaces:'1' });
  return text;
}

/* ===== –ü–∞—Ä—Å–µ—Ä —Ä–µ–∫–≤—ñ–∑–∏—Ç—ñ–≤ ===== */
const RX={
  actNo: /(–ê–∫—Ç|–ê–∫—Ç\s*‚Ññ|‚Ññ\s*–∞–∫—Ç–∞|Act|ACT|‚Ññ)\s*[:#\-]?\s*([A-Z–ê-–Ø–Ü–á–Ñ“ê]{1,4}[- ]?\d{2,4}[- ]?\d{2,6}|\d{5,10})/ui,
  date: /(\b\d{4}[-./]\d{1,2}[-./]\d{1,2}\b|\b\d{1,2}[./-]\d{1,2}[./-]\d{2,4}\b)(?:\s+[T ]?(\d{1,2}[:.]\d{2}))?/,
  phone: /(?:\+?380|0)\s?\d{2}\s?\d{3}\s?\d{2}\s?\d{2}|\+?38\s?0\d{2}[-\s]?\d{3}[-\s]?\d{2}[-\s]?\d{2}/,
  abon: /(–∞–±–æ–Ω–µ–Ω—Ç|–∫–ª—ñ—î–Ω—Ç|–∑–∞–º–æ–≤–Ω–∏–∫)\s*[:\-]?\s*([A-Z–ê-–Ø–Ü–á–Ñ“ê][\p{L} º‚Äô'\-]+(?:\s+[A-Z–ê-–Ø–Ü–á–Ñ“ê][\p{L} º‚Äô'\-]+){0,2}|–¢–û–í ¬´[^¬ª]+¬ª|–§–û–ü [^.,;]+)/ui,
  addr: /(–º\.|–º—ñ—Å—Ç–æ|–ö–∏—ó–≤|–ë—Ä–æ–≤–∞—Ä–∏|–Ü—Ä–ø—ñ–Ω—å|–ë—É—á–∞|–ë—ñ–ª–∞ –¶–µ—Ä–∫–≤–∞|–í–∏—à–Ω–µ–≤–µ|–û–±—É—Ö—ñ–≤|[\p{Lu}\p{Ll} º‚Äô\-]+)\s*,?\s*(–≤—É–ª\.|–≤—É–ª–∏—Ü—è|–ø—Ä–æ—Å–ø\.|–ø—Ä–æ—Å–ø–µ–∫—Ç|–±—É–ª—å–≤\.|–ø—Ä–æ–≤\.|–ø—Ä–æ–≤—É–ª–æ–∫|—à–æ—Å–µ|–ø—Ä-—Ç)\s*[\p{L}\d\s\-.]+(?:,\s*(?:–∫–≤\.|–æ—Ñ\.)\s*\d+)?/ui,
  prio: /\b(P[123])\b/,
  resp: /(–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω(–∏–π|–∞)|–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å|–±—Ä–∏–≥–∞–¥–∞)\s*[:\-]?\s*([A-Z–ê-–Ø–Ü–á–Ñ“ê][\p{L} º‚Äô'\-]+(?:\s+[A-Z–ê-–Ø–Ü–á–Ñ“ê][\p{L} º‚Äô'\-]+)?)/ui
};
function parseText(name, text){
  const t=norm(text);
  const mNo=t.match(RX.actNo); const actNo = mNo? mNo[2].replace(/\s+/g,'').toUpperCase() : '';
  const mDt=t.match(RX.date); let date='', time='';
  if(mDt){ date=mDt[1].replace(/[.]/g,'-'); time=(mDt[2]||'').replace('.',':'); }
  const mPh=t.match(RX.phone); const phone=mPh? mPh[0].replace(/\s+/g,''): '';
  const mAb=t.match(RX.abon); const abonent=mAb? norm(mAb[2]) : '';
  const mAd=t.match(RX.addr); const address=mAd? norm(mAd[0]) : '';
  const mPr=t.match(RX.prio); const priority=mPr? mPr[1].toUpperCase() : '';
  const mRs=t.match(RX.resp); const responsible=mRs? norm(mRs[3]) : '';
  const iso = toISO(date, time);
  return {name, actNo, date:iso, address, abonent, phone, priority, responsible, text:t};
}
function toISO(d, t){
  if(!d) return '';
  let [y,m,dd]=d.includes('-')? d.split('-'): d.split(/[./]/).reverse();
  if(y.length===2) y='20'+y;
  m=m.padStart(2,'0'); dd=dd.padStart(2,'0');
  let hh='00', mm='00';
  if(t){ [hh,mm]=t.split(':'); hh=hh.padStart(2,'0'); mm=mm.padStart(2,'0'); }
  return `${y}-${m}-${dd}${t? ' '+hh+':'+mm:''}`;
}

/* ===== –î—É–±–ª—ñ–∫–∞—Ç–æ—Ä: –∫–ª—é—á + —Å—Ö–æ–∂—ñ—Å—Ç—å –∞–¥—Ä–µ—Å–∏ ===== */
function jaccard(a,b){
  const ta=new Set(norm(a).toLowerCase().split(/[^a-z–∞-—è—ñ—ó—î“ë0-9]+/i).filter(Boolean));
  const tb=new Set(norm(b).toLowerCase().split(/[^a-z–∞-—è—ñ—ó—î“ë0-9]+/i).filter(Boolean));
  const inter=[...ta].filter(x=>tb.has(x)).length;
  return inter / Math.max(1, new Set([...ta,...tb]).size);
}
function duplicateFlag(r, i, all){
  // –¥—É–±–ª—å —è–∫—â–æ: —Å–ø—ñ–≤–ø–∞–≤ ‚Ññ –∞–∫—Ç–∞ (–Ω–µ–ø–æ—Ä–æ–∂–Ω—ñ–π) –ê–ë–û (–¥–∞—Ç–∞ –±–ª–∏–∑—å–∫–∞ —ñ –∞–¥—Ä–µ—Å–∞ –¥—É–∂–µ —Å—Ö–æ–∂–∞)
  if(r.actNo){
    const sameNo = all.findIndex((x,idx)=> idx<i && x.actNo && x.actNo===r.actNo);
    if(sameNo>=0) return {dup:true, reason:'–û–¥–Ω–∞–∫–æ–≤–∏–π ‚Ññ –∞–∫—Ç–∞'};
  }
  if(r.date && r.address){
    const sameDay = all.findIndex((x,idx)=>{
      if(idx>=i || !x.date || !x.address) return false;
      return x.date.slice(0,10)===r.date.slice(0,10) && jaccard(x.address, r.address)>=0.7;
    });
    if(sameDay>=0) return {dup:true, reason:'–°—Ö–æ–∂–∞ –∞–¥—Ä–µ—Å–∞ –≤ —Ç–æ–π —Å–∞–º–∏–π –¥–µ–Ω—å'};
  }
  return {dup:false, reason:''};
}

/* ===== –û–±—Ä–æ–±–∫–∞ –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤ ===== */
async function processAll(){
  if(!FILES.length){ alert('–ù–µ –æ–±—Ä–∞–Ω–æ —Ñ–∞–π–ª—ñ–≤'); return; }
  RECORDS=[]; $('#tbody').innerHTML='<tr><td colspan="10" class="muted">‚Äî –æ–±—Ä–æ–±–∫–∞‚Ä¶ ‚Äî</td></tr>';
  for(let i=0;i<FILES.length;i++){
    const f=FILES[i];
    try{
      const text = f.type==='application/pdf'? await extractFromPDF(f) : await extractFromImage(f);
      const rec = parseText(f.name, text);
      RECORDS.push({...rec, id:i+1});
      log(`OK: ${f.name} ‚Üí –∞–∫—Ç ${rec.actNo||'‚Äî'}; –¥–∞—Ç–∞ ${rec.date||'‚Äî'}`);
    }catch(e){
      log(`–ü–æ–º–∏–ª–∫–∞: ${f.name} (${e.message||e})`);
    }
  }
  // –ø–æ–∑–Ω–∞—á–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏
  let dupCount=0;
  for(let i=0;i<RECORDS.length;i++){
    const r=RECORDS[i];
    const d=duplicateFlag(r,i,RECORDS);
    r.dupFlag=d.dup; r.dupKey=d.reason;
    if(d.dup) dupCount++;
  }
  $('#nActs').textContent=String(RECORDS.length);
  $('#nDup').textContent=String(dupCount);
  renderTable(); renderDash();
}

/* ===== –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ + inline-—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ===== */
function renderTable(){
  const tb=$('#tbody'); tb.innerHTML='';
  const rows = applyFilters(RECORDS);
  if(rows.length===0){ tb.innerHTML='<tr><td colspan="10" class="muted">‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî</td></tr>'; return; }
  rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${escapeHtml(r.name)}</td>
      <td data-k="actNo">${escapeHtml(r.actNo||'‚Äî')}</td>
      <td data-k="date">${escapeHtml(r.date||'‚Äî')}</td>
      <td data-k="address">${escapeHtml(r.address||'‚Äî')}</td>
      <td data-k="abonent">${escapeHtml(r.abonent||'‚Äî')}</td>
      <td data-k="phone">${escapeHtml(r.phone||'‚Äî')}</td>
      <td data-k="priority" class="${r.priority==='P1'?'bad':r.priority==='P2'?'warn':'ok'}"><b>${escapeHtml(r.priority||'‚Äî')}</b></td>
      <td data-k="responsible">${escapeHtml(r.responsible||'‚Äî')}</td>
      <td>${r.dupFlag? '<span class="tag bad">–î—É–±–ª—å ‚Ä¢ '+escapeHtml(r.dupKey)+'</span>':'‚Äî'}</td>`;
    // inline edit
    tr.querySelectorAll('[data-k]').forEach(td=>{
      td.addEventListener('dblclick',()=>{
        const k=td.dataset.k, old=td.textContent.trim();
        const inp=document.createElement('input'); inp.className='input'; inp.value=old==='‚Äî'?'':old;
        td.innerHTML=''; td.appendChild(inp); inp.focus();
        inp.addEventListener('blur',()=>{ const v=inp.value.trim(); td.innerHTML=escapeHtml(v||'‚Äî'); r[k]=v; renderDash(); });
        inp.addEventListener('keydown',e=>{ if(e.key==='Enter') inp.blur(); });
      });
    });
    tb.appendChild(tr);
  });
}

function applyFilters(arr){
  const q=FILTERS.q.toLowerCase();
  const from=FILTERS.from? new Date(FILTERS.from): null;
  const to=FILTERS.to? new Date(FILTERS.to): null;
  return arr.filter(r=>{
    if(q){
      const hay=(r.name+' '+r.actNo+' '+r.address+' '+r.abonent+' '+r.phone).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(from && r.date){ if(new Date(r.date) < from) return false; }
    if(to && r.date){ if(new Date(r.date) > new Date(to.getTime()+24*3600*1000)) return false; }
    if(FILTERS.prio && r.priority!==FILTERS.prio) return false;
    if(FILTERS.resp && !norm(r.responsible).toLowerCase().includes(norm(FILTERS.resp).toLowerCase())) return false;
    return true;
  });
}

/* ===== –î–∞—à–±–æ—Ä–¥ ===== */
const cBar=$('#cBar'), gb=cBar.getContext('2d');
const cTop=$('#cTop'), gt=cTop.getContext('2d');
const cPie=$('#cPie'), gp=cPie.getContext('2d');

function kpis(all,p1,p2,p3){ $('#kAll').textContent=all; $('#kP1').textContent=p1; $('#kP2').textContent=p2; $('#kP3').textContent=p3; }

function renderDash(){
  const rows=applyFilters(RECORDS);
  const p1=rows.filter(r=>r.priority==='P1').length;
  const p2=rows.filter(r=>r.priority==='P2').length;
  const p3=rows.filter(r=>r.priority==='P3').length;
  kpis(rows.length,p1,p2,p3);

  // –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ –ø–æ –¥–∞—Ç–∞—Ö (YYYY-MM-DD)
  const byDay={};
  rows.forEach(r=>{ const d=(r.date||'').slice(0,10)||'(–±–µ–∑ –¥–∞—Ç–∏)'; byDay[d]=(byDay[d]||0)+1; });
  const X=Object.keys(byDay).sort(); const Y=X.map(k=>byDay[k]);
  drawBar(X.map((d,i)=>({x:d,y:Y[i]})));

  // –¢–æ–ø –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ
  const byResp={};
  rows.forEach(r=>{ const k=r.responsible||'(‚Äî)'; byResp[k]=(byResp[k]||0)+1; });
  const top = Object.entries(byResp).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([k,v])=>({x:k,y:v}));
  drawTop(top);

  // –ü–∏—Ä—ñ–≥ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤
  drawPie(p1,p2,p3);
}

function drawBar(points){
  const W=cBar.width,H=cBar.height; gb.clearRect(0,0,W,H);
  gb.strokeStyle='#223049'; gb.strokeRect(0.5,0.5,W-1,H-1);
  if(points.length===0){ gb.fillStyle='#94a3b8'; gb.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', 16, 24); return; }
  const left=40,right=W-10,top=20,bottom=H-26;
  const max=Math.max(...points.map(p=>p.y),1);
  const bw=(right-left)/points.length;
  gb.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; gb.beginPath(); gb.moveTo(left,y); gb.lineTo(right,y); gb.stroke(); }
  points.forEach((p,i)=>{
    const x=left+i*bw+4; const h=(p.y/max)*(bottom-top);
    gb.fillStyle='#38bdf8'; gb.fillRect(x, bottom-h, bw-8, h);
    if(points.length<=24){ gb.fillStyle='#e5e7eb'; gb.font='10px ui-monospace'; gb.fillText(String(p.x).slice(5), x+2, bottom-4); }
  });
}

function drawTop(points){
  const W=cTop.width,H=cTop.height; gt.clearRect(0,0,W,H);
  gt.strokeStyle='#223049'; gt.strokeRect(0.5,0.5,W-1,H-1);
  if(points.length===0){ gt.fillStyle='#94a3b8'; gt.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', 16, 24); return; }
  const left=120,right=W-10,top=20,bottom=H-20;
  const max=Math.max(...points.map(p=>p.y),1);
  const rowH=(bottom-top)/points.length;
  gt.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const x=left+i*(right-left)/4; gt.beginPath(); gt.moveTo(x,top); gt.lineTo(x,bottom); gt.stroke(); }
  points.forEach((p,i)=>{
    const y=top+i*rowH+6; const w=(p.y/max)*(right-left-10);
    gt.fillStyle='#22c55e'; gt.fillRect(left, y, w, rowH-12);
    gt.fillStyle='#e5e7eb'; gt.font='11px ui-monospace'; gt.fillText(`${p.x} ‚Äî ${p.y}`, 8, y+rowH/2);
  });
}

function drawPie(p1,p2,p3){
  const W=cPie.width,H=cPie.height; gp.clearRect(0,0,W,H);
  gp.strokeStyle='#223049'; gp.strokeRect(0.5,0.5,W-1,H-1);
  const total=p1+p2+p3;
  if(total===0){ gp.fillStyle='#94a3b8'; gp.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', 16, 24); return; }
  const cx=W/2, cy=H/2, R=Math.min(W,H)/2-20;
  const segs=[{v:p1,c:'#f87171',t:'P1'},{v:p2,c:'#fbbf24',t:'P2'},{v:p3,c:'#22c55e',t:'P3'}];
  let a0=0;
  segs.forEach(s=>{
    const a1=a0+2*Math.PI*(s.v/total);
    gp.beginPath(); gp.moveTo(cx,cy); gp.arc(cx,cy,R,a0,a1); gp.closePath(); gp.fillStyle=s.c; gp.fill();
    const am=(a0+a1)/2; const lx=cx+Math.cos(am)*(R+10), ly=cy+Math.sin(am)*(R+10);
    gp.fillStyle='#e5e7eb'; gp.font='12px ui-monospace'; gp.fillText(`${s.t} ${s.v}`, lx-16, ly);
    a0=a1;
  });
}

/* ===== –ï–∫—Å–ø–æ—Ä—Ç / QR ===== */
$('#saveCsv').addEventListener('click', ()=>{
  const rows=applyFilters(RECORDS);
  let csv='file,act_no,date,address,abonent,phone,priority,responsible,duplicate\n';
  rows.forEach(r=>{
    csv+=`"${r.name}","${r.actNo||''}","${r.date||''}","${r.address||''}","${r.abonent||''}","${r.phone||''}","${r.priority||''}","${r.responsible||''}","${r.dupFlag?'YES':''}"\n`;
  });
  download('gas_para23_archive_'+stamp()+'.csv', csv, 'text/csv'); log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click', ()=>{
  const rows=applyFilters(RECORDS);
  const p1=rows.filter(r=>r.priority==='P1').length, p2=rows.filter(r=>r.priority==='P2').length, p3=rows.filter(r=>r.priority==='P3').length;
  const lines=[
    '–ü–∞—Ä–∞ 23 ‚Äî AI-–∞—Ä—Ö—ñ–≤ –∞–∫—Ç—ñ–≤: –ø—ñ–¥—Å—É–º–æ–∫',
    `–í–∏–±—ñ—Ä–∫–∞: ${rows.length} –∞–∫—Ç(–∏/—ñ–≤)`,
    `P1/P2/P3: ${p1}/${p2}/${p3}`,
    `–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤ —É –≤–∏–±—ñ—Ä—Ü—ñ: ${rows.filter(r=>r.dupFlag).length}`,
    '',
    ...rows.slice(0,50).map(r=>`‚Ä¢ ${r.date||'‚Äî'} | ${r.priority||'‚Äî'} | ${r.actNo||'‚Äî'} | ${r.address||'‚Äî'} | ${r.responsible||'‚Äî'}`)
  ];
  download('gas_para23_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#qrGen').addEventListener('click', ()=>{
  const data=prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª–∞–º–∏ PDF/JPEG):', 'https://');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const imgQ=new Image(); imgQ.crossOrigin='anonymous';
  imgQ.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(imgQ,0,0,220,220); };
  imgQ.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  imgQ.src=url;
  log('QR –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ');
});

/* ===== –î–æ–ø–æ–º—ñ–∂–Ω—ñ ===== */
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}

/* ===== –Ü–Ω—ñ—Ç ===== */
renderDash();

</script>
</body>
</html>
