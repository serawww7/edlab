<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 15 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ê–∫—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ –±–µ–∑–ø–µ–∫–∏: –¥–∞—Ç—á–∏–∫–∏/—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∏/—Ç—è–≥–∞/—ñ–æ–Ω—ñ–∑–∞—Ü—ñ—è, –≥—Ä–∞—Ñ—ñ–∫–∏, —Ñ–æ—Ç–æ/–∞—É–¥—ñ–æ, –ø—ñ–¥–ø–∏—Å, 58 –º–º, CSV/TXT, QR</title>
<meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ –±–µ–∑–ø–µ–∫–∏: —Ç–µ—Å—Ç–∏ –¥–∞—Ç—á–∏–∫—ñ–≤ (–≤–∏—Ç–æ–∫—É, —Ç—è–≥–∏, –ø–µ—Ä–µ–≥—Ä—ñ–≤—É, —ñ–æ–Ω—ñ–∑–∞—Ü—ñ—ó, —Ç–∏—Å–∫—É –≤–æ–¥–∏), —Ç–∞–π–º–µ—Ä–∏ —ñ KPI –¥–ª—è —á–∞—Å—É —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è, –≥—Ä–∞—Ñ—ñ–∫–∏, –∫–∞–º–µ—Ä–∞, –∞—É–¥—ñ–æ, –ø—ñ–¥–ø–∏—Å, —á–µ–∫ 58 –º–º, CSV/TXT, QR, –∂—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
.canvasWrap{overflow:hidden;border-radius:12px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre;min-height:140px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.photo{width:100%;max-width:240px;border:1px solid var(--line);border-radius:12px;display:block}
.gallery{display:flex;gap:8px;flex-wrap:wrap}
.block{border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#0c182a}
.sigWrap{border:1px dashed var(--line);border-radius:12px;padding:8px;background:#0c182a}
#sig{background:#0b1220;border:1px solid var(--line);border-radius:8px;touch-action:none}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.test{border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0;background:#0c182a;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.test[data-pass="true"]{border-color:#1d3e2a;background:#0f2f1e22}
.test .actions{display:flex;gap:6px;flex-wrap:wrap}
audio{width:100%}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üõ°Ô∏èüî•</span>
      <div>
        <b>–ü–∞—Ä–∞ 15 ‚Äî –ê–∫—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ –±–µ–∑–ø–µ–∫–∏</b><br/>
        <span class="badge">–î–∞—Ç—á–∏–∫–∏ ‚Üí —Ç–∞–π–º–µ—Ä–∏ ‚Üí KPI ‚Üí –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Üí –∫–∞–º–µ—Ä–∞/–∞—É–¥—ñ–æ ‚Üí –ø—ñ–¥–ø–∏—Å ‚Üí 58 –º–º ‚Üí CSV/TXT ‚Üí QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <!-- –í–≤—ñ–¥–Ω—ñ -->
  <div class="card">
    <h2>üìö –°—Ü–µ–Ω–∞—Ä—ñ–π</h2>
    <p>–í–∏–∫–æ–Ω—É—î–º–æ <b>–ø–æ—Å–ª—ñ–¥–æ–≤–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</b> –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ –±–µ–∑–ø–µ–∫–∏ –ø–æ–±—É—Ç–æ–≤–æ–≥–æ –∫–æ—Ç–ª–∞/–í–ë–î: –≥–∞–∑-–¥–µ—Ç–µ–∫—Ç–æ—Ä (–≤–∏—Ç—ñ–∫), –¥–∞—Ç—á–∏–∫ —Ç—è–≥–∏, —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç –ø–µ—Ä–µ–≥—Ä—ñ–≤—É, —ñ–æ–Ω—ñ–∑–∞—Ü—ñ–π–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–ª—É–º‚Äô—è, 
      –ø—Ä–µ—Å–æ—Å—Ç–∞—Ç/–¥–∞—Ç—á–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ —Ç–∏—Å–∫—É –≤–æ–¥–∏, –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–∑-–∫–ª–∞–ø–∞–Ω–∞. –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–µ—Å—Ç—É —Ñ—ñ–∫—Å—É—î–º–æ <b>—á–∞—Å —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è</b> —ñ –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ –∑ <b>KPI</b>.</p>
    <div class="row">
      <label style="flex:1">–ê–¥—Ä–µ—Å–∞/–æ–±‚Äô—î–∫—Ç<input id="addr" class="input" placeholder="–º. –¢–∞–ª—å–Ω–µ, –≤—É–ª. ..., –∫–æ—Ç–µ–ª—å–Ω—è"/></label>
      <label style="flex:1">–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è
        <select id="equip" class="input">
          <option selected>–ö–æ—Ç–µ–ª –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π</option><option>–ö–æ—Ç–µ–ª —Ç—É—Ä–±–æ–≤–∞–Ω–∏–π</option><option>–í–ë–î (–≤–æ–¥–æ–Ω–∞–≥—Ä—ñ–≤–∞—á)</option><option>–Ü–Ω—à–µ</option>
        </select>
      </label>
      <label style="flex:1">–ú–æ–¥–µ–ª—å/—Å–µ—Ä—ñ–π–Ω–∏–π<input id="model" class="input" placeholder="–ù–∞–ø—Ä. AOGV 11, S/N 12345..."/></label>
      <label style="flex:1">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å<input id="tech" class="input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."/></label>
      <label style="flex:1">–î–∞—Ç–∞<input id="day" class="input" type="date"/></label>
    </div>
    <div class="row">
      <button class="btn good" id="mkCase">üß∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å</button>
      <span class="badge" id="cid">–ö–µ–π—Å: ‚Äî</span>
    </div>
  </div>

  <div class="grid">
    <!-- –õ—ñ–≤–∞: –¢–µ—Å—Ç–∏ + –≥—Ä–∞—Ñ—ñ–∫–∏ + –∫–∞–º–µ—Ä–∞/–∞—É–¥—ñ–æ/–ø—ñ–¥–ø–∏—Å -->
    <div class="card">
      <h2>üß™ –¢–µ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ (—Ç–∞–π–º–µ—Ä–∏, KPI)</h2>
      <div class="block">
        <div class="row">
          <label>–ú–∞–∫—Å. —á–∞—Å —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è (KPI), —Å–µ–∫<input id="kpiTime" class="input" type="number" step="0.1" value="5.0"/></label>
          <label>–ú–∞–∫—Å. CO –¥–ª—è –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è, ppm<input id="kpiCO" class="input" type="number" step="1" value="50"/></label>
          <button class="btn secondary" id="applyKPI">‚öôÔ∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ KPI</button>
        </div>
        <div class="kpi" style="margin-top:6px">
          <span class="tag ok">KPI —á–∞—Å: <b id="kTime">‚â§ 5.0 c</b></span>
          <span class="tag warn">KPI CO: <b id="kCO">‚â§ 50 ppm</b></span>
          <span class="tag bad">–ó–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å: <b id="kAll">‚Äî</b></span>
        </div>
      </div>

      <div id="tests"></div>

      <h2 style="margin-top:10px">üìà –ì—Ä–∞—Ñ—ñ–∫ 1 ‚Äî —á–∞—Å —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è (—Å)</h2>
      <div class="canvasWrap"><canvas id="bar" class="chart" width="520" height="240"></canvas></div>

      <h2 style="margin-top:10px">üïí –ì—Ä–∞—Ñ—ñ–∫ 2 ‚Äî —Ç–∞–π–º–ª–∞–π–Ω –ø–æ–¥—ñ–π</h2>
      <div class="canvasWrap"><canvas id="timeline" class="chart" width="520" height="240"></canvas></div>

      <h2 style="margin-top:10px">üé• –§–æ—Ç–æ (3 —à—Ç.)</h2>
      <div class="row">
        <video id="vid" class="photo" autoplay playsinline muted></video>
        <div>
          <button class="btn" id="camOn">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          <button class="btn" data-kind="sensor">üì∑ –î–∞—Ç—á–∏–∫ (—Ç—è–≥–∏/–≥–∞–∑—É)</button>
          <button class="btn" data-kind="wiring">üì∑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è/–∫–ª–µ–º–∏</button>
          <button class="btn" data-kind="valve">üì∑ –ì–∞–∑-–∫–ª–∞–ø–∞–Ω</button><br/>
          <small class="muted">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É ¬´–ì–∞–ª–µ—Ä–µ—ó –¥–æ–∫–∞–∑—ñ–≤¬ª.</small>
        </div>
      </div>
      <div class="gallery" id="gal"></div>

      <h2 style="margin-top:10px">üéôÔ∏è –ê—É–¥—ñ–æ-–∫–æ–º–µ–Ω—Ç–∞—Ä (—Ä–µ–∑—é–º–µ –≤–∏–ø—Ä–æ–±—É–≤–∞–Ω—å)</h2>
      <div class="block">
        <div class="row">
          <button class="btn" id="audStart">‚è∫Ô∏è –ó–∞–ø–∏—Å</button>
          <button class="btn secondary" id="audStop">‚èπÔ∏è –°—Ç–æ–ø</button>
          <button class="btn" id="audSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <span class="badge" id="audStat">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É</span>
        </div>
        <audio id="audPlay" controls></audio>
      </div>

      <h2 style="margin-top:10px">‚úçÔ∏è –ü—ñ–¥–ø–∏—Å –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>
      <div class="sigWrap">
        <canvas id="sig" width="520" height="200"></canvas>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="sigClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
          <button class="btn" id="sigSave">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
          <span class="badge" id="sigStat">–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞: –ú–µ—Ç—Ä–∏–∫–∏ / –ï–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞ —Å—Ç–∞–Ω</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ö–µ–π—Å</th><td id="mCase">‚Äî</td></tr>
          <tr><th>–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</th><td id="mEquip">‚Äî</td></tr>
          <tr><th>–¢–µ—Å—Ç—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–æ</th><td id="mDone">0 / 6</td></tr>
          <tr><th>–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è</th><td id="mAvg">‚Äî</td></tr>
          <tr><th>CO –∫–æ–Ω—Ç—Ä–æ–ª—å</th><td id="mCO">‚Äî</td></tr>
          <tr><th>–§–æ—Ç–æ (sensor/wiring/valve)</th><td id="mPhotos">0 / 0 / 0</td></tr>
          <tr><th>–ê—É–¥—ñ–æ</th><td id="mAud">‚Äî</td></tr>
          <tr><th>–ü—ñ–¥–ø–∏—Å</th><td id="mSig">‚Äî</td></tr>
          <tr><th>–°—Ç–∞—Ç—É—Å</th><td id="mState"><b class="warn">–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç–µ—Å—Ç–∏</b></td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <ul>
        <li>–ö–µ–π—Å + –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è ‚Äî <b>2</b></li>
        <li>–í–∏–∫–æ–Ω–∞–Ω—ñ –≤—Å—ñ 6 —Ç–µ—Å—Ç—ñ–≤ ‚Äî <b>3</b></li>
        <li>–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å ‚â§ KPI ‚Äî <b>2</b></li>
        <li>CO ‚â§ KPI ‚Äî <b>2</b></li>
        <li>–§–æ—Ç–æ (3) –∞–±–æ –∞—É–¥—ñ–æ + –ø—ñ–¥–ø–∏—Å ‚Äî <b>1</b></li>
      </ul>

      <h2 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h2>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV</button>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (Case)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>

      <h2 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h2>
      <pre id="alog" class="card" style="max-height:240px;overflow:auto;margin-top:6px">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clean(s){return String(s).replace(/\s+/g,' ').trim();}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

// ===== –°—Ç–∞–Ω
let CASE_ID=null;
let photos={sensor:null, wiring:null, valve:null};
let sigUrl=null;
let audBlob=null, audUrl=null;
let coRoom=0; // ppm (–µ–º—É–ª—è—Ü—ñ—è –∫–æ–Ω—Ç—Ä–æ–ª—é —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞)

// ===== –ö–µ–π—Å
$('#mkCase').addEventListener('click',()=>{
  const addr=clean($('#addr').value||''); const tech=clean($('#tech').value||''); const day=$('#day').value;
  if(!addr||!tech||!day){ alert('–í–∫–∞–∂–∏ –∞–¥—Ä–µ—Å—É, –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ç–∞ –¥–∞—Ç—É'); return; }
  CASE_ID='A-'+Math.random().toString(36).slice(2,8).toUpperCase();
  $('#cid').textContent='–ö–µ–π—Å: '+CASE_ID;
  log(`–ö–µ–π—Å ${CASE_ID}: ${addr}, ${$('#equip').value}, ${$('#model').value||'-'}, ${tech}, ${day}`);
  renderTests(); drawBars(); drawTimeline(); updateMetrics(); computeKPI();
});

// ===== KPI
let KPI={tMax:5.0, coMax:50};
$('#applyKPI').addEventListener('click',()=>{
  KPI.tMax = Math.max(0.5, parseFloat($('#kpiTime').value)||5);
  KPI.coMax = Math.max(1, parseFloat($('#kpiCO').value)||50);
  $('#kTime').textContent = `‚â§ ${KPI.tMax} c`;
  $('#kCO').textContent   = `‚â§ ${KPI.coMax} ppm`;
  computeKPI(); updateMetrics(); log(`KPI –æ–Ω–æ–≤–ª–µ–Ω–æ: —á–∞—Å‚â§${KPI.tMax}s, CO‚â§${KPI.coMax}ppm`);
});

// ===== –ü–µ—Ä–µ–ª—ñ–∫ —Ç–µ—Å—Ç—ñ–≤
const TEST_DEF=[
  {k:'gas',   name:'–ì–∞–∑-–¥–µ—Ç–µ–∫—Ç–æ—Ä (–≤–∏—Ç—ñ–∫) ‚Üí —Å–∏–≥–Ω–∞–ª/–≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è', hint:'–Ü–º—ñ—Ç–∞—Ü—ñ—è –≤–∏—Ç–æ–∫—É ‚Äî –æ—á—ñ–∫—É—î–º–æ —Å–∏–≥–Ω–∞–ª —ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è'},
  {k:'draft', name:'–î–∞—Ç—á–∏–∫ —Ç—è–≥–∏ ‚Üí –∑—É–ø–∏–Ω–∫–∞ –ø–∞–ª—å–Ω–∏–∫–∞', hint:'–Ü–º—ñ—Ç—É—î–º–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ç—è–≥–∏'},
  {k:'over',  name:'–¢–µ—Ä–º–æ—Å—Ç–∞—Ç –ø–µ—Ä–µ–≥—Ä—ñ–≤—É ‚Üí –∑—É–ø–∏–Ω–∫–∞', hint:'–Ü–º—ñ—Ç—É—î–º–æ –ø–µ—Ä–µ–≥—Ä—ñ–≤ —Ç–µ–ø–ª–æ–æ–±–º—ñ–Ω–Ω–∏–∫–∞'},
  {k:'ion',   name:'–Ü–æ–Ω—ñ–∑–∞—Ü—ñ–π–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å ‚Üí –≤—ñ–¥—Å—ñ—á–µ–Ω–Ω—è –≥–∞–∑—É', hint:'–Ü–º—ñ—Ç—É—î–º–æ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–ª—É–º‚Äô—è'},
  {k:'press', name:'–ü—Ä–µ—Å–æ—Å—Ç–∞—Ç/–¥–∞—Ç—á–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ —Ç–∏—Å–∫—É –≤–æ–¥–∏', hint:'–Ü–º—ñ—Ç—É—î–º–æ –Ω–∏–∑—å–∫–∏–π —Ç–∏—Å–∫ —É —Å–∏—Å—Ç–µ–º—ñ'},
  {k:'valve', name:'–ì–∞–∑-–∫–ª–∞–ø–∞–Ω (—à–≤–∏–¥–∫—ñ—Å—Ç—å –∑–∞–∫—Ä–∏—Ç—Ç—è)', hint:'–í–∏–º—ñ—Ä—é—î–º–æ —á–∞—Å –¥–æ –ø–æ–≤–Ω–æ–≥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è'}
];

let TESTS = TEST_DEF.map(t=>({...t, tStart:null, tStop:null, dur:NaN, pass:false, notes:''}));

function renderTests(){
  const box=$('#tests'); box.innerHTML='';
  TESTS.forEach((t,i)=>{
    const el=document.createElement('div'); el.className='test'; el.dataset.key=t.k; el.dataset.pass=t.pass;
    el.innerHTML = `
      <div>
        <div class="row" style="justify-content:space-between">
          <div><span class="badge mono">${t.k}</span> <b>${i+1}. ${t.name}</b></div>
          <div class="badge muted">${t.hint}</div>
        </div>
        <div class="row">
          <span class="badge">–°—Ç–∞—Ä—Ç: <b class="s">‚Äî</b></span>
          <span class="badge">–°—Ç–æ–ø: <b class="e">‚Äî</b></span>
          <span class="badge">–ß–∞—Å: <b class="d">‚Äî</b> c</span>
          <span class="badge">–°—Ç–∞—Ç—É—Å: <b class="st">‚Äî</b></span>
        </div>
        <textarea class="input notes" placeholder="–ù–æ—Ç–∞—Ç–∫–∏/—Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è"></textarea>
      </div>
      <div class="actions">
        <button class="btn btn-start">‚ñ∂Ô∏è Start</button>
        <button class="btn secondary btn-stop">‚èπÔ∏è Stop</button>
        <button class="btn good btn-pass">‚úÖ Pass</button>
        <button class="btn secondary btn-fail">‚ùå Fail</button>
      </div>
    `;
    box.appendChild(el);
  });
}
renderTests();

function testByKey(k){ return TESTS.find(x=>x.k===k); }
$('#tests').addEventListener('click',(e)=>{
  const wrap=e.target.closest('.test'); if(!wrap) return; const key=wrap.dataset.key; const t=testByKey(key);
  if(e.target.classList.contains('btn-start')){
    t.tStart=Date.now(); t.tStop=null; t.dur=NaN; t.pass=false;
    wrap.querySelector('.s').textContent=new Date(t.tStart).toLocaleTimeString();
    wrap.querySelector('.e').textContent='‚Äî'; wrap.querySelector('.d').textContent='‚Äî';
    wrap.querySelector('.st').textContent='–≤ –ø—Ä–æ—Ü–µ—Å—ñ'; wrap.dataset.pass='false';
    log(`–¢–µ—Å—Ç ${key}: Start`);
  }
  if(e.target.classList.contains('btn-stop')){
    if(!t.tStart){ alert('–°–ø–µ—Ä—à—É Start'); return; }
    t.tStop=Date.now(); t.dur=((t.tStop-t.tStart)/1000).toFixed(2);
    wrap.querySelector('.e').textContent=new Date(t.tStop).toLocaleTimeString();
    wrap.querySelector('.d').textContent=String(t.dur);
    log(`–¢–µ—Å—Ç ${key}: Stop (${t.dur}s)`);
    addTimelinePoint(key, parseFloat(t.dur));
    drawBars(); drawTimeline(); updateMetrics(); computeKPI();
  }
  if(e.target.classList.contains('btn-pass')){
    const ok = isFinite(parseFloat(t.dur)) ? parseFloat(t.dur) <= KPI.tMax : true;
    t.pass = ok; wrap.dataset.pass=String(t.pass);
    wrap.querySelector('.st').textContent = ok?'OK':'–ü–æ–∑–∞ KPI';
    t.notes = wrap.querySelector('.notes').value;
    log(`–¢–µ—Å—Ç ${key}: ${t.pass?'PASS':'FAIL'} (dur=${t.dur||'‚Äî'})`);
    drawBars(); updateMetrics(); computeKPI();
  }
  if(e.target.classList.contains('btn-fail')){
    t.pass=false; wrap.dataset.pass='false';
    wrap.querySelector('.st').textContent='Fail';
    t.notes = wrap.querySelector('.notes').value;
    log(`–¢–µ—Å—Ç ${key}: FAIL`);
    drawBars(); updateMetrics(); computeKPI();
  }
});

// ===== –¢–∞–π–º–ª–∞–π–Ω –ø–æ–¥—ñ–π (–º–∞—Å–∏–≤ —Ç–æ—á–æ–∫)
let TL=[]; // {key, t:timestamp, dur:number}
function addTimelinePoint(key,dur){ TL.push({key, t:Date.now(), dur}); }

// ===== –ì—Ä–∞—Ñ—ñ–∫ 1 (—Å—Ç–æ–≤–ø—á–∏–∫–∏ —á–∞—Å—É)
const bar=$('#bar'), gb=bar.getContext('2d');
function drawBars(){
  const W=bar.width,H=bar.height; gb.clearRect(0,0,W,H);
  gb.strokeStyle='#223049'; gb.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  const labels=TESTS.map(t=>t.k.toUpperCase());
  const vals=TESTS.map(t=>isFinite(parseFloat(t.dur))?parseFloat(t.dur):0);
  const max=Math.max(5, ...vals, KPI.tMax);
  const bw=(right-left)/labels.length;
  // –°—ñ—Ç–∫–∞
  gb.strokeStyle='#1f2a44';
  for(let i=0;i<=4;i++){const y=top+i*(bottom-top)/4; gb.beginPath(); gb.moveTo(left,y); gb.lineTo(right,y); gb.stroke();}
  // –ë–∞—Ä—á–∏–∫–∏
  labels.forEach((lab,i)=>{
    const v=vals[i], x=left+i*bw+6; const h=(v/max)*(bottom-top);
    gb.fillStyle= v>0 ? (v<=KPI.tMax? '#22c55e' : '#f87171') : '#334155';
    gb.fillRect(x, bottom-h, bw-12, h);
    gb.fillStyle='#94a3b8'; gb.font='10px ui-monospace'; gb.fillText(lab, x+2, bottom+12);
  });
  // –õ—ñ–Ω—ñ—è KPI
  const yK=bottom - (KPI.tMax/max)*(bottom-top);
  gb.strokeStyle='#fbbf24'; gb.beginPath(); gb.moveTo(left,yK); gb.lineTo(right,yK); gb.stroke();
  gb.fillStyle='#e5e7eb'; gb.font='11px ui-monospace'; gb.fillText('KPI —á–∞—Å', right-68, yK-4);
}

// ===== –ì—Ä–∞—Ñ—ñ–∫ 2 (—Ç–∞–π–º–ª–∞–π–Ω)
const tl=$('#timeline'), gt=tl.getContext('2d');
function drawTimeline(){
  const W=tl.width,H=tl.height; gt.clearRect(0,0,W,H);
  gt.strokeStyle='#223049'; gt.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=24,bottom=H-28;
  gt.strokeStyle='#1f2a44'; gt.beginPath(); gt.moveTo(left,bottom); gt.lineTo(right,bottom); gt.stroke();
  if(!TL.length){ gt.fillStyle='#94a3b8'; gt.fillText('–ü–æ–¥—ñ—ó –∑‚Äô—è–≤–ª—è—é—Ç—å—Å—è –ø—ñ—Å–ª—è Stop –∫–æ–∂–Ω–æ–≥–æ —Ç–µ—Å—Ç—É', left+8, top+14); return; }
  const tMin=TL[0].t, tMax=TL[TL.length-1].t, span=(tMax-tMin)||1;
  TL.forEach((p,i)=>{
    const x=left + (p.t-tMin)/span*(right-left);
    const y=bottom - 8 - (i%3)*16;
    gt.strokeStyle='#38bdf8'; gt.beginPath(); gt.moveTo(x,bottom); gt.lineTo(x,y); gt.stroke();
    gt.fillStyle='#22c55e'; if(p.dur>KPI.tMax) gt.fillStyle='#f87171';
    gt.fillRect(x-3,y-3,6,6);
    gt.fillStyle='#e5e7eb'; gt.font='10px ui-monospace';
    gt.fillText(p.key.toUpperCase()+' '+p.dur.toFixed(2)+'c', x-24, y-6);
  });
}

// ===== –ö–∞–º–µ—Ä–∞ / —Ñ–æ—Ç–æ
let stream=null;
async function startCam(){
  try{ stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); $('#vid').srcObject=stream; log('–ö–∞–º–µ—Ä—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ'); }
  catch(e){ alert('–ö–∞–º–µ—Ä—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); }
}
$('#camOn').addEventListener('click', startCam);
function takeShot(kind){
  const video=$('#vid'); if(!video.srcObject){ alert('–°–ø–µ—Ä—à—É —É–≤—ñ–º–∫–Ω–∏ –∫–∞–º–µ—Ä—É'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480;
  c.getContext('2d').drawImage(video,0,0,c.width,c.height);
  const url=c.toDataURL('image/png'); photos[kind]=url; renderGallery(); log(`–§–æ—Ç–æ: ${kind}`); updateMetrics();
}
$$('button[data-kind]').forEach(b=>b.addEventListener('click',()=>takeShot(b.dataset.kind)));
function renderGallery(){
  const gal=$('#gal'); gal.innerHTML='';
  if(photos.sensor){ const i=document.createElement('img'); i.className='photo'; i.src=photos.sensor; i.alt='sensor'; gal.appendChild(i); }
  if(photos.wiring){ const i=document.createElement('img'); i.className='photo'; i.src=photos.wiring; i.alt='wiring'; gal.appendChild(i); }
  if(photos.valve){ const i=document.createElement('img'); i.className='photo'; i.src=photos.valve; i.alt='valve'; gal.appendChild(i); }
}

// ===== –ê—É–¥—ñ–æ
let mediaStream=null, mediaRec=null, chunks=[];
$('#audStart').addEventListener('click', async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRec = new MediaRecorder(mediaStream); chunks=[];
    mediaRec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
    mediaRec.onstop = ()=>{ audBlob=new Blob(chunks,{type:'audio/webm'}); audUrl=URL.createObjectURL(audBlob); $('#audPlay').src=audUrl; $('#audStat').textContent='–Ñ –∑–∞–ø–∏—Å'; log('–ê—É–¥—ñ–æ: –≥–æ—Ç–æ–≤–æ'); updateMetrics(); };
    mediaRec.start(); $('#audStat').textContent='–ô–¥–µ –∑–∞–ø–∏—Å...'; log('–ê—É–¥—ñ–æ: —Å—Ç–∞—Ä—Ç');
  }catch(e){ alert('–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'); }
});
$('#audStop').addEventListener('click',()=>{
  if(mediaRec && mediaRec.state!=='inactive'){ mediaRec.stop(); mediaStream.getTracks().forEach(t=>t.stop()); $('#audStat').textContent='–ó—É–ø–∏–Ω–µ–Ω–æ'; log('–ê—É–¥—ñ–æ: —Å—Ç–æ–ø'); }
});
$('#audSave').addEventListener('click',()=>{
  if(!audBlob){ alert('–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É'); return; }
  const a=document.createElement('a'); a.href=audUrl; a.download='audio_'+(CASE_ID||'case')+'_'+stamp()+'.webm'; document.body.appendChild(a); a.click(); a.remove(); log('–ê—É–¥—ñ–æ: –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

// ===== –ü—ñ–¥–ø–∏—Å
const sig=$('#sig'), ctx=sig.getContext('2d');
let drawing=false, last=null, hasInk=false;
function xy(e){ const r=sig.getBoundingClientRect(); const t=e.touches? e.touches[0]:e; return {x:(t.clientX-r.left)*sig.width/r.width, y:(t.clientY-r.top)*sig.height/r.height}; }
function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke(); }
sig.addEventListener('pointerdown',e=>{ drawing=true; last=xy(e); hasInk=true; });
sig.addEventListener('pointermove',e=>{ if(!drawing) return; const p=xy(e); line(last,p); last=p; });
sig.addEventListener('pointerup',()=>{ drawing=false; last=null; });
sig.addEventListener('pointerleave',()=>{ drawing=false; last=null; });
$('#sigClear').addEventListener('click',()=>{ ctx.clearRect(0,0,sig.width,sig.height); hasInk=false; $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å—É –Ω–µ–º–∞—î'; updateMetrics(); });
$('#sigSave').addEventListener('click',()=>{ if(!hasInk){ alert('–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å—É'); return; } sigUrl=sig.toDataURL('image/png'); $('#sigStat').textContent='–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ'; const a=document.createElement('a'); a.href=sigUrl; a.download='signature_'+(CASE_ID||'case')+'_'+stamp()+'.png'; document.body.appendChild(a); a.click(); a.remove(); log('–ü—ñ–¥–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ (png)'); updateMetrics(); });

// ===== –û–±—á–∏—Å–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É/KPI
function computeKPI(){
  const done=TESTS.filter(t=>t.pass).length;
  const durs=TESTS.map(t=>parseFloat(t.dur)).filter(Number.isFinite);
  const avg = durs.length? (durs.reduce((a,b)=>a+b,0)/durs.length) : NaN;
  const coOk = coRoom <= KPI.coMax;
  $('#kAll').textContent = (done===TESTS.length && (isFinite(avg)? avg<=KPI.tMax : true) && coOk) ? 'OK' : '–ù–µ –≤–∏–∫–æ–Ω–∞–Ω–æ';
  $('#mAvg').textContent = isFinite(avg)? `${avg.toFixed(2)} c` : '‚Äî';
  $('#mCO').textContent  = `${coRoom} ppm (${coOk?'OK':'HIGH'})`;
  updateState();
}

// –ï–º—É–ª—è—Ç–æ—Ä CO (–∫—Ä—É—Ç–∏–ª–∫–∞ —á–µ—Ä–µ–∑ prompt –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏)
document.addEventListener('keydown',(e)=>{
  if(e.key.toLowerCase()==='c'){ 
    const v = prompt('–í–∫–∞–∂–∏ CO –≤ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ, ppm (–¥–ª—è –∂—É—Ä–Ω–∞–ª—É/KPI):', String(coRoom));
    if(v!==null){ const n=parseInt(v); if(Number.isFinite(n)){ coRoom=n; log('CO room –æ–Ω–æ–≤–ª–µ–Ω–æ: '+coRoom+' ppm'); computeKPI(); } }
  }
});

// ===== –ú–µ—Ç—Ä–∏–∫–∏ / —Å—Ç–∞–Ω
function updateState(){
  let score=0;
  const caseOk=!!CASE_ID;
  const allTestsOk=TESTS.every(t=>t.pass);
  const durs=TESTS.map(t=>parseFloat(t.dur)).filter(Number.isFinite);
  const avg = durs.length? (durs.reduce((a,b)=>a+b,0)/durs.length) : Infinity;
  const kpiTimeOk = avg<=KPI.tMax;
  const coOk = coRoom<=KPI.coMax;
  const mediaOk = (photos.sensor && photos.wiring && photos.valve) || !!audBlob;
  const signOk = !!sigUrl;

  if(caseOk)score+=2;
  if(allTestsOk)score+=3;
  if(kpiTimeOk)score+=2;
  if(coOk)score+=2;
  if(mediaOk && signOk)score+=1;

  const html = score>=9? `<b class="ok">–ì–æ—Ç–æ–≤–æ (‚âà${score}/10)</b>`:
               score>=6? `<b class="warn">–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–æ (‚âà${score}/10)</b>`:
                         `<b class="bad">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ä–æ–±–∏—Ç–∏ (‚âà${score}/10)</b>`;
  $('#mState').innerHTML=html;
}
function updateMetrics(){
  $('#mCase').textContent = CASE_ID||'‚Äî';
  $('#mEquip').textContent = `${$('#equip').value||'‚Äî'} (${($('#model').value||'‚Äî')})`;
  $('#mDone').textContent = `${TESTS.filter(t=>t.pass).length} / ${TESTS.length}`;
  $('#mPhotos').textContent = `${photos.sensor?1:0} / ${photos.wiring?1:0} / ${photos.valve?1:0}`;
  $('#mAud').textContent = audBlob?'—î':'‚Äî';
  $('#mSig').textContent = sigUrl?'—î':'‚Äî';
  computeKPI(); drawBars(); drawTimeline();
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR
function summary(){
  const addr=$('#addr').value||'‚Äî', tech=$('#tech').value||'‚Äî', day=$('#day').value||'‚Äî';
  return {
    case: CASE_ID||'‚Äî', addr, tech, day,
    equip: {type: $('#equip').value||'‚Äî', model: $('#model').value||'‚Äî'},
    tests: TESTS.map(t=>({key:t.k, name:t.name, dur:isFinite(parseFloat(t.dur))?parseFloat(t.dur):null, pass:t.pass, notes:t.notes})),
    kpi: {tMax: KPI.tMax, coMax: KPI.coMax, coRoom},
    media: {photos: {sensor:!!photos.sensor, wiring:!!photos.wiring, valve:!!photos.valve}, audio: !!audBlob},
    signature: !!sigUrl
  };
}
$('#saveCsv').addEventListener('click',()=>{
  const s=summary(); let csv='field,value\n';
  csv+=`case,${s.case}\naddr,${s.addr}\ntech,${s.tech}\nday,${s.day}\n`;
  csv+=`equip_type,${s.equip.type}\nequip_model,${s.equip.model}\n`;
  csv+='# tests\nkey,name,dur_s,pass,notes\n';
  s.tests.forEach(t=>{ csv+=`${t.key},${t.name.replace(/,/g,';')},${t.dur??''},${t.pass},${(t.notes||'').replace(/,/g,';')}\n`; });
  csv+='# kpi\nkpi_time_max_s,'+s.kpi.tMax+'\nco_room_ppm,'+s.kpi.coRoom+'\nco_max_ppm,'+s.kpi.coMax+'\n';
  csv+='# media\nphotos_sensor,'+(s.media.photos.sensor?1:0)+'\nphotos_wiring,'+(s.media.photos.wiring?1:0)+'\nphotos_valve,'+(s.media.photos.valve?1:0)+'\naudio,'+(s.media.audio?1:0)+'\nsignature,'+(s.signature?1:0)+'\n';
  download('gas_para15_safety_auto_'+stamp()+'.csv', csv, 'text/csv'); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ CSV');
});
$('#saveTxt').addEventListener('click',()=>{
  const s=summary();
  const done=s.tests.filter(t=>t.pass).length;
  const avg = (()=>{
    const d=s.tests.map(x=>x.dur).filter(v=>Number.isFinite(v));
    return d.length? (d.reduce((a,b)=>a+b,0)/d.length).toFixed(2)+' c' : '‚Äî';
  })();
  const lines=[
    '–ü–∞—Ä–∞ 15 ‚Äî –ê–∫—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ –±–µ–∑–ø–µ–∫–∏: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ö–µ–π—Å: ${s.case}`, `–ê–¥—Ä–µ—Å–∞: ${s.addr}`, `–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è: ${s.equip.type} (${s.equip.model})`,
    `–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${s.tech}`, `–î–∞—Ç–∞: ${s.day}`,
    `–¢–µ—Å—Ç–∏: ${done}/${s.tests.length} PASS`,
    `–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å: ${avg}; KPI —á–∞—Å ‚â§ ${s.kpi.tMax} c`,
    `CO: ${s.kpi.coRoom} ppm (KPI ‚â§ ${s.kpi.coMax})`,
    '--- –ü–µ—Ä–µ–ª—ñ–∫ —Ç–µ—Å—Ç—ñ–≤ ---',
    ...s.tests.map(t=>`${t.key.toUpperCase()}: ${t.name} ‚Äî ${t.pass?'PASS':'FAIL'}; t=${t.dur??'‚Äî'} c; notes: ${(t.notes||'-')}`),
    `–§–æ—Ç–æ (sensor/wiring/valve): ${s.media.photos.sensor?'1':'0'} / ${s.media.photos.wiring?'1':'0'} / ${s.media.photos.valve?'1':'0'}; –ê—É–¥—ñ–æ: ${s.media.audio?'—î':'‚Äî'}`,
    `–ü—ñ–¥–ø–∏—Å: ${s.signature?'—î':'‚Äî'}`
  ];
  download('gas_para15_safety_auto_'+stamp()+'.txt', lines.join('\n')); log('–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ TXT');
});
$('#print58').addEventListener('click',()=>{
  const s=summary(); const rc=$('#rc'); rc.hidden=false;
  const done=s.tests.filter(t=>t.pass).length;
  const avg = (()=>{
    const d=s.tests.map(x=>x.dur).filter(v=>Number.isFinite(v));
    return d.length? (d.reduce((a,b)=>a+b,0)/d.length).toFixed(2) : '‚Äî';
  })();
  const lines=[
'=== SAFETY AUTO (58–º–º) ===',
'Case: '+s.case,
'Date: '+s.day,
'Equip:'+s.equip.type,
'Model:'+s.equip.model,
'PASS: '+done+'/'+s.tests.length+' Avg:'+avg+'s',
'CO: '+s.kpi.coRoom+'ppm (‚â§'+s.kpi.coMax+')',
'Photos:'+(s.media.photos.sensor?1:0)+'/'+(s.media.photos.wiring?1:0)+'/'+(s.media.photos.valve?1:0)+' Aud:'+(s.media.audio?'Y':'N')+' Sign:'+(s.signature?'Y':'N'),
'--------------------------'
  ];
  rc.textContent=lines.join('\n');
  download('gas_para15_receipt_'+stamp()+'.txt', rc.textContent);
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —á–µ–∫ 58–º–º');
});
$('#qrGen').addEventListener('click',()=>{
  const def=CASE_ID||'safety-auto';
  const data=prompt('–í—Å—Ç–∞–≤ URL/ID (Case):', def);
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url; log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ QR');
});

// ===== –Ü–Ω—ñ—Ç/—Ç–µ—Ö–Ω—ñ—á–Ω–µ
function init(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); }
init(); updateMetrics(); drawBars(); drawTimeline();

// –í–±—É–¥–æ–≤–∞–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Moodle/iFrame)
(function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
</script>
</body>
</html>
