<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 19 (–≥–∞–∑–æ–≤–∏–∫–∏) ‚Äî –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∏–π –æ–±–ª—ñ–∫: –ø—Ä–æ—Ñ—ñ–ª—ñ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –∞–≥—Ä–µ–≥–∞—Ü—ñ—è, –ø—ñ–∫–∏, –ª—ñ–º—ñ—Ç–∏</title>
<meta name="description" content="–ü–æ–≥–æ–¥–∏–Ω–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ –≤—É–∑–ª—ñ–≤, –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è, –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ñ –ª—ñ–º—ñ—Ç–∏ (–¥–æ–±–æ–≤–∏–π –æ–±—Å—è–≥ —Ç–∞ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏–π –ø—ñ–∫), –∞–ª–µ—Ä—Ç–∏, –≥—Ä–∞—Ñ—ñ–∫–∏ (–ø—Ä–æ—Ñ—ñ–ª—å/–ø—ñ–∫–∏/–∫—É–º—É–ª—è—Ç–∏–≤), —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1320px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.grid{display:grid;gap:14px;grid-template-columns:1.25fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e6eef9}
textarea{min-height:100px}
.btn{border:1px solid var(--line);background:#0f1f39;color:#e6eef9;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
small.mono,.mono{font-family:ui-monospace,monospace}
h2{margin:.2em 0 .4em}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:#e5e7eb;margin-right:6px;margin-top:6px}
.muted{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
canvas.chart{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
canvas.map{display:block;width:100%;height:240px;background:#0b1220;border:1px solid var(--line);border-radius:12px}
pre.log{max-height:240px;overflow:auto;background:#0c182a;border-radius:12px;padding:10px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 10px;color:#e5e7eb}
.tag.ok{border-color:#1d3e2a;background:#0f2f1e}
.tag.warn{border-color:#4a3b13;background:#2b2310}
.tag.bad{border-color:#5a1f1f;background:#2a1212}
.footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üìà‚õΩ</span>
      <div>
        <b>–ü–∞—Ä–∞ 19 ‚Äî –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∏–π –æ–±–ª—ñ–∫</b><br/>
        <span class="badge">–ü—Ä–æ—Ñ—ñ–ª—ñ (–≥–æ–¥) ‚Üí –∞–≥—Ä–µ–≥–∞—Ü—ñ—è ‚Üí –ø—ñ–∫–∏ ‚Üí –ª—ñ–º—ñ—Ç–∏ (Vday/Pmax) ‚Üí –∞–ª–µ—Ä—Ç–∏ ‚Üí –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <div class="card">
    <h2>üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>
    <p>–ü—Ä–∞—Ü—é—î–º–æ –∑ <b>–ø–æ–≥–æ–¥–∏–Ω–Ω–∏–º–∏ –ø—Ä–æ—Ñ—ñ–ª—è–º–∏</b> –≤—É–∑–ª—ñ–≤ (–ª—ñ—á–∏–ª—å–Ω–∏–∫–∏/–¢–ü). –ê–≥—Ä–µ–≥—É—î–º–æ –ø–æ <b>–≥—Ä—É–ø–∞—Ö</b> (Feeder/–†–∞–π–æ–Ω) —ñ –∫–æ–Ω—Ç—Ä–æ–ª—é—î–º–æ <b>–∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ñ –ª—ñ–º—ñ—Ç–∏</b>:
      <b>V<sub>day</sub></b> (–¥–æ–±–æ–≤–∏–π –æ–±—Å—è–≥, —Ç–∏—Å. –º¬≥) —Ç–∞ <b>P<sub>max</sub></b> (–ø–æ–≥–æ–¥–∏–Ω–Ω–∏–π –ø—ñ–∫, –º¬≥/–≥–æ–¥). –ü—Ä–∏ –ø–æ—Ä—É—à–µ–Ω–Ω—è—Ö ‚Äî <b>–∞–ª–µ—Ä—Ç–∏</b>. –ó–∞–¥–∞—á–∞: –Ω–∞–≤—á–∏—Ç–∏—Å—è —á–∏—Ç–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—ñ, 
      –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞—Ç–∏ –ø—ñ–∫–∏ —Ç–∞ –ø–æ—è—Å–Ω—é–≤–∞—Ç–∏ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è.</p>
    <div class="row">
      <label>–î–∞—Ç–∞ –ø—Ä–æ—Ñ—ñ–ª—é <input id="day" class="input" type="date"></label>
      <label>–ì—Ä—É–ø–∞/—Ñ—ñ–¥–µ—Ä <input id="group" class="input" placeholder="Feeder-A / –†–∞–π–æ–Ω-1"></label>
      <label>–í—É–∑–æ–ª (ID) <input id="node" class="input" placeholder="MTR-0001"></label>
      <label>–ë–∞–∑–æ–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –º¬≥/–≥–æ–¥ <input id="base" class="input" type="number" step="1" value="400"></label>
      <label>–ê–º–ø–ª. –ø—ñ–∫—ñ–≤, % <input id="amp" class="input" type="number" step="1" value="45"></label>
      <button class="btn" id="gen">üß™ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 24 —Ç–æ—á–∫–∏</button>
      <button class="btn secondary" id="add">‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
      <button class="btn" id="clr">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
    </div>
    <textarea id="txt" placeholder="–§–æ—Ä–º–∞—Ç —Ä—è–¥–∫–∞: HH; m3_per_hour (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 00; 320)
00; 320
01; 300
...
23; 410"></textarea>

    <div class="row" style="margin-top:6px">
      <label>–õ—ñ–º—ñ—Ç –¥–æ–±–æ–≤–∏–π Vday, —Ç–∏—Å. –º¬≥ <input id="limDay" class="input" type="number" step="0.1" value="9.5"></label>
      <label>–õ—ñ–º—ñ—Ç –ø–æ–≥–æ–¥–∏–Ω–Ω–∏–π Pmax, –º¬≥/–≥–æ–¥ <input id="limMax" class="input" type="number" step="10" value="580"></label>
      <button class="btn good" id="applyLim">‚öôÔ∏è –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ª—ñ–º—ñ—Ç–∏</button>
      <span class="badge">Œ£–≤—É–∑–ª—ñ–≤: <b id="nNodes">0</b></span>
      <span class="badge">Œ£–≥—Ä—É–ø: <b id="nGroups">0</b></span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>üìà –ì—Ä–∞—Ñ—ñ–∫ 1 ‚Äî –°—É–∫—É–ø–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å (–º¬≥/–≥–æ–¥)</h2>
      <div class="row">
        <label>–ü–æ–∫–∞–∑–∞—Ç–∏ –≥—Ä—É–ø—É
          <select id="selGroup" class="input"></select>
        </label>
        <label>–õ—ñ–Ω—ñ—è Pmax (–≤–∫–ª) <input id="shPmax" type="checkbox" checked></label>
        <label>–õ—ñ–Ω—ñ—è —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ <input id="shAvg" type="checkbox" checked></label>
        <button class="btn" id="mark">üìç –ó–Ω—è—Ç–∏ —Ç–æ—á–∫—É</button>
        <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
      </div>
      <canvas id="cMain" class="chart" width="560" height="240"></canvas>

      <h2 style="margin-top:10px">üìä –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ –ø—ñ–∫—ñ–≤ (–º¬≥/–≥–æ–¥)</h2>
      <canvas id="cHist" class="chart" width="560" height="240"></canvas>

      <h2 style="margin-top:10px">üìà –ö—É–º—É–ª—è—Ç–∏–≤ –¥–æ–±–∏ vs –ª—ñ–º—ñ—Ç (—Ç–∏—Å. –º¬≥)</h2>
      <canvas id="cCum" class="chart" width="560" height="240"></canvas>
    </div>

    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ / –∞–ª–µ—Ä—Ç–∏ / —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞</h2>
      <div class="row">
        <span class="tag ok">Œ£V<sub>day</sub>: <b id="mDay">‚Äî</b> —Ç–∏—Å. –º¬≥</span>
        <span class="tag warn">P<sub>max</sub> —Ñ–∞–∫—Ç: <b id="mPmax">‚Äî</b> –º¬≥/–≥–æ–¥</span>
        <span class="tag bad">–ü–æ—Ä—É—à–µ–Ω–Ω—è: <b id="mViol">0</b></span>
      </div>

      <table class="tbl" style="margin-top:8px">
        <thead><tr><th>#</th><th>–î–∞—Ç–∞</th><th>–ì—Ä—É–ø–∞</th><th>–í—É–∑–æ–ª</th><th>Pmax</th><th>Œ£Vday</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
        <tbody id="tbl"><tr><td colspan="7" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr></tbody>
      </table>

      <h3 style="margin-top:10px">üó∫Ô∏è –¢–µ–ø–ª–æ–∫–∞—Ä—Ç–∞ –≥–æ–¥–∏–Ω (–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)</h3>
      <canvas id="cHeat" class="map" width="520" height="240"></canvas>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="log">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV (–≤—É–∑–ª–∏ + —Å—É–º–∞—Ä–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
    <ol>
      <li>–°—Ç–≤–æ—Ä–∏ 2‚Äì3 –≤—É–∑–ª–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö –≥—Ä—É–ø–∞—Ö. –î–æ—Å—è–≥–Ω–∏ —Å–∏—Ç—É–∞—Ü—ñ—ó, –∫–æ–ª–∏ <b>—Å—É–º–∞ Vday</b> —É –≤–∏–±—Ä–∞–Ω—ñ–π –≥—Ä—É–ø—ñ <b>–º–∞–π–∂–µ –¥–æ—Ä—ñ–≤–Ω—é—î</b> –ª—ñ–º—ñ—Ç—É (–±–µ–∑ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è).</li>
      <li>–ó–Ω–∞–π–¥–∏ –≥–æ–¥–∏–Ω–∏, –¥–µ —Å—É–∫—É–ø–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –ø–µ—Ä–µ–≤–∏—â—É—î <b>Pmax</b>. –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π 2 —Å–ø–æ—Å–æ–±–∏ –∑–Ω–∏–∂–µ–Ω–Ω—è –ø—ñ–∫—É (—Ç–µ—Ö–Ω—ñ—á–Ω—ñ/–æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω—ñ).</li>
      <li>–ó–±—É–¥—É–π <b>–≥—ñ—Å—Ç–æ–≥—Ä–∞–º—É –ø—ñ–∫—ñ–≤</b> —Ç–∞ –ø–æ—è—Å–Ω–∏ ¬´–¥–æ–≤–≥–∏–π —Ö–≤—ñ—Å—Ç¬ª. –ó—Ä–æ–±–∏ –≤–∏—Å–Ω–æ–≤–æ–∫ —â–æ–¥–æ –¥–æ—Ü—ñ–ª—å–Ω–æ—Å—Ç—ñ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è Pmax.</li>
      <li>–ï–∫—Å–ø–æ—Ä—Ç—É–π CSV/TXT —ñ –ø—ñ–¥–≥–æ—Ç—É–π –∫–æ—Ä–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä—É –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è (—Ä–∏–∑–∏–∫ –ø–µ—Ä–µ–≤–∏—â–µ–Ω—å, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó).</li>
    </ol>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time id="upd"></time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString('uk-UA');const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
$('#upd').textContent=new Date().toLocaleDateString('uk-UA');
(function(){ const d=new Date(); $('#day').value=d.toISOString().slice(0,10); })();

/* ===== –°—Ö–æ–≤–∏—â–µ –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ ===== */
let PROFILES=[]; // {date, group, node, vals[24], sum, pmax}
let LIMITS={Vday:9.5, Pmax:580}; // Vday —Ç–∏—Å. –º3, Pmax –º3/–≥–æ–¥
let SERIES={t:[], Y:[]}; // –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ —Å—É–∫—É–ø–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é (–≤–∏–±—Ä–∞–Ω–∞ –≥—Ä—É–ø–∞)

/* ===== –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è/–ü–∞—Ä—Å–∏–Ω–≥ ===== */
function gen24(base, amp){
  // –¥–µ–Ω–Ω–∞ —Ñ–æ—Ä–º–∞: —Ä–∞–Ω–∫–æ–≤–∏–π —Ç–∞ –≤–µ—á—ñ—Ä–Ω—ñ–π –ø—ñ–∫–∏ + —à—É–º
  const out=[];
  for(let h=0;h<24;h++){
    const morning = Math.max(0, Math.sin((h-7)/3));   // ~7-10
    const evening = Math.max(0, Math.sin((h-19)/3));  // ~19-22
    const val = base * (0.65 + 0.35*morning + 0.45*evening) * (1 + (amp/100)*(Math.random()*0.2-0.1));
    out.push(Math.round(val));
  }
  return out;
}
function parseText(txt){
  const rows = txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  if(rows.length!==24) return null;
  const vals=[];
  for(const line of rows){
    const m=line.match(/^(\d{2});\s*([0-9]+(?:\.[0-9]+)?)$/);
    if(!m) return null;
    const h=parseInt(m[1]); const v=+m[2];
    if(h<0||h>23||!Number.isFinite(v)) return null;
    vals[h]=Math.round(v);
  }
  return vals;
}

/* ===== –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é ===== */
function recalc(p){
  p.sum = p.vals.reduce((a,b)=>a+b,0)/1000; // —Ç–∏—Å. –º3 –∑–∞ –¥–æ–±—É
  p.pmax = Math.max(...p.vals);
}
function addProfile(date, group, node, vals){
  const p={date, group, node, vals:vals.slice(), sum:0, pmax:0}; recalc(p);
  PROFILES.push(p);
  log(`–î–æ–¥–∞–Ω–æ –ø—Ä–æ—Ñ—ñ–ª—å: ${date} ${group}/${node}, Œ£=${p.sum.toFixed(3)} —Ç–∏—Å.–º¬≥, Pmax=${p.pmax} –º¬≥/–≥–æ–¥`);
  refreshGroups(); refreshTable(); redrawAll();
}
$('#gen').addEventListener('click',()=>{
  const vals=gen24( +$('#base').value||400, +$('#amp').value||40 );
  $('#txt').value = vals.map((v,h)=>`${String(h).padStart(2,'0')}; ${v}`).join('\n');
});
$('#add').addEventListener('click',()=>{
  const date=$('#day').value||'‚Äî', group=($('#group').value||'‚Äî').trim(), node=($('#node').value||'‚Äî').trim();
  const vals=parseText($('#txt').value);
  if(!group||!node||!vals){ alert('–ó–∞–ø–æ–≤–Ω–∏ –≥—Ä—É–ø—É/–≤—É–∑–æ–ª —ñ 24 —Ä—è–¥–∫–∏ —Ñ–æ—Ä–º–∞—Ç—É HH; value'); return; }
  addProfile(date, group, node, vals);
});
$('#clr').addEventListener('click',()=>{ PROFILES=[]; SERIES={t:[],Y:[]}; refreshGroups(); refreshTable(); redrawAll(); log('–û—á–∏—â–µ–Ω–æ'); });

/* ===== –õ—ñ–º—ñ—Ç–∏ ===== */
$('#applyLim').addEventListener('click',()=>{
  LIMITS.Vday = Math.max(0.1, parseFloat($('#limDay').value)||LIMITS.Vday);
  LIMITS.Pmax = Math.max(1, parseFloat($('#limMax').value)||LIMITS.Pmax);
  log(`–õ—ñ–º—ñ—Ç–∏: Vday=${LIMITS.Vday} —Ç–∏—Å.–º¬≥; Pmax=${LIMITS.Pmax} –º¬≥/–≥–æ–¥`); redrawAll();
});

/* ===== –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –ø–æ –≥—Ä—É–ø—ñ ===== */
function groups(){ return [...new Set(PROFILES.map(p=>p.group))]; }
function refreshGroups(){
  const gSel=$('#selGroup'); const gs=groups();
  gSel.innerHTML = gs.length? gs.map(g=>`<option>${g}</option>`).join('') : `<option>(–≤—Å—ñ)</option>`;
  $('#nNodes').textContent=String(PROFILES.length);
  $('#nGroups').textContent=String(gs.length);
}
$('#selGroup').addEventListener('change', redrawAll);

/* ===== –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —Å—É–º–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é, –ø—ñ–∫—ñ–≤, –∫—É–º—É–ª—è—Ç–∏–≤—É ===== */
function buildAggregate(group=null){
  // —Å—É–º—É—î–º–æ –ø–æ 24 –≥–æ–¥–∏–Ω–∞—Ö —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –≤—É–∑–ª—ñ–≤ —É –≥—Ä—É–ø—ñ (–∞–±–æ –ø–æ –≤—Å—ñ—Ö)
  const hours=new Array(24).fill(0);
  const filter = group? PROFILES.filter(p=>p.group===group) : PROFILES.slice();
  filter.forEach(p=>{ for(let h=0;h<24;h++) hours[h]+=p.vals[h]; });
  const sDay = hours.reduce((a,b)=>a+b,0)/1000; // —Ç–∏—Å.–º3
  const pMax = Math.max(...hours);
  return {hours, sDay, pMax, count:filter.length};
}

/* ===== –ì—Ä–∞—Ñ—ñ–∫ 1: —Å—É–∫—É–ø–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å ===== */
const cMain=$('#cMain'), g1=cMain.getContext('2d');
function drawMain(series, showAvg=true, showPmax=true){
  const W=cMain.width,H=cMain.height; g1.clearRect(0,0,W,H);
  g1.strokeStyle='#223049'; g1.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  // —Å—ñ—Ç–∫–∞
  g1.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; g1.beginPath(); g1.moveTo(left,y); g1.lineTo(right,y); g1.stroke(); }
  if(series.length===0){ g1.fillStyle='#94a3b8'; g1.fillText('–î–æ–¥–∞–π 1+ –ø—Ä–æ—Ñ—ñ–ª—ñ–≤', left+8, top+14); return; }
  const max=Math.max(LIMITS.Pmax, ...series);
  const X=i=> left + i/23*(right-left);
  const Y=v=> bottom - (v/max)*(bottom-top);
  // –∫—Ä–∏–≤–∞
  g1.beginPath(); g1.strokeStyle='#38bdf8';
  series.forEach((v,i)=>{ const x=X(i), y=Y(v); if(i===0) g1.moveTo(x,y); else g1.lineTo(x,y); });
  g1.stroke();
  // —Å–µ—Ä–µ–¥–Ω—î
  if(showAvg){ const avg=series.reduce((a,b)=>a+b,0)/Math.max(1,series.length);
    g1.strokeStyle='#22c55e'; const y=Y(avg); g1.beginPath(); g1.moveTo(left,y); g1.lineTo(right,y); g1.stroke();
    g1.fillStyle='#e5e7eb'; g1.font='11px ui-monospace'; g1.fillText('Avg', right-34, y-4);
  }
  // –ª—ñ–º—ñ—Ç Pmax
  if(showPmax){ const y=Y(LIMITS.Pmax); g1.strokeStyle='#fbbf24'; g1.beginPath(); g1.moveTo(left,y); g1.lineTo(right,y); g1.stroke();
    g1.fillStyle='#e5e7eb'; g1.font='11px ui-monospace'; g1.fillText('Pmax', right-44, y-4);
  }
}

/* ===== –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ –ø—ñ–∫—ñ–≤ ===== */
const cHist=$('#cHist'), g2=cHist.getContext('2d');
function drawHist(series){
  const W=cHist.width,H=cHist.height; g2.clearRect(0,0,W,H);
  g2.strokeStyle='#223049'; g2.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  if(series.length===0){ g2.fillStyle='#94a3b8'; g2.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', left+8, top+14); return; }
  const max=Math.max(...series); const bins=10, bw=(right-left)/bins;
  const step=Math.ceil(max/bins); const hist=new Array(bins).fill(0);
  series.forEach(v=>{ const i=Math.min(bins-1, Math.floor(v/step)); hist[i]++; });
  const hMax=Math.max(1, ...hist);
  // —Å—ñ—Ç–∫–∞
  g2.strokeStyle='#1f2a44'; for(let i=0;i<=4;i++){ const y=top+i*(bottom-top)/4; g2.beginPath(); g2.moveTo(left,y); g2.lineTo(right,y); g2.stroke(); }
  // —Å—Ç–æ–≤–ø—á–∏–∫–∏
  hist.forEach((c,i)=>{
    const x=left+i*bw+4; const h=(c/hMax)*(bottom-top);
    g2.fillStyle='#22c55e'; g2.fillRect(x, bottom-h, bw-8, h);
  });
  g2.fillStyle='#e5e7eb'; g2.font='11px ui-monospace';
  g2.fillText(`–ö—Ä–æ–∫ ~ ${step} –º¬≥/–≥–æ–¥`, right-120, top+12);
}

/* ===== –ö—É–º—É–ª—è—Ç–∏–≤ –¥–æ–±–∏ ===== */
const cCum=$('#cCum'), g3=cCum.getContext('2d');
function drawCum(series){
  const W=cCum.width,H=cCum.height; g3.clearRect(0,0,W,H);
  g3.strokeStyle='#223049'; g3.strokeRect(0.5,0.5,W-1,H-1);
  const left=40,right=W-10,top=20,bottom=H-26;
  if(series.length===0){ g3.fillStyle='#94a3b8'; g3.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', left+8, top+14); return; }
  // –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ —É —Ç–∏—Å.–º3, —ñ–Ω—Ç–µ–≥—Ä—É—é—á–∏ –≥–æ–¥–∏–Ω–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (–º3/–≥–æ–¥) ‚Üí —Å—É–º–∞/1000
  const cum=[]; let s=0; for(let h=0;h<24;h++){ s+=series[h]; cum[h]=s/1000; }
  const max=Math.max(LIMITS.Vday, ...cum);
  const X=i=> left + i/23*(right-left);
  const Y=v=> bottom - (v/max)*(bottom-top);
  g3.beginPath(); g3.strokeStyle='#38bdf8';
  cum.forEach((v,i)=>{ const x=X(i), y=Y(v); if(i===0) g3.moveTo(x,y); else g3.lineTo(x,y); }); g3.stroke();
  // Vday
  const y=Y(LIMITS.Vday); g3.strokeStyle='#fbbf24'; g3.beginPath(); g3.moveTo(left,y); g3.lineTo(right,y); g3.stroke();
  g3.fillStyle='#e5e7eb'; g3.font='11px ui-monospace'; g3.fillText('Vday', right-44, y-4);
}

/* ===== –¢–µ–ø–ª–æ–∫–∞—Ä—Ç–∞ –≥–æ–¥–∏–Ω √ó –≥—Ä—É–ø–∏ ===== */
const cHeat=$('#cHeat'), gh=cHeat.getContext('2d');
function drawHeat(){
  const W=cHeat.width,H=cHeat.height; gh.clearRect(0,0,W,H);
  gh.strokeStyle='#223049'; gh.strokeRect(0.5,0.5,W-1,H-1);
  const gs=groups(); const ROWS=gs.length, COLS=24;
  if(ROWS===0){ gh.fillStyle='#94a3b8'; gh.fillText('–î–æ–¥–∞–π –≥—Ä—É–ø–∏ ‚Äî –∑‚Äô—è–≤–∏—Ç—å—Å—è —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞', 16, 20); return; }
  const cellW=(W-80)/COLS, cellH=(H-40)/ROWS;
  // max –ø–æ –≤—Å—ñ—Ö –≥—Ä—É–ø–∞—Ö (–¥–ª—è –Ω–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É)
  let max=1; gs.forEach(g=>{ const a=buildAggregate(g).hours; a.forEach(v=>{ if(v>max) max=v;}); });
  // –ø—ñ–¥–ø–∏—Å–∏
  gh.fillStyle='#94a3b8'; gh.font='11px ui-monospace'; gh.fillText('–≥–æ–¥–∏–Ω–∏ ‚Üí', 80, 16);
  // –∫–ª—ñ—Ç–∏–Ω–∏
  gs.forEach((g,i)=>{
    const a=buildAggregate(g).hours;
    for(let h=0;h<24;h++){
      const x=80+h*cellW, y=24+i*cellH;
      const t=a[h]/max; const r=Math.floor(80+150*t), gg=Math.floor(100+120*t), b=120;
      gh.fillStyle=`rgb(${r},${gg},${b})`; gh.fillRect(x,y,cellW-1,cellH-1);
    }
    gh.fillStyle='#e5e7eb'; gh.fillText(g, 8, 24+i*cellH+Math.min(cellH-6,14));
  });
}

/* ===== –¢–∞–±–ª–∏—Ü—è/–º–µ—Ç—Ä–∏–∫–∏/–∞–ª–µ—Ä—Ç–∏ ===== */
function refreshTable(){
  const tb=$('#tbl'); tb.innerHTML='';
  if(PROFILES.length===0){ tb.innerHTML='<tr><td colspan="7" class="muted">‚Äî —â–µ –ø–æ—Ä–æ–∂–Ω—å–æ ‚Äî</td></tr>'; return; }
  const rows=PROFILES.slice().sort((a,b)=> (a.group.localeCompare(b.group) || a.node.localeCompare(b.node)) );
  let viol=0, sDayTot=0, pMaxTot=0;
  rows.forEach((p,i)=>{
    const vdayOk = p.sum <= LIMITS.Vday;
    const pmaxOk = p.pmax <= LIMITS.Pmax;
    const st = vdayOk && pmaxOk? '<b class="ok">OK</b>' : (vdayOk||pmaxOk? '<b class="warn">–ú–∞–π–∂–µ –ª—ñ–º—ñ—Ç</b>' : '<b class="bad">–ü–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è</b>');
    if(!vdayOk||!pmaxOk) viol++;
    sDayTot+=p.sum; pMaxTot=Math.max(pMaxTot,p.pmax);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.date}</td><td>${p.group}</td><td>${p.node}</td><td>${p.pmax}</td><td>${p.sum.toFixed(3)}</td><td>${st}</td>`;
    tb.appendChild(tr);
  });
  $('#mViol').textContent=viol.toString();
  $('#mDay').textContent=sDayTot.toFixed(3);
  $('#mPmax').textContent=pMaxTot.toFixed(0);
}

/* ===== –ó–≤–µ–¥–µ–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä ===== */
function redrawAll(){
  const gSel=$('#selGroup').value || null;
  const agg = buildAggregate(groups().includes(gSel)? gSel : null);
  SERIES.Y = agg.hours; SERIES.t=[...Array(24).keys()];
  drawMain(SERIES.Y, $('#shAvg').checked, $('#shPmax').checked);
  drawHist(SERIES.Y);
  drawCum(SERIES.Y);
  drawHeat();
  refreshTable();
}
$('#shPmax').addEventListener('change', ()=>drawMain(SERIES.Y, $('#shAvg').checked, $('#shPmax').checked));
$('#shAvg').addEventListener('change', ()=>drawMain(SERIES.Y, $('#shAvg').checked, $('#shPmax').checked));

/* ===== –ö–Ω–æ–ø–∫–∏ –≥—Ä–∞—Ñ—ñ–∫–∞ ===== */
$('#mark').addEventListener('click', ()=>{
  // ¬´–ú–∞—Ä–∫–∞¬ª = —â–µ –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ —ñ—Å—Ç–æ—Ä—ñ—ó –≥—Ä–∞—Ñ—ñ–∫–∞ ‚Äî –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —ñ –ª–æ–≥
  if(SERIES.Y.length){ const pmax=Math.max(...SERIES.Y); const day=SERIES.Y.reduce((a,b)=>a+b,0)/1000;
    log(`–ú–∞—Ä–∫–µ—Ä: Pmax=${pmax} –º¬≥/–≥–æ–¥; Œ£Vday=${day.toFixed(3)} —Ç–∏—Å.–º¬≥`); }
});
$('#clear').addEventListener('click', ()=>{ SERIES={t:[],Y:[]}; drawMain([],true,true); drawHist([]); drawCum([]); log('–ì—Ä–∞—Ñ—ñ–∫–∏ –æ—á–∏—â–µ–Ω–æ'); });

/* ===== –ï–∫—Å–ø–æ—Ä—Ç ===== */
$('#saveCsv').addEventListener('click',()=>{
  let csv='date,group,node,hour,value_m3ph,sum_km3,pmax_m3ph\n';
  PROFILES.forEach(p=>{
    for(let h=0;h<24;h++){ csv+=`${p.date},${p.group},${p.node},${String(h).padStart(2,'0')},${p.vals[h]},, \n`; }
    csv+=`,,,Œ£, ,${p.sum.toFixed(3)},${p.pmax}\n`;
  });
  // –¥–æ–¥–∞–º–æ —Å—É–∫—É–ø–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –≤–∏–±—Ä–∞–Ω–æ—ó –≥—Ä—É–ø–∏
  const gSel=$('#selGroup').value || '';
  const agg=buildAggregate(groups().includes(gSel)? gSel : null);
  csv+='\n# aggregate\nhour,value_m3ph\n';
  agg.hours.forEach((v,h)=>{ csv+=`${String(h).padStart(2,'0')},${v}\n`; });
  download('gas_para19_profiles_'+stamp()+'.csv', csv, 'text/csv'); log('CSV –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});
$('#saveTxt').addEventListener('click',()=>{
  const gSel=$('#selGroup').value || null;
  const agg=buildAggregate(groups().includes(gSel)? gSel : null);
  const lines=[
    '–ü–∞—Ä–∞ 19 ‚Äî –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∏–π –æ–±–ª—ñ–∫: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ü—Ä–æ—Ñ—ñ–ª—ñ: ${PROFILES.length}, –≥—Ä—É–ø: ${groups().length}`,
    `–õ—ñ–º—ñ—Ç–∏: Vday=${LIMITS.Vday} —Ç–∏—Å.–º¬≥; Pmax=${LIMITS.Pmax} –º¬≥/–≥–æ–¥`,
    `Œ£Vday(–∞–≥—Ä): ${agg.sDay.toFixed(3)} —Ç–∏—Å.–º¬≥; Pmax(–∞–≥—Ä): ${agg.pMax} –º¬≥/–≥–æ–¥; –≤—É–∑–ª—ñ–≤ —É –≤–∏–±–æ—Ä—ñ: ${agg.count}`,
    `–ü–æ—Ä—É—à–µ–Ω–Ω—è –∑–∞–≥–∞–ª–æ–º: ${$('#mViol').textContent}`
  ];
  download('gas_para19_summary_'+stamp()+'.txt', lines.join('\n')); log('TXT –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
});

/* ===== –Ü–Ω—ñ—Ç ===== */
refreshGroups(); redrawAll();
</script>
</body>
</html>
