<!-- electric_para9.html
     –ü–∞—Ä–∞ 9 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –í–£–ó–û–õ –ó–ê–ó–ï–ú–õ–ï–ù–ù–Ø
     –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–≥–ª—è–¥—É —ñ –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å: –æ–ø—ñ—Ä –∑–∞–∑–µ–º–ª—é–≤–∞—á–∞ (Œ©), –Ω–µ–ø–µ—Ä–µ—Ä–≤–Ω—ñ—Å—Ç—å PE (Œ©), –æ—Ü—ñ–Ω–∫–∞ PASS/FAIL, A4-–ø—Ä–æ—Ç–æ–∫–æ–ª (PDF/–¥—Ä—É–∫),
     –º—ñ—Ç–∫–∞ 58 –º–º ¬´–ó–ê–ó–ï–ú–õ–ï–ù–ù–Ø ¬∑ –ü–ï–†–ï–í–Ü–†–ï–ù–û¬ª, NFC/QR-—Ä—è–¥–æ–∫, —ñ–º–ø–æ—Ä—Ç/–µ–∫—Å–ø–æ—Ä—Ç CSV.
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è GitHub Pages —ñ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ Moodle —á–µ—Ä–µ–∑ <iframe>.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 9 ‚Äî –í—É–∑–æ–ª –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è: –ø—Ä–æ—Ç–æ–∫–æ–ª, PASS/FAIL, –¥—Ä—É–∫ 58 –º–º</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 80px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:#9aa5b1}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1000px){.g3{grid-template-columns:1fr}; .g2{grid-template-columns:1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .muted{color:#9aa5b1}

  /* –¢–∞–±–ª–∏—Ü—è */
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}

  /* –î—Ä—É–∫–æ–≤–∞–Ω–∞ –∑–æ–Ω–∞ A4 */
  #printArea{background:#fff; color:#000; border-radius:12px; border:1px solid #e5e7eb; padding:16px}
  .doc{page-break-after:always; padding:12mm; color:#000; font-family:Georgia,"Times New Roman",serif}
  .doc h2{color:#000; font-size:20px; margin:0 0 6px}
  .doc h3{color:#000; font-size:16px; margin:6px 0}
  .doc p{color:#000; margin:4px 0}
  .doc table{width:100%; border-collapse:collapse; border:1px solid #111}
  .doc th,.doc td{border:1px solid #111; padding:6px 8px; font-size:12px; vertical-align:top}
  .doc .sign{margin-top:10mm; display:flex; gap:10mm; flex-wrap:wrap}
  .doc .sign div{flex:1 1 220px}
  .chip{display:inline-block; padding:2px 8px; border:1px solid #111; border-radius:999px; font-size:11px; margin-right:6px}
  .okb{border-color:#16a34a} .badb{border-color:#dc2626}

  /* –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è 58 –º–º */
  .ticket{width:58mm; background:#fff; color:#000; padding:6mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px; font-size:13px; text-align:center}
  .ticket p{margin:2px 0; font-size:12px}
  .ticket .center{text-align:center}
  .ticket .line{border-top:1px dashed #111; margin:6px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}
  .tickets{display:flex; gap:12px; flex-wrap:wrap}

  /* –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (iframe/Moodle) */
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}

  @media print{
    @page{ size:A4; margin:12mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    #printArea{ border:none; padding:0 }
    .doc{ page-break-after:always }
  }
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

</head>
<body>
  <div class="wrap">
    <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 9 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
    <h1>üü© –í—É–∑–æ–ª –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è: –æ–≥–ª—è–¥, –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, A4-–ø—Ä–æ—Ç–æ–∫–æ–ª + üßæ –º—ñ—Ç–∫–∞ 58 –º–º</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>–í–∏–∫–æ–Ω–∞—Ç–∏ –æ–≥–ª—è–¥ –≤—É–∑–ª–∞ –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è, –≤–∏–º—ñ—Ä—è—Ç–∏ <b>–æ–ø—ñ—Ä –∑–∞–∑–µ–º–ª—é–≤–∞—á–∞</b> (Œ©) —Ç–∞ <b>–Ω–µ–ø–µ—Ä–µ—Ä–≤–Ω—ñ—Å—Ç—å –ø—Ä–æ–≤—ñ–¥–Ω–∏–∫–∞ PE</b> (Œ©), –æ—Ü—ñ–Ω–∏—Ç–∏ PASS/FAIL –∑–∞ –Ω–∞–≤—á–∞–ª—å–Ω–∏–º–∏ –ª—ñ–º—ñ—Ç–∞–º–∏, —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ A4-–ø—Ä–æ—Ç–æ–∫–æ–ª —ñ –º—ñ—Ç–∫—É 58 –º–º.</p>
      <p class="small">–ù–∞–≤—á–∞–ª—å–Ω—ñ –ª—ñ–º—ñ—Ç–∏ (—Å–ø—Ä–æ—â–µ–Ω–æ): <span class="chip">R<sub>–∑–∞–∑</sub> ‚â§ 4 Œ©</span> (TT/TN*), <span class="chip">R<sub>PE</sub> ‚â§ 0.5 Œ©</span> (–∫–æ–Ω—Ç–∏–Ω—É—ó—Ç–µ—Ç PE). –î–ª—è –æ–∫—Ä–µ–º–∏—Ö –æ–±‚Äô—î–∫—Ç—ñ–≤ –¥–æ–ø—É—Å–∫–∞—é—Ç—å—Å—è —ñ–Ω—à—ñ –ª—ñ–º—ñ—Ç–∏ ‚Äî –º–∏ –∑–∞–¥–∞—î–º–æ —ó—Ö —É –ø–æ–ª—ñ ¬´–õ—ñ–º—ñ—Ç¬ª –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ç–æ—á–∫–∏.</p>
    </div>

    <div class="card">
      <h2>üè∑Ô∏è –û–±‚Äô—î–∫—Ç —Ç–∞ —É–º–æ–≤–∏</h2>
      <div class="grid g2">
        <div>
          <div class="row">
            <label class="small" style="min-width:140px">–û–±‚Äô—î–∫—Ç/–∞–¥—Ä–µ—Å–∞</label>
            <input id="site" class="btn" value="–ö–æ–ª–µ–¥–∂ ¬∑ –ú–∞–π—Å—Ç–µ—Ä–Ω—è" />
          </div>
          <div class="row" style="margin-top:8px">
            <label class="small" style="min-width:140px">–°–∏—Å—Ç–µ–º–∞</label>
            <select id="system" class="btn"><option>TN</option><option selected>TT</option></select>
            <label class="small" style="min-width:80px">–¢–µ–º–ø. ¬∞C</label>
            <input id="temp" class="btn" type="number" value="20" />
          </div>
          <div class="row" style="margin-top:8px">
            <label class="small" style="min-width:140px">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</label>
            <input id="resp" class="btn" value="–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞" />
          </div>
        </div>
        <div>
          <div class="row">
            <button class="btn" type="button" onclick="seedDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥ –¥–∞–Ω–∏—Ö</button>
            <button class="btn" type="button" onclick="buildProtocol()">üß© –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ A4-–ø—Ä–æ—Ç–æ–∫–æ–ª</button>
            <button class="btn" type="button" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫ / PDF</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" type="button" onclick="exportCSV()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
            <input id="file" type="file" accept=".csv,text/csv" class="btn" />
            <button class="btn" type="button" onclick="importCSV()">‚¨ÜÔ∏è –Ü–º–ø–æ—Ä—Ç CSV</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>‚ûï –¢–æ—á–∫–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è</h2>
      <div class="grid g3">
        <div>
          <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
          <div class="row"><label class="small" style="min-width:120px">–¢–∏–ø</label>
            <select id="ptType" class="btn">
              <option selected>R–∑–∞–∑ (–µ–ª–µ–∫—Ç—Ä–æ–¥/–∫–æ–Ω—Ç—É—Ä)</option>
              <option>RPE (–Ω–µ–ø–µ—Ä–µ—Ä–≤–Ω—ñ—Å—Ç—å PE)</option>
            </select>
          </div>
          <div class="row" style="margin-top:6px"><label class="small" style="min-width:120px">–ù–∞–∑–≤–∞ —Ç–æ—á–∫–∏</label>
            <input id="ptName" class="btn" value="–ö–æ–Ω—Ç—É—Ä 1 ¬∑ –±–æ–ª—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π"/>
          </div>
          <div class="row" style="margin-top:6px"><label class="small" style="min-width:120px">R –≤–∏–º—ñ—Ä., Œ©</label>
            <input id="ptR" class="btn" type="number" step="0.01" value="3.2"/>
          </div>
          <div class="row" style="margin-top:6px"><label class="small" style="min-width:120px">–õ—ñ–º—ñ—Ç, Œ©</label>
            <input id="ptLimit" class="btn" type="number" step="0.01" value="4"/>
          </div>
          <div class="row" style="margin-top:6px"><label class="small" style="min-width:120px">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
            <input id="ptNote" class="btn" placeholder="—Å—Ö–µ–º–∞ 62% / 3-–∫i–ª–∫–∏ / –¥–æ–≤–∂–∏–Ω–∞..." />
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" onclick="addPoint()">‚ûï –î–æ–¥–∞—Ç–∏</button>
            <button class="btn" onclick="seedPoints()">üîÑ 2 –ø—Ä–∏–∫–ª–∞–¥–∏</button>
          </div>
        </div>

        <div class="g2">
          <div>
            <h3>–§—ñ–ª—å—Ç—Ä</h3>
            <div class="row">
              <select id="flt" class="btn">
                <option selected>–í—Å—ñ</option>
                <option>–õ–∏—à–µ R–∑–∞–∑</option>
                <option>–õ–∏—à–µ RPE</option>
                <option>–õ–∏—à–µ FAIL</option>
                <option>–õ–∏—à–µ PASS</option>
              </select>
              <button class="btn" onclick="render()">üîé –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            </div>
            <p class="small">PASS, —è–∫—â–æ <span class="mono">R–≤–∏–º—ñ—Ä ‚â§ –õ—ñ–º—ñ—Ç</span>.</p>
          </div>
          <div>
            <h3>–°–µ—Ä–≤—ñ—Å</h3>
            <div class="row">
              <button class="btn" onclick="clearAll()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
              <button class="btn" onclick="buildLabel()">üßæ –ú—ñ—Ç–∫–∞ 58 –º–º</button>
            </div>
            <p class="small">–ú—ñ—Ç–∫–∞ –±—É–¥—É—î—Ç—å—Å—è –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –∞–±–æ –ø–µ—Ä—à–æ–≥–æ —É —Å–ø–∏—Å–∫—É.</p>
          </div>
        </div>

        <div>
          <h3>–í–∏–±—ñ—Ä –¥–ª—è –º—ñ—Ç–∫–∏</h3>
          <div class="row">
            <select id="labelSel" class="btn"></select>
          </div>
          <p class="small">–í–∏–±–µ—Ä–∏ —Ç–æ—á–∫—É –∑—ñ —Å–ø–∏—Å–∫—É ‚Äî –¥–∞–Ω—ñ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –≤ –º—ñ—Ç–∫—É 58 –º–º.</p>
        </div>
      </div>
    </div>

    <div class="card printable">
      <h2>üìã –ñ—É—Ä–Ω–∞–ª –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞ —Ç–æ—á–∫–∏</th><th>R –≤–∏–º—ñ—Ä, Œ©</th><th>–õ—ñ–º—ñ—Ç, Œ©</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th><th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small">–ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ ‚Äî —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ—Ç–∏–Ω–∫–∏. –ö–Ω–æ–ø–∫–∏ —É –¥—ñ—ó: –ú—ñ—Ç–∫–∞/‚úñ.</p>
    </div>

    <div class="card printable">
      <h2>üßæ –ú—ñ—Ç–∫–∞ 58 –º–º ¬´–ó–ê–ó–ï–ú–õ–ï–ù–ù–Ø ¬∑ –ü–ï–†–ï–í–Ü–†–ï–ù–û¬ª</h2>
      <div class="row">
        <button class="btn" onclick="buildLabel()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
        <button class="btn" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
        <button class="btn" onclick="downloadTXT()">üì• TXT</button>
      </div>
      <div class="tickets" id="tickets">
        <div id="ticket" class="ticket" aria-live="polite">
          <h4>–ó–ê–ó–ï–ú–õ–ï–ù–ù–Ø ¬∑ –ü–ï–†–ï–í–Ü–†–ï–ù–û</h4>
          <p class="center"><small id="t-date">–î–∞—Ç–∞: ‚Äî</small></p>
          <div class="line"></div>
          <p><b id="t-site">–û–±‚Äô—î–∫—Ç: ‚Äî</b></p>
          <p>–°–∏—Å—Ç–µ–º–∞: <span id="t-sys">‚Äî</span> ¬∑ T= <span id="t-temp">‚Äî</span>¬∞C</p>
          <p>–¢–æ—á–∫–∞: <span id="t-name">‚Äî</span></p>
          <p>–¢–∏–ø/–õ—ñ–º—ñ—Ç: <span id="t-type">‚Äî</span> / <span id="t-lim">‚Äî</span> Œ©</p>
          <p>R –≤–∏–º—ñ—Ä: <span id="t-R">‚Äî</span> Œ© ¬∑ –°—Ç–∞—Ç—É—Å: <span id="t-status">‚Äî</span></p>
          <div class="line"></div>
          <p class="center"><small>–í—ñ–¥–ø.: <span id="t-resp">‚Äî</span></small></p>
          <p class="qr"><small id="t-ref">Ref: EARTH-0001</small></p>
        </div>
      </div>
    </div>

    <div class="card printable">
      <h2>üìÑ A4-–ø—Ä–æ—Ç–æ–∫–æ–ª (–¥–ª—è –¥—Ä—É–∫—É/PDF)</h2>
      <div id="printArea"></div>
    </div>
  </div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–æ —É Moodle ‚Üí —Å—Ç—Ä–∏–º–∞–Ω—ñ—à–∞ –ø–∞–ª—ñ—Ç—Ä–∞
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // –°—Ç–∞–Ω
  let points = []; // {id, type, name, R, limit, note, status}
  const tbody = document.querySelector('#tbl tbody');
  const labelSel = document.getElementById('labelSel');

  function pad(n){ return n.toString().padStart(2,'0'); }
  function nowStamp(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è / –ø—Ä–∏–∫–ª–∞–¥–∏
  function addPoint(){
    const type = document.getElementById('ptType').value;
    const name = document.getElementById('ptName').value.trim() || (type.startsWith('R–∑–∞–∑')?'–ö–æ–Ω—Ç—É—Ä':'PE-–ª—ñ–Ω—ñ—è');
    const R = parseFloat(document.getElementById('ptR').value);
    const limit = parseFloat(document.getElementById('ptLimit').value);
    const note = document.getElementById('ptNote').value.trim();
    if(!(R>=0) || !(limit>0)){ alert('–ü–µ—Ä–µ–≤—ñ—Ä R —Ç–∞ –õ—ñ–º—ñ—Ç'); return; }
    const status = (R <= limit) ? 'PASS' : 'FAIL';
    const rec = { id: 'E'+Math.random().toString(36).slice(2,7).toUpperCase(), type, name, R:round2(R), limit:round2(limit), note, status };
    points.push(rec); render(); rebuildLabelSel();
  }

  function seedPoints(){
    // 2 –ø—Ä–∏–∫–ª–∞–¥–∏: R–∑–∞–∑ OK —Ç–∞ RPE FAIL
    document.getElementById('ptType').value='R–∑–∞–∑ (–µ–ª–µ–∫—Ç—Ä–æ–¥/–∫–æ–Ω—Ç—É—Ä)';
    document.getElementById('ptName').value='–ö–æ–Ω—Ç—É—Ä 1 ¬∑ –±–æ–ª—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π';
    document.getElementById('ptR').value=3.2; document.getElementById('ptLimit').value=4; addPoint();
    document.getElementById('ptType').value='RPE (–Ω–µ–ø–µ—Ä–µ—Ä–≤–Ω—ñ—Å—Ç—å PE)';
    document.getElementById('ptName').value='PE –ª—ñ–Ω—ñ—è ¬∑ —â–∏—Ç ‚Äî —Ä–æ–∑–µ—Ç–∫–∞ 01';
    document.getElementById('ptR').value=0.72; document.getElementById('ptLimit').value=0.5; addPoint();
  }

  function seedDemo(){
    document.getElementById('site').value='–ö–æ–ª–µ–¥–∂ ¬∑ –ú–∞–π—Å—Ç–µ—Ä–Ω—è';
    document.getElementById('system').value='TT';
    document.getElementById('temp').value=20;
    document.getElementById('resp').value='–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞';
    points = [];
    seedPoints();
  }

  // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ + —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  function render(){
    const flt = document.getElementById('flt').value;
    tbody.innerHTML='';
    let view = points.slice();
    if(flt==='–õ–∏—à–µ R–∑–∞–∑') view = view.filter(p=>p.type.startsWith('R–∑–∞–∑'));
    if(flt==='–õ–∏—à–µ RPE') view = view.filter(p=>p.type.startsWith('RPE'));
    if(flt==='–õ–∏—à–µ FAIL') view = view.filter(p=>p.status==='FAIL');
    if(flt==='–õ–∏—à–µ PASS') view = view.filter(p=>p.status==='PASS');

    view.forEach((p,i)=>{
      const tr=document.createElement('tr');
      const badge = `<span class="mono" style="padding:2px 8px;border:1px solid #223049;border-radius:999px;background:#0d1a2e;color:${p.status==='PASS'?'#22c55e':'#ef4444'}">${p.status}</span>`;
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="editable" data-k="type" data-id="${p.id}">${escapeHTML(p.type)}</td>
        <td class="editable" data-k="name" data-id="${p.id}">${escapeHTML(p.name)}</td>
        <td class="editable" data-k="R" data-id="${p.id}">${escapeHTML(p.R)}</td>
        <td class="editable" data-k="limit" data-id="${p.id}">${escapeHTML(p.limit)}</td>
        <td>${badge}</td>
        <td class="editable" data-k="note" data-id="${p.id}">${escapeHTML(p.note||'')}</td>
        <td class="mono"><button class="btn" data-act="label" data-id="${p.id}">–ú—ñ—Ç–∫–∞</button> <button class="btn" data-act="del" data-id="${p.id}">‚úñ</button></td>`;
      tbody.appendChild(tr);
    });
  }

  tbody.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('.editable'); if(!td) return;
    const key = td.getAttribute('data-k'); const id = td.getAttribute('data-id');
    const idx = points.findIndex(x=>x.id===id); const p = points[idx];
    const input = document.createElement('input'); input.value = p[key]; input.style.width='100%'; input.style.padding='6px 8px';
    input.addEventListener('blur', ()=>{
      let v = input.value.trim();
      if(key==='R' || key==='limit'){ v = round2(parseFloat(v)); if(!(v>=0)){ v = p[key]; } }
      p[key] = v;
      if(key==='R' || key==='limit'){ p.status = (parseFloat(p.R) <= parseFloat(p.limit)) ? 'PASS' : 'FAIL'; }
      render(); rebuildLabelSel();
    });
    td.innerHTML=''; td.appendChild(input); input.focus(); input.select();
  });

  tbody.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
    if(act==='del'){ points = points.filter(x=>x.id!==id); render(); rebuildLabelSel(); return; }
    if(act==='label'){ labelSel.value = id; buildLabel(); document.getElementById('ticket').scrollIntoView({behavior:'smooth'}); }
  });

  function rebuildLabelSel(){
    labelSel.innerHTML='';
    points.forEach(p=>{
      const opt=document.createElement('option'); opt.value=p.id; opt.textContent=`${p.name} (${p.status})`;
      labelSel.appendChild(opt);
    });
  }

  function clearAll(){ if(confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –∂—É—Ä–Ω–∞–ª?')){ points=[]; render(); rebuildLabelSel(); } }

  // –ú—ñ—Ç–∫–∞ 58 –º–º
  function buildLabel(){
    const sel = labelSel.value || (points[0]?.id || '');
    const p = points.find(x=>x.id===sel);
    const site = document.getElementById('site').value.trim() || '‚Äî';
    const sys = document.getElementById('system').value;
    const temp = document.getElementById('temp').value || '‚Äî';
    const resp = document.getElementById('resp').value.trim() || '‚Äî';

    document.getElementById('t-date').textContent = `–î–∞—Ç–∞: ${nowStamp()}`;
    document.getElementById('t-site').textContent = `–û–±‚Äô—î–∫—Ç: ${site}`;
    document.getElementById('t-sys').textContent = sys;
    document.getElementById('t-temp').textContent = temp;
    document.getElementById('t-resp').textContent = resp;

    if(!p){
      document.getElementById('t-name').textContent='‚Äî';
      document.getElementById('t-type').textContent='‚Äî';
      document.getElementById('t-lim').textContent='‚Äî';
      document.getElementById('t-R').textContent='‚Äî';
      document.getElementById('t-status').textContent='‚Äî';
      document.getElementById('t-ref').textContent='Ref: EARTH-XXXX';
      return;
    }
    document.getElementById('t-name').textContent = p.name;
    document.getElementById('t-type').textContent = p.type.startsWith('R–∑–∞–∑')?'R–∑–∞–∑':'RPE';
    document.getElementById('t-lim').textContent = p.limit;
    document.getElementById('t-R').textContent = p.R;
    document.getElementById('t-status').textContent = p.status;
    const ref = 'EARTH-' + Math.random().toString(36).slice(2,8).toUpperCase();
    document.getElementById('t-ref').textContent = `Ref: ${ref}`;
  }

  function downloadTXT(){
    const lines = [];
    lines.push('EARTHING CHECK 58mm');
    lines.push('-------------------');
    lines.push(document.getElementById('t-date').textContent);
    lines.push(document.getElementById('t-site').textContent);
    lines.push(`–°–∏—Å—Ç–µ–º–∞: ${document.getElementById('t-sys').textContent} ¬∑ T=${document.getElementById('t-temp').textContent}¬∞C`);
    lines.push(`–¢–æ—á–∫–∞: ${document.getElementById('t-name').textContent}`);
    lines.push(`–¢–∏–ø/–õ—ñ–º—ñ—Ç: ${document.getElementById('t-type').textContent} / ${document.getElementById('t-lim').textContent} Œ©`);
    lines.push(`R –≤–∏–º—ñ—Ä: ${document.getElementById('t-R').textContent} Œ© ¬∑ –°—Ç–∞—Ç—É—Å: ${document.getElementById('t-status').textContent}`);
    lines.push(`–í—ñ–¥–ø.: ${document.getElementById('t-resp').textContent}`);
    lines.push(document.getElementById('t-ref').textContent);
    const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='earthing_check_58mm.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  // A4-–ø—Ä–æ—Ç–æ–∫–æ–ª
  function buildProtocol(){
    if(!points.length){ alert('–î–æ–¥–∞–π —Ö–æ—á–∞ –± –æ–¥–Ω—É —Ç–æ—á–∫—É'); return; }
    const site = escapeHTML(document.getElementById('site').value.trim() || '‚Äî');
    const sys = escapeHTML(document.getElementById('system').value);
    const temp = escapeHTML(document.getElementById('temp').value);
    const resp = escapeHTML(document.getElementById('resp').value.trim() || '‚Äî');
    const passCount = points.filter(p=>p.status==='PASS').length;
    const failCount = points.filter(p=>p.status==='FAIL').length;

    const rowsHTML = points.map((p,i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${escapeHTML(p.type)}</td>
        <td>${escapeHTML(p.name)}</td>
        <td>${escapeHTML(p.R)}</td>
        <td>${escapeHTML(p.limit)}</td>
        <td>${escapeHTML(p.status)}</td>
        <td>${escapeHTML(p.note||'')}</td>
      </tr>`).join('');

    const docHTML = `
      <section class="doc">
        <h2>–ü–†–û–¢–û–ö–û–õ –û–ì–õ–Ø–î–£ –¢–ê –í–ò–ú–Ü–†–Æ–í–ê–ù–¨ –í–£–ó–õ–ê –ó–ê–ó–ï–ú–õ–ï–ù–ù–Ø</h2>
        <p class="muted">–û–±‚Äô—î–∫—Ç: ${site} ¬∑ –°–∏—Å—Ç–µ–º–∞: ${sys} ¬∑ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${temp} ¬∞C ¬∑ –î–∞—Ç–∞: ${nowStamp()}</p>
        <p>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π: ${resp}</p>
        <h3>1. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å</h3>
        <table>
          <thead>
            <tr><th>‚Ññ</th><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞ —Ç–æ—á–∫–∏</th><th>R –≤–∏–º—ñ—Ä, Œ©</th><th>–õ—ñ–º—ñ—Ç, Œ©</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th></tr>
          </thead>
          <tbody>${rowsHTML}</tbody>
        </table>
        <h3>2. –í–∏—Å–Ω–æ–≤–æ–∫</h3>
        <p>–ü–æ–∑–∏—Ü—ñ–π PASS: <span class="chip okb">${passCount}</span> ¬∑ –ü–æ–∑–∏—Ü—ñ–π FAIL: <span class="chip badb">${failCount}</span>.</p>
        <p>${failCount ? '–í–∏—è–≤–ª–µ–Ω—ñ –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Å–ª—ñ–¥ —É—Å—É–Ω—É—Ç–∏ —Ç–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É.' : '–°—Ç–∞–Ω –≤—É–∑–ª–∞ –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞–≤—á–∞–ª—å–Ω–∏–º –∫—Ä–∏—Ç–µ—Ä—ñ—è–º —Ü—ñ—î—ó —Ä–æ–±–æ—Ç–∏.'}</p>
        <div class="sign">
          <div>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: _____________________ / ${resp}</div>
          <div>–ö–µ—Ä—ñ–≤–Ω–∏–∫ —Ä–æ–±—ñ—Ç: _____________________</div>
        </div>
        <p class="muted">–¶–µ–π –ø—Ä–æ—Ç–æ–∫–æ–ª –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —É –º–µ–∂–∞—Ö –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –∫—É—Ä—Å—É ¬´–ö–æ–º–ø‚Äô—é—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è¬ª.</p>
      </section>
    `;
    document.getElementById('printArea').innerHTML = docHTML;
    document.getElementById('printArea').scrollIntoView({behavior:'smooth'});
  }

  // CSV I/O
  function exportCSV(){
    const headers = ['type','name','R_ohm','limit_ohm','status','note','site','system','temp_C','responsible','timestamp'];
    const site = document.getElementById('site').value.trim();
    const sys = document.getElementById('system').value;
    const temp = document.getElementById('temp').value;
    const resp = document.getElementById('resp').value.trim();
    const stamp = nowStamp();
    const csv = [headers.join(','), ...points.map(p=>[
      p.type, p.name, p.R, p.limit, p.status, p.note||'', site, sys, temp, resp, stamp
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download='earthing_protocol.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  async function importCSV(){
    const f=document.getElementById('file').files[0]; if(!f){ alert('–û–±–µ—Ä—ñ—Ç—å CSV'); return; }
    const txt=await f.text();
    const lines=txt.trim().split(/\r?\n/); if(lines.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers=lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const req=['type','name','R_ohm','limit_ohm','status','note']; const miss=req.filter(x=>!headers.includes(x));
    if(miss.length){ alert('–í—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è: '+miss.join(', ')); return; }
    const out=[];
    for(let i=1;i<lines.length;i++){
      const cells = splitCSV(lines[i]); if(!cells.length) continue;
      const o={}; headers.forEach((h,j)=> o[h]=(cells[j]||'').replace(/^"|"$/g,''));
      out.push({
        id:'E'+Math.random().toString(36).slice(2,7).toUpperCase(),
        type:o.type, name:o.name, R:round2(parseFloat(o.R_ohm||'0')), limit:round2(parseFloat(o.limit_ohm||'0')),
        note:o.note||'', status:(o.status||((parseFloat(o.R_ohm||'0')<=parseFloat(o.limit_ohm||'0'))?'PASS':'FAIL'))
      });
    }
    points = out; render(); rebuildLabelSel();
  }

  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  function round2(x){ return Math.round(x*100)/100; }

  // –ê–≤—Ç–æ-–¥–µ–º–æ
  seedDemo();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>

</body>
</html>
