<!-- electric_para5.html
     –ü–∞—Ä–∞ 5 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –ü–ª–∞–Ω/–§–∞–∫—Ç –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å U,I ¬∑ –∂—É—Ä–Ω–∞–ª ¬∑ PASS/FAIL ¬∑ –¥—Ä—É–∫ 58 –º–º ¬∑ –µ–∫—Å–ø–æ—Ä—Ç CSV
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è GitHub Pages —ñ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ Moodle —á–µ—Ä–µ–∑ <iframe>.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 5 ‚Äî –ü–ª–∞–Ω/–§–∞–∫—Ç –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å, –∂—É—Ä–Ω–∞–ª, –¥—Ä—É–∫ 58 –º–º</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1024px; margin:0 auto; padding:24px 16px 64px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:var(--muted)}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

  /* –¢–∞–±–ª–∏—Ü—è */
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}

  /* –§–æ—Ä–º–∏ */
  .field{display:flex; gap:8px; margin:6px 0}
  .field label{min-width:170px; color:#cbd5e1}
  .field input,.field select{flex:1; padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e5e7eb}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  @media (max-width:900px){.g2{grid-template-columns:1fr}}

  /* –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è 58 –º–º */
  .ticket{width:58mm; background:#fff; color:#000; padding:6mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px; font-size:13px; text-align:center}
  .ticket p{margin:2px 0; font-size:12px}
  .ticket .center{text-align:center}
  .ticket .line{border-top:1px dashed #111; margin:6px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}

  /* –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (iframe/Moodle) */
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}

  @media print{
    @page{ size:58mm auto; margin:4mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

</head>
<body>
  <div class="wrap">
    <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 5 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
    <h1>üìè –ü–ª–∞–Ω/–§–∞–∫—Ç –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å U,I ¬∑ –∂—É—Ä–Ω–∞–ª ¬∑ üßæ ¬´–ü–ï–†–ï–í–Ü–†–ï–ù–û 58 –º–º¬ª</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>–ó–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ª—ñ–Ω—ñ—ó –∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è–º–∏: —ñ–º–ø–æ—Ä—Ç <span class="mono">line_calc.csv</span> –∑ –ü–∞—Ä–∞ 4, –≤–∏–º—ñ—Ä—è—Ç–∏ U —Ç–∞ I –≤ —Ç–æ—á–∫–∞—Ö, —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è, –ø—Ä–∏—Å–≤–æ—ó—Ç–∏ PASS/FAIL, –Ω–∞–¥—Ä—É–∫—É–≤–∞—Ç–∏ ¬´–ü–ï–†–ï–í–Ü–†–ï–ù–û¬ª —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª —É CSV.</p>
      <div class="row">
        <input id="file" type="file" accept=".csv,text/csv" class="btn" />
        <button class="btn" type="button" onclick="pasteSample()">‚¨áÔ∏è –ù–∞–≤—á–∞–ª—å–Ω–∏–π CSV</button>
        <button class="btn" type="button" onclick="parseLine()">üîé –Ü–º–ø–æ—Ä—Ç –ø–ª–∞–Ω—É</button>
      </div>
      <p class="small">–û—á—ñ–∫—É–≤–∞–Ω—ñ –ø–æ–ª—è —É CSV: <span class="mono">line_name,phase,U_V,P_kW,cos_phi,eta,I_A,material,section_mm2,ampacity_A,MCB_A,length_m,voltage_drop_pct,drop_limit_pct,install,responsible</span></p>
    </div>

    <div class="card">
      <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–æ–ø—É—Å–∫—ñ–≤ (–Ω–∞–≤—á–∞–ª—å–Ω—ñ)</h2>
      <div class="grid g2">
        <div class="field">
          <label for="tolU">–î–æ–ø—É—Å–∫ –Ω–∞–ø—Ä—É–≥–∏, %</label>
          <input id="tolU" type="number" step="0.1" value="10" />
        </div>
        <div class="field">
          <label for="tolI">–î–æ–ø—É—Å–∫ —Å—Ç—Ä—É–º—É, %</label>
          <input id="tolI" type="number" step="0.1" value="20" />
        </div>
      </div>
      <p class="small">–í —Ä–µ–∞–ª—å–Ω—ñ–π –ø—Ä–∞–∫—Ç–∏—Ü—ñ –¥–æ–ø—É—Å–∫–∏ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –Ω–æ—Ä–º–∞—Ç–∏–≤—ñ–≤ —Ç–∞ —Ç–∏–ø—É –æ–±‚Äô—î–∫—Ç–∞ ‚Äî —Ç—É—Ç —Å–ø—Ä–æ—â–µ–Ω–∞ –Ω–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å.</p>
    </div>

    <div class="card">
      <h2>‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è</h2>
      <div class="grid g2">
        <div>
          <div class="field"><label for="ptName">–ù–∞–∑–≤–∞ —Ç–æ—á–∫–∏</label><input id="ptName" type="text" value="–©–∏—Ç / –í–≤—ñ–¥" /></div>
          <div class="field"><label for="Umeas">U —Ñ–∞–∫—Ç, –í</label><input id="Umeas" type="number" step="0.1" /></div>
          <div class="field"><label for="Imeas">I —Ñ–∞–∫—Ç, –ê</label><input id="Imeas" type="number" step="0.01" /></div>
          <div class="row">
            <button class="btn" type="button" onclick="addPoint()">‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∂—É—Ä–Ω–∞–ª</button>
            <button class="btn" type="button" onclick="seedPoints()">üîÑ –ü—Ä–∏–∫–ª–∞–¥ —Ç–æ—á–æ–∫</button>
          </div>
        </div>
        <div>
          <p class="small">–ü–æ—Ä–∞–¥–∞: –¥–æ–¥–∞–π 2‚Äì3 —Ç–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ¬´–©–∏—Ç/–í–≤—ñ–¥¬ª, ¬´–†–æ–∑–µ—Ç–∫–∞ 1¬ª, ¬´–†–æ–∑–µ—Ç–∫–∞ 2¬ª). –ó–∞–ø–∏—à–∏ —Ä–µ–∞–ª—å–Ω—ñ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –∑ –º—É–ª—å—Ç–∏–º–µ—Ç—Ä–∞.</p>
        </div>
      </div>
    </div>

    <div class="card printable">
      <h2>üìã –ñ—É—Ä–Ω–∞–ª –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å (–ø–ª–∞–Ω/—Ñ–∞–∫—Ç)</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th><th>–¢–æ—á–∫–∞</th><th>U –ø–ª–∞–Ω, –í</th><th>U —Ñ–∞–∫—Ç, –í</th><th>ŒîU, %</th>
            <th>I –ø–ª–∞–Ω, –ê</th><th>I —Ñ–∞–∫—Ç, –ê</th><th>ŒîI, %</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small">PASS ‚Äî –æ–±–∏–¥–≤–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≤ –º–µ–∂–∞—Ö –¥–æ–ø—É—Å–∫—ñ–≤. –Ü–Ω–∞–∫—à–µ ‚Äî FAIL.</p>
    </div>

    <div class="card">
      <h2>üßæ –ú—ñ—Ç–∫–∞ ¬´–ü–ï–†–ï–í–Ü–†–ï–ù–û¬ª (58 –º–º)</h2>
      <div class="grid g2">
        <div>
          <div id="ticket" class="ticket" aria-live="polite">
            <h4>–ü–ï–†–ï–í–Ü–†–ï–ù–û ¬∑ –õ–Ü–ù–Ü–Ø</h4>
            <p class="center"><small id="t-date">–î–∞—Ç–∞: ‚Äî</small></p>
            <div class="line"></div>
            <p><b id="t-line">–õ—ñ–Ω—ñ—è: ‚Äî</b></p>
            <p>–¢–æ—á–∫–∞: <span id="t-pt">‚Äî</span></p>
            <p>U –ø–ª–∞–Ω/—Ñ–∞–∫—Ç: <span id="t-Upair">‚Äî</span></p>
            <p>I –ø–ª–∞–Ω/—Ñ–∞–∫—Ç: <span id="t-Ipair">‚Äî</span></p>
            <p>ŒîU/ŒîI: <span id="t-deltas">‚Äî</span></p>
            <p>–°—Ç–∞—Ç—É—Å: <span id="t-status">‚Äî</span></p>
            <div class="line"></div>
            <p class="center"><small>–í—ñ–¥–ø.: <span id="t-resp">‚Äî</span></small></p>
            <p class="qr"><small id="t-ref">Ref: MEAS-0001</small></p>
          </div>
          <div class="row no-print" style="margin-top:8px">
            <button class="btn" type="button" onclick="buildTicket()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
            <button class="btn" type="button" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
            <button class="btn" type="button" onclick="downloadTXT()">üì• TXT</button>
          </div>
        </div>
        <div>
          <div class="field"><label for="resp">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</label><input id="resp" type="text" value="–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞" /></div>
          <div class="field"><label for="stickPt">–¢–æ—á–∫–∞ –¥–ª—è –º—ñ—Ç–∫–∏</label>
            <select id="stickPt"></select>
          </div>
          <div class="small">–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –∑ –∂—É—Ä–Ω–∞–ª—É ‚Äî –¥–∞–Ω—ñ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —É –∫–≤–∏—Ç–∞–Ω—Ü—ñ—é.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üì§ –ï–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª—É</h2>
      <div class="row">
        <button class="btn" type="button" onclick="exportCSV()">CSV</button>
      </div>
      <p class="small">–ù–∞–∑–≤–∞ —Ñ–∞–π–ª—É: <span class="mono">–ì–†–£–ü–ê_–ü—Ä—ñ–∑–≤–∏—â–µ_–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è.csv</span></p>
    </div>
  </div>

<script>
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // –°—Ç–∞–Ω
  let plan = { name:'‚Äî', U:230, I:10 };
  let points = []; // {id, name, Uplan, Ufact, dU, Iplan, Ifact, dI, status}
  const tblBody = document.querySelector('#tbl tbody');
  const stickSel = document.getElementById('stickPt');

  // –Ü–º–ø–æ—Ä—Ç –ø–ª–∞–Ω—É –∑ CSV (–∑ –ü–∞—Ä–∞ 4)
  const fileInput = document.getElementById('file');
  const csvSample = `line_name,phase,U_V,P_kW,cos_phi,eta,I_A,material,section_mm2,ampacity_A,MCB_A,length_m,voltage_drop_pct,drop_limit_pct,install,responsible
–õ—ñ–Ω—ñ—è –†–æ–∑–µ—Ç–∫–∏/–ú–∞–π—Å—Ç–µ—Ä–Ω—è,3,400,6.0,0.95,0.98,9.05,Cu,6,36,16,35,1.45,5,air,–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞`;

  function pasteSample(){
    // –ó–±–µ—Ä–µ–∂–µ–º–æ sample —É —Ñ–∞–π–ª-–ø–æ–ª–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ, –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–±–µ—Ä–µ–º–æ —Ä—è–¥–æ–∫
    parseCSVText(csvSample);
  }

  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    parseCSVText(txt);
  });

  function parseCSVText(txt){
    const lines = txt.trim().split(/\r?\n/);
    if(lines.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers = lines[0].split(',');
    const vals = splitCSV(lines[1]);
    const row = {};
    headers.forEach((h,i)=> row[h.trim()] = (vals[i]||'').replace(/^"|"$/g,''));
    // –æ—á—ñ–∫—É—î–º–æ U_V —Ç–∞ I_A
    const U = parseFloat(row['U_V']) || 230;
    const I = parseFloat(row['I_A']) || 10;
    const name = row['line_name'] || '–õ—ñ–Ω—ñ—è';
    plan = { name, U, I, resp: row['responsible']||'' };
    alert(`–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –ø–ª–∞–Ω: ${plan.name}, U=${plan.U} –í, I=${plan.I} –ê`);
    rebuildStickOptions();
  }

  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–æ–∫
  function addPoint(){
    const name = document.getElementById('ptName').value.trim() || '–¢–æ—á–∫–∞';
    const Ufact = parseFloat(document.getElementById('Umeas').value);
    const Ifact = parseFloat(document.getElementById('Imeas').value);
    if(!(Ufact>=0) || !(Ifact>=0)){ alert('–í–≤–µ–¥–∏ U —Ñ–∞–∫—Ç —Ç–∞ I —Ñ–∞–∫—Ç'); return; }
    const tolU = parseFloat(document.getElementById('tolU').value)||10;
    const tolI = parseFloat(document.getElementById('tolI').value)||20;

    const Uplan = plan.U;
    const Iplan = plan.I;

    const dU = (Ufact - Uplan)/Uplan*100;
    const dI = (Ifact - Iplan)/Iplan*100;

    const passU = Math.abs(dU) <= tolU;
    const passI = Math.abs(dI) <= tolI;
    const status = (passU && passI) ? 'PASS' : 'FAIL';

    const rec = {
      id: 'P' + Math.random().toString(36).slice(2,6).toUpperCase(),
      name, Uplan, Ufact, dU: Math.round(dU*100)/100,
      Iplan, Ifact, dI: Math.round(dI*100)/100, status
    };
    points.push(rec);
    renderTable();
    rebuildStickOptions();
  }

  function seedPoints(){
    document.getElementById('ptName').value = '–©–∏—Ç / –í–≤—ñ–¥';
    document.getElementById('Umeas').value = plan.U * 0.98;
    document.getElementById('Imeas').value = plan.I * 1.05;
    addPoint();

    document.getElementById('ptName').value = '–†–æ–∑–µ—Ç–∫–∞ 1';
    document.getElementById('Umeas').value = plan.U * 0.94;
    document.getElementById('Imeas').value = plan.I * 1.12;
    addPoint();
  }

  function renderTable(){
    tblBody.innerHTML='';
    points.forEach((p,idx)=>{
      const tr = document.createElement('tr');
      const badge = `<span class="mono" style="padding:2px 8px;border:1px solid #223049;border-radius:999px;background:#0d1a2e;color:${p.status==='PASS'?'#22c55e':'#ef4444'}">${p.status}</span>`;
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHTML(p.name)}</td>
        <td class="mono">${p.Uplan}</td>
        <td class="mono">${p.Ufact}</td>
        <td class="mono">${p.dU}</td>
        <td class="mono">${p.Iplan}</td>
        <td class="mono">${p.Ifact}</td>
        <td class="mono">${p.dI}</td>
        <td>${badge}</td>
        <td class="mono">
          <button class="btn" data-act="choose" data-id="${p.id}">–ú—ñ—Ç–∫–∞</button>
          <button class="btn" data-act="del" data-id="${p.id}">‚úñ</button>
        </td>`;
      tblBody.appendChild(tr);
    });
  }

  tblBody.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id');
    const act = b.getAttribute('data-act');
    if(act==='del'){
      points = points.filter(x=>x.id!==id);
      renderTable(); rebuildStickOptions(); return;
    }
    if(act==='choose'){
      stickSel.value = id;
      buildTicket();
      document.getElementById('ticket').scrollIntoView({behavior:'smooth'});
    }
  });

  function rebuildStickOptions(){
    stickSel.innerHTML='';
    points.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = `${p.name} (${p.status})`;
      stickSel.appendChild(opt);
    });
  }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function nowStamp(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è
  function buildTicket(){
    const id = stickSel.value;
    const p = points.find(x=>x.id===id);
    const resp = document.getElementById('resp').value.trim() || (plan.resp||'‚Äî');
    document.getElementById('t-date').textContent = `–î–∞—Ç–∞: ${nowStamp()}`;
    document.getElementById('t-line').textContent = `–õ—ñ–Ω—ñ—è: ${plan.name}`;
    if(!p){
      document.getElementById('t-pt').textContent = '‚Äî';
      document.getElementById('t-Upair').textContent = '‚Äî';
      document.getElementById('t-Ipair').textContent = '‚Äî';
      document.getElementById('t-deltas').textContent = '‚Äî';
      document.getElementById('t-status').textContent = '‚Äî';
      document.getElementById('t-resp').textContent = resp;
      document.getElementById('t-ref').textContent = 'Ref: MEAS-XXXX';
      return;
    }
    document.getElementById('t-pt').textContent = p.name;
    document.getElementById('t-Upair').textContent = `${p.Uplan} / ${p.Ufact}`;
    document.getElementById('t-Ipair').textContent = `${p.Iplan} / ${p.Ifact}`;
    document.getElementById('t-deltas').textContent = `${p.dU}% / ${p.dI}%`;
    document.getElementById('t-status').textContent = p.status;
    document.getElementById('t-resp').textContent = resp;
    const ref = 'MEAS-' + Math.random().toString(36).slice(2,8).toUpperCase();
    document.getElementById('t-ref').textContent = `Ref: ${ref}`;
  }

  function downloadTXT(){
    const id = stickSel.value;
    const p = points.find(x=>x.id===id);
    const lines = [];
    lines.push('MEAS VERIFIED 58mm');
    lines.push('-------------------');
    lines.push(document.getElementById('t-date').textContent);
    lines.push(document.getElementById('t-line').textContent);
    lines.push(`–¢–æ—á–∫–∞: ${p ? p.name : '‚Äî'}`);
    lines.push(`U –ø–ª–∞–Ω/—Ñ–∞–∫—Ç: ${p ? (p.Uplan+' / '+p.Ufact) : '‚Äî'}`);
    lines.push(`I –ø–ª–∞–Ω/—Ñ–∞–∫—Ç: ${p ? (p.Iplan+' / '+p.Ifact) : '‚Äî'}`);
    lines.push(`ŒîU/ŒîI: ${p ? (p.dU+'% / '+p.dI+'%') : '‚Äî'}`);
    lines.push(`–°—Ç–∞—Ç—É—Å: ${p ? p.status : '‚Äî'}`);
    lines.push(`–í—ñ–¥–ø.: ${document.getElementById('t-resp').textContent}`);
    lines.push(document.getElementById('t-ref').textContent);
    const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'meas_verified_58mm.txt';
    a.click(); URL.revokeObjectURL(a.href);
  }

  function exportCSV(){
    const headers = ['point_id','point_name','U_plan_V','U_fact_V','dU_pct','I_plan_A','I_fact_A','dI_pct','status','line_name'];
    const rows = points.map(p=>[p.id,p.name,p.Uplan,p.Ufact,p.dU,p.Iplan,p.Ifact,p.dI,p.status,plan.name]);
    const csv = [headers.join(','), ...rows.map(a=>a.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'measurements_plan_fact.csv';
    a.click(); URL.revokeObjectURL(a.href);
  }

  function parseLine(){ alert('–Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ —Ñ–∞–π–ª ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ OK –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É. –Ø–∫—â–æ –Ω—ñ ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ù–∞–≤—á–∞–ª—å–Ω–∏–π CSV¬ª.'); }

  // –ê–≤—Ç–æ: —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –≤–ø–µ—Ä—à–µ ‚Äî –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—é –æ–ø—Ü—ñ—é
  rebuildStickOptions();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>

</body>
</html>
