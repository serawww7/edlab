<!-- electric_para4.html
     –ü–∞—Ä–∞ 4 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ª—ñ–Ω—ñ—ó ‚Äî —Å—Ç—Ä—É–º, –ø–µ—Ä–µ—Ä—ñ–∑ –∫–∞–±–µ–ª—é, –∞–≤—Ç–æ–º–∞—Ç, –ø–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ + –¥—Ä—É–∫ 58 –º–º —ñ –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è GitHub Pages —ñ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ Moodle —á–µ—Ä–µ–∑ <iframe>.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 4 ‚Äî –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ª—ñ–Ω—ñ—ó: –ø–µ—Ä–µ—Ä—ñ–∑, –∞–≤—Ç–æ–º–∞—Ç, ŒîU, –¥—Ä—É–∫ 58 –º–º</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1024px; margin:0 auto; padding:24px 16px 64px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:var(--muted)}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  @media (max-width:900px){.g2{grid-template-columns:1fr}}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

  /* –§–æ—Ä–º–∞ */
  .field{display:flex; gap:8px; margin:6px 0}
  .field label{min-width:180px; color:#cbd5e1}
  .field input,.field select{flex:1; padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e5e7eb}
  .block{border:1px solid #223049; border-radius:12px; padding:10px}

  /* –¢–∞–±–ª–∏—Ü—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ */
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}

  /* –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è 58 –º–º */
  .ticket{width:58mm; background:#fff; color:#000; padding:6mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px; font-size:13px; text-align:center}
  .ticket p{margin:2px 0; font-size:12px}
  .ticket .center{text-align:center}
  .ticket .line{border-top:1px dashed #111; margin:6px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}

  /* –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (iframe/Moodle) */
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}

  @media print{
    @page{ size:58mm auto; margin:4mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

</head>
<body>
  <div class="wrap">
    <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 4 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
    <h1>üîå –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ª—ñ–Ω—ñ—ó: —Å—Ç—Ä—É–º, –ø–µ—Ä–µ—Ä—ñ–∑, –∞–≤—Ç–æ–º–∞—Ç, –ø–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ + üßæ –¥—Ä—É–∫ 58 –º–º</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>–ù–∞–≤—á–∏—Ç–∏—Å—è —à–≤–∏–¥–∫–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –ª—ñ–Ω—ñ—ó: —Ä–æ–±–æ—á–∏–π —Å—Ç—Ä—É–º, –ø–µ—Ä–µ—Ä—ñ–∑ –ø—Ä–æ–≤—ñ–¥–Ω–∏–∫–∞ (Cu/Al), –Ω–æ–º—ñ–Ω–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∞, –ø–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏, –∞ —Ç–∞–∫–æ–∂ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ ¬´–ø–∞—Å–ø–æ—Ä—Ç –ª—ñ–Ω—ñ—ó¬ª –¥–ª—è –¥—Ä—É–∫—É 58 –º–º —ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è CSV/TXT.</p>
      <div class="row">
        <button class="btn" type="button" onclick="fillDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥ –¥–∞–Ω–∏—Ö</button>
        <button class="btn" type="button" onclick="calcAll()">üß© –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <button class="btn" type="button" onclick="exportCSV()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>
      <p class="small">–ü—ñ—Å–ª—è –∑–∞–Ω—è—Ç—Ç—è –∑–∞–≤–∞–Ω—Ç–∞–∂ CSV —É —Å–ø—ñ–ª—å–Ω—É –ø–∞–ø–∫—É: <span class="mono">–ì–†–£–ü–ê_–ü—Ä—ñ–∑–≤–∏—â–µ_–õ—ñ–Ω—ñ—è.csv</span></p>
    </div>

    <div class="card">
      <h2>üßÆ –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ</h2>
      <div class="grid g2">
        <div class="block">
          <div class="field">
            <label for="lineName">–ù–∞–∑–≤–∞ –ª—ñ–Ω—ñ—ó</label>
            <input id="lineName" type="text" value="–õ—ñ–Ω—ñ—è –†–æ–∑–µ—Ç–∫–∏/–ú–∞–π—Å—Ç–µ—Ä–Ω—è" />
          </div>
          <div class="field">
            <label for="phase">–°—Ö–µ–º–∞</label>
            <select id="phase">
              <option value="1">1-—Ñ–∞–∑–Ω–∞ (U–ª)</option>
              <option value="3" selected>3-—Ñ–∞–∑–Ω–∞ (U–ª = 400 –í)</option>
            </select>
          </div>
          <div class="field">
            <label for="U">–ù–∞–ø—Ä—É–≥–∞ U, –í</label>
            <input id="U" type="number" value="400" />
          </div>
          <div class="field">
            <label for="P">–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å P, –∫–í—Ç</label>
            <input id="P" type="number" step="0.1" value="6.0" />
          </div>
          <div class="field">
            <label for="cosfi">cos œÜ</label>
            <input id="cosfi" type="number" step="0.01" value="0.95" />
          </div>
          <div class="field">
            <label for="eta">–ö–ö–î Œ∑</label>
            <input id="eta" type="number" step="0.01" value="0.98" />
          </div>
        </div>
        <div class="block">
          <div class="field">
            <label for="L">–î–æ–≤–∂–∏–Ω–∞ —Ç—Ä–∞—Å–∏ L, –º</label>
            <input id="L" type="number" value="35" />
          </div>
          <div class="field">
            <label for="mat">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>
            <select id="mat">
              <option value="Cu" selected>–ú—ñ–¥—å (Cu)</option>
              <option value="Al">–ê–ª—é–º—ñ–Ω—ñ–π (Al)</option>
            </select>
          </div>
          <div class="field">
            <label for="dropMax">–î–æ–ø—É—Å—Ç–∏–º–∞ ŒîU, %</label>
            <input id="dropMax" type="number" step="0.1" value="5" />
          </div>
          <div class="field">
            <label for="install">–°–ø–æ—Å—ñ–± –ø—Ä–æ–∫–ª–∞–¥–∞–Ω–Ω—è</label>
            <select id="install">
              <option value="air" selected>–í –ø–æ–≤—ñ—Ç—Ä—ñ/–∫–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª</option>
              <option value="pipe">–í —Ç—Ä—É–±—ñ/—à—Ç—Ä–æ–±—ñ</option>
            </select>
          </div>
          <div class="field">
            <label for="resp">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</label>
            <input id="resp" type="text" value="–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞" />
          </div>
        </div>
      </div>
      <p class="small">–ü—Ä–∏–º—ñ—Ç–∫–∞: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–≤—ñ–¥–∫–æ–≤—ñ –æ–ø–æ—Ä–∏ –ø—Ä–æ–≤—ñ–¥–Ω–∏–∫—ñ–≤ –ø—Ä–∏ 20 ¬∞C: œÅ(Cu)=0.01851 Œ©¬∑–º–º¬≤/–º, œÅ(Al)=0.02941 Œ©¬∑–º–º¬≤/–º (–æ—Ü—ñ–Ω–∫–∞). –¢–∞–±–ª–∏—Ü—è –¥–æ–ø—É—Å—Ç–∏–º–∏—Ö —Å—Ç—Ä—É–º—ñ–≤ ‚Äî –Ω–∞–≤—á–∞–ª—å–Ω–∞ –∞–ø—Ä–æ–∫—Å–∏–º–∞—Ü—ñ—è –¥–ª—è —Ç–∏–ø–æ–≤–∏—Ö –∂–∏–ª.</p>
    </div>

    <div class="card">
      <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h2>
      <table id="res">
        <thead>
          <tr>
            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–Ω—è</th><th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="verdict" style="margin-top:8px"></p>
    </div>

    <div class="card printable">
      <h2>üßæ –ü–∞—Å–ø–æ—Ä—Ç –ª—ñ–Ω—ñ—ó ‚Äî 58 –º–º</h2>
      <div class="grid g2">
        <div>
          <div id="ticket" class="ticket" aria-live="polite">
            <h4>–ü–ê–°–ü–û–†–¢ –õ–Ü–ù–Ü–á</h4>
            <p class="center"><small id="t-date">–î–∞—Ç–∞: ‚Äî</small></p>
            <div class="line"></div>
            <p><b id="t-name">–õ—ñ–Ω—ñ—è: ‚Äî</b></p>
            <p>–°—Ö–µ–º–∞/–ù–∞–ø—Ä—É–≥–∞: <span id="t-phase">‚Äî</span></p>
            <p>–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å: <span id="t-P">‚Äî</span> –∫–í—Ç</p>
            <p>–°—Ç—Ä—É–º: <span id="t-I">‚Äî</span> –ê</p>
            <p>–ú–∞—Ç–µ—Ä—ñ–∞–ª/–ø–µ—Ä–µ—Ä—ñ–∑: <span id="t-S">‚Äî</span></p>
            <p>–ê–≤—Ç–æ–º–∞—Ç: <span id="t-MCB">‚Äî</span></p>
            <p>–î–æ–≤–∂–∏–Ω–∞: <span id="t-L">‚Äî</span> –º</p>
            <p>ŒîU: <span id="t-drop">‚Äî</span>% (‚â§ <span id="t-dropmax">‚Äî</span>%)</p>
            <div class="line"></div>
            <p class="qr"><small id="t-ref">Ref: LINE-0001</small></p>
            <p class="center"><small>–í—ñ–¥–ø.: <span id="t-resp">‚Äî</span></small></p>
          </div>
          <div class="row no-print" style="margin-top:8px">
            <button class="btn" type="button" onclick="buildTicket()">üß© –û–Ω–æ–≤–∏—Ç–∏</button>
            <button class="btn" type="button" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
            <button class="btn" type="button" onclick="downloadTXT()">üì• TXT</button>
          </div>
        </div>
        <div>
          <p class="small">–ü–æ—Ä–∞–¥–∞: –∑—Ä–æ–±–∏ —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó —Ç–∞ –¥–æ–¥–∞–π —É —Å–ø—ñ–ª—å–Ω—É –ø–∞–ø–∫—É: <span class="mono">–ì–†–£–ü–ê_–ü—Ä—ñ–∑–≤–∏—â–µ_–õ—ñ–Ω—ñ—è–ü–∞—Å–ø–æ—Ä—Ç.jpg</span></p>
        </div>
      </div>
    </div>
  </div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–æ —É Moodle ‚Üí —Å—Ç—Ä–∏–º–∞–Ω–∞ —Ç–µ–º–∞
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // –î–æ–≤—ñ–¥–Ω–∏–∫ –¥–æ–ø—É—Å—Ç–∏–º–∏—Ö —Å—Ç—Ä—É–º—ñ–≤ (–Ω–∞–≤—á–∞–ª—å–Ω–∞ –∞–ø—Ä–æ–∫—Å–∏–º–∞—Ü—ñ—è)
  const tableAmpacity = {
    Cu: [
      {S:1.5, A_air:19, A_pipe:16},
      {S:2.5, A_air:27, A_pipe:21},
      {S:4,   A_air:36, A_pipe:28},
      {S:6,   A_air:46, A_pipe:36},
      {S:10,  A_air:63, A_pipe:50},
      {S:16,  A_air:85, A_pipe:68},
      {S:25,  A_air:110, A_pipe:89},
      {S:35,  A_air:135, A_pipe:110}
    ],
    Al: [
      {S:2.5, A_air:21, A_pipe:17},
      {S:4,   A_air:28, A_pipe:22},
      {S:6,   A_air:36, A_pipe:29},
      {S:10,  A_air:50, A_pipe:40},
      {S:16,  A_air:65, A_pipe:52},
      {S:25,  A_air:85, A_pipe:68},
      {S:35,  A_air:105, A_pipe:84}
    ]
  };

  // –ù–æ–º—ñ–Ω–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç—ñ–≤ (—Ç–∏–ø–æ–≤–∞ –ª—ñ–Ω—ñ–π–∫–∞)
  const MCBs = [6,10,13,16,20,25,32,40,50,63,80,100];

  // œÅ (–û–º*–º–º¬≤/–º)
  const rho = { Cu: 0.01851, Al: 0.02941 };

  function pad(n){ return n.toString().padStart(2,'0'); }
  function nowStamp(){
    const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function fillDemo(){
    document.getElementById('lineName').value = '–õ—ñ–Ω—ñ—è –†–æ–∑–µ—Ç–∫–∏/–ú–∞–π—Å—Ç–µ—Ä–Ω—è';
    document.getElementById('phase').value = '3';
    document.getElementById('U').value = 400;
    document.getElementById('P').value = 6.0;
    document.getElementById('cosfi').value = 0.95;
    document.getElementById('eta').value = 0.98;
    document.getElementById('L').value = 35;
    document.getElementById('mat').value = 'Cu';
    document.getElementById('dropMax').value = 5;
    document.getElementById('install').value = 'air';
    document.getElementById('resp').value = '–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞';
    calcAll();
  }

  function calcAll(){
    const name = document.getElementById('lineName').value.trim();
    const phase = parseInt(document.getElementById('phase').value,10);
    const U = parseFloat(document.getElementById('U').value);
    const PkW = parseFloat(document.getElementById('P').value);
    const cosfi = parseFloat(document.getElementById('cosfi').value);
    const eta = parseFloat(document.getElementById('eta').value);
    const L = parseFloat(document.getElementById('L').value);
    const mat = document.getElementById('mat').value;
    const dropMax = parseFloat(document.getElementById('dropMax').value);
    const install = document.getElementById('install').value;

    if(!(U>0 && PkW>0 && cosfi>0 && eta>0 && L>=0)){ alert('–ü–µ—Ä–µ–≤—ñ—Ä –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ'); return; }

    const P = PkW * 1000;
    const I = (phase===3) ? (P/(Math.sqrt(3)*U*cosfi*eta)) : (P/(U*cosfi*eta)); // –ê
    const Iround = Math.round(I*100)/100;

    // –ü—ñ–¥–±—ñ—Ä –ø–µ—Ä–µ—Ä—ñ–∑—É –∑–∞ –¥–æ–ø—É—Å—Ç–∏–º–∏–º —Å—Ç—Ä—É–º–æ–º (–Ω–∞–≤—á–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è)
    const list = tableAmpacity[mat];
    const key = (install==='air') ? 'A_air' : 'A_pipe';
    let chosen = list.find(row => row[key] >= I);
    if(!chosen) chosen = list[list.length-1];
    const S = chosen.S;
    const Iallow = chosen[key];

    // –ü—ñ–¥–±—ñ—Ä –∞–≤—Ç–æ–º–∞—Ç–∞: –ø–µ—Ä—à–∏–π –Ω–æ–º—ñ–Ω–∞–ª >= I, –∞–ª–µ –Ω–µ –±—ñ–ª—å—à–∏–π –∑–∞ Iallow
    let mcb = MCBs.find(n => n >= I && n <= Iallow);
    if(!mcb){
      // —è–∫—â–æ –∂–æ–¥–µ–Ω –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å —É –º–µ–∂–∞—Ö, –≤—ñ–∑—å–º–µ–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π > I, –∞–ª–µ –ø–æ–∫–∞–∂–µ–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
      mcb = MCBs.find(n=> n>=I) || MCBs[MCBs.length-1];
    }

    // –ü–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ (–æ—Ü—ñ–Ω–∫–∞): 1-—Ñ–∞–∑–Ω–∞ ŒîU = 2¬∑I¬∑œÅ¬∑L/S ; 3-—Ñ–∞–∑–Ω–∞ ŒîU = ‚àö3¬∑I¬∑œÅ¬∑L/S
    const factor = (phase===3) ? Math.sqrt(3) : 2;
    const dU = factor * I * rho[mat] * L / S; // —É –≤–æ–ª—å—Ç–∞—Ö
    const dUperc = (dU / U) * 100;
    const dUpercRound = Math.round(dUperc*100)/100;

    // –í–∏—Å–Ω–æ–≤–æ–∫
    let verdict = '';
    let ok = true;
    if(I > Iallow){ ok=false; verdict += '–ü–µ—Ä–µ—Ä—ñ–∑ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–π –∑–∞ —Å—Ç—Ä—É–º–æ–º. '; }
    if(dUperc > dropMax){ ok=false; verdict += '–ü–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ –ø–µ—Ä–µ–≤–∏—â—É—î –ª—ñ–º—ñ—Ç. '; }
    if(mcb > Iallow){ ok=false; verdict += '–ù–æ–º—ñ–Ω–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∞ –ø–µ—Ä–µ–≤–∏—â—É—î –¥–æ–ø—É—Å—Ç–∏–º–∏–π –¥–ª—è –∫–∞–±–µ–ª—é. '; }
    if(ok) verdict = '‚úÖ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø—Ä–æ–π–¥–µ–Ω–æ: –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä–µ—Ä—ñ–∑ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –æ–±–º–µ–∂–µ–Ω–Ω—è–º.';

    // –í–∏–≤—ñ–¥ —É —Ç–∞–±–ª–∏—Ü—é
    const rows = [
      ['–õ—ñ–Ω—ñ—è', name || '‚Äî', '–ù–∞–∑–≤–∞ –¥–ª—è –ø–∞—Å–ø–æ—Ä—Ç–∞'],
      ['–°—Ö–µ–º–∞/–ù–∞–ø—Ä—É–≥–∞', (phase===3?'3-—Ñ–∞–∑–Ω–∞':'1-—Ñ–∞–∑–Ω–∞')+` / ${U} –í`, 'U –ø–æ–¥–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º'],
      ['P, –∫–í—Ç; cosœÜ; Œ∑', `${PkW} ; ${cosfi} ; ${eta}`, '–ü–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ'],
      ['–†–æ–±–æ—á–∏–π —Å—Ç—Ä—É–º I, –ê', Iround, '–û–±—á–∏—Å–ª–µ–Ω–æ –∑–∞ —Ñ–æ—Ä–º—É–ª–æ—é –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'],
      ['–ú–∞—Ç–µ—Ä—ñ–∞–ª', (mat==='Cu'?'–ú—ñ–¥—å (Cu)':'–ê–ª—é–º—ñ–Ω—ñ–π (Al)'), '–í–ø–ª–∏–≤–∞—î –Ω–∞ œÅ'],
      ['–î–æ–≤–∂–∏–Ω–∞ L, –º', L, '–§—ñ–∑–∏—á–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ —Ç—Ä–∞—Å–∏'],
      ['–†–µ–∫–æ–º–µ–Ω–¥. –ø–µ—Ä–µ—Ä—ñ–∑ S, –º–º¬≤', S, `–î–æ–ø—É—Å—Ç–∏–º–∏–π —Å—Ç—Ä—É–º ‚âà ${Iallow} –ê (${install==='air'?'–ø–æ–≤—ñ—Ç—Ä—è/–∫–∞–Ω–∞–ª':'—Ç—Ä—É–±–∞/—à—Ç—Ä–æ–±–∞'})`],
      ['–ù–æ–º—ñ–Ω–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∞, –ê', mcb, '–ü—ñ–¥—ñ–±—Ä–∞–Ω–æ –∑–∞ I —Ç–∞ Iallow'],
      ['–ü–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ ŒîU, %', dUpercRound, `–õ—ñ–º—ñ—Ç ‚â§ ${dropMax}%`]
    ];
    renderTable(rows, ok ? 'ok' : (verdict? 'bad':'warn'), verdict);

    // –û–Ω–æ–≤–∏—Ç–∏ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—é
    buildTicket({ name, phase, U, PkW, I: Iround, mat, S, mcb, L, dUperc: dUpercRound, dropMax });

    // –ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —É –∑–º—ñ–Ω–Ω—ñ–π –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É
    lastResult = { name, phase, U, PkW, cosfi, eta, I: Iround, mat, S, Iallow, mcb, L, dUperc: dUpercRound, dropMax, install };
  }

  function renderTable(items, state, verdict){
    const tbody = document.querySelector('#res tbody');
    tbody.innerHTML = '';
    items.forEach(([k,v,c])=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td class="mono">${v}</td><td class="small">${c}</td>`;
      tbody.appendChild(tr);
    });
    const v = document.getElementById('verdict');
    v.className=''; v.textContent='';
    if(state==='ok'){ v.classList.add('ok'); v.textContent = verdict; }
    else if(state==='bad'){ v.classList.add('bad'); v.textContent = verdict; }
    else { v.classList.add('warn'); v.textContent = verdict; }
  }

  let lastResult = null;

  function buildTicket(dataOverride){
    const d = dataOverride || lastResult;
    const tNow = nowStamp();
    document.getElementById('t-date').textContent = `–î–∞—Ç–∞: ${tNow}`;
    const resp = document.getElementById('resp').value.trim() || '‚Äî';

    if(!d){
      // –ü–æ—Ä–æ–∂–Ω—ñ–π —Å—Ç–∞–Ω
      document.getElementById('t-name').textContent = '–õ—ñ–Ω—ñ—è: ‚Äî';
      document.getElementById('t-phase').textContent = '‚Äî';
      document.getElementById('t-P').textContent = '‚Äî';
      document.getElementById('t-I').textContent = '‚Äî';
      document.getElementById('t-S').textContent = '‚Äî';
      document.getElementById('t-MCB').textContent = '‚Äî';
      document.getElementById('t-L').textContent = '‚Äî';
      document.getElementById('t-drop').textContent = '‚Äî';
      document.getElementById('t-dropmax').textContent = '‚Äî';
      document.getElementById('t-resp').textContent = resp;
      document.getElementById('t-ref').textContent = 'Ref: LINE-XXXX';
      return;
    }

    document.getElementById('t-name').textContent = `–õ—ñ–Ω—ñ—è: ${d.name}`;
    document.getElementById('t-phase').textContent = `${d.phase===3?'3—Ñ':'1—Ñ'} / ${d.U} –í`;
    document.getElementById('t-P').textContent = d.PkW;
    document.getElementById('t-I').textContent = d.I;
    document.getElementById('t-S').textContent = `${d.mat} ${d.S} –º–º¬≤`;
    document.getElementById('t-MCB').textContent = `${d.mcb} –ê`;
    document.getElementById('t-L').textContent = d.L;
    document.getElementById('t-drop').textContent = d.dUperc;
    document.getElementById('t-dropmax').textContent = d.dropMax;
    document.getElementById('t-resp').textContent = resp;

    const ref = 'LINE-' + Math.random().toString(36).slice(2,8).toUpperCase();
    document.getElementById('t-ref').textContent = `Ref: ${ref}`;
  }

  function downloadTXT(){
    const lines = [];
    lines.push('LINE PASSPORT 58mm');
    lines.push('-------------------');
    lines.push(document.getElementById('t-date').textContent);
    lines.push(document.getElementById('t-name').textContent);
    lines.push(`–°—Ö–µ–º–∞/–ù–∞–ø—Ä—É–≥–∞: ${document.getElementById('t-phase').textContent}`);
    lines.push(`–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å: ${document.getElementById('t-P').textContent} –∫–í—Ç`);
    lines.push(`–°—Ç—Ä—É–º: ${document.getElementById('t-I').textContent} –ê`);
    lines.push(`–ú–∞—Ç–µ—Ä—ñ–∞–ª/–ø–µ—Ä–µ—Ä—ñ–∑: ${document.getElementById('t-S').textContent}`);
    lines.push(`–ê–≤—Ç–æ–º–∞—Ç: ${document.getElementById('t-MCB').textContent}`);
    lines.push(`–î–æ–≤–∂–∏–Ω–∞: ${document.getElementById('t-L').textContent} –º`);
    lines.push(`ŒîU: ${document.getElementById('t-drop').textContent}% (‚â§ ${document.getElementById('t-dropmax').textContent}%)`);
    lines.push(document.getElementById('t-ref').textContent);
    lines.push(`–í—ñ–¥–ø.: ${document.getElementById('t-resp').textContent}`);
    const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'line_passport_58mm.txt';
    a.click(); URL.revokeObjectURL(a.href);
  }

  function exportCSV(){
    if(!lastResult){ alert('–°–ø–æ—á–∞—Ç–∫—É —Ä–æ–∑—Ä–∞—Ö—É–π –ª—ñ–Ω—ñ—é'); return; }
    const r = lastResult;
    const headers = ['line_name','phase','U_V','P_kW','cos_phi','eta','I_A','material','section_mm2','ampacity_A','MCB_A','length_m','voltage_drop_pct','drop_limit_pct','install','responsible'];
    const values = [
      r.name, r.phase, r.U, r.PkW, r.cosfi, r.eta, r.I, r.mat, r.S, r.Iallow, r.mcb, r.L, r.dUperc, r.dropMax, r.install,
      document.getElementById('resp').value.trim()
    ];
    const csv = headers.join(',') + '\n' + values.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'line_calc.csv';
    a.click(); URL.revokeObjectURL(a.href);
  }

  // –ê–≤—Ç–æ-–ø–æ—á–∞—Ç–∫–æ–≤–∏–π –ø—Ä–∏–∫–ª–∞–¥
  fillDemo();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>

</body>
</html>
