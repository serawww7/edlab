<!-- electric_para19.html
     –ü–∞—Ä–∞ 19 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): LOTO (Lockout/Tagout) —Ç–∞ –î–æ–∑–≤—ñ–ª –Ω–∞ —Ä–æ–±–æ—Ç–∏
     –ú–µ—Ç–∞: —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ü–∏—Ñ—Ä–æ–≤–∏–π "–î–æ–∑–≤—ñ–ª –Ω–∞ —Ä–æ–±–æ—Ç–∏" (PTW) —ñ–∑ –ø–µ—Ä–µ–ª—ñ–∫–æ–º —Ç–æ—á–æ–∫ —ñ–∑–æ–ª—è—Ü—ñ—ó, —á–µ–∫-–ª–∏—Å—Ç–∞–º–∏,
     QR/NFC-—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–æ–º, –Ω–∞–∫–ª–µ–π–∫–∞–º–∏ 58 –º–º, A4-–¥–æ–∫—É–º–µ–Ω—Ç–æ–º, CSV/ICS –µ–∫—Å–ø–æ—Ä—Ç–æ–º.
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–æ –¥–ª—è GitHub Pages —Ç–∞ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è —É Moodle (iframe).
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 19 ‚Äî LOTO —Ç–∞ –î–æ–∑–≤—ñ–ª –Ω–∞ —Ä–æ–±–æ—Ç–∏ (PTW)</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{
    --bg:#0b1220; --bg2:#101826; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 32%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1120px; margin:0 auto; padding:24px 16px 96px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:#9aa5b1}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e);
     -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1050px){.g3{grid-template-columns:1fr}; .g2{grid-template-columns:1fr}}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  input,select,textarea{padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e5e7eb; width:100%}
  textarea{min-height:80px}
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}

  .tickets{display:flex; gap:12px; flex-wrap:wrap}
  .ticket{width:58mm; background:#fff; color:#000; padding:5mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 4px; font-size:13px; text-align:center}
  .ticket p{margin:1px 0; font-size:12px}
  .ticket .line{border-top:1px dashed #111; margin:5px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}
  #printArea{background:#fff; color:#000; border-radius:12px; border:1px solid #e5e7eb; padding:16px}
  .doc{page-break-after:always; padding:12mm; color:#000; font-family:Georgia,"Times New Roman",serif}
  .doc h2{color:#000; font-size:20px; margin:0 0 6px}
  .doc h3{color:#000; font-size:16px; margin:6px 0}
  .doc p{color:#000; margin:4px 0}
  .doc table{width:100%; border-collapse:collapse; border:1px solid #111}
  .doc th,.doc td{border:1px solid #111; padding:6px 8px; font-size:12px; vertical-align:top}
  .doc .sign{margin-top:10mm; display:flex; gap:10mm; flex-wrap:wrap}
  .doc .sign div{flex:1 1 220px}
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}
  @media print{
    @page{ size:A4; margin:12mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    #printArea{ border:none; padding:0 }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }

  .list{display:flex; gap:8px; flex-wrap:wrap}
  .chip{display:inline-block; padding:2px 8px; border:1px solid #223049; border-radius:999px; background:#0d1a2e; font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 19 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
  <h1>üîí LOTO —Ç–∞ ¬´–î–æ–∑–≤—ñ–ª –Ω–∞ —Ä–æ–±–æ—Ç–∏¬ª (PTW): —á–µ–∫-–ª–∏—Å—Ç–∏ ‚Üí —Ç–æ—á–∫–∏ —ñ–∑–æ–ª—è—Ü—ñ—ó ‚Üí 58 –º–º ‚Üí A4 ‚Üí .csv ‚Üí .ics</h1>

  <div class="card">
    <h2>üéØ –ú–µ—Ç–∞</h2>
    <p>–ó–º–æ–¥–µ–ª—é–≤–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å <b>LOTO</b>: —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥–æ–∑–≤—ñ–ª –Ω–∞ —Ä–æ–±–æ—Ç–∏ (PTW), –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ <b>—Ç–æ—á–∫–∏ —ñ–∑–æ–ª—è—Ü—ñ—ó</b>, —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ <b>—á–µ–∫-–ª–∏—Å—Ç–∏</b>, 
      –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ <b>–Ω–∞–∫–ª–µ–π–∫–∏ 58 –º–º</b> –¥–ª—è –±—ñ—Ä–æ–∫/–∑–∞–º–∫—ñ–≤, <b>A4-–¥–æ–∫—É–º–µ–Ω—Ç</b> –¥–ª—è –¥—Ä—É–∫—É/–ø—ñ–¥–ø–∏—Å—ñ–≤, –µ–∫—Å–ø–æ—Ä—Ç <b>CSV</b> —Ç–∞ <b>.ics</b> –ø–æ–¥—ñ—ó.</p>
    <div class="row">
      <button class="btn" onclick="seedDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥</button>
      <button class="btn" onclick="exportCSV()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
      <input id="file" class="btn" type="file" accept=".csv,text/csv"/>
      <button class="btn" onclick="importCSV()">‚¨ÜÔ∏è –Ü–º–ø–æ—Ä—Ç CSV</button>
      <button class="btn" onclick="downloadICS()">üìÖ .ics –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è</button>
    </div>
    <p class="small">CSV: <span class="mono">ptw_id,job_title,location,requester,issuer,team,window_start,window_end,risk_level,work_type,notes,url,iso_points,precheck,postcheck</span></p>
  </div>

  <div class="card">
    <h2>‚ûï –ù–æ–≤–∏–π –¥–æ–∑–≤—ñ–ª (PTW)</h2>
    <div class="grid g3">
      <div>
        <h3>–û—Å–Ω–æ–≤–Ω–µ</h3>
        <div class="row"><label class="small" style="min-width:140px">PTW ID</label><input id="ptw_id" value="PTW-001"></div>
        <div class="row"><label class="small" style="min-width:140px">–†–æ–±–æ—Ç–∞</label><input id="job_title" value="–ó–∞–º—ñ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∞ C16"></div>
        <div class="row"><label class="small" style="min-width:140px">–õ–æ–∫–∞—Ü—ñ—è</label><input id="location" value="–©–û-1 ¬∑ –ö–æ—Ä–ø—É—Å –ê"></div>
        <div class="row"><label class="small" style="min-width:140px">–¢–∏–ø —Ä–æ–±—ñ—Ç</label><select id="work_type">
          <option selected>–ï–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂</option><option>–û–≥–ª—è–¥/–¢–û</option><option>–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è</option><option>–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –∑–æ–Ω–∏</option></select></div>
      </div>
      <div>
        <h3>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ</h3>
        <div class="row"><label class="small" style="min-width:140px">–ó–∞–º–æ–≤–Ω–∏–∫</label><input id="requester" value="–í–∏–∫–ª. –°–µ—Ä–≥—ñ–π"></div>
        <div class="row"><label class="small" style="min-width:140px">–î–æ–∑–≤—ñ–ª –≤–∏–¥–∞–≤</label><input id="issuer" value="–°—Ç–∞—Ä–æ—Å—Ç–∞ –≥—Ä—É–ø–∏"></div>
        <div class="row"><label class="small" style="min-width:140px">–ö–æ–º–∞–Ω–¥–∞</label><input id="team" value="–°—Ç—É–¥–µ–Ω—Ç–∏ –≥—Ä. –ï–õ-21 (2 –æ—Å.)"></div>
        <div class="row"><label class="small" style="min-width:140px">–†–∏–∑–∏–∫</label><select id="risk_level"><option>–ù–∏–∑—å–∫–∏–π</option><option selected>–°–µ—Ä–µ–¥–Ω—ñ–π</option><option>–í–∏—Å–æ–∫–∏–π</option></select></div>
      </div>
      <div>
        <h3>–í—ñ–∫–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è</h3>
        <div class="row"><label class="small" style="min-width:140px">–°—Ç–∞—Ä—Ç</label><input id="window_start" value="2025-10-20 09:00"></div>
        <div class="row"><label class="small" style="min-width:140px">–ö—ñ–Ω–µ—Ü—å</label><input id="window_end" value="2025-10-20 11:00"></div>
        <div class="row"><label class="small" style="min-width:140px">URL/QR (—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è)</label><input id="url" placeholder="https://serawww7.github.io/edlab/..."></div>
        <div class="row"><label class="small" style="min-width:140px">–ü—Ä–∏–º—ñ—Ç–∫–∞</label><input id="notes" placeholder="–ó–Ü–ó, –∑–æ–Ω–∞, —Å—Ç–æ—Ä–æ–Ω–Ω—ñ"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üîå –¢–æ—á–∫–∏ —ñ–∑–æ–ª—è—Ü—ñ—ó (Lockout)</h2>
    <div class="grid g2">
      <div>
        <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</h3>
        <div class="row"><label class="small" style="min-width:140px">ID —Ç–æ—á–∫–∏</label><input id="iso_id" value="ISO-01"></div>
        <div class="row"><label class="small" style="min-width:140px">–û–ø–∏—Å</label><input id="iso_desc" value="–ê–≤—Ç–æ–º–∞—Ç C16, –∫–æ–º—ñ—Ä–∫–∞ 4"></div>
        <div class="row"><label class="small" style="min-width:140px">–î—ñ—è</label><select id="iso_action"><option selected>–í–∏–º–∫–Ω—É—Ç–∏</option><option>–í–∏—Ç—è–≥—Ç–∏ –ø–ª–∞–≤–∫—É –≤—Å—Ç–∞–≤–∫—É</option><option>–†–æ–∑'—î–¥–Ω–∞—Ç–∏ —à—Ç–µ–ø—Å–µ–ª—å</option><option>–ó–∞–∫–æ—Ä–æ—Ç–∏—Ç–∏/–∑–∞–∑–µ–º–ª–∏—Ç–∏</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">–ó–∞–º–æ–∫/–ë—ñ—Ä–∫–∞</label><input id="iso_tag" value="–ó–∞–º–æ–∫ LOTO #12"></div>
        <div class="row"><button class="btn" onclick="addIso()">‚ûï –î–æ–¥–∞—Ç–∏</button></div>
      </div>
      <div>
        <h3>–°–ø–∏—Å–æ–∫</h3>
        <table id="iso_tbl">
          <thead><tr><th>#</th><th>ID</th><th>–û–ø–∏—Å</th><th>–î—ñ—è</th><th>–ó–∞–º–æ–∫/–ë—ñ—Ä–∫–∞</th><th>–î—ñ—ó</th></tr></thead>
          <tbody></tbody>
        </table>
        <p class="small">–ü—ñ—Å–ª—è —ñ–∑–æ–ª—è—Ü—ñ—ó ‚Äî <b>–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –Ω–∞–ø—Ä—É–≥–∏</b> —Ç–∞ <b>–∑–Ω—è—Ç–∏ –∑–∞–ª–∏—à–∫–æ–≤—É –µ–Ω–µ—Ä–≥—ñ—é</b>.</p>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üìã –ß–µ–∫-–ª–∏—Å—Ç–∏ (–ü–µ—Ä–µ–¥/–ü—ñ—Å–ª—è)</h2>
    <div class="grid g2">
      <div>
        <h3>–ü–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º</h3>
        <textarea id="precheck"></textarea>
        <div class="row"><button class="btn" onclick="loadTemplate('pre')">üì• –®–∞–±–ª–æ–Ω</button></div>
      </div>
      <div>
        <h3>–ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</h3>
        <textarea id="postcheck"></textarea>
        <div class="row"><button class="btn" onclick="loadTemplate('post')">üì• –®–∞–±–ª–æ–Ω</button></div>
      </div>
    </div>
  </div>

  <div class="card printable">
    <h2>üßæ –ù–∞–∫–ª–µ–π–∫–∏ 58 –º–º ¬´LOTO / PTW¬ª</h2>
    <div class="row">
      <button class="btn" onclick="buildTickets()">üß© –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
      <button class="btn" onclick="downloadTXT()">üì• TXT</button>
    </div>
    <div id="tickets" class="tickets"></div>
  </div>

  <div class="card printable">
    <h2>üìÑ A4 ¬´–î–æ–∑–≤—ñ–ª –Ω–∞ —Ä–æ–±–æ—Ç–∏¬ª</h2>
    <div class="row">
      <button class="btn" onclick="buildReport()">üß© –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ A4</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫/PDF</button>
    </div>
    <div id="printArea"></div>
  </div>
</div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // ===== –°–¢–ê–ù =====
  let isoPoints = [];

  // ===== –£–¢–ò–õ–Ü–¢–ò =====
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&lt;','"':'&quot;',"'":'&#39;' }[m])); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function now(){ return new Date(); }
  function nowStamp(){ const d=now(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  function getPTW(){
    return {
      ptw_id: (document.getElementById('ptw_id').value||'').trim(),
      job_title: (document.getElementById('job_title').value||'').trim(),
      location: (document.getElementById('location').value||'').trim(),
      work_type: document.getElementById('work_type').value,
      requester: (document.getElementById('requester').value||'').trim(),
      issuer: (document.getElementById('issuer').value||'').trim(),
      team: (document.getElementById('team').value||'').trim(),
      risk_level: document.getElementById('risk_level').value,
      window_start: (document.getElementById('window_start').value||'').trim(),
      window_end: (document.getElementById('window_end').value||'').trim(),
      url: (document.getElementById('url').value||'').trim(),
      notes: (document.getElementById('notes').value||'').trim(),
      precheck: (document.getElementById('precheck').value||'').trim(),
      postcheck: (document.getElementById('postcheck').value||'').trim(),
      iso_points: isoPoints.slice()
    };
  }

  // ===== –Ü–ó–û–õ–Ø–¶–Ü–Ø =====
  const isoBody = document.querySelector('#iso_tbl tbody');
  function addIso(){
    const rec = {
      id: (document.getElementById('iso_id').value||'').trim(),
      desc: (document.getElementById('iso_desc').value||'').trim(),
      action: document.getElementById('iso_action').value,
      tag: (document.getElementById('iso_tag').value||'').trim()
    };
    if(!rec.id){ alert('–£–∫–∞–∂–∏ ID —Ç–æ—á–∫–∏'); return; }
    const i = isoPoints.findIndex(x=>x.id===rec.id);
    if(i>=0) isoPoints[i] = {...isoPoints[i], ...rec};
    else isoPoints.push(rec);
    renderIso();
  }
  function renderIso(){
    isoBody.innerHTML='';
    isoPoints.forEach((p,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td><td class="editable" data-k="id" data-id="${p.id}">${esc(p.id)}</td>
        <td class="editable" data-k="desc" data-id="${p.id}">${esc(p.desc)}</td>
        <td class="editable" data-k="action" data-id="${p.id}">${esc(p.action)}</td>
        <td class="editable" data-k="tag" data-id="${p.id}">${esc(p.tag)}</td>
        <td class="mono"><button class="btn" data-act="del" data-id="${p.id}">‚úñ</button></td>`;
      isoBody.appendChild(tr);
    });
  }
  isoBody.addEventListener('dblclick',(e)=>{
    const td=e.target.closest('.editable'); if(!td) return;
    const id=td.getAttribute('data-id'); const key=td.getAttribute('data-k');
    const idx=isoPoints.findIndex(x=>x.id===id); const r=isoPoints[idx];
    const input=document.createElement('input'); input.value=r[key]||''; input.style.width='100%'; input.style.padding='6px 8px';
    input.addEventListener('blur', ()=>{ r[key]=input.value.trim(); renderIso(); });
    td.innerHTML=''; td.appendChild(input); input.focus(); input.select();
  });
  isoBody.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.getAttribute('data-id'); isoPoints=isoPoints.filter(x=>x.id!==id); renderIso();
  });

  // ===== –®–ê–ë–õ–û–ù–ò –ß–ï–ö-–õ–ò–°–¢–Ü–í =====
  function loadTemplate(which){
    const pre = [
      '‚Ä¢ –û—Ü—ñ–Ω–∏—Ç–∏ —Ä–∏–∑–∏–∫–∏: –Ω–∞–ø—Ä—É–≥–∞, –≤–∏—Å–æ—Ç–∞, —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –ó–Ü–ó',
      '‚Ä¢ –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –∑–∞—Ü—ñ–∫–∞–≤–ª–µ–Ω–∏—Ö —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –º–µ–∂—ñ –∑–æ–Ω–∏',
      '‚Ä¢ –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –≤—Å—ñ –¥–∂–µ—Ä–µ–ª–∞ –µ–Ω–µ—Ä–≥—ñ—ó (–µ–ª–µ–∫—Ç—Ä., –º–µ—Ö–∞–Ω., –ø–Ω–µ–≤–º–æ)',
      '‚Ä¢ –í–∏–º–∫–Ω—É—Ç–∏/—Ä–æ–∑\'—î–¥–Ω–∞—Ç–∏ –¥–∂–µ—Ä–µ–ª–∞ (LOTO), –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç–∏ –∑–∞–º–∫–∏/–±—ñ—Ä–∫–∏',
      '‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –Ω–∞–ø—Ä—É–≥–∏ —Ç–µ—Å—Ç–µ—Ä–æ–º; –∑–Ω—è—Ç–∏ –∑–∞–ª–∏—à–∫–æ–≤—É',
      '‚Ä¢ –û—Ä–≥–∞–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è/–∑–∞–∫–æ—Ä–æ—Ç–∫—É (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏)'
    ].join('\n');
    const post = [
      '‚Ä¢ –ü—Ä–∏–±—Ä–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–º–∞—Ç–µ—Ä—ñ–∞–ª–∏, –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ö–∏—Å—Ç–∏',
      '‚Ä¢ –ó–Ω—è—Ç–∏ –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è/–∑–∞–∫–æ—Ä–æ—Ç–∫–∏ (–∑–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–æ—é)',
      '‚Ä¢ –ó–Ω—è—Ç–∏ –∑–∞–º–∫–∏/–±—ñ—Ä–∫–∏ —É –∑–≤–æ—Ä–æ—Ç–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ',
      '‚Ä¢ –ü–æ–ø–µ—Ä–µ–¥–∏—Ç–∏ –∑–∞—Ü—ñ–∫–∞–≤–ª–µ–Ω–∏—Ö –ø—Ä–æ –ø—É—Å–∫, –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤–∏–π –∑–∞–ø—É—Å–∫',
      '‚Ä¢ –ó–∞–∫—Ä–∏—Ç–∏ –¥–æ–∑–≤—ñ–ª, –∑—Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Å —É –∂—É—Ä–Ω–∞–ª—ñ'
    ].join('\n');
    if(which==='pre') document.getElementById('precheck').value = pre;
    else document.getElementById('postcheck').value = post;
  }

  // ===== 58 –ú–ú –ù–ê–ö–õ–ï–ô–ö–ò =====
  const ticketsBox = document.getElementById('tickets');
  function buildTickets(){
    const P = getPTW();
    ticketsBox.innerHTML='';
    // –ë—ñ—Ä–∫–∞ –Ω–∞ –î–û–ó–í–Ü–õ
    ticketsBox.appendChild(ticket(`
      <h4>PTW / LOTO</h4>
      <p><b>${esc(P.ptw_id)}</b> ‚Äî ${esc(P.job_title)}</p>
      <div class="line"></div>
      <p>${esc(P.location)}</p>
      <p>–í—ñ–∫–Ω–æ: ${esc(P.window_start)} ‚Üí ${esc(P.window_end)}</p>
      <p>–†—ñ–≤–µ–Ω—å: ${esc(P.risk_level)} ¬∑ –¢–∏–ø: ${esc(P.work_type)}</p>
      <div class="line"></div>
      <p class="qr"><small>URI: ${esc(P.url || defaultURL(P.ptw_id))}</small></p>
      <p><small>${nowStamp()}</small></p>
    `));
    // –ë—ñ—Ä–∫–∏ –Ω–∞ —Ç–æ—á–∫–∏ —ñ–∑–æ–ª—è—Ü—ñ—ó
    (P.iso_points||[]).forEach(x=>{
      ticketsBox.appendChild(ticket(`
        <h4>LOTO –ë–Ü–†–ö–ê</h4>
        <p><b>${esc(P.ptw_id)} ¬∑ ${esc(x.id)}</b></p>
        <div class="line"></div>
        <p>${esc(x.desc)}</p>
        <p>–î—ñ—è: ${esc(x.action)}</p>
        <p>–ó–∞–º–æ–∫/–±—ñ—Ä–∫–∞: ${esc(x.tag)}</p>
        <div class="line"></div>
        <p class="qr"><small>URI: ${esc(P.url || defaultURL(P.ptw_id)+'#'+encodeURIComponent(x.id))}</small></p>
        <p><small>${nowStamp()}</small></p>
      `));
    });
  }
  function ticket(innerHTML){
    const el=document.createElement('div'); el.className='ticket'; el.innerHTML=innerHTML; return el;
  }
  function defaultURL(id){ return `https://serawww7.github.io/edlab/electric_para19.html#${encodeURIComponent(id)}`; }
  function downloadTXT(){
    if(!ticketsBox.firstChild){ alert('–°–ø–æ—á–∞—Ç–∫—É –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ –Ω–∞–∫–ª–µ–π–∫–∏'); return; }
    const arr=['PTW/LOTO 58mm','-------------------'];
    Array.from(ticketsBox.children).forEach(t=>{ arr.push(t.innerText.replace(/\n{2,}/g,'\n')); arr.push('-------------------'); });
    const blob=new Blob([arr.join('\n')],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ptw_loto_labels_58mm.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  // ===== A4 –ó–í–Ü–¢ =====
  function buildReport(){
    const P=getPTW();
    const isoRows=(P.iso_points||[]).map((x,i)=>`<tr><td>${i+1}</td><td>${esc(x.id)}</td><td>${esc(x.desc)}</td><td>${esc(x.action)}</td><td>${esc(x.tag)}</td></tr>`).join('');
    const html=`
      <section class="doc">
        <h2>–î–û–ó–í–Ü–õ –ù–ê –†–û–ë–û–¢–ò (PTW) ‚Äî ${esc(P.ptw_id)}</h2>
        <p>–†–æ–±–æ—Ç–∞: <b>${esc(P.job_title)}</b> ¬∑ –õ–æ–∫–∞—Ü—ñ—è: ${esc(P.location)} ¬∑ –¢–∏–ø: ${esc(P.work_type)} ¬∑ –†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É: ${esc(P.risk_level)}</p>
        <p>–í—ñ–∫–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ${esc(P.window_start)} ‚Üí ${esc(P.window_end)}</p>
        <p>–ó–∞–º–æ–≤–Ω–∏–∫: ${esc(P.requester)} ¬∑ –î–æ–∑–≤—ñ–ª –≤–∏–¥–∞–≤: ${esc(P.issuer)} ¬∑ –ö–æ–º–∞–Ω–¥–∞: ${esc(P.team)}</p>
        <p>URI/QR: ${esc(P.url || defaultURL(P.ptw_id))}</p>
        <h3>1. –¢–æ—á–∫–∏ —ñ–∑–æ–ª—è—Ü—ñ—ó</h3>
        <table><thead><tr><th>#</th><th>ID</th><th>–û–ø–∏—Å</th><th>–î—ñ—è</th><th>–ó–∞–º–æ–∫/–±—ñ—Ä–∫–∞</th></tr></thead>
        <tbody>${isoRows || '<tr><td colspan="5">‚Äî</td></tr>'}</tbody></table>
        <h3>2. –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º</h3>
        <p style="white-space:pre-wrap">${esc(P.precheck||'‚Äî')}</p>
        <h3>3. –ß–µ–∫-–ª–∏—Å—Ç –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</h3>
        <p style="white-space:pre-wrap">${esc(P.postcheck||'‚Äî')}</p>
        <h3>4. –ü—ñ–¥–ø–∏—Å–∏</h3>
        <div class="sign">
          <div>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ____________________ (–¥–∞—Ç–∞/—á–∞—Å)</div>
          <div>–û—Å–æ–±–∞ —â–æ –≤–∏–¥–∞–ª–∞ –¥–æ–∑–≤—ñ–ª: ______________________ (–¥–∞—Ç–∞/—á–∞—Å)</div>
        </div>
        <p class="small">–ù–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å LOTO/PTW. –£ —Ä–µ–∞–ª—å–Ω—ñ–π –ø—Ä–∞–∫—Ç–∏—Ü—ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ —á–∏–Ω–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∑ –û–ü, –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ –Ω–∞ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤—ñ, —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∏ –¥–æ–ø—É—Å–∫—É.</p>
      </section>
    `;
    const box=document.getElementById('printArea'); box.innerHTML=html; box.scrollIntoView({behavior:'smooth'});
  }

  // ===== CSV =====
  function exportCSV(){
    const P=getPTW();
    // –ø–æ–ª—è–º–∏ iso_points, precheck, postcheck –ø—ñ–¥–µ–º–æ —è–∫ –æ–∫—Ä–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏ (—Å–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ " | ")
    const headers=['ptw_id','job_title','location','requester','issuer','team','window_start','window_end','risk_level','work_type','notes','url','iso_points','precheck','postcheck','timestamp'];
    const stamp=nowStamp();
    const isoStr=(P.iso_points||[]).map(x=>`${x.id}:${x.action}:${x.tag}`).join(' | ');
    const row=[P.ptw_id,P.job_title,P.location,P.requester,P.issuer,P.team,P.window_start,P.window_end,P.risk_level,P.work_type,P.notes,(P.url||defaultURL(P.ptw_id)),isoStr,P.precheck,P.postcheck,stamp]
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    const blob=new Blob([[headers.join(','),row].join('\n')],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ptw_loto.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  async function importCSV(){
    const f=document.getElementById('file').files[0]; if(!f){ alert('–û–±–µ—Ä—ñ—Ç—å CSV'); return; }
    const txt=await f.text();
    const lines=txt.trim().split(/\r?\n/); if(lines.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers=lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const cells=splitCSV(lines[1]); const o={}; headers.forEach((h,j)=> o[h]=(cells[j]||'').replace(/^"|"$/g,''));
    document.getElementById('ptw_id').value=o.ptw_id||'';
    document.getElementById('job_title').value=o.job_title||'';
    document.getElementById('location').value=o.location||'';
    document.getElementById('requester').value=o.requester||'';
    document.getElementById('issuer').value=o.issuer||'';
    document.getElementById('team').value=o.team||'';
    document.getElementById('window_start').value=o.window_start||'';
    document.getElementById('window_end').value=o.window_end||'';
    document.getElementById('risk_level').value=o.risk_level||'–°–µ—Ä–µ–¥–Ω—ñ–π';
    document.getElementById('work_type').value=o.work_type||'–ï–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂';
    document.getElementById('notes').value=o.notes||'';
    document.getElementById('url').value=o.url||'';
    document.getElementById('precheck').value=o.precheck||'';
    document.getElementById('postcheck').value=o.postcheck||'';
    isoPoints=[];
    if(o.iso_points){
      o.iso_points.split('|').forEach(chunk=>{
        const t=chunk.trim(); if(!t) return;
        const [id,action,tag]=t.split(':'); isoPoints.push({id:id||'',desc:'(–∑ CSV)',action:action||'',tag:tag||''});
      });
    }
    renderIso();
  }
  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  // ===== ICS =====
  function icsEscape(s){ return String(s).replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n'); }
  function icsFormatDateLocal(sISO){
    // "YYYY-MM-DD HH:MM" -> basic local (–±–µ–∑ TZ, –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏)
    const [d,t]=String(sISO||'').split(' ');
    const [y,m,dd]=(d||'').split('-'); const [hh,mm]=(t||'').split(':');
    return `${y}${m}${dd}T${hh}${mm}00`;
  }
  function buildICS(){
    const P=getPTW();
    const uid = `${P.ptw_id}@edlab`;
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//edlab//ptw//UA','BEGIN:VEVENT'];
    lines.push('UID:'+uid);
    lines.push('DTSTAMP:'+icsFormatDateLocal(nowStamp().replace(' ',' ')));
    lines.push('DTSTART:'+icsFormatDateLocal(P.window_start||'2025-10-20 09:00'));
    lines.push('DTEND:'+icsFormatDateLocal(P.window_end||'2025-10-20 11:00'));
    lines.push('SUMMARY:'+icsEscape(`PTW: ${P.ptw_id} ¬∑ ${P.job_title}`));
    lines.push('LOCATION:'+icsEscape(P.location||''));
    lines.push('DESCRIPTION:'+icsEscape(`–¢–∏–ø: ${P.work_type}\n–†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É: ${P.risk_level}\n–ó–∞–º–æ–≤–Ω–∏–∫: ${P.requester}\n–î–æ–∑–≤—ñ–ª –≤–∏–¥–∞–≤: ${P.issuer}\n–ö–æ–º–∞–Ω–¥–∞: ${P.team}\nURL: ${P.url||defaultURL(P.ptw_id)}`));
    lines.push('END:VEVENT','END:VCALENDAR');
    return lines.join('\n');
  }
  function downloadICS(){
    const blob=new Blob([buildICS()],{type:'text/calendar;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ptw_loto.ics'; a.click(); URL.revokeObjectURL(a.href);
  }

  // ===== –î–ï–ú–û =====
  function seedDemo(){
    document.getElementById('ptw_id').value='PTW-101';
    document.getElementById('job_title').value='–ó–∞–º—ñ–Ω–∞ —Ä–æ–∑–µ—Ç–∫–∏ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∞ C16 —É –∞—É–¥.101';
    document.getElementById('location').value='–ö–æ—Ä–ø—É—Å –ê, –©–û-1 (–∫–æ–º—ñ—Ä–∫–∞ 4), –∞—É–¥.101';
    document.getElementById('work_type').value='–ï–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂';
    document.getElementById('requester').value='–í–∏–∫–ª. –°–µ—Ä–≥—ñ–π';
    document.getElementById('issuer').value='–°—Ç–∞—Ä–æ—Å—Ç–∞ –ï–õ-21';
    document.getElementById('team').value='–°—Ç—É–¥–µ–Ω—Ç–∏ –ï–õ-21 (2 –æ—Å.)';
    document.getElementById('risk_level').value='–°–µ—Ä–µ–¥–Ω—ñ–π';
    document.getElementById('window_start').value='2025-10-23 09:00';
    document.getElementById('window_end').value='2025-10-23 11:00';
    document.getElementById('url').value='';
    document.getElementById('notes').value='–ó–Ü–ó: –¥—ñ–µ–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ —Ä—É–∫–∞–≤–∏—á–∫–∏, –æ–∫—É–ª—è—Ä–∏; –ø–æ–ø–µ—Ä–µ–¥–∏—Ç–∏ –∞—É–¥.101.';
    loadTemplate('pre'); loadTemplate('post');
    isoPoints=[
      {id:'ISO-01',desc:'–ê–≤—Ç–æ–º–∞—Ç C16, –∫–æ–º—ñ—Ä–∫–∞ 4',action:'–í–∏–º–∫–Ω—É—Ç–∏',tag:'–ó–∞–º–æ–∫ #12'},
      {id:'ISO-02',desc:'–†–æ–∑–µ—Ç–∫–∞ –∞—É–¥.101',action:'–†–æ–∑\'—î–¥–Ω–∞—Ç–∏ —à—Ç–µ–ø—Å–µ–ª—å',tag:'–ë—ñ—Ä–∫–∞ R-101'},
      {id:'ISO-03',desc:'–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞–ø—Ä—É–≥–∏ –Ω–∞ –∫–ª–µ–º–∞—Ö',action:'–ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è —É –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ U',tag:'–¢–µ—Å—Ç–µ—Ä/—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä'}
    ];
    renderIso();
  }

  // –ê–≤—Ç–æ–¥–µ–º–æ
  seedDemo();
</script>
</body>
</html>
