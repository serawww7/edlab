<!-- electric_para8.html
     –ü–∞—Ä–∞ 8 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –û–ë–õ–Ü–ö –Ü–ù–°–¢–†–£–ú–ï–ù–¢–£
     –ö–∞—Ä—Ç–∫–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É, –≥—Ä–∞—Ñ—ñ–∫ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω—å, –≤–∏–¥–∞—á–∞/–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, —Å—Ç–∞–Ω–∏, NFC/QR, –¥—Ä—É–∫ 58 –º–º, —ñ–º–ø–æ—Ä—Ç/–µ–∫—Å–ø–æ—Ä—Ç CSV.
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è GitHub Pages —ñ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ Moodle —á–µ—Ä–µ–∑ <iframe>.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 8 ‚Äî –û–±–ª—ñ–∫ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É, –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è, QR/NFC, –¥—Ä—É–∫ 58 –º–º</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 80px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:#9aa5b1}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1000px){.g3{grid-template-columns:1fr}; .g2{grid-template-columns:1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  .chip{display:inline-block; padding:2px 8px; border:1px solid #223049; border-radius:999px; font-size:12px; margin-right:6px; background:#0d1a2e}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .muted{color:#9aa5b1}

  /* –¢–∞–±–ª–∏—Ü—ñ */
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}

  /* –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è 58 –º–º */
  .ticket{width:58mm; background:#fff; color:#000; padding:5mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 4px; font-size:13px; text-align:center}
  .ticket p{margin:1px 0; font-size:12px}
  .ticket .line{border-top:1px dashed #111; margin:5px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}
  .tickets{display:flex; gap:12px; flex-wrap:wrap}

  /* –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (iframe/Moodle) */
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}

  @media print{
    @page{ size:58mm auto; margin:4mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }
</style>
</head>
<body>
  <div class="wrap">
    <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 8 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
    <h1>üß∞ –û–±–ª—ñ–∫ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É ¬∑ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è ¬∑ –≤–∏–¥–∞—á–∞/–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è ¬∑ QR/NFC ¬∑ üßæ –¥—Ä—É–∫ 58 –º–º</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>–ù–∞–≤—á–∏—Ç–∏—Å—è –≤–µ—Å—Ç–∏ –æ–±–ª—ñ–∫ –µ–ª–µ–∫—Ç—Ä–æ–≤–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–æ–≥–æ —Ç–∞ –¥–æ–ø–æ–º—ñ–∂–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É: –∫–∞—Ä—Ç–∫–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É, –≥—Ä–∞—Ñ—ñ–∫ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω—å, <b>–≤–∏–¥–∞—á–∞/–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</b>, —Å—Ç–∞–Ω–∏ <b>OK/REPAIR/OOS</b>, —à–≤–∏–¥–∫—ñ <b>QR/NFC</b>-—Ä—è–¥–∫–∏, –¥—Ä—É–∫ –µ—Ç–∏–∫–µ—Ç–æ–∫ 58 –º–º, —ñ–º–ø–æ—Ä—Ç/–µ–∫—Å–ø–æ—Ä—Ç CSV.</p>
      <div class="row">
        <button class="btn" onclick="seedDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥</button>
        <button class="btn" onclick="exportCSV()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
        <input id="file" type="file" accept=".csv,text/csv" class="btn" />
        <button class="btn" onclick="importCSV()">‚¨ÜÔ∏è –Ü–º–ø–æ—Ä—Ç CSV</button>
      </div>
      <p class="small">–ü–æ–ª—è CSV: <span class="mono">tool_id,name,category,serial,location,responsible,condition,last_cal,interval_m,next_cal,status,holder,notes,url</span></p>
    </div>

    <div class="card">
      <h2>‚ûï –î–æ–¥–∞–≤–∞–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è</h2>
      <div class="grid g3">
        <div>
          <h3>–ö–∞—Ä—Ç–∫–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É</h3>
          <div class="field"><label for="tid">ID</label><input id="tid" value="TL-001" /></div>
          <div class="field"><label for="tname">–ù–∞–∑–≤–∞</label><input id="tname" value="–ú—É–ª—å—Ç–∏–º–µ—Ç—Ä UT61E" /></div>
          <div class="field"><label for="tcat">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><input id="tcat" value="–í–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–∏–π" /></div>
          <div class="field"><label for="tser">–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ</label><input id="tser" value="SN-A12345" /></div>
          <div class="field"><label for="tloc">–õ–æ–∫–∞—Ü—ñ—è</label><input id="tloc" value="–ú–∞–π—Å—Ç–µ—Ä–Ω—è" /></div>
          <div class="field"><label for="tresp">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</label><input id="tresp" value="–°—Ç—É–¥–µ–Ω—Ç –ü–Ü–ë / –≥—Ä—É–ø–∞" /></div>
          <div class="field"><label for="tcond">–°—Ç–∞–Ω</label>
            <select id="tcond"><option value="OK" selected>OK</option><option value="REPAIR">REPAIR</option><option value="OOS">OOS</option></select>
          </div>
        </div>
        <div>
          <h3>–ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è</h3>
          <div class="field"><label for="tlast">–û—Å—Ç–∞–Ω–Ω—î –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è</label><input id="tlast" type="date" /></div>
          <div class="field"><label for="tint">–Ü–Ω—Ç–µ—Ä–≤–∞–ª, –º—ñ—Å</label><input id="tint" type="number" value="6" /></div>
          <div class="field"><label for="tnext">–ù–∞—Å—Ç—É–ø–Ω–µ (—Ä–æ–∑—Ä–∞—Ö.)</label><input id="tnext" type="text" readonly placeholder="‚Äî" /></div>
          <div class="field"><label for="tstatus">–°—Ç–∞—Ç—É—Å</label><input id="tstatus" type="text" readonly placeholder="‚Äî" /></div>
        </div>
        <div>
          <h3>–ü–æ—Å–∏–ª–∞–Ω–Ω—è/–ù–æ—Ç–∞—Ç–∫–∏</h3>
          <div class="field"><label for="turl">URL (NFC/QR)</label><input id="turl" placeholder="https://serawww7.github.io/edlab/..."></div>
          <div class="field"><label for="tnote">–ù–æ—Ç–∞—Ç–∫–∞</label><input id="tnote" placeholder="–ö–æ–º–ø–ª–µ–∫—Ç —â—É–ø—ñ–≤ —É –∫–µ–π—Å—ñ" /></div>
          <div class="row">
            <button class="btn" onclick="calcNext()">üß© –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –¥–∞—Ç—É</button>
            <button class="btn" onclick="addOrUpdate()">üíæ –î–æ–¥–∞—Ç–∏/–û–Ω–æ–≤–∏—Ç–∏</button>
          </div>
        </div>
      </div>
      <p class="small">–°—Ç–∞—Ç—É—Å –∑–∞ —Ç–µ—Ä–º—ñ–Ω–∞–º–∏: <span class="chip ok">PASS</span> ‚Äî –≤ –º–µ–∂–∞—Ö; <span class="chip warn">DUE</span> ‚Äî —Å—å–æ–≥–æ–¥–Ω—ñ/—Å–∫–æ—Ä–æ; <span class="chip bad">OVERDUE</span> ‚Äî –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ.</p>
    </div>

    <div class="card">
      <h2>üßæ –í–∏–¥–∞—á–∞/–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</h2>
      <div class="grid g2">
        <div>
          <div class="field"><label for="holder">–ö–æ–º—É –≤–∏–¥–∞–Ω–æ</label><input id="holder" placeholder="–°—Ç—É–¥–µ–Ω—Ç –ü—Ä—ñ–∑–≤–∏—â–µ / –≥—Ä—É–ø–∞" /></div>
          <div class="row">
            <button class="btn" onclick="checkout()">üì§ –í–∏–¥–∞—Ç–∏</button>
            <button class="btn" onclick="checkin()">üì• –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</button>
            <button class="btn" onclick="markRepair()">üõ†Ô∏è –í —Ä–µ–º–æ–Ω—Ç</button>
          </div>
        </div>
        <div>
          <p class="small">–Ü—Å—Ç–æ—Ä—ñ—é —Ä—É—Ö—É –º–æ–∂–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —É –≤–∏–≥–ª—è–¥—ñ CSV (–µ–∫—Å–ø–æ—Ä—Ç –Ω–∏–∂—á–µ) –∞–±–æ –¥—É–±–ª—é–≤–∞—Ç–∏ —É –∂—É—Ä–Ω–∞–ª—ñ –ü–ü–†.</p>
        </div>
      </div>
    </div>

    <div class="card printable">
      <h2>üìã –†–µ—î—Å—Ç—Ä —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th><th>ID</th><th>–ù–∞–∑–≤–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–°–µ—Ä—ñ–π–Ω–∏–π</th><th>–õ–æ–∫–∞—Ü—ñ—è</th><th>–í—ñ–¥–ø.</th>
            <th>–°—Ç–∞–Ω</th><th>–û—Å—Ç. –∫–∞–ª—ñ–±—Ä.</th><th>–Ü–Ω—Ç–µ—Ä–≤–∞–ª</th><th>–ù–∞—Å—Ç—É–ø–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–º—É –≤–∏–¥–∞–Ω–æ</th><th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small">–ü–æ–¥–≤—ñ–π–Ω–µ –∫–ª–∞—Ü–∞–Ω–Ω—è –ø–æ –∫–ª—ñ—Ç–∏–Ω—Ü—ñ ‚Äî —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è. –ö–Ω–æ–ø–∫–∏ —É –¥—ñ—ó: –ï—Ç–∏–∫–µ—Ç–∫–∞/‚úñ.</p>
    </div>

    <div class="card printable">
      <h2>üßæ –ï—Ç–∏–∫–µ—Ç–∫–∞ 58 –º–º (–∫–∞—Ä—Ç–∫–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É)</h2>
      <div class="row">
        <button class="btn" onclick="buildTicket()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
        <button class="btn" onclick="downloadTXT()">üì• TXT</button>
      </div>
      <div class="tickets" id="tickets">
        <div id="ticket" class="ticket" aria-live="polite">
          <h4>–Ü–ù–°–¢–†–£–ú–ï–ù–¢</h4>
          <p><b id="t-id">ID: ‚Äî</b></p>
          <div class="line"></div>
          <p id="t-name">–ù–∞–∑–≤–∞: ‚Äî</p>
          <p id="t-ser">–°–µ—Ä—ñ–π–Ω–∏–π: ‚Äî</p>
          <p id="t-loc">–õ–æ–∫–∞—Ü—ñ—è: ‚Äî</p>
          <p id="t-cond">–°—Ç–∞–Ω: ‚Äî</p>
          <div class="line"></div>
          <p id="t-last">–û—Å—Ç. –∫–∞–ª—ñ–±—Ä.: ‚Äî</p>
          <p id="t-next">–ù–∞—Å—Ç—É–ø–Ω–∞: ‚Äî</p>
          <p id="t-stat">–°—Ç–∞—Ç—É—Å: ‚Äî</p>
          <div class="line"></div>
          <p class="qr"><small id="t-url">QR/NFC: ‚Äî</small></p>
          <p><small id="t-ref">Ref: TL-XXXX</small></p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üì§ –ï–∫—Å–ø–æ—Ä—Ç/—Å–ø–∏—Å–∫–∏</h2>
      <div class="row">
        <button class="btn" onclick="exportCSV()">CSV —Ä–µ—î—Å—Ç—Ä—É</button>
        <button class="btn" onclick="exportDue()">CSV ¬´–î–æ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è¬ª</button>
        <button class="btn" onclick="exportMovements()">CSV —Ä—É—Ö—É</button>
      </div>
      <p class="small">¬´–î–æ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è¬ª –≤–∫–ª—é—á–∞—î <span class="chip warn">DUE</span> —Ç–∞ <span class="chip bad">OVERDUE</span>.</p>
    </div>
  </div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–æ —É Moodle
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // –°—Ç–∞–Ω
  let rows = []; // –æ–±'—î–∫—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
  let movements = []; // –∂—É—Ä–Ω–∞–ª —Ä—É—Ö—É: {time, tool_id, action, holder}
  const tbody = document.querySelector('#tbl tbody');

  // –£—Ç–∏–ª—ñ—Ç–∏ –¥–∞—Ç
  function pad(n){ return n.toString().padStart(2,'0'); }
  function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function addMonths(iso, m){
    const [y,mo,d]=iso.split('-').map(Number);
    const dt=new Date(y,mo-1,d||1);
    dt.setMonth(dt.getMonth()+m);
    return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
  }
  function cmpISO(a,b){ return new Date(a) - new Date(b); }

  // –°—Ç–∞—Ç—É—Å –∑–∞ –¥–∞—Ç–∞–º–∏
  function statusByDates(nextISO){
    const t = todayISO();
    if(!nextISO) return { status:'‚Äî', css:'' };
    if(cmpISO(nextISO,t) < 0) return { status:'OVERDUE', css:'bad' };
    if(nextISO === t) return { status:'DUE', css:'warn' };
    // –∑–∞ 14 –¥–Ω—ñ–≤ –¥–æ ‚Äî –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
    const soon = addMonths(t,-0); // –∫–æ–ø—ñ—è
    const soonDate = new Date(t); soonDate.setDate(soonDate.getDate()+14);
    const soonISO = `${soonDate.getFullYear()}-${pad(soonDate.getMonth()+1)}-${pad(soonDate.getDate())}`;
    if(cmpISO(nextISO, soonISO) <= 0) return { status:'DUE', css:'warn' };
    return { status:'PASS', css:'ok' };
  }

  // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ
  function render(){
    tbody.innerHTML='';
    rows.forEach((r,i)=>{
      const st = statusByDates(r.next_cal);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="editable" data-k="tool_id">${esc(r.tool_id)}</td>
        <td class="editable" data-k="name">${esc(r.name)}</td>
        <td class="editable" data-k="category">${esc(r.category)}</td>
        <td class="editable" data-k="serial">${esc(r.serial)}</td>
        <td class="editable" data-k="location">${esc(r.location)}</td>
        <td class="editable" data-k="responsible">${esc(r.responsible)}</td>
        <td class="editable" data-k="condition">${esc(r.condition)}</td>
        <td class="editable" data-k="last_cal">${esc(r.last_cal)}</td>
        <td class="editable" data-k="interval_m">${esc(r.interval_m)}</td>
        <td class="editable" data-k="next_cal">${esc(r.next_cal)}</td>
        <td class="${st.css}"><b>${st.status}</b></td>
        <td class="editable" data-k="holder">${esc(r.holder||'')}</td>
        <td class="mono">
          <button class="btn" data-act="label" data-id="${r.tool_id}">–ï—Ç–∏–∫–µ—Ç–∫–∞</button>
          <button class="btn" data-act="del" data-id="${r.tool_id}">‚úñ</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤ —Ç–∞–±–ª–∏—Ü—ñ
  tbody.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('.editable'); if(!td) return;
    const key = td.getAttribute('data-k');
    const idx = td.parentElement.rowIndex-1;
    const r = rows[idx];
    const inp = document.createElement('input');
    inp.value = r[key] || '';
    inp.style.width='100%'; inp.style.padding='6px 8px';
    inp.addEventListener('blur', ()=>{
      r[key] = inp.value.trim();
      if(key==='last_cal' || key==='interval_m'){
        r.next_cal = (r.last_cal && r.interval_m) ? addMonths(r.last_cal, parseInt(r.interval_m,10)||0) : '';
      }
      render();
    });
    td.innerHTML=''; td.appendChild(inp); inp.focus(); inp.select();
  });

  // –î—ñ—ó
  tbody.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
    if(act==='del'){ rows = rows.filter(x=>x.tool_id!==id); render(); return; }
    if(act==='label'){ const r = rows.find(x=>x.tool_id===id); buildTicket(r); document.getElementById('ticket').scrollIntoView({behavior:'smooth'}); }
  });

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
  function calcNext(){
    const last = document.getElementById('tlast').value || todayISO();
    const m = parseInt(document.getElementById('tint').value,10)||0;
    const next = m ? addMonths(last,m) : '';
    document.getElementById('tnext').value = next || '‚Äî';
    const st = statusByDates(next);
    document.getElementById('tstatus').value = next ? st.status : '‚Äî';
  }

  function addOrUpdate(){
    const rec = {
      tool_id: (document.getElementById('tid').value||'').trim(),
      name: (document.getElementById('tname').value||'').trim(),
      category: (document.getElementById('tcat').value||'').trim(),
      serial: (document.getElementById('tser').value||'').trim(),
      location: (document.getElementById('tloc').value||'').trim(),
      responsible: (document.getElementById('tresp').value||'').trim(),
      condition: document.getElementById('tcond').value,
      last_cal: document.getElementById('tlast').value || '',
      interval_m: parseInt(document.getElementById('tint').value,10)||0,
      next_cal: (document.getElementById('tnext').value && document.getElementById('tnext').value!=='‚Äî') ? document.getElementById('tnext').value : '',
      status: document.getElementById('tstatus').value || '‚Äî',
      holder: (document.getElementById('holder').value||'').trim(),
      notes: (document.getElementById('tnote').value||'').trim(),
      url: (document.getElementById('turl').value||'').trim()
    };
    if(!rec.tool_id){ alert('–ó–∞–ø–æ–≤–Ω–∏ ID'); return; }
    const i = rows.findIndex(x=>x.tool_id===rec.tool_id);
    if(i>=0) rows[i] = {...rows[i], ...rec};
    else rows.push(rec);
    render();
  }

  // –í–∏–¥–∞—á–∞/–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è/—Ä–µ–º–æ–Ω—Ç
  function checkout(){
    const id = document.getElementById('tid').value.trim();
    const who = document.getElementById('holder').value.trim();
    if(!id || !who){ alert('–í–∫–∞–∂–∏ ID —ñ –ö–æ–º—É –≤–∏–¥–∞–Ω–æ'); return; }
    const r = rows.find(x=>x.tool_id===id); if(!r){ alert('–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ ID —É —Ä–µ—î—Å—Ç—Ä—ñ'); return; }
    r.holder = who; pushMove(id,'CHECKOUT',who); render();
  }
  function checkin(){
    const id = document.getElementById('tid').value.trim();
    const r = rows.find(x=>x.tool_id===id); if(!r){ alert('–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ ID —É —Ä–µ—î—Å—Ç—Ä—ñ'); return; }
    pushMove(id,'CHECKIN', r.holder||''); r.holder=''; render();
  }
  function markRepair(){
    const id = document.getElementById('tid').value.trim();
    const r = rows.find(x=>x.tool_id===id); if(!r){ alert('–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ ID —É —Ä–µ—î—Å—Ç—Ä—ñ'); return; }
    r.condition = 'REPAIR'; pushMove(id,'REPAIR', r.holder||''); render();
  }
  function pushMove(id, action, holder){ movements.push({time:nowStamp(), tool_id:id, action, holder}); }
  function nowStamp(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // –ï—Ç–∏–∫–µ—Ç–∫–∞
  function buildTicket(rec){
    let r = rec;
    if(!r){
      const id = (document.getElementById('tid').value||'').trim();
      r = rows.find(x=>x.tool_id===id);
    }
    const t = (id)=>document.getElementById(id);
    if(!r){
      t('t-id').textContent = 'ID: ‚Äî';
      t('t-name').textContent = '–ù–∞–∑–≤–∞: ‚Äî';
      t('t-ser').textContent = '–°–µ—Ä—ñ–π–Ω–∏–π: ‚Äî';
      t('t-loc').textContent = '–õ–æ–∫–∞—Ü—ñ—è: ‚Äî';
      t('t-cond').textContent = '–°—Ç–∞–Ω: ‚Äî';
      t('t-last').textContent = '–û—Å—Ç. –∫–∞–ª—ñ–±—Ä.: ‚Äî';
      t('t-next').textContent = '–ù–∞—Å—Ç—É–ø–Ω–∞: ‚Äî';
      t('t-stat').textContent = '–°—Ç–∞—Ç—É—Å: ‚Äî';
      t('t-url').textContent = 'QR/NFC: ‚Äî';
      t('t-ref').textContent = 'Ref: TL-XXXX';
      return;
    }
    const st = statusByDates(r.next_cal);
    t('t-id').textContent = `ID: ${r.tool_id}`;
    t('t-name').textContent = `–ù–∞–∑–≤–∞: ${r.name}`;
    t('t-ser').textContent = `–°–µ—Ä—ñ–π–Ω–∏–π: ${r.serial||'‚Äî'}`;
    t('t-loc').textContent = `–õ–æ–∫–∞—Ü—ñ—è: ${r.location||'‚Äî'}`;
    t('t-cond').textContent = `–°—Ç–∞–Ω: ${r.condition||'‚Äî'}`;
    t('t-last').textContent = `–û—Å—Ç. –∫–∞–ª—ñ–±—Ä.: ${r.last_cal||'‚Äî'}`;
    t('t-next').textContent = `–ù–∞—Å—Ç—É–ø–Ω–∞: ${r.next_cal||'‚Äî'}`;
    t('t-stat').textContent = `–°—Ç–∞—Ç—É—Å: ${st.status}`;
    const url = r.url || (`https://serawww7.github.io/edlab/electric_para8.html#${encodeURIComponent(r.tool_id)}`);
    t('t-url').textContent = `QR/NFC: ${url}`;
    t('t-ref').textContent = `Ref: ${r.tool_id}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
  }

  function downloadTXT(){
    const lines=[];
    lines.push('TOOL LABEL 58mm'); lines.push('----------------');
    lines.push(document.getElementById('ticket').innerText.replace(/\n{2,}/g,'\n'));
    const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tool_label_58mm.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  // –ï–∫—Å–ø–æ—Ä—Ç
  function exportCSV(){
    const headers = ['tool_id','name','category','serial','location','responsible','condition','last_cal','interval_m','next_cal','status','holder','notes','url'];
    const csv = [headers.join(','), ...rows.map(r=>[
      r.tool_id,r.name,r.category,r.serial,r.location,r.responsible,r.condition,r.last_cal,r.interval_m,r.next_cal,statusByDates(r.next_cal).status,r.holder||'',r.notes||'',r.url||''
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='tool_registry.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  function exportDue(){
    const headers = ['tool_id','name','next_cal','status'];
    const due = rows.filter(r=>['DUE','OVERDUE'].includes(statusByDates(r.next_cal).status));
    const csv = [headers.join(','), ...due.map(r=>[r.tool_id,r.name,r.next_cal,statusByDates(r.next_cal).status].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='tool_due_calibration.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  function exportMovements(){
    const headers = ['time','tool_id','action','holder'];
    const csv = [headers.join(','), ...movements.map(m=>[m.time,m.tool_id,m.action,m.holder].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='tool_movements.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  // –Ü–º–ø–æ—Ä—Ç
  async function importCSV(){
    const f=document.getElementById('file').files[0]; if(!f){ alert('–û–±–µ—Ä—ñ—Ç—å CSV'); return; }
    const txt = await f.text();
    const lines = txt.trim().split(/\r?\n/); if(lines.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers = lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const req = ['tool_id','name','category','serial','location','responsible','condition','last_cal','interval_m','next_cal','status','holder','notes','url'];
    const miss = req.filter(x=>!headers.includes(x));
    if(miss.length){ alert('–í—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è: '+miss.join(', ')); return; }
    const out=[];
    for(let i=1;i<lines.length;i++){
      const cells = splitCSV(lines[i]); if(!cells.length) continue;
      const o={}; headers.forEach((h,j)=> o[h]=(cells[j]||'').replace(/^"|"$/g,''));
      out.push({
        tool_id:o.tool_id, name:o.name, category:o.category, serial:o.serial, location:o.location, responsible:o.responsible,
        condition:o.condition, last_cal:o.last_cal, interval_m:parseInt(o.interval_m||'0',10), next_cal:o.next_cal,
        status:o.status, holder:o.holder||'', notes:o.notes||'', url:o.url||''
      });
    }
    rows = out; render();
  }
  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  // –î–µ–º–æ
  function seedDemo(){
    rows = [
      {tool_id:'TL-001', name:'–ú—É–ª—å—Ç–∏–º–µ—Ç—Ä UT61E', category:'–í–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–∏–π', serial:'SN-A12345', location:'–ú–∞–π—Å—Ç–µ—Ä–Ω—è', responsible:'–°—Ç—É–¥–µ–Ω—Ç 1', condition:'OK', last_cal:todayISO(), interval_m:6, next_cal:addMonths(todayISO(),6), status:'PASS', holder:'', notes:'–ö–æ–º–ø–ª–µ–∫—Ç —â—É–ø—ñ–≤', url:''},
      {tool_id:'TL-002', name:'–ö–ª—ñ—â—ñ —Å—Ç—Ä—É–º–æ–≤—ñ', category:'–í–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–∏–π', serial:'SN-B9988', location:'–ú–∞–π—Å—Ç–µ—Ä–Ω—è', responsible:'–°—Ç—É–¥–µ–Ω—Ç 2', condition:'OK', last_cal:'2025-05-01', interval_m:6, next_cal:'2025-11-01', status:'DUE', holder:'', notes:'', url:''},
      {tool_id:'TL-010', name:'–ü–∞—è–ª—å–Ω–∏–∫ 60W', category:'–î–æ–ø–æ–º—ñ–∂–Ω–∏–π', serial:'', location:'–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è', responsible:'–°—Ç—É–¥–µ–Ω—Ç 3', condition:'REPAIR', last_cal:'', interval_m:0, next_cal:'', status:'‚Äî', holder:'', notes:'–ó–∞–º—ñ–Ω–∞ –∂–∞–ª–∞', url:''}
    ];
    render();
  }

  // –î–æ–ø–æ–º—ñ–∂–Ω—ñ
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // –ê–≤—Ç–æ-–¥–µ–º–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
  seedDemo();
</script>
</body>
</html>
