<!-- electric_para14.html
     –ü–∞—Ä–∞ 14 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –ö–ê–ë–ï–õ–Ü –¢–ê –ó–ê–•–ò–°–¢
     –í–∏–±—ñ—Ä –ø–µ—Ä–µ—Ä—ñ–∑—É –∫–∞–±–µ–ª—é –∑–∞ —Å—Ç—Ä—É–º–æ–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ –∫–æ—Ä–µ–∫—Ü—ñ—ó,
     –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ (ŒîU), –ø—ñ–¥–±—ñ—Ä –∞–≤—Ç–æ–º–∞—Ç–∞ (MCB), –Ω–∞–∫–ª–µ–π–∫–∏ 58 –º–º, A4-–∑–≤—ñ—Ç, CSV.
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è GitHub Pages —ñ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ Moodle —á–µ—Ä–µ–∑ <iframe>.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 14 ‚Äî –ö–∞–±–µ–ª—ñ: –ø–µ—Ä–µ—Ä—ñ–∑, –∫–æ–µ—Ñ. –∫–æ—Ä–µ–∫—Ü—ñ—ó, ŒîU, –∞–≤—Ç–æ–º–∞—Ç, 58 –º–º</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1120px; margin:0 auto; padding:24px 16px 96px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:#9aa5b1}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1050px){.g3{grid-template-columns:1fr}; .g2{grid-template-columns:1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  .chip{display:inline-block; padding:2px 8px; border:1px solid #223049; border-radius:999px; font-size:12px; margin-right:6px; background:#0d1a2e}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)} .muted{color:#9aa5b1}
  input,select,textarea{padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e5e7eb; width:100%}

  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px}
  tbody tr:nth-child(even){background:#0b1324}

  .tickets{display:flex; gap:12px; flex-wrap:wrap}
  .ticket{
    width:58mm; background:#fff; color:#000; padding:5mm 4mm; border-radius:6px;
    box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace
  }
  .ticket h4{margin:0 0 4px; font-size:13px; text-align:center}
  .ticket p{margin:1px 0; font-size:12px}
  .ticket .line{border-top:1px dashed #111; margin:5px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}

  #printArea{background:#fff; color:#000; border-radius:12px; border:1px solid #e5e7eb; padding:16px}
  .doc{page-break-after:always; padding:12mm; color:#000; font-family:Georgia,"Times New Roman",serif}
  .doc h2{color:#000; font-size:20px; margin:0 0 6px}
  .doc h3{color:#000; font-size:16px; margin:6px 0}
  .doc p{color:#000; margin:4px 0}
  .doc table{width:100%; border-collapse:collapse; border:1px solid #111}
  .doc th,.doc td{border:1px solid #111; padding:6px 8px; font-size:12px; vertical-align:top}
  .doc .sign{margin-top:10mm; display:flex; gap:10mm; flex-wrap:wrap}
  .doc .sign div{flex:1 1 220px}

  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}

  @media print{
    @page{ size:A4; margin:12mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    #printArea{ border:none; padding:0 }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }
</style>
</head>
<body>
  <div class="wrap">
    <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 14 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
    <h1>üßµ –ö–∞–±–µ–ª—ñ: –ø–µ—Ä–µ—Ä—ñ–∑ –∑–∞ —Å—Ç—Ä—É–º–æ–º ‚Üí –∫–æ–µ—Ñ. –∫–æ—Ä–µ–∫—Ü—ñ—ó ‚Üí ŒîU ‚Üí –ø—ñ–¥–±—ñ—Ä MCB ‚Üí üßæ 58 –º–º</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>–î–ª—è –∫–æ–∂–Ω–æ—ó –ª—ñ–Ω—ñ—ó –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä–æ–±–æ—á–∏–π —Å—Ç—Ä—É–º, –æ–±—Ä–∞—Ç–∏ –ø–µ—Ä–µ—Ä—ñ–∑ –∫–∞–±–µ–ª—é –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º <b>–∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ –∫–æ—Ä–µ–∫—Ü—ñ—ó</b> (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —Å–ø–æ—Å—ñ–± –ø—Ä–æ–∫–ª–∞–¥–∫–∏, –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è), –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ <b>–ø–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ ŒîU</b> –Ω–∞ –¥–æ–≤–∂–∏–Ω—ñ, –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ <b>–∞–≤—Ç–æ–º–∞—Ç</b> —Ç–∞ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–∞–∫–ª–µ–π–∫–∏ 58 –º–º —ñ A4-–∑–≤—ñ—Ç.</p>
      <p class="small">–§–æ—Ä–º—É–ª–∏: <span class="mono">I = P / (U¬∑PF¬∑Œ∑)</span> (1–§: U=230; 3–§: <span class="mono">I = P / (‚àö3¬∑U<sub>L-L</sub>¬∑PF¬∑Œ∑)</span>), <span class="mono">I<sub>corr</sub> = I / (k<sub>T</sub>¬∑k<sub>inst</sub>¬∑k<sub>grp</sub>)</span>, –≤–∏–±—ñ—Ä S: <span class="mono">Iz(S) ‚â• 1.25¬∑I</span> —Ç–∞ <span class="mono">ŒîU%</span> –≤ –º–µ–∂–∞—Ö –ª—ñ–º—ñ—Ç—É.</p>
      <div class="row">
        <button class="btn" onclick="seedDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥</button>
        <button class="btn" onclick="exportCSV()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
        <input id="file" type="file" accept=".csv,text/csv" class="btn" />
        <button class="btn" onclick="importCSV()">‚¨ÜÔ∏è –Ü–º–ø–æ—Ä—Ç CSV</button>
      </div>
      <p class="small">CSV: <span class="mono">id,name,phases,kW,PF,eta,material,install,tempC,groupCount,length_m,drop_limit_pct,curve,stdA,url,notes</span></p>
    </div>

    <div class="card">
      <h2>‚ûï –î–æ–¥–∞—Ç–∏ –ª—ñ–Ω—ñ—é</h2>
      <div class="grid g3">
        <div>
          <h3>–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
          <div class="row"><label class="small" style="min-width:150px">ID</label><input id="id" value="CL-01"></div>
          <div class="row"><label class="small" style="min-width:150px">–ù–∞–∑–≤–∞</label><input id="name" value="–ñ–∏–≤–ª–µ–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó"></div>
          <div class="row"><label class="small" style="min-width:150px">–§–∞–∑–∏</label><select id="phases"><option selected>1–§</option><option>3–§</option></select></div>
          <div class="row"><label class="small" style="min-width:150px">–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å, –∫–í—Ç</label><input id="kW" type="number" step="0.1" value="3.5"></div>
          <div class="row"><label class="small" style="min-width:150px">PF (cosœÜ)</label><input id="pf" type="number" step="0.01" value="0.95"></div>
          <div class="row"><label class="small" style="min-width:150px">Œ∑</label><input id="eta" type="number" step="0.01" value="0.98"></div>
        </div>
        <div>
          <h3>–ö–∞–±–µ–ª—å / —É–º–æ–≤–∏</h3>
          <div class="row"><label class="small" style="min-width:150px">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label><select id="material"><option selected>Cu</option><option>Al</option></select></div>
          <div class="row"><label class="small" style="min-width:150px">–ü—Ä–æ–∫–ª–∞–¥–∫–∞</label>
            <select id="install"><option selected>–ü–æ–≤—ñ—Ç—Ä—è/–ª–æ—Ç–æ–∫</option><option>–¢—Ä—É–±–∞/–∫–∞–Ω–∞–ª</option><option>–ó–µ–º–ª—è</option></select></div>
          <div class="row"><label class="small" style="min-width:150px">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C</label><input id="tempC" type="number" value="30"></div>
          <div class="row"><label class="small" style="min-width:150px">–ö-—Ç—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö/–∑–≥—Ä—É–ø.</label><input id="groupCount" type="number" value="1"></div>
          <div class="row"><label class="small" style="min-width:150px">–î–æ–≤–∂–∏–Ω–∞ L, –º</label><input id="L" type="number" value="35"></div>
          <div class="row"><label class="small" style="min-width:150px">–õ—ñ–º—ñ—Ç ŒîU, %</label><input id="dropLim" type="number" step="0.1" value="5"></div>
        </div>
        <div>
          <h3>–ó–∞—Ö–∏—Å—Ç / —Å–ª—É–∂–±–æ–≤–µ</h3>
          <div class="row"><label class="small" style="min-width:150px">–ö—Ä–∏–≤–∞ MCB</label><select id="curve"><option>B</option><option selected>C</option><option>D</option></select></div>
          <div class="row"><label class="small" style="min-width:150px">–†—è–¥, –ê</label>
            <select id="stdA"><option>6</option><option>10</option><option selected>16</option><option>20</option><option>25</option><option>32</option><option>40</option><option>50</option><option>63</option></select></div>
          <div class="row"><label class="small" style="min-width:150px">URL (NFC/QR)</label><input id="url" placeholder="https://serawww7.github.io/edlab/..."></div>
          <div class="row"><label class="small" style="min-width:150px">–ù–æ—Ç–∞—Ç–∫–∞</label><input id="notes" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∞"></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="addOrUpdate()">üíæ –î–æ–¥–∞—Ç–∏/–û–Ω–æ–≤–∏—Ç–∏</button>
        <button class="btn" onclick="calcOne()">üßÆ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="seedOne()">üîÑ –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Å—É</button>
      </div>
    </div>

    <div class="card printable">
      <h2>üìã –†–µ—î—Å—Ç—Ä –∫–∞–±–µ–ª—å–Ω–∏—Ö –ª—ñ–Ω—ñ–π</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th><th>ID</th><th>–ù–∞–∑–≤–∞</th><th>–§–∞–∑–∏</th><th>–∫–í—Ç</th><th>I, –ê</th><th>S, –º–º¬≤</th><th>Iz, –ê</th><th>MCB</th><th>ŒîU, %</th><th>–°—Ç–∞—Ç—É—Å</th><th>URL</th><th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small">–°—Ç–∞—Ç—É—Å: <span class="chip ok">PASS</span> ‚Äî Iz ‚â• 1.25¬∑I —ñ ŒîU ‚â§ –ª—ñ–º—ñ—Ç; <span class="chip warn">WARN</span> ‚Äî –Ω–∞ –º–µ–∂—ñ; <span class="chip bad">FAIL</span> ‚Äî –ø–æ—Ä—É—à–µ–Ω–æ.</p>
    </div>

    <div class="card printable">
      <h2>üßæ –ù–∞–∫–ª–µ–π–∫–∏ 58 –º–º ¬´–ö–ê–ë–ï–õ–¨–ù–ê –õ–Ü–ù–Ü–Ø¬ª</h2>
      <div class="row">
        <button class="btn" onclick="buildTickets()">üß© –ó—ñ–±—Ä–∞—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
        <button class="btn" onclick="downloadTXT()">üì• TXT</button>
      </div>
      <div id="tickets" class="tickets"></div>
    </div>

    <div class="card printable">
      <h2>üìÑ A4-–∑–≤—ñ—Ç (–¥–ª—è –¥—Ä—É–∫—É/PDF)</h2>
      <div class="row">
        <button class="btn" onclick="buildReport()">üß© –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ A4</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫/PDF</button>
      </div>
      <div id="printArea"></div>
    </div>
  </div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // ======= –°–¢–ê–ù =======
  let lines = []; // {id,name,phases,kW,PF,eta,material,install,tempC,groupCount,L,dropLim,curve,stdA,url,notes,calc:{I, kT,kInst,kGrp, Icorr, S, Iz, drop, mcb, status}}
  const tbody = document.querySelector('#tbl tbody');
  const ticketsBox = document.getElementById('tickets');

  // ======= –î–ê–ù–Ü –î–õ–Ø –†–û–ó–†–ê–•–£–ù–ö–Ü–í (–ù–ê–í–ß–ê–õ–¨–ù–Ü) =======
  // –ë–∞–∑–æ–≤—ñ –¥–æ–ø—É—Å—Ç–∏–º—ñ —Ç—Ä–∏–≤–∞–ª—ñ —Å—Ç—Ä—É–º–∏ Iz_base (A) –¥–ª—è Cu/Al, 2-3 –∂–∏–ª–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ, –ü–í–• —ñ–∑–æ–ª—è—Ü—ñ—è (—Å–ø—Ä–æ—â–µ–Ω–æ):
  const IZ_BASE = {
    Cu: {1.5: 18, 2.5: 25, 4: 34, 6: 44, 10: 61, 16: 82, 25: 108, 35: 135},
    Al: {2.5: 20, 4: 26, 6: 34, 10: 46, 16: 61, 25: 79, 35: 96}
  };
  // –ö–æ–µ—Ñ. —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∏–π kT (–¥–æ–≤–∫—ñ–ª–ª—è, ¬∞C):
  function kT(temp){
    if(temp<=25) return 1.10;
    if(temp<=30) return 1.00;
    if(temp<=35) return 0.94;
    if(temp<=40) return 0.87;
    if(temp<=45) return 0.79;
    if(temp<=50) return 0.71;
    return 0.63;
  }
  // –ö–æ–µ—Ñ. —Å–ø–æ—Å–æ–±—É –ø—Ä–æ–∫–ª–∞–¥–∫–∏ kInst:
  // –ü–æ–≤—ñ—Ç—Ä—è/–ª–æ—Ç–æ–∫ ~1.00; –¢—Ä—É–±–∞/–∫–∞–Ω–∞–ª (–≥—ñ—Ä—à–µ –æ—Ö–æ–ª–æ–¥–∂.) ~0.85; –ó–µ–º–ª—è (–æ–¥–∏–Ω –∫–∞–±–µ–ª—å) ~1.05
  function kInst(install){
    if(install==='–ü–æ–≤—ñ—Ç—Ä—è/–ª–æ—Ç–æ–∫') return 1.00;
    if(install==='–¢—Ä—É–±–∞/–∫–∞–Ω–∞–ª') return 0.85;
    if(install==='–ó–µ–º–ª—è') return 1.05;
    return 1.00;
  }
  // –ö–æ–µ—Ñ. –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è kGrp (–Ω–∞–≤—á–∞–ª—å–Ω–æ; 1 ‚Üí 1.00; 2 ‚Üí 0.8; 3‚Äì5 ‚Üí 0.7; >5 ‚Üí 0.6)
  function kGrp(n){
    if(n<=1) return 1.00;
    if(n===2) return 0.80;
    if(n<=5) return 0.70;
    return 0.60;
  }
  // –û–ø–æ—Ä–∏ (Œ©¬∑–º–º¬≤/–º) –¥–ª—è ŒîU (–ø–∏—Ç–æ–º–∏–π –æ–ø—ñ—Ä –ø—Ä–∏ 20¬∞C):
  const RHO = { Cu: 0.0175, Al: 0.0282 };

  // ======= –£–¢–ò–õ–Ü–¢–ò =======
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function nowStamp(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function round2(x){ return Math.round(x*100)/100; }

  // –°—Ç—Ä—É–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  function I_from(kW, phases, PF, eta, Uln=230, Ull=400){
    const P = (parseFloat(kW)||0)*1000;
    const pf = parseFloat(PF)||1;
    const e = parseFloat(eta)||1;
    if(phases==='3–§'){ if(Ull<=0||pf<=0||e<=0) return 0; return P/(Math.sqrt(3)*Ull*pf*e); }
    if(Uln<=0||pf<=0||e<=0) return 0; return P/(Uln*pf*e);
  }

  // –ü–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ (—Å–ø—Ä–æ—â–µ–Ω–æ, –∞–∫—Ç–∏–≤–Ω–∞ —Å–∫–ª–∞–¥–æ–≤–∞): ŒîU% ‚âà I ¬∑ 2¬∑L¬∑œÅ / (S¬∑U) ¬∑ 100; 3–§ ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ U=400
  function drop_pct(I, L, S, U, material){
    const rho = RHO[material] || RHO.Cu;
    if(S<=0||U<=0) return 0;
    return (I * 2 * L * rho) / (S * U) * 100;
  }

  // –í–∏–±—ñ—Ä –ø–µ—Ä–µ—Ä—ñ–∑—É ‚Äî –ø–µ—Ä—à–∏–π S, –¥–ª—è —è–∫–æ–≥–æ Iz_adj ‚â• 1.25*I
  function pickSection(material, I, temp, inst, grp){
    const base = IZ_BASE[material];
    const k = kT(temp) * kInst(inst) * kGrp(grp);
    const need = 1.25 * I;
    let bestS = null, bestIz = 0;
    Object.keys(base).map(parseFloat).sort((a,b)=>a-b).forEach(S=>{
      const Iz_adj = base[S] * k;
      if(!bestS && Iz_adj >= need){ bestS = S; bestIz = Iz_adj; }
    });
    // —è–∫—â–æ –∂–æ–¥–µ–Ω –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å ‚Äî –±–µ—Ä–µ–º–æ –Ω–∞–π–±—ñ–ª—å—à–∏–π —ñ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—î–º–æ
    if(!bestS){
      const Smax = Math.max(...Object.keys(base).map(parseFloat));
      bestS = Smax; bestIz = base[Smax] * k;
    }
    return {S:bestS, Iz:round2(bestIz), kT:kT(temp), kInst:kInst(inst), kGrp:kGrp(grp)};
  }

  function pickMCB(Irun, stdA){
    const row=[6,10,13,16,20,25,32,40,50,63];
    const need = Irun*1.25; // –∑–∞–ø–∞—Å –¥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    let pick = row.find(x=>x>=need) || row[row.length-1];
    return Math.max(pick, stdA);
  }

  function statusFrom(I, Iz, drop, dropLim){
    if(Iz < 1.25*I || drop > dropLim) return 'FAIL';
    if( (Iz - 1.25*I) < 5 || (dropLim - drop) < 0.5 ) return 'WARN';
    return 'PASS';
  }

  // ======= –î–û–î–ê–¢–ò/–û–ù–û–í–ò–¢–ò =======
  function addOrUpdate(){
    const rec = {
      id: (document.getElementById('id').value||'').trim(),
      name: (document.getElementById('name').value||'').trim(),
      phases: document.getElementById('phases').value,
      kW: parseFloat(document.getElementById('kW').value||'0'),
      PF: parseFloat(document.getElementById('pf').value||'1'),
      eta: parseFloat(document.getElementById('eta').value||'1'),
      material: document.getElementById('material').value,
      install: document.getElementById('install').value,
      tempC: parseFloat(document.getElementById('tempC').value||'30'),
      groupCount: parseInt(document.getElementById('groupCount').value||'1',10),
      L: parseFloat(document.getElementById('L').value||'0'),
      dropLim: parseFloat(document.getElementById('dropLim').value||'5'),
      curve: document.getElementById('curve').value,
      stdA: parseInt(document.getElementById('stdA').value||'16',10),
      url: (document.getElementById('url').value||'').trim(),
      notes: (document.getElementById('notes').value||'').trim()
    };
    if(!rec.id){ alert('–£–∫–∞–∂–∏ ID'); return; }
    const i = lines.findIndex(x=>x.id===rec.id);
    if(i>=0) lines[i] = {...lines[i], ...rec};
    else lines.push(rec);
    calcOne(rec.id);
  }

  // ======= –†–û–ó–†–ê–•–£–ù–û–ö –û–î–ù–Ü–Ñ–á –õ–Ü–ù–Ü–á =======
  function calcOne(idOpt){
    const id = idOpt || (document.getElementById('id').value||'').trim();
    const r = lines.find(x=>x.id===id);
    if(!r){ alert('–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ –∑–∞–ø–∏—Å—É'); return; }
    r.calc = r.calc || {};
    const U = r.phases==='3–§' ? 400 : 230;
    const I = I_from(r.kW, r.phases, r.PF, r.eta, 230, 400);
    const pick = pickSection(r.material, I, r.tempC, r.install, r.groupCount);
    const drop = round2( drop_pct(I, r.L, pick.S, U, r.material) );
    const mcb = pickMCB(I, r.stdA);
    const status = statusFrom(I, pick.Iz, drop, r.dropLim);
    r.calc = { I:round2(I), ...pick, drop, mcb, status };
    render();
    buildTickets([r]);
  }

  // ======= –†–ï–ù–î–ï–† =======
  function render(){
    tbody.innerHTML='';
    lines.forEach((r,i)=>{
      const c = r.calc || {};
      const badge = `<span class="mono" style="padding:2px 8px;border:1px solid #223049;border-radius:999px;background:#0d1a2e;color:${
        c.status==='PASS'?'#22c55e':(c.status==='WARN'?'#f59e0b':'#ef4444')
      }">${c.status||'‚Äî'}</span>`;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="editable" data-k="id" data-id="${r.id}">${esc(r.id)}</td>
        <td class="editable" data-k="name" data-id="${r.id}">${esc(r.name)}</td>
        <td class="editable" data-k="phases" data-id="${r.id}">${esc(r.phases)}</td>
        <td class="editable" data-k="kW" data-id="${r.id}">${esc(r.kW)}</td>
        <td>${c.I??'‚Äî'}</td>
        <td>${c.S??'‚Äî'}</td>
        <td>${c.Iz??'‚Äî'}</td>
        <td>${esc(r.curve||'')}${c.mcb??'‚Äî'}</td>
        <td>${c.drop??'‚Äî'}</td>
        <td>${badge}</td>
        <td class="editable" data-k="url" data-id="${r.id}">${esc(r.url||'')}</td>
        <td class="mono"><button class="btn" data-act="label" data-id="${r.id}">–ù–∞–∫–ª–µ–π–∫–∞</button> <button class="btn" data-act="del" data-id="${r.id}">‚úñ</button></td>`;
      tbody.appendChild(tr);
    });
  }

  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤ —Ç–∞–±–ª–∏—Ü—ñ
  tbody.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('.editable'); if(!td) return;
    const id = td.getAttribute('data-id'); const key = td.getAttribute('data-k');
    const idx = lines.findIndex(x=>x.id===id); const r = lines[idx];
    const input = document.createElement('input'); input.value = r[key] || ''; input.style.width='100%'; input.style.padding='6px 8px';
    input.addEventListener('blur', ()=>{
      let v = input.value.trim();
      if(['kW'].includes(key)) v = parseFloat(v.replace(',','.'))||0;
      r[key] = v; calcOne(r.id);
    });
    td.innerHTML=''; td.appendChild(input); input.focus(); input.select();
  });

  // –î—ñ—ó
  tbody.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
    if(act==='del'){ lines = lines.filter(x=>x.id!==id); render(); return; }
    if(act==='label'){ const r = lines.find(x=>x.id===id); if(!r.calc) calcOne(id); buildTickets([r]); ticketsBox.scrollIntoView({behavior:'smooth'}); }
  });

  // ======= –ù–ê–ö–õ–ï–ô–ö–ò 58 –º–º =======
  function buildTickets(list){
    const L = list || lines;
    ticketsBox.innerHTML='';
    L.forEach(r=>{
      const c = r.calc || {};
      const el = document.createElement('div'); el.className='ticket';
      const urlText = r.url ? r.url : `https://serawww7.github.io/edlab/electric_para14.html#${encodeURIComponent(r.id)}`;
      el.innerHTML = `
        <h4>–ö–ê–ë–ï–õ–¨–ù–ê –õ–Ü–ù–Ü–Ø</h4>
        <p><b>${esc(r.id)} ¬∑ ${esc(r.name)}</b></p>
        <div class="line"></div>
        <p>${esc(r.phases)} ¬∑ –ú–∞—Ç–µ—Ä—ñ–∞–ª: ${esc(r.material)} ¬∑ –ü—Ä–æ–∫–ª–∞–¥–∫–∞: ${esc(r.install)}</p>
        <p>I‚âà ${c.I??'‚Äî'} A ¬∑ S=${c.S??'‚Äî'} –º–º¬≤ (Iz‚âà ${c.Iz??'‚Äî'} A)</p>
        <p>MCB: ${esc(r.curve)}${c.mcb??'‚Äî'} A ¬∑ ŒîU‚âà ${c.drop??'‚Äî'}% (L=${esc(r.L)} –º)</p>
        <div class="line"></div>
        <p class="qr"><small>URL/NFC: ${esc(urlText)}</small></p>
        <p><small>${nowStamp()}</small></p>
      `;
      ticketsBox.appendChild(el);
    });
  }

  function downloadTXT(){
    if(!ticketsBox.firstChild){ alert('–°–ø–æ—á–∞—Ç–∫—É –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ –Ω–∞–∫–ª–µ–π–∫–∏'); return; }
    const linesOut=['CABLE LINE LABELS 58mm','-------------------'];
    Array.from(ticketsBox.children).forEach(t=>{ linesOut.push(t.innerText.replace(/\n{2,}/g,'\n')); linesOut.push('-------------------'); });
    const blob = new Blob([linesOut.join('\n')], {type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cable_line_58mm.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  // ======= A4-–ó–í–Ü–¢ =======
  function buildReport(){
    if(!lines.length){ alert('–ù–µ–º–∞—î –ª—ñ–Ω—ñ–π'); return; }
    const rows = lines.map((r,i)=>{
      const c = r.calc || {};
      return `
        <tr>
          <td>${i+1}</td><td>${esc(r.id)}</td><td>${esc(r.name)}</td><td>${esc(r.phases)}</td>
          <td>${r.kW}</td><td>${c.I??'‚Äî'}</td><td>${esc(r.material)}</td><td>${esc(r.install)}</td><td>${r.tempC}¬∞C</td>
          <td>${c.S??'‚Äî'}</td><td>${c.Iz??'‚Äî'}</td><td>${esc(r.curve)}${c.mcb??'‚Äî'}</td><td>${c.drop??'‚Äî'}%</td><td>${esc(r.notes||'')}</td>
        </tr>`;
    }).join('');
    const html = `
      <section class="doc">
        <h2>–í–ò–ë–Ü–† –ü–ï–†–ï–†–Ü–ó–£ –ö–ê–ë–ï–õ–Æ, ŒîU –¢–ê –ó–ê–•–ò–°–¢</h2>
        <p>–î–∞—Ç–∞: ${nowStamp()}</p>
        <table>
          <thead>
            <tr><th>#</th><th>ID</th><th>–ù–∞–∑–≤–∞</th><th>–§–∞–∑–∏</th><th>–∫–í—Ç</th><th>I, –ê</th><th>–ú–∞—Ç–µ—Ä—ñ–∞–ª</th><th>–ü—Ä–æ–∫–ª–∞–¥–∫–∞</th><th>–¢–µ–º–ø.</th><th>S, –º–º¬≤</th><th>Iz, –ê</th><th>MCB</th><th>ŒîU, %</th><th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <h3>–í–∏—Å–Ω–æ–≤–æ–∫</h3>
        <p>PASS: ${lines.filter(r=>r.calc?.status==='PASS').length}; WARN: ${lines.filter(r=>r.calc?.status==='WARN').length}; FAIL: ${lines.filter(r=>r.calc?.status==='FAIL').length}.</p>
        <div class="sign"><div>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ____________________</div><div>–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ____________________</div></div>
        <p class="small">–ó–∞—É–≤–∞–∂–µ–Ω–Ω—è: —Å–ø—Ä–æ—â–µ–Ω–∏–π –Ω–∞–≤—á–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ (–±–µ–∑ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—ó —Å–∫–ª–∞–¥–æ–≤–æ—ó, –±–µ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ö–ó —Ç–∞ —á–∞—Å—É –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è). –£ —Ä–µ–∞–ª—å–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–∞–Ω—ñ –≤–∏—Ä–æ–±–Ω–∏–∫—ñ–≤/–î–°–¢–£/–ü–£–ï, —Ç–∞–±–ª–∏—Ü—ñ —Å—Ç—Ä—É–º—ñ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø—É –∫–∞–±–µ–ª—é, —É–º–æ–≤–∏ –ø—Ä–æ–∫–ª–∞–¥–∞–Ω–Ω—è —Ç–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ñ –∫–æ—Ä–µ–∫—Ü—ñ—ó –∑–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º.</p>
      </section>`;
    document.getElementById('printArea').innerHTML = html;
    document.getElementById('printArea').scrollIntoView({behavior:'smooth'});
  }

  // ======= CSV =======
  function exportCSV(){
    const headers = ['id','name','phases','kW','PF','eta','material','install','tempC','groupCount','length_m','drop_limit_pct','curve','stdA','I_A','kT','kInst','kGrp','S_mm2','Iz_A','ŒîU_pct','MCB_A','status','url','notes','timestamp'];
    const stamp = nowStamp();
    const csv = [headers.join(','), ...lines.map(r=>{
      const c = r.calc || {};
      const vals = [r.id,r.name,r.phases,r.kW,r.PF,r.eta,r.material,r.install,r.tempC,r.groupCount,r.L,r.dropLim,r.curve,r.stdA,c.I,c.kT,c.kInst,c.kGrp,c.S,c.Iz,c.drop,c.mcb,c.status,r.url||'',r.notes||'',stamp];
      return vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    })].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cable_selection_registry.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  async function importCSV(){
    const f=document.getElementById('file').files[0]; if(!f){ alert('–û–±–µ—Ä—ñ—Ç—å CSV'); return; }
    const txt=await f.text();
    const linesArr=txt.trim().split(/\r?\n/); if(linesArr.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers=linesArr[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const req=['id','name','phases','kW','PF','eta','material','install','tempC','groupCount','length_m','drop_limit_pct','curve','stdA','url','notes'];
    const miss=req.filter(x=>!headers.includes(x)); if(miss.length){ alert('–í—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è: '+miss.join(', ')); return; }
    const out=[];
    for(let i=1;i<linesArr.length;i++){
      const cells=splitCSV(linesArr[i]); if(!cells.length) continue;
      const o={}; headers.forEach((h,j)=> o[h]=(cells[j]||'').replace(/^"|"$/g,''));
      out.push({
        id:o.id,name:o.name,phases:o.phases||'1–§',kW:parseFloat(o.kW||'0'),PF:parseFloat(o.PF||'1'),eta:parseFloat(o.eta||'1'),
        material:o.material||'Cu',install:o.install||'–ü–æ–≤—ñ—Ç—Ä—è/–ª–æ—Ç–æ–∫',tempC:parseFloat(o.tempC||'30'),groupCount:parseInt(o.groupCount||'1',10),
        L:parseFloat(o.length_m||'0'),dropLim:parseFloat(o.drop_limit_pct||'5'),curve:o.curve||'C',stdA:parseInt(o.stdA||'16',10),
        url:o.url||'',notes:o.notes||''
      });
    }
    lines = out.map(r=>{ r.calc=null; return r; }); render();
  }
  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  // ======= –ü–†–ò–ö–õ–ê–î =======
  function seedOne(){
    document.getElementById('id').value='CL-01';
    document.getElementById('name').value='–ñ–∏–≤–ª–µ–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó';
    document.getElementById('phases').value='1–§';
    document.getElementById('kW').value=3.5;
    document.getElementById('pf').value=0.95;
    document.getElementById('eta').value=0.98;
    document.getElementById('material').value='Cu';
    document.getElementById('install').value='–ü–æ–≤—ñ—Ç—Ä—è/–ª–æ—Ç–æ–∫';
    document.getElementById('tempC').value=30;
    document.getElementById('groupCount').value=1;
    document.getElementById('L').value=35;
    document.getElementById('dropLim').value=5;
    document.getElementById('curve').value='C';
    document.getElementById('stdA').value=16;
  }

  function seedDemo(){
    lines = [
      {id:'CL-01',name:'–ñ–∏–≤–ª–µ–Ω–Ω—è –ª–∞–±. 1',phases:'1–§',kW:3.5,PF:0.95,eta:0.98,material:'Cu',install:'–ü–æ–≤—ñ—Ç—Ä—è/–ª–æ—Ç–æ–∫',tempC:30,groupCount:1,L:35,dropLim:5,curve:'C',stdA:16,url:'',notes:'–†–æ–∑–µ—Ç–∫–∏'},
      {id:'CL-02',name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 3–§',phases:'3–§',kW:2.2,PF:0.9,eta:0.9,material:'Cu',install:'–¢—Ä—É–±–∞/–∫–∞–Ω–∞–ª',tempC:40,groupCount:3,L:55,dropLim:5,curve:'D',stdA:20,url:'',notes:'–î–≤–∏–≥—É–Ω'}
    ];
    lines.forEach(r=>calcOne(r.id));
  }

  // –ê–≤—Ç–æ-–¥–µ–º–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
  seedDemo();
</script>
</body>
</html>
