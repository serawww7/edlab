<!-- electric_para11.html
     –ü–∞—Ä–∞ 11 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –ï–õ–ï–ö–¢–†–û–ë–ï–ó–ü–ï–ö–ê
     –ß–µ–∫-–ª–∏—Å—Ç–∏ –û–ü (–æ—Ö–æ—Ä–æ–Ω–∞ –ø—Ä–∞—Ü—ñ), –∂—É—Ä–Ω–∞–ª —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ–≤ (–ø–µ—Ä–≤–∏–Ω–Ω–∏–π/–ø–æ–≤—Ç–æ—Ä–Ω–∏–π/—Ü—ñ–ª—å–æ–≤–∏–π/–ø–æ–∑–∞–ø–ª–∞–Ω–æ–≤–∏–π),
     –Ω–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫ (LOTO-–ø—É–Ω–∫—Ç–∏), –µ—Ç–∏–∫–µ—Ç–∫–∏-–¥–æ–ø—É—Å–∫–∏ 58 –º–º, A4-–∑–≤—ñ—Ç–∏, —ñ–º–ø–æ—Ä—Ç/–µ–∫—Å–ø–æ—Ä—Ç CSV, NFC/QR.
     –ü–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è GitHub Pages —ñ –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –≤ Moodle —á–µ—Ä–µ–∑ <iframe>.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 11 ‚Äî –ï–ª–µ–∫—Ç—Ä–æ–±–µ–∑–ø–µ–∫–∞: —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ, –Ω–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫, LOTO, 58 –º–º, A4</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1120px; margin:0 auto; padding:24px 16px 96px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:#9aa5b1}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1050px){.g3{grid-template-columns:1fr}; .g2{grid-template-columns:1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  .chip{display:inline-block; padding:2px 8px; border:1px solid #223049; border-radius:999px; font-size:12px; margin-right:6px; background:#0d1a2e}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)} .muted{color:#9aa5b1}
  input,select,textarea{padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e5e7eb; width:100%}
  textarea{min-height:88px}

  /* –¢–∞–±–ª–∏—Ü—ñ */
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}

  /* –ö–≤–∏—Ç–∞–Ω—Ü—ñ—ó 58 –º–º */
  .tickets{display:flex; gap:12px; flex-wrap:wrap}
  .ticket{
    width:58mm; background:#fff; color:#000; padding:5mm 4mm; border-radius:6px;
    box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace
  }
  .ticket h4{margin:0 0 4px; font-size:13px; text-align:center}
  .ticket p{margin:1px 0; font-size:12px}
  .ticket .line{border-top:1px dashed #111; margin:5px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}

  /* A4 */
  #printArea{background:#fff; color:#000; border-radius:12px; border:1px solid #e5e7eb; padding:16px}
  .doc{page-break-after:always; padding:12mm; color:#000; font-family:Georgia,"Times New Roman",serif}
  .doc h2{color:#000; font-size:20px; margin:0 0 6px}
  .doc h3{color:#000; font-size:16px; margin:6px 0}
  .doc p{color:#000; margin:4px 0}
  .doc table{width:100%; border-collapse:collapse; border:1px solid #111}
  .doc th,.doc td{border:1px solid #111; padding:6px 8px; font-size:12px; vertical-align:top}
  .doc .sign{margin-top:10mm; display:flex; gap:10mm; flex-wrap:wrap}
  .doc .sign div{flex:1 1 220px}

  /* –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (iframe/Moodle) */
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}

  @media print{
    @page{ size:A4; margin:12mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    #printArea{ border:none; padding:0 }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }
</style>
</head>
<body>
  <div class="wrap">
    <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 11 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
    <h1>‚ö° –ï–ª–µ–∫—Ç—Ä–æ–±–µ–∑–ø–µ–∫–∞: —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ ¬∑ –Ω–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫ ¬∑ LOTO ¬∑ üßæ –µ—Ç–∏–∫–µ—Ç–∫–∏ 58 –º–º ¬∑ A4-–∑–≤—ñ—Ç–∏</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>–í—ñ–¥–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ–≤ –∑ –û–ü, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ä—è–¥—É-–¥–æ–ø—É—Å–∫—É –∑ —á–µ–∫-–ª–∏—Å—Ç–∞–º–∏ <b>LOTO</b>, –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –µ—Ç–∏–∫–µ—Ç–æ–∫-–¥–æ–ø—É—Å–∫—ñ–≤ 58 –º–º —Ç–∞ A4-–∑–≤—ñ—Ç—ñ–≤, –∞ —Ç–∞–∫–æ–∂ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏/—ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ CSV.</p>
      <div class="row">
        <button class="btn" onclick="seedDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥</button>
        <button class="btn" onclick="exportAll()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV (3 —Ñ–∞–π–ª–∏)</button>
        <input id="fileInstr" type="file" accept=".csv,text/csv" class="btn"/>
        <button class="btn" onclick="importInstr()">‚¨ÜÔ∏è –Ü–º–ø–æ—Ä—Ç CSV (—ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ)</button>
      </div>
      <p class="small">CSV (—ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ): <span class="mono">date,type,student,group,topic,result,notes</span></p>
    </div>

    <div class="card">
      <h2>üë• –ñ—É—Ä–Ω–∞–ª —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ–≤</h2>
      <div class="grid g3">
        <div>
          <h3>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</h3>
          <div class="row"><label class="small" style="min-width:140px">–î–∞—Ç–∞</label><input id="iDate" type="date"></div>
          <div class="row"><label class="small" style="min-width:140px">–¢–∏–ø</label>
            <select id="iType"><option>–ü–µ—Ä–≤–∏–Ω–Ω–∏–π</option><option selected>–ü–æ–≤—Ç–æ—Ä–Ω–∏–π</option><option>–¶—ñ–ª—å–æ–≤–∏–π</option><option>–ü–æ–∑–∞–ø–ª–∞–Ω–æ–≤–∏–π</option></select>
          </div>
          <div class="row"><label class="small" style="min-width:140px">–°—Ç—É–¥–µ–Ω—Ç</label><input id="iStudent" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü.–ü."></div>
          <div class="row"><label class="small" style="min-width:140px">–ì—Ä—É–ø–∞</label><input id="iGroup" placeholder="–ï-21"></div>
          <div class="row"><label class="small" style="min-width:140px">–¢–µ–º–∞</label><input id="iTopic" value="–†–æ–±–æ—Ç–∏ –≤ –µ–ª–µ–∫—Ç—Ä–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö –¥–æ 1000–í"></div>
          <div class="row"><label class="small" style="min-width:140px">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
            <select id="iResult"><option class="ok">PASS</option><option class="bad">FAIL</option></select>
          </div>
          <div class="row"><label class="small" style="min-width:140px">–ù–æ—Ç–∞—Ç–∫–∞</label><input id="iNote" placeholder="–ó–∞–≤–¥–∞–Ω–Ω—è –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è (—è–∫—â–æ FAIL)"></div>
          <div class="row"><button class="btn" onclick="addInstr()">‚ûï –î–æ–¥–∞—Ç–∏</button></div>
        </div>

        <div>
          <h3>–§—ñ–ª—å—Ç—Ä/—Å–ª—É–∂–±–æ–≤–µ</h3>
          <div class="row">
            <select id="iFilter">
              <option selected>–í—Å—ñ</option><option>–õ–∏—à–µ PASS</option><option>–õ–∏—à–µ FAIL</option><option>–ü–µ—Ä–≤–∏–Ω–Ω–∏–π</option><option>–ü–æ–≤—Ç–æ—Ä–Ω–∏–π</option><option>–¶—ñ–ª—å–æ–≤–∏–π</option><option>–ü–æ–∑–∞–ø–ª–∞–Ω–æ–≤–∏–π</option>
            </select>
            <button class="btn" onclick="renderInstr()">üîé –§—ñ–ª—å—Ç—Ä</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" onclick="clearInstr()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
            <button class="btn" onclick="buildA4Instr()">üìÑ A4-–≤—ñ–¥–æ–º—ñ—Å—Ç—å</button>
          </div>
          <p class="small">–í—ñ–¥–æ–º—ñ—Å—Ç—å –º—ñ—Å—Ç–∏—Ç—å –ø—ñ–¥—Å—É–º–∫–∏ PASS/FAIL —ñ –º—ñ—Å—Ü–µ –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤.</p>
        </div>

        <div>
          <h3>–ï—Ç–∏–∫–µ—Ç–∫–∞-–¥–æ–ø—É—Å–∫ 58 –º–º</h3>
          <div class="row"><label class="small" style="min-width:140px">–û–±—Ä–∞–Ω–∞ –æ—Å–æ–±–∞</label>
            <select id="iSelect"></select>
          </div>
          <div class="row">
            <button class="btn" onclick="buildTicket()">üßæ –ó—ñ–±—Ä–∞—Ç–∏</button>
            <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
            <button class="btn" onclick="downloadTXT()">üì• TXT</button>
          </div>
        </div>
      </div>

      <table id="iTable" style="margin-top:12px">
        <thead>
          <tr><th>#</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—Ç—É–¥–µ–Ω—Ç</th><th>–ì—Ä—É–ø–∞</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–ù–æ—Ç–∞—Ç–∫–∞</th><th>–î—ñ—ó</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>üìù –ù–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫ + LOTO —á–µ–∫-–ª–∏—Å—Ç</h2>
      <div class="grid g2">
        <div>
          <h3>–ó–∞–≥–∞–ª—å–Ω–µ</h3>
          <div class="row"><label class="small" style="min-width:160px">–ù–æ–º–µ—Ä –Ω–∞—Ä—è–¥—É</label><input id="wId" value="ND-001"></div>
          <div class="row"><label class="small" style="min-width:160px">–ú—ñ—Å—Ü–µ/–æ–±‚Äô—î–∫—Ç</label><input id="wSite" value="–ú–∞–π—Å—Ç–µ—Ä–Ω—è ¬∑ —â–∏—Ç –©–û-1"></div>
          <div class="row"><label class="small" style="min-width:160px">–ö–µ—Ä—ñ–≤–Ω–∏–∫ —Ä–æ–±—ñ—Ç</label><input id="wLead" value="–í–∏–∫–ª–∞–¥–∞—á / –ú–∞–π—Å—Ç–µ—Ä"></div>
          <div class="row"><label class="small" style="min-width:160px">–ë—Ä–∏–≥–∞–¥–∞</label><input id="wCrew" value="2 –æ—Å–æ–±–∏ (—Å—Ç—É–¥–µ–Ω—Ç1, —Å—Ç—É–¥–µ–Ω—Ç2)"></div>
          <div class="row"><label class="small" style="min-width:160px">–û–ø–∏—Å —Ä–æ–±—ñ—Ç</label><textarea id="wDesc">–ó–∞–º—ñ–Ω–∞ MCB —É –ª—ñ–Ω—ñ—ó –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è.</textarea></div>
        </div>
        <div>
          <h3>LOTO / –ë–µ–∑–ø–µ—á–Ω–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
          <div class="row"><label class="small" style="min-width:160px">–í–∏–º–∫–Ω–µ–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞</label><select id="wIso"><option selected>–í–∏–∫–æ–Ω–∞–Ω–æ</option><option>–ù/–ó</option></select></div>
          <div class="row"><label class="small" style="min-width:160px">–ó–∞–º–æ–∫ (Lock)</label><select id="wLock"><option selected>–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</option><option>–ù/–ó</option></select></div>
          <div class="row"><label class="small" style="min-width:160px">–ë–∏—Ä–∫–∞ (Tag)</label><select id="wTag"><option selected>–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</option><option>–ù/–ó</option></select></div>
          <div class="row"><label class="small" style="min-width:160px">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –Ω–∞–ø—Ä—É–≥–∏</label><select id="wTest"><option selected>–í–∏–∫–æ–Ω–∞–Ω–æ</option><option>–ù/–ó</option></select></div>
          <div class="row"><label class="small" style="min-width:160px">–ó–Ü–ó (PPE) –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ</label><select id="wPPE"><option selected>–¢–∞–∫</option><option>–ù—ñ</option></select></div>
          <div class="row"><button class="btn" onclick="buildA4Permit()">üìÑ A4 –Ω–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫</button></div>
          <p class="small">–ü—ñ—Å–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è ‚Äî <b>–∑–Ω—è—Ç–∏ lock/tag</b>, –∑–∞–ø–∏—Å–∞—Ç–∏ —á–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±—ñ—Ç.</p>
        </div>
      </div>
    </div>

    <div class="card printable">
      <h2>üßæ –ï—Ç–∏–∫–µ—Ç–∫–∞ 58 –º–º ¬´–î–æ–ø—É—Å–∫/–Ü–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂¬ª</h2>
      <div class="tickets" id="tickets">
        <div class="ticket" id="ticket" aria-live="polite">
          <h4>–î–û–ü–£–°–ö ¬∑ –ï–õ–ï–ö–¢–†–û–ë–ï–ó–ü–ï–ö–ê</h4>
          <p><b id="t-name">–°—Ç—É–¥–µ–Ω—Ç ‚Äî</b></p>
          <div class="line"></div>
          <p>–¢–∏–ø: <span id="t-type">‚Äî</span> ¬∑ –†–µ–∑—É–ª—å—Ç–∞—Ç: <span id="t-res">‚Äî</span></p>
          <p>–ì—Ä—É–ø–∞: <span id="t-grp">‚Äî</span> ¬∑ –î–∞—Ç–∞: <span id="t-date">‚Äî</span></p>
          <p>–¢–µ–º–∞: <span id="t-topic">‚Äî</span></p>
          <div class="line"></div>
          <p class="qr"><small id="t-url">NFC/QR: ‚Äî</small></p>
          <p><small id="t-ref">Ref: PERM-XXXX</small></p>
        </div>
      </div>
      <div class="row">
        <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫ 58 –º–º</button>
        <button class="btn" onclick="downloadTXT()">üì• TXT</button>
      </div>
    </div>

    <div class="card printable">
      <h2>üìÑ A4-–¥–æ–∫—É–º–µ–Ω—Ç–∏</h2>
      <div class="row">
        <button class="btn" onclick="buildA4Instr()">üß© –í—ñ–¥–æ–º—ñ—Å—Ç—å —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—É (A4)</button>
        <button class="btn" onclick="buildA4Permit()">üß© –ù–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫ (A4)</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫/PDF</button>
      </div>
      <div id="printArea"></div>
    </div>
  </div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–æ —É Moodle
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // ======= –°–¢–ê–ù =======
  let instr = [];   // —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ
  const iBody = document.querySelector('#iTable tbody');
  const iSelect = document.getElementById('iSelect');

  // ======= –£–¢–ò–õ–Ü–¢–ò =======
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&gt;','>':'&lt;','"':'&quot;',"'":'&#39;' }[m])); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function nowStamp(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // ======= –Ü–ù–°–¢–†–£–ö–¢–ê–ñ–Ü =======
  function addInstr(){
    const d = document.getElementById('iDate').value || todayISO();
    const t = document.getElementById('iType').value;
    const s = (document.getElementById('iStudent').value||'').trim();
    const g = (document.getElementById('iGroup').value||'').trim();
    const tp = (document.getElementById('iTopic').value||'').trim();
    const r = document.getElementById('iResult').value;
    const note = (document.getElementById('iNote').value||'').trim();
    if(!s){ alert('–í–∫–∞–∂–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞'); return; }
    const row = { id:'I'+Math.random().toString(36).slice(2,7).toUpperCase(), date:d, type:t, student:s, group:g, topic:tp, result:r, notes:note };
    instr.push(row); renderInstr(); rebuildSelect();
  }

  function renderInstr(){
    const flt = document.getElementById('iFilter').value;
    iBody.innerHTML='';
    let view = instr.slice();
    if(flt==='–õ–∏—à–µ PASS') view=view.filter(x=>x.result==='PASS');
    if(flt==='–õ–∏—à–µ FAIL') view=view.filter(x=>x.result==='FAIL');
    if(['–ü–µ—Ä–≤–∏–Ω–Ω–∏–π','–ü–æ–≤—Ç–æ—Ä–Ω–∏–π','–¶—ñ–ª—å–æ–≤–∏–π','–ü–æ–∑–∞–ø–ª–∞–Ω–æ–≤–∏–π'].includes(flt)) view=view.filter(x=>x.type===flt);
    view.forEach((r,i)=>{
      const tr=document.createElement('tr');
      const badge = `<span class="mono" style="padding:2px 8px;border:1px solid #223049;border-radius:999px;background:#0d1a2e;color:${r.result==='PASS'?'#22c55e':'#ef4444'}">${r.result}</span>`;
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="editable" data-k="date" data-id="${r.id}">${esc(r.date)}</td>
        <td class="editable" data-k="type" data-id="${r.id}">${esc(r.type)}</td>
        <td class="editable" data-k="student" data-id="${r.id}">${esc(r.student)}</td>
        <td class="editable" data-k="group" data-id="${r.id}">${esc(r.group)}</td>
        <td class="editable" data-k="topic" data-id="${r.id}">${esc(r.topic)}</td>
        <td>${badge}</td>
        <td class="editable" data-k="notes" data-id="${r.id}">${esc(r.notes||'')}</td>
        <td class="mono"><button class="btn" data-act="label" data-id="${r.id}">–ï—Ç–∏–∫–µ—Ç–∫–∞</button> <button class="btn" data-act="del" data-id="${r.id}">‚úñ</button></td>`;
      iBody.appendChild(tr);
    });
  }

  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  iBody.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('.editable'); if(!td) return;
    const id = td.getAttribute('data-id'); const key = td.getAttribute('data-k');
    const idx = instr.findIndex(x=>x.id===id); const r=instr[idx];
    const input = document.createElement('input'); input.value = r[key] || ''; input.style.width='100%'; input.style.padding='6px 8px';
    input.addEventListener('blur', ()=>{ r[key] = input.value.trim(); renderInstr(); rebuildSelect(); });
    td.innerHTML=''; td.appendChild(input); input.focus(); input.select();
  });

  iBody.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
    if(act==='del'){ instr = instr.filter(x=>x.id!==id); renderInstr(); rebuildSelect(); return; }
    if(act==='label'){ iSelect.value = id; buildTicket(); document.getElementById('ticket').scrollIntoView({behavior:'smooth'}); }
  });

  function clearInstr(){ if(confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –∂—É—Ä–Ω–∞–ª —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—ñ–≤?')){ instr=[]; renderInstr(); rebuildSelect(); } }

  function rebuildSelect(){
    iSelect.innerHTML='';
    instr.forEach(x=>{
      const op=document.createElement('option'); op.value=x.id; op.textContent=`${x.student} ¬∑ ${x.type} (${x.result})`;
      iSelect.appendChild(op);
    });
  }

  // ======= –ï–¢–ò–ö–ï–¢–ö–ê 58 –º–º =======
  function buildTicket(){
    const id = iSelect.value || (instr[0]?.id || '');
    const r = instr.find(x=>x.id===id);
    const t = (id)=>document.getElementById(id);
    if(!r){
      t('t-name').textContent='–°—Ç—É–¥–µ–Ω—Ç ‚Äî'; t('t-type').textContent='‚Äî'; t('t-res').textContent='‚Äî';
      t('t-grp').textContent='‚Äî'; t('t-date').textContent='‚Äî'; t('t-topic').textContent='‚Äî';
      t('t-url').textContent='NFC/QR: ‚Äî'; t('t-ref').textContent='Ref: PERM-XXXX'; return;
    }
    t('t-name').textContent = r.student;
    t('t-type').textContent = r.type;
    t('t-res').textContent = r.result;
    t('t-grp').textContent = r.group || '‚Äî';
    t('t-date').textContent = r.date;
    t('t-topic').textContent = r.topic;
    const url = `https://serawww7.github.io/edlab/electric_para11.html#${encodeURIComponent(r.student)}`
    t('t-url').textContent = 'NFC/QR: ' + url;
    t('t-ref').textContent = 'Ref: PERM-' + Math.random().toString(36).slice(2,7).toUpperCase();
  }

  function downloadTXT(){
    const lines=[
      'SAFETY PERMIT 58mm','-------------------',
      '–ü–Ü–ë: ' + document.getElementById('t-name').textContent,
      '–¢–∏–ø/–†–µ–∑—É–ª—å—Ç–∞—Ç: ' + document.getElementById('t-type').textContent + ' / ' + document.getElementById('t-res').textContent,
      '–ì—Ä—É–ø–∞/–î–∞—Ç–∞: ' + document.getElementById('t-grp').textContent + ' / ' + document.getElementById('t-date').textContent,
      '–¢–µ–º–∞: ' + document.getElementById('t-topic').textContent,
      document.getElementById('t-url').textContent,
      document.getElementById('t-ref').textContent
    ];
    const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='safety_permit_58mm.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  // ======= A4: –í—ñ–¥–æ–º—ñ—Å—Ç—å —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—É =======
  function buildA4Instr(){
    if(!instr.length){ alert('–î–æ–¥–∞–π —Ö–æ—á–∞ –± –æ–¥–∏–Ω —ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂'); return; }
    const pass = instr.filter(x=>x.result==='PASS').length;
    const fail = instr.filter(x=>x.result==='FAIL').length;
    const rows = instr.map((x,i)=>`
      <tr>
        <td>${i+1}</td><td>${esc(x.date)}</td><td>${esc(x.type)}</td><td>${esc(x.student)}</td>
        <td>${esc(x.group)}</td><td>${esc(x.topic)}</td><td>${esc(x.result)}</td><td>${esc(x.notes||'')}</td>
        <td style="height:24px"></td>
      </tr>`).join('');
    const html = `
      <section class="doc">
        <h2>–í–Ü–î–û–ú–Ü–°–¢–¨ –Ü–ù–°–¢–†–£–ö–¢–ê–ñ–£ –ó –û–•–û–†–û–ù–ò –ü–†–ê–¶–Ü (–ï–õ–ï–ö–¢–†–û–ë–ï–ó–ü–ï–ö–ê)</h2>
        <p>–î–∞—Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è: ${nowStamp()}</p>
        <table>
          <thead><tr><th>#</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ü–Ü–ë</th><th>–ì—Ä—É–ø–∞</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–ù–æ—Ç–∞—Ç–∫–∞</th><th>–ü—ñ–¥–ø–∏—Å</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <h3>–ü—ñ–¥—Å—É–º–æ–∫</h3>
        <p>PASS: ${pass} ¬∑ FAIL: ${fail}</p>
        <div class="sign"><div>–í–∏–∫–ª–∞–¥–∞—á: ____________________</div><div>–ú–∞–π—Å—Ç–µ—Ä: ____________________</div></div>
      </section>`;
    document.getElementById('printArea').innerHTML = html;
    document.getElementById('printArea').scrollIntoView({behavior:'smooth'});
  }

  // ======= A4: –ù–∞—Ä—è–¥-–¥–æ–ø—É—Å–∫ =======
  function buildA4Permit(){
    const w = {
      id: document.getElementById('wId').value.trim(),
      site: document.getElementById('wSite').value.trim(),
      lead: document.getElementById('wLead').value.trim(),
      crew: document.getElementById('wCrew').value.trim(),
      desc: document.getElementById('wDesc').value.trim(),
      iso: document.getElementById('wIso').value,
      lock: document.getElementById('wLock').value,
      tag: document.getElementById('wTag').value,
      test: document.getElementById('wTest').value,
      ppe: document.getElementById('wPPE').value
    };
    const rows = [
      ['–í–∏–º–∫–Ω–µ–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞', w.iso],
      ['LOCK –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', w.lock],
      ['TAG –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', w.tag],
      ['–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –Ω–∞–ø—Ä—É–≥–∏', w.test],
      ['–ó–Ü–ó –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ', w.ppe]
    ].map((r,i)=>`<tr><td>${i+1}</td><td>${esc(r[0])}</td><td>${esc(r[1])}</td></tr>`).join('');
    const html = `
      <section class="doc">
        <h2>–ù–ê–†–Ø–î-–î–û–ü–£–°–ö ‚Ññ ${esc(w.id)}</h2>
        <p>–û–±‚Äô—î–∫—Ç: ${esc(w.site)} ¬∑ –î–∞—Ç–∞: ${nowStamp()}</p>
        <table>
          <tbody>
            <tr><td>–ö–µ—Ä—ñ–≤–Ω–∏–∫ —Ä–æ–±—ñ—Ç</td><td>${esc(w.lead)}</td></tr>
            <tr><td>–°–∫–ª–∞–¥ –±—Ä–∏–≥–∞–¥–∏</td><td>${esc(w.crew)}</td></tr>
            <tr><td>–û–ø–∏—Å —Ä–æ–±—ñ—Ç</td><td>${esc(w.desc)}</td></tr>
          </tbody>
        </table>
        <h3>–ß–µ–∫-–ª–∏—Å—Ç LOTO / –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
        <table><thead><tr><th>#</th><th>–ü—É–Ω–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>${rows}</tbody></table>
        <div class="sign">
          <div>–í–∏–¥–∞–≤ –Ω–∞—Ä—è–¥: ____________________</div>
          <div>–î–æ–ø—É—â–µ–Ω–æ –¥–æ —Ä–æ–±—ñ—Ç: ____________________</div>
          <div>–†–æ–±–æ—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (—á–∞—Å): _____________ –ü—ñ–¥–ø–∏—Å: _____________</div>
        </div>
        <p class="small">–ü—Ä–∏–º—ñ—Ç–∫–∞: –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ —É –º–µ–∂–∞—Ö –Ω–∞–≤—á–∞–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏; –¥–ª—è —Ä–µ–∞–ª—å–Ω–∏—Ö —Ä–æ–±—ñ—Ç –∫–æ—Ä–∏—Å—Ç—É–π—Ç–µ—Å—å —á–∏–Ω–Ω–∏–º–∏ —Ñ–æ—Ä–º–∞–º–∏ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞.</p>
      </section>`;
    document.getElementById('printArea').innerHTML = html;
    document.getElementById('printArea').scrollIntoView({behavior:'smooth'});
  }

  // ======= –ï–ö–°–ü–û–†–¢/–Ü–ú–ü–û–†–¢ =======
  function exportAll(){
    exportCSV(instr, ['date','type','student','group','topic','result','notes'], 'safety_instructions.csv');
    // –î–æ–ø–æ–º—ñ–∂–Ω–æ ‚Äî –≤–∏—Ç—è–≥ –¥–ª—è –¥–æ–ø—É—Å–∫—ñ–≤ (—É—Å–ø—ñ—à–Ω—ñ)
    const passes = instr.filter(x=>x.result==='PASS');
    exportCSV(passes, ['date','student','group','type','topic'], 'safety_passes.csv');
    // –ü–æ—Ä–æ–∂–Ω—ñ–π —à–∞–±–ª–æ–Ω –¥–ª—è LOTO (—â–æ–± —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑–∞–ø–æ–≤–Ω—é–≤–∞–ª–∏ —Ç–µ–∫—Å—Ç–æ–º)
    const templ = [{item:'–í–∏–º–∫–Ω–µ–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞'},{item:'–ó–∞–º–æ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'},{item:'–ë–∏—Ä–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'},{item:'–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –Ω–∞–ø—Ä—É–≥–∏'},{item:'–ó–Ü–ó –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ'}];
    exportCSV(templ, ['item'], 'loto_template.csv');
  }

  function exportCSV(arr, headers, name){
    const csv = [headers.join(','), ...arr.map(o=>headers.map(h=>`"${String((o[h]??'')).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }

  async function importInstr(){
    const f = document.getElementById('fileInstr').files[0]; if(!f){ alert('–û–±–µ—Ä—ñ—Ç—å CSV'); return; }
    const txt = await f.text();
    const lines = txt.trim().split(/\r?\n/); if(lines.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers = lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const req = ['date','type','student','group','topic','result','notes'];
    const miss = req.filter(x=>!headers.includes(x)); if(miss.length){ alert('–í—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è: '+miss.join(', ')); return; }
    const out=[];
    for(let i=1;i<lines.length;i++){
      const cells = splitCSV(lines[i]); if(!cells.length) continue;
      const o={}; headers.forEach((h,j)=> o[h]=(cells[j]||'').replace(/^"|"$/g,''));
      out.push({ id:'I'+Math.random().toString(36).slice(2,7).toUpperCase(), ...o });
    }
    instr = out; renderInstr(); rebuildSelect();
  }

  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  // ======= –î–ï–ú–û =======
  function seedDemo(){
    instr = [
      {id:'I001', date:todayISO(), type:'–ü–æ–≤—Ç–æ—Ä–Ω–∏–π', student:'–Ü–≤–∞–Ω–µ–Ω–∫–æ –Ü.–û.', group:'–ï-21', topic:'–†–æ–±–æ—Ç–∏ –≤ –ï–£ –¥–æ 1000–í', result:'PASS', notes:''},
      {id:'I002', date:todayISO(), type:'–¶—ñ–ª—å–æ–≤–∏–π', student:'–ü–µ—Ç—Ä–µ–Ω–∫–æ –ü.–ü.', group:'–ï-21', topic:'–†–æ–±–æ—Ç–∏ –ø—ñ–¥ –Ω–∞–ø—Ä—É–≥–æ—é –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ', result:'PASS', notes:'–ù–∞–≥–∞–¥–∞–Ω–æ –ø—Ä–æ –ó–Ü–ó'},
      {id:'I003', date:todayISO(), type:'–ü–µ—Ä–≤–∏–Ω–Ω–∏–π', student:'–°–∏–¥–æ—Ä–µ–Ω–∫–æ –°.–°.', group:'–ï-22', topic:'LOTO: lock/tag/test', result:'FAIL', notes:'–ü–æ–≤—Ç–æ—Ä–Ω–µ –≤–∏–≤—á–µ–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª—É LOTO'}
    ];
    renderInstr(); rebuildSelect();
    buildTicket();
    buildA4Instr();
  }

  // –ê–≤—Ç–æ-–¥–µ–º–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
  seedDemo();
</script>
</body>
</html>
