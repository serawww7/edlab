<!-- electric_para18.html
     –ü–∞—Ä–∞ 18 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∏, –∞—É–¥–∏—Ç–æ—Ä–Ω–æ): –ë–ê–õ–ê–ù–°–£–í–ê–ù–ù–Ø –§–ê–ó –¢–ê –ü–õ–ê–ù-–©–ò–¢–û–ö
     –ú–µ—Ç–∞: —Å–∫–ª–∞—Å—Ç–∏ —Ä–µ—î—Å—Ç—Ä –∫—ñ–ª —â–∏—Ç–∫–∞, –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—Ç—Ä—É–º–∏ –ø–æ —Ñ–∞–∑–∞—Ö (A/B/C), –æ—Ü—ñ–Ω–∏—Ç–∏ –¥–∏—Å–±–∞–ª–∞–Ω—Å —ñ —Å—Ç—Ä—É–º N,
     –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è, –Ω–∞–¥—Ä—É–∫—É–≤–∞—Ç–∏ –Ω–∞–∫–ª–µ–π–∫–∏ 58 –º–º —Ç–∞ A4-¬´–ø–ª–∞–Ω-—â–∏—Ç–æ–∫¬ª,
     –µ–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç CSV. –ü—Ä–∞—Ü—é—î –æ—Ñ–ª–∞–π–Ω, –ø—ñ–¥ GitHub Pages —ñ Moodle (iframe).
--><!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 18 ‚Äî –ë–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è —Ñ–∞–∑ —ñ –ø–ª–∞–Ω-—â–∏—Ç–æ–∫</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --bg2:#111827; --card:#0f172a; --text:#e2e8f0; --muted:#9aa5b1; --line:#1f2937;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg)); color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55}
  .wrap{max-width:1120px; margin:0 auto; padding:24px 16px 96px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:#9aa5b1}
  h1{font-size:32px; margin:6px 0 12px; line-height:1.15; background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:22px 0 12px}
  h3{font-size:18px; margin:12px 0 8px; color:#cbd5e1}
  p{margin:8px 0}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1050px){.g3{grid-template-columns:1fr}; .g2{grid-template-columns:1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .small{font-size:12px; color:#93a3b5}
  input,select,textarea{padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e5e7eb; width:100%}
  textarea{min-height:72px}
  table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid #223049; border-radius:12px; overflow:hidden}
  thead th{background:#0c1629; color:#a5b4fc; text-align:left; padding:10px 12px; font-size:14px}
  tbody td{padding:8px 10px; border-top:1px solid #1f2937; font-size:14px; vertical-align:top}
  tbody tr:nth-child(even){background:#0b1324}
  .chip{display:inline-block; padding:2px 8px; border:1px solid #223049; border-radius:999px; font-size:12px; background:#0d1a2e; color:#9aa5b1}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .tickets{display:flex; gap:12px; flex-wrap:wrap}
  .ticket{width:58mm; background:#fff; color:#000; padding:5mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 4px; font-size:13px; text-align:center}
  .ticket p{margin:1px 0; font-size:12px}
  .ticket .line{border-top:1px dashed #111; margin:5px 0}
  .ticket small{font-size:10px}
  .ticket .qr{font-size:10px; word-break:break-all}
  #printArea{background:#fff; color:#000; border-radius:12px; border:1px solid #e5e7eb; padding:16px}
  .doc{page-break-after:always; padding:12mm; color:#000; font-family:Georgia,"Times New Roman",serif}
  .doc h2{color:#000; font-size:20px; margin:0 0 6px}
  .doc h3{color:#000; font-size:16px; margin:6px 0}
  .doc p{color:#000; margin:4px 0}
  .doc table{width:100%; border-collapse:collapse; border:1px solid #111}
  .doc th,.doc td{border:1px solid #111; padding:6px 8px; font-size:12px; vertical-align:top}
  .doc .sign{margin-top:10mm; display:flex; gap:10mm; flex-wrap:wrap}
  .doc .sign div{flex:1 1 220px}
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}
  @media print{
    @page{ size:A4; margin:12mm }
    body{ background:#fff; color:#000 }
    .no-print, .card:not(.printable){ display:none !important }
    #printArea{ border:none; padding:0 }
    .ticket{ box-shadow:none; width:auto; padding:0 }
  }
  .banner{display:flex; gap:8px; flex-wrap:wrap}
  .banner .b{padding:8px 10px; border:1px solid #223049; border-radius:10px; background:#0d1a2e}
</style>
<meta name="description" content="–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä –∫—ñ–ª —â–∏—Ç–∫–∞ (1–§/3–§), –æ–±—á–∏—Å–ª–∏—Ç–∏ —Å—Ç—Ä—É–º–∏ –ø–æ —Ñ–∞–∑–∞—Ö, –æ—Ü—ñ–Ω–∏—Ç–∏ % –¥–∏—Å–±–∞–ª–∞–Ω—Å—É —Ç–∞ IN (–Ω–µ–π—Ç—Ä–∞–ª—å), –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ –¥–ª—è –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è, —Å—Ñ"><link rel="canonical" href="https://edlab.pp.ua/elect_II_kyrs/electric_para18.html"><meta property="og:type" content="article"><meta property="og:title" content="‚öñÔ∏è –ë–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è —Ñ–∞–∑: A/B/C ‚Üí %–¥–∏—Å–±–∞–ª–∞–Ω—Å—É ‚Üí IN ‚Üí –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ ‚Üí üßæ 58 –º–º ‚Üí üìÑ –ø–ª–∞–Ω-—â–∏—Ç–æ–∫"><meta property="og:description" content="–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä –∫—ñ–ª —â–∏—Ç–∫–∞ (1–§/3–§), –æ–±—á–∏—Å–ª–∏—Ç–∏ —Å—Ç—Ä—É–º–∏ –ø–æ —Ñ–∞–∑–∞—Ö, –æ—Ü—ñ–Ω–∏—Ç–∏ % –¥–∏—Å–±–∞–ª–∞–Ω—Å—É —Ç–∞ IN (–Ω–µ–π—Ç—Ä–∞–ª—å), –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ –¥–ª—è –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è, —Å—Ñ"><meta property="og:url" content="https://edlab.pp.ua/elect_II_kyrs/electric_para18.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"‚öñÔ∏è –ë–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è —Ñ–∞–∑: A/B/C ‚Üí %–¥–∏—Å–±–∞–ª–∞–Ω—Å—É ‚Üí IN ‚Üí –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ ‚Üí üßæ 58 –º–º ‚Üí üìÑ –ø–ª–∞–Ω-—â–∏—Ç–æ–∫","description":"–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä –∫—ñ–ª —â–∏—Ç–∫–∞ (1–§/3–§), –æ–±—á–∏—Å–ª–∏—Ç–∏ —Å—Ç—Ä—É–º–∏ –ø–æ —Ñ–∞–∑–∞—Ö, –æ—Ü—ñ–Ω–∏—Ç–∏ % –¥–∏—Å–±–∞–ª–∞–Ω—Å—É —Ç–∞ IN (–Ω–µ–π—Ç—Ä–∞–ª—å), –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ –¥–ª—è –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è, —Å—Ñ","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/elect_II_kyrs/electric_para18.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <span class="badge">–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ ¬∑ –ü–∞—Ä–∞ 18 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ</span>
  <h1>‚öñÔ∏è –ë–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è —Ñ–∞–∑: A/B/C ‚Üí %–¥–∏—Å–±–∞–ª–∞–Ω—Å—É ‚Üí I<sub>N</sub> ‚Üí –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ ‚Üí üßæ 58 –º–º ‚Üí üìÑ –ø–ª–∞–Ω-—â–∏—Ç–æ–∫</h1>

  <div class="card">
    <h2>üéØ –ú–µ—Ç–∞</h2>
    <p>–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä –∫—ñ–ª —â–∏—Ç–∫–∞ (1–§/3–§), –æ–±—á–∏—Å–ª–∏—Ç–∏ —Å—Ç—Ä—É–º–∏ –ø–æ —Ñ–∞–∑–∞—Ö, –æ—Ü—ñ–Ω–∏—Ç–∏ <b>% –¥–∏—Å–±–∞–ª–∞–Ω—Å—É</b> —Ç–∞ <b>I<sub>N</sub></b> (–Ω–µ–π—Ç—Ä–∞–ª—å),
      –æ—Ç—Ä–∏–º–∞—Ç–∏ <b>–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫</b> –¥–ª—è –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è, —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–∞–∫–ª–µ–π–∫–∏ 58 –º–º —ñ A4 ¬´–ø–ª–∞–Ω-—â–∏—Ç–æ–∫¬ª, –æ–±–º—ñ–Ω—é–≤–∞—Ç–∏—Å—å CSV.</p>
    <div class="row">
      <button class="btn" onclick="seedDemo()">üîÑ –ü—Ä–∏–∫–ª–∞–¥</button>
      <button class="btn" onclick="recalc()">üßÆ –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
      <button class="btn" onclick="exportCSV()">üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
      <input id="file" class="btn" type="file" accept=".csv,text/csv">
      <button class="btn" onclick="importCSV()">‚¨ÜÔ∏è –Ü–º–ø–æ—Ä—Ç CSV</button>
    </div>
    <p class="small">CSV: <span class="mono">way,id,name,phase,poles,mode,p_or_I,value,PF,eta,duty_pct,diversity_pct,curve,In_A,location,notes,url,nonlinear</span> (mode=p –∞–±–æ i; value=–∫–í—Ç –∞–±–æ –ê; poles=1P/3P; phase=A/B/C/3F; nonlinear=–¢–∞–∫/–ù—ñ).</p>
  </div>

  <div class="card">
    <h2>‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ–ª–æ</h2>
    <div class="grid g3">
      <div>
        <h3>–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è</h3>
        <div class="row"><label class="small" style="min-width:140px">‚Ññ –∫–æ–º—ñ—Ä–∫–∏ (way)</label><input id="way" type="number" value="1"></div>
        <div class="row"><label class="small" style="min-width:140px">ID</label><input id="id" value="C-01"></div>
        <div class="row"><label class="small" style="min-width:140px">–ù–∞–∑–≤–∞</label><input id="name" value="–û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è –∞—É–¥.101"></div>
        <div class="row"><label class="small" style="min-width:140px">–õ–æ–∫–∞—Ü—ñ—è</label><input id="location" value="–ö–æ—Ä–ø—É—Å –ê ¬∑ 1 –ø–æ–≤."></div>
      </div>
      <div>
        <h3>–ï–ª–µ–∫—Ç—Ä–∏–∫–∞</h3>
        <div class="row"><label class="small" style="min-width:140px">–§–∞–∑–∞</label><select id="phase"><option selected="">A</option><option>B</option><option>C</option><option>3F</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">–ü–æ–ª—é—Å—ñ–≤</label><select id="poles"><option selected="">1P</option><option>3P</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">–†–µ–∂–∏–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label><select id="mode"><option selected="">p (–∫–í—Ç)</option><option>i (–ê)</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">–ó–Ω–∞—á–µ–Ω–Ω—è</label><input id="value" type="number" step="0.1" value="0.6"></div>
        <div class="row"><label class="small" style="min-width:140px">PF</label><input id="pf" type="number" step="0.01" value="0.95"></div>
        <div class="row"><label class="small" style="min-width:140px">Œ∑</label><input id="eta" type="number" step="0.01" value="0.98"></div>
      </div>
      <div>
        <h3>–ó–∞—Ö–∏—Å—Ç/—Ä–µ–∂–∏–º</h3>
        <div class="row"><label class="small" style="min-width:140px">Duty, %</label><input id="duty" type="number" value="80"></div>
        <div class="row"><label class="small" style="min-width:140px">–î–∏–≤–µ—Ä—Å–∏—Ñ., %</label><input id="divers" type="number" value="100"></div>
        <div class="row"><label class="small" style="min-width:140px">–ö—Ä–∏–≤–∞</label><select id="curve"><option>B</option><option selected="">C</option><option>D</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">–ù–æ–º—ñ–Ω–∞–ª MCB, –ê</label><select id="InA"><option>6</option><option selected="">10</option><option>16</option><option>20</option><option>25</option><option>32</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">–ù–µ–ª—ñ–Ω—ñ–π–Ω–µ?</label><select id="nonlin"><option>–ù—ñ</option><option>–¢–∞–∫</option></select></div>
        <div class="row"><label class="small" style="min-width:140px">URL</label><input id="url" placeholder="https://serawww7.github.io/edlab/..."></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="addOrUpdate()">üíæ –î–æ–¥–∞—Ç–∏/–û–Ω–æ–≤–∏—Ç–∏</button>
      <button class="btn" onclick="seedOne()">üîÑ –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Å—É</button>
    </div>
    <p class="small">–†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏: 1–§ I‚âàP/(U¬∑PF¬∑Œ∑) –ø—Ä–∏ U=230–í; 3–§ I—Ñ‚âàP/(‚àö3¬∑U<sub>LL</sub>¬∑PF¬∑Œ∑) –ø—Ä–∏ U<sub>LL</sub>=400–í; –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è duty¬∑diversity.</p>
  </div>

  <div class="card printable">
    <h2>üìã –†–µ—î—Å—Ç—Ä –∫—ñ–ª —â–∏—Ç–∫–∞</h2>
    <div class="banner" id="banner"></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th><th>way</th><th>ID</th><th>–ù–∞–∑–≤–∞</th><th>–§–∞–∑–∞</th><th>–ü–æ–ª—é—Å—ñ–≤</th>
          <th>–†–µ–∂–∏–º</th><th>–ó–Ω–∞—á–µ–Ω–Ω—è</th><th>I, –ê</th><th>–ö—Ä–∏–≤–∞/MCB</th><th>–ù–µ–ª—ñ–Ω.</th><th>URL</th><th>–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="small">–õ—ñ–º—ñ—Ç–∏: <span class="chip">PASS &lt; 10%</span> ¬∑ <span class="chip">WARN 10‚Äì20%</span> ¬∑ <span class="chip">FAIL &gt; 20%</span> –¥–∏—Å–±–∞–ª–∞–Ω—Å—É —Ñ–∞–∑.</p>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="suggest()">üß≠ –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏</button>
      <button class="btn" onclick="buildTickets()">üßæ –ù–∞–∫–ª–µ–π–∫–∏ 58 –º–º</button>
      <button class="btn" onclick="buildReport()">üìÑ A4 –ü–ª–∞–Ω-—â–∏—Ç–æ–∫</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫</button>
    </div>
  </div>

  <div class="card printable">
    <h2>üßæ –ù–∞–∫–ª–µ–π–∫–∏ 58 –º–º ¬´–ö–æ–ª–æ —â–∏—Ç–∫–∞¬ª</h2>
    <div id="tickets" class="tickets"></div>
  </div>

  <div class="card printable">
    <h2>üìÑ A4 ¬´–ü–ª–∞–Ω-—â–∏—Ç–æ–∫¬ª</h2>
    <div id="printArea"></div>
  </div>
</div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  // ===== –°–¢–ê–ù =====
  let rows = []; // –∫–æ–ª–∞ —â–∏—Ç–∫–∞
  const tbody = document.querySelector('#tbl tbody');
  const ticketsBox = document.getElementById('tickets');
  const banner = document.getElementById('banner');

  // ===== –£–¢–ò–õ–Ü–¢–ò =====
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&lt;','"':'&quot;',"'":'&#39;' }[m])); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function round2(x){ return Math.round(x*100)/100; }
  function nowStamp(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç—Ä—É–º—É –∫–æ–ª–∞ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º duty —ñ diversity)
  function currentOf(r){
    const duty = (parseFloat(r.duty)||100)/100;
    const divs = (parseFloat(r.diversity)||100)/100;
    if(r.mode==='i'){ return (parseFloat(r.value)||0)*duty*divs; }
    // —Ä–µ–∂–∏–º –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ
    const PkW = parseFloat(r.value)||0;
    if(r.phase==='3F' || r.poles==='3P'){
      const I = (PkW*1000)/(Math.sqrt(3)*400*(parseFloat(r.PF)||1)*(parseFloat(r.eta)||1));
      return I*duty*divs;
    }else{
      const I = (PkW*1000)/(230*(parseFloat(r.PF)||1)*(parseFloat(r.eta)||1));
      return I*duty*divs;
    }
  }

  // –°—É–º—É–≤–∞–Ω–Ω—è –ø–æ —Ñ–∞–∑–∞—Ö —ñ –Ω–µ–π—Ç—Ä–∞–ª—å
  function totals(){
    let A=0,B=0,C=0;
    let nonlinA=0,nonlinB=0,nonlinC=0;
    rows.forEach(r=>{
      const I = currentOf(r);
      if(r.phase==='3F' || r.poles==='3P'){
        // —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ –ø–æ —Ç—Ä—å–æ—Ö —Ñ–∞–∑–∞—Ö
        A+=I; B+=I; C+=I;
        if(r.nonlinear==='–¢–∞–∫'){ nonlinA+=I; nonlinB+=I; nonlinC+=I; }
      }else if(r.phase==='A'){
        A+=I; if(r.nonlinear==='–¢–∞–∫') nonlinA+=I;
      }else if(r.phase==='B'){
        B+=I; if(r.nonlinear==='–¢–∞–∫') nonlinB+=I;
      }else if(r.phase==='C'){
        C+=I; if(r.nonlinear==='–¢–∞–∫') nonlinC+=I;
      }
    });
    // –í–µ–∫—Ç–æ—Ä–Ω–∞ —Å—É–º–∞ –¥–ª—è –ª—ñ–Ω—ñ–π–Ω–∏—Ö —Å–∫–ª–∞–¥–æ–≤–∏—Ö (A‚à†0, B‚à†-120, C‚à†+120)
    function phasorSum(a,b,c){
      const rad = Math.PI/180;
      const Ax=a, Ay=0;
      const Bx=b*Math.cos(-120*rad), By=b*Math.sin(-120*rad);
      const Cx=c*Math.cos(120*rad),  Cy=c*Math.sin(120*rad);
      return Math.sqrt((Ax+Bx+Cx)**2 + (Ay+By+Cy)**2);
    }
    const In_linear = phasorSum(A-nonlinA, B-nonlinB, C-nonlinC);
    // –¢—Ä–∏–ø–ª–µ—Ç–Ω—ñ –≥–∞—Ä–º–æ–Ω—ñ–∫–∏ –≤—ñ–¥ –Ω–µ–ª—ñ–Ω—ñ–π–Ω–∏—Ö ‚Äî –≥—Ä—É–±–∞ –æ—Ü—ñ–Ω–∫–∞: 1.5√ó —Å–µ—Ä–µ–¥–Ω—å–æ—ó –Ω–µ–ª—ñ–Ω—ñ–π–Ω–æ—ó —Å–∫–ª–∞–¥–æ–≤–æ—ó
    const avgNonlin = (nonlinA+nonlinB+nonlinC)/3;
    const In_triplen = 1.5 * avgNonlin;
    const In = round2(In_linear + In_triplen);

    const arr=[A,B,C];
    const avg=(A+B+C)/3;
    const diff = Math.max(...arr) - Math.min(...arr);
    const pct = avg>0 ? (diff/avg)*100 : 0;
    let status='PASS'; if(pct>20) status='FAIL'; else if(pct>=10) status='WARN';
    return {A:round2(A),B:round2(B),C:round2(C),In,avg:round2(avg),imb_pcnt:round2(pct),status,nonlin:{A:round2(nonlinA),B:round2(nonlinB),C:round2(nonlinC)}};
  }

  // –†–µ–Ω–¥–µ—Ä –±–∞–Ω–µ—Ä–∞
  function renderBanner(){
    const t=totals();
    banner.innerHTML='';
    const chips=[
      `Œ£A=${t.A} –ê`,`Œ£B=${t.B} –ê`,`Œ£C=${t.C} –ê`,`I‚Çô‚âà${t.In} –ê`,`Œî%= ${t.imb_pcnt}`,
      t.status==='PASS'?'<span class="b" style="color:#22c55e">PASS</span>':
      (t.status==='WARN'?'<span class="b" style="color:#f59e0b">WARN</span>':'<span class="b" style="color:#ef4444">FAIL</span>')
    ];
    chips.forEach(x=>{ const s=document.createElement('div'); s.className='b'; s.innerHTML=x; banner.appendChild(s); });
  }

  // CRUD
  function addOrUpdate(){
    const r={
      way:parseInt(document.getElementById('way').value||'1',10),
      id:(document.getElementById('id').value||'').trim(),
      name:(document.getElementById('name').value||'').trim(),
      phase:document.getElementById('phase').value,
      poles:document.getElementById('poles').value,
      mode:document.getElementById('mode').value.startsWith('p')?'p':'i',
      value:parseFloat(document.getElementById('value').value||'0'),
      PF:parseFloat(document.getElementById('pf').value||'1'),
      eta:parseFloat(document.getElementById('eta').value||'1'),
      duty:parseFloat(document.getElementById('duty').value||'100'),
      diversity:parseFloat(document.getElementById('divers').value||'100'),
      curve:document.getElementById('curve').value,
      In_A:parseFloat(document.getElementById('InA').value||'10'),
      nonlinear:document.getElementById('nonlin').value,
      location:(document.getElementById('location').value||'').trim(),
      url:(document.getElementById('url').value||'').trim(),
      notes:''
    };
    if(!r.id){ alert('–£–∫–∞–∂–∏ ID'); return; }
    const i=rows.findIndex(x=>x.id===r.id);
    if(i>=0) rows[i]={...rows[i],...r}; else rows.push(r);
    recalc();
    buildTickets([r]);
  }

  function recalc(){ rows.sort((a,b)=>a.way-b.way); render(); renderBanner(); }

  // –¢–∞–±–ª–∏—Ü—è
  function render(){
    tbody.innerHTML='';
    rows.forEach((r,i)=>{
      const I = round2(currentOf(r));
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="editable" data-k="way" data-id="${r.id}">${r.way}</td>
        <td class="editable" data-k="id" data-id="${r.id}">${esc(r.id)}</td>
        <td class="editable" data-k="name" data-id="${r.id}">${esc(r.name)}</td>
        <td class="editable" data-k="phase" data-id="${r.id}">${esc(r.phase)}</td>
        <td class="editable" data-k="poles" data-id="${r.id}">${esc(r.poles)}</td>
        <td class="editable" data-k="mode" data-id="${r.id}">${esc(r.mode)}</td>
        <td class="editable" data-k="value" data-id="${r.id}">${esc(r.value)}</td>
        <td>${I}</td>
        <td class="editable" data-k="In_A" data-id="${r.id}">${esc(r.curve)}${esc(r.In_A)}</td>
        <td class="editable" data-k="nonlinear" data-id="${r.id}">${esc(r.nonlinear)}</td>
        <td class="editable" data-k="url" data-id="${r.id}">${esc(r.url||'')}</td>
        <td class="mono">
          <button class="btn" data-act="label" data-id="${r.id}">–ù–∞–∫–ª–µ–π–∫–∞</button>
          <button class="btn" data-act="del" data-id="${r.id}">‚úñ</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // –Ü–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  tbody.addEventListener('dblclick',(e)=>{
    const td=e.target.closest('.editable'); if(!td) return;
    const id=td.getAttribute('data-id'); const key=td.getAttribute('data-k');
    const idx=rows.findIndex(x=>x.id===id); const r=rows[idx];
    const input=document.createElement('input'); input.value=r[key]||''; input.style.width='100%'; input.style.padding='6px 8px';
    input.addEventListener('blur', ()=>{ let v=input.value.trim();
      if(['way','value','In_A'].includes(key)) v=parseFloat(v)||0;
      r[key]=v; recalc(); });
    td.innerHTML=''; td.appendChild(input); input.focus(); input.select();
  });

  // –ö–Ω–æ–ø–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ
  tbody.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
    if(act==='del'){ rows=rows.filter(x=>x.id!==id); recalc(); return; }
    if(act==='label'){ const r=rows.find(x=>x.id===id); buildTickets([r]); ticketsBox.scrollIntoView({behavior:'smooth'}); }
  });

  // –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–æ–∫ (–∂–∞–¥—ñ–±–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º)
  function suggest(){
    let changed=true; let steps=[];
    // –ø—Ä–∞—Ü—é—î–º–æ –∑ –∫–æ–ø—ñ—î—é
    const arr=rows.map(x=>({...x}));
    function totalsOf(a){
      let A=0,B=0,C=0;
      a.forEach(r=>{
        const I=currentOf(r);
        if(r.phase==='3F' || r.poles==='3P'){ A+=I;B+=I;C+=I; }
        else if(r.phase==='A') A+=I; else if(r.phase==='B') B+=I; else C+=I;
      });
      return {A,B,C};
    }
    while(changed){
      changed=false;
      const T=totalsOf(arr);
      const listA=arr.filter(r=>r.phase==='A' && r.poles!=='3P').sort((x,y)=>currentOf(y)-currentOf(x));
      const listB=arr.filter(r=>r.phase==='B' && r.poles!=='3P').sort((x,y)=>currentOf(y)-currentOf(x));
      const listC=arr.filter(r=>r.phase==='C' && r.poles!=='3P').sort((x,y)=>currentOf(y)-currentOf(x));
      const phases=[{k:'A',I:T.A,list:listA},{k:'B',I:T.B,list:listB},{k:'C',I:T.C,list:listC}].sort((x,y)=>y.I-x.I);
      const maxP=phases[0], minP=phases[2];
      if(maxP.I - minP.I < 0.5) break; // –ø–æ—Ä—ñ–≥ —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ
      const donor = maxP.list[0];
      if(!donor) break;
      donor.phase = minP.k; changed=true;
      steps.push(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ${donor.id} (${round2(currentOf(donor))} –ê) –∑ ${phases[0].k} ‚Üí ${minP.k}`);
    }
    const t=totalsOf(arr);
    const avg=(t.A+t.B+t.C)/3;
    const pct = avg>0 ? ((Math.max(t.A,t.B,t.C)-Math.min(t.A,t.B,t.C))/avg)*100 : 0;
    const text = steps.length ? (`‚úÖ –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó:\n- `+steps.join('\n- ')
      + `\n–û—á—ñ–∫—É–≤–∞–Ω—ñ Œ£A=${round2(t.A)}A Œ£B=${round2(t.B)}A Œ£C=${round2(t.C)}A (Œî%‚âà${round2(pct)})`)
      : '‚ÑπÔ∏è –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∞–±–æ –Ω–µ–º–∞—î 1–§ –∫—ñ–ª –≤–µ–ª–∏–∫–æ—ó –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ.';
    alert(text);
  }

  // –ù–∞–∫–ª–µ–π–∫–∏ 58 –º–º
  function buildTickets(list){
    const L=list||rows;
    ticketsBox.innerHTML='';
    L.forEach(r=>{
      const I=round2(currentOf(r));
      const el=document.createElement('div'); el.className='ticket';
      const urlText = r.url && r.url.length ? r.url : `https://serawww7.github.io/edlab/electric_para18.html#${encodeURIComponent(r.id)}`;
      el.innerHTML = `
        <h4>–ö–û–õ–û –©–ò–¢–ö–ê</h4>
        <p><b>${esc(r.id)} ¬∑ ${esc(r.name)}</b></p>
        <div class="line"></div>
        <p>–§–∞–∑–∞/–ø–æ–ª—é—Å–∏: ${esc(r.phase)}/${esc(r.poles)} ¬∑ ${esc(r.curve)}${esc(r.In_A)}A</p>
        <p>I‚âà ${I} A ¬∑ –†–µ–∂–∏–º: ${esc(r.mode==='p'?'–∫–í—Ç':'–ê')} ¬∑ Duty ${esc(r.duty||100)}% ¬∑ Div ${esc(r.diversity||100)}%</p>
        <p>–ù–µ–ª—ñ–Ω.: ${esc(r.nonlinear||'–ù—ñ')}</p>
        <div class="line"></div>
        <p class="qr"><small>URL: ${esc(urlText)}</small></p>
        <p><small>${nowStamp()}</small></p>
      `;
      ticketsBox.appendChild(el);
    });
  }

  // A4 –ø–ª–∞–Ω-—â–∏—Ç–æ–∫
  function buildReport(){
    if(!rows.length){ alert('–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤'); return; }
    const t=totals();
    const head=`
      <p>–î–∞—Ç–∞: ${nowStamp()}</p>
      <p>–ü—ñ–¥—Å—É–º–∫–∏: Œ£A=${t.A} A ¬∑ Œ£B=${t.B} A ¬∑ Œ£C=${t.C} A ¬∑ I‚Çô‚âà${t.In} A ¬∑ Œî%=${t.imb_pcnt} ‚Üí ${t.status}</p>
    `;
    const lines = rows.map(r=>{
      const I=round2(currentOf(r));
      return `<tr>
        <td>${r.way}</td><td>${esc(r.id)}</td><td>${esc(r.name)}</td><td>${esc(r.location||'')}</td>
        <td>${esc(r.phase)}</td><td>${esc(r.poles)}</td><td>${esc(r.mode==='p'?'–∫–í—Ç':'–ê')}=${esc(r.value)}</td>
        <td>${I}</td><td>${esc(r.curve)}${esc(r.In_A)}</td><td>${esc(r.nonlinear||'–ù—ñ')}</td><td>${esc(r.url||'')}</td>
      </tr>`;
    }).join('');
    const html = `
      <section class="doc">
        <h2>–ü–õ–ê–ù-–©–ò–¢–û–ö (–±–∞–ª–∞–Ω—Å —Ñ–∞–∑)</h2>
        ${head}
        <table>
          <thead>
            <tr><th>way</th><th>ID</th><th>–ù–∞–∑–≤–∞</th><th>–õ–æ–∫–∞—Ü—ñ—è</th><th>–§–∞–∑–∞</th><th>–ü–æ–ª—é—Å—ñ–≤</th><th>–í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ</th><th>I, –ê</th><th>MCB</th><th>–ù–µ–ª—ñ–Ω—ñ–π–Ω–µ</th><th>URL</th></tr>
          </thead>
          <tbody>${lines}</tbody>
        </table>
        <h3>–ü—Ä–∏–º—ñ—Ç–∫–∞</h3>
        <p>–°—Ç—Ä—É–º N –æ—Ü—ñ–Ω–µ–Ω–æ —è–∫ –≤–µ–∫—Ç–æ—Ä–Ω—É —Å—É–º—É –ª—ñ–Ω—ñ–π–Ω–∏—Ö —Å–∫–ª–∞–¥–æ–≤–∏—Ö + –¥–æ–¥–∞—Ç–æ–∫ –≤—ñ–¥ —Ç—Ä–∏–ø–ª–µ—Ç–Ω–∏—Ö –≥–∞—Ä–º–æ–Ω—ñ–∫ (1.5√óavg –Ω–µ–ª—ñ–Ω—ñ–π–Ω–æ—ó —Å–∫–ª–∞–¥–æ–≤–æ—ó). –£ —Ä–µ–∞–ª—å–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –≤–∏–º—ñ—Ä—é–π—Ç–µ I<sub>N</sub> —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ñ–∞–∫—Ç–∏—á–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.</p>
        <div class="sign"><div>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ____________________</div><div>–ü–µ—Ä–µ–≤—ñ—Ä–∏–≤: ____________________</div></div>
      </section>`;
    document.getElementById('printArea').innerHTML=html;
    document.getElementById('printArea').scrollIntoView({behavior:'smooth'});
  }

  // CSV
  function exportCSV(){
    const headers=['way','id','name','phase','poles','mode','p_or_I','value','PF','eta','duty_pct','diversity_pct','curve','In_A','location','notes','url','nonlinear','I_calc_A','timestamp'];
    const stamp=nowStamp();
    const csv=[headers.join(','), ...rows.map(r=>{
      const vals=[r.way,r.id,r.name,r.phase,r.poles,r.mode,(r.mode==='p'?'p':'i'),r.value,r.PF,r.eta,r.duty,r.diversity,r.curve,r.In_A,r.location||'',r.notes||'',r.url||'',r.nonlinear||'–ù—ñ',round2(currentOf(r)),stamp];
      return vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    })].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='panel_balance_registry.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  async function importCSV(){
    const f=document.getElementById('file').files[0]; if(!f){ alert('–û–±–µ—Ä—ñ—Ç—å CSV'); return; }
    const txt=await f.text();
    const lines=txt.trim().split(/\r?\n/); if(lines.length<2){ alert('CSV –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const headers=lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const req=['way','id','name','phase','poles','mode','value','PF','eta','duty_pct','diversity_pct','curve','In_A','location','url','nonlinear'];
    const miss=req.filter(x=>!headers.includes(x)); if(miss.length){ alert('–í—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è: '+miss.join(', ')); return; }
    const out=[];
    for(let i=1;i<lines.length;i++){
      const cells=splitCSV(lines[i]); if(!cells.length) continue;
      const o={}; headers.forEach((h,j)=> o[h]=(cells[j]||'').replace(/^"|"$/g,''));
      out.push({
        way:parseInt(o.way||'1',10), id:o.id, name:o.name, phase:o.phase||'A', poles:o.poles||'1P',
        mode:(o.mode||'p').startsWith('p')?'p':'i', value:parseFloat(o.value||'0'), PF:parseFloat(o.PF||'1'), eta:parseFloat(o.eta||'1'),
        duty:parseFloat(o.duty_pct||'100'), diversity:parseFloat(o.diversity_pct||'100'),
        curve:o.curve||'C', In_A:parseFloat(o.In_A||'10'), location:o.location||'', notes:o.notes||'', url:o.url||'', nonlinear:o.nonlinear||'–ù—ñ'
      });
    }
    rows=out; recalc();
  }
  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else { cur+=ch; }
    }
    res.push(cur); return res;
  }

  // –ü—Ä–∏–∫–ª–∞–¥–∏
  function seedOne(){
    document.getElementById('way').value=4;
    document.getElementById('id').value='C-04';
    document.getElementById('name').value='–†–æ–∑–µ—Ç–∫–∏ –ª–∞–±.1';
    document.getElementById('phase').value='C';
    document.getElementById('poles').value='1P';
    document.getElementById('mode').value='p (–∫–í—Ç)';
    document.getElementById('value').value=1.2;
    document.getElementById('pf').value=0.95;
    document.getElementById('eta').value=0.98;
    document.getElementById('duty').value=60;
    document.getElementById('divers').value=80;
    document.getElementById('curve').value='C';
    document.getElementById('InA').value=16;
    document.getElementById('nonlin').value='–¢–∞–∫';
    document.getElementById('location').value='–õ–∞–±. –µ–ª–µ–∫—Ç—Ä–∏–∫–∏';
  }

  function seedDemo(){
    rows = [
      {way:1,id:'C-01',name:'–û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è –∞—É–¥.101',phase:'A',poles:'1P',mode:'p',value:0.6,PF:0.95,eta:0.98,duty:80,diversity:100,curve:'C',In_A:10,nonlinear:'–ù—ñ',location:'–ö–æ—Ä–ø—É—Å –ê ¬∑ 1 –ø–æ–≤.',url:''},
      {way:2,id:'C-02',name:'–†–æ–∑–µ—Ç–∫–∏ –∞—É–¥.101',phase:'A',poles:'1P',mode:'p',value:1.5,PF:0.95,eta:0.98,duty:70,diversity:80,curve:'C',In_A:16,nonlinear:'–¢–∞–∫',location:'–ö–æ—Ä–ø—É—Å –ê ¬∑ 1 –ø–æ–≤.',url:''},
      {way:3,id:'M-01',name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 3–§',phase:'3F',poles:'3P',mode:'p',value:2.2,PF:0.9,eta:0.9,duty:100,diversity:100,curve:'D',In_A:20,nonlinear:'–ù—ñ',location:'–ú–∞–π—Å—Ç–µ—Ä–Ω—è',url:''},
      {way:4,id:'C-03',name:'–í–∏—Ç—è–∂–∫–∞',phase:'B',poles:'1P',mode:'p',value:0.35,PF:1,eta:1,duty:100,diversity:100,curve:'B',In_A:10,nonlinear:'–ù—ñ',location:'–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è',url:''},
      {way:5,id:'S-01',name:'–Ü–Ω–≤–µ—Ä—Ç–æ—Ä (SMPS)',phase:'C',poles:'1P',mode:'i',value:6.0,PF:0.9,eta:0.95,duty:100,diversity:100,curve:'C',In_A:16,nonlinear:'–¢–∞–∫',location:'–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è',url:''}
    ];
    recalc();
  }

  // –ê–≤—Ç–æ–¥–µ–º–æ
  seedDemo();
</script>


</body></html>