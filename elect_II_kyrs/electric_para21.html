<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 21 (–ï–ª–µ–∫—Ç—Ä–∏–∫–∞) ‚Äî Arduino: –º–æ–Ω—ñ—Ç–æ—Ä –µ–Ω–µ—Ä–≥–æ—Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è (SCT-013, –∫–í—Ç¬∑–≥–æ–¥, —Å–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è)</title>
<meta name="description" content="–í–∏–º—ñ—Ä—é—î–º–æ —Å—Ç—Ä—É–º SCT-013, –æ–±—á–∏—Å–ª—é—î–º–æ S/P, –∫–í—Ç¬∑–≥–æ–¥, —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (LED/–±—É–∑–µ—Ä), –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è, –∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫, –∂—É—Ä–Ω–∞–ª —ñ –µ–∫—Å–ø–æ—Ä—Ç. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ—à–∏–≤–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞–±–æ –¥–≤–æ—Ö —Å–µ–Ω—Å–æ—Ä—ñ–≤ (I-only –∞–±–æ I+U)."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1040px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
.grid{display:grid;gap:14px;grid-template-columns:1.35fr 1fr}
@media(max-width:1040px){.grid{grid-template-columns:1fr}}
pre.code{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto;white-space:pre-wrap}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:260px}
.log{max-height:160px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1220;font-family:ui-monospace,monospace;font-size:13px;white-space:pre-wrap}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.small{font-size:.9rem}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
svg{max-width:100%;height:auto;display:block}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üîå</span>
      <div>
        <b>–ü–∞—Ä–∞ 21 ‚Äî Arduino: –º–æ–Ω—ñ—Ç–æ—Ä –µ–Ω–µ—Ä–≥–æ—Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è</b><br/>
        <span class="badge">SCT-013 ‚Üí I<sub>rms</sub> ‚Üí S/P ‚Üí –∫–í—Ç¬∑–≥–æ–¥ ‚Üí –ø–æ—Ä–æ–≥–∏ ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">
    –ú–µ—Ç–∞: <b>–±–µ–∑–ø–µ—á–Ω–∏–º</b> —Å–ø–æ—Å–æ–±–æ–º –∑–Ω—è—Ç–∏ —Å—Ç—Ä—É–º —ñ–∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–∞ —Å—Ç—Ä—É–º—É <b>SCT-013</b>, –æ—Ü—ñ–Ω–∏—Ç–∏ <b>S</b> (–ø–æ–≤–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å), –∑–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Å–µ–Ω—Å–æ—Ä–∞ –Ω–∞–ø—Ä—É–≥–∏ ‚Äî <b>P</b> (–∞–∫—Ç–∏–≤–Ω–∞) —Ç–∞ <b>PF</b>, –Ω–∞–∫–æ–ø–∏—á–∏—Ç–∏ <b>–∫–í—Ç¬∑–≥–æ–¥</b>, –ø–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É —ñ –ø–æ–¥–∞—Ç–∏ —Å–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—é –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è. –Ñ <b>–µ–º—É–ª—è—Ç–æ—Ä</b> –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, <b>–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä .ino</b>, <b>SVG-—Å—Ö–µ–º–∞</b> —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT.
  </p>

  <div class="grid">
    <!-- –õ–Ü–í–û -->
    <div class="card">
      <h2>üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å</h2>
      <div class="row">
        <div style="flex:1">
          <label for="mode">–†–µ–∂–∏–º</label>
          <select id="mode" class="input">
            <option value="I_ONLY" selected>–õ–∏—à–µ —Å—Ç—Ä—É–º (S‚âàU¬∑I)</option>
            <option value="I_U">–°—Ç—Ä—É–º + –Ω–∞–ø—Ä—É–≥–∞ (—Ä–µ–∞–ª—å–Ω–∞ P, PF)</option>
          </select>
        </div>
        <div style="flex:1">
          <label for="mains">–ú–µ—Ä–µ–∂–∞, –í (RMS)</label>
          <input id="mains" class="input" type="number" step="1" value="230"/>
        </div>
        <div style="flex:1">
          <label for="freq">–ß–∞—Å—Ç–æ—Ç–∞, –ì—Ü</label>
          <input id="freq" class="input" type="number" step="0.1" value="50.0"/>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="apinI">A0 ‚Äî SCT-013 (—Å—Ç—Ä—É–º)</label>
          <select id="apinI" class="input"><option>A0</option><option>A1</option><option>A2</option></select>
        </div>
        <div style="flex:1">
          <label for="apinU">A1 ‚Äî AC-–∞–¥–∞–ø—Ç–µ—Ä (–Ω–∞–ø—Ä—É–≥–∞)</label>
          <select id="apinU" class="input"><option>A1</option><option selected>A2</option><option>A3</option></select>
        </div>
        <div style="flex:1">
          <label for="nSamples">–í—ñ–∫–Ω–æ –≤–∏–±—ñ—Ä–∫–∏ (–º—Å)</label>
          <input id="nSamples" class="input" type="number" step="5" value="500"/>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="calI">–ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è I (A/ADC)</label>
          <input id="calI" class="input" type="number" step="0.0001" value="0.0500"/>
        </div>
        <div style="flex:1">
          <label for="calU">–ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è U (–í/ADC)</label>
          <input id="calU" class="input" type="number" step="0.001" value="1.100"/>
        </div>
        <div style="flex:1">
          <label for="phase">–§–∞–∑–æ–≤–∏–π –∑—Å—É–≤ (—Ä–∞–¥)</label>
          <input id="phase" class="input" type="number" step="0.01" value="0.10"/>
        </div>
      </div>

      <h3 style="margin-top:12px">üö® –ü–æ—Ä–æ–≥–∏/—ñ–Ω–¥–∏–∫–∞—Ü—ñ—è</h3>
      <div class="row">
        <div style="flex:1">
          <label for="pMax">–ü–æ—Ä—ñ–≥ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –í—Ç</label>
          <input id="pMax" class="input" type="number" step="10" value="3000"/>
        </div>
        <div style="flex:1">
          <label for="ledPin">LED –ø—ñ–Ω</label>
          <select id="ledPin" class="input"><option>3</option><option selected>5</option><option>6</option><option>9</option><option>10</option><option>11</option></select>
        </div>
        <div style="flex:1">
          <label for="buzPin">Buzzer –ø—ñ–Ω</label>
          <select id="buzPin" class="input"><option>4</option><option selected>8</option><option>7</option><option>12</option><option>13</option></select>
        </div>
      </div>

      <h3 style="margin-top:12px">üß™ –ï–º—É–ª—è—Ç–æ—Ä –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
      <div class="row">
        <input id="emu" type="checkbox"/><label for="emu">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –µ–º—É–ª—å</label>
      </div>
      <div class="row">
        <label style="flex:1">–°—Ç—Ä—É–º, A<sub>rms</sub> <input id="emuI" class="input" type="range" min="0" max="25" step="0.1" value="4" disabled/></label>
        <label style="flex:1">PF (cos œÜ) <input id="emuPF" class="input" type="range" min="0" max="1" step="0.01" value="0.90" disabled/></label>
      </div>

      <h3 style="margin-top:12px">üìà –ñ–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫</h3>
      <div class="canvasWrap"><canvas id="chart" width="900" height="260"></canvas></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="tick">‚ûï –ó—á–∏—Ç–∞—Ç–∏</button>
        <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
        <span id="last" class="badge">I=‚Äî A | U=‚Äî V | P=‚Äî W | S=‚Äî VA | PF=‚Äî | Œ£E=0.000 –∫–í—Ç¬∑–≥–æ–¥</span>
      </div>

      <h3 style="margin-top:12px">üß© –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥ (.ino)</h3>
      <div class="row">
        <button class="btn good" id="gen">‚öôÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
        <button class="btn secondary" id="copy">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        <button class="btn secondary" id="dl">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ .ino</button>
      </div>
      <pre class="code" id="code">// –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏¬ª ‚Üë</pre>

      <h3 style="margin-top:12px">üíæ –ü—Ä–æ—Ç–æ–∫–æ–ª/–µ–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <input id="fio" class="input" placeholder="–ü–Ü–ë —Å—Ç—É–¥–µ–Ω—Ç–∞"/>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="saveCsv">üìÑ CSV</button>
      </div>
      <div id="log" class="log" aria-live="polite"></div>
    </div>

    <!-- –ü–†–ê–í–û -->
    <div class="card">
      <h2>üîå –°—Ö–µ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (SVG)</h2>
      <svg viewBox="0 0 760 420" role="img" aria-label="Arduino + SCT-013 + AC-–∞–¥–∞–ø—Ç–µ—Ä">
        <!-- Arduino -->
        <rect x="40" y="40" width="220" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="150" y="66" fill="#e5e7eb" font-size="16" text-anchor="middle">Arduino UNO/Nano</text>
        <text x="60" y="96" fill="#93c5fd" font-size="12">A0 ‚Äî I</text>
        <text x="60" y="116" fill="#93c5fd" font-size="12">A1/A2 ‚Äî U (–æ–ø—Ü.)</text>
        <text x="60" y="136" fill="#93c5fd" font-size="12">5V/3.3V ‚Äî bias</text>

        <!-- SCT -->
        <rect x="320" y="40" width="200" height="100" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="420" y="70" fill="#dcfce7" font-size="16" text-anchor="middle">SCT-013 (CT)</text>
        <text x="420" y="90" fill="#a7f3d0" font-size="12" text-anchor="middle">I ‚Üí A0 —á–µ—Ä–µ–∑ —à—É–Ω—Ç + bias</text>

        <!-- Bias divider -->
        <rect x="320" y="160" width="200" height="90" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="420" y="190" fill="#e5e7eb" font-size="14" text-anchor="middle">–î—ñ–ª—å–Ω–∏–∫ 2√ó100–∫Œ©</text>
        <text x="420" y="210" fill="#9ca3af" font-size="12" text-anchor="middle">—Ü–µ–Ω—Ç—Ä ~Vcc/2 ‚Üí A0/A2</text>

        <!-- AC adapter -->
        <rect x="320" y="270" width="200" height="100" rx="12" fill="#7c2d12" stroke="#fb923c"/>
        <text x="420" y="300" fill="#fed7aa" font-size="16" text-anchor="middle">AC-–∞–¥–∞–ø—Ç–µ—Ä 9V (–æ–ø—Ü.)</text>
        <text x="420" y="320" fill="#fed7aa" font-size="12" text-anchor="middle">—á–µ—Ä–µ–∑ –¥—ñ–ª—å–Ω–∏–∫ –¥–æ A1/A2</text>

        <!-- Connections -->
        <line x1="260" y1="100" x2="320" y2="80" stroke="#93c5fd" stroke-width="3"/><text x="280" y="90" fill="#93c5fd" font-size="12">A0 ‚Üê CT</text>
        <line x1="260" y1="120" x2="320" y2="300" stroke="#93c5fd" stroke-width="3"/><text x="280" y="210" fill="#93c5fd" font-size="12">A1/A2 ‚Üê AC</text>

        <line x1="260" y1="140" x2="320" y2="200" stroke="#64748b" stroke-width="3"/><text x="280" y="170" fill="#94a3b8" font-size="12">Bias: Vcc/2</text>
      </svg>

      <div class="note small" style="margin-top:10px">
        <b>–ë–µ–∑–ø–µ–∫–∞:</b> –ø–µ—Ä–≤–∏–Ω–Ω–∞ –º–µ—Ä–µ–∂–∞ 230 –í –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑‚Äô—î–¥–Ω—É—î—Ç—å—Å—è –∑ Arduino –Ω–∞–ø—Ä—è–º—É. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ <b>—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä —Å—Ç—Ä—É–º—É SCT-013</b> (—ñ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º —à—É–Ω—Ç–æ–º) —Ç–∞, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏, <b>—ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–π AC-–∞–¥–∞–ø—Ç–µ—Ä</b> –¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏. –ü—Ä–∞—Ü—é–π –ª–∏—à–µ –ø—ñ–¥ –Ω–∞–≥–ª—è–¥–æ–º —ñ –∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω–∏–º –∂–∏–≤–ª–µ–Ω–Ω—è–º –ø—ñ–¥ —á–∞—Å –º–æ–Ω—Ç–∞–∂—É.
      </div>

      <h3 style="margin-top:12px">üß∑ –ö–æ—Ä–∏—Å–Ω—ñ —Ç–µ–≥–∏</h3>
      <div>
        <span class="tag">#SCT013</span>
        <span class="tag">#current_transformer</span>
        <span class="tag">#power_factor</span>
        <span class="tag">#kWh</span>
        <span class="tag">#overload_alarm</span>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h3>
        <p class="muted small">
          –Ü–¥–µ—è –ø–æ–±—É—Ç–æ–≤–æ–≥–æ ¬´–µ–Ω–µ—Ä–≥–æ–º–µ—Ç—Ä–∞¬ª –∑ CT —Å—Ç–∞–ª–∞ –º–∞—Å–æ–≤–æ—é –∑–∞–≤–¥—è–∫–∏ open-hardware —Å–ø—ñ–ª—å–Ω–æ—Ç–∞–º (—Ç–∏–ø—É –ø—Ä–æ–µ–∫—Ç—ñ–≤ –µ–Ω–µ—Ä–≥–æ–º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É), 
          —è–∫—ñ –ø–æ–ø—É–ª—è—Ä–∏–∑—É–≤–∞–ª–∏ –±–µ–∑–ø–µ—á–Ω–∏–π –≤–∏–º—ñ—Ä –∑–º—ñ–Ω–Ω–æ–≥–æ —Å—Ç—Ä—É–º—É <i>–±–µ–∑ –ø—Ä—è–º–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É</i> —ñ–∑ –º–µ—Ä–µ–∂–µ—é.
        </p>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üìã –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –∑–≤—ñ—Ç—É</h2>
    <ul>
      <li>–§–æ—Ç–æ —Å—Ö–µ–º–∏; –ø–æ—è—Å–Ω–µ–Ω–Ω—è, —è–∫–∏–π SCT-013 (—ñ–∑/–±–µ–∑ —à—É–Ω—Ç–∞) —ñ —è–∫ –ø—ñ–¥—ñ–±—Ä–∞–Ω–∏–π –¥—ñ–ª—å–Ω–∏–∫.</li>
      <li>CSV-–ª–æ–≥ 2‚Äì3 —Ö–≤ —ñ–∑ I, U (—è–∫—â–æ —î), P, S, PF, Œ£E; —Å–∫—Ä—ñ–Ω –≥—Ä–∞—Ñ—ñ–∫–∞.</li>
      <li>–ö–æ—Ä–æ—Ç–∫–æ: —è–∫ –≤–ø–ª–∏–≤–∞—é—Ç—å –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —Ñ–∞–∑–æ–≤–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—è –Ω–∞ PF —Ç–∞ P.</li>
    </ul>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s);
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function log(msg){const t=new Date().toLocaleTimeString(); LOG.textContent+=`[${t}] ${msg}\n`; LOG.scrollTop=LOG.scrollHeight;}

// ===== –°—Ç–∞–Ω–∏ =====
const cvs=$('#chart'), ctx=cvs.getContext('2d');
const series=[]; // {t,I,U,P,S,PF,E}
let E_kWh=0, lastTs=null;

// ===== –ï–º—É–ª—è—Ç–æ—Ä =====
const emu=$('#emu'), emuI=$('#emuI'), emuPF=$('#emuPF');
emu.addEventListener('change',()=>{emuI.disabled=emuPF.disabled=!emu.checked;});

// ===== –ì—Ä–∞—Ñ—ñ–∫ =====
function drawChart(){
  const W=cvs.width,H=cvs.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  if(series.length<2) return;
  const maxN=140;
  const s=series.slice(-maxN);
  const xs=s.map((_,i)=> i*(W/(s.length-1)));

  // P (–í—Ç)
  const maxP = Math.max(1000, Math.max(...s.map(v=>v.P||0))*1.2);
  ctx.beginPath(); ctx.strokeStyle='#22c55e'; ctx.lineWidth=2;
  xs.forEach((x,i)=>{const y=H-10-(Math.min(maxP,s[i].P)/maxP)*(H-20); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.stroke();

  // S (–í–ê)
  const maxS = Math.max(1000, Math.max(...s.map(v=>v.S||0))*1.2);
  ctx.beginPath(); ctx.strokeStyle='#38bdf8'; ctx.lineWidth=1.5;
  xs.forEach((x,i)=>{const y=H-10-(Math.min(maxS,s[i].S)/maxS)*(H-20); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.stroke();

  ctx.fillStyle='#94a3b8'; ctx.font='12px ui-monospace';
  ctx.fillText('P',W-28,14); ctx.fillText('S',W-12,14);
}

// ===== –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫—Ä–æ–∫—É =====
function acquirePoint(){
  const mode=$('#mode').value;
  const Ugrid=parseFloat($('#mains').value)||230;
  let I=0, PF=1, U=Ugrid;

  if(emu.checked){
    I=parseFloat(emuI.value)||0;
    PF=parseFloat(emuPF.value)||1;
  }else{
    // –£ ¬´–∂–∏–≤–æ–º—É¬ª —Ä–µ–∂–∏–º—ñ —Ç—É—Ç –º–æ–≥–ª–∏ –± —Å—Ç–æ—è—Ç–∏ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è –∑ SerialMonitor:
    // –∞–ª–µ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ—ó –¥–µ–º–æ-—Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑–∞–ø–∏—Ç—É—î–º–æ –≤—Ä—É—á–Ω—É
    const i=prompt('–í–≤–µ–¥–∏ I_rms (A) –∑—ñ —Å–≤–æ–≥–æ —Å–∫–µ—Ç—á–∞/Serial:', '3.2'); if(i===null) return;
    const pf= (mode==='I_U') ? prompt('–í–≤–µ–¥–∏ PF (0..1):','0.85') : null;
    I=parseFloat(i)||0; PF = pf==null?1:(parseFloat(pf)||1);
    if(mode==='I_U'){ const u=prompt('–í–≤–µ–¥–∏ U_rms (–í):','228'); if(u===null) return; U=parseFloat(u)||Ugrid; }
  }

  let P=0,S=0;
  if(mode==='I_ONLY'){ S = U*I; P = S*PF; }
  else{ S = U*I; P = U*I*PF; } // —É –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ñ .ino –±—É–¥–µ —Ç–æ—á–Ω—ñ—à–µ —á–µ—Ä–µ–∑ –∫—Ä–æ—Å-–¥–æ–±—É—Ç–æ–∫

  const now=Date.now();
  if(lastTs==null) lastTs=now;
  const dt_h=(now-lastTs)/3600000;
  lastTs=now;
  E_kWh += (P/1000)*dt_h;

  series.push({t:now,I,U,P,S,PF,E:E_kWh});
  $('#last').textContent=`I=${I.toFixed(2)} A | U=${U.toFixed(0)} V | P=${P.toFixed(0)} W | S=${S.toFixed(0)} VA | PF=${PF.toFixed(2)} | Œ£E=${E_kWh.toFixed(3)} –∫–í—Ç¬∑–≥–æ–¥`;

  // —Å–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è
  const pMax=parseFloat($('#pMax').value)||3000;
  if(P>=pMax){ document.title='‚ö†Ô∏è –ü–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è!'; setTimeout(()=>document.title='–ú–æ–Ω—ñ—Ç–æ—Ä –µ–Ω–µ—Ä–≥–æ—Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è',1000); }
  drawChart();
}

// –ü–æ–¥—ñ—ó –≥—Ä–∞—Ñ—ñ–∫–∞
$('#tick').addEventListener('click', acquirePoint);
$('#clear').addEventListener('click', ()=>{ series.length=0; E_kWh=0; lastTs=null; $('#last').textContent='I=‚Äî A | U=‚Äî V | P=‚Äî W | S=‚Äî VA | PF=‚Äî | Œ£E=0.000 –∫–í—Ç¬∑–≥–æ–¥'; drawChart(); });

// ===== –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ—à–∏–≤–∫–∏ =====
function genSketch(){
  const mode=$('#mode').value;
  const apinI=$('#apinI').value.replace('A','');
  const apinU=$('#apinU').value.replace('A','');
  const mains=parseFloat($('#mains').value)||230;
  const freq=parseFloat($('#freq').value)||50;
  const nms=parseInt($('#nSamples').value)||500;
  const calI=parseFloat($('#calI').value)||0.05;
  const calU=parseFloat($('#calU').value)||1.1;
  const phase=parseFloat($('#phase').value)||0.1;
  const led=parseInt($('#ledPin').value)||5;
  const buz=parseInt($('#buzPin').value)||8;
  const pMax=parseFloat($('#pMax').value)||3000;

  const code = `/*
  –ü–∞—Ä–∞ 21 ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä –µ–Ω–µ—Ä–≥–æ—Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è (SCT-013)
  –†–µ–∂–∏–º–∏:
    - I_ONLY: –ª–∏—à–µ —Å—Ç—Ä—É–º (–æ—Ü—ñ–Ω–∫–∞ S‚âàUgrid*Irms, P‚âàS*PF_approx)
    - I_U: —Å—Ç—Ä—É–º + –Ω–∞–ø—Ä—É–≥–∞ –∑ AC-–∞–¥–∞–ø—Ç–µ—Ä–∞ (—Ä–µ–∞–ª—å–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å P —Ç–∞ PF —á–µ—Ä–µ–∑ –∫—Ä–æ—Å-–¥–æ–±—É—Ç–æ–∫)
  ‚ö† –ë–µ–∑–ø–µ–∫–∞: –º–µ—Ä–µ–∂–∞ 230–í –ª–∏—à–µ —á–µ—Ä–µ–∑ —ñ–∑–æ–ª—å–æ–≤–∞–Ω—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é–≤–∞—á—ñ (CT/AC-–∞–¥–∞–ø—Ç–µ—Ä). –ù–Ü–ö–û–õ–ò –Ω–∞–ø—Ä—è–º—É –≤ Arduino.
*/

#define MODE_${mode} 1
#define PIN_I A${apinI}
#define PIN_U A${apinU}   // –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É I_U
const float UGRID = ${mains};     // –í
const float FREQ  = ${freq};      // –ì—Ü
const unsigned long WINDOW_MS = ${nms}; // —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –Ω–∞–±–æ—Ä—É –∑—Ä–∞–∑–∫—ñ–≤
const float CAL_I = ${calI};      // A –Ω–∞ 1 ADC-–æ–¥–∏–Ω–∏—Ü—é (–ø—ñ—Å–ª—è bias-–≤—ñ–¥–Ω—ñ–º–∞–Ω–Ω—è)
const float CAL_U = ${calU};      // –í –Ω–∞ 1 ADC-–æ–¥–∏–Ω–∏—Ü—é (–ø—ñ—Å–ª—è bias)
const float PHASE = ${phase};     // —Ñ–∞–∑–æ–≤–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—è –¥–ª—è I_U (—Ä–∞–¥—ñ–∞–Ω–∏ –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–æ)
const int   LED_PIN = ${led};
const int   BUZ_PIN = ${buz};
const float P_MAX_W = ${pMax};    // –ø–æ—Ä—ñ–≥ —Å–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó (–í—Ç)

float E_kWh = 0.0;
unsigned long tPrev = 0;

static inline int fastRead(int pin){ return analogRead(pin); } // 10-–±—ñ—Ç ADC

void setup(){
  Serial.begin(115200);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZ_PIN, OUTPUT);
  analogReference(DEFAULT); // 5–í –¥–ª—è UNO (–º—ñ–Ω—è–π –∑–∞ –ø–æ—Ç—Ä–µ–±–∏)
  delay(300);
  Serial.println(F("millis,Irms,Urms,P,S,PF,E_kWh"));
}

void loop(){
  const unsigned long tStart = millis();
  const unsigned long tEnd   = tStart + WINDOW_MS;

  // –¶–µ–Ω—Ç—Ä –∑–º—ñ—â–µ–Ω–Ω—è (bias) ‚Äî –≤–∏–º—ñ—Ä—è—î–º–æ
  long sumI=0,sumU=0; int n0=0;
  while(millis() < tStart + 50){ // 50 –º—Å –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ bias
    sumI += fastRead(PIN_I);
    sumU += fastRead(PIN_U);
    n0++;
  }
  const float biasI = (float)sumI / max(1,n0);
  const float biasU = (float)sumU / max(1,n0);

  // –ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ –¥–ª—è RMS —Ç–∞ –∫—Ä–æ—Å-–¥–æ–±—É—Ç–∫—É
  double accI2=0, accU2=0, accPU=0;
  unsigned long n=0;

  while(millis() < tEnd){
    int ai = fastRead(PIN_I);
    int au = fastRead(PIN_U);

    float xi = (ai - biasI) * CAL_I;   // –ê –º–∏—Ç—Ç—î–≤–µ
    float xu = (au - biasU) * CAL_U;   // –í –º–∏—Ç—Ç—î–≤–µ

    #ifdef MODE_I_U
      // –ü—Ä–æ—Å—Ç–µ —Ñ–∞–∑–æ–≤–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è: U' = U*cosœÜ + (dU/dt)*sinœÜ/œâ ‚Äî –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—è –¥–∏—Å–∫—Ä–µ—Ç–Ω–∏–º –∑—Å—É–≤–æ–º
      // –î–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è –∑–∞—Å—Ç–æ—Å—É—î–º–æ —Ñ–∞–∑.–∫–æ—Ä–µ–∫—Ü—ñ—é –Ω–∞ I: I' = I*cosœÜ (–¥–æ—Å–∏—Ç—å –¥–ª—è —É—á–±–æ–≤–æ—ó)
      xi = xi * cos(PHASE);
      accPU += (double)xi * (double)xu; // –º–∏—Ç—Ç—î–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å
      accU2 += (double)xu * (double)xu;
    #endif

    accI2 += (double)xi * (double)xi;
    n++;
  }

  const float Irms = sqrt(accI2 / max(1UL,n));
  #ifdef MODE_I_U
    const float Urms = sqrt(accU2 / max(1UL,n));
    const float P    = accPU / max(1UL,n);     // —Å–µ—Ä–µ–¥–Ω—è –∞–∫—Ç–∏–≤–Ω–∞ (–í—Ç)
    const float S    = Urms * Irms;            // –ø–æ–≤–Ω–∞ (–í–ê)
    const float PF   = (S>1e-3)? (P/S) : 1.0;  // –∫–æ–µ—Ñ. –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ
  #else
    const float Urms = UGRID;
    const float S    = Urms * Irms;
    const float PF   = 0.95;                   // –ø—Ä–∏–ø—É—â–µ–Ω–Ω—è (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏)
    const float P    = S * PF;
  #endif

  // –ï–Ω–µ—Ä–≥—ñ—è
  const unsigned long now = millis();
  const float dt_h = (now - tPrev) / 3600000.0;
  tPrev = now;
  E_kWh += (P/1000.0) * max(0.0f, dt_h);

  // –°–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è
  const bool overload = (P >= P_MAX_W);
  digitalWrite(LED_PIN, overload?HIGH:LOW);
  if(overload){ tone(BUZ_PIN, 2000, 80); }

  Serial.print(now); Serial.print(',');
  Serial.print(Irms,3); Serial.print(',');
  Serial.print(Urms,1); Serial.print(',');
  Serial.print(P,1);    Serial.print(',');
  Serial.print(S,1);    Serial.print(',');
  Serial.print(PF,2);   Serial.print(',');
  Serial.println(E_kWh,3);

  // –ü–∞—É–∑–∞ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)
  delay(50);
}
`;
  return code;
}

$('#gen').addEventListener('click', ()=>{ const txt=genSketch(); $('#code').textContent=txt; log('–°–∫–µ—Ç—á –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ'); });
$('#copy').addEventListener('click', ()=>{ const ta=document.createElement('textarea'); ta.value=$('#code').textContent; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); log('–ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'); });
$('#dl').addEventListener('click', ()=>{ const txt=$('#code').textContent||genSketch(); download('electric_para21_energy_monitor.ino',txt,'text/x-ino'); });

// ===== –ï–∫—Å–ø–æ—Ä—Ç =====
const LOG=$('#log');
$('#saveTxt').addEventListener('click', ()=>{
  const fio=($('#fio').value||'').trim();
  const lines=[
    '–ü–∞—Ä–∞ 21 ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä –µ–Ω–µ—Ä–≥–æ—Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è',
    '–°—Ç—É–¥–µ–Ω—Ç: '+fio,
    `–†–µ–∂–∏–º: ${$('#mode').value}, –ú–µ—Ä–µ–∂–∞: ${$('#mains').value} –í @ ${$('#freq').value} –ì—Ü`,
    `–í—ñ–∫–Ω–æ: ${$('#nSamples').value} –º—Å; –ö–∞–ª—ñ–±—Ä I=${$('#calI').value} A/ADC; U=${$('#calU').value} –í/ADC; œÜ=${$('#phase').value} —Ä–∞–¥`,
    `–ü–æ—Ä—ñ–≥ Pmax: ${$('#pMax').value} –í—Ç; LED=${$('#ledPin').value}; Buzzer=${$('#buzPin').value}`,
    `Œ£E (—Å–µ—Å—ñ—è): ${E_kWh.toFixed(3)} –∫–í—Ç¬∑–≥–æ–¥`,
    '–ö–æ–º–µ–Ω—Ç–∞—Ä: ...'
  ].join('\n');
  download('electric_para21_'+stamp()+'.txt',lines);
});
$('#saveCsv').addEventListener('click', ()=>{
  const fio=($('#fio').value||'').replace(/"/g,'""');
  const csv='"–ü–∞—Ä–∞","–°—Ç—É–¥–µ–Ω—Ç","Mode","Ugrid","Freq","Window_ms","CalI","CalU","Phase","Pmax","SumE_kWh"\n'
          + `"21","${fio}","${$('#mode').value}",${$('#mains').value},${$('#freq').value},${$('#nSamples').value},${$('#calI').value},${$('#calU').value},${$('#phase').value},${$('#pMax').value},${E_kWh.toFixed(3)}\n`;
  download('electric_para21_'+stamp()+'.csv',csv,'text/csv');
});

// ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
drawChart();
if (window.self !== window.top) document.documentElement.classList.add('embedded'); // LMS/Moodle-friendly
</script>
</body>
</html>
