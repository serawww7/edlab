<!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 19 (–º–µ—Ö–∞–Ω—ñ–∫–∏) ‚Äî –í—ñ–∑—É–∞–ª—å–Ω–∏–π —Ç–∞—Ö–æ–º–µ—Ç—Ä —ñ —Å—Ç—Ä–æ–±–æ—Å–∫–æ–ø (–≤–µ–±–∫–∞–º–µ—Ä–∞ ‚Üí RPM, –±–∏—Ç—Ç—è, –∂—É—Ä–Ω–∞–ª)</title>
<meta name="description" content="–ë–µ–∑ Arduino: –≤–µ–±–∫–∞–º–µ—Ä–∞ ‚Üí ROI ‚Üí –¥–µ—Ç–µ–∫—Ü—ñ—è –≤—ñ–¥–±–∏–≤–∞—á–∞ ‚Üí RPM, –±–∏—Ç—Ç—è/–µ–∫—Å—Ü–µ–Ω—Ç—Ä–∏—Å–∏—Ç–µ—Ç, –∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫, –∞—É–¥—ñ–æ/–µ–∫—Ä–∞–Ω-—Å—Ç—Ä–æ–±, –∂—É—Ä–Ω–∞–ª, –µ–∫—Å–ø–æ—Ä—Ç PNG/CSV/TXT, —á–µ–∫ 58 –º–º.">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1140px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
.small{font-size:.9rem}
pre.code{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto;white-space:pre-wrap}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
video,canvas{display:block}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.fullflash{position:fixed;inset:0;background:#fff;display:none;z-index:9998}
</style>
<link rel="canonical" href="https://edlab.pp.ua/mech_II_kyrs/mechanic_para19.html"><meta property="og:type" content="article"><meta property="og:title" content="–ú–µ—Ö–∞–Ω—ñ–∑–∞—Ü—ñ—è ‚Äî –ü–∞—Ä–∞ 19"><meta property="og:description" content="–ú–µ—Ç–∞: –≤–∏–º—ñ—Ä—è—Ç–∏ –æ–±–µ—Ä—Ç–∏ (RPM) –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞/—à–∫—ñ–≤–∞/–í–í–ü –∑–∞ –≤–µ–±–∫–∞–º–µ—Ä–æ—é –∑ –±—ñ–ª–∏–º –≤—ñ–¥–±–∏–≤–∞—á–µ–º, –æ—Ü—ñ–Ω–∏—Ç–∏ –±–∏—Ç—Ç—è/–µ–∫—Å—Ü–µ–Ω—Ç—Ä–∏—Å–∏—Ç–µ—Ç, ¬´–∑–∞–º–æ—Ä–æ–∑–∏—Ç–∏¬ª –æ–±–µ—Ä—Ç —Å—Ç—Ä–æ–±–æ—Å–∫–æ–ø–æ–º (–µ–∫—Ä–∞–Ω/–∞—É"><meta property="og:url" content="https://edlab.pp.ua/mech_II_kyrs/mechanic_para19.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"–ú–µ—Ö–∞–Ω—ñ–∑–∞—Ü—ñ—è ‚Äî –ü–∞—Ä–∞ 19","description":"–ú–µ—Ç–∞: –≤–∏–º—ñ—Ä—è—Ç–∏ –æ–±–µ—Ä—Ç–∏ (RPM) –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞/—à–∫—ñ–≤–∞/–í–í–ü –∑–∞ –≤–µ–±–∫–∞–º–µ—Ä–æ—é –∑ –±—ñ–ª–∏–º –≤—ñ–¥–±–∏–≤–∞—á–µ–º, –æ—Ü—ñ–Ω–∏—Ç–∏ –±–∏—Ç—Ç—è/–µ–∫—Å—Ü–µ–Ω—Ç—Ä–∏—Å–∏—Ç–µ—Ç, ¬´–∑–∞–º–æ—Ä–æ–∑–∏—Ç–∏¬ª –æ–±–µ—Ä—Ç —Å—Ç—Ä–æ–±–æ—Å–∫–æ–ø–æ–º (–µ–∫—Ä–∞–Ω/–∞—É","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/mech_II_kyrs/mechanic_para19.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üé•</span>
      <div>
        <b>–ü–∞—Ä–∞ 19 ‚Äî –í—ñ–∑—É–∞–ª—å–Ω–∏–π —Ç–∞—Ö–æ–º–µ—Ç—Ä —ñ —Å—Ç—Ä–æ–±–æ—Å–∫–æ–ø (–±–µ–∑ Arduino)</b><br>
        <span class="badge">–≤–µ–±–∫–∞–º–µ—Ä–∞ ‚Üí RPM, –±–∏—Ç—Ç—è/–µ–∫—Å—Ü–µ–Ω—Ç—Ä–∏—Å–∏—Ç–µ—Ç ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí –∞—É–¥—ñ–æ/–µ–∫—Ä–∞–Ω-—Å—Ç—Ä–æ–± ‚Üí –∂—É—Ä–Ω–∞–ª ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –≤–∏–º—ñ—Ä—è—Ç–∏ <b>–æ–±–µ—Ä—Ç–∏ (RPM)</b> –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞/—à–∫—ñ–≤–∞/–í–í–ü –∑–∞ <b>–≤–µ–±–∫–∞–º–µ—Ä–æ—é</b> –∑ –±—ñ–ª–∏–º –≤—ñ–¥–±–∏–≤–∞—á–µ–º, –æ—Ü—ñ–Ω–∏—Ç–∏ <b>–±–∏—Ç—Ç—è/–µ–∫—Å—Ü–µ–Ω—Ç—Ä–∏—Å–∏—Ç–µ—Ç</b>, ¬´–∑–∞–º–æ—Ä–æ–∑–∏—Ç–∏¬ª –æ–±–µ—Ä—Ç <b>—Å—Ç—Ä–æ–±–æ—Å–∫–æ–ø–æ–º</b> (–µ–∫—Ä–∞–Ω/–∞—É–¥—ñ–æ), –≤–µ—Å—Ç–∏ –∂—É—Ä–Ω–∞–ª —ñ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç. –ü—Ä–∞—Ü—é—î —É –∫–æ–º–ø‚Äô—é—Ç–µ—Ä–Ω–æ–º—É –∫–ª–∞—Å—ñ –±–µ–∑ Arduino.</p>

  <div class="grid" style="display:grid;gap:14px;grid-template-columns:1.3fr 1fr">
    <!-- –õ–Ü–í–û: –≤—ñ–¥–µ–æ + –≥—Ä–∞—Ñ—ñ–∫–∏ -->
    <div class="card">
      <h2>üéõÔ∏è –í—ñ–¥–µ–æ-–¥–∂–µ—Ä–µ–ª–æ</h2>
      <div class="row">
        <div style="flex:1">
          <label>–ö–∞–º–µ—Ä–∞</label>
          <select id="cam" class="input"></select>
        </div>
        <div style="flex:1">
          <label>–†–æ–∑–¥—ñ–ª—å–Ω—ñ—Å—Ç—å</label>
          <select id="res" class="input">
            <option value="640x480">640√ó480</option>
            <option value="1280x720" selected="">1280√ó720</option>
            <option value="1920x1080">1920√ó1080</option>
          </select>
        </div>
        <button class="btn good" id="start">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button class="btn secondary" id="stop">‚è∏Ô∏è –°—Ç–æ–ø</button>
        <span id="stat" class="badge">–°—Ç–∞—Ç—É—Å: idle</span>
      </div>

      <div class="row" style="margin-top:8px">
        <label style="flex:1">–ü–æ—Ä–æ–≥ —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ <input id="thr" class="input" type="range" min="10" max="250" step="1" value="180"></label>
        <label style="flex:1">EMA Œ± (—Å–∏–≥–Ω–∞–ª) <input id="alpha" class="input" type="range" min="0" max="1" step="0.02" value="0.30"></label>
        <label style="flex:1">–î—ñ–∞–º–µ—Ç—Ä –¥–∏—Å–∫–∞, –º–º <input id="diam" class="input" type="number" min="10" step="1" value="300"></label>
      </div>
      <small class="muted">–ü–æ—Ä–∞–¥–∞: –Ω–∞–∫–ª–µ–π 1 —Å–º—É–∂–∫—É –±—ñ–ª–æ—ó/—Å—Ä—ñ–±–Ω–æ—ó —Å—Ç—Ä—ñ—á–∫–∏ –Ω–∞ –¥–∏—Å–∫ –∞–±–æ –ª–æ–ø–∞—Ç—ñ. –ö–ª–∞—Ü–Ω–∏ –ø–æ –≤—ñ–¥–µ–æ ‚Äî —Ü–µ —Å—Ç–∞–Ω–µ —Ü–µ–Ω—Ç—Ä–æ–º ROI.</small>

      <div class="canvasWrap" style="margin-top:8px">
        <canvas id="view" width="960" height="540"></canvas>
      </div>

      <h3 style="margin-top:12px">üìà –ñ–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫</h3>
      <div class="canvasWrap"><canvas id="chart" width="960" height="260"></canvas></div>
      <div class="row small" style="margin-top:8px">
        <span id="last" class="badge">RPM=‚Äî; –ø–µ—Ä—ñ–æ–¥=‚Äî –º—Å; –±–∏—Ç—Ç—è=‚Äî –º–º</span>
        <span id="quality" class="badge">–Ø–∫—ñ—Å—Ç—å —Å–∏–≥–Ω–∞–ª—É: ‚Äî</span>
      </div>
    </div>

    <!-- –ü–†–ê–í–û: —Å—Ç—Ä–æ–±, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –∂—É—Ä–Ω–∞–ª -->
    <div class="card">
      <h2>üí° –°—Ç—Ä–æ–±–æ—Å–∫–æ–ø</h2>
      <div class="row">
        <div style="flex:1">
          <label>–¶—ñ–ª—å RPM</label>
          <input id="targetRPM" class="input" type="number" step="1" value="600">
        </div>
        <div style="flex:1">
          <label>–ì–∞—Ä–º–æ–Ω—ñ–∫–∞</label>
          <select id="harm" class="input"><option value="1" selected="">1√ó</option><option value="2">2√ó</option><option value="3">3√ó</option><option value="0.5">¬Ω√ó</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="flash">üñ•Ô∏è –ï–∫—Ä–∞–Ω-—Å—Ç—Ä–æ–±</button>
        <button class="btn" id="beep">üîä –ê—É–¥—ñ–æ-—Å—Ç—Ä–æ–±</button>
        <button class="btn secondary" id="stopStrobe">‚èπÔ∏è –°—Ç–æ–ø</button>
      </div>
      <div class="row small" style="margin-top:8px">
        <span id="sync" class="badge">ŒîRPM –¥–æ —Ü—ñ–ª—ñ: ‚Äî</span>
      </div>

      <h2 style="margin-top:14px">üß† –û—Ü—ñ–Ω–∫–∏ —Ç–∞ –ø–æ–¥—ñ—ó</h2>
      <table class="tbl">
        <tbody>
          <tr><th>RPM (–º–µ–¥—ñ–∞–Ω–∞ 5—Å)</th><td id="rpmMed">‚Äî</td></tr>
          <tr><th>–ë–∏—Ç—Ç—è, –º–º (RMS)</th><td id="runout">‚Äî</td></tr>
          <tr><th>–ü–æ—Ä—ñ–≥ —Ç—Ä–∏–≤–æ–≥–∏ –±–∏—Ç—Ç—è, –º–º</th><td><input id="runThr" class="input" type="number" step="0.1" value="0.8"></td></tr>
        </tbody>
      </table>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="mark">üìå –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –ø–æ–¥—ñ—é</button>
        <select id="label" class="input" style="max-width:240px">
          <option value="ok" selected="">ok</option>
          <option value="belt_slip">–∫–æ–≤–∑–∞–Ω–Ω—è —Ä–µ–º–µ–Ω—è</option>
          <option value="misalignment">–Ω–µ–ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å</option>
          <option value="bearing">–ø—ñ–¥—à–∏–ø–Ω–∏–∫</option>
        </select>
      </div>

      <h3 style="margin-top:10px">üìú –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="code" style="max-height:200px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –∑–∞–ø–∏—Å—ñ–≤</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <button class="btn" id="savePng">üñºÔ∏è PNG (–≥—Ä–∞—Ñ—ñ–∫+–∫–∞–¥—Ä)</button>
        <button class="btn" id="saveCsv">üìÑ CSV (—Å–µ—Ä—ñ—ó)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn secondary" id="receipt">üñ®Ô∏è 58 –º–º —á–µ–∫</button>
      </div>
      <div id="rc" class="receipt" hidden=""></div>
    </div>
  </div>

  <div class="card">
    <h2>üîå –°—Ö–µ–º–∞ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è (SVG)</h2>
    <svg viewBox="0 0 980 300" role="img" aria-label="–í–µ–±–∫–∞–º–µ—Ä–∞ ‚Üí –¥–∏—Å–∫/—à–∫—ñ–≤ —ñ–∑ –º–∞—Ä–∫–µ—Ä–æ–º">
      <rect x="40" y="40" width="260" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"></rect>
      <text x="170" y="70" fill="#e5e7eb" font-size="16" text-anchor="middle">–ù–æ—É—Ç–±—É–∫/–ü–ö</text>
      <text x="170" y="92" fill="#93c5fd" font-size="12" text-anchor="middle">–≤–µ–±–∫–∞–º–µ—Ä–∞ 30‚Äì60 fps</text>
      <line x1="300" y1="100" x2="420" y2="100" stroke="#93c5fd" stroke-width="3"></line>
      <circle cx="480" cy="100" r="8" fill="#22c55e"></circle>
      <text x="520" y="90" fill="#a7f3d0" font-size="12">–≤—ñ–¥—Å—Ç–∞–Ω—å 30‚Äì80 —Å–º</text>

      <circle cx="760" cy="120" r="70" fill="#111827" stroke="#9ca3af"></circle>
      <path d="M760 50 A70 70 0 0 1 830 120 L760 120 Z" fill="#e5e7eb"></path>
      <text x="760" y="210" fill="#e5e7eb" font-size="14" text-anchor="middle">—à–∫—ñ–≤/–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä</text>
      <text x="760" y="228" fill="#93c5fd" font-size="12" text-anchor="middle">–±—ñ–ª–∞ —Å–º—É–∂–∫–∞ = –≤—ñ–¥–±–∏–≤–∞—á</text>

      <text x="120" y="250" fill="#fbbf24" font-size="12">‚ö†Ô∏è –ë–µ–∑–ø–µ–∫–∞: –Ω–µ –ø—ñ–¥–Ω–æ—Å–∏—Ç–∏ —Ä—É–∫–∏/–∫–∞–º–µ—Ä—É –±–ª–∏–∑—å–∫–æ –¥–æ –æ–±–µ—Ä—Ç–æ–≤–∏—Ö –≤—É–∑–ª—ñ–≤; —Ñ—ñ–∫—Å—É–π —à—Ç–∞—Ç–∏–≤/–Ω–æ—É—Ç–±—É–∫.</text>
    </svg>
  </div>

  <div class="card">
    <h2>üìã –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –∑–≤—ñ—Ç—É</h2>
    <ul>
      <li>PNG —ñ–∑ –∫–∞–¥—Ä–æ–º + –≥—Ä–∞—Ñ—ñ–∫ (RPM, —Å–∏–≥–Ω–∞–ª), –ø–æ–∑–Ω–∞—á–µ–Ω—ñ –ø–æ–¥—ñ—ó.</li>
      <li>CSV 1‚Äì2 —Ö–≤ –≤–∏–º—ñ—Ä—ñ–≤ (—á–∞—Å, —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å, RPM, –±–∏—Ç—Ç—è).</li>
      <li>–í–∏—Å–Ω–æ–≤–æ–∫: —á–∏ –≤ –º–µ–∂–∞—Ö –±–∏—Ç—Ç—è; —â–æ —Ä–æ–±–∏—Ç–∏ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—Ç—è–≥—É/–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—Å—Ç—ñ/–ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤/–±–∞–ª–∞–Ω—Å—É).</li>
    </ul>
  </div>

  <div class="card">
    <h2>üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
    <p class="muted small">–°—Ç—Ä–æ–±–æ—Å–∫–æ–ø–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è –∑‚Äô—è–≤–∏–ª–∏—Å—è –≤ 1930-—Ö —É –∞–≤—ñ–∞—Ü—ñ—ó. –°—å–æ–≥–æ–¥–Ω—ñ –±—É–¥—å-—è–∫–∏–π –Ω–æ—É—Ç–±—É–∫ —ñ–∑ –∫–∞–º–µ—Ä–æ—é –¥–∞—î —Ç–∞—Ö–æ–º–µ—Ç—Ä —ñ —Å—Ç—Ä–æ–± –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ ‚Äî —Ü—å–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ, —â–æ–± –≤–∏—è–≤–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏ —â–µ –¥–æ –∑–∞–ø–∞—Ö—É –≥—É–º–∏ —á–∏ –ø–µ—Ä–µ–≥—Ä—ñ–≤—É.</p>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<div id="flashLayer" class="fullflash"></div>

<script>
// ========= –£—Ç–∏–ª—ñ—Ç–∏ =========
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}

// ========= –í—ñ–¥–µ–æ/–∫–∞–º–µ—Ä–∞ =========
let stream=null, video=null, vCanvas=$('#view'), vctx=vCanvas.getContext('2d');
let reqId=null, fps=0, lastFpsT=0, frames=0;

const camSel=$('#cam');
async function listCams(){
  const devs=await navigator.mediaDevices.enumerateDevices();
  const cams=devs.filter(d=>d.kind==='videoinput');
  camSel.innerHTML=''; cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=(c.label||('–ö–∞–º–µ—Ä–∞ '+(i+1))); camSel.appendChild(o); });
}
listCams().catch(()=>{});

// ROI
let roi={x: vCanvas.width*0.5, y: vCanvas.height*0.5, r: 60};
vCanvas.addEventListener('click',(e)=>{
  const rect=vCanvas.getBoundingClientRect();
  roi.x = (e.clientX - rect.left) * (vCanvas.width/rect.width);
  roi.y = (e.clientY - rect.top) * (vCanvas.height/rect.height);
});

// ========= –î–∞–Ω—ñ/—Å–µ—Ä—ñ—ó =========
const sGraph=$('#chart'), gctx=sGraph.getContext('2d');
const series=[]; // {t, sig, rpm, runout}
const rpmWindow=[]; // –æ—Å—Ç–∞–Ω–Ω—ñ N –∑–Ω–∞—á–µ–Ω—å –¥–ª—è –º–µ–¥—ñ–∞–Ω–∏
const timeSig=[]; // –¥–ª—è –¥–µ—Ç–µ–∫—Ü—ñ—ó –ø–µ—Ä—ñ–æ–¥—É (–æ—Å—Ç–∞–Ω–Ω—ñ 8 c–µ–∫)
const peakTimes=[];

function ema(prev, val, a){ return (prev==null)? val : a*val + (1-a)*prev; }

// ========= –û—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ =========
let emaSig=null, lastFrame=0, lastPeak=0;

// ========= –û–±—á–∏—Å–ª–µ–Ω–Ω—è –∫–∞–¥—Ä—É =========
function processFrame(){
  if(!video) return;
  const W=vCanvas.width, H=vCanvas.height;
  vctx.drawImage(video, 0,0,W,H);

  // –í–∏–¥—ñ–ª–µ–Ω–Ω—è ROI
  vctx.beginPath(); vctx.strokeStyle='#38bdf8'; vctx.lineWidth=2; vctx.arc(roi.x, roi.y, roi.r, 0, Math.PI*2); vctx.stroke();
  vctx.fillStyle='rgba(56,189,248,0.12)'; vctx.beginPath(); vctx.arc(roi.x, roi.y, roi.r, 0, Math.PI*2); vctx.fill();

  // –Ø—Å–∫—Ä–∞–≤—ñ—Å—Ç—å —É ROI + —Ü–µ–Ω—Ç—Ä –º–∞—Å
  const r=Math.floor(roi.r), x0=Math.max(0, Math.floor(roi.x-r)), y0=Math.max(0, Math.floor(roi.y-r));
  const x1=Math.min(W-1, Math.floor(roi.x+r)), y1=Math.min(H-1, Math.floor(roi.y+r));
  const img=vctx.getImageData(x0,y0, x1-x0+1, y1-y0+1);
  const thr=parseInt($('#thr').value,10);
  let sum=0, cnt=0, cx=0, cy=0, brightCount=0, cxB=0, cyB=0;

  for(let j=0;j<img.height;j++){
    for(let i=0;i<img.width;i++){
      const k=(j*img.width+i)*4;
      const r=img.data[k], g=img.data[k+1], b=img.data[k+2];
      const Y=(0.2126*r + 0.7152*g + 0.0722*b);
      const X=i+x0, Yp=j+y0;
      // –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–ª–∞?
      if((X-roi.x)*(X-roi.x)+(Yp-roi.y)*(Yp-roi.y) <= roi.r*roi.r){
        sum+=Y; cnt++; cx+=X; cy+=Yp;
        if(Y>thr){ brightCount++; cxB+=X; cyB+=Yp; }
      }
    }
  }
  const meanY = (cnt>0) ? sum/cnt : 0;
  const alpha=parseFloat($('#alpha').value)||0.3;
  emaSig = ema(emaSig, meanY, alpha);

  let spotX=roi.x, spotY=roi.y;
  if(brightCount>10){ spotX=cxB/brightCount; spotY=cyB/brightCount; }

  // ¬´–ë–∏—Ç—Ç—è¬ª: RMS –∫–æ–ª–∏–≤–∞–Ω–Ω—è –ø–æ–ª–æ–∂–µ–Ω–Ω—è —è—Å–∫—Ä–∞–≤–æ—ó –ø–ª—è–º–∏ –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É ROI ‚Üí —É –ø—ñ–∫—Å–µ–ª—è—Ö ‚Üí –º–º
  const pxFromCenter = Math.hypot(spotX-roi.x, spotY-roi.y);
  const diamMM = parseFloat($('#diam').value)||300;
  // –º–∞—Å—à—Ç–∞–± –º–º/–ø—ñ–∫—Å–µ–ª—å: –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ roi.r –ø—ñ–∫—Å–µ–ª—ñ–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î (diamMM/2) –º–º
  const mmPerPx = (diamMM/2) / roi.r;
  const runoutNow = pxFromCenter * mmPerPx;

  // –î–µ—Ç–µ–∫—Ü—ñ—è –ø—ñ–∫—ñ–≤ —Å–∏–≥–Ω–∞–ª—É (–ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –ø–æ—Ä–æ–≥–∞ —ñ –ø–µ—Ä–µ—Ö—ñ–¥ –∑–≥–æ—Ä–∏ –≤–Ω–∏–∑)
  const t=performance.now();
  timeSig.push({t, y:emaSig}); if(timeSig.length>800) timeSig.shift();

  const L=timeSig.length;
  let rpmInst=series.length? series[series.length-1].rpm : 0;

  if(L>=3){
    const y2=timeSig[L-1].y, y1=timeSig[L-2].y, y0=timeSig[L-3].y;
    const TH= (thr + 255)/2; // —É —à–∫–∞–ª—ñ ~0..255
    // –ª–æ–∫–∞–ª—å–Ω–∏–π –º–∞–∫—Å–∏–º—É–º –ø–æ–±–ª–∏–∑—É –ø–æ—Ä–æ–≥–∞
    if(y1>y0 && y1>y2 && y1>TH){
      const tPeak=timeSig[L-2].t;
      if(tPeak - lastPeak > 40){ // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª ~25 –ì—Ü
        peakTimes.push(tPeak);
        if(peakTimes.length>8) peakTimes.shift();
        if(peakTimes.length>=2){
          let periods=0, n=0;
          for(let i=1;i<peakTimes.length;i++){ periods += (peakTimes[i]-peakTimes[i-1]); n++; }
          const meanP = periods/n; // –º—Å
          rpmInst = 60000.0/meanP;
          lastPeak=tPeak;
        }
      }
    }
  }

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—ñ–π
  const point={t:Date.now(), sig:emaSig, rpm:rpmInst, runout:runoutNow};
  series.push(point); if(series.length>1200) series.shift();
  rpmWindow.push(rpmInst); if(rpmWindow.length>200) rpmWindow.shift();

  drawGraph();

  // –¢–µ–∫—Å—Ç–æ–≤—ñ –±–µ–π–¥–∂—ñ
  const med = rpmWindow.slice().sort((a,b)=>a-b)[Math.floor(rpmWindow.length/2)]||0;
  $('#rpmMed').textContent = med ? med.toFixed(1) : '‚Äî';
  $('#runout').textContent = stdRunout().toFixed(2);
  $('#last').textContent = `RPM=${rpmInst?rpmInst.toFixed(1):'‚Äî'}; –ø–µ—Ä—ñ–æ–¥=${rpmInst?(60000/rpmInst).toFixed(1):'‚Äî'} –º—Å; –±–∏—Ç—Ç—è=${runoutNow.toFixed(2)} –º–º`;
  $('#quality').textContent = `–Ø–∫—ñ—Å—Ç—å —Å–∏–≥–Ω–∞–ª—É: ${brightCount>10?'ok':'—Å–ª–∞–±–∫–∏–π'} | fps‚âà${fps.toFixed(0)}`;

  // –¢—Ä–∏–≤–æ–≥–∞ –ø–æ –±–∏—Ç—Ç—é
  const thrRun=parseFloat($('#runThr').value)||0.8;
  if(runoutNow>thrRun){
    log(`‚ö†Ô∏è –ë–∏—Ç—Ç—è –ø–µ—Ä–µ–≤–∏—â—É—î –ø–æ—Ä—ñ–≥: ${runoutNow.toFixed(2)} –º–º (–ø–æ—Ä—ñ–≥ ${thrRun} –º–º)`);
  }

  // fps
  frames++; const now=performance.now();
  if(now-lastFpsT>1000){ fps=frames*1000/(now-lastFpsT); lastFpsT=now; frames=0; }
}

function drawGraph(){
  const W=sGraph.width,H=sGraph.height;
  gctx.clearRect(0,0,W,H);
  gctx.strokeStyle='#223049'; gctx.strokeRect(0.5,0.5,W-1,H-1);
  if(series.length<3) return;
  const maxN=600;
  const s=series.slice(-maxN);
  const xs=s.map((_,i)=> 60 + i*((W-80)/(maxN-1)));

  // –ù–æ—Ä–º—É–≤–∞–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—É (0..255)
  const minY = Math.min(...s.map(o=>o.sig)), maxY=Math.max(...s.map(o=>o.sig));
  gctx.fillStyle='#94a3b8'; gctx.font='12px ui-monospace';
  gctx.fillText('Signal (Y)', 12, 14); gctx.fillText('RPM', 12, 28);

  // Signal
  gctx.beginPath(); gctx.strokeStyle='#38bdf8'; gctx.lineWidth=1.6;
  xs.forEach((x,i)=>{ const v=s[i].sig; const y=H-10 - ((v-minY)/Math.max(1,(maxY-minY))) * (H-20); i?gctx.lineTo(x,y):gctx.moveTo(x,y); });
  gctx.stroke();

  // RPM (–≤—Ç–æ—Ä. —à–∫–∞–ª–∞)
  const rpmMax = Math.max(100, Math.max(...s.map(o=>o.rpm||0))*1.2);
  gctx.beginPath(); gctx.strokeStyle='#fbbf24'; gctx.lineWidth=1.8;
  xs.forEach((x,i)=>{ const v=s[i].rpm||0; const y=H-10 - (v/rpmMax)*(H-20); i?gctx.lineTo(x,y):gctx.moveTo(x,y); });
  gctx.stroke();
}

function stdRunout(){
  const arr=series.slice(-200).map(o=>o.runout);
  if(arr.length<5) return 0;
  const m=arr.reduce((a,b)=>a+b,0)/arr.length;
  const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;
  return Math.sqrt(v);
}

// ========= –ö–∞–º–µ—Ä–∞ –∫–µ—Ä—É–≤–∞–Ω–Ω—è =========
async function startVideo(){
  try{
    const [w,h] = $('#res').value.split('x').map(Number);
    const constraints={video:{deviceId: camSel.value?{exact:camSel.value}:undefined, width:{ideal:w}, height:{ideal:h}}, audio:false};
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video=document.createElement('video'); video.srcObject=stream; video.muted=true; await video.play();
    $('#stat').textContent='–°—Ç–∞—Ç—É—Å: camera ok';

    // –ü—ñ–¥–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∫–∞–Ω–≤–∞—Å
    const vw=video.videoWidth, vh=video.videoHeight;
    vCanvas.width=vw; vCanvas.height=vh;
    sGraph.width=vw; sGraph.height=260;
    roi={x:vw*0.5, y:vh*0.5, r:Math.min(vw,vh)*0.12};

    loop();
  }catch(err){
    alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: '+err.message);
    $('#stat').textContent='–°—Ç–∞—Ç—É—Å: –ø–æ–º–∏–ª–∫–∞';
  }
}
function stopVideo(){
  if(reqId) cancelAnimationFrame(reqId), reqId=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video=null;
  $('#stat').textContent='–°—Ç–∞—Ç—É—Å: idle';
}
function loop(){
  processFrame();
  reqId = requestAnimationFrame(loop);
}

// ========= –°—Ç—Ä–æ–±–æ—Å–∫–æ–ø =========
let actx=null, osc=null, flashTimer=null;
function strobeHz(){
  const rpm=parseFloat($('#targetRPM').value)||600;
  const k=parseFloat($('#harm').value)||1;
  return (rpm/60)*k;
}
function startBeep(){
  if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)();
  const hz=strobeHz();
  osc=actx.createOscillator(); const g=actx.createGain(); g.gain.value=0.2;
  osc.type='square'; osc.frequency.value=hz;
  osc.connect(g).connect(actx.destination); osc.start();
}
function stopBeep(){ try{osc.stop();}catch{} osc=null; }

function startFlash(){
  const layer=$('#flashLayer'); layer.style.display='block';
  const hz=strobeHz();
  const period=1000/hz;
  flashTimer = setInterval(()=>{ layer.style.background = (layer.style.background==='#fff')?'#000':'#fff'; }, period/2);
}
function stopFlash(){
  const layer=$('#flashLayer'); layer.style.display='none'; layer.style.background='#fff';
  if(flashTimer){ clearInterval(flashTimer); flashTimer=null; }
}

// –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –≤–∏–º—ñ—Ä—è–Ω–∏–º RPM
setInterval(()=>{
  const rpm = series.length? (series[series.length-1].rpm||0) : 0;
  if(!rpm) { $('#sync').textContent='ŒîRPM –¥–æ —Ü—ñ–ª—ñ: ‚Äî'; return; }
  const target = parseFloat($('#targetRPM').value)||0;
  $('#sync').textContent = 'ŒîRPM –¥–æ —Ü—ñ–ª—ñ: ' + (rpm-target).toFixed(1);
}, 300);

// ========= –ï–º—É–ª—è—Ç–æ—Ä (–±–µ–∑ –≤—ñ–¥–µ–æ) ‚Äî –¥–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –∞–ª–≥–æ—Ä–∏—Ç–º—É =========
function emulate(){
  // –≥–µ–Ω–µ—Ä—É—î–º–æ ¬´—è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å¬ª —è–∫ —Å–∏–Ω—É—Å + —à—É–º ‚Üí –¥–æ–¥–∞—î–º–æ –≤ —Å–µ—Ä—ñ—ó
  const f= (parseFloat($('#targetRPM').value)||600)/60; // –ì—Ü
  let t0=performance.now();
  function tick(){
    if(stream || video) return; // —è–∫—â–æ –≤–∂–µ –∫–∞–º–µ—Ä–∞ ‚Äî –µ–º—É–ª—å –Ω–µ –∫—Ä—É—Ç–∏—Ç–∏
    const t=performance.now(); const dt=(t-t0)/1000; t0=t;
    const sig = 200 + 40*Math.sin(2*Math.PI*f*(t/1000)) + (Math.random()*8-4);
    const rpm = (f*60) + (Math.random()*1-0.5);
    const run = Math.abs(2*Math.sin(2*Math.PI*0.9*(t/1000))) + Math.random()*0.1;
    series.push({t:Date.now(), sig, rpm, runout:run}); if(series.length>1200) series.shift();
    drawGraph();
    reqId=requestAnimationFrame(tick);
  }
  tick();
}

// ========= –ñ—É—Ä–Ω–∞–ª/–µ–∫—Å–ø–æ—Ä—Ç =========
const logbook=[];
function log(msg){ const t=new Date().toLocaleTimeString(); const box=$('#alog'); if(box.textContent.startsWith('//')) box.textContent=''; box.textContent+=`[${t}] ${msg}\n`; box.scrollTop=box.scrollHeight; logbook.push({t,msg}); }

$('#mark').addEventListener('click', ()=>{
  const y=$('#label').value;
  const p=series[series.length-1]||{rpm:0,runout:0};
  log(`–ü–æ–∑–Ω–∞—á–∫–∞: ${y} | RPM=${(p.rpm||0).toFixed(1)} | –±–∏—Ç—Ç—è=${(p.runout||0).toFixed(2)} –º–º`);
});

$('#savePng').addEventListener('click', ()=>{
  // —Å–∫–ª–µ–π–∫–∞ –∫–∞–¥—Ä—É + –≥—Ä–∞—Ñ—ñ–∫–∞
  const tmp=document.createElement('canvas'); tmp.width=vCanvas.width; tmp.height=vCanvas.height + sGraph.height + 10;
  const tctx=tmp.getContext('2d'); tctx.drawImage(vCanvas,0,0); tctx.drawImage(sGraph,0,vCanvas.height+10);
  tmp.toBlob(b=>{ const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='mech_para19_frame_'+stamp()+'.png'; a.click(); URL.revokeObjectURL(u); });
});

$('#saveCsv').addEventListener('click', ()=>{
  const head='t_iso,signal,rpm,runout_mm\n';
  const body=series.map(o=> `${new Date(o.t).toISOString()},${o.sig.toFixed(2)},${(o.rpm||0).toFixed(2)},${(o.runout||0).toFixed(3)}`).join('\n');
  download('mechanic_para19_series_'+stamp()+'.csv', head+body, 'text/csv');
});

$('#saveTxt').addEventListener('click', ()=>{
  const rpmMed=$('#rpmMed').textContent, run=$('#runout').textContent;
  const lines=['–ü–∞—Ä–∞ 19 ‚Äî –í—ñ–∑—É–∞–ª—å–Ω–∏–π —Ç–∞—Ö–æ–º–µ—Ç—Ä —ñ —Å—Ç—Ä–æ–±–æ—Å–∫–æ–ø','–ü—ñ–¥—Å—É–º–æ–∫:','RPM (–º–µ–¥—ñ–∞–Ω–∞ 5—Å): '+rpmMed,'–ë–∏—Ç—Ç—è (RMS): '+run+' –º–º','---','–ñ—É—Ä–Ω–∞–ª:'];
  logbook.forEach(l=>lines.push(`[${l.t}] ${l.msg}`));
  download('mechanic_para19_summary_'+stamp()+'.txt', lines.join('\n'));
});

$('#receipt').addEventListener('click', ()=>{
  const items=logbook.slice(-10);
  const lines=['=== –ß–ï–ö –í–Ü–ó–£–ê–õ.–¢–ê–•–û–ú–ï–¢–†–ê (58–º–º) ===','–î–∞—Ç–∞: '+new Date().toISOString().slice(0,10),'---'];
  if(items.length===0){ lines.push('–ü–æ–¥—ñ–π –Ω–µ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ'); } else { items.forEach(l=>lines.push(`[${l.t}] ${l.msg}`)); }
  const el=$('#rc'); el.hidden=false; el.textContent=lines.join('\n');
  download('para19_receipt_'+stamp()+'.txt', lines.join('\n'));
});

// ========= –ü–æ–¥—ñ—ó UI =========
$('#start').addEventListener('click', ()=>{ if(stream) return; startVideo(); });
$('#stop').addEventListener('click', ()=>{ stopVideo(); stopBeep(); stopFlash(); });
$('#flash').addEventListener('click', ()=>{ stopFlash(); startFlash(); log('–ï–∫—Ä–∞–Ω-—Å—Ç—Ä–æ–± —É–≤—ñ–º–∫–Ω–µ–Ω–æ @ '+strobeHz().toFixed(1)+' –ì—Ü'); });
$('#beep').addEventListener('click', ()=>{ stopBeep(); startBeep(); log('–ê—É–¥—ñ–æ-—Å—Ç—Ä–æ–± —É–≤—ñ–º–∫–Ω–µ–Ω–æ @ '+strobeHz().toFixed(1)+' –ì—Ü'); });
$('#stopStrobe').addEventListener('click', ()=>{ stopBeep(); stopFlash(); log('–°—Ç—Ä–æ–±–æ—Å–∫–æ–ø –≤–∏–º–∫–Ω–µ–Ω–æ'); });

// ========= –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =========
if (window.self !== window.top) document.documentElement.classList.add('embedded'); // LMS-friendly
// –Ø–∫—â–æ –∫–∞–º–µ—Ä–∏ –Ω–µ–º–∞—î ‚Äî –¥–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–æ—Ç—Ä–µ–Ω—É–≤–∞—Ç–∏—Å—å –Ω–∞ –µ–º—É–ª—è—Ç–æ—Ä—ñ:
setTimeout(()=>{ if(!stream) emulate(); }, 1000);
</script>


</body></html>