<!-- mechanic_para4.html
     –ü–ê–†–ê 4 (–∞—É–¥–∏—Ç–æ—Ä–Ω–æ) –¥–ª—è –º–µ—Ö–∞–Ω—ñ–∫—ñ–≤
     –¢–µ–º–∞: –ü–†–ò–í–û–î–ò –¢–ê –û–ë–ï–†–¢–ò ‚Äî –í–í–ü (PTO), —Ä–µ–º—ñ–Ω–Ω—ñ/–ª–∞–Ω—Ü—é–≥–æ–≤—ñ –ø–µ—Ä–µ–¥–∞—á—ñ, –ø–µ—Ä–µ–¥–∞—Ç–Ω—ñ —á–∏—Å–ª–∞, –æ–±–µ—Ä—Ç–∏, –ª—ñ–Ω—ñ–π–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å, –ø—ñ–¥–±—ñ—Ä —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫
     –§–æ–∫—É—Å: —Ç–µ–ª–µ—Ñ–æ–Ω–∏/–ü–ö; –±–µ–∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫; –ª–æ–∫–∞–ª—å–Ω–æ; –ø—Ä–∞—Ü—é—î –Ω–∞ GitHub Pages —ñ –≤ Moodle (iframe).
     –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è: —Ç–µ–ª–µ—Ñ–æ–Ω–∏, —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä 58 –º–º (–æ–ø—Ü.), NFC-–º—ñ—Ç–∫–∏ (–æ–ø—Ü.).

     –©–æ –≤–º—ñ—î:
     ‚Ä¢ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ–±–µ—Ä—Ç—ñ–≤ –≤–µ–¥–µ–Ω–æ—ó –≤–∞–ª–∏/–º–µ—Ö–∞–Ω—ñ–∑–º—É –≤—ñ–¥ –¥–≤–∏–≥—É–Ω–∞ –∞–±–æ –í–í–ü 540/1000.
     ‚Ä¢ –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –≤—É–∑–ª–∞: —Ç–∏–ø –ø—Ä–∏–≤–æ–¥—É (–ø—Ä—è–º–∏–π/—Ä–µ–º—ñ–Ω—å/–ª–∞–Ω—Ü—é–≥), –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (–¥—ñ–∞–º–µ—Ç—Ä–∏ —à–∫—ñ–≤—ñ–≤ –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑—É–±—ñ–≤), –∫–æ–ª–æ/–¥—ñ–∞–º–µ—Ç—Ä –±–∞—Ä–∞–±–∞–Ω–∞.
     ‚Ä¢ –û–±—á–∏—Å–ª–µ–Ω–Ω—è –ª—ñ–Ω—ñ–π–Ω–æ—ó —à–≤–∏–¥–∫–æ—Å—Ç—ñ –∫–æ–Ω–≤–µ—î—Ä–∞/–≤–∞–ª–∏–∫–∞; –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ —Ü—ñ–ª—å–æ–≤–æ—é (rpm –∞–±–æ –º/—Å).
     ‚Ä¢ –ü—ñ–¥–±—ñ—Ä: –ø–æ—Ç—Ä—ñ–±–Ω—ñ –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ –ø—ñ–¥ —Ü—ñ–ª—å, –∞–±–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è –±–ª–∏–∑—å–∫–æ—ó –ø–∞—Ä–∏ —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫ (—ñ–∑ –∑–∞–¥–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É).
     ‚Ä¢ –ö–≤–∏—Ç–æ–∫ 58 –º–º ¬´–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏–≤–æ–¥—É¬ª —Ç–∞ NFC-—Ç–µ–∫—Å—Ç; –µ–∫—Å–ø–æ—Ä—Ç CSV.

     –§–æ—Ä–º—É–ª–∏ (–Ω–∞–≤—á–∞–ª—å–Ω–æ):
     ‚Ä¢ –î–ª—è —Ä–µ–º–µ–Ω—è: i = œâ–≤–∏—Ö/œâ–≤—Ö = D–≤–µ–¥—É—á–æ–≥–æ / D–≤–µ–¥–µ–Ω–æ–≥–æ  (–∑–∞ –¥—ñ–∞–º–µ—Ç—Ä–∞–º–∏ —à–∫—ñ–≤—ñ–≤)
     ‚Ä¢ –î–ª—è –ª–∞–Ω—Ü—é–≥–∞: i = z–≤–µ–¥—É—á–æ—ó / z–≤–µ–¥–µ–Ω–æ—ó  (–∑–∞ —á–∏—Å–ª–æ–º –∑—É–±—ñ–≤)
     ‚Ä¢ œâ–≤–∏—Ö = œâ–≤—Ö √ó i;  v–ª—ñ–Ω = (œÄ¬∑D–±–∞—Ä–∞–±–∞–Ω–∞) √ó œâ–≤–∏—Ö / 60
--><!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 4 (–º–µ—Ö–∞–Ω—ñ–∫–∏) ‚Äî –ü—Ä–∏–≤–æ–¥–∏: –í–í–ü, —Ä–µ–º–µ–Ω—ñ/–ª–∞–Ω—Ü—é–≥–∏, rpm, –º/—Å, –ø—ñ–¥–±—ñ—Ä —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫, —á–µ–∫ 58 –º–º, NFC</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
    --accent:#22c55e; --accent-2:#60a5fa; --warn:#f59e0b; --bad:#ef4444; --good:#10b981; --line:#1f2937;
    --darkcell:#0b1324; --darkink:#e6eef9; --darkink2:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#0b1220,#111827 30%,#0b1220);
    color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; line-height:1.55
  }
  .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 64px}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); background:#0b1220; border-radius:999px; font-size:12px; color:var(--muted); letter-spacing:.3px}
  h1{font-size:34px; margin:6px 0 12px; line-height:1.15;
     background:linear-gradient(90deg,#60a5fa,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{font-size:22px; margin:28px 0 12px}
  h3{font-size:18px; margin:20px 0 8px; color:#cbd5e1}
  p{margin:10px 0}
  .small{font-size:12px; color:#9fb0c8}
  .muted{color:#93a3b5}
  .pill{display:inline-block; padding:4px 10px; border:1px solid #223049; border-radius:999px; font-size:12px; color:#a5b4fc; background:#0d1a2e; margin-right:6px}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#dbeafe; text-decoration:none; cursor:pointer}
  .btn:hover{background:#0f1f39}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1000px){.g2,.g3{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg,#0f172a,#0b1220); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .box{border:1px solid #223049; border-radius:12px; padding:12px; background:var(--darkcell); color:var(--darkink)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .mono,code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  .table{width:100%; border-collapse:separate; border-spacing:0; overflow:auto; border-radius:12px; border:1px solid #223049}
  .table th,.table td{padding:8px 10px; border-bottom:1px solid #1f2937; font-size:14px; vertical-align:top}
  .table thead th{background:#0c1629; color:#a5b4fc; text-align:left; position:sticky; top:0}
  .table tbody tr:nth-child(even){background:var(--darkcell); color:var(--darkink2)}
  .table td.dark, .table th.dark{background:var(--darkcell) !important; color:var(--darkink2) !important}
  .out{background:var(--darkcell); color:var(--darkink2); border:1px dashed #263042; padding:10px 12px; border-radius:10px; word-break:break-all}

  input[type="text"], input[type="number"], input[type="date"], select, textarea{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid #223049; background:#0d1a2e; color:#e6eef9
  }

  /* –ß–µ–∫ 58 –º–º */
  .ticket{ width:58mm; background:#fff; color:#000; padding:6mm 4mm; border-radius:6px; box-shadow:0 0 0 1px #e5e7eb inset; font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px; font-size:13px; text-align:center}
  .ticket p{margin:2px 0; font-size:12px}
  .ticket .line{border-top:1px dashed #111; margin:6px 0}
  .ticket small{font-size:10px}

  /* –í–±—É–¥–æ–≤–∞–Ω–æ (iframe) ‚Üí —Å–≤—ñ—Ç–ª–∏–π –≤–∏–≥–ª—è–¥ */
  html.embedded body{background:#fff; color:#111}
  html.embedded .card{background:#fff; border:1px solid #e5e7eb; box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial; background:none; color:#111}
  html.embedded .btn{background:#111827; color:#fff; border-color:#111827}
  html.embedded .box{background:#f8fafc; color:#111}
  html.embedded .table tbody tr:nth-child(even){background:#f3f4f6; color:#111}

  @media print{
    @page{ margin:4mm }
    .no-print{ display:none !important }
  }
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

<meta name="description" content="–ó–∞ –ø–∞—Ä—É —Å—Ç—É–¥–µ–Ω—Ç–∏ –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö –≤—É–∑–ª—ñ–≤ –ø—Ä–∏–≤–æ–¥—É —Ä–æ–∑—Ä–∞—Ö—É—é—Ç—å –æ–±–µ—Ä—Ç–∏ —Ç–∞ –ª—ñ–Ω—ñ–π–Ω—É —à–≤–∏–¥–∫—ñ—Å—Ç—å, –ø–æ—Ä—ñ–≤–Ω—è—é—Ç—å —ñ–∑ —Ü—ñ–ª—å–æ–≤–∏–º–∏, –ø—ñ–¥–±–µ—Ä—É—Ç—å –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ –∞–±–æ –ø–∞—Ä—É —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á"><link rel="canonical" href="https://edlab.pp.ua/mech_II_kyrs/mechanic_para4.html"><meta property="og:type" content="article"><meta property="og:title" content="‚öôÔ∏è –ü—Ä–∏–≤–æ–¥–∏: –í–í–ü, —Ä–µ–º–µ–Ω—ñ/–ª–∞–Ω—Ü—é–≥–∏ ‚Üí rpm, –º/—Å, –ø—ñ–¥–±—ñ—Ä —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫, —á–µ–∫ 58 –º–º, NFC"><meta property="og:description" content="–ó–∞ –ø–∞—Ä—É —Å—Ç—É–¥–µ–Ω—Ç–∏ –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö –≤—É–∑–ª—ñ–≤ –ø—Ä–∏–≤–æ–¥—É —Ä–æ–∑—Ä–∞—Ö—É—é—Ç—å –æ–±–µ—Ä—Ç–∏ —Ç–∞ –ª—ñ–Ω—ñ–π–Ω—É —à–≤–∏–¥–∫—ñ—Å—Ç—å, –ø–æ—Ä—ñ–≤–Ω—è—é—Ç—å —ñ–∑ —Ü—ñ–ª—å–æ–≤–∏–º–∏, –ø—ñ–¥–±–µ—Ä—É—Ç—å –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ –∞–±–æ –ø–∞—Ä—É —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á"><meta property="og:url" content="https://edlab.pp.ua/mech_II_kyrs/mechanic_para4.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"‚öôÔ∏è –ü—Ä–∏–≤–æ–¥–∏: –í–í–ü, —Ä–µ–º–µ–Ω—ñ/–ª–∞–Ω—Ü—é–≥–∏ ‚Üí rpm, –º/—Å, –ø—ñ–¥–±—ñ—Ä —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫, —á–µ–∫ 58 –º–º, NFC","description":"–ó–∞ –ø–∞—Ä—É —Å—Ç—É–¥–µ–Ω—Ç–∏ –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö –≤—É–∑–ª—ñ–≤ –ø—Ä–∏–≤–æ–¥—É —Ä–æ–∑—Ä–∞—Ö—É—é—Ç—å –æ–±–µ—Ä—Ç–∏ —Ç–∞ –ª—ñ–Ω—ñ–π–Ω—É —à–≤–∏–¥–∫—ñ—Å—Ç—å, –ø–æ—Ä—ñ–≤–Ω—è—é—Ç—å —ñ–∑ —Ü—ñ–ª—å–æ–≤–∏–º–∏, –ø—ñ–¥–±–µ—Ä—É—Ç—å –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ –∞–±–æ –ø–∞—Ä—É —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/mech_II_kyrs/mechanic_para4.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
  <div class="wrap">
    <span class="badge">–ü–∞—Ä–∞ 4 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ ¬∑ –º–µ—Ö–∞–Ω—ñ–∫–∏</span>
    <h1>‚öôÔ∏è –ü—Ä–∏–≤–æ–¥–∏: –í–í–ü, —Ä–µ–º–µ–Ω—ñ/–ª–∞–Ω—Ü—é–≥–∏ ‚Üí rpm, –º/—Å, –ø—ñ–¥–±—ñ—Ä —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫, —á–µ–∫ 58 –º–º, NFC</h1>

    <div class="card">
      <h2>üéØ –ú–µ—Ç–∞</h2>
      <p>
        –ó–∞ –ø–∞—Ä—É —Å—Ç—É–¥–µ–Ω—Ç–∏ –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö –≤—É–∑–ª—ñ–≤ –ø—Ä–∏–≤–æ–¥—É —Ä–æ–∑—Ä–∞—Ö—É—é—Ç—å <b>–æ–±–µ—Ä—Ç–∏</b> —Ç–∞ <b>–ª—ñ–Ω—ñ–π–Ω—É —à–≤–∏–¥–∫—ñ—Å—Ç—å</b>,
        –ø–æ—Ä—ñ–≤–Ω—è—é—Ç—å —ñ–∑ <b>—Ü—ñ–ª—å–æ–≤–∏–º–∏</b>, –ø—ñ–¥–±–µ—Ä—É—Ç—å <b>–æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞</b> –∞–±–æ <b>–ø–∞—Ä—É —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫</b>,
        —Å—Ñ–æ—Ä–º—É—é—Ç—å <b>–∫–≤–∏—Ç–æ–∫ 58 –º–º</b> —Ç–∞ <b>NFC</b>-—Ç–µ–∫—Å—Ç. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî —É <b>CSV</b>.
      </p>
      <p class="small">PTO: 540 –∞–±–æ 1000 rpm. –î–ª—è –±–µ–∑–ø–µ—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –Ω–µ –ø–µ—Ä–µ–≤–∏—â—É–π—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç–Ω—ñ –æ–±–µ—Ä—Ç–∏ –≤—É–∑–ª–∞.</p>
    </div>

    <!-- –í–•–Ü–î–ù–Ü –î–ê–ù–Ü: –î–í–ò–ì–£–ù / –í–í–ü / –ù–ê–ë–Ü–† –®–ö–Ü–í–Ü–í -->
    <div class="card">
      <h2>üõ†Ô∏è –î–∂–µ—Ä–µ–ª–æ –æ–±–µ—Ä—Ç—ñ–≤ —ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫</h2>
      <div class="grid g3">
        <div class="box">
          <h3>–î–∂–µ—Ä–µ–ª–æ</h3>
          <div class="row">
            <div style="flex:1">
              <label>–†–µ–∂–∏–º</label>
              <select id="srcMode">
                <option value="engine" selected="">–î–≤–∏–≥—É–Ω</option>
                <option value="pto">–í–í–ü (PTO)</option>
              </select>
            </div>
            <div style="flex:1">
              <label>–û–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞, rpm</label>
              <input id="engRpm" type="number" step="10" value="1800">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <div style="flex:1">
              <label>PTO, rpm (—è–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ –í–í–ü)</label>
              <select id="ptoRpm">
                <option value="540">540</option>
                <option value="1000" selected="">1000</option>
              </select>
            </div>
            <div style="flex:1">
              <label>–ü–µ—Ä–µ–¥–∞—Ç–Ω–µ –¥–≤–∏–≥—É–Ω‚ÜíPTO (–¥–æ–≤—ñ–¥–∫–æ–≤–æ)</label>
              <input id="eng2pto" type="number" step="0.01" value="1.88">
            </div>
          </div>
          <p class="small">–ü—Ä–∏ <span class="mono">engine</span> –¥–∂–µ—Ä–µ–ª–æ–º —î <b>engRpm</b>. –ü—Ä–∏ <span class="mono">pto</span> ‚Äî <b>ptoRpm</b>.</p>
        </div>

        <div class="box">
          <h3>–î–æ—Å—Ç—É–ø–Ω—ñ —à–∫—ñ–≤–∏/–∑—ñ—Ä–æ—á–∫–∏ (–ø—ñ–¥–±—ñ—Ä)</h3>
          <p class="small">–ß–µ—Ä–µ–∑ –∫–æ–º—É: <span class="mono">–¥—ñ–∞–º–µ—Ç—Ä–∏ –º–º</span> –¥–ª—è —Ä–µ–º–µ–Ω—è –∞–±–æ <span class="mono">–∑—É–±–∏</span> –¥–ª—è –ª–∞–Ω—Ü—é–≥–∞.</p>
          <div class="row">
            <div style="flex:1"><label>–†–µ–º–µ–Ω—ñ ‚Äî –¥—ñ–∞–º–µ—Ç—Ä–∏, –º–º</label><input id="pulleyList" type="text" value="80,100,120,140,160,180,200"></div>
          </div>
          <div class="row" style="margin-top:6px">
            <div style="flex:1"><label>–ó—ñ—Ä–æ—á–∫–∏ ‚Äî –∑—É–±–∏</label><input id="sprocketList" type="text" value="12,14,15,16,18,20,22,24"></div>
          </div>
          <p class="small">–ü—ñ–¥–±—ñ—Ä —à—É–∫–∞—î –Ω–∞–π–±–ª–∏–∂—á–µ –ø–µ—Ä–µ–¥–∞—Ç–Ω–µ –¥–æ —Ü—ñ–ª—å–æ–≤–∏—Ö –æ–±–µ—Ä—Ç—ñ–≤/—à–≤–∏–¥–∫–æ—Å—Ç—ñ.</p>
        </div>

        <div class="box">
          <h3>–ö–µ—Ä—É–≤–∞–Ω–Ω—è</h3>
          <div class="row">
            <button class="btn" onclick="addRow()">‚ûï –î–æ–¥–∞—Ç–∏ –≤—É–∑–æ–ª</button>
            <button class="btn" onclick="preset()">üß™ –ü—Ä–∏–∫–ª–∞–¥</button>
            <button class="btn" onclick="recalc()">üîÅ –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
            <button class="btn" onclick="copyCSV()">üìã CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–Ø –í–£–ó–õ–Ü–í -->
    <div class="card">
      <h2>üß± –í—É–∑–ª–∏ –ø—Ä–∏–≤–æ–¥—É</h2>
      <div style="overflow:auto">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>–í—É–∑–æ–ª</th>
              <th>–¢–∏–ø</th>
              <th>–í–µ–¥—É—á–∏–π (D –º–º / –∑—É–±–∏)</th>
              <th>–í–µ–¥–µ–Ω–∏–π (D –º–º / –∑—É–±–∏)</th>
              <th>–ë–∞—Ä–∞–±–∞–Ω D, –º–º</th>
              <th>–¶—ñ–ª—å rpm</th>
              <th>–¶—ñ–ª—å –º/—Å</th>
              <th class="dark">i (–≤–∏—Ö/–≤—Ö)</th>
              <th class="dark">rpm –≤–∏—Ö.</th>
              <th class="dark">–º/—Å</th>
              <th class="dark">–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</th>
              <th class="dark">–ü–æ—Ç—Ä. rpm –¥–≤–∏–≥—É–Ω–∞</th>
              <th class="dark">–†–µ–∫–æ–º–µ–Ω–¥. –ø–∞—Ä–∞</th>
              <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
            </tr>
          </thead>
          <tbody id="body"></tbody>
          <tfoot>
            <tr>
              <th class="dark" colspan="9">–°–µ—Ä–µ–¥–Ω—ñ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</th>
              <th class="dark" colspan="2">‚Äî</th>
              <th class="dark" id="avgDev">‚Äî</th>
              <th class="dark" colspan="2">‚Äî</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
      <div id="csv" class="out" style="margin-top:8px">‚Äî</div>
      <p class="small">CSV: <span class="mono"># | –í—É–∑–æ–ª | –¢–∏–ø | –í–µ–¥—É—á–∏–π | –í–µ–¥–µ–Ω–∏–π | D–±–∞—Ä–∞–±–∞–Ω–∞ | –¶—ñ–ª—å_rpm | –¶—ñ–ª—å_–º—Å | i | rpm_–≤–∏—Ö | –º_—Å | –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è% | –ü–æ—Ç—Ä_engine_rpm | –†–µ–∫–æ–º_–ø–∞—Ä–∞ | –ü—Ä–∏–º.</span></p>
      <p class="small muted">–ö–æ–Ω—Ç—Ä–∞—Å—Ç –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–æ: —Ç–µ–º–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ (<span class="mono">.dark</span>) –º–∞—é—Ç—å —Å–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç.</p>
    </div>

    <!-- –ö–í–ò–¢–û–ö 58 –ú–ú + NFC -->
    <div class="card">
      <h2>üßæ –ö–≤–∏—Ç–æ–∫ 58 –º–º —Ç–∞ NFC</h2>
      <div class="grid g2">
        <div class="box">
          <h3>NFC ‚Äî –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—É–∑–ª–∞</h3>
          <div class="row">
            <div style="flex:1"><label>ID –º–∞—à–∏–Ω–∏</label><input id="nfcId" type="text" value="TR-001"></div>
            <div style="flex:1"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input id="nfcPhone" type="text" value="+380XXXXXXXXX"></div>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn" onclick="buildNFC()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
            <button class="btn" onclick="copyEl('nfcOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
          </div>
          <div id="nfcOut" class="out">‚Äî</div>
        </div>

        <div class="box">
          <h3>–ö–≤–∏—Ç–æ–∫ (–æ–±—Ä–∞–Ω–∏–π —Ä—è–¥–æ–∫)</h3>
          <div class="row">
            <button class="btn" onclick="buildTicket()">üßæ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
            <button class="btn" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫</button>
          </div>
          <div class="ticket" id="ticket" style="margin-top:8px">
            <h4>–ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ü–†–ò–í–û–î–£</h4>
            <p id="tDate"><small>–î–∞—Ç–∞: ‚Äî</small></p>
            <div class="line"></div>
            <p><b>–í—É–∑–æ–ª:</b> <span id="tNode">‚Äî</span> ¬∑ <b>–¢–∏–ø:</b> <span id="tType">‚Äî</span></p>
            <p><b>–ü–∞—Ä–∞:</b> <span id="tPair">‚Äî</span> ¬∑ <b>i:</b> <span id="tI">‚Äî</span></p>
            <p><b>rpm –≤–∏—Ö.:</b> <span id="tRpm">‚Äî</span> ¬∑ <b>–º/—Å:</b> <span id="tMs">‚Äî</span></p>
            <div class="line"></div>
            <p><b>–¶—ñ–ª—ñ:</b> rpm <span id="tRpmT">‚Äî</span> ¬∑ –º/—Å <span id="tMsT">‚Äî</span></p>
            <p><b>–ü–æ—Ç—Ä. rpm –¥–≤–∏–≥—É–Ω–∞:</b> <span id="tNeed">‚Äî</span></p>
            <p><small id="tRec">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: ‚Äî</small></p>
          </div>
        </div>
      </div>
    </div>

    <!-- –•–Ü–î –†–û–ë–û–¢–ò -->
    <div class="card">
      <h2>ü™ú –•—ñ–¥ —Ä–æ–±–æ—Ç–∏ (45‚Äì70 —Ö–≤)</h2>
      <ol>
        <li>–í–∏–±–µ—Ä–∏ <b>–¥–∂–µ—Ä–µ–ª–æ –æ–±–µ—Ä—Ç—ñ–≤</b> (–¥–≤–∏–≥—É–Ω –∞–±–æ –í–í–ü) —ñ –∑–∞–¥–∞–π —Å—Ç–∞—Ä—Ç–æ–≤—ñ rpm.</li>
        <li>–î–æ–¥–∞–π 2‚Äì4 –≤—É–∑–ª–∏: —Ç–∏–ø –ø—Ä–∏–≤–æ–¥—É, –ø–∞—Ä–∏ —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫, –¥—ñ–∞–º–µ—Ç—Ä –±–∞—Ä–∞–±–∞–Ω–∞ (—è–∫—â–æ —î), —Ü—ñ–ª—ñ <b>rpm</b> –∞–±–æ <b>–º/—Å</b>.</li>
        <li>–ü–µ—Ä–µ—Ä–∞—Ö—É–π, –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è, –ø—ñ–¥–±–µ—Ä–∏ <b>engine rpm</b> –∞–±–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É –ø–∞—Ä—É.</li>
        <li>–ó–≥–µ–Ω–µ—Ä—É–π <b>NFC</b>-—Ç–µ–∫—Å—Ç —Ç–∞ <b>–∫–≤–∏—Ç–æ–∫ 58 –º–º</b>. –ï–∫—Å–ø–æ—Ä—Ç—É–π <b>CSV</b> —É Sheets (<span class="mono">Drives</span>).</li>
      </ol>
    </div>

    <div class="card">
      <h2>‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
      <table class="table">
        <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä—ñ–π</th><th>–ë–∞–ª–∏</th></tr></thead>
        <tbody>
          <tr><td>–ö–æ—Ä–µ–∫—Ç–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ i, rpm —Ç–∞ –º/—Å –ø–æ –≤—É–∑–ª–∞—Ö</td><td>4</td></tr>
          <tr><td>–ê—Ä–≥—É–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π –ø—ñ–¥–±—ñ—Ä engine rpm –∞–±–æ –ø–∞—Ä–∏ —à–∫—ñ–≤—ñ–≤/–∑—ñ—Ä–æ—á–æ–∫</td><td>3</td></tr>
          <tr><td>–ö–≤–∏—Ç–æ–∫ 58 –º–º —ñ NFC-—Ç–µ–∫—Å—Ç</td><td>2</td></tr>
          <tr><td>CSV —É Sheets + –≤–∏—Å–Ω–æ–≤–∫–∏</td><td>1</td></tr>
        </tbody>
      </table>
      <p class="pill">üåÄ –í–í–ü</p><p class="pill">üßÆ –ü–µ—Ä–µ–¥–∞—Ç–Ω—ñ</p><p class="pill">üìè –º/—Å</p><p class="pill">üßæ –ß–µ–∫</p><p class="pill">üîñ NFC</p>
    </div>
  </div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle iFrame)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  const bodyEl = document.getElementById('body');
  const csvEl  = document.getElementById('csv');
  const byId = id => document.getElementById(id);
  const rnd = (n,d=2) => Number((+n).toFixed(d));

  function srcRPM(){
    const mode = byId('srcMode').value;
    if(mode==='engine') return +byId('engRpm').value || 0;
    const pto = +byId('ptoRpm').value || 0;
    return pto;
  }

  function addRow(sample){
    const def = { node:'–ö–æ–Ω–≤–µ—î—Ä –Ω–∞—Å—ñ–Ω–Ω—è', type:'belt', drv:120, drn:200, drum:160, rpmT:180, msT:0.0, note:'' };
    const s = Object.assign({}, def, sample||{});
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td><input type="text" value="${s.node}"></td>
      <td>
        <select>
          <option value="direct" ${s.type==='direct'?'selected':''}>direct</option>
          <option value="belt" ${s.type==='belt'?'selected':''}>belt</option>
          <option value="chain" ${s.type==='chain'?'selected':''}>chain</option>
        </select>
      </td>
      <td><input type="number" step="1" value="${s.drv}"></td>
      <td><input type="number" step="1" value="${s.drn}"></td>
      <td><input type="number" step="1" value="${s.drum}"></td>
      <td><input type="number" step="1" value="${s.rpmT}"></td>
      <td><input type="number" step="0.01" value="${s.msT}"></td>
      <td class="dark i">‚Äî</td>
      <td class="dark rpm">‚Äî</td>
      <td class="dark ms">‚Äî</td>
      <td class="dark dev">‚Äî</td>
      <td class="dark need">‚Äî</td>
      <td class="dark rec">‚Äî</td>
      <td><input type="text" value="${s.note}"></td>
    `;
    bodyEl.appendChild(tr);
    reindex();
  }

  function reindex(){ [...bodyEl.querySelectorAll('tr')].forEach((tr,i)=>tr.querySelector('.idx').textContent=i+1); }

  function ratio(type, drv, drn){
    if(type==='direct') return 1;
    if(type==='belt'){ // i = Ddrive/Ddriven
      return (drv>0 && drn>0)? (drv/drn) : 0;
    }
    if(type==='chain'){ // i = zdrive/zdriven
      return (drv>0 && drn>0)? (drv/drn) : 0;
    }
    return 0;
  }

  function toMs(drum_mm, rpm){
    if(!(drum_mm>0 && rpm>0)) return 0;
    const circumference_m = Math.PI * (drum_mm/1000);
    return (circumference_m * rpm) / 60;
  }

  function neededEngineRPM(type, drv, drn, drum, targetRPM, targetMS){
    // –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ç—Ä—ñ–±–Ω—ñ –æ–±–µ—Ä—Ç–∏ –¥–∂–µ—Ä–µ–ª–∞ —â–æ–± –¥–æ—Å—è–≥—Ç–∏ —Ü—ñ–ª—ñ
    const i = ratio(type, drv, drn);
    if(i<=0) return 0;
    if(targetRPM>0) return targetRPM / i;
    if(targetMS>0 && drum>0){
      const rpmOut = (targetMS * 60) / (Math.PI * (drum/1000));
      return rpmOut / i;
    }
    return 0;
  }

  function parseList(str){
    return str.split(',').map(s=>+s.trim()).filter(x=>x>0).sort((a,b)=>a-b);
  }

  function suggestPair(type, want_i){
    if(!(want_i>0)) return null;
    if(type==='belt'){
      const arr = parseList(byId('pulleyList').value);
      let best=null, bestErr=1e9, pair='‚Äî';
      for(const d1 of arr) for(const d2 of arr){
        const i = d1/d2;
        const err = Math.abs(i - want_i)/want_i;
        if(err<bestErr){ bestErr=err; best={d1,d2,i}; }
      }
      if(best) pair = `${best.d1}/${best.d2} (i=${rnd(best.i,3)})`;
      return { text: pair, err: bestErr };
    } else if(type==='chain'){
      const arr = parseList(byId('sprocketList').value);
      let best=null, bestErr=1e9, pair='‚Äî';
      for(const z1 of arr) for(const z2 of arr){
        const i = z1/z2;
        const err = Math.abs(i - want_i)/want_i;
        if(err<bestErr){ bestErr=err; best={z1,z2,i}; }
      }
      if(best) pair = `${best.z1}T/${best.z2}T (i=${rnd(best.i,3)})`;
      return { text: pair, err: bestErr };
    }
    return null;
  }

  function recalc(){
    const src = srcRPM();
    let devSum=0, nDev=0;

    [...bodyEl.querySelectorAll('tr')].forEach(tr=>{
      const type = tr.children[2].querySelector('select').value;
      const drv  = +tr.children[3].querySelector('input').value || 0;
      const drn  = +tr.children[4].querySelector('input').value || 0;
      const drum = +tr.children[5].querySelector('input').value || 0;
      const rpmT = +tr.children[6].querySelector('input').value || 0;
      const msT  = +tr.children[7].querySelector('input').value || 0;

      const i = ratio(type, drv, drn);
      const rpmOut = src * i;
      const ms = toMs(drum, rpmOut);

      let devPct = 0, basis=0;
      if(rpmT>0){ basis=rpmT; devPct = (rpmOut - rpmT)/rpmT*100; }
      else if(msT>0){ basis=msT; devPct = (ms - msT)/msT*100; }

      if(basis>0){ devSum += Math.abs(devPct); nDev++; }

      const needSrc = neededEngineRPM(type, drv, drn, drum, rpmT, msT);
      let rec='‚Äî';
      if(needSrc>0){
        // –Ø–∫—â–æ —Ä–µ–∂–∏–º ‚Äî PTO, –ø—ñ–¥–±—ñ—Ä –Ω–µ–º–æ–∂–ª–∏–≤–∏–π –∑–º—ñ–Ω–æ—é engine rpm –Ω–∞–ø—Ä—è–º—É (—Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ 540/1000).
        if(byId('srcMode').value==='pto'){
          // –¢–æ–¥—ñ –ø—ñ–¥–±–∏—Ä–∞—î–º–æ –ø–∞—Ä—É –∑ –±–∞–∂–∞–Ω–∏–º i_target = rpmT/src –∞–±–æ –∑ msT
          let i_target = 0;
          if(rpmT>0) i_target = rpmT / src;
          else if(msT>0 && drum>0){
            const rpmFromMs = (msT*60)/(Math.PI*(drum/1000));
            i_target = rpmFromMs / src;
          }
          const sug = suggestPair(type, i_target);
          rec = sug? sug.text : '‚Äî';
        } else {
          // –ú–æ–∂–µ–º–æ –ø—Ä–æ—Å—Ç–æ –∑–º—ñ–Ω–∏—Ç–∏ –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞
          rec = `engine ‚âà ${Math.round(needSrc)} rpm`;
        }
      }

      tr.querySelector('.i').textContent   = i? rnd(i,3) : '‚Äî';
      tr.querySelector('.rpm').textContent = rpmOut? rnd(rpmOut,1) : '‚Äî';
      tr.querySelector('.ms').textContent  = ms? rnd(ms,2) : '‚Äî';
      tr.querySelector('.dev').textContent = (basis>0)? rnd(devPct,1)+'%' : '‚Äî';
      tr.querySelector('.dev').style.color = (basis>0)? (Math.abs(devPct)<=5?'#10b981':(Math.abs(devPct)<=12?'#f59e0b':'#ef4444')) : '';
      tr.querySelector('.need').textContent= (needSrc>0 && byId('srcMode').value==='engine')? Math.round(needSrc) : '‚Äî';
      tr.querySelector('.rec').textContent = rec;
    });

    byId('avgDev').textContent = nDev? rnd(devSum/nDev,1)+'%' : '‚Äî';
    buildCSV();
  }

  function buildCSV(){
    const lines = [...bodyEl.querySelectorAll('tr')].map(tr=>{
      const idx=tr.querySelector('.idx').textContent.trim();
      const node=tr.children[1].querySelector('input').value.trim();
      const type=tr.children[2].querySelector('select').value.trim();
      const drv =tr.children[3].querySelector('input').value.trim();
      const drn =tr.children[4].querySelector('input').value.trim();
      const drum=tr.children[5].querySelector('input').value.trim();
      const rpmT=tr.children[6].querySelector('input').value.trim();
      const msT =tr.children[7].querySelector('input').value.trim();
      const i   =tr.querySelector('.i').textContent.trim();
      const rpm =tr.querySelector('.rpm').textContent.trim();
      const ms  =tr.querySelector('.ms').textContent.trim();
      const dev =tr.querySelector('.dev').textContent.trim();
      const need=tr.querySelector('.need').textContent.trim();
      const rec =tr.querySelector('.rec').textContent.trim();
      const note=tr.children[14].querySelector('input').value.trim();
      return [idx,node,type,drv,drn,drum,rpmT,msT,i,rpm,ms,dev,need,rec,note].join(' | ');
    });
    csvEl.textContent = lines.join('\n') || '‚Äî';
  }

  function copyCSV(){
    const t = csvEl.textContent.trim();
    if(!t || t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è'); return; }
    navigator.clipboard.writeText(t).then(()=>flash('‚úÖ CSV —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'),()=>flash('–ù–µ –≤–¥–∞–ª–æ—Å—è'));
  }

  function preset(){
    bodyEl.innerHTML='';
    // 3 –ø—Ä–∏–∫–ª–∞–¥–∏: —Ä–µ–º—ñ–Ω—å –Ω–∞ –∫–æ–Ω–≤–µ—î—Ä, –ª–∞–Ω—Ü—é–≥ –Ω–∞ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä, –ø—Ä—è–º–∏–π PTO –≤–∞–ª
    addRow({node:'–ö–æ–Ω–≤–µ—î—Ä –Ω–∞—Å—ñ–Ω–Ω—è', type:'belt',  drv:120, drn:200, drum:160, rpmT:180, msT:0.0, note:'—à–∫—ñ–≤ 120/200'});
    addRow({node:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –æ—Ö–æ–ª–æ–¥–∂.', type:'chain', drv:15, drn:20, drum:0, rpmT:2200, msT:0.0, note:'–∑—ñ—Ä–æ—á–∫–∏ 15/20'});
    addRow({node:'–ù–∞—Å–æ—Å –≥—ñ–¥—Ä–æ', type:'direct', drv:1, drn:1, drum:0, rpmT:1500, msT:0.0, note:'–≤–∞–ª –Ω–∞–ø—Ä—è–º—É'});
    recalc();
  }

  // ===== –ö–≤–∏—Ç–æ–∫ 58 –º–º =====
  function buildTicket(){
    const tr = bodyEl.querySelector('tr') || null;
    const d  = new Date().toISOString().slice(0,10);
    byId('tDate').innerHTML = `<small>–î–∞—Ç–∞: ${d}</small>`;
    if(!tr){ return; }
    const node = tr.children[1].querySelector('input').value.trim();
    const type = tr.children[2].querySelector('select').value.trim();
    const drv  = tr.children[3].querySelector('input').value.trim();
    const drn  = tr.children[4].querySelector('input').value.trim();
    const i    = tr.querySelector('.i').textContent.trim();
    const rpm  = tr.querySelector('.rpm').textContent.trim();
    const ms   = tr.querySelector('.ms').textContent.trim();
    const rpmT = tr.children[6].querySelector('input').value.trim();
    const msT  = tr.children[7].querySelector('input').value.trim();
    const need = tr.querySelector('.need').textContent.trim();
    const rec  = tr.querySelector('.rec').textContent.trim();

    byId('tNode').textContent = node;
    byId('tType').textContent = type;
    byId('tPair').textContent = `${drv}/${drn}`;
    byId('tI').textContent    = i;
    byId('tRpm').textContent  = rpm;
    byId('tMs').textContent   = ms;
    byId('tRpmT').textContent = rpmT || '‚Äî';
    byId('tMsT').textContent  = msT  || '‚Äî';
    byId('tNeed').textContent = need || '‚Äî';
    byId('tRec').textContent  = `–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: ${rec || '‚Äî'} ¬∑ Src:${byId('srcMode').value==='engine'? byId('engRpm').value+' rpm' : ('PTO '+byId('ptoRpm').value+' rpm')}`;
  }

  // ===== NFC =====
  function buildNFC(){
    const tr = bodyEl.querySelector('tr') || null;
    if(!tr){ alert('–î–æ–¥–∞–π —Ö–æ—á–∞ –± –æ–¥–∏–Ω –≤—É–∑–æ–ª.'); return; }
    const text = [
      `DRIVE_NFC`,
      `MACHINE:${byId('nfcId').value}`,
      `CONTACT:${byId('nfcPhone').value}`,
      `MODE:${byId('srcMode').value==='engine'?'ENGINE':'PTO'}`,
      `SRC_RPM:${srcRPM()}`,
      `NODE:${tr.children[1].querySelector('input').value.trim()}`,
      `TYPE:${tr.children[2].querySelector('select').value.trim()}`,
      `PAIR:${tr.children[3].querySelector('input').value.trim()}/${tr.children[4].querySelector('input').value.trim()}`,
      `I:${tr.querySelector('.i').textContent.trim()}`,
      `RPM_OUT:${tr.querySelector('.rpm').textContent.trim()}`,
      `MS:${tr.querySelector('.ms').textContent.trim()}`,
      `TARGET_RPM:${tr.children[6].querySelector('input').value.trim()}`,
      `TARGET_MS:${tr.children[7].querySelector('input').value.trim()}`,
      `NEED_ENGINE_RPM:${tr.querySelector('.need').textContent.trim()}`,
      `REC:${tr.querySelector('.rec').textContent.trim()}`,
      `STAMP:${new Date().toISOString().slice(0,19).replace('T',' ')}`
    ].join('\n');
    byId('nfcOut').textContent = text;
  }

  // ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
  function copyEl(id){
    const t = byId(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'); return; }
    navigator.clipboard.writeText(t).then(()=>flash('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'),()=>flash('–ù–µ –≤–¥–∞–ª–æ—Å—è'));
  }
  function flash(msg){ const o=document.title; document.title=msg; setTimeout(()=>document.title=o,900); }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  (function init(){ addRow(); addRow(); recalc(); })();

  // –°–ª—É—Ö–∞—á—ñ
  ['srcMode','engRpm','ptoRpm','eng2pto','pulleyList','sprocketList'].forEach(id=>{
    document.getElementById(id).addEventListener('change', recalc);
  });
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>



</body></html>