<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 20 (–º–µ—Ö–∞–Ω—ñ–∫–∏) ‚Äî –ê–∫—É—Å—Ç–∏—á–Ω–∏–π —Å—Ç–µ—Ç–æ—Å–∫–æ–ø –ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤ —Ä–µ–¥—É–∫—Ç–æ—Ä–∞ (WebAudio)</title>
<meta name="description" content="–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –≥–∞—Ä–Ω—ñ—Ç—É—Ä–∏ –∞–±–æ WAV ‚Üí –æ—Å—Ü–∏–ª–æ–≥—Ä–∞–º–∞, envelope, —Å–ø–µ–∫—Ç—Ä/—Å–ø–µ–∫—Ç—Ä –æ–≥–∏–Ω–∞—é—á–æ—ó, –∫–µ–ø—Å—Ç—Ä—É–º ‚Üí –¥—ñ–∞–≥–Ω–æ–∑ –ø—ñ–¥—à–∏–ø–Ω–∏–∫–∞/—Ä–µ–¥—É–∫—Ç–æ—Ä–∞ ‚Üí —á–µ–∫-–ª–∏—Å—Ç –¥—ñ–π ‚Üí –∂—É—Ä–Ω–∞–ª ‚Üí –µ–∫—Å–ø–æ—Ä—Ç PNG/CSV/TXT."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1180px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
pre.code{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto;white-space:pre-wrap}
.small{font-size:.9rem}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:220px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üéß</span>
      <div>
        <b>–ü–∞—Ä–∞ 20 ‚Äî –ê–∫—É—Å—Ç–∏—á–Ω–∏–π —Å—Ç–µ—Ç–æ—Å–∫–æ–ø –ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤ —Ä–µ–¥—É–∫—Ç–æ—Ä–∞</b><br/>
        <span class="badge">–º—ñ–∫—Ä–æ—Ñ–æ–Ω ‚Üí envelope ‚Üí —Å–ø–µ–∫—Ç—Ä/–∫–µ–ø—Å—Ç—Ä—É–º ‚Üí –¥—ñ–∞–≥–Ω–æ–∑ ‚Üí —á–µ–∫-–ª–∏—Å—Ç ‚Üí –∂—É—Ä–Ω–∞–ª ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∑–≤–∏—á–∞–π–Ω–æ–≥–æ <b>–º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –≥–∞—Ä–Ω—ñ—Ç—É—Ä–∏</b> –ø—Ä–æ—Å–ª—É—Ö–∞—Ç–∏ –∫–æ—Ä–ø—É—Å —Ä–µ–¥—É–∫—Ç–æ—Ä–∞, –æ—Ç—Ä–∏–º–∞—Ç–∏ <b>–æ–≥–∏–Ω–∞—é—á—É —É–¥–∞—Ä—ñ–≤</b>, —Å–ø–µ–∫—Ç—Ä —ñ <b>–∫–µ–ø—Å—Ç—Ä—É–º</b>, —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ —Ç–∏–ø–æ–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ (<b>1X</b> —Ä–æ–∑–±–∞–ª–∞–Ω—Å, <b>2X</b> –Ω–µ–ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å, <b>looseness</b> ‚Äî –ø–æ—Å–ª–∞–±–ª–µ–Ω–Ω—è –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è, <b>–¥–µ—Ñ–µ–∫—Ç–∏ –ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤</b>, <b>–∑–∞—á–µ–ø–ª–µ–Ω–Ω—è —à–µ—Å—Ç–µ—Ä–µ–Ω—å</b>) —ñ —Å–∫–ª–∞—Å—Ç–∏ <b>—á–µ–∫-–ª–∏—Å—Ç –¥—ñ–π</b>. –ë–µ–∑–ø–µ—á–Ω–æ, –¥–µ—à–µ–≤–æ, –Ω–∞ –∫–æ–∂–Ω–æ–º—É –ü–ö –≤ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó.</p>

  <div class="card">
    <h2>üéôÔ∏è –î–∂–µ—Ä–µ–ª–æ —Å–∏–≥–Ω–∞–ª—É</h2>
    <div class="row">
      <div style="flex:1">
        <label>–†–µ–∂–∏–º</label>
        <select id="src" class="input">
          <option value="mic" selected>–ú—ñ–∫—Ä–æ—Ñ–æ–Ω (–≥–∞—Ä–Ω—ñ—Ç—É—Ä–∞/–Ω–æ—É—Ç–±—É–∫)</option>
          <option value="file">–ê—É–¥—ñ–æ—Ñ–∞–π–ª (WAV/MP3)</option>
          <option value="emu">–ï–º—É–ª—è—Ç–æ—Ä (—Å–∏–Ω—Ç–µ—Ç–∏–∫–∞ –ø—ñ–¥—à–∏–ø–Ω–∏–∫–∞)</option>
        </select>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn good" id="start">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button class="btn secondary" id="stop">‚èπÔ∏è –°—Ç–æ–ø</button>
        <span id="stat" class="badge">–°—Ç–∞—Ç—É—Å: idle</span>
      </div>
    </div>
    <div id="fileBox" class="row" style="display:none;margin-top:6px">
      <input id="fileInp" class="input" type="file" accept="audio/*"/>
      <button class="btn" id="playFile">‚ñ∂Ô∏è –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª</button>
    </div>
    <div id="emuBox" class="note" style="display:none;margin-top:6px">
      <b>–ï–º—É–ª—è—Ç–æ—Ä:</b>
      <div class="row">
        <div style="flex:1">
          <select id="emuType" class="input">
            <option value="normal" selected>–ù–æ—Ä–º–∞ (—Ç–∏—Ö–∏–π –ø—ñ–¥—à–∏–ø–Ω–∏–∫)</option>
            <option value="outer">–ü—ñ–¥—à–∏–ø–Ω–∏–∫ ‚Äî –¥–æ—Ä—ñ–∂–∫–∞ <i>outer race</i></option>
            <option value="inner">–ü—ñ–¥—à–∏–ø–Ω–∏–∫ ‚Äî –¥–æ—Ä—ñ–∂–∫–∞ <i>inner race</i></option>
            <option value="ball">–ü—ñ–¥—à–∏–ø–Ω–∏–∫ ‚Äî —Ç—ñ–ª–∞ –∫–æ—á–µ–Ω–Ω—è</option>
            <option value="gear">–ó–∞—á–µ–ø–ª–µ–Ω–Ω—è —à–µ—Å—Ç–µ—Ä–µ–Ω—å (GMF)</option>
            <option value="loose">Looseness (–ø–æ—Å–ª–∞–±–ª–µ–Ω–Ω—è)</option>
          </select>
        </div>
        <div style="flex:1">
          <label>–†—ñ–≤–µ–Ω—å <input id="emuLvl" class="input" type="range" min="0" max="1" step="0.01" value="0.7"/></label>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –º–µ—Ö–∞–Ω—ñ–∑–º—É</h2>
    <div class="row">
      <div style="flex:1">
        <label>RPM –≤–∞–ª—É (–∞–±–æ –æ—Ü—ñ–Ω–∫–∞)</label>
        <input id="rpm" class="input" type="number" min="60" step="1" value="900"/>
      </div>
      <div style="flex:1">
        <label>–ó—É–±—Ü—ñ–≤ –Ω–∞ —à–µ—Å—Ç–µ—Ä–Ω—ñ (—è–∫—â–æ —Ä–µ–¥—É–∫—Ç–æ—Ä)</label>
        <input id="teeth" class="input" type="number" min="5" step="1" value="30"/>
      </div>
      <div style="flex:1">
        <label>–°–º—É–≥–∞ –æ–≥–∏–Ω–∞—é—á–æ—ó, –∫–ì—Ü (–ù–ß —Ñ—ñ–ª—å—Ç—Ä)</label>
        <input id="envLP" class="input" type="number" min="0.2" step="0.1" value="2.0"/>
      </div>
      <div style="flex:1">
        <label>FFT —Ä–æ–∑–º—ñ—Ä</label>
        <select id="fft" class="input"><option>2048</option><option selected>4096</option><option>8192</option></select>
      </div>
    </div>
    <small class="muted">–ü–æ—Ä–∞–¥–∞: ¬´—Å—Ç–µ—Ç–æ—Å–∫–æ–ø¬ª –ø—Ä–∞—Ü—é—î –∫—Ä–∞—â–µ –Ω–∞ —á–∞—Å—Ç–∏–Ω–∞—Ö –∫–æ—Ä–ø—É—Å—É, –¥–µ –∑–≤—É–∫ ¬´–¥–∑–≤–µ–Ω–∏—Ç—å¬ª. –ü—Ä–∏—Ç–∏—Å–Ω–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω —á–µ—Ä–µ–∑ –≥—É–º–æ–≤—É –ø—Ä–æ–∫–ª–∞–¥–∫—É –∞–±–æ —ñ–∑–æ–ª–µ–Ω—Ç—É.</small>
  </div>

  <div class="card">
    <h2>üìà –û—Å—Ü–∏–ª–æ–≥—Ä–∞–º–∏ (—Å–∏—Ä–∏–π —Ç–∞ –æ–≥–∏–Ω–∞—é—á–∞)</h2>
    <div class="canvasWrap"><canvas id="wave" width="1080" height="200"></canvas></div>
    <div class="canvasWrap" style="margin-top:8px"><canvas id="env" width="1080" height="200"></canvas></div>
    <div class="row" style="margin-top:8px">
      <span id="last" class="badge">RMS=‚Äî, Kurt=‚Äî, Crest=‚Äî</span>
      <button class="btn secondary" id="pngOsci">üñºÔ∏è PNG (–æ—Å—Ü–∏–ª–æ–≥—Ä–∞–º–∏)</button>
      <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
    </div>
  </div>

  <div class="card">
    <h2>üî¨ –°–ø–µ–∫—Ç—Ä —Ç–∞ —Å–ø–µ–∫—Ç—Ä –æ–≥–∏–Ω–∞—é—á–æ—ó</h2>
    <div class="canvasWrap"><canvas id="spec" width="1080" height="240"></canvas></div>
    <div class="canvasWrap" style="margin-top:8px"><canvas id="espec" width="1080" height="240"></canvas></div>
    <div class="row small" style="margin-top:8px">
      <span class="badge">Fs=–∞–≤—Ç–æ; –∫–æ–ª—ñ—Ä –∑–µ–ª–µ–Ω–∏–π ‚Äî —Å–ø–µ–∫—Ç—Ä, –∂–æ–≤—Ç–∏–π ‚Äî –æ–≥–∏–Ω–∞—é—á–∞</span>
      <button class="btn secondary" id="pngSpec">üñºÔ∏è PNG (—Å–ø–µ–∫—Ç—Ä–∏)</button>
    </div>
  </div>

  <div class="card">
    <h2>üß† –ö–µ–ø—Å—Ç—Ä—É–º (–ø–æ—à—É–∫ –ø–µ—Ä—ñ–æ–¥–∏–∫–∏ —É–¥–∞—Ä—ñ–≤)</h2>
    <div class="canvasWrap"><canvas id="cep" width="1080" height="200"></canvas></div>
    <div class="row small" style="margin-top:8px">
      <span id="cepInfo" class="badge">–ö–µ–ø—Å—Ç—Ä–∞–ª—å–Ω—ñ –ø—ñ–∫–∏: ‚Äî</span>
      <button class="btn secondary" id="pngCep">üñºÔ∏è PNG (–∫–µ–ø—Å—Ç—Ä—É–º)</button>
    </div>
  </div>

  <div class="card">
    <h2>ü©∫ –î—ñ–∞–≥–Ω–æ–∑ —ñ —á–µ–∫-–ª–∏—Å—Ç –¥—ñ–π</h2>
    <div class="row">
      <span id="diag" class="badge">–î—ñ–∞–≥–Ω–æ–∑: ‚Äî</span>
      <span id="gmf" class="badge">–û—á—ñ–∫—É–≤–∞–Ω–∏–π GMF: ‚Äî –ì—Ü</span>
    </div>
    <table class="tbl" style="margin-top:8px">
      <tbody id="checklist">
        <tr><th>–†–æ–∑–±–∞–ª–∞–Ω—Å (1X)</th><td>–ü–µ—Ä–µ–≤—ñ—Ä —á–∏—Å—Ç–æ—Ç—É –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞/—à–∫—ñ–≤–∞, –∑–Ω—è—Ç–∏ –±—Ä—É–¥; –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è; –æ–≥–ª—è–¥ –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —à–∫—ñ–≤—ñ–≤.</td></tr>
        <tr><th>–ù–µ–ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å (2X)</th><td>–í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –≤–∞–ª—ñ–≤ –ª–∞–∑–µ—Ä–Ω–æ—é –ª—ñ–Ω—ñ–π–∫–æ—é/—â—É–ø–æ–º; –ø–µ—Ä–µ–≤—ñ—Ä –æ–ø–æ—Ä–Ω—ñ –ø–æ–≤–µ—Ä—Ö–Ω—ñ, –ø—Ä–æ—Å—Ç–∞–≤–∫–∏.</td></tr>
        <tr><th>Looseness (–ø–æ—Å–ª–∞–±–ª–µ–Ω–Ω—è)</th><td>–î–æ—Ç—è–≥–Ω—É—Ç–∏ –±–æ–ª—Ç–∏ –∫–æ—Ä–ø—É—Å—É/–∫—Ä–∏—à–æ–∫; –ø–µ—Ä–µ–≤—ñ—Ä –ø–æ—Å–∞–¥–∫–∏ –ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤, –ª—é—Ñ—Ç.</td></tr>
        <tr><th>–ü—ñ–¥—à–∏–ø–Ω–∏–∫ (BPFO/BPFI/BSF)</th><td>–°–ª—É—Ö–∞—Ç–∏ —Å–ø–µ–∫—Ç—Ä –æ–≥–∏–Ω–∞—é—á–æ—ó: —Ä—è–¥ —Ç–æ–Ω–∫–∏—Ö –ø—ñ–∫-—Ñ—Ä–µ–∫–≤–µ–Ω—Ü—ñ–π —É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ 5‚Äì300 –ì—Ü; –æ–≥–ª—è–Ω—É—Ç–∏ –º–∞—Å—Ç–∏–ª–æ, –≥–µ—Ä–º–µ—Ç–∏—á–Ω—ñ—Å—Ç—å, –∑–∞–º—ñ–Ω–∞ –ø—Ä–∏ –Ω–∞—Ä–æ—Å—Ç–∞–Ω–Ω—ñ Kurtosis.</td></tr>
        <tr><th>–ó–∞—á–µ–ø–ª–µ–Ω–Ω—è —à–µ—Å—Ç–µ—Ä–µ–Ω—å (GMF)</th><td>GMF‚âàz√óf<sub>–≤–∞–ª</sub>: —Å–∏–ª—å–Ω–∏–π —Ç–æ–Ω + –±—ñ—á–Ω—ñ —Å–º—É–≥–∏ ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä –∑–∞–∑–æ—Ä, –∑–º–∞—â–µ–Ω–Ω—è, –∑–Ω–æ—Å –∑—É–±—Ü—ñ–≤.</td></tr>
      </tbody>
    </table>
    <div class="note small" style="margin-top:8px">
      <b>–Ø–∫ —á–∏—Ç–∞—Ç–∏:</b> <i>1X</i> ‚Äî —á–∞—Å—Ç–æ—Ç–∞ –æ–±–µ—Ä—Ç—ñ–≤; <i>2X</i> ‚Äî —É–¥–≤—ñ—á—ñ; <i>GMF</i> ‚Äî —á–∞—Å—Ç–æ—Ç–∞ –∑–∞—á–µ–ø–ª–µ–Ω–Ω—è (–∑—É–±—Ü—ñ–≤√ó–æ–±/—Å). –î–ª—è –ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤ –¥–∏–≤–∏—Å—å <b>—Å–ø–µ–∫—Ç—Ä –æ–≥–∏–Ω–∞—é—á–æ—ó</b> —Ç–∞ <b>–∫–µ–ø—Å—Ç—Ä—É–º</b>.
    </div>
  </div>

  <div class="card">
    <h2>üìú –ñ—É—Ä–Ω–∞–ª —ñ –µ–∫—Å–ø–æ—Ä—Ç</h2>
    <div class="row">
      <button class="btn" id="mark">üìå –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –ø–æ–¥—ñ—é</button>
      <select id="label" class="input" style="max-width:260px">
        <option value="ok" selected>ok</option>
        <option value="unbalance">unbalance</option>
        <option value="misalignment">misalignment</option>
        <option value="looseness">looseness</option>
        <option value="bearing">bearing</option>
        <option value="gearmesh">gearmesh</option>
      </select>
    </div>
    <pre id="alog" class="code" style="max-height:200px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –∑–∞–ø–∏—Å—ñ–≤</pre>
    <div class="row">
      <button class="btn" id="expCSV">üìÑ CSV (–æ–∑–Ω–∞–∫–∏/–ø—ñ–∫–∏)</button>
      <button class="btn" id="expTXT">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫ + —á–µ–∫-–ª–∏—Å—Ç)</button>
      <button class="btn" id="expPNG">üñºÔ∏è PNG (–≤—Å–µ —Ä–∞–∑–æ–º)</button>
      <button class="btn secondary" id="receipt">üñ®Ô∏è 58 –º–º —á–µ–∫</button>
    </div>
    <div id="rc" class="receipt" hidden></div>
  </div>

  <div class="card">
    <h2>üîå –°—Ö–µ–º–∞ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è (SVG)</h2>
    <svg viewBox="0 0 980 300" role="img" aria-label="–ú—ñ–∫—Ä–æ—Ñ–æ–Ω ‚Üí –∫–æ—Ä–ø—É—Å —Ä–µ–¥—É–∫—Ç–æ—Ä–∞">
      <rect x="60" y="60" width="300" height="160" rx="16" fill="#0e2a47" stroke="#3b82f6"/>
      <text x="210" y="90" fill="#e5e7eb" font-size="15" text-anchor="middle">–†–µ–¥—É–∫—Ç–æ—Ä</text>
      <text x="210" y="110" fill="#93c5fd" font-size="12" text-anchor="middle">–≤—Ö—ñ–¥–Ω–∏–π –≤–∞–ª –ª—ñ–≤–æ—Ä—É—á, –≤–∏—Ö—ñ–¥ –ø—Ä–∞–≤–æ—Ä—É—á</text>

      <circle cx="130" cy="140" r="20" fill="#1f2937" stroke="#9ca3af"/>
      <circle cx="350" cy="140" r="28" fill="#1f2937" stroke="#9ca3af"/>
      <rect x="500" y="110" width="160" height="60" rx="10" fill="#14532d" stroke="#22c55e"/>
      <text x="580" y="145" fill="#dcfce7" font-size="14" text-anchor="middle">üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</text>
      <line x1="360" y1="140" x2="500" y2="140" stroke="#93c5fd" stroke-width="3"/>
      <text x="640" y="210" fill="#fbbf24" font-size="12" text-anchor="middle">–ü—Ä–∏—Ç–∏—Å–Ω—É—Ç–∏ –¥–æ –∫–æ—Ä–ø—É—Å–∞ —á–µ—Ä–µ–∑ –≥—É–º—É/—ñ–∑–æ–ª–µ–Ω—Ç–æ—é</text>
    </svg>
    <div class="note small" style="margin-top:8px">
      <b>–ë–µ–∑–ø–µ–∫–∞:</b> –Ω–µ —Ç–æ—Ä–∫–∞—Ç–∏—Å—è —Ä—É—Ö–æ–º–∏—Ö —á–∞—Å—Ç–∏–Ω; –≤–∏–∫–ª—é—á–∏—Ç–∏ LOTO –ø–µ—Ä–µ–¥ —Å–µ—Ä–≤—ñ—Å–æ–º; –Ω–µ —Å—Ç–∞–≤–∏—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω —É –∑–æ–Ω—É –±—Ä–∏–∑–æ–∫ –º–∞—Å–ª–∞.
    </div>
  </div>

  <div class="card">
    <h2>üìã –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –∑–≤—ñ—Ç—É</h2>
    <ul>
      <li>PNG: –æ—Å—Ü–∏–ª–æ–≥—Ä–∞–º–∏, —Å–ø–µ–∫—Ç—Ä–∏, –∫–µ–ø—Å—Ç—Ä—É–º —ñ–∑ –ø–æ–∑–Ω–∞—á–µ–Ω–∏–º –¥—ñ–∞–≥–Ω–æ–∑–æ–º.</li>
      <li>CSV –æ–∑–Ω–∞–∫/–ø—ñ–∫—ñ–≤ –∑–∞ 1‚Äì2 —Ö–≤ + –∂—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π.</li>
      <li>–ö–æ—Ä–æ—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç –¥—ñ–π: —â–æ –∑—Ä–æ–±–∏—Ç–∏ –∑–∞—Ä–∞–∑, —â–æ ‚Äî –ø—Ä–∏ –Ω–∞–π–±–ª–∏–∂—á–æ–º—É –¢–û.</li>
    </ul>
  </div>

  <div class="card">
    <h2>üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
    <p class="muted small">–ü–µ—Ä—à—ñ ¬´—Å—Ç–µ—Ç–æ—Å–∫–æ–ø–∏ –º–µ—Ö–∞–Ω—ñ–∫–∞¬ª –±—É–ª–∏ –ø—Ä–æ—Å—Ç–æ—é —Ç—Ä—É–±–∫–æ—é. –°—å–æ–≥–æ–¥–Ω—ñ –±—Ä–∞—É–∑–µ—Ä —Ä–æ–±–∏—Ç—å —ñ–Ω–∞–∫—à–µ: –æ–≥–∏–Ω–∞—é—á–∞, —Å–ø–µ–∫—Ç—Ä, –∫–µ–ø—Å—Ç—Ä—É–º ‚Äî —ñ –≤–∏ –≤–∂–µ –±–∞—á–∏—Ç–µ ¬´—É–¥–∞—Ä–∏¬ª –¥–µ—Ñ–µ–∫—Ç—ñ–≤ –ø—ñ–¥—à–∏–ø–Ω–∏–∫–∞ —Ç–∞–º, –¥–µ –≤—É—Ö–æ –ª–∏—à–µ –∑–¥–æ–≥–∞–¥—É—î—Ç—å—Å—è.</p>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}

// ===== –ê—É–¥—ñ–æ –ø–∞–π–ø–ª–∞–π–Ω =====
let actx=null, analyser=null, srcNode=null, micStream=null, fileBuf=null, fileSrc=null, fs=48000;
let bp=null, rectifier=null, lp=null; // –¥–ª—è –æ–≥–∏–Ω–∞—é—á–æ—ó
let NFFT=4096;

const wave=$('#wave'), wctx=wave.getContext('2d');
const env=$('#env'),  ectx=env.getContext('2d');
const spec=$('#spec'), sctx=spec.getContext('2d');
const espec=$('#espec'), exctx=espec.getContext('2d');
const cep=$('#cep'), cctx=cep.getContext('2d');

const featsLog=[], logbook=[];

function log(msg){const t=new Date().toLocaleTimeString(); const box=$('#alog'); if(box.textContent.startsWith('//')) box.textContent=''; box.textContent+=`[${t}] ${msg}\n`; box.scrollTop=box.scrollHeight; logbook.push({t,msg});}

// ===== –ì—Ä–∞—Ñ—ñ–∫–∞ =====
function drawLine(ctx, arr, color='#38bdf8', ymid=false){
  const W=ctx.canvas.width,H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=1.4;
  const n=arr.length;
  for(let i=0;i<n;i++){
    const x=i*(W/(n-1));
    const y= ymid? (H/2 - arr[i]*(H/2-12)) : (H-10 - arr[i]*(H-20));
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }
  ctx.stroke();
}
function drawSpec(ctx, db, maxHz, color='#22c55e'){
  const W=ctx.canvas.width,H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  ctx.fillStyle='#94a3b8'; ctx.font='12px ui-monospace';
  for(let fk=100; fk<=maxHz; fk+=100){
    const x=fk*(W/maxHz); ctx.strokeStyle='#18243b'; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    if(fk%500===0) ctx.fillText(fk+' –ì—Ü', x+2, 12);
  }
  ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=1.5;
  for(let i=0;i<db.length;i++){
    const x=i*(W/(db.length-1));
    const y=H-10 - ((Math.max(-100,Math.min(0,db[i]))+100)/100)*(H-20);
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }
  ctx.stroke();
}

// ===== –ë—É—Ñ–µ—Ä–∏ =====
let timeBuf=new Float32Array(4096);
let envBuf=new Float32Array(4096);
let specBuf=new Float32Array(2048);
let especBuf=new Float32Array(2048);
let cepBuf=new Float32Array(2048);

// ===== DSP =====
function makeChain(){
  bp=actx.createBiquadFilter(); bp.type='bandpass'; bp.Q=3; bp.frequency.value=6000; // —Å–º—É–≥–∞ —É–¥–∞—Ä—ñ–≤
  rectifier=new WaveShaperNode(actx,{curve:new Float32Array([ -1, 0, 1 ])}); // –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É ‚Äî –∑–∞–º—ñ–Ω–∏–º–æ –Ω–∞ ScriptProcessor
  lp=actx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=(parseFloat($('#envLP').value)||2)*1000;
}

let procNode=null;
function startMic(){
  navigator.mediaDevices.getUserMedia({audio:{noiseSuppression:false,echoCancellation:false,autoGainControl:false}})
    .then(stream=>{
      micStream=stream; srcNode=actx.createMediaStreamSource(stream);
      buildPipeline('mic');
      $('#stat').textContent='–°—Ç–∞—Ç—É—Å: mic';
      loop();
      log('–ú—ñ–∫—Ä–æ—Ñ–æ–Ω —É–≤—ñ–º–∫–Ω–µ–Ω–æ');
    }).catch(err=>{ alert('–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞: '+err.message); $('#stat').textContent='–°—Ç–∞—Ç—É—Å: –ø–æ–º–∏–ª–∫–∞'; });
}

function startFile(){
  $('#fileBox').style.display='flex';
  log('–í–∏–±–µ—Ä–∏ –∞—É–¥—ñ–æ—Ñ–∞–π–ª (WAV/MP3)');
}

$('#fileInp').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const ab=await f.arrayBuffer();
  if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)();
  fileBuf=await actx.decodeAudioData(ab);
  log('–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: '+f.name);
});
$('#playFile').addEventListener('click', ()=>{
  if(!fileBuf){ alert('–ù–µ–º–∞—î —Ñ–∞–π–ª—É'); return; }
  if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)();
  fileSrc=actx.createBufferSource(); fileSrc.buffer=fileBuf; fileSrc.loop=false;
  buildPipeline('file');
  fileSrc.start();
  $('#stat').textContent='–°—Ç–∞—Ç—É—Å: file';
  loop(); log('–í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É');
});

let emuNodes=[];
function startEmu(){
  const g=actx.createGain(); g.gain.value=parseFloat($('#emuLvl').value)||0.7; emuNodes=[g];
  function mkNoise(center,bw,gain){const buf=actx.createBuffer(1,fs,fs),d=buf.getChannelData(0); for(let i=0;i<fs;i++) d[i]=Math.random()*2-1; const s=actx.createBufferSource(); s.buffer=buf; s.loop=true; const biq=actx.createBiquadFilter(); biq.type='bandpass'; biq.frequency.value=center; biq.Q=center/Math.max(10,bw); const gg=actx.createGain(); gg.gain.value=gain; s.connect(biq).connect(gg).connect(g); s.start(); emuNodes.push(s,biq,gg);}
  function mkClick(rateHz, gain){ // –ø–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ —É–¥–∞—Ä–∏
    const osc=actx.createOscillator(); osc.type='square'; osc.frequency.value=rateHz; const sh=actx.createGain(); sh.gain.value=gain; osc.connect(sh).connect(g); osc.start(); emuNodes.push(osc,sh);
  }
  const t=$('#emuType').value;
  const f1x=(parseFloat($('#rpm').value)||900)/60;
  if(t==='normal'){ mkNoise(3000,3000,0.08); mkNoise(8000,8000,0.04); }
  if(t==='outer'){ mkNoise(6000,6000,0.08); mkClick(f1x*3.2,0.18); }
  if(t==='inner'){ mkNoise(7000,7000,0.1); mkClick(f1x*4.8,0.16); }
  if(t==='ball'){  mkNoise(9000,9000,0.12); mkClick(f1x*2.1,0.14); }
  if(t==='gear'){  mkNoise(4000,3000,0.1); mkClick((parseFloat($('#teeth').value)||30)*f1x,0.12); }
  if(t==='loose'){ mkNoise(2500,2000,0.08); mkClick(f1x*2,0.07); mkClick(f1x,0.12); }
  srcNode=g;
  buildPipeline('emu');
  $('#stat').textContent='–°—Ç–∞—Ç—É—Å: –µ–º—É–ª—è—Ç–æ—Ä';
  loop(); log('–ï–º—É–ª—è—Ç–æ—Ä: '+t);
}

function stopAll(){
  if(emuNodes.length){ emuNodes.forEach(n=>{try{if(n.stop)n.stop(); if(n.disconnect)n.disconnect();}catch{}}); emuNodes.length=0; }
  if(fileSrc){ try{fileSrc.stop(); fileSrc.disconnect();}catch{} fileSrc=null; }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(procNode){ try{procNode.disconnect();}catch{} procNode=null; }
  if(analyser){ try{analyser.disconnect();}catch{} analyser=null; }
  if(srcNode){ try{srcNode.disconnect();}catch{} srcNode=null; }
  if(actx){ try{actx.close();}catch{} }
  actx=null; $('#stat').textContent='–°—Ç–∞—Ç—É—Å: idle';
}

function buildPipeline(mode){
  if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  fs=actx.sampleRate; NFFT=parseInt($('#fft').value)||4096;
  makeChain();
  analyser=actx.createAnalyser(); analyser.fftSize=NFFT; analyser.smoothingTimeConstant=0.4;

  // –°–∫—Ä–∏–ø—Ç–æ–≤–∏–π –≤—É–∑–æ–ª –¥–ª—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–∏—Ä–æ–≥–æ —Ç–∞ envelope
  const bufSize=2048;
  procNode=actx.createScriptProcessor(bufSize, 1, 1);
  const bp1=actx.createBiquadFilter(); bp1.type='highpass'; bp1.frequency.value=200; // –ø—Ä–∏–±—Ä–∞—Ç–∏ —ñ–Ω—Ñ—Ä–∞–Ω–∏–∑—å–∫—ñ
  const fullGain=actx.createGain(); fullGain.gain.value=1.0;

  // envelope: |BP(audio)| -> LP
  const absGain=actx.createGain(); absGain.gain.value=1.0;
  const envLP=actx.createBiquadFilter(); envLP.type='lowpass'; envLP.frequency.value=(parseFloat($('#envLP').value)||2)*1000;

  // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
  if(mode==='mic') srcNode.connect(fullGain);
  if(mode==='file') fileSrc.connect(fullGain);
  if(mode==='emu') srcNode.connect(fullGain);

  // –°–∏—Ä–∏–π ‚Üí –∞–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä —Ç–∞ –æ—Å—Ü–∏–ª–æ–≥—Ä–∞–º–∞
  fullGain.connect(bp1).connect(analyser);
  // –î–ª—è –æ–≥–∏–Ω–∞—é—á–æ—ó
  const bpHi=actx.createBiquadFilter(); bpHi.type='bandpass'; bpHi.Q=3; bpHi.frequency.value=6000;
  fullGain.connect(bpHi).connect(absGain).connect(envLP);

  // –û—Ç—Ä–∏–º–∞—î–º–æ envelope —É ScriptProcessor
  envLP.connect(procNode);
  procNode.connect(actx.destination); // –±–µ–∑ –∑–≤—É–∫—É (–º–∞–π–∂–µ –Ω—É–ª—å–æ–≤–∏–π)

  // –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü—ñ—è
  let rawStore=new Float32Array(0), envStore=new Float32Array(0);
  procNode.onaudioprocess=(e)=>{
    const ch=e.inputBuffer.getChannelData(0);
    // ¬´–ê–±—Å–æ–ª—é—Ç¬ª —è–∫ –¥–µ—Ç–µ–∫—Ç–æ—Ä –æ–≥–∏–Ω–∞—é—á–æ—ó (–ø—Ä–∏–±–ª–∏–∑–Ω–æ)
    const tmp=new Float32Array(ch.length);
    for(let i=0;i<ch.length;i++){ tmp[i]=Math.abs(ch[i]); }
    // –∑–±–µ—Ä–µ–∂–µ–º–æ —É –º–∞—Å–∏–≤–∞—Ö —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏
    rawStore = concatKeep(rawStore, ch, 4096);
    envStore = concatKeep(envStore, tmp, 4096);
    timeBuf=rawStore; envBuf=envStore;
  };

  function concatKeep(dst, add, keep){
    const out=new Float32Array(Math.min(keep, dst.length+add.length));
    const start=Math.max(0, dst.length+add.length-keep);
    let k=0;
    for(let i=start;i<dst.length;i++) out[k++]=dst[i];
    for(let i=0;i<add.length && k<out.length;i++) out[k++]=add[i];
    return out;
  }
}

// ===== –û–±—á–∏—Å–ª–µ–Ω–Ω—è –æ–∑–Ω–∞–∫ —Ç–∞ –¥—ñ–∞–≥–Ω–æ–∑ =====
function computeOnce(){
  if(!analyser || !timeBuf.length) return null;

  // –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –æ—Å—Ü–∏–ª–æ–≥—Ä–∞–º
  const normRaw = norm01(timeBuf);
  const normEnv = norm01(envBuf);
  drawLine(wctx, normRaw, '#38bdf8', true);
  drawLine(ectx, normEnv, '#fbbf24', false);

  // –°–ø–µ–∫—Ç—Ä —Å–∏—Ä–æ–≥–æ
  const ftime=new Float32Array(NFFT); analyser.getFloatTimeDomainData(ftime);
  const ffrq=new Float32Array(NFFT/2); analyser.getFloatFrequencyData(ffrq);
  specBuf=ffrq.slice();
  drawSpec(sctx, specBuf, fs/2, '#22c55e');

  // –°–ø–µ–∫—Ç—Ä envelope (–æ–≥–∏–Ω–∞—é—á–æ—ó): —Å–∞–º—ñ —Ä–∞—Ö—É—î–º–æ FFT —á–µ—Ä–µ–∑ Analyser –Ω–µ–º–æ–∂–ª–∏–≤–æ ‚Äî –∑—Ä–æ–±–∏–º–æ –ø—Ä–∏–º—ñ—Ç–∏–≤–Ω—É DFT
  const envArr=envBuf.slice(-NFFT);
  const mag=fftMag(envArr); especBuf=mag.db;
  drawSpec(exctx, especBuf, mag.maxHz, '#fbbf24');

  // –ö–µ–ø—Å—Ç—Ä—É–º (—Ä–µ–∞–ª—å–Ω–∏–π –∫–µ–ø—Å—Ç—Ä—É–º –≤—ñ–¥ log|FFT|)
  const cepObj=cepstrumFromMag(mag.mag);
  cepBuf=cepObj.cep; drawLine(cctx, norm01(cepBuf.slice(0,cepBuf.length/2)), '#34d399', false);
  const peaksC=cepObj.peaks.slice(0,3).map(p=>`${p.q.toFixed(4)}c (${(1/p.q).toFixed(1)} –ì—Ü)`).join(', ');
  $('#cepInfo').textContent='–ö–µ–ø—Å—Ç—Ä–∞–ª—å–Ω—ñ –ø—ñ–∫–∏: '+(peaksC||'‚Äî');

  // –û–∑–Ω–∞–∫–∏
  const rms = Math.sqrt(normRaw.reduce((s,x)=>s+x*x,0)/normRaw.length);
  const mean = normRaw.reduce((s,x)=>s+x,0)/normRaw.length;
  const std = Math.sqrt(normRaw.reduce((s,x)=>s+(x-mean)*(x-mean),0)/normRaw.length);
  const kurt = normRaw.reduce((s,x)=>s+Math.pow((x-mean)/std,4),0)/normRaw.length;
  const crest = (Math.max(...normRaw)+1e-9)/(rms+1e-9);
  const cent = spectralCentroid(specBuf, fs/2);
  const peak = specPeak(specBuf, fs/2);
  const pratio = peak.db - medianDb(specBuf);

  $('#last').textContent = `RMS=${rms.toFixed(3)}, Kurt=${kurt.toFixed(2)}, Crest=${crest.toFixed(2)}`;

  // –û—á—ñ–∫—É–≤–∞–Ω—ñ —á–∞—Å—Ç–æ—Ç–∏
  const fr1x = (parseFloat($('#rpm').value)||900)/60;
  const z = parseFloat($('#teeth').value)||30;
  const gmf = fr1x*z; $('#gmf').textContent='–û—á—ñ–∫—É–≤–∞–Ω–∏–π GMF: '+gmf.toFixed(1)+' –ì—Ü';

  // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏ + –ø—ñ–¥–∫–∞–∑–∫–∏ –∑ –æ–≥–∏–Ω–∞—é—á–æ—ó
  const envPeaks = topPeaks(especBuf, fs/(2*NFFT), 5, 5, 5); // –º–∞—Å–∏–≤ {f,db}
  const oneX = nearPeak(specBuf, fs/2, fr1x, 0.1*fr1x);
  const twoX = nearPeak(specBuf, fs/2, 2*fr1x, 0.1*fr1x);
  const gmfHit = nearPeak(specBuf, fs/2, gmf, Math.max(2,0.05*gmf));

  let diag='normal';
  if(oneX.hit && !twoX.hit && pratio>12 && kurt<4) diag='unbalance';
  if(oneX.hit && twoX.hit && pratio>10) diag='misalignment';
  if(kurt>6 || crest>4.0 || envPeaks.length>=2) diag='bearing';
  if(gmfHit.hit) diag='gearmesh';
  if((std>0.22 && crest>3.5) || (oneX.hit && envPeaks.some(p=>Math.abs(p.f-fr1x)<0.2*fr1x))) diag='looseness';

  $('#diag').textContent = '–î—ñ–∞–≥–Ω–æ–∑: ' + diag;

  const featRow={t:new Date().toISOString(), rms, kurt, crest, cent, peakF:peak.f, peakDb:peak.db, pratio, oneX:oneX.db, twoX:twoX.db, envTop:envPeaks.map(p=>p.f.toFixed(1)).join('|'), diag};
  featsLog.push(featRow);
  return featRow;
}

function norm01(arr){
  if(!arr || !arr.length) return new Float32Array(0);
  let mi=Infinity, ma=-Infinity; for(let i=0;i<arr.length;i++){ const v=arr[i]; if(v<mi) mi=v; if(v>ma) ma=v; }
  const out=new Float32Array(arr.length); const den=(ma-mi)||1;
  for(let i=0;i<arr.length;i++) out[i]=(arr[i]-mi)/den;
  for(let i=0;i<out.length;i++) out[i]=(out[i]-0.5)*2; // -1..1
  return out;
}

function spectralCentroid(db, maxHz){
  const step=maxHz/(db.length-1);
  let num=0,den=0;
  for(let i=1;i<db.length;i++){ const a=Math.pow(10, db[i]/20); num+=i*step*a; den+=a; }
  return den>0? num/den : 0;
}
function specPeak(db, maxHz){
  let im=1, mx=-1e9;
  for(let i=1;i<db.length;i++){ if(db[i]>mx){mx=db[i]; im=i;} }
  return {f: im*(maxHz/(db.length-1)), db: mx};
}
function medianDb(db){
  const a=db.slice(1).map(x=>x).sort((x,y)=>x-y);
  return a[Math.floor(a.length/2)];
}
function nearPeak(db, maxHz, f0, tol){
  const step=maxHz/(db.length-1);
  const i0=Math.round(f0/step);
  let mx=-1e9, idx=-1;
  for(let i=Math.max(1,i0-Math.round(tol/step)); i<=Math.min(db.length-1,i0+Math.round(tol/step)); i++){
    if(db[i]>mx){mx=db[i]; idx=i;}
  }
  return {hit: mx>-40, f: idx*step, db: mx};
}
function topPeaks(db, stepHz, n=5, minSep=5, floor=8){
  // –ø–æ—à—É–∫ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –º–∞–∫—Å–∏–º—É–º—ñ–≤ —É dB-–º–∞—Å–∏–≤—ñ
  const peaks=[];
  for(let i=2;i<db.length-2;i++){
    if(db[i]>db[i-1] && db[i]>db[i+1]){
      const f=i*stepHz;
      const val=db[i]-medianDb(db);
      if(val>floor){
        if(!peaks.some(p=>Math.abs(p.f-f)<minSep)) peaks.push({f,db:db[i]});
      }
    }
  }
  peaks.sort((a,b)=>b.db-a.db);
  return peaks.slice(0,n);
}

// –ü—Ä–∏–º—ñ—Ç–∏–≤–Ω–∞ FFT-–º–∞–≥–Ω—ñ—Ç—É–¥–∞ —á–µ—Ä–µ–∑ Analyser –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞; —Ç—É—Ç ‚Äî Goertzel-–ø–æ–¥—ñ–±–Ω–∞ –î–ü–§ (–¥–ª—è –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É)
function fftMag(x){
  const N=nearestPow2(x.length); const arr=x.slice(x.length-N);
  const mag=new Float32Array(N/2);
  for(let k=1;k<N/2;k++){
    let re=0, im=0;
    const w=-2*Math.PI*k/N;
    for(let n=0;n<N;n++){ const ph=w*n; const v=arr[n]; re+=v*Math.cos(ph); im+=v*Math.sin(ph); }
    mag[k]=Math.sqrt(re*re+im*im)/N;
  }
  const db=new Float32Array(N/2);
  for(let k=1;k<N/2;k++){ db[k]=20*Math.log10(mag[k]+1e-9); }
  return {mag, db, maxHz: fs/2};
}
function nearestPow2(n){ let p=1; while(p*2<=n) p*=2; return p; }

function cepstrumFromMag(m){
  const N=m.length*2; // —Å–∏–º–µ—Ç—Ä—ñ—è
  // –ª–æ–≥ —Å–ø–µ–∫—Ç—Ä–∞
  const L=new Float32Array(m.length);
  for(let i=1;i<m.length;i++){ L[i]=Math.log(m[i]+1e-9); }
  // IDFT(log|X|) ‚Äî —Ä–µ–∞–ª—å–Ω–∏–π –∫–µ–ø—Å—Ç—Ä—É–º
  const cep=new Float32Array(m.length);
  for(let n=1;n<m.length;n++){
    let s=0;
    for(let k=1;k<m.length;k++){ s+= L[k]*Math.cos(2*Math.PI*k*n/(m.length*2)); }
    cep[n]=s/m.length;
  }
  // –ø–æ—à—É–∫ –ø—ñ–∫—ñ–≤ —É –∫–µ–ø—Å—Ç—Ä—É–º—ñ (queffrency —Å–µ–∫)
  const peaks=[];
  for(let n=2;n<cep.length/2;n++){
    if(cep[n]>cep[n-1] && cep[n]>cep[n+1]){
      const q=n/fs; // —Å–µ–∫—É–Ω–¥–∏
      const val=cep[n];
      peaks.push({q,val});
    }
  }
  peaks.sort((a,b)=>b.val-a.val);
  return {cep, peaks:peaks.slice(0,5)};
}

// ===== –¶–∏–∫–ª =====
let reqId=null;
function loop(){
  computeOnce();
  reqId=requestAnimationFrame(loop);
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç/–∫–Ω–æ–ø–∫–∏ =====
$('#pngOsci').addEventListener('click', ()=> savePNGs([wave,env], 'osci'));
$('#pngSpec').addEventListener('click', ()=> savePNGs([spec,espec], 'spec'));
$('#pngCep').addEventListener('click', ()=> savePNGs([cep], 'cep'));
$('#expPNG').addEventListener('click', ()=> savePNGs([wave,env,spec,espec,cep], 'all'));

function savePNGs(canvases, tag){
  const pad=10;
  const W=Math.max(...canvases.map(c=>c.width));
  const H=canvases.reduce((s,c)=>s+c.height+pad,0);
  const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H;
  const tctx=tmp.getContext('2d'); let y=0;
  canvases.forEach(c=>{ tctx.drawImage(c,0,y); y+=c.height+pad; });
  tmp.toBlob(b=>{ const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='mech_para20_'+tag+'_'+stamp()+'.png'; a.click(); URL.revokeObjectURL(u); });
}

$('#clear').addEventListener('click', ()=>{ featsLog.length=0; wctx.clearRect(0,0,wave.width,wave.height); ectx.clearRect(0,0,env.width,env.height); sctx.clearRect(0,0,spec.width,spec.height); exctx.clearRect(0,0,espec.width,espec.height); cctx.clearRect(0,0,cep.width,cep.height); });

$('#mark').addEventListener('click', ()=>{
  const lab=$('#label').value;
  const last=featsLog[featsLog.length-1]||{};
  log(`–ü–æ–∑–Ω–∞—á–∫–∞: ${lab} | diag=${last.diag||'‚Äî'} | Kurt=${(last.kurt||0).toFixed?.(2)??'‚Äî'} | crest=${(last.crest||0).toFixed?.(2)??'‚Äî'}`);
});

$('#expCSV').addEventListener('click', ()=>{
  const head='t_iso,rms,kurt,crest,centroid,peakF,peakDb,pratio,oneXdb,twoXdb,envTopHz,diag\n';
  const body=featsLog.map(r=>`${r.t},${r.rms?.toFixed(4)||''},${r.kurt?.toFixed(2)||''},${r.crest?.toFixed(2)||''},${r.cent?.toFixed(1)||''},${r.peakF?.toFixed(1)||''},${r.peakDb?.toFixed(1)||''},${r.pratio?.toFixed(1)||''},${r.oneX?.toFixed(1)||''},${r.twoX?.toFixed(1)||''},"${r.envTop||''}",${r.diag||''}`).join('\n');
  download('mechanic_para20_feats_'+stamp()+'.csv', head+body, 'text/csv');
});
$('#expTXT').addEventListener('click', ()=>{
  const last=featsLog[featsLog.length-1]||{};
  const lines=[
    '–ü–∞—Ä–∞ 20 ‚Äî –ê–∫—É—Å—Ç–∏—á–Ω–∏–π —Å—Ç–µ—Ç–æ—Å–∫–æ–ø –ø—ñ–¥—à–∏–ø–Ω–∏–∫—ñ–≤ —Ä–µ–¥—É–∫—Ç–æ—Ä–∞',
    'RPM –≤–∞–ª—É: '+$('#rpm').value+'; –∑—É–±—Ü—ñ–≤: '+$('#teeth').value+'; LP(env): '+$('#envLP').value+' –∫–ì—Ü',
    '–î—ñ–∞–≥–Ω–æ–∑: '+(last.diag||'‚Äî'),
    '–û–∑–Ω–∞–∫–∏: RMS='+fmt(last.rms)+' Kurt='+fmt(last.kurt)+' Crest='+fmt(last.crest)+' Centroid='+fmt(last.cent)+'Hz Peak='+fmt(last.peakF)+'Hz ('+fmt(last.peakDb)+' dB)',
    'ENV —Ç–æ–ø –ø—ñ–∫–∏ (–ì—Ü): '+(last.envTop||'‚Äî'),
    '--- –ß–µ–∫-–ª–∏—Å—Ç –¥—ñ–π ---',
    '- –Ø–∫—â–æ 1X –¥–æ–º—ñ–Ω—É—î ‚Üí –æ—á–∏—Å—Ç–∏—Ç–∏/–≤—ñ–¥–±–∞–ª–∞–Ω—Å—É–≤–∞—Ç–∏ –∫–æ–ª–µ—Å–æ, –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —à–ø–æ–Ω–∫—É/–ø–æ—Å–∞–¥–∫—É.',
    '- –Ø–∫—â–æ 2X –¥–æ–º—ñ–Ω—É—î ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–ø—ñ–≤–≤—ñ—Å–Ω—ñ—Å—Ç—å, –ø—ñ–¥–∫–ª–∞–¥–∫–∏, –ø–µ—Ä–µ–∫–æ—Å–∏.',
    '- –Ø–∫—â–æ Kurtosis —Ä–æ—Å—Ç–µ, ENV –º–∞—î –≥—Ä–µ–±—ñ–Ω—å ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –º–∞—Å—Ç–∏–ª–æ/–≥–µ—Ä–º–µ—Ç–∏—á–Ω—ñ—Å—Ç—å, –ø–ª–∞–Ω—É–≤–∞—Ç–∏ –∑–∞–º—ñ–Ω—É –ø—ñ–¥—à–∏–ø–Ω–∏–∫–∞.',
    '- –Ø–∫—â–æ GMF —ñ –±—ñ—á–Ω—ñ —Å–º—É–≥–∏ ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä –≤–µ—Å—Ç–∏–∫—É/–∑–∞–∑–æ—Ä –∑—É–±—Ü—ñ–≤, –∑–º–∞—â–µ–Ω–Ω—è, –∑–Ω–æ—Å.'
  ];
  download('mechanic_para20_summary_'+stamp()+'.txt', lines.join('\n'));
});
$('#receipt').addEventListener('click', ()=>{
  const items=logbook.slice(-10);
  const lines=['=== –ß–ï–ö –°–¢–ï–¢–û–°–ö–û–ü–ê (58–º–º) ===','–î–∞—Ç–∞: '+new Date().toISOString().slice(0,10),'---'];
  if(items.length===0){ lines.push('–ü–æ–¥—ñ–π –Ω–µ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ'); } else { items.forEach(l=>lines.push(`[${l.t}] ${l.msg}`)); }
  const el=$('#rc'); el.hidden=false; el.textContent=lines.join('\n');
  download('para20_receipt_'+stamp()+'.txt', lines.join('\n'));
});

function fmt(x){ return (x==null||isNaN(x))?'‚Äî':(typeof x==='number'?x.toFixed?.(2):x); }

// ===== –ö–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø =====
$('#start').addEventListener('click', ()=>{
  if(actx) return;
  actx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  fs=actx.sampleRate; NFFT=parseInt($('#fft').value)||4096;
  const mode=$('#src').value;
  if(mode==='mic') startMic();
  if(mode==='file') startFile();
  if(mode==='emu'){ $('#emuBox').style.display='block'; startEmu(); }
});
$('#stop').addEventListener('click', ()=>{ if(reqId) cancelAnimationFrame(reqId), reqId=null; stopAll(); });
$('#src').addEventListener('change', ()=>{
  $('#fileBox').style.display = ($('#src').value==='file')?'flex':'none';
  $('#emuBox').style.display  = ($('#src').value==='emu')?'block':'none';
});
$('#fft').addEventListener('change', ()=>{ if(actx){ alert('–ó–º—ñ–Ω—ñ—Ç—å FFT –ø—ñ—Å–ª—è –°—Ç–æ–ø'); }});

// ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
if (window.self !== window.top) document.documentElement.classList.add('embedded'); // LMS-friendly
</script>
</body>
</html>
