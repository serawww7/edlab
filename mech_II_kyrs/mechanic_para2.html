<script>
// === PRINT v2: зовнішня сторінка друку через localStorage ===
// ВАЖЛИВО: файл друку має бути доступний за URL типу .../print-58mm.html

function printTicketNewTab(){
  const ticket = document.getElementById('ticket');
  if(!ticket){ alert('Немає #ticket на сторінці'); return; }

  // Якщо чек ще порожній — згенеруємо
  try{
    const raw = (ticket.textContent || '').replace(/\s+/g,'');
    const onlyDashes = raw.replace(/—/g,'');
    if(!raw || !onlyDashes){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  // Пакуємо HTML у localStorage
  const html = ticket.outerHTML;
  const id = createPrintJob(html);
  if(!id){ return; } // помилка запису

  // Відкриваємо зовнішню сторінку друку з id у query
  const url = new URL('print-58mm.html', location.href); // <- заміни ім'я, якщо інше
  url.searchParams.set('id', id);

  const w = window.open(url.toString(), '_blank', 'noopener,noreferrer,width=480,height=800');
  if(!w){
    alert('Браузер заблокував спливаюче вікно. Дозволь попапи для сайту й натисни ще раз.');
  }
}

// Створює «завдання друку» в localStorage
function createPrintJob(html){
  const id = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  const key = 'print_job_' + id;
  const payload = { html: String(html) };

  try{
    // Перевіримо квоту/доступ
    localStorage.setItem(key, JSON.stringify(payload));
    return id;
  }catch(e){
    console.error('localStorage print job error:', e);
    alert('Не вдалося записати дані для друку в localStorage. Перевір доступ або спробуй очистити місце.');
    return null;
  }
}
</script>
