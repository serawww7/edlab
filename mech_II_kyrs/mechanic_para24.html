<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 24 (–º–µ—Ö–∞–Ω—ñ–∫–∏) ‚Äî –®–Ü#4: –ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ñ–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç—ñ–≤ (ISO-—á–µ–∫-–ª–∏—Å—Ç, heatmap, –Ω–∞–≤—á–∞–Ω–Ω—è)</title>
<meta name="description" content="–§–æ—Ç–æ/–∫–∞–º–µ—Ä–∞ ‚Üí ROI ‚Üí –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è –¥–µ—Ñ–µ–∫—Ç—ñ–≤: –≤–∏—Ç—ñ–∫/–º–∞—Å–ª–æ, –∫–æ—Ä–æ–∑—ñ—è, —Ç—Ä—ñ—â–∏–Ω–∞, –∑–Ω–æ—Å/–ø—ñ—Ç—Ç—ñ–Ω–≥, –ø–µ—Ä–µ–∫—ñ—Å, –ø–æ—Å–ª–∞–±–ª–µ–Ω–µ –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è. Heatmap-–ø–æ—è—Å–Ω–µ–Ω–Ω—è, –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ —Å–≤–æ—ó—Ö –ø—Ä–∏–∫–ª–∞–¥–∞—Ö, ISO-—á–µ–∫-–ª–∏—Å—Ç, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT/58–º–º."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1220px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:100px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
small.mono,.mono{font-family:ui-monospace,monospace}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
video,canvas{display:block;max-width:100%}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.grid{display:grid;gap:14px;grid-template-columns:1.35fr 1fr}
@media(max-width:1120px){.grid{grid-template-columns:1fr}}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üß†</span>
      <div>
        <b>–ü–∞—Ä–∞ 24 ‚Äî –ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ñ–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç—ñ–≤ (–®–Ü —É –±—Ä–∞—É–∑–µ—Ä—ñ)</b><br/>
        <span class="badge">ROI ‚Üí –∫–ª–∞—Å–∏ ‚Üí heatmap ‚Üí ISO-—á–µ–∫-–ª–∏—Å—Ç ‚Üí –Ω–∞–≤—á–∞–Ω–Ω—è ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –Ω–∞–≤—á–∏—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ –±–∞—á–∏—Ç–∏ –¥–µ—Ñ–µ–∫—Ç–∏** –Ω–∞ —Ñ–æ—Ç–æ –≤—É–∑–ª—ñ–≤ —ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ **—Å–ø—Ä–æ—â–µ–Ω—ñ –æ–∑–Ω–∞–∫–∏ CV** –¥–ª—è –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ –ø–æ—è—Å–Ω–µ–Ω—å. –ö–ª–∞—Å–∏: <b>oil</b> (–≤–∏—Ç—ñ–∫/–º–∞—Å–ª–æ), <b>rust</b> (–∫–æ—Ä–æ–∑—ñ—è), <b>crack</b> (—Ç—Ä—ñ—â–∏–Ω–∞/—Å–∫–æ–ª), <b>wear</b> (–∑–Ω–æ—Å/–ø—ñ—Ç—Ç—ñ–Ω–≥), <b>misalign</b> (–ø–µ—Ä–µ–∫—ñ—Å/–Ω–µ–≤–∏—Ä—ñ–≤–Ω—è–Ω–Ω—è), <b>loose</b> (–ø–æ—Å–ª–∞–±–ª–µ–Ω–µ –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è).</p>

  <div class="grid">
    <!-- –õ–Ü–í–û: –∫–∞–º–µ—Ä–∞/—Ñ–æ—Ç–æ + –ø–æ–ª–æ—Ç–Ω–æ + –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ -->
    <div class="card">
      <h2>üé• –î–∂–µ—Ä–µ–ª–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h2>
      <div class="row">
        <select id="src" class="input" style="max-width:220px">
          <option value="cam" selected>–í–µ–±–∫–∞–º–µ—Ä–∞</option>
          <option value="img">–§–æ—Ç–æ (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏)</option>
        </select>
        <select id="camSel" class="input" style="max-width:260px"></select>
        <select id="res" class="input" style="max-width:160px">
          <option>640x480</option><option selected>1280x720</option><option>1920x1080</option>
        </select>
        <input id="file" class="input" type="file" accept="image/*" style="display:none"/>
        <button class="btn good" id="start">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button class="btn secondary" id="shot">üì∏ –ó–Ω—ñ–º–æ–∫</button>
        <button class="btn secondary" id="stop">‚èπÔ∏è –°—Ç–æ–ø</button>
        <span id="stat" class="badge">–°—Ç–∞—Ç—É—Å: idle</span>
      </div>

      <div class="row" style="margin-top:6px">
        <label>Heatmap<span class="mono"> Œ±</span><input id="alpha" class="input" type="range" min="0" max="1" step="0.05" value="0.6"/></label>
        <label>Edge thr<input id="thrE" class="input" type="range" min="8" max="80" step="1" value="26"/></label>
        <label>Shiny V%<input id="thrV" class="input" type="range" min="40" max="95" step="1" value="75"/></label>
        <label>Low-Sat S%<input id="thrS" class="input" type="range" min="5" max="60" step="1" value="18"/></label>
      </div>

      <div class="canvasWrap" style="margin-top:8px">
        <canvas id="view" width="960" height="540"></canvas>
      </div>
      <small class="muted">–ü–æ–±—É–¥—É–π **ROI**: –º–∏—à–µ—é –ø–æ—Ç—è–≥–Ω–∏ –ø–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—é –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫. <b>Shift+–∫–ª—ñ–∫ √ó2</b> ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ –ø–µ—Ä–µ–∫–æ—Å—É (–∫—É—Ç).</small>

      <h3 style="margin-top:10px">üìä –ú–µ—Ç—Ä–∏–∫–∏ ROI</h3>
      <table class="tbl">
        <tbody>
          <tr><th>Edge density</th><td id="m_edge">‚Äî</td></tr>
          <tr><th>Specular/oil ratio</th><td id="m_oil">‚Äî</td></tr>
          <tr><th>Brown (rust) ratio</th><td id="m_rust">‚Äî</td></tr>
          <tr><th>Low-sat ratio</th><td id="m_lowS">‚Äî</td></tr>
          <tr><th>Misalign angle</th><td id="m_ang">‚Äî</td></tr>
          <tr><th>–ö–ª–∞—Å (k-NN)</th><td id="m_cls">‚Äî</td></tr>
        </tbody>
      </table>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="analyze">üîç –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ ROI</button>
        <button class="btn secondary" id="overlay">üß© Heatmap on/off</button>
        <button class="btn secondary" id="savePng">üñºÔ∏è PNG (–∫–∞–¥—Ä+heatmap)</button>
        <button class="btn secondary" id="saveCsv">üìÑ CSV (–º–µ—Ç—Ä–∏–∫–∏+–∫–ª–∞—Å)</button>
      </div>
    </div>

    <!-- –ü–†–ê–í–û: –Ω–∞–≤—á–∞–Ω–Ω—è, —á–µ–∫-–ª–∏—Å—Ç, –∂—É—Ä–Ω–∞–ª, –µ–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üß† –ù–∞–≤—á–∞–Ω–Ω—è –Ω–∞ —Å–≤–æ—ó—Ö –ø—Ä–∏–∫–ª–∞–¥–∞—Ö (k-NN)</h2>
      <div class="row">
        <select id="label" class="input" style="max-width:200px">
          <option value="oil">oil</option>
          <option value="rust">rust</option>
          <option value="crack">crack</option>
          <option value="wear">wear</option>
          <option value="misalign">misalign</option>
          <option value="loose">loose</option>
        </select>
        <button class="btn" id="addShot">‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ ROI</button>
        <button class="btn secondary" id="exportShots">üíæ –ï–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn secondary" id="importShots">üì• –Ü–º–ø–æ—Ä—Ç JSON</button>
      </div>
      <pre id="shotsBox" class="code small" style="max-height:160px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ (–¥–æ–¥–∞–π 3‚Äì5 –Ω–∞ –∫–æ–∂–µ–Ω –∫–ª–∞—Å)</pre>

      <h2 style="margin-top:10px">üìã ISO-—á–µ–∫-–ª–∏—Å—Ç –æ–≥–ª—è–¥—É –≤—É–∑–ª–∞</h2>
      <div id="checklist" class="note small">
        <label><input type="checkbox"/> –û—á–∏—Å—Ç–∏—Ç–∏ –≤—É–∑–æ–ª (–±–µ–∑–ø–µ–∫–∞: LOTO, –ó–Ü–ó), –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ñ–æ—Ç–æ.</label><br/>
        <label><input type="checkbox"/> –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏—Ç–æ–∫–∏/–º–∞—Å–ª–æ –Ω–∞–≤–∫–æ–ª–æ –ø—Ä–æ–∫–ª–∞–¥–æ–∫/—à–≤—ñ–≤ (ISO 4406 –∫–æ–Ω—Ç–∞–º—ñ–Ω.).</label><br/>
        <label><input type="checkbox"/> –û—Ü—ñ–Ω–∏—Ç–∏ –∫–æ—Ä–æ–∑—ñ—é (—Å—Ç—É–ø—ñ–Ω—å –ø–æ–∫—Ä–∏—Ç—Ç—è, –ª—É—Å–æ—á–∫–∏/—ñ—Ä–∂–∞, –ø—ñ–¥—Ñ–∞—Ä–±—É–≤–∞—Ç–∏/–∑–∞–º—ñ–Ω–∞).</label><br/>
        <label><input type="checkbox"/> –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç—Ä—ñ—â–∏–Ω–∏/—Å–∫–æ–ª–∏ (–∑–±—ñ–ª—å—à–µ–Ω–Ω—è, –±–∞—Ä–≤–Ω–∏–∫-–ø—Ä–æ–Ω–∏–∫–Ω–∏–∫, NDT –∑–∞ –ø–æ—Ç—Ä–µ–±–∏).</label><br/>
        <label><input type="checkbox"/> –ó–Ω–æ—Å/–ø—ñ—Ç—Ç—ñ–Ω–≥ –Ω–∞ –∑—É–±–∞—Ö/—Ä–æ–ª–∏–∫–∞—Ö (—à–æ—Ä—Å—Ç–∫—ñ—Å—Ç—å, –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π –ª—é—Ñ—Ç).</label><br/>
        <label><input type="checkbox"/> –ü–µ—Ä–µ–∫—ñ—Å/–Ω–µ–≤–∏—Ä—ñ–≤–Ω—è–Ω–Ω—è (–∫—É—Ç &lt; 2¬∞ –≤—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ—ó –ª—ñ–Ω—ñ—ó).</label><br/>
        <label><input type="checkbox"/> –ö—Ä—ñ–ø–ª–µ–Ω–Ω—è: –º–æ–º–µ–Ω—Ç –∑–∞—Ç—è–≥—É–≤–∞–Ω–Ω—è –∑–∞ –º–∞–Ω—É–∞–ª–æ–º, –º–∞—Ä–∫–µ—Ä-—Ñ–∞—Ä–±–∞.</label>
      </div>

      <h2 style="margin-top:10px">üìú –ñ—É—Ä–Ω–∞–ª —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç</h2>
      <div class="row">
        <button class="btn" id="mark">üìå –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –ø–æ–¥—ñ—é</button>
        <select id="lab2" class="input" style="max-width:200px">
          <option>ok</option><option>oil</option><option>rust</option><option>crack</option><option>wear</option><option>misalign</option><option>loose</option>
        </select>
      </div>
      <pre id="alog" class="code small" style="max-height:160px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –∑–∞–ø–∏—Å—ñ–≤</pre>

      <div class="row">
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn" id="saveTasks">üìù TXT (–∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç–∞)</button>
        <button class="btn" id="receipt">üñ®Ô∏è 58 –º–º —á–µ–∫</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
    </div>
  </div>

  <div class="card">
    <h2>üìö –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ (–≤–±—É–¥–æ–≤–∞–Ω–æ)</h2>
    <ol>
      <li>–ó—Ä–æ–±–∏ **2 —Ñ–æ—Ç–æ ¬´–¥–æ/–ø—ñ—Å–ª—è¬ª –æ—á–∏—â–µ–Ω–Ω—è**. –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–∏ <b>PNG</b> (–∑ heatmap) —Ç–∞ <b>CSV</b> (–º–µ—Ç—Ä–∏–∫–∏+–∫–ª–∞—Å).</li>
      <li>–ü–æ–±—É–¥—É–π **–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É –ª—ñ–Ω—ñ—é** (<kbd>Shift</kbd>+–∫–ª—ñ–∫ √ó2) —ñ –¥–æ–±–∏–π—Å—è |–∫—É—Ç| &lt; <span class="mono">2¬∞</span> –¥–ª—è –≤–∞–ª—ñ–≤/—à–∫—ñ–≤—ñ–≤. –î–æ–¥–∞–π –∑–∞–ø–∏—Å —É –∂—É—Ä–Ω–∞–ª.</li>
      <li>–ù–∞–≤—á–∏ k-NN: –¥–æ–¥–∞–π **–ø–æ 3‚Äì5 –ø—Ä–∏–∫–ª–∞–¥—ñ–≤** –Ω–∞ –∫–ª–∞—Å (oil/rust/‚Ä¶). –ü–æ–≤—Ç–æ—Ä–∏ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—é —ñ –ø–æ—Ä—ñ–≤–Ω—è–π –∑–º—ñ–Ω–∏. –ï–∫—Å–ø–æ—Ä—Ç—É–π JSON —ñ–∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏.</li>
      <li>–ó–∞–ø–æ–≤–Ω–∏ **ISO-—á–µ–∫-–ª–∏—Å—Ç** (–≥–∞–ª–æ—á–∫–∏), —Å—Ñ–æ—Ä–º—É–π **TXT-–∑–≤—ñ—Ç** —Ç–∞ **—á–µ–∫ 58 –º–º**.</li>
    </ol>
  </div>

  <div class="card">
    <h2>üîå –°—Ö–µ–º–∞ (SVG)</h2>
    <svg viewBox="0 0 980 260" role="img" aria-label="–§–æ—Ç–æ ‚Üí ROI ‚Üí –æ–∑–Ω–∞–∫–∏ ‚Üí k-NN ‚Üí –∫–ª–∞—Å/heatmap">
      <rect x="40" y="60" width="220" height="100" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
      <text x="150" y="92" fill="#e5e7eb" font-size="14" text-anchor="middle">–§–æ—Ç–æ/–∫–∞–º–µ—Ä–∞</text>
      <text x="150" y="112" fill="#93c5fd" font-size="12" text-anchor="middle">ROI + –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è</text>

      <rect x="290" y="50" width="220" height="120" rx="12" fill="#14532d" stroke="#22c55e"/>
      <text x="400" y="90" fill="#dcfce7" font-size="14" text-anchor="middle">–û–∑–Ω–∞–∫–∏</text>
      <text x="400" y="108" fill="#a7f3d0" font-size="12" text-anchor="middle">edge, oil, rust, low-sat, angle</text>

      <rect x="540" y="50" width="220" height="120" rx="12" fill="#1f2937" stroke="#9ca3af"/>
      <text x="650" y="90" fill="#e5e7eb" font-size="14" text-anchor="middle">k-NN –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ç–æ—Ä</text>
      <text x="650" y="108" fill="#93c5fd" font-size="12" text-anchor="middle">–Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ —Å–≤–æ—ó—Ö –ø—Ä–∏–∫–ª–∞–¥–∞—Ö</text>

      <rect x="790" y="50" width="150" height="120" rx="12" fill="#0b1a2f" stroke="#64748b"/>
      <text x="865" y="90" fill="#e5e7eb" font-size="14" text-anchor="middle">–ö–ª–∞—Å + Heatmap</text>
      <text x="865" y="108" fill="#93c5fd" font-size="12" text-anchor="middle">–µ–∫—Å–ø–æ—Ä—Ç CSV/PNG</text>

      <line x1="260" y1="110" x2="290" y2="110" stroke="#93c5fd" stroke-width="3"/>
      <line x1="510" y1="110" x2="540" y2="110" stroke="#22c55e" stroke-width="3"/>
      <line x1="760" y1="110" x2="790" y2="110" stroke="#64748b" stroke-width="3"/>
    </svg>
  </div>

  <div class="card">
    <h2>üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
    <p class="muted small">–©–µ –¥–æ –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂ –∑–∞–≤–æ–¥–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞–ª–∏ ¬´–∫–æ–ª—å–æ—Ä–æ–≤—ñ –∫–∞—Ä—Ç–∏ –¥–µ—Ñ–µ–∫—Ç—ñ–≤¬ª ‚Äî –∑–∞ –º–∞—Å–∫–æ—é —ñ—Ä–∂—ñ/–º–∞—Å–ª–∞ –≤–∏—Ä—ñ—à—É–≤–∞–ª–∏, —á–∏ —Ç—Ä–µ–±–∞ —Ä–µ–º–æ–Ω—Ç. –ú–∏ –≤—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ —Ü–µ–π –ø—ñ–¥—Ö—ñ–¥ —É –±—Ä–∞—É–∑–µ—Ä—ñ –π –¥–æ–¥–∞—î–º–æ –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ —Å–≤–æ—ó—Ö –ø—Ä–∏–∫–ª–∞–¥–∞—Ö.</p>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

// ===== –ö–∞–º–µ—Ä–∞/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è =====
let stream=null, video=null;
const camSel=$('#camSel'), resSel=$('#res'), srcSel=$('#src');
const view=$('#view'), vctx=view.getContext('2d');
let overlayOn=true;

async function listCams(){
  try{
    const devs=await navigator.mediaDevices.enumerateDevices();
    const cams=devs.filter(d=>d.kind==='videoinput');
    camSel.innerHTML=''; cams.forEach((c,i)=>{const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||('–ö–∞–º–µ—Ä–∞ '+(i+1)); camSel.appendChild(o);});
  }catch{}
}
listCams();

async function startCam(){
  try{
    const [w,h]=resSel.value.split('x').map(Number);
    stream = await navigator.mediaDevices.getUserMedia({video:{deviceId: camSel.value?{exact:camSel.value}:undefined, width:{ideal:w}, height:{ideal:h}}, audio:false});
    video=document.createElement('video'); video.srcObject=stream; video.muted=true; await video.play();
    view.width=video.videoWidth; view.height=video.videoHeight;
    $('#stat').textContent='–°—Ç–∞—Ç—É—Å: camera ok';
    loop();
  }catch(err){ alert('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: '+err.message); $('#stat').textContent='–°—Ç–∞—Ç—É—Å: –ø–æ–º–∏–ª–∫–∞'; }
}
function stopCam(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video=null; $('#stat').textContent='–°—Ç–∞—Ç—É—Å: idle';
}

$('#src').addEventListener('change', ()=>{
  const useImg = ($('#src').value==='img');
  $('#file').style.display = useImg?'block':'none';
  if(useImg){ stopCam(); $('#stat').textContent='–°—Ç–∞—Ç—É—Å: —Ñ–æ—Ç–æ'; }
});
$('#start').addEventListener('click', ()=>{
  if($('#src').value==='cam'){ startCam(); }
  else { $('#file').click(); }
});
$('#file').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=new Image();
  img.onload=()=>{ view.width=img.width; view.height=img.height; vctx.drawImage(img,0,0); $('#stat').textContent='–°—Ç–∞—Ç—É—Å: —Ñ–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ'; };
  img.src=URL.createObjectURL(f);
});
$('#shot').addEventListener('click', ()=>{
  if(!video){ log('–ó–Ω—ñ–º–æ–∫: –Ω–µ–º–∞—î –≤—ñ–¥–µ–æ'); return; }
  vctx.drawImage(video,0,0,view.width,view.height);
  log('–ö–∞–¥—Ä –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ');
});
$('#stop').addEventListener('click', ()=>{ stopCam(); });

// ===== ROI (–º–∏—à–∫–æ—é) =====
let roi=null, dragging=false, startPt=null;
view.addEventListener('mousedown', (e)=>{
  const r=view.getBoundingClientRect();
  startPt={x:(e.clientX-r.left)*(view.width/r.width), y:(e.clientY-r.top)*(view.height/r.height)};
  dragging=true;
});
view.addEventListener('mousemove', (e)=>{
  if(!dragging) return;
  const r=view.getBoundingClientRect();
  const x=(e.clientX-r.left)*(view.width/r.width), y=(e.clientY-r.top)*(view.height/r.height);
  roi = normRect(startPt.x,startPt.y,x,y);
});
view.addEventListener('mouseup', ()=>{ dragging=false; });
function normRect(x1,y1,x2,y2){
  const x=Math.min(x1,x2), y=Math.min(y1,y2), w=Math.abs(x2-x1), h=Math.abs(y2-y1);
  return {x,y,w,h};
}

// ===== –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è (Shift+–∫–ª—ñ–∫ √ó2) –¥–ª—è –ø–µ—Ä–µ–∫–æ—Å—É =====
let aline=null;
view.addEventListener('click',(e)=>{
  if(!e.shiftKey) return;
  const r=view.getBoundingClientRect();
  const x=(e.clientX-r.left)*(view.width/r.width);
  const y=(e.clientY-r.top)*(view.height/r.height);
  if(!aline){ aline={x1:x,y1:y,x2:x,y2:y}; }
  else if(aline && (aline.x1===aline.x2 && aline.y1===aline.y2)){ aline.x2=x; aline.y2=y; }
  else { aline={x1:x,y1:y,x2:x,y2:y}; }
});

// ===== –û–±—á–∏—Å–ª–µ–Ω–Ω—è –æ–∑–Ω–∞–∫ =====
function getROIimage(){
  const W=view.width,H=view.height; if(!W||!H) return null;
  const r = roi? {...roi} : {x:0,y:0,w:W,h:H};
  const x=clamp(Math.floor(r.x),0,W-1), y=clamp(Math.floor(r.y),0,H-1);
  const w=clamp(Math.floor(r.w||W),1,W-x), h=clamp(Math.floor(r.h||H),1,H-y);
  return {img:vctx.getImageData(x,y,w,h), x,y,w,h};
}
function rgb2hsv(r,g,b){
  r/=255; g/=255; b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b); const d=mx-mn;
  let h=0;
  if(d!==0){
    if(mx===r) h=((g-b)/d)%6;
    else if(mx===g) h=(b-r)/d+2;
    else h=(r-g)/d+4;
    h*=60; if(h<0) h+=360;
  }
  const s = mx===0?0:d/mx, v=mx;
  return {h,s,v};
}
function features(){
  const R=getROIimage(); if(!R) return null;
  const {img,w,h}=R, data=img.data;
  const thrE=parseInt($('#thrE').value,10), thrV=parseInt($('#thrV').value,10)/100, thrS=parseInt($('#thrS').value,10)/100;
  let eCount=0, shiny=0, lowS=0, brown=0;
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const k=(y*w+x)*4;
      const r=data[k], g=data[k+1], b=data[k+2];
      const gx = (data[k+4]-data[k-4]) + (data[k+4*w]-data[k-4*w])*0.5;
      const gy = (data[k+4*w]-data[k-4*w]) + (data[k+4]-data[k-4])*0.5;
      const m=Math.sqrt(gx*gx+gy*gy);
      if(m>thrE) eCount++;
      const {h:hh,s,v}=rgb2hsv(r,g,b);
      if(v>thrV && s<thrS) shiny++;
      if(s<thrS) lowS++;
      // –∫–æ—Ä–æ–∑—ñ—è ~ –∫–æ—Ä–∏—á–Ω–µ–≤—ñ/—ñ—Ä–∂–∞–≤—ñ —Ç–æ–Ω–∏ 10..40¬∞ –∞–±–æ 15..35¬∞ + —Å–µ—Ä–µ–¥–Ω—è V
      if( (hh>10 && hh<40) && v>0.2 && s>0.3 ) brown++;
    }
  }
  const N=w*h;
  // –ü–µ—Ä–µ–∫—ñ—Å ‚Äî –∫—É—Ç –¥–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ—ó –ª—ñ–Ω—ñ—ó (—è–∫—â–æ –∑–∞–¥–∞–Ω–∞)
  let ang=null;
  if(aline && (aline.x1!==aline.x2 || aline.y1!==aline.y2)){
    const ax=aline.x2-aline.x1, ay=aline.y2-aline.y1;
    const aang=Math.atan2(ay,ax);
    // –û—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è —Ä–µ–±–µ—Ä –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∏–º —Ç–µ–Ω–∑–æ—Ä–æ–º
    let Sxx=0,Syy=0,Sxy=0;
    for(let y=2;y<h-2;y+=2){
      for(let x=2;x<w-2;x+=2){
        const k=(y*w+x)*4;
        const gx=(data[k+4]-data[k-4]) + (data[k+4*w]-data[k-4*w])*0.5;
        const gy=(data[k+4*w]-data[k-4*w]) + (data[k+4]-data[k-4])*0.5;
        Sxx+=gx*gx; Syy+=gy*gy; Sxy+=gx*gy;
      }
    }
    const theta=0.5*Math.atan2(2*Sxy, Sxx-Syy);
    let d=Math.abs(theta-aang)*180/Math.PI; if(d>90) d=180-d; ang=d;
  }
  return {
    edge:eCount/N,
    oil:shiny/N,
    rust:brown/N,
    lowsat:lowS/N,
    angle: ang
  };
}

// ===== Heatmap (–ø–æ—è—Å–Ω–µ–Ω–Ω—è) =====
let lastMasks=null;
function makeHeatmap(){
  const R=getROIimage(); if(!R) return null;
  const {img,w,h,x:ox,y:oy}=R, data=img.data;
  const thrE=parseInt($('#thrE').value,10), thrV=parseInt($('#thrV').value,10)/100, thrS=parseInt($('#thrS').value,10)/100;
  const edges=new Uint8ClampedArray(w*h);
  const oilM=new Uint8ClampedArray(w*h);
  const rustM=new Uint8ClampedArray(w*h);
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const k=(y*w+x)*4;
      const r=data[k], g=data[k+1], b=data[k+2];
      const gx=(data[k+4]-data[k-4]) + (data[k+4*w]-data[k-4*w])*0.5;
      const gy=(data[k+4*w]-data[k-4*w]) + (data[k+4]-data[k-4])*0.5;
      const m=Math.sqrt(gx*gx+gy*gy);
      if(m>thrE) edges[y*w+x]=255;
      const {h:hh,s,v}=rgb2hsv(r,g,b);
      const shiny=(v>thrV && s<thrS);
      if(shiny) oilM[y*w+x]=255;
      const br=((hh>10 && hh<40) && v>0.2 && s>0.3);
      if(br) rustM[y*w+x]=255;
    }
  }
  lastMasks={edges,oilM,rustM,w,h,ox,oy};
  return lastMasks;
}

// ===== k-NN –Ω–∞–≤—á–∞–Ω–Ω—è =====
const SHOTS=[]; // {y, feat:{edge,oil,rust,lowsat,angle}}
function renderShots(){ $('#shotsBox').textContent = SHOTS.length? SHOTS.map((r,i)=> `${i+1}. [${r.y}] edge=${r.feat.edge.toFixed(3)} oil=${r.feat.oil.toFixed(3)} rust=${r.feat.rust.toFixed(3)} lowS=${r.feat.lowsat.toFixed(3)} ang=${r.feat.angle==null?'‚Äî':r.feat.angle.toFixed(1)}¬∞`).join('\n') : '// –ü–æ–∫–∏ –±–µ–∑ –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ (–¥–æ–¥–∞–π 3‚Äì5 –Ω–∞ –∫–æ–∂–µ–Ω –∫–ª–∞—Å)'; }
function dist(a,b){
  const wa=1, wo=1, wr=1, wl=0.5, wang=0.2;
  const da=a.edge-b.edge, db=a.oil-b.oil, dc=a.rust-b.rust, dd=a.lowsat-b.lowsat, de=( (a.angle??0)-(b.angle??0) )/90;
  return Math.sqrt(wa*da*da+wo*db*db+wr*dc*dc+wl*dd*dd+wang*de*de);
}
function knn(feat,k=5){
  if(!SHOTS.length) return {y:'unknown', conf:0};
  const sims=SHOTS.map(s=>({y:s.y, d:dist(feat,s.feat)})).sort((a,b)=>a.d-b.d).slice(0,k);
  const votes=new Map();
  sims.forEach(o=>votes.set(o.y,(votes.get(o.y)||0)+(1/(o.d+1e-6))));
  let best='unknown', v=-1; votes.forEach((val,key)=>{ if(val>v){v=val; best=key;} });
  const tot=[...votes.values()].reduce((s,x)=>s+x,0)||1;
  return {y:best, conf:v/tot};
}

// ===== –ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ UI =====
let lastFeat=null;
function analyze(){
  // –æ–Ω–æ–≤–∏–º–æ –∫–∞–¥—Ä —è–∫—â–æ –∑ –≤—ñ–¥–µ–æ
  if(video){ vctx.drawImage(video,0,0,view.width,view.height); }
  const feat=features(); if(!feat) return alert('–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è/ROI');
  lastFeat=feat;
  $('#m_edge').textContent=(feat.edge*100).toFixed(1)+' %';
  $('#m_oil').textContent=(feat.oil*100).toFixed(1)+' %';
  $('#m_rust').textContent=(feat.rust*100).toFixed(1)+' %';
  $('#m_lowS').textContent=(feat.lowsat*100).toFixed(1)+' %';
  $('#m_ang').textContent= feat.angle==null? '‚Äî' : (feat.angle.toFixed(2)+' ¬∞');
  const pred=knn(feat,5);
  $('#m_cls').textContent = `${pred.y} (conf ${(pred.conf*100).toFixed(0)}%)`;
  makeHeatmap();
  drawFrame();
}

// ===== –ú–∞–ª—é–≤–∞–Ω–Ω—è –∫–∞–¥—Ä—É/heatmap/ROI/–ª—ñ–Ω—ñ–π =====
function drawFrame(){
  const W=view.width,H=view.height;
  if(video){ vctx.drawImage(video,0,0,W,H); }
  // heatmap
  if(overlayOn && lastMasks){
    const img=vctx.getImageData(0,0,W,H);
    const a=parseFloat($('#alpha').value);
    const {edges,oilM,rustM,w,h,ox,oy}=lastMasks;
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const i=( (y+oy)*W + (x+ox) )*4;
        const e=edges[y*w+x], o=oilM[y*w+x], r=rustM[y*w+x];
        if(e){ img.data[i+1]=Math.max(img.data[i+1], 220*a); }       // –∑–µ–ª–µ–Ω–∏–π ‚Äî –∫—Ä–∞—ó (—Ç—Ä—ñ—â–∏–Ω–∏/–∑–Ω–æ—Å)
        if(o){ img.data[i+0]=Math.max(img.data[i+0], 220*a); }       // —á–µ—Ä–≤–æ–Ω–∏–π ‚Äî –º–∞—Å–ª–æ
        if(r){ img.data[i+2]=Math.max(img.data[i+2], 220*a); }       // —Å–∏–Ω—ñ–π ‚Äî –∫–æ—Ä–æ–∑—ñ—è (–¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É)
      }
    }
    vctx.putImageData(img,0,0);
  }
  // ROI
  if(roi){ vctx.strokeStyle='#38bdf8'; vctx.lineWidth=2; vctx.strokeRect(roi.x+0.5,roi.y+0.5,roi.w,roi.h); }
  // –õ—ñ–Ω—ñ—è
  if(aline){ vctx.beginPath(); vctx.strokeStyle='#fbbf24'; vctx.lineWidth=3; vctx.moveTo(aline.x1,aline.y1); vctx.lineTo(aline.x2,aline.y2); vctx.stroke(); }
}
function loop(){ if(video){ drawFrame(); } requestAnimationFrame(loop); }
loop();

function log(msg){ const t=new Date().toLocaleTimeString(); const box=$('#alog'); if(box.textContent.startsWith('//')) box.textContent=''; box.textContent+=`[${t}] ${msg}\n`; box.scrollTop=box.scrollHeight; }

// ===== –ü–æ–¥—ñ—ó =====
$('#overlay').addEventListener('click', ()=>{ overlayOn=!overlayOn; log('Heatmap: '+(overlayOn?'on':'off')); drawFrame(); });
$('#analyze').addEventListener('click', analyze);
$('#savePng').addEventListener('click', ()=>{
  const a=document.createElement('a'); view.toBlob(b=>{ a.href=URL.createObjectURL(b); a.download='mech_para24_frame_'+stamp()+'.png'; a.click(); }, 'image/png'); 
});
$('#saveCsv').addEventListener('click', ()=>{
  if(!lastFeat) return alert('–ù–µ–º–∞—î –º–µ—Ç—Ä–∏–∫');
  const head='t_iso,edge,oil,rust,low_sat,angle_deg,class,conf\n';
  const pred=knn(lastFeat,5);
  const row=`${new Date().toISOString()},${lastFeat.edge.toFixed(4)},${lastFeat.oil.toFixed(4)},${lastFeat.rust.toFixed(4)},${lastFeat.lowsat.toFixed(4)},${(lastFeat.angle??NaN).toFixed?.(2)??''},${pred.y},${pred.conf.toFixed(3)}\n`;
  download('mechanic_para24_metrics_'+stamp()+'.csv', head+row,'text/csv');
});

// –ù–∞–≤—á–∞–Ω–Ω—è
$('#addShot').addEventListener('click', ()=>{
  if(!lastFeat) return alert('–°–ø–µ—Ä—à—É ¬´–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ ROI¬ª');
  SHOTS.push({y:$('#label').value, feat:{...lastFeat}});
  renderShots(); log('–î–æ–¥–∞–Ω–æ –ø—Ä–∏–∫–ª–∞–¥ –¥–ª—è '+$('#label').value);
});
$('#exportShots').addEventListener('click', ()=> download('mechanic_para24_shots_'+stamp()+'.json', JSON.stringify(SHOTS,null,2)));
$('#importShots').addEventListener('click', ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const js=JSON.parse(await f.text()); if(Array.isArray(js)){ js.forEach(x=>{ if(x.y && x.feat) SHOTS.push(x); }); renderShots(); log('–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ '+js.length+' –ø—Ä–∏–∫–ª.'); } };
  inp.click();
});
renderShots();

// –ñ—É—Ä–Ω–∞–ª/–µ–∫—Å–ø–æ—Ä—Ç–∏
$('#mark').addEventListener('click', ()=>{
  const lab=$('#lab2').value;
  const pred= lastFeat? knn(lastFeat,5) : {y:'n/a',conf:0};
  log(`–ü–æ–∑–Ω–∞—á–∫–∞: ${lab} | cls=${pred.y} conf=${(pred.conf*100).toFixed(0)}%`);
});
$('#saveTxt').addEventListener('click', ()=>{
  const pred= lastFeat? knn(lastFeat,5) : {y:'‚Äî',conf:0};
  const lines=[
    '–ü–∞—Ä–∞ 24 ‚Äî –ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è –¥–µ—Ñ–µ–∫—Ç—ñ–≤ (–®–Ü#4)',
    lastFeat?`edge=${lastFeat.edge.toFixed(4)} | oil=${lastFeat.oil.toFixed(4)} | rust=${lastFeat.rust.toFixed(4)} | lowS=${lastFeat.lowsat.toFixed(4)} | ang=${(lastFeat.angle??NaN).toFixed?.(2)??'N/A'}¬∞`:'(–±–µ–∑ –º–µ—Ç—Ä–∏–∫)',
    `–∫–ª–∞—Å=${pred.y} conf=${(pred.conf*100).toFixed(0)}%`,
    '--- ISO-—á–µ–∫-–ª–∏—Å—Ç ---',
    ...Array.from($('#checklist').querySelectorAll('label')).map((el,i)=>`${i+1}. ${el.textContent.trim()} [${el.querySelector('input').checked?'x':' '}]`),
    '--- –ñ—É—Ä–Ω–∞–ª ---',
    ...($('#alog').textContent.startsWith('//')?[]:$('#alog').textContent.trim().split('\n'))
  ];
  download('mechanic_para24_summary_'+stamp()+'.txt', lines.join('\n'));
});
$('#saveTasks').addEventListener('click', ()=>{
  const tasks=[
    '1) –ó—Ä–æ–±–∏—Ç–∏ 2 —Ñ–æ—Ç–æ ¬´–¥–æ/–ø—ñ—Å–ª—è¬ª, –∑–±–µ—Ä–µ–≥—Ç–∏ PNG+CSV.',
    '2) –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É –ª—ñ–Ω—ñ—é, –¥–æ—Å—è–≥—Ç–∏ |–∫—É—Ç| < 2¬∞.',
    '3) –î–æ–¥–∞—Ç–∏ 3‚Äì5 –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ –Ω–∞ –∫–ª–∞—Å (–Ω–∞–≤—á–∞–Ω–Ω—è k-NN), –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—é.',
    '4) –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ ISO-—á–µ–∫-–ª–∏—Å—Ç, —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ TXT-–∑–≤—ñ—Ç —ñ —á–µ–∫ 58 –º–º.'
  ];
  download('mechanic_para24_tasks_'+stamp()+'.txt', tasks.join('\n'));
});
$('#receipt').addEventListener('click', ()=>{
  const pred= lastFeat? knn(lastFeat,5) : {y:'‚Äî',conf:0};
  const lines=[
    '=== –ß–ï–ö –í–Ü–ó.–î–ï–§–ï–ö–¢–Ü–í (58–º–º) ===',
    '–î–∞—Ç–∞: '+new Date().toISOString().slice(0,10),
    lastFeat?('edge='+lastFeat.edge.toFixed(3)+' | oil='+lastFeat.oil.toFixed(3)):'edge=?, oil=?',
    lastFeat?('rust='+lastFeat.rust.toFixed(3)+' | lowS='+lastFeat.lowsat.toFixed(3)):'rust=?, lowS=?',
    lastFeat?('ang='+(lastFeat.angle?.toFixed(1)??'N/A')+'¬∞'):'ang=?',
    '–ö–ª–∞—Å: '+pred.y+' ('+(pred.conf*100).toFixed(0)+'%)'
  ];
  const el=$('#rc'); el.hidden=false; el.textContent=lines.join('\n');
  download('para24_receipt_'+stamp()+'.txt', lines.join('\n'));
});

// –†–µ–Ω–¥–µ—Ä-—Ü–∏–∫–ª
function tick(){ drawFrame(); requestAnimationFrame(tick); }
tick();

// LMS-friendly
if (window.self !== window.top) document.documentElement.classList.add('embedded');
</script>
</body>
</html>
