<!-- tech_para9.html
     –ü–ê–†–ê 9 (–∞—É–¥–∏—Ç–æ—Ä–Ω–æ) –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–≤ –∑ –ø–µ—Ä–µ—Ä–æ–±–∫–∏ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞
     –¢–µ–º–∞: –ü–†–û–°–¢–ï–ñ–£–í–ê–ù–Ü–°–¢–¨ (TRACEABILITY) –¢–ê –í–Ü–î–ö–õ–ò–ö–ê–ù–ù–Ø ‚Äî –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—è –ø–∞—Ä—Ç—ñ–π RAW‚ÜíWIP‚ÜíFG,
           —Å–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è, –æ–±—Å—è–≥ —É—Ä–∞–∂–µ–Ω–æ—ó –ø—Ä–æ–¥—É–∫—Ü—ñ—ó, CSV-–∑–≤—ñ—Ç–∏, –∫–≤–∏—Ç–æ–∫ 58 –º–º, QR/NFC.
     –§–æ–∫—É—Å: —Ç–µ–ª–µ—Ñ–æ–Ω–∏/–ü–ö; –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫; –≥–æ—Ç–æ–≤–æ –¥–ª—è GitHub Pages —Ç–∞ Moodle (iframe).
     –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è: —Ç–µ–ª–µ—Ñ–æ–Ω–∏; (–æ–ø—Ü.) —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä 58 –º–º; NFC-–º—ñ—Ç–∫–∏.

     –ü—Ä–∏–º—ñ—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É: —Ç–µ–º–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—å –º–∞—é—Ç—å —Å–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç (.dark).
--><!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 9 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî Traceability &amp; Recall: –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—è –ø–∞—Ä—Ç—ñ–π, —Å–∏–º—É–ª—è—Ü—ñ—è, –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
    --accent:#22c55e; --accent-2:#60a5fa; --warn:#f59e0b; --bad:#ef4444; --good:#10b981; --line:#1f2937;
    --darkcell:#0b1324; --darkink:#e6eef9; --darkink2:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#111827 30%,#0b1220);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;line-height:1.55}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 64px}
  .badge{display:inline-block;padding:6px 10px;border:1px solid var(--line);background:#0b1220;border-radius:999px;
         font-size:12px;color:var(--muted);letter-spacing:.3px}
  h1{font-size:34px;margin:6px 0 12px;line-height:1.15;
     background:linear-gradient(90deg,#60a5fa,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  h2{font-size:22px;margin:28px 0 12px} h3{font-size:18px;margin:20px 0 8px;color:#cbd5e1}
  p{margin:10px 0}.small{font-size:12px;color:#9fb0c8}.muted{color:#93a3b5}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#dbeafe;text-decoration:none;cursor:pointer}
  .btn:hover{background:#0f1f39}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1000px){.g2,.g3{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .box{border:1px solid #223049;border-radius:12px;padding:12px;background:var(--darkcell);color:var(--darkink)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto;border-radius:12px;border:1px solid #223049}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid #1f2937;font-size:14px;vertical-align:top}
  .table thead th{background:#0c1629;color:#a5b4fc;text-align:left;position:sticky;top:0}
  .table tbody tr:nth-child(even){background:var(--darkcell);color:var(--darkink2)}
  .table td.dark,.table th.dark{background:var(--darkcell)!important;color:var(--darkink2)!important}
  .out{background:var(--darkcell);color:var(--darkink2);border:1px dashed #263042;padding:10px 12px;border-radius:10px;word-break:break-all}
  input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#e6eef9}
  textarea{min-height:84px}
  /* –ß–µ–∫ 58 –º–º */
  .ticket{width:58mm;background:#fff;color:#000;padding:6mm 4mm;border-radius:6px;box-shadow:0 0 0 1px #e5e7eb inset;font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px;font-size:13px;text-align:center}.ticket p{margin:2px 0;font-size:12px}.ticket .line{border-top:1px dashed #111;margin:6px 0}
  .ticket small{font-size:10px}
  /* –í–±—É–¥–æ–≤–∞–Ω–æ –≤ Moodle (iframe) ‚Üí —Å–≤—ñ—Ç–ª–∏–π –≤–∏–≥–ª—è–¥ */
  html.embedded body{background:#fff;color:#111}
  html.embedded .card{background:#fff;border:1px solid #e5e7eb;box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial;background:none;color:#111}
  html.embedded .box{background:#f8fafc;color:#111}
  html.embedded .table tbody tr:nth-child(even){background:#f3f4f6;color:#111}
  @media print{@page{margin:4mm}.no-print{display:none!important}}
  /* ASCII-–≥—Ä–∞—Ñ –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—ó */
  .graph{font:12px/14px ui-monospace,monospace;white-space:pre;background:#fff;color:#000;padding:8px;border-radius:8px;border:1px solid #e5e7eb;overflow:auto}
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

<meta name="description" content="–ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑–±–µ—Ä—É—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó RAW‚ÜíWIP‚ÜíFG, –ø–æ–±—É–¥—É—é—Ç—å –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—é, –∑–∞–ø—É—Å—Ç—è—Ç—å —Å–∏–º—É–ª—è—Ü—ñ—é –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è (–∑–∞ –ª–æ—Ç–æ–º/–¥–∞—Ç–æ—é/–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º), –ø–æ—Ä–∞—Ö—É—é—Ç—å —É—Ä"><link rel="canonical" href="https://edlab.pp.ua/tech_II_kyrs/tech_para9.html"><meta property="og:type" content="article"><meta property="og:title" content="üîó Traceability &amp; Recall: –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—è –ø–∞—Ä—Ç—ñ–π, —Å–∏–º—É–ª—è—Ü—ñ—è, –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV"><meta property="og:description" content="–ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑–±–µ—Ä—É—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó RAW‚ÜíWIP‚ÜíFG, –ø–æ–±—É–¥—É—é—Ç—å –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—é, –∑–∞–ø—É—Å—Ç—è—Ç—å —Å–∏–º—É–ª—è—Ü—ñ—é –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è (–∑–∞ –ª–æ—Ç–æ–º/–¥–∞—Ç–æ—é/–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º), –ø–æ—Ä–∞—Ö—É—é—Ç—å —É—Ä"><meta property="og:url" content="https://edlab.pp.ua/tech_II_kyrs/tech_para9.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"üîó Traceability & Recall: –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—è –ø–∞—Ä—Ç—ñ–π, —Å–∏–º—É–ª—è—Ü—ñ—è, –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV","description":"–ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑–±–µ—Ä—É—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó RAW‚ÜíWIP‚ÜíFG, –ø–æ–±—É–¥—É—é—Ç—å –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—é, –∑–∞–ø—É—Å—Ç—è—Ç—å —Å–∏–º—É–ª—è—Ü—ñ—é –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è (–∑–∞ –ª–æ—Ç–æ–º/–¥–∞—Ç–æ—é/–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º), –ø–æ—Ä–∞—Ö—É—é—Ç—å —É—Ä","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/tech_II_kyrs/tech_para9.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <span class="badge">–ü–∞—Ä–∞ 9 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ ¬∑ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏ –ø–µ—Ä–µ—Ä–æ–±–∫–∏</span>
  <h1>üîó Traceability &amp; Recall: –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—è –ø–∞—Ä—Ç—ñ–π, —Å–∏–º—É–ª—è—Ü—ñ—è, –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</h1>

  <div class="card">
    <h2>üéØ –ú–µ—Ç–∞ –ø–∞—Ä–∏</h2>
    <p>
      –ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏ –∑–±–µ—Ä—É—Ç—å <b>–¥–∞–Ω—ñ –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó RAW‚ÜíWIP‚ÜíFG</b>, –ø–æ–±—É–¥—É—é—Ç—å <b>–≥–µ–Ω–µ–∞–ª–æ–≥—ñ—é</b>,
      –∑–∞–ø—É—Å—Ç—è—Ç—å <b>—Å–∏–º—É–ª—è—Ü—ñ—é –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è</b> (–∑–∞ –ª–æ—Ç–æ–º/–¥–∞—Ç–æ—é/–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º), –ø–æ—Ä–∞—Ö—É—é—Ç—å <b>—É—Ä–æ–∂–µ–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å</b>,
      —Å—Ñ–æ—Ä–º—É—é—Ç—å <b>–∂—É—Ä–Ω–∞–ª/CSV</b>, <b>–∫–≤–∏—Ç–æ–∫ 58 –º–º</b>, <b>QR/NFC</b> –¥–ª—è –∫–æ–º–∞–Ω–¥ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è.
    </p>
    <p class="small muted">–ù–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å ISO 22005/BRCGS. –†–µ–∞–ª—å–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ –¥–∏–≤. —É –≤–∞—à–æ–º—É HACCP-–ø–ª–∞–Ω—ñ —Ç–∞ –°–û–ü –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è.</p>
  </div>

  <!-- 1. RAW: –≤—Ö—ñ–¥–Ω—ñ –ø–∞—Ä—Ç—ñ—ó -->
  <div class="card">
    <h2>ü•© RAW ‚Äî –≤—Ö—ñ–¥–Ω—ñ –ø–∞—Ä—Ç—ñ—ó</h2>
    <div class="row">
      <button class="btn" onclick="addRAW()">‚ûï –î–æ–¥–∞—Ç–∏ RAW</button>
      <button class="btn" onclick="presetRAW()">üß™ –ü—Ä–∏–∫–ª–∞–¥ RAW</button>
      <button class="btn" onclick="copyCSV('csvRAW')">üìã CSV (RAW)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblRAW">
        <thead>
          <tr>
            <th>#</th>
            <th>–õ–æ—Ç RAW</th>
            <th class="dark">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</th>
            <th class="dark">–î–∞—Ç–∞ –ø—Ä–∏–π–º.</th>
            <th class="dark">–ö-—Ç—å, –∫–≥</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyRAW"></tbody>
      </table>
    </div>
    <div id="csvRAW" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 2. WIP: –∑–º—ñ—à—É–≤–∞–Ω–Ω—è / –Ω–∞–ø—ñ–≤—Ñ–∞–±—Ä–∏–∫–∞—Ç -->
  <div class="card">
    <h2>üõ†Ô∏è WIP ‚Äî –∑–º—ñ—à—É–≤–∞–Ω–Ω—è/–Ω–∞–ø—ñ–≤—Ñ–∞–±—Ä–∏–∫–∞—Ç</h2>
    <div class="row">
      <button class="btn" onclick="addWIP()">‚ûï –î–æ–¥–∞—Ç–∏ WIP</button>
      <button class="btn" onclick="presetWIP()">üß™ –ü—Ä–∏–∫–ª–∞–¥ WIP</button>
      <button class="btn" onclick="copyCSV('csvWIP')">üìã CSV (WIP)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblWIP">
        <thead>
          <tr>
            <th>#</th>
            <th>WIP ID</th>
            <th class="dark">–î–∞—Ç–∞</th>
            <th class="dark">–°–∫–ª–∞–¥: RAW –ª–æ—Ç ‚Üí %</th>
            <th>–í–∏—Ö—ñ–¥, –∫–≥</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyWIP"></tbody>
      </table>
    </div>
    <div id="csvWIP" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 3. FG: –≥–æ—Ç–æ–≤–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è -->
  <div class="card">
    <h2>üì¶ FG ‚Äî –≥–æ—Ç–æ–≤–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—è</h2>
    <div class="row">
      <button class="btn" onclick="addFG()">‚ûï –î–æ–¥–∞—Ç–∏ FG</button>
      <button class="btn" onclick="presetFG()">üß™ –ü—Ä–∏–∫–ª–∞–¥ FG</button>
      <button class="btn" onclick="copyCSV('csvFG')">üìã CSV (FG)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblFG">
        <thead>
          <tr>
            <th>#</th>
            <th>–õ–æ—Ç FG</th>
            <th class="dark">–î–∞—Ç–∞ –≤–∏–ø—É—Å–∫—É</th>
            <th class="dark">WIP ‚Üí %</th>
            <th>–ö-—Ç—å, –∫–≥</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyFG"></tbody>
      </table>
    </div>
    <div id="csvFG" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 4. –ì–ï–ù–ï–ê–õ–û–ì–Ü–Ø + ASCII-–≥—Ä–∞—Ñ -->
  <div class="card">
    <h2>üß¨ –ì–µ–Ω–µ–∞–ª–æ–≥—ñ—è –ø–∞—Ä—Ç—ñ–π RAW‚ÜíWIP‚ÜíFG</h2>
    <div class="row">
      <button class="btn" onclick="buildGraph()">üß© –ü–æ–±—É–¥—É–≤–∞—Ç–∏ –≥—Ä–∞—Ñ</button>
      <button class="btn" onclick="copyEl('graphOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
    </div>
    <div id="graphOut" class="graph" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 5. –°–ò–ú–£–õ–Ø–¢–û–† –í–Ü–î–ö–õ–ò–ö–ê–ù–ù–Ø -->
  <div class="card">
    <h2>üö® –°–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è</h2>
    <div class="grid g3">
      <div class="box">
        <h3>–ö—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É</h3>
        <div class="row">
          <div style="flex:1"><label>RAW-–ª–æ—Ç (—á–∞—Å—Ç–∏–Ω–∞/–ø–æ–≤–Ω–∏–π)</label><input id="fltRaw" type="text" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: S-25041"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1"><label>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ (–º—ñ—Å—Ç–∏—Ç—å)</label><input id="fltSupp" type="text" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ú º—è—Å"></div>
          <div style="flex:1"><label>FG –¥–∞—Ç–∞ ‚â•</label><input id="fltFrom" type="date"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1"><label>FG –¥–∞—Ç–∞ ‚â§</label><input id="fltTo" type="date"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="runRecall()">üö® –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è</button>
          <button class="btn" onclick="copyCSV('csvRecall')">üìã CSV (recall)</button>
        </div>
      </div>

      <div class="box">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
        <p>–£—Ä–∞–∂–µ–Ω–æ FG-–ª–æ—Ç—ñ–≤: <b><span id="rcLots">‚Äî</span></b></p>
        <p>–û—Ä—ñ—î–Ω—Ç. –∫—ñ–ª—å–∫—ñ—Å—Ç—å, –∫–≥: <b><span id="rcKg">‚Äî</span></b></p>
        <p>–°–ø–∏—Å–æ–∫ FG: <b><span id="rcList">‚Äî</span></b></p>
      </div>

      <div class="box">
        <h3>–î—ñ—ó (draft)</h3>
        <div id="rcActions" class="out">‚Äî</div>
      </div>
    </div>
    <div id="csvRecall" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 6. –ñ–£–†–ù–ê–õ / –ö–í–ò–¢–û–ö / QR / NFC -->
  <div class="card">
    <h2>üìí –ñ—É—Ä–Ω–∞–ª / –ö–≤–∏—Ç–æ–∫ 58 –º–º / QR / NFC</h2>
    <div class="row">
      <button class="btn" onclick="addLog()">‚ûï –î–æ–¥–∞—Ç–∏ —É –∂—É—Ä–Ω–∞–ª</button>
      <button class="btn" onclick="copyCSV('csvLog')">üìã CSV (journal)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblLog">
        <thead>
          <tr>
            <th>#</th>
            <th>–ü—ñ–¥—Å—Ç–∞–≤–∞ (RAW/Supp/–¥—ñ–∞–ø–∞–∑–æ–Ω –¥–∞—Ç)</th>
            <th class="dark">FG-–ª–æ—Ç–∏</th>
            <th class="dark">–û—Ü—ñ–Ω–∫–∞, –∫–≥</th>
            <th>–î—ñ—ó</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyLog"></tbody>
      </table>
    </div>
    <div id="csvLog" class="out" style="margin-top:8px">‚Äî</div>

    <div class="grid g2" style="margin-top:12px">
      <div class="box">
        <h3>–ö–≤–∏—Ç–æ–∫ 58 –º–º ‚Äî ‚ÄúRECALL TASK‚Äù</h3>
        <div class="row">
          <button class="btn" onclick="buildTicket()">üßæ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
          <button class="btn" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫</button>
        </div>
        <div class="ticket" id="ticket" style="margin-top:8px">
          <h4>RECALL TASK</h4>
          <p><b>–ü—ñ–¥—Å—Ç–∞–≤–∞:</b> <span id="tReason">‚Äî</span></p>
          <div class="line"></div>
          <p><b>FG-–ª–æ—Ç–∏:</b> <span id="tFGLots">‚Äî</span></p>
          <p><b>–û—Ä—ñ—î–Ω—Ç. –∫–≥:</b> <span id="tKg">‚Äî</span></p>
          <div class="line"></div>
          <p><small id="tAction">–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏, —ñ–∑–æ–ª—é–≤–∞—Ç–∏, —ñ–Ω—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥/–∑–±—É—Ç. –î–∏–≤. NFC/QR.</small></p>
        </div>
      </div>

      <div class="box">
        <h3>QR / NFC –¥–ª—è –±—Ä–∏–≥–∞–¥–∏ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è</h3>
        <div class="row">
          <button class="btn" onclick="buildQR()">üß© –ó—ñ–±—Ä–∞—Ç–∏ QR</button>
          <button class="btn" onclick="copyEl('qrOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="qrOut" class="out">‚Äî</div>

        <h3 style="margin-top:12px">NFC ‚Äî ‚ÄúRECALL CARD‚Äù</h3>
        <div class="row">
          <div style="flex:1"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input id="nfcPhone" type="text" value="+380XXXXXXXXX"></div>
          <div style="flex:1"><label>–ö–µ—Ä—ñ–≤–Ω–∏–∫</label><input id="rcLead" type="text" value="–°—Ç—É–¥–µ–Ω—Ç –¢–ü–¢"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" onclick="buildNFC()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
          <button class="btn" onclick="copyEl('nfcOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="nfcOut" class="out">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- 7. –•–Ü–î –†–û–ë–û–¢–ò + –û–¶–Ü–ù–Æ–í–ê–ù–ù–Ø -->
  <div class="card">
    <h2>ü™ú –•—ñ–¥ —Ä–æ–±–æ—Ç–∏ (45‚Äì70 —Ö–≤)</h2>
    <ol>
      <li>–°—Ç–≤–æ—Ä—ñ—Ç—å 3‚Äì5 RAW, 2‚Äì3 WIP –∑ –º—ñ–∫—Å–∞–º–∏ RAW, 3‚Äì6 FG, —â–æ –ø–æ—Ö–æ–¥—è—Ç—å —ñ–∑ WIP.</li>
      <li>–ü–æ–±—É–¥—É–π—Ç–µ –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—é; –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–≤‚Äô—è–∑–∫–∏ RAW‚ÜíWIP‚ÜíFG.</li>
      <li>–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∏–º—É–ª—è—Ü—ñ—é –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è (–∑–∞ RAW –∞–±–æ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º + –¥–∞—Ç–∞–º–∏ FG).</li>
      <li>–ó–∞–Ω–µ—Å—ñ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –∂—É—Ä–Ω–∞–ª; –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ –∫–≤–∏—Ç–æ–∫, QR —ñ NFC, —Å–∫–æ–ø—ñ—é–π—Ç–µ CSV.</li>
    </ol>
  </div>

  <div class="card">
    <h2>‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
    <table class="table">
      <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä—ñ–π</th><th>–ë–∞–ª–∏</th></tr></thead>
      <tbody>
        <tr><td>–ö–æ—Ä–µ–∫—Ç–Ω–æ –∑—ñ–±—Ä–∞–Ω—ñ RAW/WIP/FG —Ç–∞ –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—è</td><td>4</td></tr>
        <tr><td>–°–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è —ñ –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –æ–±—Å—è–≥—É</td><td>4</td></tr>
        <tr><td>–ñ—É—Ä–Ω–∞–ª + –∫–≤–∏—Ç–æ–∫/NFC/QR + CSV</td><td>2</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle iFrame)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  const byId = id => document.getElementById(id);
  const rnd = (n,d=2)=>Number((+n).toFixed(d));
  const pad2 = n => String(n).padStart(2,'0');

  // ===== –î–æ–ø–æ–º—ñ–∂–Ω—ñ =====
  function copyCSV(id){
    const t = document.getElementById(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è'); return; }
    navigator.clipboard.writeText(t).then(()=>flash('‚úÖ CSV —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'),()=>flash('–ù–µ –≤–¥–∞–ª–æ—Å—è'));
  }
  function copyEl(id){
    const t = byId(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'); return; }
    navigator.clipboard.writeText(t).then(()=>flash('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'),()=>flash('–ù–µ –≤–¥–∞–ª–æ—Å—è'));
  }
  function flash(msg){ const o=document.title; document.title=msg; setTimeout(()=>document.title=o,900); }
  function fmtDate(d){ return d instanceof Date ? d.toISOString().slice(0,10) : (d||''); }

  // ===== RAW =====
  const bodyRAW = byId('bodyRAW');
  function reindex(tb){ [...tb.querySelectorAll('tr')].forEach((tr,i)=>tr.querySelector('.idx').textContent=i+1); }
  function addRAW(sample){
    const s = Object.assign({lot:'', supp:'', date:'', kg:''}, sample||{});
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td><input type="text" value="${s.lot}"></td>
      <td class="dark"><input type="text" value="${s.supp}"></td>
      <td class="dark"><input type="date" value="${s.date}"></td>
      <td class="dark"><input type="number" step="0.1" value="${s.kg}"></td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyRAW); buildCSV_RAW();">‚úñ</button></td>
    `;
    bodyRAW.appendChild(tr); reindex(bodyRAW); buildCSV_RAW();
  }
  function presetRAW(){
    bodyRAW.innerHTML='';
    addRAW({lot:'S-25041-AC', supp:'–¢–û–í ‚Äú–ú º—è—Å–¢—Ä–µ–π–¥‚Äù', date:fmtDate(new Date()), kg:800});
    addRAW({lot:'B-25039-Z1', supp:'–§–û–ü ‚Äú–ê–≥—Ä–æ–ü—Ä–æ–¥—É–∫—Ç‚Äù', date:fmtDate(new Date()), kg:500});
    addRAW({lot:'M-25040-D',  supp:'–ú–æ–ª–ü–æ—Å—Ç–∞—á', date:fmtDate(new Date()), kg:600});
  }
  function buildCSV_RAW(){
    const rows=[...bodyRAW.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].querySelector('input').value.trim(),
        r.children[3].querySelector('input').value.trim(),
        r.children[4].querySelector('input').value.trim()
      ].join(' | ');
    });
    byId('csvRAW').textContent = rows.join('\n') || '‚Äî';
  }

  // ===== WIP =====
  const bodyWIP = byId('bodyWIP');
  function addWIP(sample){
    const s=Object.assign({id:'', date:'', comp:'', outKg:''}, sample||{});
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td><input type="text" value="${s.id}"></td>
      <td class="dark"><input type="date" value="${s.date}"></td>
      <td class="dark"><input type="text" value="${s.comp}" placeholder="S-25041-AC:60%;B-25039-Z1:40%"></td>
      <td><input type="number" step="0.1" value="${s.outKg}"></td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyWIP); buildCSV_WIP();">‚úñ</button></td>
    `;
    bodyWIP.appendChild(tr); reindex(bodyWIP); buildCSV_WIP();
  }
  function presetWIP(){
    bodyWIP.innerHTML='';
    addWIP({id:'WIP-101', date:fmtDate(new Date()), comp:'S-25041-AC:70%;B-25039-Z1:30%', outKg:700});
    addWIP({id:'WIP-102', date:fmtDate(new Date()), comp:'M-25040-D:100%', outKg:550});
  }
  function buildCSV_WIP(){
    const rows=[...bodyWIP.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].querySelector('input').value.trim(),
        r.children[3].querySelector('input').value.trim(),
        r.children[4].querySelector('input').value.trim()
      ].join(' | ');
    });
    byId('csvWIP').textContent = rows.join('\n') || '‚Äî';
  }

  // ===== FG =====
  const bodyFG = byId('bodyFG');
  function addFG(sample){
    const s=Object.assign({lot:'', date:'', comp:'', kg:''}, sample||{});
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td><input type="text" value="${s.lot}"></td>
      <td class="dark"><input type="date" value="${s.date}"></td>
      <td class="dark"><input type="text" value="${s.comp}" placeholder="WIP-101:60%;WIP-102:40%"></td>
      <td><input type="number" step="0.1" value="${s.kg}"></td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyFG); buildCSV_FG();">‚úñ</button></td>
    `;
    bodyFG.appendChild(tr); reindex(bodyFG); buildCSV_FG();
  }
  function presetFG(){
    bodyFG.innerHTML='';
    addFG({lot:'FG-001', date:fmtDate(new Date()), comp:'WIP-101:100%', kg:680});
    addFG({lot:'FG-002', date:fmtDate(new Date()), comp:'WIP-101:50%;WIP-102:50%', kg:600});
    addFG({lot:'FG-003', date:fmtDate(new Date()), comp:'WIP-102:100%', kg:520});
  }
  function buildCSV_FG(){
    const rows=[...bodyFG.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].querySelector('input').value.trim(),
        r.children[3].querySelector('input').value.trim(),
        r.children[4].querySelector('input').value.trim()
      ].join(' | ');
    });
    byId('csvFG').textContent = rows.join('\n') || '‚Äî';
  }

  // ===== –ü–∞—Ä—Å–µ—Ä "A:60%;B:40%" ‚Üí {A:0.6, B:0.4} =====
  function parseMix(s){
    const out={}; if(!s) return out;
    s.split(';').forEach(pair=>{
      const [k,v]=pair.split(':').map(x=>x.trim());
      if(!k||!v) return;
      const m = /([\d.]+)\s*%/.exec(v);
      const frac = m? (parseFloat(m[1])/100) : parseFloat(v);
      if(!isNaN(frac)) out[k]=frac;
    });
    return out;
  }

  // ===== –ü–æ–±—É–¥–æ–≤–∞ –≥–µ–Ω–µ–∞–ª–æ–≥—ñ—ó =====
  function getRAW(){ return [...bodyRAW.querySelectorAll('tr')].map(r=>({lot:r.children[1].querySelector('input').value.trim(), supp:r.children[2].querySelector('input').value.trim(), date:r.children[3].querySelector('input').value.trim(), kg:+r.children[4].querySelector('input').value||0})).filter(x=>x.lot); }
  function getWIP(){ return [...bodyWIP.querySelectorAll('tr')].map(r=>({id:r.children[1].querySelector('input').value.trim(), date:r.children[2].querySelector('input').value.trim(), comp:parseMix(r.children[3].querySelector('input').value.trim()), outKg:+r.children[4].querySelector('input').value||0})).filter(x=>x.id); }
  function getFG(){  return [...bodyFG.querySelectorAll('tr')].map(r=>({lot:r.children[1].querySelector('input').value.trim(), date:r.children[2].querySelector('input').value.trim(), comp:parseMix(r.children[3].querySelector('input').value.trim()), kg:+r.children[4].querySelector('input').value||0})).filter(x=>x.lot); }

  function buildGraph(){
    const RAW=getRAW(), WIP=getWIP(), FG=getFG();
    if(!RAW.length && !WIP.length && !FG.length){ byId('graphOut').textContent='‚Äî'; return; }
    const lines=[];
    lines.push('RAW ‚Üí WIP ‚Üí FG (–≤–∞–≥–∏ –≤ %)');
    lines.push('-------------------------------------------');
    // RAW ‚Üí WIP
    WIP.forEach(w=>{
      const mix=w.comp;
      const parts=Object.keys(mix).map(k=>`${k}‚Üí${w.id} (${rnd(mix[k]*100,1)}%)`).join(', ');
      lines.push(`WIP ${w.id} [${w.outKg} –∫–≥] <= ${parts}`);
    });
    // WIP ‚Üí FG
    FG.forEach(f=>{
      const mix=f.comp;
      const parts=Object.keys(mix).map(k=>`${k}‚Üí${f.lot} (${rnd(mix[k]*100,1)}%)`).join(', ');
      lines.push(`FG ${f.lot} [${f.kg} –∫–≥] <= ${parts}`);
    });
    byId('graphOut').textContent = lines.join('\n');
  }

  // ===== –°–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è =====
  function runRecall(){
    const RAW=getRAW(), WIP=getWIP(), FG=getFG();
    // –Ü–Ω–¥–µ–∫—Å –¥–æ–ø–æ–º—ñ–∂–Ω–∏—Ö –∑–≤'—è–∑–∫—ñ–≤
    const rawByLot = {}; RAW.forEach(r=>rawByLot[r.lot]=r);
    const wipUsesRaw = {}; // RAW lot -> [{wipId, frac}]
    WIP.forEach(w=>{
      Object.entries(w.comp).forEach(([rawLot,frac])=>{
        if(!wipUsesRaw[rawLot]) wipUsesRaw[rawLot]=[];
        wipUsesRaw[rawLot].push({wipId:w.id, frac});
      });
    });
    const fgUsesWip = {}; // WIP id -> [{fgLot, frac}]
    FG.forEach(f=>{
      Object.entries(f.comp).forEach(([wipId,frac])=>{
        if(!fgUsesWip[wipId]) fgUsesWip[wipId]=[];
        fgUsesWip[wipId].push({fgLot:f.lot, frac, date:f.date, kg:f.kg});
      });
    });

    // –§—ñ–ª—å—Ç—Ä–∏
    const fRaw = byId('fltRaw').value.trim().toLowerCase();
    const fSupp= byId('fltSupp').value.trim().toLowerCase();
    const fFrom= byId('fltFrom').value ? new Date(byId('fltFrom').value) : null;
    const fTo  = byId('fltTo').value ? new Date(byId('fltTo').value) : null;

    // 1) –ó–Ω–∞–π—Ç–∏ –ø—ñ–¥–æ–∑—Ä—ñ–ª—ñ RAW
    const suspectRAW = RAW.filter(r=>{
      const matchLot = !fRaw || r.lot.toLowerCase().includes(fRaw);
      const matchSupp= !fSupp|| r.supp.toLowerCase().includes(fSupp);
      return matchLot && matchSupp;
    });

    // 2) –ß–µ—Ä–µ–∑ WIP ‚Üí FG
    const affectedFG = {};
    suspectRAW.forEach(r=>{
      (wipUsesRaw[r.lot]||[]).forEach(wref=>{
        (fgUsesWip[wref.wipId]||[]).forEach(fref=>{
          // —Ñ—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ FG
          const d = fref.date ? new Date(fref.date) : null;
          if( (fFrom && d && d < fFrom) || (fTo && d && d > fTo) ) return;
          // –ß–∞—Å—Ç–∫–∞ RAW —É FG: raw‚Üíwip (frac) * wip‚Üífg (frac)
          const frac = (wref.frac||0) * (fref.frac||0);
          const kg = rnd((fref.kg||0) * frac,2);
          if(!affectedFG[fref.fgLot]) affectedFG[fref.fgLot]={kg:0, parts:[]};
          affectedFG[fref.fgLot].kg += kg;
          affectedFG[fref.fgLot].parts.push(`${r.lot}@${rnd(frac*100,2)}%`);
        });
      });
    });

    const lots = Object.keys(affectedFG);
    const sumKg = rnd(lots.reduce((acc,l)=>acc + (affectedFG[l].kg||0),0),2);

    // –í–∏–≤—ñ–¥
    byId('rcLots').textContent = lots.length || '0';
    byId('rcKg').textContent   = lots.length ? sumKg : '0';
    byId('rcList').textContent = lots.length ? lots.join(', ') : '‚Äî';

    const act = (lots.length)
      ? [
          '–î–Ü–á –í–Ü–î–ö–õ–ò–ö–ê–ù–ù–Ø:',
          '- –ù–µ–≥–∞–π–Ω–∞ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ —ñ–∑–æ–ª—è—Ü—ñ—è –Ω–∞–≤–µ–¥–µ–Ω–∏—Ö FG-–ª–æ—Ç—ñ–≤.',
          '- –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/—Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó, –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è ‚ÄúHOLD/RECALL‚Äù.',
          '- –Ü–Ω—Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –≤—ñ–¥–¥—ñ–ª—ñ–≤: —Å–∫–ª–∞–¥, –∑–±—É—Ç, QA, –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ.',
          '- –Ø–∫—â–æ —á–∞—Å—Ç–∏–Ω–∞ –≤–∂–µ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ ‚Äî –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∑–≤–æ—Ä–æ—Ç–Ω–∞ –ª–æ–≥—ñ—Å—Ç–∏–∫–∞.',
          '- –†–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è –ø–µ—Ä—à–æ–ø—Ä–∏—á–∏–Ω–∏, CAPA.'
        ].join('\n')
      : '–ó–±—ñ–≥—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–¥–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏.';
    byId('rcActions').textContent = act;

    // CSV –∑–≤—ñ—Ç
    const reason = `RAW~${fRaw||'*'};SUPP~${fSupp||'*'};DATE~${byId('fltFrom').value||'*'}..${byId('fltTo').value||'*'}`;
    const lines = [`RECALL|reason=${reason}|lots=${lots.length}|kg=${lots.length?sumKg:0}`];
    lots.forEach(l=> lines.push(`FG|${l}|affected_kg=${rnd(affectedFG[l].kg,2)}|from=${affectedFG[l].parts.join(';')}`));
    byId('csvRecall').textContent = lines.join('\n');

    // –û–Ω–æ–≤–∏—Ç–∏ –∫–≤–∏—Ç–æ–∫
    byId('tReason').textContent = reason;
    byId('tFGLots').textContent = lots.length ? lots.join(', ') : '‚Äî';
    byId('tKg').textContent     = lots.length ? sumKg : '0';
    byId('tAction').textContent = lots.length ? '–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ —Ç–∞ —ñ–∑–æ–ª—é–≤–∞—Ç–∏ –≤—Å—ñ –ø–æ–∑–Ω–∞—á–µ–Ω—ñ FG-–ª–æ—Ç–∏. –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ —Å–∫–ª–∞–¥/–∑–±—É—Ç.' : '–ó–±—ñ–≥—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.';
  }

  // ===== –ñ—É—Ä–Ω–∞–ª / –∫–≤–∏—Ç–æ–∫ / QR / NFC =====
  const bodyLog = byId('bodyLog');
  function addLog(){
    const reason = byId('tReason').textContent || '‚Äî';
    const fgs    = byId('tFGLots').textContent || '‚Äî';
    const kg     = byId('tKg').textContent || '0';
    const act    = byId('rcActions').textContent.slice(0,120)+'‚Ä¶';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td><input type="text" value="${reason}"></td>
      <td class="dark">${fgs}</td>
      <td class="dark">${kg}</td>
      <td>${act}</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyLog); buildCSV_Log();">‚úñ</button></td>
    `;
    bodyLog.appendChild(tr); reindex(bodyLog); buildCSV_Log();
  }
  function buildCSV_Log(){
    const rows=[...bodyLog.querySelectorAll('tr')].map(r=>{
      const idx=r.querySelector('.idx').textContent.trim();
      const reason=r.children[1].querySelector('input').value.trim();
      const fgs=r.children[2].textContent.trim();
      const kg=r.children[3].textContent.trim();
      const act=r.children[4].textContent.trim();
      return [idx,reason,fgs,kg,act].join(' | ');
    });
    byId('csvLog').textContent = rows.join('\n') || '‚Äî';
  }
  function buildTicket(){
    window.scrollTo({top: document.getElementById('ticket').getBoundingClientRect().top + window.scrollY - 60, behavior:'smooth'});
  }
  function buildQR(){
    const payload = {
      reason: byId('tReason').textContent,
      fg_lots: byId('tFGLots').textContent,
      est_kg: byId('tKg').textContent
    };
    byId('qrOut').textContent = JSON.stringify(payload);
  }
  function buildNFC(){
    const txt = [
      `RECALL_NFC`,
      `REASON:${byId('tReason').textContent}`,
      `FG_LOTS:${byId('tFGLots').textContent}`,
      `EST_KG:${byId('tKg').textContent}`,
      `LEAD:${byId('rcLead').value} CONTACT:${byId('nfcPhone').value}`,
      `STAMP:${new Date().toISOString().slice(0,19).replace('T',' ')}`
    ].join('\n');
    byId('nfcOut').textContent = txt;
  }

  // ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
  (function init(){
    presetRAW(); presetWIP(); presetFG(); buildGraph();
    document.addEventListener('change', e=>{
      if(e.target.matches('input,select,textarea')){
        if(e.target.closest('#tblRAW')) buildCSV_RAW();
        if(e.target.closest('#tblWIP')) buildCSV_WIP();
        if(e.target.closest('#tblFG'))  buildCSV_FG();
      }
    });
  })();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>



</body></html>