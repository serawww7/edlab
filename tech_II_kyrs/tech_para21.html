<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 21 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –®–Ü –¥–ª—è QC: –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è + k-NN, ROC/AUC, –≥—Ä–∞—Ñ—ñ–∫–∏, —á–µ–∫/CSV/QR</title>
<meta name="description" content="–û–Ω–ª–∞–π–Ω-–ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è: –∑–±—ñ—Ä –¥–∞–Ω–∏—Ö QC (–º–∞—Å–∞, pH, aw, L*, T—è–¥—Ä–∞, –≤–∞–∫—É—É–º), –Ω–∞–≤—á–∞–Ω–Ω—è –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–æ—ó —Ä–µ–≥—Ä–µ—Å—ñ—ó —Ç–∞ k-NN —É –±—Ä–∞—É–∑–µ—Ä—ñ, –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –º–µ–∂—ñ —Ä—ñ—à–µ–Ω–Ω—è, ROC/AUC, —á–µ–∫/CSV/QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1260px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
small.mono,.mono{font-family:ui-monospace,monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.45fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:300px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:var(--muted);margin-right:6px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">ü§ñ</span>
      <div>
        <b>–ü–∞—Ä–∞ 21 ‚Äî –®–Ü –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é —è–∫–æ—Å—Ç—ñ (QC)</b><br/>
        <span class="badge">–¥–∞–Ω—ñ QC ‚Üí –Ω–∞–≤—á–∞–Ω–Ω—è –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–æ—ó —Ä–µ–≥—Ä–µ—Å—ñ—ó / k-NN ‚Üí –º–µ–∂–∞ —Ä—ñ—à–µ–Ω–Ω—è ‚Üí ROC/AUC ‚Üí —á–µ–∫/CSV/QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –∑—ñ–±—Ä–∞—Ç–∏ –¥–∞–Ω—ñ **QC** –¥–ª—è –ø–∞—Ä—Ç—ñ–π (–º–æ–ª–æ–∫–æ/–º‚Äô—è—Å–æ/—Å–∏—Ä), –Ω–∞–≤—á–∏—Ç–∏ **–º–æ–¥–µ–ª—å –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** (<span class="mono">–ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è</span> + <span class="mono">k-NN</span>) –ø—Ä—è–º–æ —É –±—Ä–∞—É–∑–µ—Ä—ñ, –ø–æ–±–∞—á–∏—Ç–∏ **–º–µ–∂—É —Ä—ñ—à–µ–Ω–Ω—è**, **ROC/AUC**, –∑—Ä–æ–±–∏—Ç–∏ **–ø—Ä–æ–≥–Ω–æ–∑** –¥–ª—è –Ω–æ–≤–æ—ó –ø–∞—Ä—Ç—ñ—ó, –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ **—á–µ–∫ 58 –º–º / CSV / TXT / QR**.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û -->
    <div class="card">
      <h2>üì• –î–∞–Ω—ñ QC (–≤–≤–æ–¥–∏/—ñ–º–ø–æ—Ä—Ç)</h2>
      <div class="row">
        <label>Œî–º–∞—Å–∏, –≥<input id="f_mass" class="input" type="number" step="0.1" value="-0.8"/></label>
        <label>pH<input id="f_ph" class="input" type="number" step="0.01" value="6.35"/></label>
        <label>aw<input id="f_aw" class="input" type="number" step="0.001" value="0.972"/></label>
        <label>L* (–∫–æ–ª—ñ—Ä)<input id="f_L" class="input" type="number" step="0.1" value="78.2"/></label>
        <label>T —è–¥—Ä–∞, ¬∞C<input id="f_T" class="input" type="number" step="0.1" value="3.1"/></label>
        <label>–í–∞–∫—É—É–º, –∫–ü–∞<input id="f_vac" class="input" type="number" step="0.1" value="68.0"/></label>
        <label>–ú—ñ—Ç–∫–∞
          <select id="f_y" class="input">
            <option value="1">OK</option>
            <option value="0">NCR</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button class="btn" id="add">‚ûï –î–æ–¥–∞—Ç–∏ –∑—Ä–∞–∑–æ–∫</button>
        <input id="file" class="input" type="file" accept=".csv"/>
        <button class="btn secondary" id="import">üìÑ –Ü–º–ø–æ—Ä—Ç CSV</button>
        <button class="btn secondary" id="demo">üé≤ –î–µ–º–æ-–Ω–∞–±—ñ—Ä</button>
        <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
        <span id="stat" class="badge">–ó—Ä–∞–∑–∫—ñ–≤: 0 | OK: 0 | NCR: 0</span>
      </div>

      <h2 style="margin-top:10px">üß† –ú–æ–¥–µ–ª—å</h2>
      <div class="row">
        <label>–¢–∏–ø
          <select id="modelType" class="input">
            <option value="logreg" selected>–õ–æ–≥—ñ—Å—Ç–∏—á–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è</option>
            <option value="knn">k-NN (—à–≤–∏–¥–∫–∞ –±–∞–∑–æ–≤–∞)</option>
          </select>
        </label>
        <label>Train/Test, % <input id="split" class="input" type="number" min="50" max="90" step="5" value="70"/></label>
        <label>Seed<input id="seed" class="input" type="number" step="1" value="42"/></label>

        <div id="logregParams" class="row" style="flex-basis:100%">
          <label>–ö—Ä–æ–∫ (Œ∑)<input id="lr" class="input" type="number" step="0.001" value="0.05"/></label>
          <label>–ï–ø–æ—Ö<input id="epochs" class="input" type="number" step="10" value="400"/></label>
          <label>L2-—Ä–µ–≥—É–ª.<input id="l2" class="input" type="number" step="0.001" value="0.001"/></label>
        </div>
        <div id="knnParams" class="row" style="flex-basis:100%;display:none">
          <label>k —Å—É—Å—ñ–¥—ñ–≤<input id="k" class="input" type="number" step="1" value="5"/></label>
        </div>

        <label>–û–∑–Ω–∞–∫–∏ X/Y –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
          <select id="featX" class="input">
            <option value="0" selected>Œî–º–∞—Å–∏, –≥</option><option value="1">pH</option><option value="2">aw</option><option value="3">L*</option><option value="4">T —è–¥—Ä–∞, ¬∞C</option><option value="5">–í–∞–∫—É—É–º, –∫–ü–∞</option>
          </select>
        </label>
        <label>
          <select id="featY" class="input">
            <option value="1" selected>pH</option><option value="0">Œî–º–∞—Å–∏, –≥</option><option value="2">aw</option><option value="3">L*</option><option value="4">T —è–¥—Ä–∞, ¬∞C</option><option value="5">–í–∞–∫—É—É–º, –∫–ü–∞</option>
          </select>
        </label>

        <button class="btn good" id="train">üöÄ –ù–∞–≤—á–∏—Ç–∏</button>
      </div>

      <h3 style="margin-top:10px">üìà –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è (–º–µ–∂–∞ —Ä—ñ—à–µ–Ω–Ω—è)</h3>
      <div class="canvasWrap"><canvas id="chart" width="980" height="300"></canvas></div>
      <small class="muted">–ö–æ–ª–æ: –∑—Ä–∞–∑–æ–∫ OK; –•—Ä–µ—Å—Ç–∏–∫: NCR. –§–æ–Ω ‚Äî —ñ–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å OK (–ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∞) –∞–±–æ —á–∞—Å—Ç–∫–∞ —Å—É—Å—ñ–¥—ñ–≤ (k-NN).</small>

      <h3 style="margin-top:10px">üß™ –ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –Ω–æ–≤–æ—ó –ø–∞—Ä—Ç—ñ—ó</h3>
      <div class="row">
        <label>Œî–º–∞—Å–∏, –≥<input id="p_mass" class="input" type="number" step="0.1" value="-0.3"/></label>
        <label>pH<input id="p_ph" class="input" type="number" step="0.01" value="6.42"/></label>
        <label>aw<input id="p_aw" class="input" type="number" step="0.001" value="0.975"/></label>
        <label>L*<input id="p_L" class="input" type="number" step="0.1" value="79.1"/></label>
        <label>T —è–¥—Ä–∞, ¬∞C<input id="p_T" class="input" type="number" step="0.1" value="3.5"/></label>
        <label>–í–∞–∫—É—É–º, –∫–ü–∞<input id="p_vac" class="input" type="number" step="0.1" value="67.0"/></label>
        <button class="btn" id="predict">üîÆ –ü—Ä–æ–≥–Ω–æ–∑</button>
        <span id="predStat" class="badge">P(OK)=‚Äî | –†—ñ—à–µ–Ω–Ω—è: ‚Äî</span>
      </div>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h3>
      <div class="row">
        <input id="lot" class="input" placeholder="SKU/–õ–æ—Ç (–Ω–∞–ø—Ä. –°–∏—Ä 45% 2025-10-18)"/>
        <button class="btn" id="saveCsv">üìÑ CSV (–¥–∞–Ω—ñ + –º—ñ—Ç–∫–∏)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–∑–≤—ñ—Ç/–º–µ—Ç—Ä–∏–∫–∏)</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–æ–∫–∞–∑–∏)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>
      <small class="muted">QR –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ <span class="mono">api.qrserver.com</span>; –æ—Ñ–ª–∞–π–Ω –±—É–¥–µ —Ç–µ–∫—Å—Ç.</small>
    </div>

    <!-- –ü–†–ê–í–û -->
    <div class="card">
      <h2>üìä –ú–µ—Ç—Ä–∏–∫–∏</h2>
      <table class="tbl">
        <tbody>
          <tr><th>Train/Test</th><td id="m_split">‚Äî</td></tr>
          <tr><th>Accuracy</th><td id="m_acc">‚Äî</td></tr>
          <tr><th>Precision (OK)</th><td id="m_prec">‚Äî</td></tr>
          <tr><th>Recall (OK)</th><td id="m_rec">‚Äî</td></tr>
          <tr><th>F1</th><td id="m_f1">‚Äî</td></tr>
          <tr><th>AUC</th><td id="m_auc">‚Äî</td></tr>
          <tr><th>–ú–∞—Ç—Ä–∏—Ü—è –ø–æ–º–∏–ª–æ–∫</th><td id="m_cm">‚Äî</td></tr>
          <tr><th>–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ (–ª–æ–≥—ñ—Å—Ç.)</th><td id="m_w">‚Äî</td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">üîå –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—É (SVG)</h2>
      <svg viewBox="0 0 820 280" role="img" aria-label="QC ‚Üí –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö ‚Üí –ù–∞–≤—á–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ ‚Üí –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí –î—ñ—ó/—á–µ–∫">
        <rect x="40" y="40" width="160" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="120" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">QC –≤–∏–º—ñ—Ä–∏</text>
        <text x="120" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">–º–∞—Å–∞, pH, aw, L*, T, –≤–∞–∫—É—É–º</text>

        <rect x="220" y="40" width="180" height="120" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="310" y="80" fill="#dcfce7" font-size="14" text-anchor="middle">–î–∞–Ω—ñ/–ú—ñ—Ç–∫–∏</text>
        <text x="310" y="100" fill="#a7f3d0" font-size="12" text-anchor="middle">OK / NCR</text>

        <rect x="420" y="40" width="160" height="120" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="500" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–ú–æ–¥–µ–ª—å</text>
        <text x="500" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">–ª–æ–≥—ñ—Å—Ç. / k-NN</text>

        <rect x="600" y="40" width="180" height="120" rx="12" fill="#0b1a2f" stroke="#64748b"/>
        <text x="690" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–†—ñ—à–µ–Ω–Ω—è</text>
        <text x="690" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">—á–µ–∫/CSV/QR</text>

        <line x1="200" y1="100" x2="220" y2="100" stroke="#93c5fd" stroke-width="3"/>
        <line x1="400" y1="100" x2="420" y2="100" stroke="#22c55e" stroke-width="3"/>
        <line x1="580" y1="100" x2="600" y2="100" stroke="#64748b" stroke-width="3"/>
      </svg>

      <h2 style="margin-top:10px">üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
      <ol>
        <li>–ó–±–µ—Ä–∏ ‚â• 40 –∑—Ä–∞–∑–∫—ñ–≤, –∑–±–∞–ª–∞–Ω—Å—É–π OK/NCR, –Ω–∞–≤—á–∏ **–ª–æ–≥—ñ—Å—Ç–∏—á–Ω—É —Ä–µ–≥—Ä–µ—Å—ñ—é**, –¥–æ—Å—è–≥–Ω–∏ <b>AUC ‚â• 0.85</b>, –∑–±–µ—Ä–µ–∂–∏ <b>TXT</b>.</li>
        <li>–ü–æ—Ä—ñ–≤–Ω—è–π –∑ <b>k-NN (k=3..9)</b> –Ω–∞ —Ç–∏—Ö —Å–∞–º–∏—Ö –¥–∞–Ω–∏—Ö: —Ö—Ç–æ –º–∞—î –∫—Ä–∞—â–∏–π <b>F1</b>?</li>
        <li>–ó—Ä–æ–±–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ª–æ—Ç–∞, —Ä–æ–∑–¥—Ä—É–∫—É–π <b>—á–µ–∫ 58 –º–º</b> —Ç–∞ –∑–≥–µ–Ω–µ—Ä—É–π <b>QR</b> –Ω–∞ –ø–∞–ø–∫—É –∑ —Ñ–æ—Ç–æ/–∞–∫—Ç–∞–º–∏.</li>
      </ol>

      <h2 style="margin-top:10px">üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
      <p class="muted small">–õ–æ–≥—ñ—Å—Ç–∏—á–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è ‚Äî ¬´—Ä–æ–±–æ—á–∞ –∫–æ–Ω—è—á–∫–∞¬ª QC —ñ–∑ 1950-—Ö; –ø—Ä–æ—Å—Ç–∞, —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–æ–≤–∞–Ω–∞ —ñ –¥–∞—î –≤—ñ—Ä–æ–≥—ñ–¥–Ω—ñ—Å—Ç—å. k-NN ‚Äî —ñ–Ω—Ç—É—ó—Ç–∏–≤–Ω–∏–π ¬´—Å—Ö–æ–∂—ñ—Å—Ç—å-–ø—ñ–¥—Ö—ñ–¥¬ª. –£ –±–∞–≥–∞—Ç—å–æ—Ö –º–æ–ª–æ—á–Ω–∏—Ö/–º‚Äô—è—Å–Ω–∏—Ö –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞—Ö —Å–∞–º–µ —Ü—ñ –º–µ—Ç–æ–¥–∏ –±—É–ª–∏ –ø–µ—Ä—à–∏–º–∏ AI-—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –≤ —Ü–µ—Ö—É.</p>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function rand(seed){ // –ª—ñ–Ω—ñ–π–Ω–∏–π –∫–æ–Ω–≥—Ä—É–µ–Ω—Ç–Ω–∏–π
  let x=seed%2147483647; if(x<=0) x+=2147483646;
  return ()=> (x=(x*16807)%2147483647)/2147483647;
}
function zscore(X){ // —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ —Å—Ç–æ–≤–ø—Ü—è—Ö
  const m=[], s=[];
  for(let j=0;j<X[0].length;j++){
    const col=X.map(r=>r[j]);
    const mu=col.reduce((a,b)=>a+b,0)/col.length;
    const sd=Math.sqrt(col.reduce((a,b)=>a+(b-mu)*(b-mu),0)/col.length)||1;
    m.push(mu); s.push(sd);
  }
  const Z=X.map(r=>r.map((v,j)=>(v-m[j])/s[j]));
  return {Z, mu:m, sd:s};
}
function sigmoid(z){return 1/(1+Math.exp(-z));}
function shuffleInPlace(a, R=Math.random){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(R()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function splitTrainTest(X,y,ratio=0.7,seed=42){
  const idx=[...X.keys()]; const R=rand(seed); shuffleInPlace(idx,R);
  const nTrain=Math.floor(ratio*X.length);
  const tr=idx.slice(0,nTrain), te=idx.slice(nTrain);
  return {Xtr:tr.map(i=>X[i]), ytr:tr.map(i=>y[i]), Xte:te.map(i=>X[i]), yte:te.map(i=>y[i])};
}
function metrics(yTrue, yProb, thr=0.5){
  const yHat=yProb.map(p=>p>=thr?1:0);
  let TP=0,FP=0,TN=0,FN=0;
  for(let i=0;i<yTrue.length;i++){
    if(yTrue[i]===1 && yHat[i]===1) TP++;
    else if(yTrue[i]===0 && yHat[i]===1) FP++;
    else if(yTrue[i]===0 && yHat[i]===0) TN++;
    else FN++;
  }
  const acc=(TP+TN)/Math.max(1,yTrue.length);
  const prec=TP/Math.max(1,TP+FP);
  const rec =TP/Math.max(1,TP+FN);
  const f1 = (prec+rec)? 2*prec*rec/(prec+rec):0;
  // AUC (–ø—Ä–æ—Å—Ç–∞ –∞–ø—Ä–æ–∫—Å–∏–º–∞—Ü—ñ—è –∑–∞ –ø–æ—Ä–æ–≥–∞–º–∏)
  const ts=[...new Set(yProb)].sort((a,b)=>a-b);
  let auc=0, prevTPR=0, prevFPR=0;
  for(const t of ts){
    let tp=0,fp=0,tn=0,fn=0;
    for(let i=0;i<yTrue.length;i++){
      const p=yProb[i]>=t?1:0;
      if(yTrue[i]===1 && p===1) tp++; else if(yTrue[i]===0 && p===1) fp++;
      else if(yTrue[i]===0 && p===0) tn++; else fn++;
    }
    const TPR=tp/Math.max(1,tp+fn);
    const FPR=fp/Math.max(1,fp+tn);
    auc += (FPR-prevFPR)*(TPR+prevTPR)/2;
    prevTPR=TPR; prevFPR=FPR;
  }
  auc = Math.abs(auc);
  return {acc,prec,rec,f1,cm:[TP,FP,TN,FN],auc,yHat};
}
function parseCSV(text){
  // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞: ; , \t
  const sep = text.includes('\t')?'\t':(text.split('\n')[0].includes(';')?';':',');
  const rows = text.trim().split(/\r?\n/).map(r=>r.split(sep));
  const head=rows[0].map(s=>s.trim().toLowerCase());
  // –æ—á—ñ–∫—É–≤–∞–Ω—ñ: mass_delta_g, ph, aw, L, T_core_C, vacuum_kpa, y (1=OK,0=NCR)
  const mapName=(n)=>head.findIndex(h=>h===n || h.replace(/[^a-z0-9]/g,'')===n.replace(/[^a-z0-9]/g,''));
  let idx=[mapName('mass_delta_g'),mapName('ph'),mapName('aw'),mapName('l'),mapName('t_core_c'),mapName('vacuum_kpa'),mapName('y')];
  let start=1;
  if(idx.some(i=>i<0)){ // —Å–ø—Ä–æ–±—É—î–º–æ –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
    start=0; idx=[0,1,2,3,4,5,6];
  }
  const X=[], y=[];
  for(let i=start;i<rows.length;i++){
    const r=rows[i]; if(r.length<7) continue;
    const v=idx.slice(0,6).map(j=>parseFloat((r[j]||'').toString().replace(',','.')));
    if(v.some(x=>!isFinite(x))) continue;
    const yy=parseInt((r[idx[6]]||'').toString().trim(),10); if(!(yy===0||yy===1)) continue;
    X.push(v); y.push(yy);
  }
  return {X,y};
}
function prettyW(w){return '['+w.map(v=>v.toFixed(3)).join(', ')+']';}

// ===== –ì–ª–æ–±–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ =====
let DATA_X=[]; // –º–∞—Å–∏–≤ —Ä—è–¥–∫—ñ–≤ –æ–∑–Ω–∞–∫
let DATA_y=[]; // 1 OK, 0 NCR

// ===== UI –î–æ–¥–∞–≤–∞–Ω–Ω—è/–Ü–º–ø–æ—Ä—Ç =====
function updateStat(){
  const ok=DATA_y.filter(v=>v===1).length, n=DATA_y.length;
  $('#stat').textContent=`–ó—Ä–∞–∑–∫—ñ–≤: ${n} | OK: ${ok} | NCR: ${n-ok}`;
}
$('#add').addEventListener('click', ()=>{
  const v=[+$('#f_mass').value,+$('#f_ph').value,+$('#f_aw').value,+$('#f_L').value,+$('#f_T').value,+$('#f_vac').value];
  if(v.some(x=>!isFinite(x))) return alert('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è');
  const y=+$('#f_y').value;
  DATA_X.push(v); DATA_y.push(y); updateStat(); draw(); 
});
$('#clear').addEventListener('click', ()=>{ DATA_X=[]; DATA_y=[]; updateStat(); draw(); resetMetrics(); });
$('#import').addEventListener('click', ()=>{
  const f=$('#file').files[0]; if(!f) return alert('–û–±–µ—Ä—ñ—Ç—å CSV');
  const r=new FileReader(); r.onload=()=>{ const d=parseCSV(r.result); DATA_X=DATA_X.concat(d.X); DATA_y=DATA_y.concat(d.y); updateStat(); draw(); };
  r.readAsText(f);
});
$('#demo').addEventListener('click', ()=>{
  const R=rand(123);
  // –°—Ç–≤–æ—Ä–∏–º–æ –¥–≤–∞ ¬´–∫–ª–∞—Å–∏¬ª: OK –Ω–∞–≤–∫–æ–ª–æ –Ω–æ—Ä–º–∞—Ç–∏–≤—ñ–≤, NCR ‚Äî –∑–º—ñ—â–µ–Ω—ñ
  for(let i=0;i<60;i++){
    const ok = [  // Œî–º–∞—Å–∏, pH, aw, L, T, –≤–∞–∫—É—É–º
      -0.6+R()*0.6, 6.45+R()*0.08, 0.975+R()*0.002, 79+R()*2, 3.2+R()*0.4, 68+R()*2
    ];
    DATA_X.push(ok); DATA_y.push(1);
  }
  for(let i=0;i<40;i++){
    const ncr=[
      1.5+R()*1.2, 6.05+R()*0.15, 0.985+R()*0.004, 73+R()*3.0, 6.5+R()*1.2, 55+R()*5
    ];
    DATA_X.push(ncr); DATA_y.push(0);
  }
  updateStat(); draw();
});

// ===== –ú–æ–¥–µ–ª—å: –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è =====
function trainLogReg(X,y,lr=0.05,epochs=400,l2=0.001){
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü—ñ—è
  const {Z,mu,sd}=zscore(X);
  // –¥–æ–¥–∞—î–º–æ bias
  const addBias = A=>A.map(r=>[1,...r]);
  const Zb=addBias(Z);
  let w=new Array(Zb[0].length).fill(0);
  for(let ep=0; ep<epochs; ep++){
    const grad=new Array(w.length).fill(0);
    let loss=0;
    for(let i=0;i<Zb.length;i++){
      const z=Zb[i].reduce((s,v,j)=>s+v*w[j],0);
      const p=sigmoid(z);
      const e=p - y[i];
      for(let j=0;j<w.length;j++) grad[j]+= e*Zb[i][j];
      loss += -(y[i]*Math.log(p+1e-9)+(1-y[i])*Math.log(1-p+1e-9));
    }
    // L2
    for(let j=1;j<w.length;j++){ grad[j]+= l2*w[j]; loss+= 0.5*l2*w[j]*w[j]; }
    for(let j=0;j<w.length;j++) w[j]-= lr*grad[j]/Zb.length;
    // –º–æ–∂–Ω–∞ –ø—Ä–∏ –±–∞–∂–∞–Ω–Ω—ñ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ loss
  }
  function predictProba(Xnew){
    const Znew=Xnew.map(r=>r.map((v,j)=>(v-mu[j])/sd[j]));
    const Znb=Znew.map(r=>[1,...r]);
    return Znb.map(r=>sigmoid(r.reduce((s,v,j)=>s+v*w[j],0)));
  }
  return {w,mu,sd,predictProba};
}

// ===== –ú–æ–¥–µ–ª—å: k-NN =====
function predictKNN(trainX, trainY, Xnew, k=5){
  function dist(a,b){ let s=0; for(let j=0;j<a.length;j++){ const d=a[j]-b[j]; s+=d*d; } return Math.sqrt(s); }
  const out=[];
  for(const x of Xnew){
    const d=trainX.map((r,i)=>({i, d:dist(r,x)})).sort((a,b)=>a.d-b.d).slice(0,k);
    const p = d.reduce((s,o)=>s+trainY[o.i],0)/k;
    out.push(p);
  }
  return out;
}

// ===== –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è / –ú–µ—Ç—Ä–∏–∫–∏ / –í–∏–≤—ñ–¥ =====
function resetMetrics(){
  $('#m_split').textContent='‚Äî'; $('#m_acc').textContent='‚Äî'; $('#m_prec').textContent='‚Äî';
  $('#m_rec').textContent='‚Äî'; $('#m_f1').textContent='‚Äî'; $('#m_auc').textContent='‚Äî'; $('#m_cm').textContent='‚Äî'; $('#m_w').textContent='‚Äî';
}
$('#modelType').addEventListener('change', ()=>{
  const t=$('#modelType').value;
  $('#logregParams').style.display = (t==='logreg'?'flex':'none');
  $('#knnParams').style.display    = (t==='knn'?'flex':'none');
});

let MODEL=null; // {type, predictProba, w, mu, sd, Xtr,ytr}
$('#train').addEventListener('click', ()=>{
  if(DATA_X.length<10) return alert('–î–æ–¥–∞–π —â–æ–Ω–∞–π–º–µ–Ω—à–µ 10 –∑—Ä–∞–∑–∫—ñ–≤');
  const split=+$('#split').value/100;
  const seed=+$('#seed').value;
  const {Xtr,ytr,Xte,yte}=splitTrainTest(DATA_X,DATA_y,split,seed);
  const type=$('#modelType').value;
  let predictProba, w, mu, sd;

  if(type==='logreg'){
    const lr=+$('#lr').value, ep=+$('#epochs').value, l2=+$('#l2').value;
    const M=trainLogReg(Xtr,ytr,lr,ep,l2);
    predictProba=(X)=>M.predictProba(X); w=M.w; mu=M.mu; sd=M.sd;
    $('#m_w').textContent=`bias + w: ${prettyW(w)}`;
  }else{
    const k=+$('#k').value;
    predictProba=(X)=>predictKNN(Xtr,ytr,X,k);
    $('#m_w').textContent='(k-NN –Ω–µ –º–∞—î –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤)';
  }

  const pTrain=predictProba(Xtr);
  const mTr=metrics(ytr,pTrain,0.5);
  const pTest=predictProba(Xte);
  const mTe=metrics(yte,pTest,0.5);

  $('#m_split').textContent=`Train ${Math.round(split*100)}% / Test ${Math.round(100-split*100)}%`;
  $('#m_acc').textContent = mTe.acc.toFixed(3);
  $('#m_prec').textContent= mTe.prec.toFixed(3);
  $('#m_rec').textContent = mTe.rec.toFixed(3);
  $('#m_f1').textContent  = mTe.f1.toFixed(3);
  $('#m_auc').textContent = mTe.auc.toFixed(3);
  $('#m_cm').textContent  = `TP=${mTe.cm[0]}, FP=${mTe.cm[1]}, TN=${mTe.cm[2]}, FN=${mTe.cm[3]}`;

  MODEL={type,predictProba,w,mu,sd,Xtr,ytr};
  draw(); // –ø–µ—Ä–µ–º–∞–ª—é—î–º–æ —Ñ–æ–Ω-–π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å
});

// ===== –ü—Ä–æ–≥–Ω–æ–∑ =====
$('#predict').addEventListener('click', ()=>{
  if(!MODEL) return alert('–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç—Ä–µ–Ω—É–π –º–æ–¥–µ–ª—å');
  const x=[+$('#p_mass').value,+$('#p_ph').value,+$('#p_aw').value,+$('#p_L').value,+$('#p_T').value,+$('#p_vac').value];
  const p=MODEL.predictProba([x])[0];
  const decision = p>=0.5? 'OK' : 'NCR';
  $('#predStat').textContent=`P(OK)=${p.toFixed(3)} | –†—ñ—à–µ–Ω–Ω—è: ${decision}`;
});

// ===== –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è =====
const cvs=$('#chart'), ctx=cvs.getContext('2d');
function draw(){
  const W=cvs.width,H=cvs.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);

  // –Ø–∫—â–æ —î –º–æ–¥–µ–ª—å ‚Äî –ø–æ–∫–∞–∂–µ–º–æ —Ñ–æ–Ω (–π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ) —É 2D-–ø—Ä–æ—î–∫—Ü—ñ—ó
  const fx=+$('#featX').value, fy=+$('#featY').value;
  const pad=30, left=50, right=W-10, top=20, bottom=H-30;
  const xs=DATA_X.map(r=>r[fx]), ys=DATA_X.map(r=>r[fy]);
  const minX=Math.min(...xs, -2), maxX=Math.max(...xs,  2);
  const minY=Math.min(...ys,  5.5), maxY=Math.max(...ys, 8.0);

  const xOf=v=> left+(v-minX)/(maxX-minX||1)*(right-left);
  const yOf=v=> bottom-(v-minY)/(maxY-minY||1)*(bottom-top);

  if(MODEL){
    const grid=80;
    for(let gx=0;gx<=grid;gx++){
      for(let gy=0;gy<=grid;gy++){
        const vx= minX + (gx/grid)*(maxX-minX);
        const vy= minY + (gy/grid)*(maxY-minY);
        // —ñ–Ω—à—ñ —Ñ—ñ—á—ñ —Ñ—ñ–∫—Å—É—î–º–æ –ø–æ –º–µ–¥—ñ–∞–Ω—ñ –Ω–∞–±–æ—Ä—É (—è–∫ –ø—Ä–æ—Å—Ç–∞ –ø—Ä–æ—î–∫—Ü—ñ—è)
        const med=(j)=>{ const col=DATA_X.map(r=>r[j]).sort((a,b)=>a-b); return col.length? col[Math.floor(col.length/2)] : 0; };
        const x=[0,1,2,3,4,5].map(j=> med(j));
        x[fx]=vx; x[fy]=vy;
        const p=MODEL.predictProba([x])[0];
        const alpha=Math.max(0.08, Math.min(0.28, Math.abs(p-0.5)*0.6+0.08));
        ctx.fillStyle=`rgba(56,189,248,${alpha})`; // —Å–∏–Ω—é–≤–∞—Ç–∏–π —Ñ–æ–Ω –∑–∞ p(OK)
        ctx.fillRect(xOf(vx), yOf(vy), (right-left)/grid+1, (bottom-top)/grid+1);
      }
    }
  }

  // –¢–æ—á–∫–∏ –¥–∞–Ω–∏—Ö
  for(let i=0;i<DATA_X.length;i++){
    const x=xOf(DATA_X[i][fx]), y=yOf(DATA_X[i][fy]);
    if(DATA_y[i]===1){
      ctx.strokeStyle='#22c55e'; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.stroke();
    }else{
      ctx.strokeStyle='#f87171'; ctx.beginPath(); ctx.moveTo(x-4,y-4); ctx.lineTo(x+4,y+4); ctx.moveTo(x-4,y+4); ctx.lineTo(x+4,y-4); ctx.stroke();
    }
  }

  // –û—Å—ñ/–ø—ñ–¥–ø–∏—Å–∏
  const names=['Œî–º–∞—Å–∏, –≥','pH','aw','L*','T —è–¥—Ä–∞, ¬∞C','–í–∞–∫—É—É–º, –∫–ü–∞'];
  ctx.fillStyle='#94a3b8'; ctx.font='12px ui-monospace';
  ctx.fillText(names[fx], left, H-8);
  ctx.save(); ctx.translate(10, (top+bottom)/2); ctx.rotate(-Math.PI/2); ctx.fillText(names[fy], 0,0); ctx.restore();
}

// –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ñ—ñ—á
$('#featX').addEventListener('change', draw);
$('#featY').addEventListener('change', draw);

// ===== –ï–∫—Å–ø–æ—Ä—Ç / –ß–µ–∫ / QR =====
$('#saveCsv').addEventListener('click', ()=>{
  if(!DATA_X.length) return alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö');
  let csv='mass_delta_g,ph,aw,L,T_core_C,vacuum_kPa,y\n';
  for(let i=0;i<DATA_X.length;i++){
    csv+=`${DATA_X[i].join(',')},${DATA_y[i]}\n`;
  }
  download('tech_para21_qc_'+stamp()+'.csv', csv, 'text/csv');
});
$('#saveTxt').addEventListener('click', ()=>{
  const lines=[
    '–ü–∞—Ä–∞ 21 ‚Äî –®–Ü –¥–ª—è QC: –ø—ñ–¥—Å—É–º–æ–∫',
    '–ó—Ä–∞–∑–∫—ñ–≤: '+DATA_y.length,
    '–ú–æ–¥–µ–ª—å: '+($('#modelType').value==='logreg'?'–õ–æ–≥—ñ—Å—Ç–∏—á–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è':'k-NN'),
    '–ú–µ—Ç—Ä–∏–∫–∏ (–¥–∏–≤. —Ç–∞–±–ª–∏—Ü—é –ø—Ä–∞–≤–æ—Ä—É—á —É UI)',
    '–ù–æ—Ç–∞—Ç–∫–∏: ...'
  ];
  download('tech_para21_summary_'+stamp()+'.txt', lines.join('\n'));
});
$('#print58').addEventListener('click', ()=>{
  const rc=$('#rc'); rc.hidden=false;
  const lines=[
    '=== QC AI (58–º–º) ===',
    '–õ–æ—Ç: '+($('#lot').value||'‚Äî'),
    '–ú–æ–¥–µ–ª—å: '+($('#modelType').value==='logreg'?'LogReg':'k-NN'),
    `Acc=${$('#m_acc').textContent} AUC=${$('#m_auc').textContent}`,
    $('#predStat').textContent.replace(/\|/g,'|').trim(),
    '---------------------'
  ];
  rc.textContent=lines.join('\n');
  download('tech_para21_receipt_'+stamp()+'.txt', rc.textContent);
});
$('#qrGen').addEventListener('click', ()=>{
  const data = prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –∞–∫—Ç–∞–º–∏/—Ñ–æ—Ç–æ):', $('#lot').value || 'qc-ai-evidence');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url;
});

// ===== –°—Ç–∞—Ä—Ç =====
draw(); resetMetrics();
</script>
</body>
</html>
