<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 17 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –í–∞–≥–∞ ‚Üí –ø–æ—Ä—Ü—ñ—ó ‚Üí —É—Å—É—à–∫–∞ ‚Üí SPC XÃÑ‚ÄìR, —á–µ–∫/CSV</title>
<meta name="description" content="–ï–º—É–ª—è—Ç–æ—Ä –¥–æ–∑—É–≤–∞–Ω–Ω—è: –º–∞—Å–∞ –ø–æ—Ä—Ü—ñ–π, —É—Å—É—à–∫–∞, —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó LSL/USL. SPC XÃÑ‚ÄìR (A2/D3/D4), –≥—Ä–∞—Ñ—ñ–∫–∏, –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å, giveaway/short, –∂—É—Ä–Ω–∞–ª, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, —á–µ–∫ 58 –º–º."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1220px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:100px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
small.mono,.mono{font-family:ui-monospace,monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.35fr 1fr}
@media(max-width:1120px){.grid{grid-template-columns:1fr}}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:320px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">‚öñÔ∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 17 ‚Äî –î–æ–∑—É–≤–∞–Ω–Ω—è/—É—Å—É—à–∫–∞ + SPC XÃÑ‚ÄìR</b><br/>
        <span class="badge">–µ–º—É–ª—è—Ç–æ—Ä –≤–∞–≥–∏ ‚Üí –ø—ñ–¥–≥—Ä—É–ø–∏ ‚Üí XÃÑ‚ÄìR ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å LSL/USL ‚Üí giveaway/short ‚Üí —á–µ–∫/CSV</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –∑–º–æ–¥–µ–ª—é–≤–∞—Ç–∏ **–¥–æ–∑—É–≤–∞–Ω–Ω—è –ø–æ—Ä—Ü—ñ–π** (—Å–∏—Ä/–º‚Äô—è—Å–æ/–º–∞—Å–ª–æ), –æ—Ü—ñ–Ω–∏—Ç–∏ **—É—Å—É—à–∫—É** –ø—ñ–¥ —á–∞—Å —Ç–µ—Ä–º–æ–æ–±—Ä–æ–±–∫–∏, –ø–æ–±—É–¥—É–≤–∞—Ç–∏ **SPC XÃÑ‚ÄìR** –∑ –º–µ–∂–∞–º–∏ –∫–µ—Ä–æ–≤–∞–Ω–æ—Å—Ç—ñ (<span class="mono">A‚ÇÇ, D‚ÇÉ, D‚ÇÑ</span>), –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ **–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è–º** (<span class="mono">LSL/USL</span>) —Ç–∞ –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ **giveaway/short** —É –≥—Ä–æ—à–∞—Ö.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û: –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è + –≥—Ä–∞—Ñ—ñ–∫–∏ + –∂—É—Ä–Ω–∞–ª -->
    <div class="card">
      <h2>üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –µ–º—É–ª—è—Ç–æ—Ä–∞ –≤–∞–≥–∏</h2>
      <div class="row">
        <label>–¶—ñ–ª—å, –≥<input id="target" class="input" type="number" step="0.1" value="200"/></label>
        <label>LSL, –≥<input id="lsl" class="input" type="number" step="0.1" value="195"/></label>
        <label>USL, –≥<input id="usl" class="input" type="number" step="0.1" value="205"/></label>
        <label>œÉ (—Ä–æ–∑–∫–∏–¥), –≥<input id="sigma" class="input" type="number" step="0.1" value="1.5"/></label>
      </div>
      <div class="row">
        <label>–î—Ä–µ–π—Ñ/100 –ø–æ—Ä—Ü—ñ–π, –≥<input id="drift" class="input" type="number" step="0.1" value="0.8"/></label>
        <label>–ü—ñ–¥–≥—Ä—É–ø–∞ n<input id="n" class="input" type="number" min="2" max="10" step="1" value="5"/></label>
        <label>–£—Å—É—à–∫–∞, % (–ø—ñ—Å–ª—è –≤–∞—Ä–∫–∏/–∫–æ–ø—Ç—ñ–Ω–Ω—è)<input id="shrink" class="input" type="number" step="0.1" value="3.0"/></label>
        <label>–¶—ñ–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—É, –≥—Ä–Ω/–∫–≥<input id="price" class="input" type="number" step="0.1" value="220"/></label>
      </div>
      <div class="row">
        <button class="btn good" id="start">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button class="btn" id="tick">‚ûï 1 –ø–æ—Ä—Ü—ñ—è</button>
        <button class="btn" id="tick10">‚ûï 10 –ø–æ—Ä—Ü—ñ–π</button>
        <button class="btn secondary" id="reset">üßπ –°–∫–∏–Ω—É—Ç–∏</button>
        <span id="stat" class="badge">–°—Ç–∞—Ç—É—Å: idle</span>
      </div>

      <h3 style="margin-top:10px">üìà SPC –ì—Ä–∞—Ñ—ñ–∫–∏ (XÃÑ‚ÄìR)</h3>
      <div class="canvasWrap"><canvas id="chart" width="980" height="320"></canvas></div>
      <small class="muted">–°–∏–Ω—ñ–π ‚Äî XÃÑ; –ó–µ–ª–µ–Ω–∏–π ‚Äî R; –ñ–æ–≤—Ç—ñ ‚Äî –º–µ–∂—ñ –∫–µ—Ä–æ–≤–∞–Ω–æ—Å—Ç—ñ; –°—ñ—Ä—ñ ‚Äî –º–µ–∂—ñ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ–π LSL/USL (–ø—Ä–æ–µ–∫—Ç—É—é—Ç—å—Å—è –Ω–∞ XÃÑ).</small>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="note" style="max-height:180px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <input id="lot" class="input" placeholder="–õ–æ—Ç/–ø–∞—Ä—Ç—ñ—è (–Ω–∞–ø—Ä. 2025-10-18-02)"/>
        <button class="btn" id="saveCsv">üìÑ CSV (—É—Å—ñ –∑—Ä–∞–∑–∫–∏ + XÃÑ‚ÄìR)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
      </div>
      <div class="receipt" id="rc" hidden></div>
    </div>

    <!-- –ü–†–ê–í–û: –ø–æ–∫–∞–∑–Ω–∏–∫–∏ + —Å—Ö–µ–º–∞ + –∑–∞–≤–¥–∞–Ω–Ω—è -->
    <div class="card">
      <h2>üìä –ü–æ–∫–∞–∑–Ω–∏–∫–∏</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–í–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –ø–æ—Ä—Ü—ñ–π</th><td id="m_cnt">0</td></tr>
          <tr><th>–í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å LSL/USL</th><td id="m_conform">‚Äî</td></tr>
          <tr><th>XÃÑ (—Å–µ—Ä–µ–¥–Ω—î –≤—Å—ñ—Ö)</th><td id="m_xbar">‚Äî</td></tr>
          <tr><th>RÃÑ (—Å–µ—Ä–µ–¥–Ω—î –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ–≤)</th><td id="m_rbar">‚Äî</td></tr>
          <tr><th>UCL/LCL –¥–ª—è XÃÑ</th><td id="m_xlim">‚Äî</td></tr>
          <tr><th>UCL/LCL –¥–ª—è R</th><td id="m_rlim">‚Äî</td></tr>
          <tr><th>–£—Å—É—à–∫–∞, %</th><td id="m_shrink">‚Äî</td></tr>
          <tr><th>Giveaway (–≥/–ø–æ—Ä—Ü—ñ—é)</th><td id="m_give">‚Äî</td></tr>
          <tr><th>–í—Ç—Ä–∞—Ç–∏/–Ω–∞–¥–ª–∏—à–∫–∏, –≥—Ä–Ω (–≤—Å—å–æ–≥–æ)</th><td id="m_loss">‚Äî</td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">üîå –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—É (SVG)</h2>
      <svg viewBox="0 0 820 260" role="img" aria-label="–î–æ–∑–∞—Ç–æ—Ä ‚Üí –í–∞–≥–∞ ‚Üí –£—Å—É—à–∫–∞ ‚Üí –ö–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ">
        <rect x="40" y="40" width="200" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="140" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–î–æ–∑–∞—Ç–æ—Ä</text>
        <text x="140" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">—Ç–∞—Ä—É–≤–∞–Ω–Ω—è, —Ü—ñ–ª—å</text>

        <rect x="280" y="40" width="200" height="120" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="380" y="80" fill="#dcfce7" font-size="14" text-anchor="middle">–í–∞–≥–∞</text>
        <text x="380" y="100" fill="#a7f3d0" font-size="12" text-anchor="middle">–ø—ñ–¥–≥—Ä—É–ø–∞ n</text>

        <rect x="520" y="40" width="120" height="120" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="580" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–£—Å—É—à–∫–∞</text>
        <text x="580" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">%, –ø—ñ—Å–ª—è –¢/–æ–±—Ä–æ–±–∫–∏</text>

        <rect x="660" y="40" width="120" height="120" rx="12" fill="#0b1a2f" stroke="#64748b"/>
        <text x="720" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">SPC XÃÑ‚ÄìR</text>
        <text x="720" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">A‚ÇÇ/D‚ÇÉ/D‚ÇÑ</text>

        <line x1="240" y1="100" x2="280" y2="100" stroke="#93c5fd" stroke-width="3"/>
        <line x1="480" y1="100" x2="520" y2="100" stroke="#22c55e" stroke-width="3"/>
        <line x1="640" y1="100" x2="660" y2="100" stroke="#64748b" stroke-width="3"/>
      </svg>

      <h2 style="margin-top:10px">üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
      <ol>
        <li>–ù–∞–ª–∞—à—Ç—É–π <b>LSL/USL</b> –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç—É 200 –≥ (–Ω–∞–ø—Ä. 195‚Äì205 –≥). –ó–≥–µ–Ω–µ—Ä—É–π ‚â• 50 –ø–æ—Ä—Ü—ñ–π. –ï–∫—Å–ø–æ—Ä—Ç—É–π <b>CSV</b>.</li>
        <li>–ü—ñ–¥–±–µ—Ä–∏ <b>n</b> —ñ –æ—Ü—ñ–Ω–∏ XÃÑ‚ÄìR: —á–∏ –ø–æ—Ç—Ä–∞–ø–ª—è—é—Ç—å —Ç–æ—á–∫–∏ –≤ –º–µ–∂—ñ –∫–µ—Ä–æ–≤–∞–Ω–æ—Å—Ç—ñ? –î–æ–¥–∞–π –∫–æ–º–µ–Ω—Ç–∞—Ä —É <b>TXT</b>.</li>
        <li>–ó–∞–¥–∞–π <b>—É—Å—É—à–∫—É 3‚Äì5%</b> —ñ –ø–æ—Ä–∞—Ö—É–π <b>giveaway</b> —É –≥—Ä–Ω. –†–æ–∑–¥—Ä—É–∫—É–π <b>—á–µ–∫ 58 –º–º</b> –¥–ª—è –±—Ä–∏–≥–∞–¥–∏.</li>
      </ol>
    </div>
  </div>

  <div class="card">
    <h2>üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
    <p class="muted small">SPC –∑–∞—Ä–æ–¥–∏–ª–∞—Å—å —É 1920-—Ö (–®—É—Ö–∞—Ä—Ç), –∞ —Å—å–æ–≥–æ–¥–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ä—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –≤ –º‚Äô—è—Å–Ω—ñ–π/–º–æ–ª–æ—á–Ω—ñ–π –≥–∞–ª—É–∑—ñ ‚Äî —Ü–µ –ø–æ—î–¥–Ω–∞–Ω–Ω—è –≤–∞–≥, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–∞ –≤–∞—Ä—Ç–æ—Å—Ç—ñ –≤—ñ–¥—Ö–∏–ª–µ–Ω—å. –ú–∏ –≤—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ —Ü–µ –ø—Ä–æ—Å—Ç–æ —É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s);
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function rndNorm(){ // Box‚ÄìMuller
  let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function mean(a){return a.reduce((s,x)=>s+x,0)/Math.max(1,a.length);}
function range(a){return Math.max(...a)-Math.min(...a);}

// ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ SPC (–¥–ª—è –ø—ñ–¥–≥—Ä—É–ø n=2..10) =====
const A2={2:1.880,3:1.023,4:0.729,5:0.577,6:0.483,7:0.419,8:0.373,9:0.337,10:0.308};
const D3={2:0.000,3:0.000,4:0.000,5:0.000,6:0.000,7:0.076,8:0.136,9:0.184,10:0.223};
const D4={2:3.267,3:2.574,4:2.282,5:2.114,6:2.004,7:1.924,8:1.864,9:1.816,10:1.777};

// ===== –°—Ç–∞–Ω –µ–º—É–ª—è—Ç–æ—Ä–∞ =====
let samples=[];    // —É—Å—ñ —Å–∏—Ä—ñ –∑—Ä–∞–∑–∫–∏ (–¥–æ —É—Å—É—à–∫–∏)
let groups=[];     // [{xs:[], xbar, r}]
let driftBase=0;   // –Ω–∞–∫–æ–ø–∏—á–µ–Ω–∏–π –¥—Ä–µ–π—Ñ
let tickCount=0;

const chart=$('#chart'), ctx=chart.getContext('2d');

// ===== –ü–æ–¥—ñ—ó –∫–µ—Ä—É–≤–∞–Ω–Ω—è =====
$('#start').addEventListener('click', ()=>{ tickBatch(10); $('#stat').textContent='–°—Ç–∞—Ç—É—Å: –ø—Ä–∞—Ü—é—î'; });
$('#tick').addEventListener('click', ()=> tickBatch(1));
$('#tick10').addEventListener('click', ()=> tickBatch(10));
$('#reset').addEventListener('click', resetAll);

function resetAll(){
  samples.length=0; groups.length=0; driftBase=0; tickCount=0;
  $('#stat').textContent='–°—Ç–∞—Ç—É—Å: idle';
  $('#rc').hidden=true;
  $('#alog').textContent='// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π';
  renderKPIs(); draw();
}

// ===== –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å =====
function tickBatch(k){
  const target=parseFloat($('#target').value)||200;
  const sigma=parseFloat($('#sigma').value)||1.5;
  const n=parseInt($('#n').value,10)||5;
  const drift=parseFloat($('#drift').value)||0; // –≥/100 –ø–æ—Ä—Ü—ñ–π
  for(let i=0;i<k;i++){
    // –¥—Ä–µ–π—Ñ –∑—Ä–æ—Å—Ç–∞—î –ø–ª–∞–≤–Ω–æ
    const driftNow = driftBase + (drift/100)*tickCount;
    const x = target + driftNow + sigma * rndNorm();
    samples.push(x);
    tickCount++;
    if(samples.length % n === 0){
      const xs=samples.slice(samples.length-n);
      const xbar=mean(xs), r=range(xs);
      groups.push({xs,xbar,r});
      log(`–ü—ñ–¥–≥—Ä—É–ø–∞ #${groups.length}: XÃÑ=${xbar.toFixed(2)} –≥, R=${r.toFixed(2)} –≥`);
    }
  }
  renderKPIs(); draw();
}

function log(msg){
  const t=new Date().toLocaleTimeString();
  const box=$('#alog');
  if(box.textContent.startsWith('//')) box.textContent='';
  box.textContent+=`[${t}] ${msg}\n`;
  box.scrollTop=box.scrollHeight;
}

// ===== KPI =====
function renderKPIs(){
  const LSL=parseFloat($('#lsl').value), USL=parseFloat($('#usl').value);
  $('#m_cnt').textContent = samples.length;

  if(samples.length){
    const xb = mean(samples);
    $('#m_xbar').textContent = xb.toFixed(3)+' –≥';
  } else { $('#m_xbar').textContent='‚Äî'; }

  if(groups.length){
    const rbar = mean(groups.map(g=>g.r));
    $('#m_rbar').textContent = rbar.toFixed(3)+' –≥';

    const n=parseInt($('#n').value,10);
    const a2=A2[n], d3=D3[n], d4=D4[n];
    const xbarbar = mean(groups.map(g=>g.xbar));

    const UCLx = xbarbar + a2*rbar;
    const LCLx = xbarbar - a2*rbar;
    const UCLr = d4*rbar;
    const LCLr = d3*rbar;

    $('#m_xlim').textContent = `LCL=${LCLx.toFixed(2)}; UCL=${UCLx.toFixed(2)}`;
    $('#m_rlim').textContent = `LCL=${LCLr.toFixed(2)}; UCL=${UCLr.toFixed(2)}`;

    const conf = samples.filter(x=>x>=LSL && x<=USL).length / samples.length * 100;
    $('#m_conform').textContent = samples.length? conf.toFixed(1)+' %' : '‚Äî';

    const shrink = parseFloat($('#shrink').value)||0;
    $('#m_shrink').textContent = shrink.toFixed(1)+' %';

    // Giveaway / short –ø—ñ—Å–ª—è —É—Å—É—à–∫–∏ –≤—ñ–¥–Ω–æ—Å–Ω–æ —Ç–∞—Ä–≥–µ—Ç–∞
    const price = parseFloat($('#price').value)||0;  // –≥—Ä–Ω/–∫–≥
    const tgt = parseFloat($('#target').value)||200;
    const netMean = mean(samples) * (1 - shrink/100); // —Å–µ—Ä–µ–¥–Ω—è –º–∞—Å–∞ –ø—ñ—Å–ª—è —É—Å—É—à–∫–∏
    const givePer = (netMean - tgt); // –≥/–ø–æ—Ä—Ü—ñ—é (+ –Ω–∞–¥–ª–∏—à–æ–∫, ‚Äì –Ω–µ–¥–æ–≤–∫–ª–∞–¥–µ–Ω–Ω—è)
    const lossTotalUAH = (givePer/1000) * price * samples.length; // –≥—Ä–Ω
    $('#m_give').textContent = givePer.toFixed(2)+' –≥/–ø–æ—Ä—Ü—ñ—é';
    const cls = lossTotalUAH>=0 ? 'warn' : 'bad';
    $('#m_loss').innerHTML = `<b class="${cls}">${lossTotalUAH.toFixed(2)} –≥—Ä–Ω</b>`;
  }else{
    $('#m_rbar').textContent='‚Äî';
    $('#m_xlim').textContent='‚Äî';
    $('#m_rlim').textContent='‚Äî';
    $('#m_conform').textContent='‚Äî';
    $('#m_shrink').textContent='‚Äî';
    $('#m_give').textContent='‚Äî';
    $('#m_loss').textContent='‚Äî';
  }
}

// ===== –ú–∞–ª—é–≤–∞–Ω–Ω—è XÃÑ‚ÄìR =====
function draw(){
  const W=chart.width,H=chart.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);

  if(!groups.length) return;

  const n=parseInt($('#n').value,10);
  const a2=A2[n], d3=D3[n], d4=D4[n];
  const xs=groups.map((g,i)=>i+1);
  const xbars=groups.map(g=>g.xbar);
  const rs=groups.map(g=>g.r);
  const xbarbar=mean(xbars), rbar=mean(rs);

  const UCLx=xbarbar+a2*rbar, LCLx=xbarbar-a2*rbar;
  const UCLr=d4*rbar, LCLr=d3*rbar;

  const LSL=parseFloat($('#lsl').value), USL=parseFloat($('#usl').value);

  const left=60, right=W-20, top=20, mid=H*0.52, bottom=H-20;
  const gxW=(right-left)/Math.max(1,groups.length-1);

  // –í–µ—Ä—Ö–Ω—ñ–π ‚Äî XÃÑ
  const minX = Math.min(LCLx, LSL, ...xbars);
  const maxX = Math.max(UCLx, USL, ...xbars);
  ctx.fillStyle='#94a3b8'; ctx.font='12px ui-monospace';
  ctx.fillText('XÃÑ (–≥)', 8, top+12);

  // –æ—Å—ñ
  ctx.strokeStyle='#223049';
  ctx.beginPath(); ctx.moveTo(left, top); ctx.lineTo(left, mid-10); ctx.lineTo(right, mid-10); ctx.stroke();

  // –º–µ–∂—ñ –∫–µ—Ä–æ–≤–∞–Ω–æ—Å—Ç—ñ (–∂–æ–≤—Ç—ñ)
  const yX = val => (mid-10) - (val-minX)/(maxX-minX||1)*(mid-top-20);
  ctx.strokeStyle='#fbbf24'; ctx.setLineDash([6,6]);
  ctx.beginPath(); ctx.moveTo(left,yX(UCLx)); ctx.lineTo(right,yX(UCLx)); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(left,yX(LCLx)); ctx.lineTo(right,yX(LCLx)); ctx.stroke();
  ctx.setLineDash([]);
  // —Ü–µ–Ω—Ç—Ä
  ctx.strokeStyle='#64748b'; ctx.beginPath(); ctx.moveTo(left,yX(xbarbar)); ctx.lineTo(right,yX(xbarbar)); ctx.stroke();

  // —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (—Å—ñ—Ä—ñ)
  ctx.strokeStyle='#9ca3af'; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(left,yX(USL)); ctx.lineTo(right,yX(USL)); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(left,yX(LSL)); ctx.lineTo(right,yX(LSL)); ctx.stroke();
  ctx.setLineDash([]);

  // –ª—ñ–Ω—ñ—è XÃÑ
  ctx.beginPath(); ctx.strokeStyle='#38bdf8'; ctx.lineWidth=2;
  xbars.forEach((v,i)=>{ const x=left+i*gxW, y=yX(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // –ù–∏–∂–Ω—ñ–π ‚Äî R
  const minR = Math.min(LCLr, ...rs, 0);
  const maxR = Math.max(UCLr, ...rs);
  ctx.fillStyle='#94a3b8'; ctx.fillText('R (–≥)', 8, mid+16);

  ctx.strokeStyle='#223049';
  ctx.beginPath(); ctx.moveTo(left, mid+10); ctx.lineTo(left, bottom); ctx.lineTo(right, bottom); ctx.stroke();

  const yR = val => bottom - (val-minR)/(maxR-minR||1)*(bottom-(mid+20));

  // –º–µ–∂—ñ –∫–µ—Ä–æ–≤–∞–Ω–æ—Å—Ç—ñ
  ctx.strokeStyle='#fbbf24'; ctx.setLineDash([6,6]);
  ctx.beginPath(); ctx.moveTo(left,yR(UCLr)); ctx.lineTo(right,yR(UCLr)); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(left,yR(LCLr)); ctx.lineTo(right,yR(LCLr)); ctx.stroke();
  ctx.setLineDash([]);
  // —Ü–µ–Ω—Ç—Ä
  ctx.strokeStyle='#64748b'; ctx.beginPath(); ctx.moveTo(left,yR(rbar)); ctx.lineTo(right,yR(rbar)); ctx.stroke();

  // –ª—ñ–Ω—ñ—è R
  ctx.beginPath(); ctx.strokeStyle='#22c55e'; ctx.lineWidth=2;
  rs.forEach((v,i)=>{ const x=left+i*gxW, y=yR(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // –º–∞—Ä–∫–µ—Ä–∏ –≤–∏—Ö–æ–¥—É –∑–∞ –º–µ–∂—ñ
  ctx.fillStyle='#f87171';
  xbars.forEach((v,i)=>{ if(v>UCLx||v<LCLx){ const x=left+i*gxW, y=yX(v); ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); }});
  rs.forEach((v,i)=>{ if(v>UCLr||v<LCLr){ const x=left+i*gxW, y=yR(v); ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); }});
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç =====
$('#saveCsv').addEventListener('click', ()=>{
  if(!samples.length) return alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö');
  const n=parseInt($('#n').value,10);
  const LSL=parseFloat($('#lsl').value), USL=parseFloat($('#usl').value);
  let csv='idx,group,x(g),in_spec\n';
  samples.forEach((x,i)=>{
    const g=Math.floor(i/n)+1;
    csv += `${i+1},${g},${x.toFixed(3)},${(x>=LSL && x<=USL)?1:0}\n`;
  });
  csv += '\n# Xbar-R summary\n';
  csv += 'group,xbar(g),R(g)\n';
  groups.forEach((g,i)=>{ csv += `${i+1},${g.xbar.toFixed(3)},${g.r.toFixed(3)}\n`; });
  download('tech_para17_spc_'+stamp()+'.csv', csv, 'text/csv');
});

$('#saveTxt').addEventListener('click', ()=>{
  const n=parseInt($('#n').value,10);
  const LSL=parseFloat($('#lsl').value), USL=parseFloat($('#usl').value);
  const shrink=parseFloat($('#shrink').value)||0;
  const price=parseFloat($('#price').value)||0;
  const tgt=parseFloat($('#target').value)||200;
  const conf = samples.length? (samples.filter(x=>x>=LSL && x<=USL).length/samples.length*100) : 0;
  const xb = samples.length? mean(samples) : NaN;
  const rbar = groups.length? mean(groups.map(g=>g.r)) : NaN;
  const givePer = samples.length? (xb*(1-shrink/100) - tgt) : 0;
  const lossUAH = (givePer/1000) * price * samples.length;

  const nstr = [
    '–ü–∞—Ä–∞ 17 ‚Äî –î–æ–∑—É–≤–∞–Ω–Ω—è/—É—Å—É—à–∫–∞ + SPC XÃÑ‚ÄìR',
    `–õ–æ—Ç: ${$('#lot').value||'‚Äî'}`,
    `–¶—ñ–ª—å=${tgt} –≥; LSL=${LSL} –≥; USL=${USL} –≥; n=${n}`,
    `œÉ(–º–æ–¥–µ–ª—å)=${$('#sigma').value} –≥; –¥—Ä–µ–π—Ñ/100=${$('#drift').value} –≥`,
    `–í–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ: ${samples.length} –ø–æ—Ä—Ü—ñ–π; –ü—ñ–¥–≥—Ä—É–ø: ${groups.length}`,
    `XÃÑ=${isNaN(xb)?'‚Äî':xb.toFixed(3)} –≥; RÃÑ=${isNaN(rbar)?'‚Äî':rbar.toFixed(3)} –≥`,
    `–í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å: ${conf.toFixed(1)} %`,
    `–£—Å—É—à–∫–∞=${shrink.toFixed(1)} %; Giveaway=${givePer.toFixed(2)} –≥/–ø–æ—Ä—Ü—ñ—é`,
    `–í—Ç—Ä–∞—Ç–∏/–Ω–∞–¥–ª–∏—à–∫–∏: ${lossUAH.toFixed(2)} –≥—Ä–Ω`,
    '--- –ñ—É—Ä–Ω–∞–ª ---',
    ...($('#alog').textContent.startsWith('//')?[]:$('#alog').textContent.trim().split('\n'))
  ];
  download('tech_para17_summary_'+stamp()+'.txt', nstr.join('\n'));
});

$('#print58').addEventListener('click', ()=>{
  const LSL=parseFloat($('#lsl').value), USL=parseFloat($('#usl').value);
  const shrink=parseFloat($('#shrink').value)||0;
  const price=parseFloat($('#price').value)||0;
  const tgt=parseFloat($('#target').value)||200;
  const xb = samples.length? mean(samples) : NaN;
  const givePer = samples.length? (xb*(1-shrink/100) - tgt) : 0;
  const lossUAH = (givePer/1000) * price * samples.length;
  const conf = samples.length? (samples.filter(x=>x>=LSL && x<=USL).length/samples.length*100) : 0;

  const lines=[
    '=== –ß–ï–ö –î–û–ó–£–í–ê–ù–ù–Ø (58–º–º) ===',
    '–õ–æ—Ç: '+($('#lot').value||'‚Äî'),
    `–¶—ñ–ª—å ${tgt} –≥ | LSL ${LSL} –≥ | USL ${USL} –≥`,
    `–í–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ: ${samples.length}`,
    `–í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å: ${conf.toFixed(1)} %`,
    `XÃÑ=${isNaN(xb)?'‚Äî':xb.toFixed(2)} –≥ | shrink ${shrink.toFixed(1)} %`,
    `Giveaway: ${givePer.toFixed(2)} –≥/–ø–æ—Ä—Ü`,
    `–í—Ç—Ä–∞—Ç–∏/–Ω–∞–¥–ª–∏—à–∫–∏: ${lossUAH.toFixed(2)} –≥—Ä–Ω`,
    '-----------------------------'
  ];
  const rc=$('#rc'); rc.hidden=false; rc.textContent=lines.join('\n');
  download('tech_para17_receipt_'+stamp()+'.txt', lines.join('\n'));
});

// ===== –°—Ç–∞—Ä—Ç–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
resetAll();
</script>
</body>
</html>
