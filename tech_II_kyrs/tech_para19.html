<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 19 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –°–∞–Ω—ñ—Ç–∞—Ä—ñ—è/SSOP: –∫–∞–ª–µ–Ω–¥–∞—Ä, ATP/–∑–º–∏–≤–∏, —Ç—Ä–µ–Ω–¥–∏, —á–µ–∫/CSV/QR</title>
<meta name="description" content="–ü–ª–∞–Ω –º–∏–π–∫–∏/–¥–µ–∑—ñ–Ω—Ñ–µ–∫—Ü—ñ—ó (SSOP), –∂—É—Ä–Ω–∞–ª ATP (RLU), –∑–º–∏–≤–∏ (CFU/—Å–º¬≤), –∞–ª–µ—Ä–≥–µ–Ω–∏; –∂–∏–≤—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ —Ç—Ä–µ–Ω–¥—ñ–≤, –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —á–µ–∫ 58 –º–º, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, QR –Ω–∞ –ø–∞–ø–∫—É –∑ –¥–æ–∫–∞–∑–∞–º–∏."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1240px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
small.mono,.mono{font-family:ui-monospace,monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.35fr 1fr}
@media(max-width:1120px){.grid{grid-template-columns:1fr}}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:280px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{border:1px solid var(--line);border-radius:10px;padding:6px;min-height:74px}
.day .d{font-size:.9rem;color:#a5b4fc}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 6px;margin:2px;font-size:.75rem}
.pill.shift{border-color:#38bdf8}
.pill.daily{border-color:#22c55e}
.pill.weekly{border-color:#fbbf24}
.pill.over{border-color:#f87171;color:#f87171}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üßº</span>
      <div>
        <b>–ü–∞—Ä–∞ 19 ‚Äî –°–∞–Ω—ñ—Ç–∞—Ä—ñ—è/SSOP: –∫–∞–ª–µ–Ω–¥–∞—Ä, ATP/–∑–º–∏–≤–∏, —Ç—Ä–µ–Ω–¥–∏</b><br/>
        <span class="badge">–ø–ª–∞–Ω –º–∏–π–∫–∏/–¥–µ–∑—ñ–Ω—Ñ–µ–∫—Ü—ñ—ó ‚Üí –∂—É—Ä–Ω–∞–ª ATP/CFU/–∞–ª–µ—Ä–≥–µ–Ω–∏ ‚Üí –∂–∏–≤—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Üí —á–µ–∫/CSV/QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: —Å–ø–ª–∞–Ω—É–≤–∞—Ç–∏ <b>–º–∏–π–∫—É/–¥–µ–∑—ñ–Ω—Ñ–µ–∫—Ü—ñ—é</b> –∑–∞ <b>SSOP</b>, –≤–µ—Å—Ç–∏ <b>–∂—É—Ä–Ω–∞–ª —á–∏—Å—Ç–æ—Ç–∏</b> –∑ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è–º–∏ <b>ATP (RLU)</b>, <b>–∑–º–∏–≤—ñ–≤ (CFU/—Å–º¬≤)</b> —ñ <b>–∞–ª–µ—Ä–≥–µ–Ω–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤</b>, –≤—ñ–¥—Å–ª—ñ–¥–∫–æ–≤—É–≤–∞—Ç–∏ <b>—Ç—Ä–µ–Ω–¥–∏</b>, –≤–∏–¥–∞–≤–∞—Ç–∏ <b>–ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è</b> —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞—Ç–∏ <b>—á–µ–∫/CSV/TXT/QR</b>.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û: –ø–ª–∞–Ω/–∫–∞–ª–µ–Ω–¥–∞—Ä + –∂—É—Ä–Ω–∞–ª + –≥—Ä–∞—Ñ—ñ–∫–∏ -->
    <div class="card">
      <h2>üóìÔ∏è –ü–ª–∞–Ω-–∫–∞–ª–µ–Ω–¥–∞—Ä SSOP</h2>
      <div class="row">
        <select id="area" class="input" style="max-width:220px">
          <option value="milk" selected>–¶–µ—Ö –ø–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—ó</option>
          <option value="cut">–ö–æ–ø—Ç–∏–ª—å–Ω–µ/–Ω–∞—Ä—ñ–∑–∫–∞</option>
          <option value="pack">–ü–∞–∫—É–≤–∞–Ω–Ω—è (MAP)</option>
          <option value="brine">–†–æ–∑—Å—ñ–ª—å–Ω–µ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</option>
          <option value="egg">–Ø—î—á–Ω–∏–π –≤—ñ–¥–¥—ñ–ª</option>
        </select>
        <label>–ó–º—ñ–Ω–∏/–¥–æ–±—É<input id="shifts" class="input" type="number" min="1" max="4" value="2"/></label>
        <label>ATP –ø–æ—Ä—ñ–≥ (RLU)<input id="rluThr" class="input" type="number" min="10" step="10" value="150"/></label>
        <label>CFU –ø–æ—Ä—ñ–≥ (–Ω–∞–ø—Ä., 10/—Å–º¬≤)<input id="cfuThr" class="input" type="number" min="1" step="1" value="10"/></label>
        <label>–ê–ª–µ—Ä–≥–µ–Ω (–ø–æ—Ä–æ–≥., ppm)<input id="algThr" class="input" type="number" min="1" step="1" value="2"/></label>
        <button class="btn good" id="mkPlan">‚öôÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–ª–∞–Ω</button>
      </div>

      <div id="cal" class="cal" style="margin-top:8px"></div>
      <small class="muted">–ö–æ–ª—å–æ—Ä–∏: <span class="pill shift">—â–æ–∑–º—ñ–Ω–∏</span> <span class="pill daily">—â–æ–¥–Ω—è</span> <span class="pill weekly">—â–æ—Ç–∏–∂–Ω—è</span>. –ß–µ—Ä–≤–æ–Ω–∞ —Ä–∞–º–∫–∞ ‚Äî <span class="pill over">–ø—Ä–æ—Ç–µ—Ä–º.</span></small>

      <h3 style="margin-top:12px">üìù –ñ—É—Ä–Ω–∞–ª —á–∏—Å—Ç–æ—Ç–∏ (ATP/–∑–º–∏–≤–∏/–∞–ª–µ—Ä–≥–µ–Ω–∏)</h3>
      <div class="row">
        <select id="station" class="input" style="max-width:220px">
          <option>–ù—ñ–∂/—Å—Ç—ñ–ª</option><option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ—Ä</option><option>–§–∞—Å—É–≤–∞–ª—å–Ω–∏–∫</option><option>–ü–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä</option><option>–®–ø—Ä–∏—Ü/—à–ø—Ä–∏—Ü-–Ω–∞—Å–∞–¥–∫–∞</option>
        </select>
        <label>ATP, RLU<input id="rlu" class="input" type="number" step="1" value="120"/></label>
        <label>–ó–º–∏–≤, CFU/—Å–º¬≤<input id="cfu" class="input" type="number" step="1" value="6"/></label>
        <label>–ê–ª–µ—Ä–≥–µ–Ω, ppm<input id="alg" class="input" type="number" step="1" value="0"/></label>
      </div>
      <div class="row">
        <input id="operator" class="input" placeholder="–û–ø–µ—Ä–∞—Ç–æ—Ä/–∑–º—ñ–Ω–∞ (–ü–Ü–ë)"/>
        <input id="lot" class="input" placeholder="–õ–æ—Ç/–ø–∞—Ä—Ç—ñ—è (–Ω–µ–æ–±–æ–≤.)"/>
        <button class="btn" id="addRec">‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>
        <button class="btn secondary" id="clearRec">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –∂—É—Ä–Ω–∞–ª</button>
        <span id="kpi" class="badge">PASS: ‚Äî % | –í—Å—å–æ–≥–æ: 0</span>
      </div>
      <pre id="alog" class="note" style="max-height:160px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:12px">üìà –ñ–∏–≤—ñ –≥—Ä–∞—Ñ—ñ–∫–∏</h3>
      <div class="canvasWrap"><canvas id="chart" width="980" height="280"></canvas></div>
      <small class="muted">–°–∏–Ω—è ‚Äî ATP (RLU), –∑–µ–ª–µ–Ω–∞ ‚Äî %PASS (–∫–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ 10), —á–µ—Ä–≤–æ–Ω—ñ —Ç–æ—á–∫–∏ ‚Äî –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø–æ—Ä–æ–≥—ñ–≤.</small>

      <h3 style="margin-top:12px">üíæ –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫</h3>
      <div class="row">
        <button class="btn" id="saveCsv">üìÑ CSV –∂—É—Ä–Ω–∞–ª</button>
        <button class="btn" id="saveTxt">üíæ TXT –ø—ñ–¥—Å—É–º–æ–∫</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–∞–ø–∫–∞ –∑ –∞–∫—Ç–∞–º–∏/—Ñ–æ—Ç–æ)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>
      <small class="muted">QR –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ <span class="mono">api.qrserver.com</span>; –æ—Ñ–ª–∞–π–Ω-—Ñ–æ–ª–±–µ–∫ ‚Äî —Ç–µ–∫—Å—Ç.</small>
    </div>

    <!-- –ü–†–ê–í–û: KPI + —Å—Ö–µ–º–∞ + –∑–∞–≤–¥–∞–Ω–Ω—è -->
    <div class="card">
      <h2>üìä –ü–æ–∫–∞–∑–Ω–∏–∫–∏</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–õ–æ–∫–∞—Ü—ñ—è</th><td id="m_area">‚Äî</td></tr>
          <tr><th>–ü–ª–∞–Ω–æ–≤–∏—Ö —Ç–æ—á–æ–∫/–ºi—Å—è—Ü—å</th><td id="m_plan">‚Äî</td></tr>
          <tr><th>–í–∏–∫–æ–Ω–∞–Ω–æ / –ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–æ</th><td id="m_done">‚Äî</td></tr>
          <tr><th>ATP –ø–æ—Ä—ñ–≥</th><td id="m_rlu">‚Äî</td></tr>
          <tr><th>CFU –ø–æ—Ä—ñ–≥</th><td id="m_cfu">‚Äî</td></tr>
          <tr><th>–ê–ª–µ—Ä–≥–µ–Ω –ø–æ—Ä—ñ–≥</th><td id="m_alg">‚Äî</td></tr>
          <tr><th>PASS, % (—É—Å—å–æ–≥–æ)</th><td id="m_pass">‚Äî</td></tr>
          <tr><th>–û—Å—Ç–∞–Ω–Ω—è —Ç—Ä–∏–≤–æ–≥–∞</th><td id="m_alarm">‚Äî</td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">üîå –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—É (SVG)</h2>
      <svg viewBox="0 0 820 280" role="img" aria-label="–ú–∏–π–∫–∞/–î–µ–∑ ‚Üí –Ü–Ω—Å–ø–µ–∫—Ü—ñ—è ATP/–ó–º–∏–≤–∏ ‚Üí –ñ—É—Ä–Ω–∞–ª ‚Üí –ê–Ω–∞–ª—ñ–∑ ‚Üí –î—ñ—ó">
        <rect x="40" y="40" width="160" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="120" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–ú–∏–π–∫–∞ / –î–µ–∑</text>
        <text x="120" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">SSOP</text>

        <rect x="220" y="40" width="170" height="120" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="305" y="80" fill="#dcfce7" font-size="14" text-anchor="middle">ATP / –ó–º–∏–≤–∏</text>
        <text x="305" y="100" fill="#a7f3d0" font-size="12" text-anchor="middle">RLU / CFU / –∞–ª–µ—Ä–≥–µ–Ω–∏</text>

        <rect x="410" y="40" width="160" height="120" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="490" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–ñ—É—Ä–Ω–∞–ª</text>
        <text x="490" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">CSV/TXT/—á–µ–∫</text>

        <rect x="590" y="40" width="170" height="120" rx="12" fill="#0b1a2f" stroke="#64748b"/>
        <text x="675" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–ê–Ω–∞–ª—ñ–∑/–î—ñ—ó</text>
        <text x="675" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">—Ç—Ä–µ–Ω–¥–∏/–∞–ª–∞—Ä–º–∏</text>

        <line x1="200" y1="100" x2="220" y2="100" stroke="#93c5fd" stroke-width="3"/>
        <line x1="390" y1="100" x2="410" y2="100" stroke="#22c55e" stroke-width="3"/>
        <line x1="570" y1="100" x2="590" y2="100" stroke="#64748b" stroke-width="3"/>
      </svg>

      <h2 style="margin-top:10px">üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
      <ol>
        <li>–ó–≥–µ–Ω–µ—Ä—É–π –ø–ª–∞–Ω –¥–ª—è ¬´–¶–µ—Ö –ø–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—ó¬ª: <span class="mono">ATP‚â§150 RLU</span>, <span class="mono">CFU‚â§10/—Å–º¬≤</span>, <span class="mono">–∞–ª–µ—Ä–≥–µ–Ω‚â§2 ppm</span>. –ó–∞–ø–æ–≤–Ω–∏ ‚â• 12 –∑–∞–ø–∏—Å—ñ–≤, –µ–∫—Å–ø–æ—Ä—Ç—É–π <b>CSV</b>.</li>
        <li>–î–æ—Å—è–≥–Ω–∏ ‚â§ 2 —Ç—Ä–∏–≤–æ–≥ —É –∫–æ–≤–∑–Ω–æ–º—É –≤—ñ–∫–Ω—ñ 10 –≤–∏–º—ñ—Ä—ñ–≤, –∑—Ä–æ–±–∏ —Å–∫—Ä—ñ–Ω –≥—Ä–∞—Ñ—ñ–∫–∞, –ø—ñ–¥—Å—É–º—É–π —É <b>TXT</b>.</li>
        <li>–ó–≥–µ–Ω–µ—Ä—É–π <b>QR</b> –Ω–∞ –ø–∞–ø–∫—É –∑ —Ñ–æ—Ç–æ –¥–æ/–ø—ñ—Å–ª—è –º–∏–π–∫–∏, —Ä–æ–∑–¥—Ä—É–∫—É–π <b>—á–µ–∫ 58 –º–º</b> –¥–ª—è –∑–º—ñ–Ω–∏.</li>
      </ol>
    </div>
  </div>

  <div class="card">
    <h2>üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
    <p class="muted small">HACCP –Ω–∞—Ä–æ–¥–∏–≤—Å—è –≤ –∞–µ—Ä–æ–∫–æ—Å–º—ñ—á–Ω—ñ–π –ø—Ä–æ–≥—Ä–∞–º—ñ –°–®–ê (1960-—Ç—ñ). –°—å–æ–≥–æ–¥–Ω—ñ <b>SSOP</b> —ñ —à–≤–∏–¥–∫—ñ —Ç–µ—Å—Ç–∏ –Ω–∞ –∫—à—Ç–∞–ª—Ç <b>ATP</b> ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–Ω—Ç—Ä–æ–ª—é —á–∏—Å—Ç–æ—Ç–∏. –ù–∞—à —Å–∏–º—É–ª—è—Ç–æ—Ä –≤—ñ–¥—Ç–≤–æ—Ä—é—î –ª–æ–≥—ñ–∫—É –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É/–≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–æ—Å—Ç–æ —É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

// ===== –ü–ª–∞–Ω-–∫–∞–ª–µ–Ω–¥–∞—Ä =====
const cal=$('#cal');
let PLAN=[]; // {dateISO, type:'shift'|'daily'|'weekly', area, done:boolean}

function monthGrid(date=new Date()){
  const y=date.getFullYear(), m=date.getMonth();
  const first=new Date(y,m,1);
  const start=new Date(y,m,1-first.getDay()+1); // –ø–æ—á–∞—Ç–æ–∫ –∑ –ø–æ–Ω–µ–¥—ñ–ª–∫–∞
  const days=[];
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    days.push(d);
  }
  return days;
}

function renderCal(){
  cal.innerHTML='';
  const days=monthGrid(new Date());
  const todayISO=new Date().toISOString().slice(0,10);
  days.forEach(d=>{
    const iso=d.toISOString().slice(0,10);
    const box=document.createElement('div');
    box.className='day';
    if(iso===todayISO) box.style.borderColor='#38bdf8';
    const h=document.createElement('div'); h.className='d'; h.textContent=iso.slice(8,10)+'.'+iso.slice(5,7);
    box.appendChild(h);
    const items=PLAN.filter(p=>p.dateISO===iso);
    items.forEach(p=>{
      const span=document.createElement('span');
      span.className='pill '+p.type+(p.overdue?' over':'');
      span.textContent=(p.done?'‚úÖ ':'‚óªÔ∏è ')+p.area;
      span.title = p.type+' | '+(p.done?'Done':'Due');
      span.style.cursor='pointer';
      span.addEventListener('click',()=>{ p.done=!p.done; updateKPIs(); renderCal(); });
      box.appendChild(span);
    });
    cal.appendChild(box);
  });
}

function genPlan(){
  const area=$('#area').value;
  const shifts=+$('#shifts').value||2;
  const base=new Date(); base.setDate(1);
  PLAN.length=0;
  const days=monthGrid(base);
  for(const d of days){
    const iso=d.toISOString().slice(0,10);
    // —â–æ–∑–º—ñ–Ω–∏
    for(let s=0;s<shifts;s++) PLAN.push({dateISO:iso,type:'shift',area,done:false});
    // —â–æ–¥–µ–Ω–Ω–µ
    PLAN.push({dateISO:iso,type:'daily',area,done:false});
    // —â–æ—Ç–∏–∂–Ω–µ–≤–µ ‚Äî –Ω–µ–¥—ñ–ª—è
    if(d.getDay()===0) PLAN.push({dateISO:iso,type:'weekly',area,done:false});
  }
  markOverdue();
  updateKPIs(); renderCal();
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –ø–ª–∞–Ω SSOP –¥–ª—è: '+area);
}

function markOverdue(){
  const todayISO=new Date().toISOString().slice(0,10);
  PLAN.forEach(p=>{ p.overdue = (p.dateISO<todayISO && !p.done); });
}

// ===== –ñ—É—Ä–Ω–∞–ª –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å =====
let LOG=[]; // {ts, area, station, rlu, cfu, alg, pass, operator, lot}

function addRecord(){
  const area=$('#area').value;
  const station=$('#station').value;
  const rlu=+$('#rlu').value;
  const cfu=+$('#cfu').value;
  const alg=+$('#alg').value;
  const op=($('#operator').value||'').trim()||'–û–ø–µ—Ä–∞—Ç–æ—Ä';
  const lot=($('#lot').value||'').trim();

  const thrR=+$('#rluThr').value, thrC=+$('#cfuThr').value, thrA=+$('#algThr').value;
  const pass = (rlu<=thrR && cfu<=thrC && alg<=thrA);

  LOG.push({ts:Date.now(), area, station, rlu, cfu, alg, pass, operator:op, lot});
  if(!pass){
    const msg=`–ê–õ–ê–†–ú: ${station} | RLU=${rlu} (‚â§${thrR}), CFU=${cfu} (‚â§${thrC}), ALG=${alg} (‚â§${thrA})`;
    log(msg); $('#m_alarm').innerHTML=`<b class="bad">${msg}</b>`;
    // –∞–≤—Ç–æ-–ø–æ–∑–Ω–∞—á–∫–∞ –Ω–∞–π–±–ª–∏–∂—á–æ–≥–æ due —è–∫ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π
    markOverdue(); renderCal();
  }else{
    log(`PASS: ${station} | RLU=${rlu}, CFU=${cfu}, ALG=${alg}`);
  }
  updateKPIs(); drawCharts();
}

function clearLog(){
  LOG.length=0; updateKPIs(); drawCharts(); $('#alog').textContent='// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π'; $('#m_alarm').textContent='‚Äî';
}

// ===== KPI + –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤–æ—ó –ø–∞–Ω–µ–ª—ñ =====
function updateKPIs(){
  const area=$('#area').value;
  $('#m_area').textContent=area;
  $('#m_rlu').textContent=$('#rluThr').value+' RLU';
  $('#m_cfu').textContent=$('#cfuThr').value+' /—Å–º¬≤';
  $('#m_alg').textContent=$('#algThr').value+' ppm';

  const total=PLAN.length;
  const done=PLAN.filter(p=>p.done).length;
  const overdue=PLAN.filter(p=>p.overdue).length;
  $('#m_plan').textContent=total;
  $('#m_done').innerHTML=`<b class="${overdue?'bad':''}">${done} / ${overdue} –ø—Ä–æ—Å—Ç—Ä.</b>`;

  const passPct = LOG.length? (LOG.filter(r=>r.pass).length/LOG.length*100):0;
  $('#m_pass').textContent=passPct.toFixed(1)+' %';

  $('#kpi').textContent=`PASS: ${passPct.toFixed(1)} % | –í—Å—å–æ–≥–æ: ${LOG.length}`;
}

// ===== –ì—Ä–∞—Ñ—ñ–∫–∏ =====
const chart=$('#chart'), ctx=chart.getContext('2d');

function drawCharts(){
  const W=chart.width,H=chart.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  if(!LOG.length){ ctx.fillStyle='#94a3b8'; ctx.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö',14,20); return; }

  const left=50, right=W-12, top=20, mid=H*0.56, bottom=H-20;
  const xs=LOG.map((_,i)=>i);
  const gx=(right-left)/Math.max(1,LOG.length-1);

  // –í–µ—Ä—Ö: ATP (RLU)
  const rlus=LOG.map(r=>r.rlu);
  const rMax=Math.max(...rlus, +$('#rluThr').value*1.2, 200);
  const yR=v=> (mid-10) - (v/rMax)*(mid-top-20);
  ctx.fillStyle='#94a3b8'; ctx.font='12px ui-monospace'; ctx.fillText('ATP, RLU', 8, top+12);
  ctx.beginPath(); ctx.strokeStyle='#38bdf8'; ctx.lineWidth=2;
  rlus.forEach((v,i)=>{ const x=left+i*gx, y=yR(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.stroke();
  // –ø–æ—Ä—ñ–≥
  const thrR=+$('#rluThr').value;
  ctx.strokeStyle='#fbbf24'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(left,yR(thrR)); ctx.lineTo(right,yR(thrR)); ctx.stroke(); ctx.setLineDash([]);

  // –ú–∞—Ä–∫–µ—Ä–∏ –∞–≤–∞—Ä—ñ–π (—á–µ—Ä–≤–æ–Ω—ñ —Ç–æ—á–∫–∏)
  ctx.fillStyle='#f87171';
  LOG.forEach((r,i)=>{ if(r.rlu>thrR||!r.pass){ const x=left+i*gx, y=yR(r.rlu); ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); }});

  // –ù–∏–∑: %PASS (–∫–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ 10)
  const windowN=10, pct=[];
  for(let i=1;i<=LOG.length;i++){
    const win=LOG.slice(Math.max(0,i-windowN), i);
    pct.push(win.filter(r=>r.pass).length/win.length*100);
  }
  const yP=v=> bottom - (v/100)*(bottom-(mid+24));
  ctx.fillStyle='#94a3b8'; ctx.fillText('%PASS (–∫–æ–≤–∑–Ω–µ N=10)', 8, mid+16);
  ctx.beginPath(); ctx.strokeStyle='#22c55e'; ctx.lineWidth=2;
  pct.forEach((v,i)=>{ const x=left+i*gx, y=yP(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.stroke();
  // 100/80/60 –ª—ñ–Ω—ñ—ó
  ctx.strokeStyle='#64748b'; [100,80,60].forEach(val=>{ ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(left,yP(val)); ctx.lineTo(right,yP(val)); ctx.stroke(); ctx.setLineDash([]); });
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫ =====
function saveCSV(){
  if(!LOG.length) return alert('–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤');
  let csv='ts_iso,area,station,RLU,CFU,ALG_ppm,PASS,operator,lot\n';
  LOG.forEach(r=>{
    csv+=`${new Date(r.ts).toISOString()},${r.area},${r.station},${r.rlu},${r.cfu},${r.alg},${r.pass?1:0},${r.operator||''},${(r.lot||'').replace(/"/g,'""')}\n`;
  });
  download('tech_para19_ssop_'+stamp()+'.csv', csv, 'text/csv');
}
function saveTXT(){
  const passPct=LOG.length? (LOG.filter(r=>r.pass).length/LOG.length*100):0;
  const overdue=PLAN.filter(p=>p.overdue).length;
  const done=PLAN.filter(p=>p.done).length;
  const txt=[
    '–ü–∞—Ä–∞ 19 ‚Äî –°–∞–Ω—ñ—Ç–∞—Ä—ñ—è/SSOP: –ø—ñ–¥—Å—É–º–æ–∫',
    `–õ–æ–∫–∞—Ü—ñ—è: ${$('#area').value}`,
    `–ü–ª–∞–Ω–æ–≤–∏—Ö —Ç–æ—á–æ–∫/–º—ñ—Å: ${PLAN.length}; –í–∏–∫–æ–Ω–∞–Ω–æ: ${done}; –ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–æ: ${overdue}`,
    `–ü–æ—Ä–æ–≥–∏: ATP‚â§${$('#rluThr').value} RLU; CFU‚â§${$('#cfuThr').value}/—Å–º¬≤; –ê–ª–µ—Ä–≥–µ–Ω‚â§${$('#algThr').value} ppm`,
    `–ó–∞–ø–∏—Å—ñ–≤ —É –∂—É—Ä–Ω–∞–ª—ñ: ${LOG.length}; PASS: ${passPct.toFixed(1)} %`,
    '--- –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π ---',
    ...($('#alog').textContent.startsWith('//')?[]:$('#alog').textContent.trim().split('\n'))
  ].join('\n');
  download('tech_para19_summary_'+stamp()+'.txt', txt);
}
function print58(){
  const passPct=LOG.length? (LOG.filter(r=>r.pass).length/LOG.length*100):0;
  const overdue=PLAN.filter(p=>p.overdue).length;
  const done=PLAN.filter(p=>p.done).length;
  const lines=[
    '=== –ß–ï–ö SSOP (58–º–º) ===',
    '–õ–æ–∫–∞—Ü—ñ—è: '+$('#area').value,
    `ATP‚â§${$('#rluThr').value} | CFU‚â§${$('#cfuThr').value} | ALG‚â§${$('#algThr').value}`,
    `–ü–ª–∞–Ω: ${PLAN.length} | Done: ${done} | Over: ${overdue}`,
    `PASS: ${passPct.toFixed(1)} % | –ó–∞–ø–∏—Å—ñ–≤: ${LOG.length}`,
    '-----------------------------'
  ];
  const rc=$('#rc'); rc.hidden=false; rc.textContent=lines.join('\n');
  download('tech_para19_receipt_'+stamp()+'.txt', rc.textContent);
}

// ===== QR =====
$('#qrGen').addEventListener('click', ()=>{
  const data = prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –∞–∫—Ç–∞–º–∏/—Ñ–æ—Ç–æ):', $('#lot').value || 'ssop-evidence');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url;
});

// ===== –ü–æ–¥—ñ—ó UI =====
$('#mkPlan').addEventListener('click', ()=>{ genPlan(); });
$('#addRec').addEventListener('click', addRecord);
$('#clearRec').addEventListener('click', clearLog);
$('#saveCsv').addEventListener('click', saveCSV);
$('#saveTxt').addEventListener('click', saveTXT);
$('#print58').addEventListener('click', print58);

// ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
genPlan(); drawCharts(); updateKPIs(); renderCal();
</script>
</body>
</html>
