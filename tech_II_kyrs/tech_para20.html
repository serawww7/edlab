<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 20 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –•–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥: —ñ–º–ø–æ—Ä—Ç —Ç–µ—Ä–º–æ–ª–æ–≥—ñ–≤, —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏, MKT, —á–µ–∫/CSV/QR</title>
<meta name="description" content="–Ü–º–ø–æ—Ä—Ç CSV –∑ —Ç–µ—Ä–º–æ–ª–æ–≥–µ—Ä—ñ–≤, –∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏, –≤–∏—è–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ (–≤–∏—Ö—ñ–¥ –∑–∞ –¥–æ–ø—É—Å–∫, –≤—ñ–¥–∫—Ä–∏–≤–∞–Ω–Ω—è –¥–≤–µ—Ä–µ–π), —á–∞—Å –ø–æ–∑–∞ –∑–æ–Ω–æ—é, MKT, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT, —á–µ–∫ 58 –º–º, QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1240px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
small.mono,.mono{font-family:ui-monospace,monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.35fr 1fr}
@media(max-width:1120px){.grid{grid-template-columns:1fr}}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:300px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:var(--muted);margin-right:6px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">‚ùÑÔ∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 20 ‚Äî –•–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥</b><br/>
        <span class="badge">—ñ–º–ø–æ—Ä—Ç CSV ‚Üí –≥—Ä–∞—Ñ—ñ–∫ T(t) ‚Üí —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏ (T-–≤—ñ–∫–Ω–∞/–¥–≤–µ—Ä—ñ) ‚Üí —á–∞—Å –ø–æ–∑–∞ –∑–æ–Ω–æ—é ‚Üí MKT ‚Üí —á–µ–∫/QR/CSV</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –æ—Ü—ñ–Ω–∏—Ç–∏ **—Ö–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥** –ø–æ—Å—Ç–∞–≤–∫–∏/—Å–∫–ª–∞–¥—É. –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ç–µ—Ä–º–æ–ª–æ–≥ (**CSV**), –ø–æ–±—É–¥—É–≤–∞—Ç–∏ **–∂–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫**, –≤–∏—è–≤–∏—Ç–∏ **—ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏** (–ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è/–ø–µ—Ä–µ–æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—é —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—é, ¬´–≤—ñ–¥–∫—Ä–∏–≤–∞–Ω–Ω—è –¥–≤–µ—Ä–µ–π¬ª –∑–∞ <span class="mono">dT/dt</span>), –ø—ñ–¥—Ä–∞—Ö—É–≤–∞—Ç–∏ **MKT**, –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ **—á–µ–∫ 58 –º–º/QR/CSV/TXT**.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û -->
    <div class="card">
      <h2>üì• –Ü–º–ø–æ—Ä—Ç/–µ–º—É–ª—è—Ü—ñ—è –¥–∞–Ω–∏—Ö</h2>
      <div class="row">
        <input id="file" class="input" type="file" accept=".csv"/>
        <button class="btn" id="load">üìÑ –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ CSV</button>
        <button class="btn secondary" id="demo">üé≤ –î–µ–º–æ-—Ç—Ä–∞—Å–∞</button>
        <span id="status" class="badge">–°—Ç–∞—Ç—É—Å: —á–µ–∫–∞—é CSV</span>
      </div>
      <small class="muted">–§–æ—Ä–º–∞—Ç–∏: <span class="mono">iso8601,TempC</span> –∞–±–æ <span class="mono">t_sec,TempC</span>. –î–µ—Å—è—Ç–∫–æ–≤–∞ –∫—Ä–∞–ø–∫–∞, —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ ‚Äî –∫–æ–º–∞/–∫—Ä–∞–ø–∫–∞ –∑ –∫–æ–º–æ—é/—Ç–∞–±.</small>

      <h3 style="margin-top:10px">üß∞ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é</h3>
      <div class="row">
        <select id="product" class="input" style="max-width:260px">
          <option value="dairy" selected>–ú–æ–ª–æ—á–Ω—ñ (0‚Ä¶+4 ¬∞C)</option>
          <option value="meat">–ú‚Äô—è—Å–æ (0‚Ä¶+2 ¬∞C)</option>
          <option value="egg">–Ø–π—Ü—è (+2‚Ä¶+8 ¬∞C)</option>
          <option value="cheese">–°–∏—Ä–∏ –¥–æ–∑—Ä—ñ–≤–∞–Ω–Ω—è (+2‚Ä¶+6 ¬∞C)</option>
          <option value="custom">–ö–∞—Å—Ç–æ–º</option>
        </select>
        <label>Tmin ¬∞C<input id="tmin" class="input" type="number" step="0.1" value="0"/></label>
        <label>Tmax ¬∞C<input id="tmax" class="input" type="number" step="0.1" value="4"/></label>
        <label>–ú—ñ–Ω. —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—É, —Ö–≤<input id="minDur" class="input" type="number" step="1" value="5"/></label>
      </div>
      <div class="row">
        <label>–ü–æ—Ä—ñ–≥ ¬´–¥–≤–µ—Ä–µ–π¬ª, ¬∞C/—Ö–≤ (|dT/dt|) <input id="doorThr" class="input" type="number" step="0.1" value="1.5"/></label>
        <label>MKT: Ea, –∫–î–∂/–º–æ–ª—å<input id="ea" class="input" type="number" step="1" value="83"/></label>
        <label>–Ü–Ω—Ç–µ—Ä–≤–∞–ª, —Å<input id="dt" class="input" type="number" step="1" value="60"/></label>
        <button class="btn" id="recalc">‚ôªÔ∏è –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
      </div>

      <h3 style="margin-top:10px">üìà –ñ–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ T(t)</h3>
      <div class="canvasWrap"><canvas id="chart" width="980" height="300"></canvas></div>
      <small class="muted">–°–∏–Ω—è ‚Äî T(t). –ñ–æ–≤—Ç–∞ –∑–æ–Ω–∞ ‚Äî –¥–æ–ø—É—Å–∫; —á–µ—Ä–≤–æ–Ω—ñ —Å–º—É–≥–∏ ‚Äî —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏; —á–µ—Ä–≤–æ–Ω—ñ —Ç–æ—á–∫–∏ ‚Äî ¬´–¥–≤–µ—Ä—ñ¬ª.</small>

      <h3 style="margin-top:10px">üõéÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</h3>
      <pre id="alog" class="note" style="max-height:180px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç/–¥—Ä—É–∫</h3>
      <div class="row">
        <input id="route" class="input" placeholder="–ú–∞—Ä—à—Ä—É—Ç/–ª–æ—Ç (–Ω–∞–ø—Ä. –†–¶‚Üí–°–∫–ª–∞–¥ #3, 2025-10-18)"/>
        <button class="btn" id="saveCsv">üìÑ CSV (—ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–ø—ñ–¥—Å—É–º–æ–∫)</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–æ–∫–∞–∑–∏)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>
      <small class="muted">QR –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ <span class="mono">api.qrserver.com</span>; –æ—Ñ–ª–∞–π–Ω ‚Äî –≤–∏–≤–µ–¥–µ—Ç—å—Å—è —Ç–µ–∫—Å—Ç.</small>
    </div>

    <!-- –ü–†–ê–í–û -->
    <div class="card">
      <h2>üìä –ü–æ–∫–∞–∑–Ω–∏–∫–∏</h2>
      <table class="tbl">
        <tbody>
          <tr><th>–ü—Ä–æ—Ñ—ñ–ª—å –ø—Ä–æ–¥—É–∫—Ç—É</th><td id="m_prof">–ú–æ–ª–æ—á–Ω—ñ (0‚Ä¶+4 ¬∞C)</td></tr>
          <tr><th>–ó–∞–ø–∏—Å—ñ–≤</th><td id="m_n">0</td></tr>
          <tr><th>–ß–∞—Å —É –∑–æ–Ω—ñ (–≥–æ–¥)</th><td id="m_in">0.00</td></tr>
          <tr><th>–ß–∞—Å –ø–æ–∑–∞ –∑–æ–Ω–æ—é (–≥–æ–¥)</th><td id="m_out">0.00</td></tr>
          <tr><th>–ö-—Å—Ç—å —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤</th><td id="m_inc">0</td></tr>
          <tr><th>–í—ñ–¥–∫—Ä–∏–≤–∞–Ω–Ω—è –¥–≤–µ—Ä–µ–π</th><td id="m_doors">0</td></tr>
          <tr><th>MKT, ¬∞C</th><td id="m_mkt">‚Äî</td></tr>
          <tr><th>–ú–∞–∫—Å/–ú—ñ–Ω T, ¬∞C</th><td id="m_ext">‚Äî</td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">üîå –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—É (SVG)</h2>
      <svg viewBox="0 0 820 280" role="img" aria-label="–¢–µ—Ä–º–æ–ª–æ–≥–µ—Ä ‚Üí –•–æ–ª–æ–¥–æ–≤–∞ –∫–∞–º–µ—Ä–∞/–∞–≤—Ç–æ ‚Üí –ê–Ω–∞–ª—ñ–∑ ‚Üí –ó–≤—ñ—Ç">
        <rect x="40" y="40" width="170" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="125" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–¢–µ—Ä–º–æ–ª–æ–≥–µ—Ä</text>
        <text x="125" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">CSV/USB</text>

        <rect x="230" y="40" width="170" height="120" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="315" y="80" fill="#dcfce7" font-size="14" text-anchor="middle">–•–æ–ª–æ–¥–æ–≤–∞ –∑–æ–Ω–∞</text>
        <text x="315" y="100" fill="#a7f3d0" font-size="12" text-anchor="middle">–∫–∞–º–µ—Ä–∞/—Ä–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä</text>

        <rect x="420" y="40" width="170" height="120" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="505" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–ê–Ω–∞–ª—ñ–∑</text>
        <text x="505" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">—ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏/MKT</text>

        <rect x="610" y="40" width="170" height="120" rx="12" fill="#0b1a2f" stroke="#64748b"/>
        <text x="695" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–ó–≤—ñ—Ç</text>
        <text x="695" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">—á–µ–∫/CSV/QR</text>

        <line x1="210" y1="100" x2="230" y2="100" stroke="#93c5fd" stroke-width="3"/>
        <line x1="400" y1="100" x2="420" y2="100" stroke="#22c55e" stroke-width="3"/>
        <line x1="590" y1="100" x2="610" y2="100" stroke="#64748b" stroke-width="3"/>
      </svg>

      <h2 style="margin-top:10px">üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
      <ol>
        <li>–Ü–º–ø–æ—Ä—Ç—É–π –ª–æ–≥ —ñ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏. –û—Ü—ñ–Ω–∏ **—á–∞—Å –ø–æ–∑–∞ –∑–æ–Ω–æ—é** —ñ **MKT**. –ó–±–µ—Ä–µ–∂–∏ <b>TXT</b>.</li>
        <li>–ù–∞–ª–∞—à—Ç—É–π ¬´–¥–≤–µ—Ä—ñ¬ª —Ç–∞–∫, —â–æ–± —Å–∏—Å—Ç–µ–º–∞ –≤–∏—è–≤–∏–ª–∞ ‚â• 3 –ø–æ–¥—ñ—ó. –ï–∫—Å–ø–æ—Ä—Ç—É–π <b>CSV —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤</b>.</li>
        <li>–ó—Ä–æ–±–∏ <b>QR</b> –Ω–∞ –ø–∞–ø–∫—É –∑ —Ñ–æ—Ç–æ –ø–ª–æ–º–± —Ç–∞ —Ç–µ—Ä–º–æ–ª–æ–≥–µ—Ä–∞, —Ä–æ–∑–¥—Ä—É–∫—É–π <b>—á–µ–∫ 58 –º–º</b> –¥–ª—è –ø—Ä–∏–π–º–∞–Ω–Ω—è.</li>
      </ol>

      <h2 style="margin-top:10px">üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
      <p class="muted small">–ü–µ—Ä—à—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –∑‚Äô—è–≤–∏–ª–∏—Å—è —â–µ –Ω–∞ –ø–∞–ø–µ—Ä–æ–≤–∏—Ö —Å—Ç—Ä—ñ—á–∫–∞—Ö. –°—å–æ–≥–æ–¥–Ω—ñ –∞–Ω–∞–ª—ñ–∑ **–ª–æ–≥—ñ–≤** —ñ –º–µ—Ç—Ä–∏–∫ –Ω–∞ –∫—à—Ç–∞–ª—Ç **MKT** ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è —Ö–æ–ª–æ–¥–æ–≤–æ–≥–æ –ª–∞–Ω—Ü—é–≥–∞ –≤ –º–æ–ª–æ—Ü—ñ/–º‚Äô—è—Å—ñ/—Ä–∏–±—ñ/–≤–∞–∫—Ü–∏–Ω–∞—Ö.</p>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function parseCSV(text){
  // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫—ñ–≤: , ; \t
  const sep = text.includes('\t')?'\t':(text.split('\n')[0].includes(';')?';':',');
  const rows = text.trim().split(/\r?\n/).map(r=>r.split(sep));
  // –í–∏—è–≤–∏–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const head = rows[0].map(s=>s.trim().toLowerCase());
  let tIdx=head.findIndex(h=>/(^t$|t_sec|time|timestamp|iso)/.test(h));
  let cIdx=head.findIndex(h=>/(temp|t_c|tempc)/.test(h));
  let start=1;
  if(tIdx<0||cIdx<0){ // –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    tIdx=0; cIdx=1; start=0;
  }
  const out=[];
  for(let i=start;i<rows.length;i++){
    const a=rows[i]; if(a.length<2) continue;
    const tt=a[tIdx].trim(); const tc=parseFloat((a[cIdx]||'').toString().replace(',', '.'));
    if(!isFinite(tc)) continue;
    let ts;
    if(/^\d+(\.\d+)?$/.test(tt)){ ts=+tt*1000; } // t_sec
    else { const d=new Date(tt); if(isNaN(d)) continue; ts=d.getTime(); }
    out.push({ts, T:tc});
  }
  out.sort((a,b)=>a.ts-b.ts);
  return out;
}

// ===== –°—Ç–∞–Ω–∏ =====
let SERIES=[];          // {ts, T}
let INCIDENTS=[];       // {type:'high'|'low'|'door', t0, t1, dur_s, Tmax, Tmin}
let DOORS=0;

// ===== –ü—Ä–æ—Ñ—ñ–ª—ñ =====
const PROFILES={
  dairy:{name:'–ú–æ–ª–æ—á–Ω—ñ (0‚Ä¶+4 ¬∞C)', tmin:0, tmax:4},
  meat:{name:'–ú‚Äô—è—Å–æ (0‚Ä¶+2 ¬∞C)', tmin:0, tmax:2},
  egg:{name:'–Ø–π—Ü—è (+2‚Ä¶+8 ¬∞C)', tmin:2, tmax:8},
  cheese:{name:'–°–∏—Ä–∏ (+2‚Ä¶+6 ¬∞C)', tmin:2, tmax:6},
  custom:{name:'–ö–∞—Å—Ç–æ–º', tmin:0, tmax:4}
};
function applyProfile(){
  const p=$('#product').value;
  const s=PROFILES[p];
  $('#m_prof').textContent=s.name;
  if(p!=='custom'){ $('#tmin').value=s.tmin; $('#tmax').value=s.tmax; }
}
$('#product').addEventListener('change', applyProfile);
applyProfile();

// ===== –ú–∞–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞ =====
const cvs=$('#chart'), ctx=cvs.getContext('2d');
function draw(){
  const W=cvs.width,H=cvs.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);
  if(SERIES.length<2){ ctx.fillStyle='#94a3b8'; ctx.fillText('–Ü–º–ø–æ—Ä—Ç—É–π CSV –∞–±–æ –∑–≥–µ–Ω–µ—Ä—É–π –¥–µ–º–æ', 14,20); return; }

  const Tmin = Math.min(...SERIES.map(p=>p.T), parseFloat($('#tmin').value)-2);
  const Tmax = Math.max(...SERIES.map(p=>p.T), parseFloat($('#tmax').value)+2);
  const t0 = SERIES[0].ts, t1 = SERIES[SERIES.length-1].ts;
  const left=50, right=W-10, top=20, bottom=H-20;
  const xOf = ts => left + ( (ts - t0) / (t1 - t0 || 1) ) * (right-left);
  const yOf = T  => bottom - ( (T - Tmin) / (Tmax - Tmin || 1) ) * (bottom-top);

  // –ó–æ–Ω–∞ –¥–æ–ø—É—Å–∫—É (–∂–æ–≤—Ç–∏–º)
  const zMin = parseFloat($('#tmin').value), zMax=parseFloat($('#tmax').value);
  ctx.fillStyle='rgba(251,191,36,0.12)';
  ctx.fillRect(left, yOf(zMax), right-left, yOf(zMin)-yOf(zMax));

  // –ö—Ä–∏–≤–∞ T(t)
  ctx.beginPath(); ctx.strokeStyle='#38bdf8'; ctx.lineWidth=2;
  SERIES.forEach((p,i)=>{ const x=xOf(p.ts), y=yOf(p.T); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.stroke();

  // –Ü–Ω—Ü–∏–¥–µ–Ω—Ç–∏ (—á–µ—Ä–≤–æ–Ω—ñ —Å–º—É–≥–∏)
  ctx.fillStyle='rgba(248,113,113,0.18)';
  INCIDENTS.filter(e=>e.type!=='door').forEach(e=>{
    const xA=xOf(e.t0), xB=xOf(e.t1);
    ctx.fillRect(xA, top, xB-xA, bottom-top);
  });

  // –ü–æ–∑–Ω–∞—á–∫–∏ ¬´–¥–≤–µ—Ä–µ–π¬ª
  ctx.fillStyle='#f87171';
  INCIDENTS.filter(e=>e.type==='door').forEach(e=>{
    const x=xOf(e.t0), y=yOf(e.Tmax||SERIES[0].T);
    ctx.beginPath(); ctx.arc(x, y, 3.5, 0, Math.PI*2); ctx.fill();
  });

  // –û—Å—å/–ø—ñ–¥–ø–∏—Å–∏
  ctx.fillStyle='#94a3b8'; ctx.font='12px ui-monospace';
  ctx.fillText('T, ¬∞C', 8, 14);
  ctx.fillText(new Date(t0).toLocaleString(), left, H-4);
  ctx.fillText(new Date(t1).toLocaleString(), right-160, H-4);
}

// ===== –û–±—á–∏—Å–ª–µ–Ω–Ω—è KPI, —ñ–Ω—Ü–∏–¥–µ–Ω—Ç–∏, MKT =====
function analyze(){
  INCIDENTS.length=0; DOORS=0;
  if(SERIES.length<2){ updateKPIs(); draw(); return; }

  const zMin=parseFloat($('#tmin').value), zMax=parseFloat($('#tmax').value);
  const minDurMin=parseFloat($('#minDur').value)||5;
  const doorThr=(parseFloat($('#doorThr').value)||1.5) / 60; // ¬∞C/—Å–µ–∫
  const dtDefault=parseFloat($('#dt').value)||60;

  // –í–∏—è–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ –ø–æ –∑–æ–Ω–∞–º
  let cur=null; // –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω—Ü–∏–¥–µ–Ω—Ç
  for(let i=1;i<SERIES.length;i++){
    const a=SERIES[i-1], b=SERIES[i];
    const dt=(b.ts-a.ts)/1000 || dtDefault;
    const inZone = (a.T>=zMin && a.T<=zMax);
    // –¥–≤–µ—Ä—ñ: |dT/dt|
    const dtdt=Math.abs((b.T-a.T)/dt);
    if(dtdt>doorThr){
      INCIDENTS.push({type:'door', t0:b.ts, t1:b.ts, dur_s:0, Tmax:b.T, Tmin:b.T});
      DOORS++;
      log(`Door event: |dT/dt|=${(dtdt*60).toFixed(2)} ¬∞C/—Ö–≤`);
    }
    // –≤–∏—Å–æ–∫–∏–π/–Ω–∏–∑—å–∫–∏–π
    const state = (a.T>zMax)?'high':(a.T<zMin?'low':'ok');
    if(state!=='ok'){
      if(!cur){ cur={type:state, t0:a.ts, t1:a.ts, dur_s:0, Tmax:a.T, Tmin:a.T}; }
      cur.t1=b.ts; cur.dur_s += dt; cur.Tmax=Math.max(cur.Tmax,b.T); cur.Tmin=Math.min(cur.Tmin,b.T);
    }else{
      if(cur){
        if(cur.dur_s >= minDurMin*60){ INCIDENTS.push(cur); log(`INC ${cur.type.toUpperCase()}: ${secs(cur.dur_s)}, Tmax=${cur.Tmax.toFixed(1)} ¬∞C, Tmin=${cur.Tmin.toFixed(1)} ¬∞C`); }
        cur=null;
      }
    }
  }
  if(cur && cur.dur_s >= minDurMin*60){ INCIDENTS.push(cur); log(`INC ${cur.type.toUpperCase()}: ${secs(cur.dur_s)}, Tmax=${cur.Tmax.toFixed(1)} ¬∞C, Tmin=${cur.Tmin.toFixed(1)} ¬∞C`); }

  // –ß–∞—Å –≤/–ø–æ–∑–∞ –∑–æ–Ω–æ—é
  let inS=0, outS=0, tmin=SERIES[0].ts, tmax=SERIES[SERIES.length-1].ts;
  for(let i=1;i<SERIES.length;i++){
    const a=SERIES[i-1], b=SERIES[i];
    const dt=(b.ts-a.ts)/1000 || dtDefault;
    const midT=(a.T+b.T)/2;
    if(midT>=zMin && midT<=zMax) inS+=dt; else outS+=dt;
  }

  // MKT
  const Ea_kJ=parseFloat($('#ea').value)||83; // –∫–î–∂/–º–æ–ª—å
  const Ea=Ea_kJ*1000; // –î–∂/–º–æ–ª—å
  const R=8.314; // –î–∂/(–º–æ–ª—å¬∑K)
  // –î–∏—Å–∫—Ä–µ—Ç–Ω–æ: T –≤ K
  let sumExp=0, N=0;
  for(let i=0;i<SERIES.length;i++){
    const Tkel=SERIES[i].T + 273.15;
    sumExp += Math.exp(-Ea/(R*Tkel));
    N++;
  }
  const MKT_K = -Ea/R / Math.log( (sumExp/N) );
  const MKT_C = MKT_K - 273.15;

  // –ï–∫—Å—Ç—Ä–µ–º—É–º–∏
  const Tmax = Math.max(...SERIES.map(p=>p.T));
  const Tmin2= Math.min(...SERIES.map(p=>p.T));

  updateKPIs({
    n:SERIES.length,
    inH: inS/3600,
    outH: outS/3600,
    inc: INCIDENTS.filter(e=>e.type!=='door').length,
    doors: DOORS,
    mkt: MKT_C,
    ext: `${Tmax.toFixed(1)} / ${Tmin2.toFixed(1)}`
  });
  draw();
}

function updateKPIs(k={n:0,inH:0,outH:0,inc:0,doors:0,mkt:NaN,ext:'‚Äî'}){
  $('#m_n').textContent = k.n;
  $('#m_in').textContent = k.inH.toFixed(2);
  $('#m_out').textContent= k.outH.toFixed(2);
  $('#m_inc').textContent = k.inc;
  $('#m_doors').textContent= k.doors;
  $('#m_mkt').textContent = isFinite(k.mkt)? k.mkt.toFixed(2) : '‚Äî';
  $('#m_ext').textContent = k.ext;
}

// ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è CSV / –î–µ–º–æ =====
$('#load').addEventListener('click', ()=>{
  const f=$('#file').files[0];
  if(!f) return alert('–û–±–µ—Ä—ñ—Ç—å CSV');
  const r=new FileReader();
  r.onload=()=>{ SERIES = parseCSV(r.result); $('#status').textContent=`–°—Ç–∞—Ç—É—Å: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${SERIES.length} —Ç–æ—á–æ–∫`; log(`CSV: ${SERIES.length} –∑–∞–ø–∏—Å—ñ–≤`); analyze(); };
  r.readAsText(f);
});

$('#demo').addEventListener('click', ()=>{
  // –ó–≥–µ–Ω–µ—Ä—É—î–º–æ —Å–∏–Ω—Ç–µ—Ç–∏–∫—É: 8 –≥–æ–¥, –±–∞–∑–æ–≤–æ 3¬∞C, –¥–≤–µ—Ä—ñ –∫–æ–∂–Ω—ñ ~45 —Ö–≤
  const now=Date.now();
  const N=8*60; // –∫—Ä–æ–∫ 1 —Ö–≤
  SERIES.length=0;
  let T=3;
  for(let i=0;i<=N;i++){
    const ts=now - (N-i)*60000;
    // –≤–∏–ø–∞–¥–∫–æ–≤–µ –∫–æ–ª–∏–≤–∞–Ω–Ω—è
    T += (Math.random()-0.5)*0.15;
    // –ø–æ–¥—ñ—ó –¥–≤–µ—Ä–µ–π
    if(i%45===0 && i>0){
      for(let k=0;k<5;k++){ // 5 —Ö–≤ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è
        T += 0.6; SERIES.push({ts: ts+k*60000, T});
      }
    }
    // –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ö–æ–ª–æ–¥—É
    if(T>3) T -= 0.12;
    SERIES.push({ts, T});
  }
  $('#status').textContent=`–°—Ç–∞—Ç—É—Å: –¥–µ–º–æ ${SERIES.length} —Ç–æ—á–æ–∫`;
  log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –¥–µ–º–æ-—Ç—Ä–∞—Å—É (8 –≥–æ–¥)');
  analyze();
});

$('#recalc').addEventListener('click', analyze);

// ===== –ï–∫—Å–ø–æ—Ä—Ç / —á–µ–∫ / QR =====
function secs(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=Math.floor(s%60); return `${h}–≥ ${m}—Ö ${ss}—Å`; }

$('#saveCsv').addEventListener('click', ()=>{
  if(!INCIDENTS.length){ alert('–ù–µ–º–∞—î —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤'); return; }
  let csv='type,start_iso,end_iso,duration_s,Tmax,Tmin,route\n';
  const route=$('#route').value||'';
  INCIDENTS.forEach(e=>{
    if(e.type==='door') return;
    csv+=`${e.type},${new Date(e.t0).toISOString()},${new Date(e.t1).toISOString()},${Math.round(e.dur_s)},${(e.Tmax??'')},${(e.Tmin??'')},${route.replace(/"/g,'""')}\n`;
  });
  download('tech_para20_incidents_'+stamp()+'.csv', csv, 'text/csv');
});

$('#saveTxt').addEventListener('click', ()=>{
  const zMin=parseFloat($('#tmin').value), zMax=parseFloat($('#tmax').value);
  const incs=INCIDENTS.filter(e=>e.type!=='door');
  const doors=INCIDENTS.filter(e=>e.type==='door').length;
  const txt=[
    '–ü–∞—Ä–∞ 20 ‚Äî –•–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥: –ø—ñ–¥—Å—É–º–æ–∫',
    `–ü—Ä–æ—Ñ—ñ–ª—å: ${$('#m_prof').textContent} (–¥–æ–ø—É—Å–∫ ${zMin}‚Ä¶${zMax} ¬∞C)`,
    `–ú–∞—Ä—à—Ä—É—Ç/–ª–æ—Ç: ${$('#route').value||'‚Äî'}`,
    `–ó–∞–ø–∏—Å—ñ–≤: ${SERIES.length}`,
    `–ß–∞—Å —É –∑–æ–Ω—ñ: ${$('#m_in').textContent} –≥–æ–¥`,
    `–ß–∞—Å –ø–æ–∑–∞ –∑–æ–Ω–æ—é: ${$('#m_out').textContent} –≥–æ–¥`,
    `–Ü–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤: ${incs.length} | –î–≤–µ—Ä–µ–π: ${doors}`,
    `MKT: ${$('#m_mkt').textContent} ¬∞C`,
    `–ï–∫—Å—Ç—Ä–µ–º—É–º–∏: ${$('#m_ext').textContent} ¬∞C`,
    '--- –ü–µ—Ä–µ–ª—ñ–∫ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—ñ–≤ ---',
    ...incs.map(e=>`${e.type.toUpperCase()} | ${new Date(e.t0).toLocaleString()} ‚Üí ${new Date(e.t1).toLocaleString()} | ${secs(e.dur_s)} | Tmax=${(e.Tmax??'').toFixed?e.Tmax.toFixed(1):e.Tmax} ¬∞C`)
  ].join('\n');
  download('tech_para20_summary_'+stamp()+'.txt', txt);
});

$('#print58').addEventListener('click', ()=>{
  const incs=INCIDENTS.filter(e=>e.type!=='door').length;
  const doors=INCIDENTS.filter(e=>e.type==='door').length;
  const lines=[
    '=== –ß–ï–ö –•–û–õ–û–î–û–í–û–ì–û –õ–ê–ù–¶–Æ–ì–ê (58–º–º) ===',
    '–ú–∞—Ä—à—Ä—É—Ç: '+($('#route').value||'‚Äî'),
    `–í –∑–æ–Ω—ñ: ${$('#m_in').textContent} –≥–æ–¥`,
    `–ü–æ–∑–∞ –∑–æ–Ω–æ—é: ${$('#m_out').textContent} –≥–æ–¥`,
    `MKT: ${$('#m_mkt').textContent} ¬∞C`,
    `–Ü–Ω—Ü–∏–¥–µ–Ω—Ç–∏: ${incs} | –î–≤–µ—Ä—ñ: ${doors}`,
    `–î–æ–ø—É—Å–∫: ${$('#tmin').value}‚Ä¶${$('#tmax').value} ¬∞C`,
    '-----------------------------'
  ];
  const rc=$('#rc'); rc.hidden=false; rc.textContent=lines.join('\n');
  download('tech_para20_receipt_'+stamp()+'.txt', rc.textContent);
});

// QR
$('#qrGen').addEventListener('click', ()=>{
  const data = prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –∞–∫—Ç–∞–º–∏/—Ñ–æ—Ç–æ):', $('#route').value || 'cold-chain-evidence');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url;
});

// ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
draw();
</script>
</body>
</html>
