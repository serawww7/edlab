<!-- tech_para14.html
     –ü–ê–†–ê 14 (–∞—É–¥–∏—Ç–æ—Ä–Ω–æ) –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–≤ –∑ –ø–µ—Ä–µ—Ä–æ–±–∫–∏ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞
     –¢–µ–º–∞: –ü–†–û–°–¢–ï–ñ–£–í–ê–ù–Ü–°–¢–¨ & MOCK RECALL ‚Äî ¬´–≤—ñ–¥ –ª–æ—Ç–∞ —Å–∏—Ä–æ–≤–∏–Ω–∏ –¥–æ –∫–ª—ñ—î–Ω—Ç–∞¬ª:
           —Å–∏—Ä–æ–≤–∏–Ω–∞ (RM), –≤–∏—Ä–æ–±–Ω–∏—á—ñ –ø–∞—Ä—Ç—ñ—ó (WIP/FG), –º–∞—Å-–±–∞–ª–∞–Ω—Å, –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è,
           –∑–≤—ñ—Ç –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è, –∫–≤–∏—Ç–æ–∫ 58 –º–º, QR/NFC, CSV.
     –§–æ–∫—É—Å: —Ç–µ–ª–µ—Ñ–æ–Ω–∏/–ü–ö; –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫; –≥–æ—Ç–æ–≤–æ –¥–ª—è GitHub Pages —Ç–∞ Moodle (iframe).
     –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è: —Ç–µ–ª–µ—Ñ–æ–Ω–∏; (–æ–ø—Ü.) —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä 58 –º–º; NFC-–º—ñ—Ç–∫–∏.

     –ü—Ä–∏–º—ñ—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É: —Ç–µ–º–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—å –º–∞—é—Ç—å —Å–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç (.dark).
     –£–í–ê–ì–ê: –Ω–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å. –†–µ–∞–ª—å–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ –ø—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω–æ—Å—Ç—ñ/–≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è ‚Äî –∑–∞ HACCP/FSMS –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞.
--><!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 14 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –ü—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å &amp; Mock Recall: RM‚ÜíWIP/FG‚Üí–ö–ª—ñ—î–Ω—Ç, –∑–≤—ñ—Ç/–∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
    --accent:#22c55e; --accent-2:#60a5fa; --warn:#f59e0b; --bad:#ef4444; --good:#10b981; --line:#1f2937;
    --darkcell:#0b1324; --darkink:#e6eef9; --darkink2:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#111827 30%,#0b1220);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;line-height:1.55}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 64px}
  .badge{display:inline-block;padding:6px 10px;border:1px solid var(--line);background:#0b1220;border-radius:999px;
         font-size:12px;color:var(--muted);letter-spacing:.3px}
  h1{font-size:34px;margin:6px 0 12px;line-height:1.15;
     background:linear-gradient(90deg,#60a5fa,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  h2{font-size:22px;margin:28px 0 12px} h3{font-size:18px;margin:20px 0 8px;color:#cbd5e1}
  p{margin:10px 0}.small{font-size:12px;color:#9fb0c8}.muted{color:#93a3b5}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#dbeafe;text-decoration:none;cursor:pointer}
  .btn:hover{background:#0f1f39}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1000px){.g2,.g3{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .box{border:1px solid #223049;border-radius:12px;padding:12px;background:var(--darkcell);color:var(--darkink)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto;border-radius:12px;border:1px solid #223049}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid #1f2937;font-size:14px;vertical-align:top}
  .table thead th{background:#0c1629;color:#a5b4fc;text-align:left;position:sticky;top:0}
  .table tbody tr:nth-child(even){background:var(--darkcell);color:var(--darkink2)}
  .table td.dark,.table th.dark{background:var(--darkcell)!important;color:var(--darkink2)!important}
  .out{background:var(--darkcell);color:var(--darkink2);border:1px dashed #263042;padding:10px 12px;border-radius:10px;word-break:break-all}
  input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#e6eef9}
  textarea{min-height:84px}
  /* –ß–µ–∫ 58 –º–º */
  .ticket{width:58mm;background:#fff;color:#000;padding:6mm 4mm;border-radius:6px;box-shadow:0 0 0 1px #e5e7eb inset;font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px;font-size:13px;text-align:center}.ticket p{margin:2px 0;font-size:12px}.ticket .line{border-top:1px dashed #111;margin:6px 0}
  .ticket small{font-size:10px}
  /* –í–±—É–¥–æ–≤–∞–Ω–æ –≤ Moodle (iframe) ‚Üí —Å–≤—ñ—Ç–ª–∏–π –≤–∏–≥–ª—è–¥ */
  html.embedded body{background:#fff;color:#111}
  html.embedded .card{background:#fff;border:1px solid #e5e7eb;box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial;background:none;color:#111}
  html.embedded .box{background:#f8fafc;color:#111}
  html.embedded .table tbody tr:nth-child(even){background:#f3f4f6;color:#111}
  @media print{@page{margin:4mm}.no-print{display:none!important}}
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

<meta name="description" content="–ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏: (1) –≤–Ω–µ—Å—É—Ç—å —Å–∏—Ä–æ–≤–∏–Ω—É (RM) –∑ –ª–æ—Ç–∞–º–∏, (2) –∑–±–µ—Ä—É—Ç—å –≤–∏—Ä–æ–±–Ω–∏—á—ñ –ø–∞—Ä—Ç—ñ—ó –∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é RM —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –º–∞—Å-–±–∞–ª–∞–Ω—Å—É, (3) —Å—Ñ–æ—Ä–º—É—é—Ç—å –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω"><link rel="canonical" href="https://edlab.pp.ua/tech_II_kyrs/tech_para14.html"><meta property="og:type" content="article"><meta property="og:title" content="üß≠ –ü—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å &amp; Mock Recall: RM‚ÜíWIP/FG‚Üí–ö–ª—ñ—î–Ω—Ç, –∑–≤—ñ—Ç/–∫–≤–∏—Ç–æ–∫/QR/NFC/CSV"><meta property="og:description" content="–ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏: (1) –≤–Ω–µ—Å—É—Ç—å —Å–∏—Ä–æ–≤–∏–Ω—É (RM) –∑ –ª–æ—Ç–∞–º–∏, (2) –∑–±–µ—Ä—É—Ç—å –≤–∏—Ä–æ–±–Ω–∏—á—ñ –ø–∞—Ä—Ç—ñ—ó –∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é RM —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –º–∞—Å-–±–∞–ª–∞–Ω—Å—É, (3) —Å—Ñ–æ—Ä–º—É—é—Ç—å –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω"><meta property="og:url" content="https://edlab.pp.ua/tech_II_kyrs/tech_para14.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"üß≠ –ü—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å & Mock Recall: RM‚ÜíWIP/FG‚Üí–ö–ª—ñ—î–Ω—Ç, –∑–≤—ñ—Ç/–∫–≤–∏—Ç–æ–∫/QR/NFC/CSV","description":"–ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏: (1) –≤–Ω–µ—Å—É—Ç—å —Å–∏—Ä–æ–≤–∏–Ω—É (RM) –∑ –ª–æ—Ç–∞–º–∏, (2) –∑–±–µ—Ä—É—Ç—å –≤–∏—Ä–æ–±–Ω–∏—á—ñ –ø–∞—Ä—Ç—ñ—ó –∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é RM —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –º–∞—Å-–±–∞–ª–∞–Ω—Å—É, (3) —Å—Ñ–æ—Ä–º—É—é—Ç—å –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/tech_II_kyrs/tech_para14.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <span class="badge">–ü–∞—Ä–∞ 14 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ ¬∑ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏ –ø–µ—Ä–µ—Ä–æ–±–∫–∏</span>
  <h1>üß≠ –ü—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å &amp; Mock Recall: RM‚ÜíWIP/FG‚Üí–ö–ª—ñ—î–Ω—Ç, –∑–≤—ñ—Ç/–∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</h1>

  <div class="card">
    <h2>üéØ –ú–µ—Ç–∞ –ø–∞—Ä–∏</h2>
    <p>
      –ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏: (1) –≤–Ω–µ—Å—É—Ç—å <b>—Å–∏—Ä–æ–≤–∏–Ω—É (RM)</b> –∑ –ª–æ—Ç–∞–º–∏, (2) –∑–±–µ—Ä—É—Ç—å <b>–≤–∏—Ä–æ–±–Ω–∏—á—ñ –ø–∞—Ä—Ç—ñ—ó</b> –∑
      –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é RM —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é <b>–º–∞—Å-–±–∞–ª–∞–Ω—Å—É</b>, (3) —Å—Ñ–æ—Ä–º—É—é—Ç—å <b>–≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</b> –∫–ª—ñ—î–Ω—Ç–∞–º, (4) –ø—Ä–æ–≤–µ–¥—É—Ç—å
      <b>Mock Recall</b> –≤—ñ–¥ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ª–æ—Ç–∞ RM –¥–æ <b>–ø–∞—Ä—Ç—ñ–π, –≥–æ—Ç–æ–≤–æ—ó –ø—Ä–æ–¥—É–∫—Ü—ñ—ó —Ç–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤</b>, (5) –æ—Ñ–æ—Ä–º–ª—è—Ç—å <b>CSV</b>,
      <b>QR/NFC</b> —ñ <b>–∫–≤–∏—Ç–æ–∫ 58 –º–º</b>.
    </p>
    <p class="small muted">–ù–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å. –ù–∞ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤—ñ ‚Äî –¥–æ—Ç—Ä–∏–º—É–π—Ç–µ—Å—å –ø—Ä–æ—Ü–µ–¥—É—Ä ISO 22005/FSMS, GS1 —Ç–∞ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ñ–≤ —â–æ–¥–æ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è.</p>
  </div>

  <!-- 1. –°–ò–†–û–í–ò–ù–ê (RM) -->
  <div class="card">
    <h2>ü•© –°–∏—Ä–æ–≤–∏–Ω–∞ (RM inbound)</h2>
    <div class="row">
      <button class="btn" onclick="addRM()">‚ûï –î–æ–¥–∞—Ç–∏ RM</button>
      <button class="btn" onclick="presetRM()">üß™ –ü—Ä–∏–∫–ª–∞–¥ RM</button>
      <button class="btn" onclick="copyCSV('csvRM')">üìã CSV (rm)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblRM">
        <thead>
          <tr>
            <th>#</th>
            <th>–ù–∞–∑–≤–∞</th>
            <th class="dark">–õ–û–¢ RM</th>
            <th class="dark">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</th>
            <th class="dark">EXP</th>
            <th>–ó–∞–ª–∏—à–æ–∫, –∫–≥</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyRM"></tbody>
      </table>
    </div>
    <div id="csvRM" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 2. –í–ò–†–û–ë–ù–ò–ß–Ü –ü–ê–†–¢–Ü–á (WIP/FG) -->
  <div class="card">
    <h2>üè≠ –í–∏—Ä–æ–±–Ω–∏—á–∞ –ø–∞—Ä—Ç—ñ—è (Batch ‚Üí FG)</h2>
    <div class="grid g3">
      <div class="box">
        <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–∞—Ä—Ç—ñ—ó</h3>
        <div class="row">
          <div style="flex:1"><label>ID –ø–∞—Ä—Ç—ñ—ó</label><input id="bId" type="text" value="B-251017-01"></div>
          <div style="flex:1"><label>–î–∞—Ç–∞</label><input id="bDate" type="date"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1"><label>–õ–û–¢ FG</label><input id="fgLot" type="text" value="FG-251017-A"></div>
          <div style="flex:1"><label>–í–∏—Ö—ñ–¥ FG, –∫–≥</label><input id="fgKg" type="number" step="0.1" value="380"></div>
        </div>
      </div>
      <div class="box">
        <h3>–°–∫–ª–∞–¥ –ø–∞—Ä—Ç—ñ—ó (RM ‚Üí –∫–≥)</h3>
        <div class="row">
          <div style="flex:1"><label>RM –ª–æ—Ç</label><select id="rmSel"></select></div>
          <div style="flex:1"><label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å, –∫–≥</label><input id="rmKg" type="number" step="0.1" value="100"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" onclick="addUse()">‚ûï –î–æ–¥–∞—Ç–∏ —É —Å–∫–ª–∞–¥</button>
          <button class="btn" onclick="copyCSV('csvUse')">üìã CSV (batch.RM)</button>
        </div>
      </div>
      <div class="box">
        <h3>–î—ñ—ó</h3>
        <div class="row">
          <button class="btn" onclick="saveBatch()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–∞—Ä—Ç—ñ—é</button>
          <button class="btn" onclick="presetBatch()">üß™ –ü—Ä–∏–∫–ª–∞–¥ –ø–∞—Ä—Ç—ñ—ó</button>
        </div>
        <div id="massOut" class="out" style="margin-top:8px">‚Äî</div>
      </div>
    </div>

    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblUse">
        <thead>
          <tr>
            <th>#</th>
            <th>RM –ª–æ—Ç</th>
            <th class="dark">–ù–∞–∑–≤–∞ RM</th>
            <th class="dark">–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ, –∫–≥</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyUse"></tbody>
      </table>
    </div>
    <div id="csvUse" class="out" style="margin-top:8px">‚Äî</div>

    <h3 style="margin-top:12px">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–∞—Ä—Ç—ñ—ó</h3>
    <div style="overflow:auto;margin-top:6px">
      <table class="table" id="tblBatch">
        <thead>
          <tr>
            <th>#</th>
            <th>ID –ø–∞—Ä—Ç—ñ—ó</th>
            <th class="dark">–î–∞—Ç–∞</th>
            <th class="dark">FG –ª–æ—Ç</th>
            <th>FG, –∫–≥</th>
            <th>RM (–ª–æ—Ç:–∫–≥; ‚Ä¶)</th>
            <th>–í—Ç—Ä–∞—Ç–∏, %</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyBatch"></tbody>
      </table>
    </div>
    <div id="csvBatch" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 3. –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø -->
  <div class="card">
    <h2>üöö –í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º</h2>
    <div class="row">
      <div style="flex:1"><label>–ö–ª—ñ—î–Ω—Ç</label><input id="shClient" type="text" value="–¢–û–í ¬´–†—ñ—Ç–µ–π–ª-–ú–∞—Ä–∫–µ—Ç¬ª"></div>
      <div style="flex:1"><label>FG –ª–æ—Ç</label><select id="shFg"></select></div>
      <div style="flex:1"><label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å, –∫–≥</label><input id="shKg" type="number" step="0.1" value="120"></div>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn" onclick="addShip()">‚ûï –î–æ–¥–∞—Ç–∏ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</button>
      <button class="btn" onclick="copyCSV('csvShip')">üìã CSV (ship)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblShip">
        <thead>
          <tr>
            <th>#</th>
            <th>–ö–ª—ñ—î–Ω—Ç</th>
            <th class="dark">FG –ª–æ—Ç</th>
            <th class="dark">–î–∞—Ç–∞</th>
            <th>–ö—ñ–ª–æ–≥—Ä–∞–º–∏</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyShip"></tbody>
      </table>
    </div>
    <div id="csvShip" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 4. MOCK RECALL -->
  <div class="card">
    <h2>üö® Mock Recall (–≤—ñ–¥ RM –ª–æ—Ç–∞)</h2>
    <div class="row">
      <div style="flex:1"><label>RM –ª–æ—Ç –¥–ª—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è</label><select id="recRM"></select></div>
      <div style="flex:1"><label>–ü—Ä–∏—á–∏–Ω–∞</label><input id="recReason" type="text" value="–ü—ñ–¥–æ–∑—Ä–∞ –Ω–∞ –º—ñ–∫—Ä–æ–±–Ω–µ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è"></div>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn" onclick="runRecall()">üßÆ –ü–æ–±—É–¥—É–≤–∞—Ç–∏ –∑–≤‚Äô—è–∑–∫–∏</button>
      <button class="btn" onclick="copyCSV('csvRecall')">üìã CSV (recall)</button>
    </div>

    <div class="grid g3" style="margin-top:8px">
      <div class="box">
        <h3>–ó–∞–¥—ñ—è–Ω—ñ –ø–∞—Ä—Ç—ñ—ó</h3>
        <div id="recBatches" class="out">‚Äî</div>
      </div>
      <div class="box">
        <h3>–ü–æ—Å—Ç—Ä–∞–∂–¥–∞–ª—ñ FG –ª–æ—Ç–∏</h3>
        <div id="recFG" class="out">‚Äî</div>
      </div>
      <div class="box">
        <h3>–ö–ª—ñ—î–Ω—Ç–∏/–≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
        <div id="recClients" class="out">‚Äî</div>
      </div>
    </div>
    <div id="csvRecall" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 5. –ñ–£–†–ù–ê–õ / –ö–í–ò–¢–û–ö / QR / NFC -->
  <div class="card">
    <h2>üìí –ñ—É—Ä–Ω–∞–ª &amp; –ö–≤–∏—Ç–æ–∫ 58 –º–º / QR / NFC</h2>
    <div class="row">
      <button class="btn" onclick="addLog()">‚ûï –î–æ–¥–∞—Ç–∏ —É –∂—É—Ä–Ω–∞–ª</button>
      <button class="btn" onclick="copyCSV('csvLog')">üìã CSV (journal)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblLog">
        <thead>
          <tr>
            <th>#</th>
            <th>RM –ª–æ—Ç</th>
            <th class="dark">–ü–∞—Ä—Ç—ñ—ó</th>
            <th class="dark">FG –ª–æ—Ç–∏</th>
            <th>–ö–ª—ñ—î–Ω—Ç–∏ (–∫-—Ç—å)</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyLog"></tbody>
      </table>
    </div>
    <div id="csvLog" class="out" style="margin-top:8px">‚Äî</div>

    <div class="grid g2" style="margin-top:12px">
      <div class="box">
        <h3>QR-payload</h3>
        <div class="row">
          <button class="btn" onclick="buildQR()">üß© –ó—ñ–±—Ä–∞—Ç–∏ QR</button>
          <button class="btn" onclick="copyEl('qrOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="qrOut" class="out">‚Äî</div>

        <h3 style="margin-top:12px">NFC ‚Äî ‚ÄúRECALL CARD‚Äù</h3>
        <div class="row">
          <div style="flex:1"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input id="nfcPhone" type="text" value="+380XXXXXXXXX"></div>
          <div style="flex:1"><label>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</label><input id="nfcOper" type="text" value="–°—Ç—É–¥–µ–Ω—Ç –¢–ü–¢"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" onclick="buildNFC()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
          <button class="btn" onclick="copyEl('nfcOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="nfcOut" class="out">‚Äî</div>
      </div>

      <div class="box">
        <h3>–ö–≤–∏—Ç–æ–∫ 58 –º–º ‚Äî ‚ÄúRECALL NOTICE‚Äù</h3>
        <div class="row">
          <button class="btn" onclick="scrollTicket()">üßæ –ü–æ–∫–∞–∑–∞—Ç–∏</button>
          <button class="btn" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫</button>
        </div>
        <div class="ticket" id="ticket" style="margin-top:8px">
          <h4>RECALL NOTICE</h4>
          <p><b>RM –ª–æ—Ç:</b> <span id="tRM">‚Äî</span></p>
          <p><b>–ü—Ä–∏—á–∏–Ω–∞:</b> <span id="tWhy">‚Äî</span></p>
          <div class="line"></div>
          <p><b>–ü–∞—Ä—Ç—ñ—ó:</b> <span id="tB">‚Äî</span></p>
          <p><b>FG –ª–æ—Ç–∏:</b> <span id="tFG">‚Äî</span></p>
          <p><b>–ö–ª—ñ—î–Ω—Ç–∏:</b> <span id="tCl">‚Äî</span></p>
          <div class="line"></div>
          <p><small>–ù–∞–≤—á–∞–ª—å–Ω–∞ —Å–∏–º—É–ª—è—Ü—ñ—è. –†–µ–∞–ª—å–Ω—ñ –¥—ñ—ó ‚Äî –∑–≥—ñ–¥–Ω–æ –ü–ª–∞–Ω—É –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è (FSMS).</small></p>
        </div>
      </div>
    </div>
  </div>

  <!-- 6. –•–Ü–î –†–û–ë–û–¢–ò + –û–¶–Ü–ù–Æ–í–ê–ù–ù–Ø -->
  <div class="card">
    <h2>ü™ú –•—ñ–¥ —Ä–æ–±–æ—Ç–∏ (45‚Äì70 —Ö–≤)</h2>
    <ol>
      <li>–°—Ç–≤–æ—Ä—ñ—Ç—å 3‚Äì5 –ª–æ—Ç—ñ–≤ RM –∑ –∑–∞–ª–∏—à–∫–∞–º–∏.</li>
      <li>–ó–±–µ—Ä—ñ—Ç—å 2‚Äì3 –≤–∏—Ä–æ–±–Ω–∏—á—ñ –ø–∞—Ä—Ç—ñ—ó –∑ –∫—ñ–ª—å–∫–æ—Ö RM; –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–∞—Å-–±–∞–ª–∞–Ω—Å (–≤—Ç—Ä–∞—Ç–∏ ‚â§ 5‚Äì8%).</li>
      <li>–î–æ–¥–∞–π—Ç–µ 2‚Äì3 –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è FG –ª–æ—Ç—ñ–≤ —Ä—ñ–∑–Ω–∏–º –∫–ª—ñ—î–Ω—Ç–∞–º.</li>
      <li>–í–∏–∫–æ–Ω–∞–π—Ç–µ Mock Recall –≤—ñ–¥ –æ–¥–Ω–æ–≥–æ RM –ª–æ—Ç–∞; —Å—Ñ–æ—Ä–º—É–π—Ç–µ –∑–≤—ñ—Ç, QR/NFC —ñ –∫–≤–∏—Ç–æ–∫; —Å–∫–æ–ø—ñ—é–π—Ç–µ CSV.</li>
    </ol>
  </div>

  <div class="card">
    <h2>‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
    <table class="table">
      <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä—ñ–π</th><th>–ë–∞–ª–∏</th></tr></thead>
      <tbody>
        <tr><td>–ü–æ–≤–Ω–æ—Ç–∞ –¥–∞–Ω–∏—Ö RM —Ç–∞ –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–∞–ª–∏—à–∫–∏</td><td>2</td></tr>
        <tr><td>–ü–∞—Ä—Ç—ñ—ó: –∑–≤‚Äô—è–∑–∫–∏ RM‚ÜíFG, –º–∞—Å-–±–∞–ª–∞–Ω—Å</td><td>4</td></tr>
        <tr><td>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: –∫–ª—ñ—î–Ω—Ç–∏/–¥–∞—Ç–∏/FG</td><td>2</td></tr>
        <tr><td>Mock Recall: –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –∑–≤—ñ—Ç + –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</td><td>2</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle iFrame)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();
  const byId = id => document.getElementById(id);
  const rnd = (n,d=2)=>Number((+n).toFixed(d));
  function copyCSV(id){ const t=byId(id).textContent.trim(); if(!t||t==='‚Äî'){alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è');return;} navigator.clipboard.writeText(t); }
  function copyEl(id){ const t=byId(id).textContent.trim(); if(!t||t==='‚Äî'){alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è');return;} navigator.clipboard.writeText(t); }
  function reindex(tb){ [...tb.querySelectorAll('tr')].forEach((tr,i)=>tr.querySelector('.idx').textContent=i+1); }

  // ===== 1) RM =====
  const bodyRM = byId('bodyRM');
  function addRM(sample){
    const s = Object.assign({name:'–°–≤–∏–Ω–∏–Ω–∞ –æ—Ö–æ–ª.', lot:'RM-XXXX', supp:'–¢–û–í ¬´–ú º—è—Å–æ–ü–æ—Å—Ç–∞—á¬ª', exp:new Date().toISOString().slice(0,10), left:500}, sample||{});
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td><input type="text" value="${s.name}"></td>
      <td class="dark"><input type="text" value="${s.lot}"></td>
      <td class="dark"><input type="text" value="${s.supp}"></td>
      <td class="dark"><input type="date" value="${s.exp}"></td>
      <td><input type="number" step="0.1" value="${s.left}"></td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyRM); buildCSV_RM(); refreshSelectors();">‚úñ</button></td>
    `;
    bodyRM.appendChild(tr); reindex(bodyRM); buildCSV_RM(); refreshSelectors();
  }
  function presetRM(){
    bodyRM.innerHTML='';
    const d = (off)=> new Date(Date.now()+off*86400000).toISOString().slice(0,10);
    addRM({name:'–°–≤–∏–Ω–∏–Ω–∞ –æ—Ö–æ–ª. –æ–∫—ñ—Å—Ç', lot:'RM-SV-251001', supp:'–¢–û–í ¬´–§–µ—Ä–º–∞+¬ª', exp:d(10), left:320});
    addRM({name:'–°–≤–∏–Ω–∏–Ω–∞ –æ—Ö–æ–ª. –ª–æ–ø–∞—Ç–∫–∞', lot:'RM-SV-251003', supp:'–¢–û–í ¬´–§–µ—Ä–º–∞+¬ª', exp:d(12), left:280});
    addRM({name:'–ö—Ä–æ—Ö–º–∞–ª—å —Ö–∞—Ä—á–æ–≤–∏–π', lot:'RM-AD-251002', supp:'–¢–û–í ¬´–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç¬ª', exp:d(180), left:50});
    addRM({name:'–°—ñ–ª—å —Ö–∞—Ä—á–æ–≤–∞', lot:'RM-AD-250900', supp:'–¢–û–í ¬´–°—ñ–ª—å–ö–æ–º¬ª', exp:d(365), left:40});
    addRM({name:'–°–ø–µ—Ü—ñ—ó —Å—É–º—ñ—à', lot:'RM-SP-251005', supp:'–¢–û–í ¬´–°–ø–µ—Ü—ñ—ó-UA¬ª', exp:d(240), left:10});
  }
  function buildCSV_RM(){
    const rows=[...bodyRM.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].querySelector('input').value.trim(),
        r.children[3].querySelector('input').value.trim(),
        r.children[4].querySelector('input').value.trim(),
        r.children[5].querySelector('input').value.trim()
      ].join(' | ');
    });
    byId('csvRM').textContent = rows.join('\n') || '‚Äî';
  }

  // —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ RM/FG
  function refreshSelectors(){
    const rmSel = byId('rmSel'); const recRM = byId('recRM');
    const opts = [...bodyRM.querySelectorAll('tr')].map(r=>r.children[2].querySelector('input').value.trim());
    rmSel.innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
    recRM.innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
  }
  function refreshFGSelector(){
    const fgSel = byId('shFg');
    const lots = [...byId('bodyBatch').querySelectorAll('tr')].map(r=>r.children[3].textContent.trim()).filter(Boolean);
    fgSel.innerHTML = lots.map(o=>`<option>${o}</option>`).join('');
  }

  // ===== 2) –ü–ê–†–¢–Ü–Ø =====
  const bodyUse = byId('bodyUse'); const bodyBatch = byId('bodyBatch');
  function addUse(){
    const lot = byId('rmSel').value||'‚Äî';
    const rmRow = [...bodyRM.querySelectorAll('tr')].find(r=>r.children[2].querySelector('input').value.trim()===lot);
    const name = rmRow? rmRow.children[1].querySelector('input').value.trim() : '‚Äî';
    const kg = +byId('rmKg').value||0;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td>${lot}</td>
      <td class="dark">${name}</td>
      <td class="dark">${rnd(kg,2)}</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyUse); buildCSV_Use(); massBalance();">‚úñ</button></td>
    `;
    bodyUse.appendChild(tr); reindex(bodyUse); buildCSV_Use(); massBalance();
  }
  function buildCSV_Use(){
    const rows=[...bodyUse.querySelectorAll('tr')].map(r=>{
      return [r.querySelector('.idx').textContent.trim(), r.children[1].textContent.trim(), r.children[2].textContent.trim(), r.children[3].textContent.trim()].join(' | ');
    });
    byId('csvUse').textContent = rows.join('\n') || '‚Äî';
  }
  function massBalance(){
    const sumIn = [...bodyUse.querySelectorAll('tr')].reduce((a,r)=>a+(+r.children[3].textContent.trim()||0),0);
    const fg = +byId('fgKg').value||0;
    const loss = sumIn>0 ? rnd((sumIn - fg)/sumIn*100,2) : 0;
    const ok = (loss>=0 && loss<=8);
    byId('massOut').textContent = `–í—Ö—ñ–¥: ${rnd(sumIn,2)} –∫–≥; –í–∏—Ö—ñ–¥ (FG): ${rnd(fg,2)} –∫–≥; –í—Ç—Ä–∞—Ç–∏: ${rnd(loss,2)}% ‚Üí ${ok?'üü¢ –ù–û–†–ú–ê':'üü† –ü–ï–†–ï–í–ò–©–ï–ù–ù–Ø'}`;
    return {sumIn, fg, loss, ok};
  }
  function saveBatch(){
    const id = byId('bId').value||'‚Äî';
    const date = byId('bDate').value||new Date().toISOString().slice(0,10);
    const fg = byId('fgLot').value||'‚Äî';
    const kg = +byId('fgKg').value||0;
    const uses = [...bodyUse.querySelectorAll('tr')].map(r=>({lot:r.children[1].textContent.trim(), kg:+r.children[3].textContent.trim()}));
    if(!uses.length){ alert('–î–æ–¥–∞–π—Ç–µ RM —É —Å–∫–ª–∞–¥ –ø–∞—Ä—Ç—ñ—ó'); return; }
    // —Å–ø–∏—Å–∞—Ç–∏ –∑–∞–ª–∏—à–∫–∏ –∑ RM
    uses.forEach(u=>{
      const rmRow=[...bodyRM.querySelectorAll('tr')].find(r=>r.children[2].querySelector('input').value.trim()===u.lot);
      if(rmRow){
        const leftEl = rmRow.children[5].querySelector('input');
        leftEl.value = rnd((+leftEl.value||0) - u.kg,2);
      }
    });
    buildCSV_RM();

    // —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—Ç—Ä–∞—Ç
    const mb = massBalance();

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td>${id}</td>
      <td class="dark">${date}</td>
      <td class="dark">${fg}</td>
      <td>${rnd(kg,2)}</td>
      <td>${uses.map(u=>`${u.lot}:${u.kg}–∫–≥`).join('; ')}</td>
      <td>${rnd(mb.loss,2)}%</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyBatch); buildCSV_Batch(); refreshFGSelector();">‚úñ</button></td>
    `;
    bodyBatch.appendChild(tr); reindex(bodyBatch); buildCSV_Batch(); refreshFGSelector();
    // –æ—á–∏—Å—Ç–∏—Ç–∏ —Å–∫–ª–∞–¥
    bodyUse.innerHTML=''; buildCSV_Use(); byId('massOut').textContent='‚Äî';
  }
  function buildCSV_Batch(){
    const rows=[...bodyBatch.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].textContent.trim(),
        r.children[2].textContent.trim(),
        r.children[3].textContent.trim(),
        r.children[4].textContent.trim(),
        r.children[5].textContent.trim(),
        r.children[6].textContent.trim()
      ].join(' | ');
    });
    byId('csvBatch').textContent = rows.join('\n') || '‚Äî';
  }
  function presetBatch(){
    // –ø—Ä–∏–∫–ª–∞–¥: –ø–∞—Ä—Ç—ñ—è –∑ –¥–≤–æ—Ö RM
    byId('bId').value = 'B-251017-02';
    byId('fgLot').value = 'FG-251017-B';
    byId('fgKg').value = 390;
    bodyUse.innerHTML='';
    byId('rmSel').selectedIndex = 0; byId('rmKg').value=320; addUse();
    byId('rmSel').selectedIndex = 2; byId('rmKg').value=8; addUse();
    byId('rmSel').selectedIndex = 3; byId('rmKg').value=6; addUse();
    massBalance();
  }

  // ===== 3) –í–Ü–î–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø =====
  const bodyShip = byId('bodyShip');
  function addShip(){
    const client = byId('shClient').value||'‚Äî';
    const fg = byId('shFg').value||'‚Äî';
    const kg = +byId('shKg').value||0;
    const d = new Date().toISOString().slice(0,10);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td><input type="text" value="${client}"></td>
      <td class="dark">${fg}</td>
      <td class="dark">${d}</td>
      <td>${rnd(kg,2)}</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyShip); buildCSV_Ship();">‚úñ</button></td>
    `;
    bodyShip.appendChild(tr); reindex(bodyShip); buildCSV_Ship();
  }
  function buildCSV_Ship(){
    const rows=[...bodyShip.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].textContent.trim(),
        r.children[3].textContent.trim(),
        r.children[4].textContent.trim()
      ].join(' | ');
    });
    byId('csvShip').textContent = rows.join('\n') || '‚Äî';
  }

  // ===== 4) MOCK RECALL =====
  function runRecall(){
    const rmLot = byId('recRM').value||'‚Äî';
    // –ø–∞—Ä—Ç—ñ—ó, —â–æ –º—ñ—Å—Ç—è—Ç—å rmLot
    const batches=[...bodyBatch.querySelectorAll('tr')].map(r=>({
      id:r.children[1].textContent.trim(),
      date:r.children[2].textContent.trim(),
      fg:r.children[3].textContent.trim(),
      fgkg:+r.children[4].textContent.trim()||0,
      uses:r.children[5].textContent.trim() // "RM:kg; RM:kg"
    })).filter(b=> b.uses.split(';').some(s=>s.trim().startsWith(rmLot+':')) );

    const fgLots = batches.map(b=>b.fg);
    // –∫–ª—ñ—î–Ω—Ç–∏, —â–æ –æ—Ç—Ä–∏–º–∞–ª–∏ —Ü—ñ FG
    const shipments=[...bodyShip.querySelectorAll('tr')].map(r=>({
      client:r.children[1].querySelector('input').value.trim(),
      fg:r.children[2].textContent.trim(),
      date:r.children[3].textContent.trim(),
      kg:+r.children[4].textContent.trim()||0
    })).filter(s=> fgLots.includes(s.fg));

    // –í–∏–≤—ñ–¥
    const bTxt = batches.length? batches.map(b=>`${b.id} (${b.date}) ‚Üí ${b.fg}`).join('\n') : '‚Äî';
    const fgTxt = fgLots.length? fgLots.join(', ') : '‚Äî';
    const clLines = shipments.length? shipments.map(s=>`${s.client}: ${s.fg} ‚Äî ${s.kg} –∫–≥ (${s.date})`).join('\n') : '‚Äî';

    byId('recBatches').textContent = bTxt;
    byId('recFG').textContent = fgTxt;
    byId('recClients').textContent = clLines;

    const csv = [];
    csv.push(`RECALL|RM=${rmLot}|WHY=${byId('recReason').value}`);
    batches.forEach(b=> csv.push(`BATCH|${b.id}|FG=${b.fg}|DATE=${b.date}|USES=${b.uses}`));
    shipments.forEach(s=> csv.push(`SHIP|${s.client}|FG=${s.fg}|KG=${s.kg}|DATE=${s.date}`));
    byId('csvRecall').textContent = csv.join('\n');

    // –ö–≤–∏—Ç–æ–∫ –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
    byId('tRM').textContent = rmLot;
    byId('tWhy').textContent = byId('recReason').value;
    byId('tB').textContent = batches.length? batches.map(b=>b.id).join(', ') : '‚Äî';
    byId('tFG').textContent = fgTxt;
    byId('tCl').textContent = shipments.length? `${shipments.length} —à—Ç.` : '‚Äî';
  }

  // ===== 5) –ñ–£–†–ù–ê–õ / QR / NFC =====
  const bodyLog = byId('bodyLog');
  function addLog(){
    const rm = byId('recRM').value||'‚Äî';
    const b = (byId('recBatches').textContent||'‚Äî').replace(/\n/g,'; ');
    const fg = byId('recFG').textContent||'‚Äî';
    const cl = byId('recClients').textContent||'‚Äî';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="idx">1</td>
      <td>${rm}</td>
      <td class="dark">${b.length? b.slice(0,60)+'‚Ä¶' : '‚Äî'}</td>
      <td class="dark">${fg.length? fg.slice(0,60)+'‚Ä¶' : '‚Äî'}</td>
      <td>${cl==='‚Äî'?'0':cl.split('\n').length}</td>
      <td>–ó–≤—ñ—Ç –∑—ñ–±—Ä–∞–Ω–æ</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyLog); buildCSV_Log();">‚úñ</button></td>
    `;
    bodyLog.appendChild(tr); reindex(bodyLog); buildCSV_Log();
  }
  function buildCSV_Log(){
    const rows=[...bodyLog.querySelectorAll('tr')].map(r=>{
      const idx=r.querySelector('.idx').textContent.trim();
      const rm=r.children[1].textContent.trim();
      const b=r.children[2].textContent.trim();
      const fg=r.children[3].textContent.trim();
      const n=r.children[4].textContent.trim();
      const st=r.children[5].textContent.trim();
      return [idx,rm,b,fg,n,st].join(' | ');
    });
    byId('csvLog').textContent = rows.join('\n') || '‚Äî';
  }
  function buildQR(){
    const payload = {
      rm: byId('recRM').value,
      why: byId('recReason').value,
      batches: byId('recBatches').textContent,
      fg: byId('recFG').textContent,
      clients: byId('recClients').textContent.slice(0,200)+'‚Ä¶'
    };
    byId('qrOut').textContent = JSON.stringify(payload);
  }
  function buildNFC(){
    const txt = [
      `RECALL_CARD`,
      `RM:${byId('recRM').value}`,
      `WHY:${byId('recReason').value}`,
      `BATCHES:${byId('recBatches').textContent.replace(/\n/g,' | ')}`,
      `FG:${byId('recFG').textContent}`,
      `CLIENTS:${byId('recClients').textContent.split('\n').length} –∑–∞–ø–∏—Å(—ñ–≤)`,
      `OPER:${byId('nfcOper').value} CONTACT:${byId('nfcPhone').value}`,
      `STAMP:${new Date().toISOString().slice(0,19).replace('T',' ')}`
    ].join('\n');
    byId('nfcOut').textContent = txt;
  }
  function scrollTicket(){ byId('ticket').scrollIntoView({behavior:'smooth',block:'center'}); }

  // ===== INIT =====
  (function init(){
    byId('bDate').value = new Date().toISOString().slice(0,10);
    presetRM(); refreshSelectors();
    // –Ω–µ–≤–µ–ª–∏–∫–∏–π —Ü–∏–∫–ª: –∑—Ä–æ–±–∏—Ç–∏ 1‚Äì2 –ø–∞—Ä—Ç—ñ—ó —Ç–∞ 1 –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —â–æ–± –±—É–ª–æ –Ω–∞ —á–æ–º—É —Ç—Ä–µ–Ω—É–≤–∞—Ç–∏—Å—å
    presetBatch(); saveBatch();
    byId('bId').value='B-251017-03'; byId('fgLot').value='FG-251017-C'; byId('fgKg').value=380;
    bodyUse.innerHTML=''; byId('rmSel').selectedIndex=1; byId('rmKg').value=280; addUse();
    byId('rmSel').selectedIndex=4; byId('rmKg').value=10; addUse();
    saveBatch();
    refreshFGSelector();
    addShip();
  })();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>



</body></html>