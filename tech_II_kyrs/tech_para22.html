<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 22 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –®–Ü –¥–ª—è —Ä–µ—Ü–µ–ø—Ç—É—Ä: –±–∞–≥–∞—Ç–æ–∫—Ä–∏—Ç–µ—Ä—ñ–∞–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è, –≥—Ä–∞—Ñ—ñ–∫–∏, —á–µ–∫/CSV/QR</title>
<meta name="description" content="AI-–æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ä–µ—Ü–µ–ø—Ç—É—Ä–∏: –≤–æ–ª–æ–≥–∞/–∂–∏—Ä/—Å—ñ–ª—å/–Ω—ñ—Ç—Ä–∏—Ç/—Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å, –æ–±–º–µ–∂–µ–Ω–Ω—è, –≤–∞–≥–∏ —Ü—ñ–ª–µ–π, —Å—Ç–µ–∫-–¥—ñ–∞–≥—Ä–∞–º–∞, —Ä–∞–¥–∞—Ä, –∂—É—Ä–Ω–∞–ª, —á–µ–∫/CSV/QR."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1260px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
textarea{min-height:90px}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
small.mono,.mono{font-family:ui-monospace,monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.35fr 1fr}
@media(max-width:1140px){.grid{grid-template-columns:1fr}}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:300px}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace;white-space:pre}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:0 8px;color:var(--muted);margin-right:6px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üß™</span>
      <div>
        <b>–ü–∞—Ä–∞ 22 ‚Äî –®–Ü –¥–ª—è —Ä–µ—Ü–µ–ø—Ç—É—Ä</b><br/>
        <span class="badge">–≤–æ–ª–æ–≥–∞/–∂–∏—Ä/—Å—ñ–ª—å/–Ω—ñ—Ç—Ä–∏—Ç/—Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å ‚Üí –æ–±–º–µ–∂–µ–Ω–Ω—è ‚Üí –≤–∞–≥–∏ —Ü—ñ–ª–µ–π ‚Üí –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è ‚Üí –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Üí —á–µ–∫/CSV/QR</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –ø–æ–±—É–¥—É–≤–∞—Ç–∏ **AI-–ø–æ–º—ñ—á–Ω–∏–∫** –¥–ª—è –ø—ñ–¥–±–æ—Ä—É —Ä–µ—Ü–µ–ø—Ç—É—Ä–∏ (–≤–∞—Ä–µ–Ω–∞ –∫–æ–≤–±–∞—Å–∞/—à–∏–Ω–∫–∞, –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–∏–π –≤–∏—Ä—ñ–± —Ç–æ—â–æ). –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –º–∞—é—Ç—å **–≤–º—ñ—Å—Ç–∏** (–≤–æ–¥–∞/–∂–∏—Ä/—Å—ñ–ª—å/–Ω—ñ—Ç—Ä–∏—Ç) —ñ **—Ü—ñ–Ω—É**. –û–ø—Ç–∏–º—ñ–∑—É—î–º–æ <b>–±–∞–≥–∞—Ç–æ–∫—Ä–∏—Ç–µ—Ä—ñ–∞–ª—å–Ω–æ</b> (–Ω–∞–±–ª–∏–∑–∏—Ç–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –¥–æ —Ü—ñ–ª–µ–π, –∑–º–µ–Ω—à–∏—Ç–∏ —Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å) –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º **–æ–±–º–µ–∂–µ–Ω—å**. –°—É–º–∞ —á–∞—Å—Ç–æ–∫ = <span class="mono">100 %</span>.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û -->
    <div class="card">
      <h2>üß∞ –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</h2>
      <small class="muted">–î–æ–¥–∞–π/—Ä–µ–¥–∞–≥—É–π. –í–º—ñ—Å—Ç ‚Äî —É % –≤—ñ–¥ –º–∞—Å–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞; –Ω—ñ—Ç—Ä–∏—Ç ‚Äî ppm —É –≥–æ—Ç–æ–≤–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—ñ, —è–∫–∏–π –¥–∞—î 1% —Ü—å–æ–≥–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞ (–¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è).</small>
      <div class="row">
        <label>–ù–∞–∑–≤–∞<input id="i_name" class="input" value="–ú‚Äô—è—Å–æ –Ω–µ–∂–∏—Ä–Ω–µ"/></label>
        <label>–¶—ñ–Ω–∞, –≥—Ä–Ω/–∫–≥<input id="i_price" class="input" type="number" step="0.1" value="140"/></label>
        <label>–í–æ–¥–∞, %<input id="i_w" class="input" type="number" step="0.1" value="72"/></label>
        <label>–ñ–∏—Ä, %<input id="i_f" class="input" type="number" step="0.1" value="6"/></label>
        <label>–°—ñ–ª—å, %<input id="i_s" class="input" type="number" step="0.1" value="0.3"/></label>
        <label>–ù—ñ—Ç—Ä–∏—Ç, ppm<input id="i_n" class="input" type="number" step="1" value="0"/></label>
        <button class="btn" id="addIng">‚ûï –î–æ–¥–∞—Ç–∏</button>
        <button class="btn secondary" id="demo">üé≤ –î–µ–º–æ-–Ω–∞–±—ñ—Ä</button>
        <button class="btn secondary" id="clearIng">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>

      <table class="tbl" id="ingTbl">
        <thead><tr><th>#</th><th>–ù–∞–∑–≤–∞</th><th>–¶—ñ–Ω–∞</th><th>–í–æ–¥–∞%</th><th>–ñ–∏—Ä%</th><th>–°—ñ–ª—å%</th><th>–ù—ñ—Ç—Ä–∏—Ç ppm</th><th>–î—ñ—è</th></tr></thead>
        <tbody></tbody>
      </table>

      <h2 style="margin-top:10px">üéØ –¶—ñ–ª—ñ —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è</h2>
      <div class="row">
        <label>–¶—ñ–ª—å –í–æ–ª–æ–≥–∞, %<input id="t_w" class="input" type="number" step="0.1" value="72.0"/></label>
        <label>–¶—ñ–ª—å –ñ–∏—Ä, %<input id="t_f" class="input" type="number" step="0.1" value="18.0"/></label>
        <label>–¶—ñ–ª—å –°—ñ–ª—å, %<input id="t_s" class="input" type="number" step="0.05" value="1.8"/></label>
        <label>–ú–∞–∫—Å –ù—ñ—Ç—Ä–∏—Ç, ppm<input id="c_n_max" class="input" type="number" step="1" value="120"/></label>
      </div>
      <div class="row">
        <label>–ú—ñ–Ω. –í–æ–¥–∞, %<input id="c_w_min" class="input" type="number" step="0.1" value="68"/></label>
        <label>–ú–∞–∫—Å. –í–æ–¥–∞, %<input id="c_w_max" class="input" type="number" step="0.1" value="76"/></label>
        <label>–ú–∞–∫—Å. –°—ñ–ª—å, %<input id="c_s_max" class="input" type="number" step="0.05" value="2.2"/></label>
        <label>–ú–∞–∫—Å. –ñ–∏—Ä, %<input id="c_f_max" class="input" type="number" step="0.1" value="22"/></label>
      </div>

      <h3 style="margin-top:10px">‚öñÔ∏è –í–∞–≥–∏ —Ü—ñ–ª–µ–π (0‚Ä¶1)</h3>
      <div class="row">
        <label>w –í–æ–ª–æ–≥–∞<input id="w_w" class="input" type="number" step="0.05" value="0.35"/></label>
        <label>w –ñ–∏—Ä<input id="w_f" class="input" type="number" step="0.05" value="0.25"/></label>
        <label>w –°—ñ–ª—å<input id="w_s" class="input" type="number" step="0.05" value="0.25"/></label>
        <label>w –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å<input id="w_c" class="input" type="number" step="0.05" value="0.15"/></label>
        <label>–ö—Ä–æ–∫ %, –¥–ª—è –º—É—Ç–∞—Ü—ñ–π<input id="step" class="input" type="number" step="0.1" value="0.5"/></label>
        <button class="btn good" id="opt">üöÄ –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏</button>
      </div>

      <h3 style="margin-top:10px">üìà –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è</h3>
      <div class="canvasWrap"><canvas id="stack" width="980" height="220"></canvas></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="radar" width="980" height="260"></canvas></div>
      <small class="muted">–ì–æ—Ä—ñ—à–Ω—è ‚Äî —Å—Ç–µ–∫-–¥—ñ–∞–≥—Ä–∞–º–∞ % —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤; –Ω–∏–∂–Ω—è ‚Äî —Ä–∞–¥–∞—Ä ¬´–≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ vs —Ü—ñ–ª—ñ/–æ–±–º–µ–∂–µ–Ω–Ω—è¬ª.</small>

      <h3 style="margin-top:10px">üíæ –ï–∫—Å–ø–æ—Ä—Ç/–¥—Ä—É–∫</h3>
      <div class="row">
        <input id="lot" class="input" placeholder="SKU/–õ–æ—Ç (–Ω–∞–ø—Ä. –ö–æ–≤–±–∞—Å–∞ –≤–∞—Ä–µ–Ω–∞ 2025-10-18)"/>
        <button class="btn" id="saveCsv">üìÑ CSV (—Ä–µ—Ü–µ–ø—Ç)</button>
        <button class="btn" id="saveTxt">üíæ TXT (–∑–≤—ñ—Ç)</button>
        <button class="btn" id="print58">üñ®Ô∏è –ß–µ–∫ 58 –º–º</button>
        <button class="btn secondary" id="qrGen">üîó QR (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–æ–∫–∞–∑–∏/–∞–∫—Ç–∏)</button>
      </div>
      <div id="rc" class="receipt" hidden></div>
      <div class="canvasWrap" style="margin-top:8px"><canvas id="qr" width="220" height="220"></canvas></div>
      <small class="muted">QR –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ <span class="mono">api.qrserver.com</span>; –æ—Ñ–ª–∞–π–Ω –≤–∏–≤–µ–¥–µ—Ç—å—Å—è —Ç–µ–∫—Å—Ç.</small>

      <h3 style="margin-top:10px">üßæ –ñ—É—Ä–Ω–∞–ª</h3>
      <pre id="alog" class="note" style="max-height:160px;overflow:auto">// –ü–æ–∫–∏ –±–µ–∑ –ø–æ–¥—ñ–π</pre>
    </div>

    <!-- –ü–†–ê–í–û -->
    <div class="card">
      <h2>üìä –ü–æ–∫–∞–∑–Ω–∏–∫–∏</h2>
      <table class="tbl">
        <tbody>
          <tr><th>Œ£ —á–∞—Å—Ç–æ–∫, %</th><td id="m_sum">0.0</td></tr>
          <tr><th>–í–æ–ª–æ–≥–∞, %</th><td id="m_w">‚Äî</td></tr>
          <tr><th>–ñ–∏—Ä, %</th><td id="m_f">‚Äî</td></tr>
          <tr><th>–°—ñ–ª—å, %</th><td id="m_s">‚Äî</td></tr>
          <tr><th>–ù—ñ—Ç—Ä–∏—Ç, ppm</th><td id="m_n">‚Äî</td></tr>
          <tr><th>–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å, –≥—Ä–Ω/–∫–≥</th><td id="m_c">‚Äî</td></tr>
          <tr><th>–°–∫–æ—Ä –º–æ–¥–µ–ª—ñ (0‚Äì1)</th><td id="m_score">‚Äî</td></tr>
          <tr><th>–ü–æ—Ä—É—à–µ–Ω–Ω—è</th><td id="m_viol">‚Äî</td></tr>
        </tbody>
      </table>

      <h2 style="margin-top:10px">üîå –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—É (SVG)</h2>
      <svg viewBox="0 0 820 280" role="img" aria-label="–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ ‚Üí –û–±–º–µ–∂–µ–Ω–Ω—è/–¶—ñ–ª—ñ ‚Üí –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è ‚Üí –†–µ—Ü–µ–ø—Ç ‚Üí –ó–≤—ñ—Ç">
        <rect x="40" y="40" width="170" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="125" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</text>
        <text x="125" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">–≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ/—Ü—ñ–Ω–∞</text>

        <rect x="230" y="40" width="190" height="120" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="325" y="80" fill="#dcfce7" font-size="14" text-anchor="middle">–¶—ñ–ª—ñ/–û–±–º–µ–∂–µ–Ω–Ω—è</text>
        <text x="325" y="100" fill="#a7f3d0" font-size="12" text-anchor="middle">–≤–æ–ª–æ–≥–∞/–∂–∏—Ä/—Å—ñ–ª—å/–Ω—ñ—Ç—Ä–∏—Ç</text>

        <rect x="440" y="40" width="150" height="120" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="515" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è</text>
        <text x="515" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">AI-–ø–æ—à—É–∫</text>

        <rect x="610" y="40" width="170" height="120" rx="12" fill="#0b1a2f" stroke="#64748b"/>
        <text x="695" y="80" fill="#e5e7eb" font-size="14" text-anchor="middle">–†–µ—Ü–µ–ø—Ç/–ó–≤—ñ—Ç</text>
        <text x="695" y="100" fill="#93c5fd" font-size="12" text-anchor="middle">—á–µ–∫/CSV/QR</text>

        <line x1="210" y1="100" x2="230" y2="100" stroke="#93c5fd" stroke-width="3"/>
        <line x1="420" y1="100" x2="440" y2="100" stroke="#22c55e" stroke-width="3"/>
        <line x1="590" y1="100" x2="610" y2="100" stroke="#64748b" stroke-width="3"/>
      </svg>

      <h2 style="margin-top:10px">üéØ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
      <ol>
        <li>–ó–±–µ—Ä–∏ ‚â• 6 —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤, –∑–∞–¥–∞–π —Ü—ñ–ª—ñ: <span class="mono">–í=72%</span>, <span class="mono">–ñ=18%</span>, <span class="mono">–°—ñ–ª—å=1.8%</span>, <span class="mono">–ù—ñ—Ç—Ä–∏—Ç ‚â§120 ppm</span>. –î–æ—Å—è–≥–Ω–∏ <b>Score ‚â• 0.9</b>.</li>
        <li>–ó–º—ñ–Ω—é–π –≤–∞–≥–∏ —Ü—ñ–ª–µ–π —ñ –ø–æ–∫–∞–∂–∏ –≤–ø–ª–∏–≤ –Ω–∞ <b>—Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å</b> (—Å–∫—Ä—ñ–Ω —Ä–∞–¥–∞—Ä–∏ + —Å—Ç–µ–∫-–¥—ñ–∞–≥—Ä–∞–º–∏).</li>
        <li>–ï–∫—Å–ø–æ—Ä—Ç—É–π <b>CSV</b> —Ä–µ—Ü–µ–ø—Ç–∞, –∑–≥–µ–Ω–µ—Ä—É–π <b>QR</b> –Ω–∞ –ø–∞–ø–∫—É –∑ –∞–∫—Ç–∞–º–∏, —Ä–æ–∑–¥—Ä—É–∫—É–π <b>—á–µ–∫ 58 –º–º</b>.</li>
      </ol>

      <h2 style="margin-top:10px">üìú –Ü—Å—Ç–æ—Ä–∏—á–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h2>
      <p class="muted small">–ü–µ—Ä—à—ñ –ø—ñ–¥—Ö–æ–¥–∏ –¥–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ–≥–æ –ø—ñ–¥–±–æ—Ä—É —Ä–µ—Ü–µ–ø—Ç—É—Ä —É —Ö–∞—Ä—á–æ–≤—ñ–π –ø—Ä–æ–º–∏—Å–ª–æ–≤–æ—Å—Ç—ñ –∑‚Äô—è–≤–∏–ª–∏—Å—è –≤ 1960‚Äì70-—Ö (–ª—ñ–Ω—ñ–π–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è). –°—å–æ–≥–æ–¥–Ω—ñ –ª–µ–≥–∫—ñ –µ–≤—Ä–∏—Å—Ç–∏–∫–∏ + —ñ–Ω—Ç—É—ó—Ü—ñ—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∞ –¥–∞—é—Ç—å —à–≤–∏–¥–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–≤—ñ—Ç—å —É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
    </div>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function log(msg){const t=new Date().toLocaleTimeString();const box=$('#alog');if(box.textContent.startsWith('//'))box.textContent='';box.textContent+=`[${t}] ${msg}\n`;box.scrollTop=box.scrollHeight;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

// ===== –î–∞–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ =====
let ING=[]; // {name, price, w, f, s, n} (–≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ)
let BEST={mix:[], score:0, props:null, cost:0, nit:0};

function renderTable(){
  const tb=$('#ingTbl tbody'); tb.innerHTML='';
  ING.forEach((g,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${g.name}</td><td>${g.price.toFixed(2)}</td>
      <td>${g.w.toFixed(1)}</td><td>${g.f.toFixed(1)}</td><td>${g.s.toFixed(2)}</td><td>${g.n.toFixed(0)}</td>
      <td><button class="btn secondary" data-i="${i}">üóëÔ∏è</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click', (e)=>{ ING.splice(+b.dataset.i,1); renderTable(); drawStack([]); drawRadar(null); updateKPIs(null,[]); }));
}

$('#addIng').addEventListener('click', ()=>{
  const g={
    name: $('#i_name').value.trim()||'–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç',
    price:+$('#i_price').value,
    w:+$('#i_w').value,
    f:+$('#i_f').value,
    s:+$('#i_s').value,
    n:+$('#i_n').value
  };
  if(!isFinite(g.price)||!isFinite(g.w)||!isFinite(g.f)||!isFinite(g.s)||!isFinite(g.n)) return alert('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞');
  ING.push(g); renderTable();
});

$('#clearIng').addEventListener('click', ()=>{ ING.length=0; renderTable(); });

// –î–µ–º–æ-–Ω–∞–±—ñ—Ä
$('#demo').addEventListener('click', ()=>{
  ING=[
    {name:'–ú‚Äô—è—Å–æ –Ω–µ–∂–∏—Ä–Ω–µ', price:140, w:72, f:6,  s:0.3, n:0},
    {name:'–ñ–∏—Ä-—Å–∏—Ä–µ—Ü—å',    price:90,  w:10, f:90, s:0.2, n:0},
    {name:'–õ—ñ–¥/–≤–æ–¥–∞',      price:5,   w:100,f:0,  s:0,   n:0},
    {name:'–°—ñ–ª—å –∫—É—Ö–æ–Ω–Ω–∞',  price:20,  w:0,  f:0,  s:100, n:0},
    {name:'–ü–æ—Å–æ–ª. —Å—É–º—ñ—à',  price:25,  w:0,  f:0,  s:99.5,n:6000}, // —É–º–æ–≤–Ω–æ 6000 ppm –Ω–∞ 1% —É –≥–æ—Ç–æ–≤–æ–º—É
    {name:'–§–æ—Å—Ñ–∞—Ç',        price:120, w:0,  f:0,  s:0,   n:0},
    {name:'–ë—ñ–ª–æ–∫/–∑–≤‚Äô—è–∑–∫–∞', price:80,  w:6,  f:1,  s:2,   n:0},
    {name:'–¶—É–∫–æ—Ä/—Å–ø–µ—Ü—ñ—ó',  price:60,  w:0,  f:0,  s:0,   n:0}
  ];
  renderTable();
});

// ===== –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π —Ä–µ—Ü–µ–ø—Ç–∞ =====
function mixProps(mix){ // mix[i] —É %
  if(!mix || !mix.length) return null;
  const sum = mix.reduce((a,b)=>a+b,0) || 1;
  const frac = mix.map(x=>x/sum); // –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
  let W=0,F=0,S=0,N=0,C=0;
  for(let i=0;i<ING.length;i++){
    W+= frac[i]*ING[i].w;
    F+= frac[i]*ING[i].f;
    S+= frac[i]*ING[i].s;
    N+= frac[i]*ING[i].n;
    C+= frac[i]*ING[i].price;
  }
  return {W,F,S,N,C};
}

// ===== –û—Ü—ñ–Ω–∫–∞ (score) =====
function scoreOf(props, targets, weights, cons){
  if(!props) return -1e9;
  // –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –ø–æ —Ü—ñ–ª—è—Ö (—á–∏–º –±–ª–∏–∂—á–µ ‚Äî —Ç–∏–º –∫—Ä–∞—â–µ), –ú–ê–ï-–Ω–æ—Ä–º—É–≤–∞–Ω–Ω—è
  const dW=Math.abs(props.W-targets.W)/Math.max(1,targets.W);
  const dF=Math.abs(props.F-targets.F)/Math.max(1,targets.F);
  const dS=Math.abs(props.S-targets.S)/Math.max(1,targets.S);
  // –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å ‚Äî –º—ñ–Ω—ñ–º—ñ–∑—É—î–º–æ –≤—ñ–¥–Ω–æ—Å–Ω–æ ¬´—è–∫–æ—Ä—è¬ª (—Å–µ—Ä–µ–¥–Ω—å–æ—ó —Ü—ñ–Ω–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤)
  const avgPrice = ING.length? ING.reduce((a,b)=>a+b.price,0)/ING.length : 100;
  const dC = props.C/Math.max(1,avgPrice);

  // –®—Ç—Ä–∞—Ñ–∏ –∑–∞ –ø–æ—Ä—É—à–µ–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω—å (–∂–æ—Ä—Å—Ç–∫—ñ)
  let pen=0;
  if(props.W<cons.Wmin) pen += (cons.Wmin-props.W)*10;
  if(props.W>cons.Wmax) pen += (props.W-cons.Wmax)*10;
  if(props.F>cons.Fmax) pen += (props.F-cons.Fmax)*10;
  if(props.S>cons.Smax) pen += (props.S-cons.Smax)*10;
  if(props.N>cons.Nmax) pen += (props.N-cons.Nmax)/5; // ppm —ñ–Ω—à–∏–º –º–∞—Å—à—Ç–∞–±–æ–º

  const raw = 1 - (weights.wW*dW + weights.wF*dF + weights.wS*dS + weights.wC*dC);
  return raw - pen; // –±—ñ–ª—å—à–∏–π = –∫—Ä–∞—â–µ
}

// ===== –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è (—Ä–∞–Ω–¥–æ–º–Ω–∏–π —Å—Ç–∞—Ä—Ç + –ª–æ–∫–∞–ª—å–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è) =====
function optimize(){
  if(ING.length<3) return alert('–î–æ–¥–∞–π —â–æ–Ω–∞–π–º–µ–Ω—à–µ 3 —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏');
  const targets={W:+$('#t_w').value,F:+$('#t_f').value,S:+$('#t_s').value};
  const cons={Wmin:+$('#c_w_min').value,Wmax:+$('#c_w_max').value,Smax:+$('#c_s_max').value,Fmax:+$('#c_f_max').value,Nmax:+$('#c_n_max').value};
  const weights={wW:+$('#w_w').value,wF:+$('#w_f').value,wS:+$('#w_s').value,wC:+$('#w_c').value};
  const STEP=+$('#step').value; // –∫—Ä–æ–∫ % –¥–ª—è –º—É—Ç–∞—Ü—ñ–π
  const iters=2000, restarts=10;

  let bestScore=-1e9, bestMix=null, bestProps=null;

  for(let r=0;r<restarts;r++){
    // –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —Å—Ç–∞—Ä—Ç (—Å—É–º–∞=100)
    let mix=new Array(ING.length).fill(0);
    let remain=100;
    for(let i=0;i<ING.length-1;i++){ const x=Math.random()*remain; mix[i]=x; remain-=x; }
    mix[ING.length-1]=remain;

    let props=mixProps(mix);
    let sc=scoreOf(props,targets,weights,cons);

    for(let it=0;it<iters;it++){
      // –õ–æ–∫–∞–ª—å–Ω–∞ –º—É—Ç–∞—Ü—ñ—è: –ø–µ—Ä–µ–∫–∏–Ω–µ–º–æ STEP% –≤—ñ–¥ i –¥–æ j
      const i=Math.floor(Math.random()*ING.length);
      let j=Math.floor(Math.random()*ING.length); if(j===i) j=(j+1)%ING.length;
      const delta=Math.min(STEP, mix[i]);
      if(delta<=0.0001) continue;
      mix[i]-=delta; mix[j]+=delta;

      const pNew=mixProps(mix);
      const sNew=scoreOf(pNew,targets,weights,cons);
      if(sNew>=sc){ // –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∞–±–æ —Ä—ñ–≤–Ω–µ ‚Äî –ø—Ä–∏–π–º–∞—î–º–æ
        sc=sNew; props=pNew;
      }else{
        // –≤—ñ–¥–∫–∞—Ç
        mix[j]-=delta; mix[i]+=delta;
      }
      if(it%200===0){ log(`r${r+1}/${restarts}, it ${it}: score=${sc.toFixed(3)}`); }
    }

    if(sc>bestScore){ bestScore=sc; bestMix=mix.slice(); bestProps=props; }
  }

  BEST={mix:bestMix, score:bestScore, props:bestProps, cost:bestProps?.C||0, nit:bestProps?.N||0};
  updateKPIs(bestProps, bestMix);
  drawStack(bestMix);
  drawRadar(bestProps);
  log(`–ì–æ—Ç–æ–≤–æ: Score=${bestScore.toFixed(3)}; Œ£=${bestMix.reduce((a,b)=>a+b,0).toFixed(2)}%`);
}

$('#opt').addEventListener('click', optimize);

// ===== KPI / –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è =====
function updateKPIs(props, mix){
  if(!props||!mix){ $('#m_sum').textContent='0.0'; $('#m_w').textContent='‚Äî'; $('#m_f').textContent='‚Äî'; $('#m_s').textContent='‚Äî'; $('#m_n').textContent='‚Äî'; $('#m_c').textContent='‚Äî'; $('#m_score').textContent='‚Äî'; $('#m_viol').textContent='‚Äî'; return; }
  $('#m_sum').textContent = mix.reduce((a,b)=>a+b,0).toFixed(1);
  $('#m_w').textContent = props.W.toFixed(2);
  $('#m_f').textContent = props.F.toFixed(2);
  $('#m_s').textContent = props.S.toFixed(2);
  $('#m_n').textContent = props.N.toFixed(0);
  $('#m_c').textContent = props.C.toFixed(2);
  $('#m_score').textContent = BEST.score.toFixed(3);

  const cons={Wmin:+$('#c_w_min').value,Wmax:+$('#c_w_max').value,Smax:+$('#c_s_max').value,Fmax:+$('#c_f_max').value,Nmax:+$('#c_n_max').value};
  const viol=[];
  if(props.W<cons.Wmin) viol.push('–í–æ–ª–æ–≥–∞ < –º—ñ–Ω');
  if(props.W>cons.Wmax) viol.push('–í–æ–ª–æ–≥–∞ > –º–∞–∫—Å');
  if(props.F>cons.Fmax) viol.push('–ñ–∏—Ä > –º–∞–∫—Å');
  if(props.S>cons.Smax) viol.push('–°—ñ–ª—å > –º–∞–∫—Å');
  if(props.N>cons.Nmax) viol.push('–ù—ñ—Ç—Ä–∏—Ç > –º–∞–∫—Å');
  $('#m_viol').innerHTML = viol.length? `<b class="bad">${viol.join('; ')}</b>`:'–Ω–µ–º–∞';
}

const cvsS=$('#stack'), ctxS=cvsS.getContext('2d');
function drawStack(mix){
  const W=cvsS.width,H=cvsS.height;
  ctxS.clearRect(0,0,W,H);
  ctxS.strokeStyle='#223049'; ctxS.strokeRect(0.5,0.5,W-1,H-1);
  if(!mix || !mix.length){ ctxS.fillStyle='#94a3b8'; ctxS.fillText('–î–æ–¥–∞–π —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏¬ª',14,20); return; }
  const left=60, right=W-10, top=20, bottom=H-30;
  // –°—Ç–µ–∫ –ø–æ –æ–¥–Ω–æ–º—É –±–∞—Ä—É
  let x0=left, barW=right-left, y0=bottom;
  const sum=mix.reduce((a,b)=>a+b,0) || 1;
  // –ü–∞–ª—ñ—Ç—Ä—É –ª–∏—à–∞—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∫–∞–Ω–≤–∏ (–±–µ–∑ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤), –ª–∏—à–µ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å
  let acc=0;
  for(let i=0;i<ING.length;i++){
    const h=(mix[i]/sum)*(bottom-top);
    ctxS.fillStyle='rgba(56,189,248,'+(0.25+0.6*(i%5)/5)+')';
    ctxS.fillRect(x0, y0-h, barW, h);
    // –ø—ñ–¥–ø–∏—Å
    ctxS.fillStyle='#e5e7eb';
    if(h>18) ctxS.fillText(`${ING[i].name} ${mix[i].toFixed(1)}%`, x0+8, y0-h+14);
    y0-=h; acc+=mix[i];
  }
  // –æ—Å—ñ
  ctxS.fillStyle='#94a3b8'; ctxS.font='12px ui-monospace';
  ctxS.fillText('Œ£=100%', left, H-8);
}

const cvsR=$('#radar'), ctxR=cvsR.getContext('2d');
function drawRadar(props){
  const W=cvsR.width,H=cvsR.height;
  ctxR.clearRect(0,0,W,H);
  ctxR.strokeStyle='#223049'; ctxR.strokeRect(0.5,0.5,W-1,H-1);
  if(!props){ ctxR.fillStyle='#94a3b8'; ctxR.fillText('–ù–µ–º–∞—î —Ä–µ—Ü–µ–ø—Ç–∞',14,20); return; }
  // –í—ñ—Å—ñ: –í–æ–ª–æ–≥–∞, –ñ–∏—Ä, –°—ñ–ª—å, –ù—ñ—Ç—Ä–∏—Ç, –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å
  const cx=W/2, cy=H/2+10, r=Math.min(W,H)*0.34;
  const axes=[ '–í–æ–ª–æ–≥–∞ %', '–ñ–∏—Ä %', '–°—ñ–ª—å %', '–ù—ñ—Ç—Ä–∏—Ç ppm', '–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å –≥—Ä–Ω/–∫–≥' ];
  const tgt=[ +$('#t_w').value, +$('#t_f').value, +$('#t_s').value, +$('#c_n_max').value, (ING.reduce((a,b)=>a+b.price,0)/Math.max(1,ING.length)) ];
  const val=[ props.W, props.F, props.S, props.N, props.C ];
  // –º–∞—Å—à—Ç–∞–±–∏ (–Ω–æ—Ä–º—É—î–º–æ —É [0,1] –≤—ñ–¥–Ω–æ—Å–Ω–æ —Ü—ñ–ª–µ–π/–º–∞–∫—Å–∏–º—É–º—ñ–≤)
  const lim=[ +$('#c_w_max').value, +$('#c_f_max').value, +$('#c_s_max').value, +$('#c_n_max').value, Math.max(tgt[4]*1.5, props.C*1.2, 100) ];

  function pt(k, vNorm){
    const ang = -Math.PI/2 + k*(2*Math.PI/axes.length);
    return [ cx + r*vNorm*Math.cos(ang), cy + r*vNorm*Math.sin(ang) ];
  }

  // –°—ñ—Ç–∫–∞/–º—ñ—Ç–∫–∏
  ctxR.strokeStyle='#334155'; ctxR.fillStyle='#94a3b8'; ctxR.font='12px ui-monospace';
  for(let g=0.25; g<=1.01; g+=0.25){
    ctxR.beginPath();
    for(let k=0;k<axes.length;k++){ const [x,y]=pt(k,g); k?ctxR.lineTo(x,y):ctxR.moveTo(x,y); }
    ctxR.closePath(); ctxR.stroke();
  }
  axes.forEach((a,k)=>{ const [x,y]=pt(k,1.08); ctxR.fillText(a, x-36, y); });

  // –¶—ñ–ª—ñ (—è–∫ –∫–æ–ª–æ —Ç–æ—á–æ–∫)
  ctxR.beginPath(); ctxR.strokeStyle='#22c55e';
  for(let k=0;k<axes.length;k++){ const g=clamp(tgt[k]/lim[k],0,1); const [x,y]=pt(k,g); k?ctxR.lineTo(x,y):ctxR.moveTo(x,y); }
  ctxR.closePath(); ctxR.stroke();

  // –ü–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
  ctxR.beginPath(); ctxR.strokeStyle='#38bdf8'; ctxR.fillStyle='rgba(56,189,248,0.18)';
  for(let k=0;k<axes.length;k++){ const g=clamp(val[k]/lim[k],0,1); const [x,y]=pt(k,g); k?ctxR.lineTo(x,y):ctxR.moveTo(x,y); }
  ctxR.closePath(); ctxR.fill(); ctxR.stroke();
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç / –¥—Ä—É–∫ / QR =====
$('#saveCsv').addEventListener('click', ()=>{
  if(!BEST.mix.length) return alert('–°–ø–æ—á–∞—Ç–∫—É –æ–ø—Ç–∏–º—ñ–∑—É–π —Ä–µ—Ü–µ–ø—Ç');
  let csv='ingredient,share_percent,price_per_kg,water%,fat%,salt%,nitrite_ppm\n';
  for(let i=0;i<ING.length;i++){
    csv+=`${ING[i].name.replace(/"/g,'""')},${BEST.mix[i].toFixed(2)},${ING[i].price},${ING[i].w},${ING[i].f},${ING[i].s},${ING[i].n}\n`;
  }
  csv+=`TOTAL,100,${BEST.cost.toFixed(2)},${BEST.props.W.toFixed(2)},${BEST.props.F.toFixed(2)},${BEST.props.S.toFixed(2)},${BEST.props.N.toFixed(0)}\n`;
  download('tech_para22_recipe_'+stamp()+'.csv', csv, 'text/csv');
});
$('#saveTxt').addEventListener('click', ()=>{
  if(!BEST.mix.length) return alert('–ù–µ–º–∞—î —Ä–µ—Ü–µ–ø—Ç–∞');
  const lines=[
    '–ü–∞—Ä–∞ 22 ‚Äî –®–Ü –¥–ª—è —Ä–µ—Ü–µ–ø—Ç—É—Ä: –ø—ñ–¥—Å—É–º–æ–∫',
    '–õ–æ—Ç: '+($('#lot').value||'‚Äî'),
    `Score: ${BEST.score.toFixed(3)}`,
    `–í–æ–ª–æ–≥–∞=${BEST.props.W.toFixed(2)}% | –ñ–∏—Ä=${BEST.props.F.toFixed(2)}% | –°—ñ–ª—å=${BEST.props.S.toFixed(2)}% | –ù—ñ—Ç—Ä–∏—Ç=${BEST.props.N.toFixed(0)} ppm`,
    `–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å: ${BEST.cost.toFixed(2)} –≥—Ä–Ω/–∫–≥`,
    '--- –†–µ—Ü–µ–ø—Ç ---',
    ...ING.map((g,i)=>`${g.name}: ${BEST.mix[i].toFixed(2)} %`),
  ];
  download('tech_para22_summary_'+stamp()+'.txt', lines.join('\n'));
});
$('#print58').addEventListener('click', ()=>{
  if(!BEST.mix.length) return alert('–ù–µ–º–∞—î —Ä–µ—Ü–µ–ø—Ç–∞');
  const rc=$('#rc'); rc.hidden=false;
  const lines=[
    '=== –†–ï–¶–ï–ü–¢ (58–º–º) ===',
    '–õ–æ—Ç: '+($('#lot').value||'‚Äî'),
    `Œ£=100% | –í=${BEST.props.W.toFixed(1)} –ñ=${BEST.props.F.toFixed(1)} –°=${BEST.props.S.toFixed(2)} | N=${BEST.props.N.toFixed(0)} ppm`,
    `–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å: ${BEST.cost.toFixed(2)} –≥—Ä–Ω/–∫–≥`,
    ...ING.map((g,i)=>`${(g.name).slice(0,22)}: ${BEST.mix[i].toFixed(1)}%`),
    '---------------------'
  ];
  rc.textContent=lines.join('\n');
  download('tech_para22_receipt_'+stamp()+'.txt', rc.textContent);
});
$('#qrGen').addEventListener('click', ()=>{
  const data = prompt('–í—Å—Ç–∞–≤ URL/—Ç–µ–∫—Å—Ç (–ø–∞–ø–∫–∞ –∑ –∞–∫—Ç–∞–º–∏/—Ñ–æ—Ç–æ):', $('#lot').value || 'recipe-evidence');
  if(data===null) return;
  const url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=2&data='+encodeURIComponent(data);
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.drawImage(img,0,0,220,220); };
  img.onerror=()=>{ const q=$('#qr').getContext('2d'); q.clearRect(0,0,220,220); q.fillStyle='#e5e7eb'; q.font='14px ui-monospace'; q.fillText('QR offline', 62,110); q.fillText((data.length>14?data.slice(0,14)+'‚Ä¶':data), 36,132); };
  img.src=url;
});

// ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
renderTable();
drawStack([]);
drawRadar(null);
</script>
</body>
</html>
