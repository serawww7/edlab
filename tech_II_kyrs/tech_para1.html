<!-- tech_para1.html
     –ü–ê–†–ê 1 (–∞—É–¥–∏—Ç–æ—Ä–Ω–æ) –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–≤ –∑ –ø–µ—Ä–µ—Ä–æ–±–∫–∏ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞
     –¢–µ–º–∞: –ú–ê–†–ö–£–í–ê–ù–ù–Ø –ü–ê–†–¢–Ü–ô, –¢–ï–†–ú–Ü–ù –ü–†–ò–î–ê–¢–ù–û–°–¢–Ü –¢–ê –ü–†–û–°–¢–ï–ñ–£–í–ê–ù–Ü–°–¢–¨ ‚Äî
           –∫–æ–¥ –ø–∞—Ä—Ç—ñ—ó (–ª–æ—Ç), –¥–∞—Ç–∞/—á–∞—Å, –∑–º—ñ–Ω–∏, –≤–∏—Ä–æ–±–Ω–∏—á–∞ –ª—ñ–Ω—ñ—è, —É–º–æ–≤–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è,
           —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–µ—Ä–º—ñ–Ω—É (–±–∞–∑–∞ + –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ —Ç–µ–º–ø-—Ä–∏/—É–ø–∞–∫–æ–≤–∫–∏), —á–µ–∫ 58 –º–º, NFC, CSV-–∂—É—Ä–Ω–∞–ª.
     –§–æ–∫—É—Å: —Ç–µ–ª–µ—Ñ–æ–Ω–∏/–ü–ö; –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫; –≥–æ—Ç–æ–≤–æ –¥–ª—è GitHub Pages —Ç–∞ Moodle (iframe).
     –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è: —Ç–µ–ª–µ—Ñ–æ–Ω–∏; (–æ–ø—Ü.) —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä 58 –º–º; NFC-–º—ñ—Ç–∫–∏.

     –ü—Ä–∏–º—ñ—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É: —Ç–µ–º–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—å –º–∞—é—Ç—å —Å–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç (.dark).
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 1 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –õ–æ—Ç, —Ç–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ, –ø—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å: —á–µ–∫ 58 –º–º, NFC, CSV</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
    --accent:#22c55e; --accent-2:#60a5fa; --warn:#f59e0b; --bad:#ef4444; --good:#10b981; --line:#1f2937;
    --darkcell:#0b1324; --darkink:#e6eef9; --darkink2:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#111827 30%,#0b1220);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;line-height:1.55}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 64px}
  .badge{display:inline-block;padding:6px 10px;border:1px solid var(--line);background:#0b1220;border-radius:999px;
         font-size:12px;color:var(--muted);letter-spacing:.3px}
  h1{font-size:34px;margin:6px 0 12px;line-height:1.15;
     background:linear-gradient(90deg,#60a5fa,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  h2{font-size:22px;margin:28px 0 12px} h3{font-size:18px;margin:20px 0 8px;color:#cbd5e1}
  p{margin:10px 0}.small{font-size:12px;color:#9fb0c8}.muted{color:#93a3b5}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#dbeafe;text-decoration:none;cursor:pointer}
  .btn:hover{background:#0f1f39}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1000px){.g2,.g3{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .box{border:1px solid #223049;border-radius:12px;padding:12px;background:var(--darkcell);color:var(--darkink)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto;border-radius:12px;border:1px solid #223049}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid #1f2937;font-size:14px;vertical-align:top}
  .table thead th{background:#0c1629;color:#a5b4fc;text-align:left;position:sticky;top:0}
  .table tbody tr:nth-child(even){background:var(--darkcell);color:var(--darkink2)}
  .table td.dark,.table th.dark{background:var(--darkcell)!important;color:var(--darkink2)!important}
  .out{background:var(--darkcell);color:var(--darkink2);border:1px dashed #263042;padding:10px 12px;border-radius:10px;word-break:break-all}
  input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#e6eef9}
  /* –ß–µ–∫ 58 –º–º */
  .ticket{width:58mm;background:#fff;color:#000;padding:6mm 4mm;border-radius:6px;box-shadow:0 0 0 1px #e5e7eb inset;font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px;font-size:13px;text-align:center}.ticket p{margin:2px 0;font-size:12px}.ticket .line{border-top:1px dashed #111;margin:6px 0}
  .ticket small{font-size:10px}
  /* –í–±—É–¥–æ–≤–∞–Ω–æ –≤ Moodle (iframe) ‚Üí —Å–≤—ñ—Ç–ª–∏–π –≤–∏–≥–ª—è–¥ */
  html.embedded body{background:#fff;color:#111}
  html.embedded .card{background:#fff;border:1px solid #e5e7eb;box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial;background:none;color:#111}
  html.embedded .box{background:#f8fafc;color:#111}
  html.embedded .table tbody tr:nth-child(even){background:#f3f4f6;color:#111}
  @media print{@page{margin:4mm}.no-print{display:none!important}}
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

</head>
<body>
<div class="wrap">
  <span class="badge">–ü–∞—Ä–∞ 1 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ ¬∑ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏ –ø–µ—Ä–µ—Ä–æ–±–∫–∏</span>
  <h1>üè∑Ô∏è –õ–æ—Ç, —Ç–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ —Ç–∞ –ø—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å: —á–µ–∫ 58 –º–º, NFC, CSV</h1>

  <div class="card">
    <h2>üéØ –ú–µ—Ç–∞ –ø–∞—Ä–∏</h2>
    <p>
      –ó–∞ –ø–∞—Ä—É —Å—Ç—É–¥–µ–Ω—Ç–∏ –Ω–∞–≤—á–∞—Ç—å—Å—è —Ñ–æ—Ä–º—É–≤–∞—Ç–∏ <b>–∫–æ–¥ –ø–∞—Ä—Ç—ñ—ó (–ª–æ—Ç)</b>, –æ–±–∏—Ä–∞—Ç–∏ <b>—É–º–æ–≤–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</b>,
      —Ä–æ–∑—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ <b>—Ç–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ</b> –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ç–∏–ø—É –ø—Ä–æ–¥—É–∫—Ç—É, –ø–∞–∫—É–≤–∞–Ω–Ω—è —Ç–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏,
      –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ <b>–µ—Ç–∏–∫–µ—Ç–∫—É 58 –º–º</b>, <b>NFC-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</b> —Ç–∞ –≤–µ—Å—Ç–∏ <b>CSV-–∂—É—Ä–Ω–∞–ª</b>.
    </p>
    <p class="small muted">–û—Å–Ω–æ–≤–∞: GS1-–ª–æ–≥—ñ–∫–∞ –¥–∞—Ç–∏ (–Æ–ª—ñ–∞–Ω—Å—å–∫–∏–π –¥–µ–Ω—å), –∑–º—ñ–Ω–∞/–ª—ñ–Ω—ñ—è, —á–∞—Å ‚Äú—á–∞—Å–æ–≤–æ–≥–æ –≤—ñ–∫–Ω–∞‚Äù,
      —É–º–æ–≤–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è (—Ö–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥), –≤–ø–ª–∏–≤ –ø–∞–∫—É–≤–∞–Ω–Ω—è (MAP/–≤–∞–∫—É—É–º) –Ω–∞ —Ç–µ—Ä–º—ñ–Ω.</p>
  </div>

  <!-- 1. –í–•–Ü–î–ù–Ü –î–ê–ù–Ü –ü–†–û–î–£–ö–¢–£ -->
  <div class="card">
    <h2>ü•õ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–∞—Ä—Ç—ñ—ó</h2>
    <div class="grid g3">
      <div class="box">
        <h3>–ü—Ä–æ–¥—É–∫—Ç —Ç–∞ –≤–∏–ø—É—Å–∫</h3>
        <div class="row">
          <div style="flex:1"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <select id="category">
              <option value="milk" selected>–ú–æ–ª–æ–∫–æ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–µ</option>
              <option value="yogurt">–ô–æ–≥—É—Ä—Ç (—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–Ω–∏–π)</option>
              <option value="sausage">–ö–æ–≤–±–∞—Å–∞ –≤–∞—Ä–µ–Ω–∞</option>
              <option value="minced">–§–∞—Ä—à –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–∏–π</option>
              <option value="butter">–í–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ</option>
              <option value="cheese">–°–∏—Ä —Ç–≤–µ—Ä–¥–∏–π</option>
            </select>
          </div>
          <div style="flex:1"><label>–¢–∏–ø –ø–∞–∫—É–≤–∞–Ω–Ω—è</label>
            <select id="pack">
              <option value="std" selected>–ó–≤–∏—á–∞–π–Ω–µ</option>
              <option value="vac">–í–∞–∫—É—É–º</option>
              <option value="map">MAP (–º–æ–¥–∏—Ñ. –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞)</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1"><label>–î–∞—Ç–∞ –≤–∏—Ä–æ–±–Ω.</label><input id="prodDate" type="date"></div>
          <div style="flex:1"><label>–ß–∞—Å –≤–∏—Ä–æ–±–Ω.</label><input id="prodTime" type="time"></div>
        </div>
      </div>

      <div class="box">
        <h3>–õ—ñ–Ω—ñ—è / –∑–º—ñ–Ω–∞ / —É–º–æ–≤–∏</h3>
        <div class="row">
          <div style="flex:1"><label>ID –ª—ñ–Ω—ñ—ó</label><input id="lineId" type="text" value="L1"></div>
          <div style="flex:1"><label>–ó–º—ñ–Ω–∞</label>
            <select id="shift">
              <option value="A" selected>A (06:00‚Äì14:00)</option>
              <option value="B">B (14:00‚Äì22:00)</option>
              <option value="C">C (22:00‚Äì06:00)</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1"><label>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–±–µ—Ä., ¬∞C</label><input id="temp" type="number" step="0.1" value="4"></div>
          <div style="flex:1"><label>–ó–∞–ø–∞—Å –Ω–∞ –ª–æ–≥—ñ—Å—Ç–∏–∫—É, –¥–Ω—ñ</label><input id="logReserve" type="number" step="1" value="1"></div>
        </div>
      </div>

      <div class="box">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç (–ª–æ—Ç/—Ç–µ—Ä–º—ñ–Ω)</h3>
        <p>–ö–æ–¥ –ø–∞—Ä—Ç—ñ—ó: <b><span id="lot">‚Äî</span></b></p>
        <p>‚Äú–í–∂–∏—Ç–∏ –¥–æ‚Äù / ‚Äú–ö—ñ–Ω—Ü. —Å–ø–æ–∂–∏–≤–∞—Ç–∏ –¥–æ‚Äù: <b><span id="expiry">‚Äî</span></b></p>
        <p>–£–º–æ–≤–∏: <b><span id="cond">‚Äî</span></b></p>
        <div class="row" style="margin-top:6px">
          <button class="btn" onclick="calcAll()">üîÅ –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
          <button class="btn" onclick="preset()">üß™ –ü—Ä–∏–∫–ª–∞–¥</button>
          <button class="btn" onclick="copyCSV('csvCore')">üìã CSV</button>
        </div>
        <div id="csvCore" class="out" style="margin-top:8px">‚Äî</div>
      </div>
    </div>
    <p class="small muted">–õ–æ—Ç (–ø—Ä–∏–∫–ª–∞–¥): <span class="mono">YYJJJ-L1-A-HHMM</span>, –¥–µ JJJ ‚Äî —é–ª—ñ–∞–Ω—Å—å–∫–∏–π –¥–µ–Ω—å —Ä–æ–∫—É.</p>
  </div>

  <!-- 2. –ñ–£–†–ù–ê–õ –ü–ê–†–¢–Ü–ô -->
  <div class="card">
    <h2>üìí –ñ—É—Ä–Ω–∞–ª –ø–∞—Ä—Ç—ñ–π</h2>
    <div class="row">
      <button class="btn" onclick="addRow()">‚ûï –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button>
      <button class="btn" onclick="presetRows()">üß™ –ü—Ä–∏–∫–ª–∞–¥</button>
      <button class="btn" onclick="copyCSV('csvLog')">üìã CSV (journal)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
            <th>–ü–∞–∫—É–≤–∞–Ω–Ω—è</th>
            <th class="dark">–õ–û–¢</th>
            <th class="dark">–í–∏—Ä–æ–±–Ω.</th>
            <th class="dark">–í–∂–∏—Ç–∏ –¥–æ</th>
            <th>–£–º–æ–≤–∏</th>
            <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
    <div id="csvLog" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 3. –ö–í–ò–¢–û–ö 58 –º–º + NFC -->
  <div class="card">
    <h2>üßæ –ö–≤–∏—Ç–æ–∫ 58 –º–º —Ç–∞ NFC</h2>
    <div class="grid g2">
      <div class="box">
        <h3>NFC ‚Äî ‚ÄúFOOD LOT CARD‚Äù</h3>
        <div class="row">
          <div style="flex:1"><label>–ö–æ–Ω—Ç–∞–∫—Ç/—Ç–µ—Ö–Ω.</label><input id="nfcPhone" type="text" value="+380XXXXXXXXX"></div>
          <div style="flex:1"><label>–û–±‚Äô—î–º –ø–∞—Ä—Ç—ñ—ó, –∫–≥</label><input id="batchKg" type="number" step="0.1" value="500"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" onclick="buildNFC()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
          <button class="btn" onclick="copyEl('nfcOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="nfcOut" class="out">‚Äî</div>
      </div>

      <div class="box">
        <h3>–ö–≤–∏—Ç–æ–∫ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ 58 –º–º</h3>
        <div class="row">
          <button class="btn" onclick="buildTicket()">üßæ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
          <button class="btn" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫</button>
        </div>
        <div class="ticket" id="ticket" style="margin-top:8px">
          <h4>LOT LABEL</h4>
          <p><b>–ü—Ä–æ–¥—É–∫—Ç:</b> <span id="tProd">‚Äî</span></p>
          <p><b>–ü–∞–∫—É–≤–∞–Ω–Ω—è:</b> <span id="tPack">‚Äî</span></p>
          <div class="line"></div>
          <p><b>–õ–û–¢:</b> <span id="tLot">‚Äî</span></p>
          <p><b>–í–∏—Ä–æ–±–Ω.:</b> <span id="tProdDT">‚Äî</span></p>
          <p><b>–í–∂–∏—Ç–∏ –¥–æ:</b> <span id="tExp">‚Äî</span></p>
          <p><b>–£–º–æ–≤–∏:</b> <span id="tCond">‚Äî</span></p>
          <div class="line"></div>
          <p>–õ—ñ–Ω—ñ—è: <span id="tLine">‚Äî</span> ¬∑ –ó–º—ñ–Ω–∞: <span id="tShift">‚Äî</span></p>
          <p>–ü–∞—Ä—Ç—ñ—è: <span id="tBatch">‚Äî</span> –∫–≥</p>
          <div class="line"></div>
          <p><small id="tNote">–°–∫–ª–∞–¥—É–≤–∞—Ç–∏ –ø—Ä–∏ –∑–∞–∑–Ω–∞—á–µ–Ω—ñ–π T. –•–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥ –Ω–µ –ø–µ—Ä–µ—Ä–∏–≤–∞—Ç–∏.</small></p>
        </div>
      </div>
    </div>
  </div>

  <!-- 4. –•–Ü–î –†–û–ë–û–¢–ò + –û–¶–Ü–ù–Æ–í–ê–ù–ù–Ø -->
  <div class="card">
    <h2>ü™ú –•—ñ–¥ —Ä–æ–±–æ—Ç–∏ (45‚Äì70 —Ö–≤)</h2>
    <ol>
      <li>–û–±–µ—Ä—ñ—Ç—å <b>–ø—Ä–æ–¥—É–∫—Ç</b>, <b>–ø–∞–∫—É–≤–∞–Ω–Ω—è</b>, –≤–Ω–µ—Å—ñ—Ç—å <b>–¥–∞—Ç—É/—á–∞—Å</b>, <b>–ª—ñ–Ω—ñ—é</b>, <b>–∑–º—ñ–Ω—É</b>, <b>—É–º–æ–≤–∏ T</b>.</li>
      <li>–ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ <b>–∫–æ–¥ –ª–æ—Ç—É</b> —Ç–∞ <b>—Ç–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ</b>, –¥–æ–¥–∞–π—Ç–µ 1‚Äì2 –ø–∞—Ä—Ç—ñ—ó –≤ <b>–∂—É—Ä–Ω–∞–ª</b>.</li>
      <li>–°—Ñ–æ—Ä–º—É–π—Ç–µ <b>NFC-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</b> —Ç–∞ <b>–∫–≤–∏—Ç–æ–∫ 58 –º–º</b> –¥–ª—è –¥—Ä—É–∫—É.</li>
      <li>–ï–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ <b>CSV</b> (—è–¥—Ä–æ —Ç–∞ –∂—É—Ä–Ω–∞–ª) —ñ –≤—Å—Ç–∞–≤—Ç–µ –≤ Google Sheets.</li>
    </ol>
  </div>

  <div class="card">
    <h2>‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
    <table class="table">
      <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä—ñ–π</th><th>–ë–∞–ª–∏</th></tr></thead>
      <tbody>
        <tr><td>–ö–æ—Ä–µ–∫—Ç–Ω–∏–π –∫–æ–¥ –ª–æ—Ç—É —Ç–∞ –¥–∞—Ç–∞ ‚Äú–≤–∂–∏—Ç–∏ –¥–æ‚Äù</td><td>4</td></tr>
        <tr><td>–ê–¥–µ–∫–≤–∞—Ç–Ω—ñ —É–º–æ–≤–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è / –ø–æ—è—Å–Ω–µ–Ω–Ω—è</td><td>3</td></tr>
        <tr><td>–ö–≤–∏—Ç–æ–∫ 58 –º–º —ñ NFC –∑—ñ–±—Ä–∞–Ω—ñ</td><td>2</td></tr>
        <tr><td>CSV-–∂—É—Ä–Ω–∞–ª –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–π</td><td>1</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle iFrame)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  const byId = id => document.getElementById(id);
  const rnd = (n,d=2)=>Number((+n).toFixed(d));
  const bodyEl = document.getElementById('body');

  // –ú–∞–ø–∏ –±–∞–∑–æ–≤–∏—Ö —Ç–µ—Ä–º—ñ–Ω—ñ–≤ (–¥–Ω—ñ–≤) –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—î—é –ø—Ä–∏ 0‚Ä¶+4¬∞C —É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø–∞–∫—É–≤–∞–Ω–Ω—ñ
  const baseShelf = {
    milk:   7,   // –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–µ –º–æ–ª–æ–∫–æ
    yogurt: 14,  // —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–Ω–∏–π –π–æ–≥—É—Ä—Ç
    sausage:10,  // –≤–∞—Ä–µ–Ω–∞ –∫–æ–≤–±–∞—Å–∞ –æ—Ö–æ–ª.
    minced: 2,   // —Ñ–∞—Ä—à
    butter: 60,  // –º–∞—Å–ª–æ
    cheese: 90   // —Ç–≤–µ—Ä–¥–∏–π —Å–∏—Ä –º–æ–ª–æ–¥–∏–π
  };
  // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ –ø–∞–∫—É–≤–∞–Ω–Ω—è
  const packMult = { std:1.0, vac:1.3, map:1.5 };
  // –ö–æ—Ä–µ–∫—Ü—ñ—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ (—Å–ø—Ä–æ—â–µ–Ω–æ): –∫–æ–∂–µ–Ω +2¬∞C –ø–æ–Ω–∞–¥ 4¬∞C —Å–∫–æ—Ä–æ—á—É—î ~20%; –∫–æ–∂–µ–Ω -2¬∞C –ø–æ–¥–æ–≤–∂—É—î ~10%
  function tempFactor(tempC){
    const ref = 4;
    const diff = tempC - ref;
    if(diff>=0) return Math.max(0.2, 1 - 0.2*(diff/2)); // –Ω–µ –Ω–∏–∂—á–µ 20% –≤—ñ–¥ –±–∞–∑–∏
    return 1 + 0.10*((-diff)/2);
  }

  function pad(n, w){ return (Array(w).join('0') + n).slice(-w); }
  function julianDay(date){
    const d0 = new Date(date.getFullYear(),0,0);
    const diff = date - d0;
    const oneDay = 1000*60*60*24;
    return Math.floor(diff/oneDay);
  }

  function productName(id){
    return {
      milk:'–ú–æ–ª–æ–∫–æ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–µ',
      yogurt:'–ô–æ–≥—É—Ä—Ç (—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–Ω–∏–π)',
      sausage:'–ö–æ–≤–±–∞—Å–∞ –≤–∞—Ä–µ–Ω–∞',
      minced:'–§–∞—Ä—à –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–∏–π',
      butter:'–ú–∞—Å–ª–æ –≤–µ—Ä—à–∫–æ–≤–µ',
      cheese:'–°–∏—Ä —Ç–≤–µ—Ä–¥–∏–π'
    }[id] || id;
  }
  function packName(id){
    return {std:'–ó–≤–∏—á–∞–π–Ω–µ', vac:'–í–∞–∫—É—É–º', map:'MAP'}[id] || id;
  }

  function calcAll(){
    // –ó—á–∏—Ç—É–≤–∞–Ω–Ω—è
    const cat = byId('category').value;
    const pck = byId('pack').value;
    const lineId = byId('lineId').value.trim() || 'L1';
    const shift = byId('shift').value;
    const temp = +byId('temp').value || 4;
    const rez = +byId('logReserve').value || 0;

    const pdStr = byId('prodDate').value;
    const ptStr = byId('prodTime').value;
    const now = new Date();
    const prod = (pdStr && ptStr) ? new Date(pdStr + 'T' + ptStr) :
                 (pdStr ? new Date(pdStr + 'T' + pad(now.getHours(),2)+':'+pad(now.getMinutes(),2)) : now);

    // –õ–û–¢: YYJJJ-LINE-SHIFT-HHMM
    const YY = String(prod.getFullYear()).slice(-2);
    const JJJ = pad(julianDay(prod),3);
    const HHMM = pad(prod.getHours(),2)+pad(prod.getMinutes(),2);
    const lot = `${YY}${JJJ}-${lineId}-${shift}-${HHMM}`;

    // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–µ—Ä–º—ñ–Ω—É
    const base = baseShelf[cat] || 7;
    const mult = packMult[pck] || 1.0;
    const tf = tempFactor(temp);
    const days = Math.max(1, Math.floor(base * mult * tf) - rez); // –∑–∞–ø–∞—Å –ª–æ–≥—ñ—Å—Ç–∏–∫–∏ –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ
    const expiry = new Date(prod); expiry.setDate(expiry.getDate() + days);

    const cond = (temp<=4) ? `–ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –ø—Ä–∏ 0‚Ä¶+4¬∞C` :
                 (temp<=6) ? `–ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –ø—Ä–∏ 0‚Ä¶+6¬∞C (—Å–∫–æ—Ä. —Ç–µ—Ä–º—ñ–Ω)` :
                             `–û–ë–ï–†–ï–ñ–ù–û: –ø–æ–Ω–∞–¥ +6¬∞C ‚Äî —Ö–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥ –ø–æ—Ä—É—à–µ–Ω–æ`;

    // –í–∏–≤—ñ–¥
    byId('lot').textContent = lot;
    byId('expiry').textContent = expiry.toISOString().slice(0,10);
    byId('cond').textContent = cond;

    const csv = [
      `CORE|${productName(cat)}|pack=${packName(pck)}|line=${lineId}|shift=${shift}|temp=${temp}C|reserve=${rez}d`,
      `LOT=${lot}|PROD=${prod.toISOString().slice(0,16)}|EXP=${expiry.toISOString().slice(0,10)}|DAYS=${days}|COND=${cond}`
    ].join('\n');
    byId('csvCore').textContent = csv;

    return {cat,pck,lineId,shift,temp,rez,prod,expiry,days,lot,cond};
  }

  // –ü—Ä–∏–∫–ª–∞–¥
  function preset(){
    const d = new Date();
    const iso = d.toISOString();
    byId('category').value = 'sausage';
    byId('pack').value = 'vac';
    byId('lineId').value = 'L2';
    byId('shift').value = 'B';
    byId('temp').value = 4;
    byId('logReserve').value = 1;
    byId('prodDate').value = iso.slice(0,10);
    byId('prodTime').value = iso.slice(11,16);
    calcAll();
  }

  // ===== –ñ–£–†–ù–ê–õ =====
  function addRow(sample){
    const r = calcAll();
    const def = {
      prod: productName(r.cat),
      pack: packName(r.pck),
      lot: r.lot,
      prodDT: r.prod.toISOString().slice(0,16).replace('T',' '),
      exp: r.expiry.toISOString().slice(0,10),
      cond: r.cond,
      note: ''
    };
    const s = Object.assign({}, def, sample||{});
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td><input type="text" value="${s.prod}"></td>
      <td>${s.pack}</td>
      <td class="dark">${s.lot}</td>
      <td class="dark">${s.prodDT}</td>
      <td class="dark">${s.exp}</td>
      <td>${s.cond}</td>
      <td><input type="text" value="${s.note}"></td>
    `;
    bodyEl.appendChild(tr); reindex(); buildCSVlog();
  }
  function reindex(){ [...bodyEl.querySelectorAll('tr')].forEach((tr,i)=>tr.querySelector('.idx').textContent=i+1); }
  function presetRows(){
    bodyEl.innerHTML='';
    const r = calcAll();
    addRow();
    // –î—Ä—É–≥–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∞ ‚Äî —Ñ–∞—Ä—à –ø—Ä–∏ +2¬∞C, MAP
    byId('category').value='minced'; byId('pack').value='map'; byId('temp').value=2;
    const r2 = calcAll();
    addRow({prod:productName('minced'), pack:packName('map'), lot:r2.lot, prodDT:r2.prod.toISOString().slice(0,16).replace('T',' '), exp:r2.expiry.toISOString().slice(0,10), cond:r2.cond, note:'–æ—Ö–æ–ª., MAP'});
    // –¢—Ä–µ—Ç—è ‚Äî –º–∞—Å–ª–æ –ø—Ä–∏ +6¬∞C, std (–ø–æ–∫–∞–∑–∞—Ç–∏ —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è)
    byId('category').value='butter'; byId('pack').value='std'; byId('temp').value=6;
    const r3 = calcAll();
    addRow({prod:productName('butter'), pack:packName('std'), lot:r3.lot, prodDT:r3.prod.toISOString().slice(0,16).replace('T',' '), exp:r3.expiry.toISOString().slice(0,10), cond:r3.cond, note:'–ø—ñ–¥–≤–∏—â–µ–Ω–∞ T'});
    buildCSVlog();
  }
  function buildCSVlog(){
    const lines = [...bodyEl.querySelectorAll('tr')].map(tr=>{
      const idx=tr.querySelector('.idx').textContent.trim();
      const prod=tr.children[1].querySelector('input').value.trim();
      const pack=tr.children[2].textContent.trim();
      const lot =tr.children[3].textContent.trim();
      const prd =tr.children[4].textContent.trim();
      const exp =tr.children[5].textContent.trim();
      const cond=tr.children[6].textContent.trim();
      const note=tr.children[7].querySelector('input').value.trim();
      return [idx,prod,pack,lot,prd,exp,cond,note].join(' | ');
    });
    byId('csvLog').textContent = lines.join('\n') || '‚Äî';
  }

  // ===== –ö–≤–∏—Ç–æ–∫ 58 –º–º / NFC =====
  function buildTicket(){
    const r = calcAll();
    byId('tProd').textContent = productName(r.cat);
    byId('tPack').textContent = packName(r.pck);
    byId('tLot').textContent  = r.lot;
    byId('tProdDT').textContent = r.prod.toISOString().slice(0,16).replace('T',' ');
    byId('tExp').textContent  = r.expiry.toISOString().slice(0,10);
    byId('tCond').textContent = r.cond;
    byId('tLine').textContent = r.lineId;
    byId('tShift').textContent= r.shift;
    byId('tBatch').textContent= byId('batchKg').value || '‚Äî';
  }
  function buildNFC(){
    const r = calcAll();
    const text = [
      `FOOD_LOT_NFC`,
      `PROD:${productName(r.cat)} | PACK:${packName(r.pck)}`,
      `LOT:${r.lot}`,
      `PROD:${r.prod.toISOString().slice(0,16).replace('T',' ')}`,
      `EXP:${r.expiry.toISOString().slice(0,10)} (DAYS=${r.days})`,
      `COND:${r.cond}`,
      `LINE:${r.lineId} SHIFT:${r.shift}`,
      `BATCH:${byId('batchKg').value||'‚Äî'}kg`,
      `CONTACT:${byId('nfcPhone').value}`,
      `STAMP:${new Date().toISOString().slice(0,19).replace('T',' ')}`
    ].join('\n');
    byId('nfcOut').textContent = text;
  }

  // ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
  function copyCSV(id){
    const t = document.getElementById(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è'); return; }
    navigator.clipboard.writeText(t).then(()=>flash('‚úÖ CSV —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'),()=>flash('–ù–µ –≤–¥–∞–ª–æ—Å—è'));
  }
  function copyEl(id){
    const t = byId(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'); return; }
    navigator.clipboard.writeText(t).then(()=>flash('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'),()=>flash('–ù–µ –≤–¥–∞–ª–æ—Å—è'));
  }
  function flash(msg){ const o=document.title; document.title=msg; setTimeout(()=>document.title=o,900); }

  // ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
  (function init(){
    // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–∞—Ç–∞/—á–∞—Å –∑–∞—Ä–∞–∑
    const now = new Date();
    byId('prodDate').value = now.toISOString().slice(0,10);
    byId('prodTime').value = now.toISOString().slice(11,16);
    calcAll();
    document.addEventListener('change', e=>{
      if(e.target.matches('input,select')) { calcAll(); buildCSVlog(); }
    });
  })();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>

</body>
</html>
