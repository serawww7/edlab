<!-- tech_para12.html
     –ü–ê–†–ê 12 (–∞—É–¥–∏—Ç–æ—Ä–Ω–æ) –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–≤ –∑ –ø–µ—Ä–µ—Ä–æ–±–∫–∏ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞
     –¢–µ–º–∞: –°–ö–õ–ê–î ‚Ä¢ FEFO/FIFO, –∞–¥—Ä–µ—Å–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è, –ø—Ä–∏–π–º–∞–Ω–Ω—è, –∫–æ–º–ø–ª–µ–∫—Ç—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å, –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è,
           –ø—ñ–∫—ñ–Ω–≥-–ª–∏—Å—Ç, –ø–ª–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –∫–≤–∏—Ç–æ–∫ 58 –º–º, QR/NFC, CSV.
     –§–æ–∫—É—Å: —Ç–µ–ª–µ—Ñ–æ–Ω–∏/–ü–ö; –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫; –≥–æ—Ç–æ–≤–æ –¥–ª—è GitHub Pages —Ç–∞ Moodle (iframe).
     –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è: —Ç–µ–ª–µ—Ñ–æ–Ω–∏; (–æ–ø—Ü.) —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä 58 –º–º; NFC-–º—ñ—Ç–∫–∏.

     –ü—Ä–∏–º—ñ—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É: —Ç–µ–º–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—å –º–∞—é—Ç—å —Å–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç (.dark).
     –£–í–ê–ì–ê: –Ω–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å. –†–µ–∞–ª—å–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ ‚Äî –∑–∞ –°–û–ü —Å–∫–ª–∞–¥—É, HACCP —Ç–∞ –≤–∏–º–æ–≥–∞–º–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤.
-->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 12 (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏) ‚Äî –°–∫–ª–∞–¥/FEFO: –ø—Ä–∏–π–º–∞–Ω–Ω—è, –∞–¥—Ä–µ—Å–∞—Ü—ñ—è, –ø—ñ–∫—ñ–Ω–≥, –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
    --accent:#22c55e; --accent-2:#60a5fa; --warn:#f59e0b; --bad:#ef4444; --good:#10b981; --line:#1f2937;
    --darkcell:#0b1324; --darkink:#e6eef9; --darkink2:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#111827 30%,#0b1220);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;line-height:1.55}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 64px}
  .badge{display:inline-block;padding:6px 10px;border:1px solid var(--line);background:#0b1220;border-radius:999px;
         font-size:12px;color:var(--muted);letter-spacing:.3px}
  h1{font-size:34px;margin:6px 0 12px;line-height:1.15;
     background:linear-gradient(90deg,#60a5fa,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  h2{font-size:22px;margin:28px 0 12px} h3{font-size:18px;margin:20px 0 8px;color:#cbd5e1}
  p{margin:10px 0}.small{font-size:12px;color:#9fb0c8}.muted{color:#93a3b5}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#dbeafe;text-decoration:none;cursor:pointer}
  .btn:hover{background:#0f1f39}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1000px){.g2,.g3{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .box{border:1px solid #223049;border-radius:12px;padding:12px;background:var(--darkcell);color:var(--darkink)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto;border-radius:12px;border:1px solid #223049}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid #1f2937;font-size:14px;vertical-align:top}
  .table thead th{background:#0c1629;color:#a5b4fc;text-align:left;position:sticky;top:0}
  .table tbody tr:nth-child(even){background:var(--darkcell);color:var(--darkink2)}
  .table td.dark,.table th.dark{background:var(--darkcell)!important;color:var(--darkink2)!important}
  .out{background:var(--darkcell);color:var(--darkink2);border:1px dashed #263042;padding:10px 12px;border-radius:10px;word-break:break-all}
  input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #223049;background:#0d1a2e;color:#e6eef9}
  textarea{min-height:84px}
  /* –ß–µ–∫ 58 –º–º */
  .ticket{width:58mm;background:#fff;color:#000;padding:6mm 4mm;border-radius:6px;box-shadow:0 0 0 1px #e5e7eb inset;font-family:"Courier New",ui-monospace,monospace}
  .ticket h4{margin:0 0 6px;font-size:13px;text-align:center}.ticket p{margin:2px 0;font-size:12px}.ticket .line{border-top:1px dashed #111;margin:6px 0}
  .ticket small{font-size:10px}
  /* –í–±—É–¥–æ–≤–∞–Ω–æ –≤ Moodle (iframe) ‚Üí —Å–≤—ñ—Ç–ª–∏–π –≤–∏–≥–ª—è–¥ */
  html.embedded body{background:#fff;color:#111}
  html.embedded .card{background:#fff;border:1px solid #e5e7eb;box-shadow:none}
  html.embedded h1{-webkit-text-fill-color:initial;background:none;color:#111}
  html.embedded .box{background:#f8fafc;color:#111}
  html.embedded .table tbody tr:nth-child(even){background:#f3f4f6;color:#111}
  @media print{@page{margin:4mm}.no-print{display:none!important}}
  .graph{font:12px/14px ui-monospace,monospace;white-space:pre;background:#fff;color:#000;padding:8px;border-radius:8px;border:1px solid #e5e7eb;overflow:auto}
</style>

<style>
/* PRINT PATCH v1 CSS (auto) */
.ticket{ font-weight:700; letter-spacing:0.1px }
.ticket h4{ font-weight:700 }
.ticket p,
.ticket b,
.ticket strong,
.ticket span,
.ticket small{ font-weight:700 }
</style>

</head>
<body>
<div class="wrap">
  <span class="badge">–ü–∞—Ä–∞ 12 ¬∑ –∞—É–¥–∏—Ç–æ—Ä–Ω–æ ¬∑ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏ –ø–µ—Ä–µ—Ä–æ–±–∫–∏</span>
  <h1>üè¨ –°–∫–ª–∞–¥/FEFO: –ø—Ä–∏–π–º–∞–Ω–Ω—è, –∞–¥—Ä–µ—Å–∞—Ü—ñ—è, –ø—ñ–∫—ñ–Ω–≥, –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –∫–≤–∏—Ç–æ–∫/QR/NFC/CSV</h1>

  <div class="card">
    <h2>üéØ –ú–µ—Ç–∞ –ø–∞—Ä–∏</h2>
    <p>
      –ó–∞ –∑–∞–Ω—è—Ç—Ç—è —Å—Ç—É–¥–µ–Ω—Ç–∏: (1) –ø—Ä–æ–≤–µ–¥—É—Ç—å <b>–ø—Ä–∏–π–º–∞–Ω–Ω—è</b> –ø–∞–ª–µ—Ç, (2) –≤–∏–∫–æ–Ω–∞—é—Ç—å <b>–∞–¥—Ä–µ—Å–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</b>,
      (3) —Å—Ñ–æ—Ä–º—É—é—Ç—å <b>–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞</b>, (4) –∑–∞–ø—É—Å—Ç—è—Ç—å <b>FEFO-–≤—ñ–¥–±—ñ—Ä</b> —Ç–∞ –∑–≥–µ–Ω–µ—Ä—É—é—Ç—å –ø—ñ–∫—ñ–Ω–≥-–ª–∏—Å—Ç,
      (5) —Å—Ñ–æ—Ä–º—É—é—Ç—å <b>–ø–ª–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</b> —ñ <b>–∂—É—Ä–Ω–∞–ª –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</b>, (6) —Å—Ç–≤–æ—Ä—è—Ç—å <b>CSV</b>, <b>QR/NFC</b> —ñ <b>–∫–≤–∏—Ç–æ–∫ 58 –º–º</b>.
    </p>
    <p class="small muted">–ù–∞–≤—á–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å. –ù–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ ‚Äî –¥–æ—Ç—Ä–∏–º—É–π—Ç–µ—Å—å FEFO/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∏—Ö —Ä–µ–∂–∏–º—ñ–≤, GS1-–µ—Ç–∏–∫–µ—Ç–æ–∫, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π –∑ –±–µ–∑–ø–µ–∫–∏.</p>
  </div>

  <!-- 1. –ü–ê–†–ê–ú–ï–¢–†–ò –°–ö–õ–ê–î–£ -->
  <div class="card">
    <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∫–ª–∞–¥—É —Ç–∞ –∞–¥—Ä–µ—Å–∏</h2>
    <div class="grid g3">
      <div class="box">
        <h3>–ó–æ–Ω–∏</h3>
        <div class="row">
          <div style="flex:1"><label>–•–æ–ª–æ–¥. –∑–æ–Ω–∞ (¬∞C)</label><input id="tCold" type="number" step="0.1" value="4.0"></div>
          <div style="flex:1"><label>–ó–∞–º–æ—Ä–æ–∑–∫–∞ (¬∞C)</label><input id="tFrz" type="number" step="0.1" value="-18.0"></div>
        </div>
        <p class="small muted">–ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä —É –∂—É—Ä–Ω–∞–ª—ñ; –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Äî —Ç—ñ–ª—å–∫–∏ –∑ —Ö–æ–ª–æ–¥. –∑–æ–Ω–∏ (–¥–ª—è –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–æ—ó –ø—Ä–æ–¥—É–∫—Ü—ñ—ó).</p>
      </div>

      <div class="box">
        <h3>–ê–¥—Ä–µ—Å–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏</h3>
        <p class="small muted">–§–æ—Ä–º–∞—Ç –∞–¥—Ä–µ—Å–∏: <span class="mono">–ó–û–ù–ê-–†–Ø–î-–ü–û–õ–ò–¶–Ø-–ú–Ü–°–¶–ï</span> (–Ω–∞–ø—Ä. <span class="mono">C1-A-02-03</span>).</p>
        <div class="row">
          <div style="flex:1"><label>–ü—Ä–µ—Ñ—ñ–∫—Å —Ö–æ–ª–æ–¥. –∑–æ–Ω–∏</label><input id="prefCold" type="text" value="C1"></div>
          <div style="flex:1"><label>–ü—Ä–µ—Ñ—ñ–∫—Å –∑–∞–º–æ—Ä–æ–∑–∫–∏</label><input id="prefFrz" type="text" value="F1"></div>
        </div>
      </div>

      <div class="box">
        <h3>–ö–µ—Ä—É–≤–∞–Ω–Ω—è</h3>
        <div class="row">
          <button class="btn" onclick="presetInbound()">üß™ –ü—Ä–∏–∫–ª–∞–¥ –ø—Ä–∏–π–º–∞–Ω–Ω—è</button>
          <button class="btn" onclick="copyCSV('csvInbound')">üìã CSV (inbound)</button>
        </div>
        <div id="csvInbound" class="out" style="margin-top:8px">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- 2. –ü–†–ò–ô–ú–ê–ù–ù–Ø (INBOUND) -->
  <div class="card">
    <h2>üöö –ü—Ä–∏–π–º–∞–Ω–Ω—è –ø–∞–ª–µ—Ç (Inbound)</h2>
    <div class="row">
      <button class="btn" onclick="addInbound()">‚ûï –î–æ–¥–∞—Ç–∏ –ø–∞–ª–µ—Ç—É</button>
      <button class="btn" onclick="assignLocation()">üì¶ –ü—Ä–∏—Å–≤–æ—ó—Ç–∏ –∞–¥—Ä–µ—Å—É</button>
      <button class="btn" onclick="copyCSV('csvStock')">üìã CSV (stock)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblInbound">
        <thead>
          <tr>
            <th>#</th>
            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
            <th class="dark">–õ–û–¢</th>
            <th class="dark">EXP</th>
            <th class="dark">–ö-—Ç—å, —è—â.</th>
            <th>–ê–¥—Ä–µ—Å–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyInbound"></tbody>
      </table>
    </div>
    <div id="csvStock" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 3. –ó–ê–ú–û–í–õ–ï–ù–ù–Ø –ö–õ–Ü–Ñ–ù–¢–ê -->
  <div class="card">
    <h2>üßæ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞</h2>
    <div class="row">
      <button class="btn" onclick="addOrder()">‚ûï –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
      <button class="btn" onclick="presetOrder()">üß™ –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      <button class="btn" onclick="copyCSV('csvOrder')">üìã CSV (order)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblOrder">
        <thead>
          <tr>
            <th>#</th>
            <th>–ö–ª—ñ—î–Ω—Ç</th>
            <th class="dark">–ü—Ä–æ–¥—É–∫—Ç</th>
            <th class="dark">–ü–æ—Ç—Ä—ñ–±–Ω–æ, —è—â.</th>
            <th>FEFO –í—ñ–¥–±—ñ—Ä</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyOrder"></tbody>
      </table>
    </div>
    <div id="csvOrder" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 4. FEFO –ü–Ü–ö–Ü–ù–ì-–õ–ò–°–¢ -->
  <div class="card">
    <h2>üìã FEFO –ø—ñ–∫—ñ–Ω–≥-–ª–∏—Å—Ç</h2>
    <div class="row">
      <button class="btn" onclick="runFEFO()">üßÆ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –≤—ñ–¥–±—ñ—Ä</button>
      <button class="btn" onclick="copyCSV('csvPick')">üìã CSV (picking)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblPick">
        <thead>
          <tr>
            <th>#</th>
            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
            <th class="dark">–õ–û–¢</th>
            <th class="dark">EXP</th>
            <th class="dark">–ê–¥—Ä–µ—Å–∞</th>
            <th>–í—ñ–¥—ñ–±—Ä–∞—Ç–∏, —è—â.</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyPick"></tbody>
      </table>
    </div>
    <div id="csvPick" class="out" style="margin-top:8px">‚Äî</div>
  </div>

  <!-- 5. –ü–õ–ê–ù –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø + –ö–í–ò–¢–û–ö 58 –º–º -->
  <div class="card">
    <h2>üöõ –ü–ª–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∫–≤–∏—Ç–æ–∫ 58 –º–º</h2>
    <div class="grid g2">
      <div class="box">
        <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ä–µ–π—Å—É</h3>
        <div class="row">
          <div style="flex:1"><label>–ù–æ–º–µ—Ä —Ä–µ–π—Å—É</label><input id="tripNo" type="text" value="R-251017-01"></div>
          <div style="flex:1"><label>–ü–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫</label><input id="carrier" type="text" value="–¢–û–í ¬´–•–æ–ª–æ–¥-–¢—Ä–∞–Ω—Å¬ª"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1"><label>t¬∞ –∫—É–∑–æ–≤–∞ (–ø–æ—á.)</label><input id="tStart" type="number" step="0.1" value="3.5"></div>
          <div style="flex:1"><label>t¬∞ –∫—É–∑–æ–≤–∞ (–∫—ñ–Ω.)</label><input id="tEnd" type="number" step="0.1" value="4.1"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="buildLoadPlan()">üì¶ –ü–æ–±—É–¥—É–≤–∞—Ç–∏ –ø–ª–∞–Ω</button>
          <button class="btn" onclick="copyCSV('csvLoad')">üìã CSV (load)</button>
        </div>
        <div id="loadOut" class="out" style="margin-top:8px">‚Äî</div>
        <div id="csvLoad" class="out" style="margin-top:8px">‚Äî</div>
      </div>

      <div class="box">
        <h3>–ö–≤–∏—Ç–æ–∫ 58 –º–º ‚Äî ‚ÄúLOAD & SHIP‚Äù</h3>
        <div class="row">
          <button class="btn" onclick="printTicket()">üßæ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
          <button class="btn" onclick="printTicketNewTab()">üñ®Ô∏è –î—Ä—É–∫</button>
        </div>
        <div class="ticket" id="ticket" style="margin-top:8px">
          <h4>LOAD & SHIP</h4>
          <p><b>–†–µ–π—Å:</b> <span id="tTrip">‚Äî</span></p>
          <p><b>–ü–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫:</b> <span id="tCar">‚Äî</span></p>
          <div class="line"></div>
          <p><b>–ó–∞–º–æ–≤–ª. –∫–ª—ñ—î–Ω—Ç:</b> <span id="tClient">‚Äî</span></p>
          <p><b>–ü–∞–ª–µ—Ç–∏:</b> <span id="tPals">‚Äî</span> ¬∑ <b>–Ø—â–∏–∫—ñ–≤:</b> <span id="tCases">‚Äî</span></p>
          <p><b>t¬∞ –∫—É–∑–æ–≤–∞:</b> <span id="tTstart">‚Äî</span>‚Üí<span id="tTend">‚Äî</span> ¬∞C</p>
          <div class="line"></div>
          <p><small>FEFO, —Ö–æ–ª–æ–¥–æ–≤–∏–π –ª–∞–Ω—Ü—é–≥, –æ–ø–ª–æ–º–±—É–≤–∞–Ω–Ω—è/–∂—É—Ä–Ω–∞–ª–∏ ‚Äî –∑–≥—ñ–¥–Ω–æ –°–û–ü.</small></p>
        </div>
      </div>
    </div>
  </div>

  <!-- 6. –ñ–£–†–ù–ê–õ / QR / NFC -->
  <div class="card">
    <h2>üìí –ñ—É—Ä–Ω–∞–ª –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—å / QR / NFC</h2>
    <div class="row">
      <button class="btn" onclick="addLog()">‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>
      <button class="btn" onclick="copyCSV('csvLog')">üìã CSV (journal)</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tblLog">
        <thead>
          <tr>
            <th>#</th>
            <th>–†–µ–π—Å</th>
            <th class="dark">–ö–ª—ñ—î–Ω—Ç</th>
            <th class="dark">–ü–∞–ª–µ—Ç</th>
            <th>–Ø—â–∏–∫—ñ–≤</th>
            <th>EXP –º—ñ–Ω.</th>
            <th>t¬∞</th>
            <th>√ó</th>
          </tr>
        </thead>
        <tbody id="bodyLog"></tbody>
      </table>
    </div>
    <div id="csvLog" class="out" style="margin-top:8px">‚Äî</div>

    <div class="grid g2" style="margin-top:12px">
      <div class="box">
        <h3>QR-payload</h3>
        <div class="row">
          <button class="btn" onclick="buildQR()">üß© –ó—ñ–±—Ä–∞—Ç–∏ QR</button>
          <button class="btn" onclick="copyEl('qrOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="qrOut" class="out">‚Äî</div>
      </div>
      <div class="box">
        <h3>NFC ‚Äî ‚ÄúLOAD CARD‚Äù</h3>
        <div class="row">
          <div style="flex:1"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input id="nfcPhone" type="text" value="+380XXXXXXXXX"></div>
          <div style="flex:1"><label>–í–æ–¥—ñ–π</label><input id="nfcDriver" type="text" value="–°—Ç—É–¥–µ–Ω—Ç –¢–ü–¢"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" onclick="buildNFC()">üß© –ó—ñ–±—Ä–∞—Ç–∏</button>
          <button class="btn" onclick="copyEl('nfcOut')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div id="nfcOut" class="out">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- 7. –•–Ü–î –†–û–ë–û–¢–ò + –û–¶–Ü–ù–Æ–í–ê–ù–ù–Ø -->
  <div class="card">
    <h2>ü™ú –•—ñ–¥ —Ä–æ–±–æ—Ç–∏ (45‚Äì70 —Ö–≤)</h2>
    <ol>
      <li>–°—Ç–≤–æ—Ä—ñ—Ç—å 4‚Äì8 –ø–∞–ª–µ—Ç (–ø—Ä–∏–π–º–∞–Ω–Ω—è) –∑ –ª–æ—Ç–æ–º/EXP/–∫—ñ–ª—å–∫—ñ—Å—Ç—é; –ø—Ä–∏—Å–≤–æ–π—Ç–µ –∞–¥—Ä–µ—Å–∏.</li>
      <li>–ó–∞–¥—å—Ç–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ (2‚Äì4 –ø–æ–∑–∏—Ü—ñ—ó); –≤–∏–∫–æ–Ω–∞–π—Ç–µ FEFO-–≤—ñ–¥–±—ñ—Ä, –∑–±–µ—Ä–µ–∂—ñ—Ç—å –ø—ñ–∫—ñ–Ω–≥-–ª–∏—Å—Ç.</li>
      <li>–ü–æ–±—É–¥—É–π—Ç–µ –ø–ª–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è; –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ t¬∞ –∫—É–∑–æ–≤–∞.</li>
      <li>–î–æ–¥–∞–π—Ç–µ –∑–∞–ø–∏—Å —É –∂—É—Ä–Ω–∞–ª, –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ QR/NFC —ñ –∫–≤–∏—Ç–æ–∫, —Å–∫–æ–ø—ñ—é–π—Ç–µ CSV.</li>
    </ol>
  </div>

  <div class="card">
    <h2>‚úÖ –û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (10 –±–∞–ª—ñ–≤)</h2>
    <table class="table">
      <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä—ñ–π</th><th>–ë–∞–ª–∏</th></tr></thead>
      <tbody>
        <tr><td>–ö–æ—Ä–µ–∫—Ç–Ω–µ –ø—Ä–∏–π–º–∞–Ω–Ω—è —Ç–∞ –∞–¥—Ä–µ—Å–∞—Ü—ñ—è –ø–∞–ª–µ—Ç</td><td>3</td></tr>
        <tr><td>FEFO-–≤—ñ–¥–±—ñ—Ä —ñ –ø—ñ–∫—ñ–Ω–≥-–ª–∏—Å—Ç</td><td>4</td></tr>
        <tr><td>–ü–ª–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è + –∫–≤–∏—Ç–æ–∫/NFC/QR</td><td>2</td></tr>
        <tr><td>–ñ—É—Ä–Ω–∞–ª/CSV</td><td>1</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // –í–±—É–¥–æ–≤–∞–Ω–∏–π —Ä–µ–∂–∏–º (Moodle iFrame)
  (function(){ if (window.self !== window.top) document.documentElement.classList.add('embedded'); })();

  const byId = id => document.getElementById(id);
  const rnd = (n,d=2)=>Number((+n).toFixed(d));

  function copyCSV(id){
    const t = document.getElementById(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è'); return; }
    navigator.clipboard.writeText(t);
  }
  function copyEl(id){
    const t = byId(id).textContent.trim();
    if(!t||t==='‚Äî'){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'); return; }
    navigator.clipboard.writeText(t);
  }
  function reindex(tb){ [...tb.querySelectorAll('tr')].forEach((tr,i)=>tr.querySelector('.idx').textContent=i+1); }

  // ===== 2) INBOUND =====
  const bodyInbound = byId('bodyInbound');
  function addInbound(sample){
    const s = Object.assign({prod:'', lot:'', exp:'', cases:0, addr:'', st:'–ø—Ä–∏–π–Ω—è—Ç–æ'}, sample||{});
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td><input type="text" value="${s.prod}"></td>
      <td class="dark"><input type="text" value="${s.lot}"></td>
      <td class="dark"><input type="date" value="${s.exp}"></td>
      <td class="dark"><input type="number" step="1" value="${s.cases}"></td>
      <td><input type="text" value="${s.addr}"></td>
      <td>${s.st}</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyInbound); buildCSV_Stock();">‚úñ</button></td>
    `;
    bodyInbound.appendChild(tr); reindex(bodyInbound); buildCSV_Inbound(); buildCSV_Stock();
  }
  function presetInbound(){
    bodyInbound.innerHTML='';
    const today = new Date();
    const d = dt => new Date(today.getTime()+dt*86400000).toISOString().slice(0,10);
    addInbound({prod:'–®–∏–Ω–∫–∞ –≤–∞—Ä–µ–Ω–∞ ‚Äú–î–æ–º–∞—à–Ω—è‚Äù 400–≥', lot:'H-25101-A1', exp:d(20), cases:40, addr:'', st:'–ø—Ä–∏–π–Ω—è—Ç–æ'});
    addInbound({prod:'–ö–æ–≤–±–∞—Å–∞ –≤–∞—Ä–µ–Ω–∞ ‚Äú–ö–ª–∞—Å–∏—á–Ω–∞‚Äù 500–≥', lot:'K-25100-B3', exp:d(15), cases:50, addr:'', st:'–ø—Ä–∏–π–Ω—è—Ç–æ'});
    addInbound({prod:'–°–æ—Å–∏—Å–∫–∏ –º–æ–ª–æ—á–Ω—ñ 450–≥', lot:'S-25098-C2', exp:d(10), cases:60, addr:'', st:'–ø—Ä–∏–π–Ω—è—Ç–æ'});
    addInbound({prod:'–ü–∞—à—Ç–µ—Ç –ø–µ—á—ñ–Ω–∫–æ–≤–∏–π 300–≥', lot:'P-25097-D1', exp:d(30), cases:35, addr:'', st:'–ø—Ä–∏–π–Ω—è—Ç–æ'});
    byId('csvInbound').textContent = 'PRESET INBOUND ‚Äî –¥–æ–¥–∞–Ω–æ 4 –ø–∞–ª–µ—Ç–∏';
  }
  function buildCSV_Inbound(){
    const rows=[...bodyInbound.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].querySelector('input').value.trim(),
        r.children[3].querySelector('input').value.trim(),
        r.children[4].querySelector('input').value.trim(),
        r.children[5].querySelector('input').value.trim(),
        r.children[6].textContent.trim()
      ].join(' | ');
    });
    byId('csvInbound').textContent = rows.join('\n') || '‚Äî';
  }
  function buildCSV_Stock(){
    const rows=[...bodyInbound.querySelectorAll('tr')].map(r=>{
      return [
        r.children[1].querySelector('input').value.trim(), // prod
        r.children[2].querySelector('input').value.trim(), // lot
        r.children[3].querySelector('input').value.trim(), // exp
        r.children[4].querySelector('input').value.trim(), // cases
        r.children[5].querySelector('input').value.trim(), // addr
        r.children[6].textContent.trim()                   // status
      ].join(' | ');
    });
    byId('csvStock').textContent = rows.join('\n') || '‚Äî';
  }
  function assignLocation(){
    const prefC = byId('prefCold').value.trim()||'C1';
    let row=1, shelf=1, spot=1;
    [...bodyInbound.querySelectorAll('tr')].forEach((r,i)=>{
      const addr = `${prefC}-${String.fromCharCode(65+(row-1))}-${String(shelf).padStart(2,'0')}-${String(spot).padStart(2,'0')}`;
      r.children[5].querySelector('input').value = addr;
      spot++; if(spot>4){ spot=1; shelf++; } if(shelf>6){ shelf=1; row++; }
    });
    buildCSV_Stock();
  }

  // ===== 3) ORDER =====
  const bodyOrder = byId('bodyOrder');
  function addOrder(sample){
    const s = Object.assign({client:'–¢–û–í ¬´–†—ñ—Ç–µ–π–ª-–ú–∞—Ä–∫–µ—Ç¬ª', prod:'', need:0, pick:''}, sample||{});
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td><input type="text" value="${s.client}"></td>
      <td class="dark"><input type="text" value="${s.prod}"></td>
      <td class="dark"><input type="number" step="1" value="${s.need}"></td>
      <td class="pick">‚Äî</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyOrder); buildCSV_Order();">‚úñ</button></td>
    `;
    bodyOrder.appendChild(tr); reindex(bodyOrder); buildCSV_Order();
  }
  function presetOrder(){
    bodyOrder.innerHTML='';
    addOrder({client:'–¢–û–í ¬´–†—ñ—Ç–µ–π–ª-–ú–∞—Ä–∫–µ—Ç¬ª', prod:'–°–æ—Å–∏—Å–∫–∏ –º–æ–ª–æ—á–Ω—ñ 450–≥', need:70});
    addOrder({client:'–¢–û–í ¬´–†—ñ—Ç–µ–π–ª-–ú–∞—Ä–∫–µ—Ç¬ª', prod:'–ö–æ–≤–±–∞—Å–∞ –≤–∞—Ä–µ–Ω–∞ ‚Äú–ö–ª–∞—Å–∏—á–Ω–∞‚Äù 500–≥', need:40});
    buildCSV_Order();
  }
  function buildCSV_Order(){
    const rows=[...bodyOrder.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].querySelector('input').value.trim(),
        r.children[2].querySelector('input').value.trim(),
        r.children[3].querySelector('input').value.trim(),
        r.children[4].textContent.trim()
      ].join(' | ');
    });
    byId('csvOrder').textContent = rows.join('\n') || '‚Äî';
  }

  // ===== 4) FEFO =====
  const bodyPick = byId('bodyPick');
  function runFEFO(){
    bodyPick.innerHTML='';
    const stock = [...bodyInbound.querySelectorAll('tr')].map(r=>({
      prod: r.children[1].querySelector('input').value.trim(),
      lot:  r.children[2].querySelector('input').value.trim(),
      exp:  r.children[3].querySelector('input').value.trim(),
      cases:+r.children[4].querySelector('input').value||0,
      addr: r.children[5].querySelector('input').value.trim(),
      st:   r.children[6].textContent.trim()
    })).filter(x=>x.prod && x.cases>0 && x.st!=='–≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');

    const orders = [...bodyOrder.querySelectorAll('tr')].map(r=>({
      client: r.children[1].querySelector('input').value.trim(),
      prod:   r.children[2].querySelector('input').value.trim(),
      need:  +r.children[3].querySelector('input').value||0
    })).filter(x=>x.prod && x.need>0);

    // –î–ª—è –∫–æ–∂–Ω–æ—ó –ø–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: –±–µ—Ä–µ–º–æ –∑—ñ —Å–∫–ª–∞–¥—É —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º –∑–∞ –Ω–∞–π—Ä–∞–Ω—ñ—à–æ—é EXP (FEFO)
    orders.forEach(o=>{
      const pool = stock.filter(s=>s.prod===o.prod).sort((a,b)=> new Date(a.exp) - new Date(b.exp));
      let remain = o.need;
      const pickLines=[];
      for(const p of pool){
        if(remain<=0) break;
        const take = Math.min(remain, p.cases);
        if(take>0){
          pickLines.push({prod:o.prod, lot:p.lot, exp:p.exp, addr:p.addr||'‚Äî', take});
          p.cases -= take; remain -= take;
        }
      }
      // –ó–∞–ø–∏—Å —É —Ç–∞–±–ª–∏—Ü—é –≤—ñ–¥–±–æ—Ä—É
      pickLines.forEach(addPickLine);
      // –í—ñ–¥–º—ñ—Ç–∫–∞ —É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ
      const row = [...bodyOrder.querySelectorAll('tr')].find(r=>r.children[2].querySelector('input').value.trim()===o.prod);
      if(row){
        row.querySelector('.pick').textContent = pickLines.length
          ? pickLines.map(pl=>`${pl.take} —è—â. –∑ ${pl.lot} (${pl.exp})@${pl.addr}`).join('; ')
          : '–Ω/–¥';
      }
    });

    buildCSV_Pick(); buildCSV_Order();
  }
  function addPickLine(s){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td>${s.prod}</td>
      <td class="dark">${s.lot}</td>
      <td class="dark">${s.exp}</td>
      <td class="dark">${s.addr||'‚Äî'}</td>
      <td>${s.take}</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyPick); buildCSV_Pick();">‚úñ</button></td>
    `;
    bodyPick.appendChild(tr); reindex(bodyPick);
  }
  function buildCSV_Pick(){
    const rows=[...bodyPick.querySelectorAll('tr')].map(r=>{
      return [
        r.querySelector('.idx').textContent.trim(),
        r.children[1].textContent.trim(),
        r.children[2].textContent.trim(),
        r.children[3].textContent.trim(),
        r.children[4].textContent.trim(),
        r.children[5].textContent.trim()
      ].join(' | ');
    });
    byId('csvPick').textContent = rows.join('\n') || '‚Äî';
  }

  // ===== 5) LOAD / TICKET =====
  function buildLoadPlan(){
    const picks=[...bodyPick.querySelectorAll('tr')].map(r=>({
      prod:r.children[1].textContent.trim(),
      lot:r.children[2].textContent.trim(),
      exp:r.children[3].textContent.trim(),
      addr:r.children[4].textContent.trim(),
      take:+r.children[5].textContent.trim()||0
    }));
    if(!picks.length){ byId('loadOut').textContent='‚Äî —Å–ø–æ—á–∞—Ç–∫—É —Å—Ñ–æ—Ä–º—É–π—Ç–µ FEFO-–≤—ñ–¥–±—ñ—Ä ‚Äî'; byId('csvLoad').textContent='‚Äî'; return; }
    // –ì—Ä—É–ø—É—î–º–æ –ø–æ –ª–æ—Ç—É ‚Üí –ø–∞–ª–µ—Ç–∞ (—Å–ø—Ä–æ—â–µ–Ω–æ: –∫–æ–∂–µ–Ω –ª–æ—Ç = –ø–∞–ª–µ—Ç–∞)
    const map=new Map();
    picks.forEach(p=>{
      const k=p.lot; if(!map.has(k)) map.set(k,{cases:0, prod:p.prod, lot:p.lot, exp:p.exp});
      map.get(k).cases += p.take;
    });
    const lines=[], csv=[];
    let cases=0;
    map.forEach(v=>{
      lines.push(`–ü–∞–ª–µ—Ç–∞ ${v.lot} [${v.prod}] EXP ${v.exp} ‚Üí ${v.cases} —è—â.`);
      csv.push(`LOAD|${v.lot}|${v.prod}|exp=${v.exp}|cases=${v.cases}`);
      cases+=v.cases;
    });
    byId('loadOut').textContent = lines.join('\n');
    byId('csvLoad').textContent = csv.join('\n');

    // –û–Ω–æ–≤–∏–º–æ –∫–≤–∏—Ç–æ–∫
    const client = [...bodyOrder.querySelectorAll('tr')][0]?.children[1].querySelector('input').value.trim() || '‚Äî';
    byId('tTrip').textContent = byId('tripNo').value;
    byId('tCar').textContent  = byId('carrier').value;
    byId('tClient').textContent= client;
    byId('tPals').textContent = map.size;
    byId('tCases').textContent= cases;
    byId('tTstart').textContent = byId('tStart').value;
    byId('tTend').textContent   = byId('tEnd').value;
  }
  function printTicket(){
    const el = document.getElementById('ticket');
    el.scrollIntoView({behavior:'smooth',block:'center'});
  }

  // ===== 6) JOURNAL / QR / NFC =====
  const bodyLog = byId('bodyLog');
  function addLog(){
    const client = [...bodyOrder.querySelectorAll('tr')][0]?.children[1].querySelector('input').value.trim() || '‚Äî';
    const expMin = (()=> {
      const exps = [...bodyPick.querySelectorAll('tr')].map(r=>r.children[3].textContent.trim()).filter(Boolean);
      return exps.length ? exps.sort()[0] : '‚Äî';
    })();
    const pals = byId('tPals').textContent || '0';
    const cases = byId('tCases').textContent || '0';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idx">1</td>
      <td><input type="text" value="${byId('tripNo').value}"></td>
      <td class="dark">${client}</td>
      <td class="dark">${pals}</td>
      <td>${cases}</td>
      <td>${expMin}</td>
      <td>${byId('tStart').value}‚Üí${byId('tEnd').value}</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); reindex(bodyLog); buildCSV_Log();">‚úñ</button></td>
    `;
    bodyLog.appendChild(tr); reindex(bodyLog); buildCSV_Log();
  }
  function buildCSV_Log(){
    const rows=[...bodyLog.querySelectorAll('tr')].map(r=>{
      const idx=r.querySelector('.idx').textContent.trim();
      const trip=r.children[1].querySelector('input').value.trim();
      const client=r.children[2].textContent.trim();
      const pals=r.children[3].textContent.trim();
      const cases=r.children[4].textContent.trim();
      const exp=r.children[5].textContent.trim();
      const t=r.children[6].textContent.trim();
      return [idx,trip,client,pals,cases,exp,t].join(' | ');
    });
    byId('csvLog').textContent = rows.join('\n') || '‚Äî';
  }
  function buildQR(){
    const payload = {
      trip: byId('tripNo').value,
      carrier: byId('carrier').value,
      client: [...bodyOrder.querySelectorAll('tr')][0]?.children[1].querySelector('input').value.trim() || '‚Äî',
      pallets: byId('tPals').textContent || '0',
      cases: byId('tCases').textContent || '0',
      t_start: byId('tStart').value,
      t_end: byId('tEnd').value
    };
    byId('qrOut').textContent = JSON.stringify(payload);
  }
  function buildNFC(){
    const txt = [
      `LOAD_CARD`,
      `TRIP:${byId('tripNo').value} CARRIER:${byId('carrier').value}`,
      `CLIENT:${[...bodyOrder.querySelectorAll('tr')][0]?.children[1].querySelector('input').value.trim() || '‚Äî'}`,
      `PALLETS:${byId('tPals').textContent||'0'} CASES:${byId('tCases').textContent||'0'}`,
      `T_DEG:${byId('tStart').value}->${byId('tEnd').value}C`,
      `CONTACT:${byId('nfcPhone').value} DRIVER:${byId('nfcDriver').value}`,
      `STAMP:${new Date().toISOString().slice(0,19).replace('T',' ')}`
    ].join('\n');
    byId('nfcOut').textContent = txt;
  }

  // ===== INIT =====
  (function init(){
    presetInbound(); assignLocation(); presetOrder(); runFEFO(); buildLoadPlan();
    document.addEventListener('change', e=>{
      if(e.target.matches('input,select,textarea')){
        if(e.target.closest('#tblInbound')){ buildCSV_Inbound(); buildCSV_Stock(); }
        if(e.target.closest('#tblOrder')){ buildCSV_Order(); }
      }
    });
  })();
</script>

<script>
// PRINT PATCH v1 (auto)
function printTicketNewTab(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; padding:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .ticket b,.ticket strong,.ticket span{ font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
  <script>
    window.addEventListener('load',()=>{
      try{ window.focus(); window.print(); if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'invoked'},'*'); }
      catch(e){ if(window.opener) window.opener.postMessage({type:'ticketPrint',status:'error'},'*'); }
    });
  <\/script>
  </body></html>`;

  var w = window.open('', '_blank');
  if(!w){ openTicketOnly(); return; }  // –ø–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî —Ñ–æ–ª–±–µ–∫
  w.document.open(); w.document.write(html); w.document.close();

  var timer = setTimeout(()=>{ openTicketOnly(); }, 1200);
  window.addEventListener('message', (ev)=>{
    if(ev && ev.data && ev.data.type==='ticketPrint'){ clearTimeout(timer); }
  }, {once:true});
}

function openTicketOnly(){
  var ticket = document.getElementById('ticket');
  if(!ticket){ alert('–ù–µ–º–∞—î #ticket –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ'); return; }
  try{
    var someTxt = (document.querySelector('#ticket span, #ticket p, #ticket h4')||{}).textContent||'';
    if(!someTxt || someTxt.trim()==='‚Äî'){ if(typeof buildTicket==='function') buildTicket(); }
  }catch(_){}

  var css = `
    @media print { @page { size:58mm auto; margin:0 } }
    html,body{ margin:0; background:#fff; color:#000 }
    .ticket{
      width:58mm; margin:0; padding:6mm 4mm; background:#fff; color:#000;
      font-family:"Courier New", Courier, monospace; font-weight:700; letter-spacing:0.1px;
      border:none; box-shadow:none; border-radius:0
    }
    .ticket h4{ margin:0 0 6px; font-size:13px; text-align:center; font-weight:700 }
    .ticket p{ margin:2px 0; font-size:12px; font-weight:700 }
    .line{ border-top:1px dashed #111; margin:6px 0 }
    small{ font-size:10px; font-weight:700 }
  `;
  var html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ß–µ–∫ 58 –º–º</title><style>${css}</style></head><body>${ticket.outerHTML}
<script>window.addEventListener('load',()=>{ try{ window.focus(); window.print(); }catch(e){} });<\/script>
</body></html>`;

  var blob = new Blob([html], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}
</script>

</body>
</html>
