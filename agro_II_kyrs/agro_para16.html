<!DOCTYPE html><html lang="uk"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–∞—Ä–∞ 16 ‚Äî Arduino: —Å–µ–Ω—Å–æ—Ä –≤–æ–ª–æ–≥–æ—Å—Ç—ñ “ë—Ä—É–Ω—Ç—É (–∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è, %RHsoil, –ª–æ–≥)</title>
<meta name="description" content="–ö–∞–ª—ñ–±—Ä—É—î–º–æ —î–º–Ω—ñ—Å–Ω–∏–π –¥–∞—Ç—á–∏–∫ –≤–æ–ª–æ–≥–æ—Å—Ç—ñ “ë—Ä—É–Ω—Ç—É: ADC‚Üí% –≤–æ–ª–æ–≥–æ—Å—Ç—ñ, —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è, –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è, –≥—Ä–∞—Ñ—ñ–∫, –µ–∫—Å–ø–æ—Ä—Ç CSV/TXT. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ .ino —ñ —Å—Ö–µ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.btn.warn{border-color:#513a14;background:#2a1f0a}
.btn:disabled{opacity:.6;cursor:not-allowed}
.input, select, textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
small.mono, .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas,"Courier New",monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
hr.sep{border:none;border-top:1px solid var(--line);margin:16px 0}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
svg{max-width:100%;height:auto;display:block}
pre.code{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:260px}
label>span.hint{color:var(--muted);font-size:.9rem}
.switch{display:flex;align-items:center;gap:8px}
.switch input{width:42px}
</style>
<link rel="canonical" href="https://edlab.pp.ua/agro_II_kyrs/agro_para16.html"><meta property="og:type" content="article"><meta property="og:title" content="–ê–≥—Ä–æ–Ω–æ–º—ñ—è ‚Äî –ü–∞—Ä–∞ 16"><meta property="og:description" content="–ú–µ—Ç–∞: –∑–Ω—è—Ç–∏ –∫–∞–ª—ñ–±—Ä—É–≤–∞–ª—å–Ω—ñ —Ç–æ—á–∫–∏ ¬´—Å—É—Ö–æ/–º–æ–∫—Ä–æ¬ª, –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ ADC —É % –≤–æ–ª–æ–≥–æ—Å—Ç—ñ, –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è —Ç–∞ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è, –≤–µ—Å—Ç–∏ –ª–æ–≥ —É —Ñ–æ—Ä–º–∞—Ç—ñ CSV"><meta property="og:url" content="https://edlab.pp.ua/agro_II_kyrs/agro_para16.html"><script type="application/ld+json">{"@context":"https://schema.org","@type":"LearningResource","name":"–ê–≥—Ä–æ–Ω–æ–º—ñ—è ‚Äî –ü–∞—Ä–∞ 16","description":"–ú–µ—Ç–∞: –∑–Ω—è—Ç–∏ –∫–∞–ª—ñ–±—Ä—É–≤–∞–ª—å–Ω—ñ —Ç–æ—á–∫–∏ ¬´—Å—É—Ö–æ/–º–æ–∫—Ä–æ¬ª, –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ ADC —É % –≤–æ–ª–æ–≥–æ—Å—Ç—ñ, –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è —Ç–∞ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è, –≤–µ—Å—Ç–∏ –ª–æ–≥ —É —Ñ–æ—Ä–º–∞—Ç—ñ CSV","inLanguage":"uk","educationalLevel":"college","url":"https://edlab.pp.ua/agro_II_kyrs/agro_para16.html","provider":{"@type":"Organization","name":"EDLab"}}</script></head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üå±</span>
      <div>
        <b>–ü–∞—Ä–∞ 16 ‚Äî Arduino: —Å–µ–Ω—Å–æ—Ä –≤–æ–ª–æ–≥–æ—Å—Ç—ñ “ë—Ä—É–Ω—Ç—É</b><br>
        <span class="badge">–ê–≥—Ä–æ–Ω–æ–º—ñ—è ¬∑ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è ‚Üí % –≤–æ–ª–æ–≥–æ—Å—Ç—ñ ‚Üí –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è ‚Üí –ª–æ–≥</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –∑–Ω—è—Ç–∏ <b>–∫–∞–ª—ñ–±—Ä—É–≤–∞–ª—å–Ω—ñ —Ç–æ—á–∫–∏</b> ¬´—Å—É—Ö–æ/–º–æ–∫—Ä–æ¬ª, –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ ADC —É <b>% –≤–æ–ª–æ–≥–æ—Å—Ç—ñ</b>, –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ <b>—É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è</b> —Ç–∞ <b>–µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è</b>, –≤–µ—Å—Ç–∏ –ª–æ–≥ —É —Ñ–æ—Ä–º–∞—Ç—ñ CSV —ñ –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–≤—ñ—Ç. –ë–µ–∑ ¬´–∑–∞–ª—ñ–∑–∞¬ª –º–æ–∂–Ω–∞ —É–≤—ñ–º–∫–Ω—É—Ç–∏ <b>–µ–º—É–ª—è—Ç–æ—Ä</b> –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è –∞–ª–≥–æ—Ä–∏—Ç–º—É.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û: –∫—Ä–æ–∫–∏ + –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è + –≥—Ä–∞—Ñ—ñ–∫ -->
    <div class="card">
      <h2>üîß –ö—Ä–æ–∫–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó</h2>
      <ol>
        <li>–ó–±–µ—Ä—ñ—Ç—å —Å—Ö–µ–º—É (–ø—Ä–∞–≤–æ—Ä—É—á). –í–∏—Ö—ñ–¥ —Å–µ–Ω—Å–æ—Ä–∞ ‚Üí <b>A0</b>, –∂–∏–≤–ª–µ–Ω–Ω—è 5V/GND.</li>
        <li>–ó–Ω—ñ–º—ñ—Ç—å –ø–æ–∫–∞–∑ ¬´<b>—Å—É—Ö–æ</b>¬ª: –≤–∏—Ç—Ä—ñ—Ç—å –¥–∞—Ç—á–∏–∫, —Ç—Ä–∏–º–∞–π—Ç–µ –≤ –ø–æ–≤—ñ—Ç—Ä—ñ ‚Üí –∑–∞–ø–∏—à—ñ—Ç—å <span class="mono">ADCdry</span>.</li>
        <li>–ó–Ω—ñ–º—ñ—Ç—å –ø–æ–∫–∞–∑ ¬´<b>–º–æ–∫—Ä–æ</b>¬ª: —É –≤–æ–ª–æ–≥–æ–º—É “ë—Ä—É–Ω—Ç—ñ/–≤–æ–¥—ñ (–ø—ñ–¥—Ä—ñ–≤–Ω—è—Ç–∏ –±–µ–∑ –±—É–ª—å–±–∞—à–æ–∫) ‚Üí <span class="mono">ADCwet</span>.</li>
        <li>–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è —ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è ‚Üí –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ —Å–∫–µ—Ç—á ‚Üí –ø—Ä–æ—à–∏–π—Ç–µ ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≥—Ä–∞—Ñ—ñ–∫/–ª–æ–≥.</li>
      </ol>

      <h3>üß™ –ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏</h3>
      <div class="row">
        <div style="flex:1">
          <label for="dry">ADC ¬´—Å—É—Ö–æ¬ª <span class="hint">(–Ω–∞–ø—Ä. 3000 –∞–±–æ 800 –¥–ª—è 10-–±—ñ—Ç)</span></label>
          <input id="dry" class="input" type="number" min="10" max="4095" value="3000">
        </div>
        <div style="flex:1">
          <label for="wet">ADC ¬´–º–æ–∫—Ä–æ¬ª <span class="hint">(–Ω–∞–ø—Ä. 800 –∞–±–æ 500)</span></label>
          <input id="wet" class="input" type="number" min="10" max="4095" value="800">
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label for="avg">–£—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è, –∑—Ä–∞–∑–∫—ñ–≤</label>
          <input id="avg" class="input" type="number" min="1" max="50" value="10">
        </div>
        <div style="flex:1">
          <label for="alpha">–ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è Œ± (0..1)</label>
          <input id="alpha" class="input" type="number" step="0.05" min="0" max="1" value="0.3">
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label for="ain">–ê–Ω–∞–ª–æ–≥–æ–≤–∏–π –ø—ñ–Ω —Å–µ–Ω—Å–æ—Ä–∞</label>
          <select id="ain" class="input">
            <option value="A0" selected="">A0</option><option value="A1">A1</option><option value="A2">A2</option><option value="A3">A3</option>
          </select>
        </div>
        <div style="flex:1">
          <label for="period">–ü–µ—Ä—ñ–æ–¥ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, –º—Å</label>
          <input id="period" class="input" type="number" min="100" max="5000" step="100" value="1000">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="switch">
          <input id="emu" type="checkbox">
          <label for="emu">–ï–º—É–ª—è—Ç–æ—Ä –±–µ–∑ Arduino (–ø–æ–≤–∑—É–Ω–æ–∫ –Ω–∏–∂—á–µ)</label>
        </div>
        <input id="emuSlider" class="input" type="range" min="400" max="3400" value="2100" disabled="">
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn good" id="gen">‚öôÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å–∫–µ—Ç—á</button>
        <button class="btn secondary" id="copy">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥</button>
        <button class="btn secondary" id="dl">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ .ino</button>
      </div>

      <h3 style="margin-top:12px">üìà –ñ–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ (–µ–º—É–ª—å–æ–≤–∞–Ω–∏–π –∞–±–æ –∑—á–∏—Ç–∞–Ω–∏–π –≤—Ä—É—á–Ω—É)</h3>
      <div class="canvasWrap">
        <canvas id="chart" width="900" height="260"></canvas>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addPoint">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É (–∑—á–∏—Ç–∞—Ç–∏ ADC/–µ–º—É–ª—è—Ç–æ—Ä)</button>
        <button class="btn secondary" id="clearChart">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
        <span class="muted mono" id="lastVal">ADC=‚Äî ‚Üí  ‚Äî %</span>
      </div>

      <h3 style="margin-top:12px">üß© –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥ (Arduino .ino)</h3>
      <pre class="code"><code id="code">// –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å–∫–µ—Ç—á¬ª ‚Üë</code></pre>

      <h3 style="margin-top:12px">üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ–∫–æ–ª—É –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è</h3>
      <div class="row">
        <input id="fio" class="input" placeholder="–ü–Ü–ë —Å—Ç—É–¥–µ–Ω—Ç–∞">
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="saveCsv">üìÑ CSV</button>
      </div>
    </div>

    <!-- –ü–†–ê–í–û: —Å—Ö–µ–º–∞ + –Ω–æ—Ç–∞—Ç–∫–∏ -->
    <div class="card">
      <h2>üîå –°—Ö–µ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (SVG)</h2>
      <svg viewBox="0 0 760 360" role="img" aria-label="–°—Ö–µ–º–∞ Arduino + Soil sensor">
        <!-- –ü–ª–∞—Ç–∞ -->
        <rect x="40" y="40" width="220" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"></rect>
        <text x="150" y="65" fill="#e5e7eb" font-size="16" text-anchor="middle">Arduino UNO/Nano</text>
        <text x="55" y="95" fill="#93c5fd" font-size="12">5V</text>
        <text x="55" y="115" fill="#93c5fd" font-size="12">GND</text>
        <text x="55" y="135" fill="#93c5fd" font-size="12">A0</text>

        <!-- –°–µ–Ω—Å–æ—Ä -->
        <rect x="320" y="40" width="200" height="100" rx="12" fill="#14532d" stroke="#22c55e"></rect>
        <text x="420" y="70" fill="#dcfce7" font-size="16" text-anchor="middle">–Ñ–º–Ω—ñ—Å–Ω–∏–π —Å–µ–Ω—Å–æ—Ä</text>
        <text x="420" y="90" fill="#a7f3d0" font-size="12" text-anchor="middle">VCC ‚Äî OUT ‚Äî GND</text>

        <!-- –ó‚Äô—î–¥–Ω–∞–Ω–Ω—è -->
        <line x1="260" y1="90" x2="320" y2="60" stroke="#93c5fd" stroke-width="3"></line><text x="280" y="80" fill="#93c5fd" font-size="12">5V ‚Üí VCC</text>
        <line x1="260" y1="110" x2="320" y2="100" stroke="#64748b" stroke-width="3"></line><text x="280" y="110" fill="#94a3b8" font-size="12">GND ‚Üí GND</text>
        <line x1="260" y1="130" x2="320" y2="80" stroke="#22c55e" stroke-width="3"></line><text x="280" y="95" fill="#86efac" font-size="12">A0 ‚Üê OUT</text>
      </svg>

      <div class="note" style="margin-top:10px">
        <b>–ü–æ—Ä–∞–¥–∞:</b> —î–º–Ω—ñ—Å–Ω–∏–π –¥–∞—Ç—á–∏–∫ –º–µ–Ω—à —á—É—Ç–ª–∏–≤–∏–π –¥–æ –∫–æ—Ä–æ–∑—ñ—ó, –∞–ª–µ —Ç–µ–∂ –Ω–µ –ª—é–±–∏—Ç—å ¬´–∑–∞–ª–∏–≤–∞–Ω–Ω—è¬ª –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∏. –¢—Ä–∏–º–∞–π –ø–ª–∞—Ç—É –≤–∏—â–µ —Ä—ñ–≤–Ω—è –≤–æ–ª–æ–≥–∏, –ø—Ä–æ–≤—ñ–¥ OUT ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π.
      </div>

      <h3 style="margin-top:12px">üß∑ –ö–æ—Ä–∏—Å–Ω—ñ —Ç–µ–≥–∏</h3>
      <div>
        <span class="tag">#–∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è</span>
        <span class="tag">#–≤–æ–ª–æ–≥—ñ—Å—Ç—å_“ë—Ä—É–Ω—Ç—É</span>
        <span class="tag">#—É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è</span>
        <span class="tag">#–µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ_–∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è</span>
        <span class="tag">#—Å–µ—Ä—ñ–∞–ª_–ª–æ–≥</span>
      </div>
    </div>
  </div>

  <hr class="sep">

  <div class="card">
    <h2>üìã –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –∑–≤—ñ—Ç—É</h2>
    <ul>
      <li>–§–æ—Ç–æ —Å—Ö–µ–º–∏;</li>
      <li>–°–∫—Ä—ñ–Ω/–µ–∫—Å–ø–æ—Ä—Ç CSV —ñ–∑ 2‚Äì3 —Ö–≤ –ª–æ–≥—É (–∫—Ä–æ–∫ ~1 —Å) –ø—Ä–∏ —Ä—ñ–∑–Ω—ñ–π –≤–æ–ª–æ–≥–æ—Å—Ç—ñ;</li>
      <li>–ü–æ—è—Å–Ω–µ–Ω–Ω—è –æ–±—Ä–∞–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤: <span class="mono">ADCdry</span>, <span class="mono">ADCwet</span>, —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è <span class="mono">N</span>, Œ±-–∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è.</li>
    </ul>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// –£—Ç–∏–ª—ñ—Ç–∏
const $ = (s)=>document.querySelector(s);
function clip(s,n=999){return s.length>n?s.slice(0,n):s}
function download(name, text, type="text/plain"){
  const blob = new Blob([text], {type:type+";charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function nowStamp(){ return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16); }

// –ú–∞–ø–∞ ADC‚Üí%
function adcToPercent(adc, dry, wet){
  // –ù–æ—Ä–º—É—î–º–æ –Ω–∞ [wet .. dry], –¥–µ –±—ñ–ª—å—à—ñ ADC = —Å—É—à—ñ (–¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ —î–º–Ω—ñ—Å–Ω–∏—Ö)
  const span = (dry - wet);
  if(span === 0) return 0;
  let x = (adc - wet);
  let p = 100 - (x * 100 / span);
  if(p<0) p=0; if(p>100) p=100;
  return p;
}

// –ï–º—É–ª—è—Ç–æ—Ä
const emu = $('#emu'), emuSlider = $('#emuSlider');
emu.addEventListener('change', ()=>{ emuSlider.disabled = !emu.checked; });

// –ü—Ä–∏–º—ñ—Ç–∏–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫
const canvas = $('#chart'), ctx = canvas.getContext('2d');
const data = []; // {t, adc, pct}
function drawChart(){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  // —Ä–∞–º–∫–∞
  ctx.strokeStyle = '#223049'; ctx.strokeRect(0.5,0.5,W-1,H-1);

  if(data.length<2) return;
  // –º–∞—Å—à—Ç–∞–±
  const maxN=60;
  const series = data.slice(-maxN);
  const xs = series.map((_,i)=> i*(W/(maxN-1)));
  const adcs = series.map(p=>p.adc);
  const pcts = series.map(p=>p.pct);
  const amin = Math.min(...adcs), amax = Math.max(...adcs);
  const mapY = (val, vmin, vmax)=> H-10 - ( (val - vmin) / Math.max(1,(vmax-vmin)) ) * (H-20);

  // –æ—Å—ñ –ø—ñ–¥–ø–∏—Å–∏
  ctx.fillStyle = '#94a3b8'; ctx.font = '12px ui-monospace';
  ctx.fillText(`ADC[min..max]=${amin}..${amax}`, 10, 14);
  // –õ—ñ–Ω—ñ—è ADC
  ctx.beginPath(); ctx.strokeStyle = '#38bdf8'; ctx.lineWidth = 2;
  xs.forEach((x,i)=>{ const y = mapY(adcs[i], amin, amax); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // –õ—ñ–Ω—ñ—è % (–Ω–æ—Ä–º–æ–≤–∞–Ω–æ –¥–æ 0..100)
  ctx.beginPath(); ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 2;
  xs.forEach((x,i)=>{ const y = mapY(pcts[i], 0, 100); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // –ª–µ–≥–µ–Ω–¥–∞
  ctx.fillStyle = '#e6eef9';
  ctx.fillText('ADC', W-80, 16);
  ctx.fillText('%',   W-40, 16);
}

function addPoint(){
  const dry = parseInt($('#dry').value,10);
  const wet = parseInt($('#wet').value,10);
  let adc;
  if(emu.checked){
    adc = parseInt(emuSlider.value,10);
  }else{
    // –ë–µ–∑ –ø—Ä—è–º–æ–≥–æ Arduino —É –±—Ä–∞—É–∑–µ—Ä—ñ –±–µ—Ä–µ–º–æ ¬´—Ä—É—á–Ω–µ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è¬ª: –ø–æ–ø—Ä–æ—Å–∏–º–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤–≤–µ—Å—Ç–∏
    const m = prompt('–í–≤–µ–¥–∏ –ø–æ—Ç–æ—á–Ω–∏–π ADC –∑ Serial Monitor (—Ü—ñ–ª–µ —á–∏—Å–ª–æ):', '2100');
    if(m===null) return;
    adc = parseInt(m,10);
    if(Number.isNaN(adc)) return alert('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ');
  }
  const pct = Math.round(adcToPercent(adc, dry, wet));
  data.push({t:Date.now(), adc, pct});
  $('#lastVal').textContent = `ADC=${adc} ‚Üí  ${pct} %`;
  drawChart();
}
$('#addPoint').addEventListener('click', addPoint);
$('#clearChart').addEventListener('click', ()=>{ data.length=0; drawChart(); });

// –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–∫–µ—Ç—á–∞
function makeSketch(){
  const dry = parseInt($('#dry').value,10);
  const wet = parseInt($('#wet').value,10);
  const avg = Math.max(1, parseInt($('#avg').value,10));
  const alpha = Math.min(1, Math.max(0, parseFloat($('#alpha').value)));
  const ain = $('#ain').value; // A0...
  const period = Math.max(100, parseInt($('#period').value,10));

  const code = `/*
  –ü–∞—Ä–∞ 16 ‚Äî Arduino: —Å–µ–Ω—Å–æ—Ä –≤–æ–ª–æ–≥–æ—Å—Ç—ñ “ë—Ä—É–Ω—Ç—É (–∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è, %, –ª–æ–≥)
  –ê–≤—Ç–æ—Ä –ª–∞–±–∏: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫ (EDLab)

  –§—É–Ω–∫—Ü—ñ—ó:
    - –ó—á–∏—Ç—É–≤–∞–Ω–Ω—è ${ain} –∑ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è–º N=${avg}
    - –ú–∞–ø–∞ ADC‚Üí% –∑–∞ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è–º (dry=${dry}, wet=${wet})
    - –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è Œ±=${alpha.toFixed(2)} (EMA)
    - –í–∏–≤—ñ–¥ —É Serial (CSV): millis,adc,percent,ema  –∫–æ–∂–Ω—ñ ${period} –º—Å
*/

const int PIN_SOIL = ${ain};         // –∞–Ω–∞–ª–æ–≥–æ–≤–∏–π –ø—ñ–Ω
const int AVG_SAMPLES = ${avg};      // —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è
const int PERIOD_MS   = ${period};   // –ø–µ—Ä—ñ–æ–¥ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è

// –ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è (–∑–Ω–∞—á–µ–Ω–Ω—è –ê–¶–ü)
const int CAL_DRY = ${dry};
const int CAL_WET = ${wet};

// –°—Ç–∞–Ω
unsigned long tmr = 0;
float ema = -1;

int readAveraged(int pin){
  long sum = 0;
  for(int i=0;i<AVG_SAMPLES;i++){
    sum += analogRead(pin);
    delay(2);
  }
  return (int)(sum / AVG_SAMPLES);
}

int adcToPercent(int adc){
  long span = (long)CAL_DRY - (long)CAL_WET;
  if(span == 0) return 0;
  long x = (long)adc - (long)CAL_WET;
  long p = 100 - (x * 100 / span);
  if(p<0) p=0; if(p>100) p=100;
  return (int)p;
}

void setup(){
  Serial.begin(115200);
  delay(300);
  Serial.println(F("millis,adc,pct,ema"));
}

void loop(){
  if(millis() - tmr >= PERIOD_MS){
    tmr = millis();
    int adc = readAveraged(PIN_SOIL);
    int pct = adcToPercent(adc);
    if(ema < 0) ema = pct; // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è EMA –ø–µ—Ä—à–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º
    ema = ${alpha.toFixed(3)} * pct + (1.0 - ${alpha.toFixed(3)}) * ema;
    Serial.print(millis()); Serial.print(',');
    Serial.print(adc);      Serial.print(',');
    Serial.print(pct);      Serial.print(',');
    Serial.println(ema, 2);
  }
}
`;
  return code;
}

$('#gen').addEventListener('click', ()=>{
  const txt = makeSketch();
  $('#code').textContent = txt;
  window.scrollTo({top: $('#code').parentElement.getBoundingClientRect().top + window.scrollY - 20, behavior:'smooth'});
});
$('#copy').addEventListener('click', ()=>{
  const ta = document.createElement('textarea');
  ta.value = $('#code').textContent; document.body.appendChild(ta);
  ta.select(); ta.setSelectionRange(0, ta.value.length);
  document.execCommand('copy'); ta.remove();
  const old = document.title; document.title = '‚úÖ –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'; setTimeout(()=>document.title=old,900);
});
$('#dl').addEventListener('click', ()=>{
  const txt = $('#code').textContent || makeSketch();
  download('agro_para16_soil_sensor.ino', txt, 'text/x-arduino');
});

// –ó–≤—ñ—Ç TXT/CSV
$('#saveTxt').addEventListener('click', ()=>{
  const fio = clip($('#fio').value.trim(), 120);
  const dry = $('#dry').value, wet=$('#wet').value, avg=$('#avg').value, alpha=$('#alpha').value, ain=$('#ain').value, period=$('#period').value;
  const lines = [
    '–ü–∞—Ä–∞ 16 ‚Äî Arduino: —Å–µ–Ω—Å–æ—Ä –≤–æ–ª–æ–≥–æ—Å—Ç—ñ “ë—Ä—É–Ω—Ç—É',
    '–°—Ç—É–¥–µ–Ω—Ç: ' + fio,
    '–ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è: dry=' + dry + ', wet=' + wet,
    '–§—ñ–ª—å—Ç—Ä–∏: —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è N=' + avg + ', EMA Œ±=' + alpha,
    '–ü–∞—Ä–∞–º–µ—Ç—Ä–∏: –ø—ñ–Ω=' + ain + ', –ø–µ—Ä—ñ–æ–¥=' + period + ' –º—Å',
    '–ö–æ–º–µ–Ω—Ç–∞—Ä: ...'
  ].join('\\n');
  download('agro_para16_'+nowStamp()+'.txt', lines);
});
$('#saveCsv').addEventListener('click', ()=>{
  const fio = $('#fio').value.replace(/"/g,'""');
  const dry = $('#dry').value, wet=$('#wet').value, avg=$('#avg').value, alpha=$('#alpha').value, ain=$('#ain').value, period=$('#period').value;
  const csv = '"–ü–∞—Ä–∞","–°—Ç—É–¥–µ–Ω—Ç","dry","wet","avgN","alpha","pin","period_ms"\n'
            + `"16","${fio}",${dry},${wet},${avg},${alpha},"${ain}",${period}\n`;
  download('agro_para16_'+nowStamp()+'.csv', csv, 'text/csv');
});

// –ñ–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ —Å—Ç–∞—Ä—Ç
drawChart();

// Moodle-friendly –∫–ª–∞—Å
if (window.self !== window.top) document.documentElement.classList.add('embedded');
</script>


</body></html>