<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 18 ‚Äî Arduino: –º—ñ–∫—Ä–æ–∫–ª—ñ–º–∞—Ç (DHT11/DHT22) + GDD, –≥—Ä–∞—Ñ—ñ–∫, –µ–∫—Å–ø–æ—Ä—Ç</title>
<meta name="description" content="–ß–∏—Ç–∞—î–º–æ DHT11/DHT22: T/–≤–æ–ª–æ–≥—ñ—Å—Ç—å, –∑–≥–ª–∞–¥–∂—É—î–º–æ, –±—É–¥—É—î–º–æ –æ–Ω–ª–∞–π–Ω-–≥—Ä–∞—Ñ—ñ–∫, —Ä–∞—Ö—É—î–º–æ Growing Degree Days (GDD) –∑ –±–∞–∑–æ—é/—Å—Ç–µ–ª–µ—é, –µ–∫—Å–ø–æ—Ä—Ç—É—î–º–æ CSV/TXT. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ—à–∏–≤–∫–∏ –ø—ñ–¥ –æ–±—Ä–∞–Ω–∏–π —Å–µ–Ω—Å–æ—Ä."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.input, select, textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
small.mono,.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
hr.sep{border:none;border-top:1px solid var(--line);margin:16px 0}
.note{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0c182a}
svg{max-width:100%;height:auto;display:block}
pre.code{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto}
kbd{background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:260px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
.badgeGDD{display:inline-block;border:1px solid #334155;border-radius:999px;padding:2px 8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üå°Ô∏è</span>
      <div>
        <b>–ü–∞—Ä–∞ 18 ‚Äî Arduino: –º—ñ–∫—Ä–æ–∫–ª—ñ–º–∞—Ç (DHT11/DHT22)</b><br/>
        <span class="badge">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–≤–æ–ª–æ–≥—ñ—Å—Ç—å ‚Üí –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è ‚Üí GDD ‚Üí –≥—Ä–∞—Ñ—ñ–∫ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">–ú–µ—Ç–∞: –ø—ñ–¥‚Äô—î–¥–Ω–∞—Ç–∏ <b>DHT11/DHT22</b>, –≤–∏–º—ñ—Ä—é–≤–∞—Ç–∏ T/–≤–æ–ª–æ–≥—ñ—Å—Ç—å, –±—É–¥—É–≤–∞—Ç–∏ –æ–Ω–ª–∞–π–Ω-–≥—Ä–∞—Ñ—ñ–∫, —Ä–∞—Ö—É–≤–∞—Ç–∏ <b>Growing Degree Days (GDD)</b> —ñ–∑ –±–∞–∑–æ—é (<span class="mono">T<sub>base</sub></span>) —ñ —Å—Ç–µ–ª–µ—é (<span class="mono">T<sub>upper</sub></span>), –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª. –Ñ <b>–µ–º—É–ª—è—Ç–æ—Ä</b> –¥–ª—è –≤—ñ–¥–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –±–µ–∑ ¬´–∑–∞–ª—ñ–∑–∞¬ª —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∫–µ—Ç—á–∞.</p>

  <div class="grid">
    <!-- –õ–Ü–í–û: –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è + –≥—Ä–∞—Ñ—ñ–∫ + –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä -->
    <div class="card">
      <h2>üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å</h2>
      <div class="row">
        <div style="flex:1">
          <label for="sensor">–¢–∏–ø —Å–µ–Ω—Å–æ—Ä–∞</label>
          <select id="sensor" class="input">
            <option value="DHT11">DHT11</option>
            <option value="DHT22" selected>DHT22 / AM2302</option>
          </select>
        </div>
        <div style="flex:1">
          <label for="dpin">–¶–∏—Ñ—Ä–æ–≤–∏–π –ø—ñ–Ω (DHT DATA)</label>
          <select id="dpin" class="input">
            <option value="2">D2</option><option value="3">D3</option><option value="4" selected>D4</option>
            <option value="5">D5</option><option value="6">D6</option><option value="7">D7</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="period">–ü–µ—Ä—ñ–æ–¥ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, –º—Å</label>
          <input id="period" class="input" type="number" min="1000" max="60000" step="500" value="2000"/>
        </div>
        <div style="flex:1">
          <label for="alpha">EMA –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è Œ± (0..1)</label>
          <input id="alpha" class="input" type="number" step="0.05" min="0" max="1" value="0.2"/>
        </div>
      </div>

      <h3 style="margin-top:12px">üå± Growing Degree Days (GDD)</h3>
      <div class="row">
        <div style="flex:1">
          <label for="tbase">T<sub>base</sub> (¬∞C)</label>
          <input id="tbase" class="input" type="number" step="0.5" value="10"/>
        </div>
        <div style="flex:1">
          <label for="tupper">T<sub>upper</sub> (¬∞C, ¬´—Å—Ç–µ–ª—è¬ª)</label>
          <input id="tupper" class="input" type="number" step="0.5" value="30"/>
        </div>
        <div style="flex:1">
          <label for="targetGDD">–¶—ñ–ª—å GDD (–Ω–∞–ø—Ä. —Ñ–∞–∑–∞)</label>
          <input id="targetGDD" class="input" type="number" step="1" value="150"/>
        </div>
      </div>
      <div class="row" style="gap:14px">
        <span id="gddBadge" class="badgeGDD">Œ£GDD = 0.0</span>
        <span class="muted">–ê–ª–≥–æ—Ä–∏—Ç–º: <span class="mono">Tclip = clamp(T, Tbase, Tupper), GDD += (Tclip - Tbase) * Œît/24h</span></span>
      </div>

      <h3 style="margin-top:12px">üß™ –ï–º—É–ª—è—Ç–æ—Ä (–±–µ–∑ Arduino)</h3>
      <div class="row">
        <input id="emu" type="checkbox"/>
        <label for="emu">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –µ–º—É–ª—è—Ç–æ—Ä</label>
      </div>
      <div class="row" style="width:100%">
        <label style="flex:1">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C <input id="emuT" class="input" type="range" min="-5" max="45" step="0.5" value="22" disabled/></label>
        <label style="flex:1">–í–æ–ª–æ–≥—ñ—Å—Ç—å, % <input id="emuH" class="input" type="range" min="15" max="95" step="1" value="55" disabled/></label>
      </div>

      <h3 style="margin-top:12px">üìà –ñ–∏–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫</h3>
      <div class="canvasWrap"><canvas id="chart" width="900" height="260"></canvas></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="tick">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</button>
        <button class="btn secondary" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
        <span class="muted mono" id="lastVal">T=‚Äî ¬∞C, H=‚Äî %, Œ£GDD=0.0</span>
      </div>

      <h3 style="margin-top:12px">üß© –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥ (Arduino .ino)</h3>
      <div class="row">
        <button class="btn good" id="gen">‚öôÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø—Ä–æ—à–∏–≤–∫—É</button>
        <button class="btn secondary" id="copy">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        <button class="btn secondary" id="dl">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ .ino</button>
      </div>
      <pre class="code"><code id="code">// –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø—Ä–æ—à–∏–≤–∫—É¬ª ‚Üë</code></pre>

      <h3 style="margin-top:12px">üíæ –ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –∑–≤—ñ—Ç—É</h3>
      <div class="row">
        <input id="fio" class="input" placeholder="–ü–Ü–ë —Å—Ç—É–¥–µ–Ω—Ç–∞"/>
        <button class="btn" id="saveTxt">üíæ TXT</button>
        <button class="btn" id="saveCsv">üìÑ CSV</button>
      </div>
    </div>

    <!-- –ü–†–ê–í–û: —Å—Ö–µ–º–∞ + –Ω–æ—Ç–∞—Ç–∫–∏ -->
    <div class="card">
      <h2>üîå –°—Ö–µ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (SVG)</h2>
      <svg viewBox="0 0 760 360" role="img" aria-label="Arduino + DHT">
        <!-- Arduino -->
        <rect x="40" y="40" width="220" height="120" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="150" y="65" fill="#e5e7eb" font-size="16" text-anchor="middle">Arduino UNO/Nano</text>
        <text x="55" y="95" fill="#93c5fd" font-size="12">5V</text>
        <text x="55" y="115" fill="#93c5fd" font-size="12">GND</text>
        <text x="55" y="135" fill="#93c5fd" font-size="12">D4</text>

        <!-- DHT -->
        <rect x="320" y="40" width="200" height="100" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="420" y="70" fill="#dcfce7" font-size="16" text-anchor="middle">DHT11/DHT22</text>
        <text x="420" y="90" fill="#a7f3d0" font-size="12" text-anchor="middle">VCC ‚Äî DATA ‚Äî GND</text>

        <!-- –ü—ñ–¥—Ç—è–∂–∫–∞ -->
        <line x1="420" y1="100" x2="420" y2="130" stroke="#fbbf24" stroke-width="2"/>
        <rect x="410" y="130" width="20" height="10" fill="#fbbf24"/>
        <text x="460" y="138" fill="#fde68a" font-size="12">~10k Œ© pull-up</text>

        <!-- –ó‚Äô—î–¥–Ω–∞–Ω–Ω—è -->
        <line x1="260" y1="90"  x2="320" y2="60"  stroke="#93c5fd" stroke-width="3"/><text x="280" y="80"  fill="#93c5fd" font-size="12">5V ‚Üí VCC</text>
        <line x1="260" y1="110" x2="320" y2="100" stroke="#64748b" stroke-width="3"/><text x="280" y="110" fill="#94a3b8" font-size="12">GND ‚Üí GND</text>
        <line x1="260" y1="130" x2="320" y2="80"  stroke="#22c55e" stroke-width="3"/><text x="280" y="95"  fill="#86efac" font-size="12">D4 ‚Üí DATA</text>
      </svg>

      <div class="note" style="margin-top:10px">
        <b>–ü–æ—Ä–∞–¥–∏:</b> –Ω–µ –∫–ª–∞–¥–∏ DHT –Ω–∞ –ø—Ä—è–º–µ —Å–æ–Ω—Ü–µ/–≥–∞—Ä—è—á—ñ –ø–æ–≤–µ—Ä—Ö–Ω—ñ; –≤–∏–º—ñ—Ä—é–π –ø–æ–≤—ñ—Ç—Ä—è –≤ –∑–æ–Ω—ñ —Ä–æ—Å–ª–∏–Ω. DHT22 —Ç–æ—á–Ω—ñ—à–∏–π —ñ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–∏–π –∑–∞ DHT11.
      </div>

      <h3 style="margin-top:12px">üß∑ –ö–æ—Ä–∏—Å–Ω—ñ —Ç–µ–≥–∏</h3>
      <div>
        <span class="tag">#–º—ñ–∫—Ä–æ–∫–ª—ñ–º–∞—Ç</span>
        <span class="tag">#DHT11</span>
        <span class="tag">#DHT22</span>
        <span class="tag">#GDD</span>
        <span class="tag">#—Å–µ—Ä—ñ–∞–ª_–ª–æ–≥</span>
      </div>
    </div>
  </div>

  <hr class="sep"/>

  <div class="card">
    <h2>üìã –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –∑–≤—ñ—Ç—É</h2>
    <ul>
      <li>–§–æ—Ç–æ —Å—Ö–µ–º–∏;</li>
      <li>CSV-–ª–æ–≥ (2‚Äì3 —Ö–≤) –∑ T/H —ñ –Ω–∞—Ä–æ—Å—Ç–∞—é—á–∏–º GDD; —Å–∫—Ä—ñ–Ω —ñ–∑ Serial Plotter/Excel;</li>
      <li>–ü–æ—è—Å–Ω–∏ –≤–∏–±—ñ—Ä <span class="mono">T<sub>base</sub>/T<sub>upper</sub></span> —ñ —è–∫ –∑–º—ñ–Ω–∏—Ç—å—Å—è GDD, —è–∫—â–æ –∑–º—ñ–Ω–∏—Ç–∏ –ø–µ—Ä—ñ–æ–¥ –∞–±–æ Œ±.</li>
    </ul>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// –£—Ç–∏–ª—ñ—Ç–∏
const $=(s)=>document.querySelector(s);
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}

// –ï–º—É–ª—è—Ç–æ—Ä
const emu=$('#emu'), emuT=$('#emuT'), emuH=$('#emuH');
emu.addEventListener('change',()=>{emuT.disabled=emuH.disabled=!emu.checked;});

// –ì—Ä–∞—Ñ—ñ–∫
const cvs=$('#chart'), ctx=cvs.getContext('2d');
const series=[]; // {t, T, H, G}
let GDD=0, lastTstamp=null;

function clipT(T, base, upper){
  if(T<base) return base;
  if(T>upper) return upper;
  return T;
}
function draw(){
  const W=cvs.width,H=cvs.height;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#223049';ctx.strokeRect(0.5,0.5,W-1,H-1);
  if(series.length<2) return;
  const maxN=120;
  const s=series.slice(-maxN);
  const xs=s.map((_,i)=> i*(W/(maxN-1)));
  // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0..40)
  ctx.beginPath();ctx.strokeStyle='#38bdf8';ctx.lineWidth=2;
  xs.forEach((x,i)=>{const y=H-10-(Math.min(40,Math.max(0,s[i].T))/40)*(H-20);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();
  // –í–æ–ª–æ–≥—ñ—Å—Ç—å (0..100)
  ctx.beginPath();ctx.strokeStyle='#22c55e';ctx.lineWidth=2;
  xs.forEach((x,i)=>{const y=H-10-(s[i].H/100)*(H-20);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();
  // –ú–∞—Ä–∫–µ—Ä–∏ GDD
  ctx.fillStyle='#94a3b8';ctx.font='12px ui-monospace';
  ctx.fillText('T',W-28,14);ctx.fillText('H',W-12,14);
}

function addPoint(){
  const base=parseFloat($('#tbase').value), upper=parseFloat($('#tupper').value);
  let T,H;
  if(emu.checked){ T=parseFloat(emuT.value); H=parseFloat(emuH.value); }
  else{
    const t=prompt('–í–≤–µ–¥–∏ –ø–æ—Ç–æ—á–Ω—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É ¬∞C (–∑ Serial Monitor):','22');
    if(t===null) return; T=parseFloat(t);
    const h=prompt('–í–≤–µ–¥–∏ –ø–æ—Ç–æ—á–Ω—É –≤–æ–ª–æ–≥—ñ—Å—Ç—å %:','55');
    if(h===null) return; H=parseFloat(h);
    if(Number.isNaN(T)||Number.isNaN(H)) return alert('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞');
  }
  const now=Date.now();
  if(lastTstamp==null) lastTstamp=now;
  const dtHours=(now-lastTstamp)/3600000; // –≥–æ–¥–∏–Ω –≤—ñ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Ç–æ—á–∫–∏
  lastTstamp=now;

  const Tcl=clipT(T,base,upper);
  const inc=Math.max(0, Tcl - base) * dtHours; // –ø—Ä–∏—Ä—ñ—Å—Ç GDD –∑–∞ –ø—Ä–æ–º—ñ–∂–æ–∫
  GDD += inc;

  series.push({t:now, T,H, G:GDD});
  $('#lastVal').textContent=`T=${T.toFixed(1)} ¬∞C, H=${H.toFixed(0)} %, Œ£GDD=${GDD.toFixed(2)}`;
  $('#gddBadge').textContent='Œ£GDD = ' + GDD.toFixed(2);

  const target=parseFloat($('#targetGDD').value)||0;
  if(target>0 && GDD>=target){ document.title='‚úÖ –î–æ—Å—è–≥–Ω—É—Ç–æ —Ü—ñ–ª—å GDD'; setTimeout(()=>document.title='–ü–∞—Ä–∞ 18 ‚Äî Arduino DHT + GDD',1200); }
  draw();
}
$('#tick').addEventListener('click', addPoint);
$('#clear').addEventListener('click', ()=>{ series.length=0; GDD=0; lastTstamp=null; $('#gddBadge').textContent='Œ£GDD = 0.0'; $('#lastVal').textContent='T=‚Äî ¬∞C, H=‚Äî %, Œ£GDD=0.0'; draw(); });

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ—à–∏–≤–∫–∏
function makeSketch(){
  const type=$('#sensor').value; // DHT11/DHT22
  const dpin=parseInt($('#dpin').value,10);
  const alpha=Math.min(1,Math.max(0,parseFloat($('#alpha').value)));
  const period=Math.max(1000,parseInt($('#period').value,10));
  const tbase=parseFloat($('#tbase').value);
  const tupper=parseFloat($('#tupper').value);

  const code = `/*
  –ü–∞—Ä–∞ 18 ‚Äî Arduino: –º—ñ–∫—Ä–æ–∫–ª—ñ–º–∞—Ç (DHT11/DHT22) + GDD
  –ê–≤—Ç–æ—Ä –ª–∞–±–∏: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫ (EDLab)

  –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏:
    - DHT sensor library –≤—ñ–¥ Adafruit (DHT.h)
  
  –§—É–Ω–∫—Ü—ñ—ó:
    - –ó—á–∏—Ç—É–≤–∞–Ω–Ω—è T/–≤–æ–ª–æ–≥—ñ—Å—Ç—å —ñ–∑ DHT –Ω–∞ D${dpin}
    - EMA –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è Œ±=${alpha.toFixed(2)} –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
    - –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ GDD –∑ –±–∞–∑–æ—é Tbase=${tbase}¬∞C —Ç–∞ ¬´—Å—Ç–µ–ª–µ—é¬ª Tupper=${tupper}¬∞C
    - –í–∏–≤—ñ–¥ CSV: millis, T, H, T_ema, GDD
*/

#include <DHT.h>

#define DHTPIN ${dpin}
#define DHTTYPE ${type}   // DHT11 –∞–±–æ DHT22

DHT dht(DHTPIN, DHTTYPE);

const unsigned long PERIOD_MS = ${period};
const float ALPHA = ${alpha.toFixed(3)};
const float TBASE = ${tbase};
const float TUPPER = ${tupper};

unsigned long tPrev = 0;
float emaT = NAN;
float GDD = 0.0;

float clipT(float T){
  if(T < TBASE) return TBASE;
  if(T > TUPPER) return TUPPER;
  return T;
}

void setup(){
  Serial.begin(115200);
  dht.begin();
  delay(300);
  Serial.println(F("millis,T,H,T_ema,GDD"));
}

void loop(){
  if(millis() - tPrev >= PERIOD_MS){
    unsigned long now = millis();
    float h = dht.readHumidity();
    float t = dht.readTemperature(); // ¬∞C

    if (isnan(h) || isnan(t)) {
      // —Å–µ–Ω—Å–æ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤ ‚Äî –≤–∏–≤–µ–¥–µ–º–æ NaN, —Å–ø—Ä–æ–±—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ü–∏–∫–ª—É
      Serial.print(now); Serial.print(",NaN,NaN,NaN,"); Serial.println(GDD,2);
      tPrev = now;
      return;
    }

    if(isnan(emaT)) emaT = t; // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è EMA
    emaT = ALPHA * t + (1.0 - ALPHA) * emaT;

    // Œît —É –≥–æ–¥–∏–Ω–∞—Ö
    float dth = (now - tPrev) / 3600000.0;
    tPrev = now;

    // GDD –ø—Ä–∏—Ä—ñ—Å—Ç
    float Tcl = clipT(t);
    float inc = max(0.0f, Tcl - TBASE) * dth;
    GDD += inc;

    Serial.print(now); Serial.print(',');
    Serial.print(t, 2); Serial.print(',');
    Serial.print(h, 1); Serial.print(',');
    Serial.print(emaT, 2); Serial.print(',');
    Serial.println(GDD, 3);
  }
}
`;
  return code;
}

$('#gen').addEventListener('click', ()=>{ const txt=makeSketch(); $('#code').textContent=txt; window.scrollTo({top: $('#code').parentElement.getBoundingClientRect().top + window.scrollY - 20, behavior:'smooth'}); });
$('#copy').addEventListener('click', ()=>{ const ta=document.createElement('textarea'); ta.value=$('#code').textContent; document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0, ta.value.length); document.execCommand('copy'); ta.remove(); const old=document.title; document.title='‚úÖ –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'; setTimeout(()=>document.title=old,900); });
$('#dl').addEventListener('click', ()=>{ const txt=$('#code').textContent||makeSketch(); download('agro_para18_dht_gdd.ino',txt,'text/x-arduino'); });

// –ü—Ä–æ—Ç–æ–∫–æ–ª
$('#saveTxt').addEventListener('click', ()=>{
  const fio=($('#fio').value||'').trim();
  const lines=[
    '–ü–∞—Ä–∞ 18 ‚Äî Arduino: –º—ñ–∫—Ä–æ–∫–ª—ñ–º–∞—Ç (DHT) + GDD',
    '–°—Ç—É–¥–µ–Ω—Ç: '+fio,
    `–°–µ–Ω—Å–æ—Ä: ${$('#sensor').value} –Ω–∞ D${$('#dpin').value}`,
    `–ü–µ—Ä—ñ–æ–¥: ${$('#period').value} –º—Å, EMA Œ±=${$('#alpha').value}`,
    `GDD: Tbase=${$('#tbase').value} ¬∞C, Tupper=${$('#tupper').value} ¬∞C, –¶—ñ–ª—å=${$('#targetGDD').value}`,
    `Œ£GDD (–ª–æ–∫–∞–ª—å–Ω–∞ —Å–µ—Å—ñ—è): ${GDD.toFixed(2)}`,
    '–ö–æ–º–µ–Ω—Ç–∞—Ä: ...'
  ].join('\n');
  download('agro_para18_'+stamp()+'.txt',lines);
});
$('#saveCsv').addEventListener('click', ()=>{
  const fio=($('#fio').value||'').replace(/"/g,'""');
  const csv='"–ü–∞—Ä–∞","–°—Ç—É–¥–µ–Ω—Ç","Sensor","Pin","Period_ms","Alpha","Tbase","Tupper","TargetGDD","SumGDD"\n'
          + `"18","${fio}","${$('#sensor').value}","D${$('#dpin').value}",${$('#period').value},${$('#alpha').value},${$('#tbase').value},${$('#tupper').value},${$('#targetGDD').value},${GDD.toFixed(2)}\n`;
  download('agro_para18_'+stamp()+'.csv',csv,'text/csv');
});

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
draw();
if (window.self !== window.top) document.documentElement.classList.add('embedded'); // Moodle-friendly
</script>
</body>
</html>
