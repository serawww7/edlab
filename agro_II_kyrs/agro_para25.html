<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ü–∞—Ä–∞ 25 ‚Äî –®–Ü-–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ —Ä–æ–±—ñ—Ç: –Ω–æ—Ç–∞—Ç–∫–∏ ‚Üí –∫–∞–ª–µ–Ω–¥–∞—Ä (SOP/REI/PHI/–ø–æ–≥–æ–¥–∞) + –∫–æ–Ω—Ñ–ª—ñ–∫—Ç-—á–µ–∫–∏–Ω“ë</title>
<meta name="description" content="–Ü–º–ø–æ—Ä—Ç –ø–æ–ª—å–æ–≤–∏—Ö –Ω–æ—Ç–∞—Ç–æ–∫ —ñ –ø–æ–≥–æ–¥–∏ ‚Üí –∞–≤—Ç–æ–ø–ª–∞–Ω —Ä–æ–±—ñ—Ç —ñ–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º REI/PHI —Ç–∞ –ø–æ–≥–æ–¥–Ω–∏—Ö –≤—ñ–∫–æ–Ω ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ —Ä–µ—Å—É—Ä—Å—ñ–≤ ‚Üí Gantt, –µ–∫—Å–ø–æ—Ä—Ç ICS/CSV/TXT, 58-–º–º —á–µ–∫, –ø—Ä–æ–º–ø—Ç –¥–æ LLM."/>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e6eef9;--line:#223049;--brand:#38bdf8;--ok:#22c55e;--warn:#fbbf24;--bad:#f87171}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif}
.wrap{max-width:1080px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo .emoji{font-size:28px}
.logo .badge{font-size:.9rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
h1{margin:.2em 0 .3em 0}
.muted{color:var(--muted)}
.card{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:14px;margin-top:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
.btn{border:1px solid var(--line);background:#0f1f39;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent}
.btn.good{border-color:#204b2a;background:#12341b}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px}
.grid{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
@media(max-width:1080px){.grid{grid-template-columns:1fr}}
pre.code{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto;white-space:pre-wrap}
.tbl{width:100%;border-collapse:collapse;font-size:.95rem}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
.tbl th{background:#0b1a2f}
.canvasWrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
canvas{display:block;width:100%;height:260px}
.log{max-height:160px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1220;font-family:ui-monospace,monospace;font-size:13px;white-space:pre-wrap}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.small{font-size:.9rem}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);margin-right:6px;margin-top:6px}
.receipt{background:#0b1220;border:1px dashed #334155;border-radius:12px;padding:10px;font-family:ui-monospace,monospace}
.footer{margin-top:20px;color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <span class="emoji">üìÖ</span>
      <div>
        <b>–ü–∞—Ä–∞ 25 ‚Äî –®–Ü-–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ —Ä–æ–±—ñ—Ç</b><br/>
        <span class="badge">–ù–æ—Ç–∞—Ç–∫–∏ ‚Üí –∫–∞–ª–µ–Ω–¥–∞—Ä ‚Üí REI/PHI ‚Üí –≤—ñ–∫–Ω–∞ –ø–æ–≥–æ–¥–∏ ‚Üí –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ ‚Üí –µ–∫—Å–ø–æ—Ä—Ç</span>
      </div>
    </div>
    <a class="btn" href="../index.html" target="_blank" rel="noopener">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <p class="muted">
    –ú–µ—Ç–∞: –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–ª—å–æ–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏ –≤ <b>–≤–∏—Ä–æ–±–Ω–∏—á–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä</b> —ñ–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º <b>REI</b> (—Ä–µ-entry), <b>PHI</b> (–ø–µ—Ä—ñ–æ–¥ –¥–æ –∑–±–æ—Ä—É), –ø–æ–≥–æ–¥–Ω–∏—Ö –≤—ñ–∫–æ–Ω, —Ä–µ—Å—É—Ä—Å—ñ–≤ —Ç–∞ <b>SOP</b>. 
    –î–∞–ª—ñ ‚Äî <b>–∫–æ–Ω—Ñ–ª—ñ–∫—Ç-—á–µ–∫–∏–Ω“ë</b>, Gantt-–≥—Ä–∞—Ñ—ñ–∫, –µ–∫—Å–ø–æ—Ä—Ç —É <b>ICS/CSV/TXT</b>, ¬´58-–º–º —á–µ–∫¬ª —ñ –ø—Ä–æ–º–ø—Ç –¥–æ LLM –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó.
  </p>

  <div class="grid">
    <!-- –õ–Ü–í–ê –ö–û–õ–û–ù–ö–ê -->
    <div class="card">
      <h2>üóÇÔ∏è –ù–æ—Ç–∞—Ç–∫–∏ –ø—Ä–æ —Ä–æ–±–æ—Ç–∏ (CSV)</h2>
      <p class="small muted">–§–æ—Ä–º–∞—Ç: <span class="mono">task,type,field,area_ha,product,REI_h,PHI_d,speed_ha_h,preferred_start,preferred_end</span> (–¥–∞—Ç–∏ —É ISO, –Ω–∞–ø—Ä. <span class="mono">2025-05-20T08:00</span>)</p>
      <textarea id="csvTasks" class="input" rows="6" placeholder="task,type,field,area_ha,product,REI_h,PHI_d,speed_ha_h,preferred_start,preferred_end
–§—É–Ω–≥—ñ—Ü–∏–¥ 1,–æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è,–ü–æ–ª–µ 3,25,—Ç–µ–±—É–∫–æ–Ω–∞–∑–æ–ª,24,35,12,2025-05-20T08:00,2025-05-22T20:00
–ü—ñ–¥–∂–∏–≤–ª–µ–Ω–Ω—è –ö–ê–°,–ø—ñ–¥–∂–∏–≤–ª–µ–Ω–Ω—è,–ü–æ–ª–µ 3,25,,0,0,15,2025-05-20T08:00,2025-05-23T20:00
–°–∫–∞—É—Ç–∏–Ω–≥,—Å–∫–∞—É—Ç–∏–Ω–≥,–ü–æ–ª–µ 3,25,,0,0,20,2025-05-19T08:00,2025-05-26T20:00"></textarea>
      <div class="row">
        <button class="btn good" id="loadTasks">üì• –Ü–º–ø–æ—Ä—Ç</button>
        <button class="btn secondary" id="demoTasks">üé≤ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ</button>
        <button class="btn secondary" id="clearTasks">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
        <span id="badgeTasks" class="badge">–ó–∞–≤–¥–∞–Ω—å: 0</span>
      </div>

      <h2 style="margin-top:12px">üå§Ô∏è –ü–æ–≥–æ–¥–∞ (–≥–æ–¥–∏–Ω–Ω—ñ –¥–∞–Ω—ñ CSV)</h2>
      <p class="small muted">–§–æ—Ä–º–∞—Ç: <span class="mono">timestamp,wind_ms,rain_mm,RH,T</span>. –î–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –∑–∞–º–æ–≤—á.: <span class="mono">wind‚â§5 –º/—Å, rain=0, 8‚â§T‚â§28, 40‚â§RH‚â§95</span></p>
      <textarea id="csvWx" class="input" rows="6" placeholder="timestamp,wind_ms,rain_mm,RH,T
2025-05-20T06:00,2.1,0,92,12.4
2025-05-20T07:00,2.5,0,90,13.1
..."></textarea>
      <div class="row">
        <button class="btn" id="loadWx">üì• –Ü–º–ø–æ—Ä—Ç</button>
        <button class="btn secondary" id="demoWx">üé≤ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 5 –¥—ñ–±</button>
        <button class="btn secondary" id="clearWx">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
        <span id="badgeWx" class="badge">–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–≥–æ–¥–∏: 0</span>
      </div>

      <h2 style="margin-top:12px">‚öôÔ∏è –†–µ—Å—É—Ä—Å–∏ —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è</h2>
      <div class="row">
        <div style="flex:1">
          <label for="sprayers">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±–ø—Ä–∏—Å–∫—É–≤–∞—á—ñ–≤</label>
          <input id="sprayers" class="input" type="number" min="0" value="1"/>
        </div>
        <div style="flex:1">
          <label for="workStart">–†–æ–±–æ—á–∏–π –¥–µ–Ω—å –∑</label>
          <input id="workStart" class="input" type="time" value="08:00"/>
        </div>
        <div style="flex:1">
          <label for="workEnd">–¥–æ</label>
          <input id="workEnd" class="input" type="time" value="20:00"/>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label for="harvest">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –¥–∞—Ç–∞ –∑–±–æ—Ä—É (PHI)</label>
          <input id="harvest" class="input" type="datetime-local" value="2025-06-30T08:00"/>
        </div>
        <div style="flex:1">
          <label for="windMax">–ú–∞–∫—Å. –≤—ñ—Ç–µ—Ä (–º/—Å) –¥–ª—è –æ–±–ø—Ä.</label>
          <input id="windMax" class="input" type="number" step="0.1" value="5"/>
        </div>
        <div style="flex:1">
          <label for="rainMax">–ú–∞–∫—Å. –æ–ø–∞–¥–∏ (–º–º/–≥–æ–¥)</label>
          <input id="rainMax" class="input" type="number" step="0.1" value="0"/>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label for="tMin">T –º—ñ–Ω (¬∞C)</label>
          <input id="tMin" class="input" type="number" step="0.5" value="8"/>
        </div>
        <div style="flex:1">
          <label for="tMax">T –º–∞–∫—Å (¬∞C)</label>
          <input id="tMax" class="input" type="number" step="0.5" value="28"/>
        </div>
        <div style="flex:1">
          <label for="rhMin">RH –º—ñ–Ω (%)</label>
          <input id="rhMin" class="input" type="number" step="1" value="40"/>
        </div>
        <div style="flex:1">
          <label for="rhMax">RH –º–∞–∫—Å (%)</label>
          <input id="rhMax" class="input" type="number" step="1" value="95"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn good" id="plan">üßÆ –ê–≤—Ç–æ–ø–ª–∞–Ω</button>
        <button class="btn secondary" id="check">üîé –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏</button>
        <button class="btn secondary" id="clearPlan">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –ø–ª–∞–Ω</button>
        <span id="badgePlan" class="badge">–ü–ª–∞–Ω: ‚Äî</span>
      </div>

      <h3 style="margin-top:12px">üìà Gantt (–¥–æ–±–æ–≤–∏–π –º–∞—Å—à—Ç–∞–±)</h3>
      <div class="canvasWrap"><canvas id="gantt" width="900" height="260"></canvas></div>
    </div>

    <!-- –ü–†–ê–í–ê –ö–û–õ–û–ù–ö–ê -->
    <div class="card">
      <h2>üßæ –ü–ª–∞–Ω (—Ç–∞–±–ª–∏—Ü—è)</h2>
      <table class="tbl" id="tblPlan">
        <thead><tr><th>#</th><th>–ó–∞–≤–¥–∞–Ω–Ω—è</th><th>–ü–æ–ª–µ</th><th>–ü–æ—á–∞—Ç–æ–∫</th><th>–ö—ñ–Ω–µ—Ü—å</th><th>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å, –≥–æ–¥</th><th>REI</th><th>PHI</th></tr></thead>
        <tbody></tbody>
      </table>

      <h2 style="margin-top:12px">üö¶ –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏</h2>
      <table class="tbl" id="tblConf">
        <thead><tr><th>–¢–∏–ø</th><th>–î–µ—Ç–∞–ª—ñ</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="exportICS">üóìÔ∏è –ï–∫—Å–ø–æ—Ä—Ç ICS</button>
        <button class="btn" id="exportCSV">üìÑ –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
        <button class="btn" id="exportTXT">üíæ –ü—ñ–¥—Å—É–º–æ–∫ TXT</button>
        <button class="btn secondary" id="dayReceipt">üñ®Ô∏è 58-–º–º —á–µ–∫ (–∑–∞ –¥–µ–Ω—å)</button>
      </div>
      <div class="receipt" id="receipt" hidden></div>

      <h2 style="margin-top:12px">ü§ñ –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM (–æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è)</h2>
      <div class="row">
        <button class="btn" id="genPrompt">‚öôÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
        <button class="btn secondary" id="copyPrompt">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        <button class="btn secondary" id="savePrompt">‚¨áÔ∏è TXT</button>
      </div>
      <pre class="code" id="prompt">// –°–ø–æ—á–∞—Ç–∫—É —ñ–º–ø–æ—Ä—Ç—É–π –Ω–æ—Ç–∞—Ç–∫–∏/–ø–æ–≥–æ–¥—É –π –Ω–∞—Ç–∏—Å–Ω–∏ ¬´üßÆ –ê–≤—Ç–æ–ø–ª–∞–Ω¬ª</pre>

      <h2 style="margin-top:12px">üîÅ –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—É (SVG)</h2>
      <svg viewBox="0 0 760 420" role="img" aria-label="–ü–∞–π–ø–ª–∞–π–Ω –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è">
        <rect x="40" y="40" width="200" height="80" rx="12" fill="#0e2a47" stroke="#3b82f6"/>
        <text x="140" y="70" fill="#e5e7eb" font-size="14" text-anchor="middle">–ù–æ—Ç–∞—Ç–∫–∏/CSV</text>
        <text x="140" y="88" fill="#93c5fd" font-size="12" text-anchor="middle">task/REI/PHI/—à–≤–∏–¥–∫.</text>

        <rect x="280" y="40" width="200" height="80" rx="12" fill="#14532d" stroke="#22c55e"/>
        <text x="380" y="70" fill="#dcfce7" font-size="14" text-anchor="middle">–ü–æ–≥–æ–¥–Ω—ñ –≤—ñ–∫–Ω–∞</text>
        <text x="380" y="88" fill="#a7f3d0" font-size="12" text-anchor="middle">–≤—ñ—Ç–µ—Ä/–¥–æ—â/T/RH</text>

        <rect x="520" y="40" width="200" height="80" rx="12" fill="#7c2d12" stroke="#fb923c"/>
        <text x="620" y="70" fill="#fed7aa" font-size="14" text-anchor="middle">–ê–≤—Ç–æ–ø–ª–∞–Ω</text>
        <text x="620" y="88" fill="#fed7aa" font-size="12" text-anchor="middle">—Ä–µ—Å—É—Ä—Å–∏/SOP</text>

        <line x1="240" y1="80" x2="280" y2="80" stroke="#93c5fd" stroke-width="3"/>
        <line x1="480" y1="80" x2="520" y2="80" stroke="#93c5fd" stroke-width="3"/>

        <rect x="40" y="170" width="260" height="90" rx="12" fill="#0b3f5a" stroke="#22d3ee"/>
        <text x="170" y="200" fill="#a5f3fc" font-size="14" text-anchor="middle">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏</text>
        <text x="170" y="220" fill="#a5f3fc" font-size="12" text-anchor="middle">REI/PHI/—Ä–µ—Å—É—Ä—Å–∏/–ø–æ–≥–æ–¥–∞</text>

        <rect x="340" y="170" width="190" height="90" rx="12" fill="#1f2937" stroke="#9ca3af"/>
        <text x="435" y="200" fill="#e5e7eb" font-size="14" text-anchor="middle">–ï–∫—Å–ø–æ—Ä—Ç</text>
        <text x="435" y="220" fill="#9ca3af" font-size="12" text-anchor="middle">ICS/CSV/TXT/—á–µ–∫</text>

        <rect x="560" y="170" width="160" height="90" rx="12" fill="#111827" stroke="#4b5563"/>
        <text x="640" y="200" fill="#e5e7eb" font-size="14" text-anchor="middle">LLM</text>
        <text x="640" y="220" fill="#9ca3af" font-size="12" text-anchor="middle">–æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è</text>
      </svg>

      <div class="card" style="margin-top:12px">
        <h3>üìú –ù–æ—Ç–∞—Ç–∫–∞ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó</h3>
        <p class="muted small">
          –ü–µ—Ä—à—ñ –∞–≥—Ä–æ–∫–∞–ª–µ–Ω–¥–∞—Ä—ñ –ø–ª–∞–Ω—É–≤–∞–ª–∏ ¬´–ø–æ —Ç–∏–∂–Ω—è—Ö¬ª —ñ –ø–æ–≥–æ–¥—ñ –∑ —Ä–∞–¥—ñ–æ. 
          –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –ø–æ—î–¥–Ω—É—î–º–æ <b>REI/PHI/SOP</b>, —á–∞—Å–æ–≤—ñ –≤—ñ–∫–Ω–∞ –ø–æ–≥–æ–¥–∏ —ñ —Ä–µ—Å—É—Ä—Å–∏, –∞ –®–Ü –ø—Ä–æ–ø–æ–Ω—É—î —Å—Ü–µ–Ω–∞—Ä—ñ—ó –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –±–µ–∑–ø–µ–∫–∏ –π –ª–æ–≥—ñ—Å—Ç–∏–∫–∏.
        </p>
      </div>

      <h3 style="margin-top:12px">üß∑ –¢–µ–≥–∏</h3>
      <div>
        <span class="tag">#planning</span>
        <span class="tag">#REI_PHI</span>
        <span class="tag">#weather_windows</span>
        <span class="tag">#SOP</span>
        <span class="tag">#ICS_export</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üìã –ü—ñ–¥—Å—É–º–æ–∫ –¥–ª—è –∑–≤—ñ—Ç—É</h2>
    <ul>
      <li>Gantt —Ç–∞ —Ç–∞–±–ª–∏—Ü—è –ø–ª–∞–Ω—É.</li>
      <li>–ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ (—Å–∫—Ä—ñ–Ω) + –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ, —è–∫ —ó—Ö –≤–∏–ø—Ä–∞–≤–ª—è–ª–∏.</li>
      <li>ICS/CSV/TXT —ñ ¬´58-–º–º —á–µ–∫¬ª –¥–ª—è –æ–¥–Ω—ñ—î—ó –¥–∞—Ç–∏.</li>
    </ul>
  </div>

  <div class="footer">
    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <time datetime="2025-10-18">18.10.2025</time>. –ê–≤—Ç–æ—Ä: –°–µ—Ä–≥—ñ–π –ü–æ–ª—ñ—â—É–∫.
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª—ñ—Ç–∏ =====
const $=s=>document.querySelector(s);
function download(name,text,type="text/plain"){const b=new Blob([text],{type:type+";charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
function stamp(){return new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);}
function parseISO(s){const d=new Date(s); return isNaN(d)?null:d;}
function fmt(dt){return new Date(dt).toISOString().slice(0,16).replace('T',' ')}

// ===== –î–∞–Ω—ñ =====
let tasks=[]; // {id,task,type,field,area,product,REI,PHI,speed,winStart,winEnd}
let wx=[];    // {t,wind,rain,RH,T}
let plan=[];  // {id, task, field, start, end, durH, REI, PHI, type, product}

// ===== –Ü–º–ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω—å =====
function parseTasks(txt){
  tasks.length=0;
  const lines=(txt||'').trim().split(/\r?\n/).filter(Boolean);
  const head=lines.shift(); const cols=head.split(',').map(s=>s.trim());
  const idx=n=>cols.indexOf(n);
  const need=['task','type','field','area_ha','product','REI_h','PHI_d','speed_ha_h','preferred_start','preferred_end'];
  for(const n of need){ if(idx(n)===-1) throw new Error('–í—ñ–¥—Å—É—Ç–Ω—ñ–π —Å—Ç–æ–≤–ø–µ—Ü—å: '+n); }
  let i=1;
  for(const line of lines){
    const p=line.split(',');
    const rec={
      id:i++,
      task:(p[idx('task')]||'').trim(),
      type:(p[idx('type')]||'').trim().toLowerCase(),
      field:(p[idx('field')]||'').trim(),
      area: parseFloat(p[idx('area_ha')])||0,
      product:(p[idx('product')]||'').trim(),
      REI: parseFloat(p[idx('REI_h')])||0,
      PHI: parseFloat(p[idx('PHI_d')])||0,
      speed: parseFloat(p[idx('speed_ha_h')])||10,
      winStart: parseISO(p[idx('preferred_start')]),
      winEnd: parseISO(p[idx('preferred_end')])
    };
    tasks.push(rec);
  }
}

$('#demoTasks').addEventListener('click', ()=>{
  $('#csvTasks').value =
`task,type,field,area_ha,product,REI_h,PHI_d,speed_ha_h,preferred_start,preferred_end
–§—É–Ω–≥—ñ—Ü–∏–¥ 1,–æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è,–ü–æ–ª–µ 3,25,—Ç–µ–±—É–∫–æ–Ω–∞–∑–æ–ª,24,35,12,2025-05-20T08:00,2025-05-22T20:00
–ü—ñ–¥–∂–∏–≤–ª–µ–Ω–Ω—è –ö–ê–°,–ø—ñ–¥–∂–∏–≤–ª–µ–Ω–Ω—è,–ü–æ–ª–µ 3,25,,0,0,15,2025-05-20T08:00,2025-05-23T20:00
–°–∫–∞—É—Ç–∏–Ω–≥,—Å–∫–∞—É—Ç–∏–Ω–≥,–ü–æ–ª–µ 3,25,,0,0,20,2025-05-19T08:00,2025-05-26T20:00`;
});

$('#loadTasks').addEventListener('click', ()=>{
  try{ parseTasks($('#csvTasks').value); $('#badgeTasks').textContent='–ó–∞–≤–¥–∞–Ω—å: '+tasks.length; log('–ù–æ—Ç–∞—Ç–∫–∏ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ'); }
  catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ CSV –∑–∞–≤–¥–∞–Ω—å: '+e.message); }
});
$('#clearTasks').addEventListener('click', ()=>{ tasks.length=0; $('#badgeTasks').textContent='–ó–∞–≤–¥–∞–Ω—å: 0'; });

// ===== –Ü–º–ø–æ—Ä—Ç –ø–æ–≥–æ–¥–∏ =====
function parseWx(txt){
  wx.length=0;
  const lines=(txt||'').trim().split(/\r?\n/).filter(Boolean);
  const head=lines.shift(); const cols=head.split(',').map(s=>s.trim());
  const idx=n=>cols.indexOf(n);
  const need=['timestamp','wind_ms','rain_mm','RH','T'];
  for(const n of need){ if(idx(n)===-1) throw new Error('–í—ñ–¥—Å—É—Ç–Ω—ñ–π —Å—Ç–æ–≤–ø–µ—Ü—å: '+n); }
  for(const line of lines){
    const p=line.split(',');
    const t=parseISO(p[idx('timestamp')]); if(!t) continue;
    wx.push({
      t, wind:parseFloat(p[idx('wind_ms')])||0,
      rain:parseFloat(p[idx('rain_mm')])||0,
      RH:parseFloat(p[idx('RH')])||0,
      T:parseFloat(p[idx('T')])||0
    });
  }
  wx.sort((a,b)=>a.t-b.t);
}

function genWx(){
  wx.length=0;
  const start=new Date(); start.setHours(start.getHours()-24,0,0,0);
  for(let i=0;i<120;i++){ // 5 –¥—ñ–±
    const t=new Date(start.getTime()+i*3600000);
    const h=t.getHours();
    const wind=2+2*Math.abs(Math.sin((h-9)/7))+ (Math.random()*0.8-0.4);
    let rain=0; if(h>=16 && h<=18 && Math.random()<0.2) rain=0.6;
    let RH=60+25*Math.sin((h+2)/3.5) + (Math.random()*6-3); if(h>=21||h<=7) RH+=18;
    let T=10+10*Math.sin((h-6)/3.8) + (Math.random()*1.2-0.6);
    RH=Math.max(30,Math.min(100,RH));
    wx.push({t, wind:parseFloat(wind.toFixed(1)), rain:parseFloat(rain.toFixed(1)), RH:Math.round(RH), T:parseFloat(T.toFixed(1))});
  }
}

$('#demoWx').addEventListener('click', ()=>{ genWx(); $('#badgeWx').textContent='–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–≥–æ–¥–∏: '+wx.length; log('–ü–æ–≥–æ–¥—É –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ'); drawGantt(); });
$('#loadWx').addEventListener('click', ()=>{
  try{ parseWx($('#csvWx').value); $('#badgeWx').textContent='–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–≥–æ–¥–∏: '+wx.length; log('–ü–æ–≥–æ–¥—É —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ'); drawGantt(); }
  catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ CSV –ø–æ–≥–æ–¥–∏: '+e.message); }
});
$('#clearWx').addEventListener('click', ()=>{ wx.length=0; $('#badgeWx').textContent='–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–≥–æ–¥–∏: 0'; drawGantt(); });

// ===== –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≥–æ–¥–∏ –¥–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è =====
function wxOK(r){
  const windMax=parseFloat($('#windMax').value)||5;
  const rainMax=parseFloat($('#rainMax').value)||0;
  const tMin=parseFloat($('#tMin').value)||8, tMax=parseFloat($('#tMax').value)||28;
  const rhMin=parseFloat($('#rhMin').value)||40, rhMax=parseFloat($('#rhMax').value)||95;
  return r.wind<=windMax && r.rain<=rainMax && r.T>=tMin && r.T<=tMax && r.RH>=rhMin && r.RH<=rhMax;
}

// ===== –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ =====
function planTasks(){
  plan.length=0;
  if(tasks.length===0 || wx.length===0) { alert('–ü–æ—Ç—Ä—ñ–±–Ω—ñ –Ω–æ—Ç–∞—Ç–∫–∏ —Ç–∞ –ø–æ–≥–æ–¥–∞'); return; }

  // —Ä–æ–±–æ—á—ñ –≥–æ–¥–∏–Ω–∏
  const [sh,sm]=($('#workStart').value||'08:00').split(':').map(Number);
  const [eh,em]=($('#workEnd').value||'20:00').split(':').map(Number);
  const harvest=parseISO($('#harvest').value)||new Date('2100-01-01T00:00');

  // –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å –æ–±–ø—Ä–∏—Å–∫—É–≤–∞—á—ñ–≤
  const sprayers = Math.max(0, parseInt($('#sprayers').value||'1',10));

  // —ñ–Ω–¥–µ–∫—Å—É—î–º–æ –ø–æ–≥–æ–¥—É –ø–æ –≥–æ–¥–∏–Ω–∞—Ö
  const wxByHour = new Map(wx.map(r=>[r.t.toISOString().slice(0,13), r]));

  // —Å–æ—Ä—Ç: –∑–∞ —Ç–∏–ø–æ–º (–Ω–µ—Ö–∞–π –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç), –¥–∞–ª—ñ –∑–∞ —Ä–∞–Ω–Ω—ñ–º –¥–µ–¥–ª–∞–π–Ω–æ–º –≤—ñ–∫–Ω–∞
  const priority=(t)=> t.type.includes('–æ–±–ø—Ä')?0:(t.type.includes('–ø—ñ–¥–∂–∏–≤')?1:(t.type.includes('—Å–∫–∞—É—Ç')?2:3));
  tasks.slice().sort((a,b)=> (priority(a)-priority(b)) || (a.winStart-b.winStart)).forEach(t=>{
    const durH = t.area / Math.max(0.1, t.speed); // –≥–æ–¥–∏–Ω
    // –ø–µ—Ä–µ–±—ñ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–Ω–∏—Ö –≥–æ–¥–∏–Ω —É –≤—ñ–∫–Ω—ñ
    const start = new Date(t.winStart||wx[0].t);
    const end   = new Date(t.winEnd  ||wx[wx.length-1].t);
    let used=0, block=[];
    let currentDay=null, dayUsedSpr=0;

    for(let dt=new Date(start); dt<=end && used<durH; dt=new Date(dt.getTime()+3600000)){
      const hourKey=dt.toISOString().slice(0,13);
      const r=wxByHour.get(hourKey); if(!r) continue;

      // —É –º–µ–∂–∞—Ö —Ä–æ–±–æ—á–æ–≥–æ –¥–Ω—è?
      const hr=dt.getHours(), min=dt.getMinutes();
      const inShift = (hr>sh || (hr===sh && min>=sm)) && (hr<eh || (hr===eh && min<em));
      if(!inShift) continue;

      // –¥–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–µ wxOK —ñ —Ä–µ—Å—É—Ä—Å
      if(t.type.includes('–æ–±–ø—Ä')){
        if(!wxOK(r)) continue;
        // –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–∏—Å—ñ–≤ –Ω–∞ –≥–æ–¥–∏–Ω—É ‚Äî –æ–±–º–µ–∂–∏–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –º–∞—à–∏–Ω
        const key='spr_'+hourKey;
        dayUsedSpr = (usage.get(key)||0);
        if(dayUsedSpr>=sprayers) continue; // —Ä–µ—Å—É—Ä—Å –∑–∞–π–Ω—è—Ç–∏–π
        usage.set(key, dayUsedSpr+1);
      }

      block.push(new Date(dt));
      used+=1;
    }

    if(used>=durH){
      const startAt = block[0];
      const endAt   = new Date(block[0].getTime()+durH*3600000);
      // PHI: –¥–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω—å —ñ–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–º
      if(t.PHI>0 && t.type.includes('–æ–±–ø—Ä')){
        const phiOK = endAt.getTime() <= (new Date(harvest.getTime()-t.PHI*24*3600000)).getTime();
        // —è–∫—â–æ –Ω–µ –û–ö ‚Äî –ø–æ–∑–Ω–∞—á–∏–º–æ, –∞–ª–µ –≤—Å–µ –æ–¥–Ω–æ –¥–æ–¥–∞–º–æ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ
        plan.push({id:t.id, task:t.task, field:t.field, start:startAt, end:endAt, durH:durH.toFixed(1), REI:t.REI, PHI:t.PHI, type:t.type, product:t.product, phiWarn:!phiOK});
      }else{
        plan.push({id:t.id, task:t.task, field:t.field, start:startAt, end:endAt, durH:durH.toFixed(1), REI:t.REI, PHI:t.PHI, type:t.type, product:t.product, phiWarn:false});
      }
    }
  });

  renderPlan();
}

const usage=new Map(); // –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞—á—ñ–≤ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö

function renderPlan(){
  const tb=$('#tblPlan tbody'); tb.innerHTML='';
  plan.sort((a,b)=>a.start-b.start);
  plan.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.task}</td><td>${p.field}</td><td>${fmt(p.start)}</td><td>${fmt(p.end)}</td><td>${p.durH}</td><td>${p.REI||0} –≥–æ–¥</td><td>${p.PHI||0} –¥–Ω</td>`;
    if(p.phiWarn) tr.querySelectorAll('td')[7].classList.add('bad');
    tb.appendChild(tr);
  });
  $('#badgePlan').textContent='–ü–ª–∞–Ω: '+plan.length+' –∑–∞–¥–∞—á';
  drawGantt();
}

// ===== –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ =====
function checkConflicts(){
  const tb=$('#tblConf tbody'); tb.innerHTML='';
  function row(type,details,ok){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${type}</td><td class="small">${details}</td><td class="${ok?'ok':'bad'}">${ok?'OK':'PROBLEM'}</td>`; tb.appendChild(tr); }

  // 1) –ü–µ—Ä–µ—Ç–∏–Ω —Ä–µ—Å—É—Ä—Å—ñ–≤ –¥–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω—å: –ª—ñ–º—ñ—Ç –º–∞—à–∏–Ω
  let resOK=true;
  const sprayers = Math.max(0, parseInt($('#sprayers').value||'1',10));
  const occupancy=new Map();
  plan.filter(p=>p.type.includes('–æ–±–ø—Ä')).forEach(p=>{
    for(let t=new Date(p.start); t<p.end; t=new Date(t.getTime()+3600000)){
      const k=t.toISOString().slice(0,13);
      occupancy.set(k,(occupancy.get(k)||0)+1);
    }
  });
  const over=[...occupancy.entries()].filter(([k,v])=>v>sprayers).map(([k,v])=>`${k}: ${v}/${sprayers}`);
  resOK = over.length===0;
  row('–†–µ—Å—É—Ä—Å–∏ –æ–±–ø—Ä–∏—Å–∫—É–≤–∞—á—ñ–≤', resOK?'–Ω–µ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ':'–ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ —É: '+over.join(', '), resOK);

  // 2) REI: –∑–∞–¥–∞—á—ñ (–Ω–µ —Å–∫–∞—É—Ç–∏–Ω–≥) –Ω–∞ —Ç–æ–º—É –∂ –ø–æ–ª—ñ –≤ REI –ø—ñ—Å–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è
  let reiOK=true; const reiIssues=[];
  plan.forEach(a=>{
    if(!a.type.includes('–æ–±–ø—Ä') || !a.REI) return;
    const reiEnd=new Date(a.end.getTime()+a.REI*3600000);
    plan.forEach(b=>{
      if(b===a) return;
      if(b.field===a.field && !b.type.includes('—Å–∫–∞—É—Ç') && b.start<reiEnd && b.start>=a.end){
        reiOK=false; reiIssues.push(`${b.task} (${fmt(b.start)}) –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ REI –ø—ñ—Å–ª—è ${a.task} (–¥–æ ${fmt(reiEnd)})`);
      }
    });
  });
  row('REI (—Ä–µ-entry)', reiOK?'–ø–æ—Ä—É—à–µ–Ω—å –Ω–µ–º–∞—î':reiIssues.join('; '), reiOK);

  // 3) PHI: –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è –±–ª–∏–∂—á–µ –¥–æ –∑–±–æ—Ä—É, –Ω—ñ–∂ –¥–æ–∑–≤–æ–ª–µ–Ω–æ
  let phiOK=true; const phiIssues=[];
  plan.forEach(p=>{ if(p.type.includes('–æ–±–ø—Ä') && p.PHI>0 && p.phiWarn){ phiOK=false; phiIssues.push(`${p.task} ‚Üí PHI=${p.PHI} –¥–Ω –Ω–µ –≤–∫–ª–∞–¥–∞—î—Ç—å—Å—è –¥–æ –∑–±–æ—Ä—É`); } });
  row('PHI (–ø–µ—Ä—ñ–æ–¥ –¥–æ –∑–±–æ—Ä—É)', phiOK?'–æ–∫':'—î –ø–æ—Ä—É—à–µ–Ω–Ω—è: '+phiIssues.join('; '), phiOK);

  // 4) –ü–æ–≥–æ–¥–Ω—ñ —É–º–æ–≤–∏ —É –ø–ª–∞–Ω–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ (–ª–∏—à–µ –¥–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω—å)
  let wxOk=true; const wxIssues=[];
  const wxByHour = new Map(wx.map(r=>[r.t.toISOString().slice(0,13), r]));
  plan.filter(p=>p.type.includes('–æ–±–ø—Ä')).forEach(p=>{
    for(let t=new Date(p.start); t<p.end; t=new Date(t.getTime()+3600000)){
      const r=wxByHour.get(t.toISOString().slice(0,13));
      if(!r || !wxOK(r)){ wxOk=false; wxIssues.push(`${p.task} @ ${fmt(t)}`); break; }
    }
  });
  row('–ü–æ–≥–æ–¥–Ω—ñ —É–º–æ–≤–∏ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è', wxOk?'–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å':'–Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —É: '+wxIssues.slice(0,6).join(', ')+(wxIssues.length>6?'‚Ä¶':''), wxOk);
}

// ===== Gantt =====
const g=$('#gantt'), gctx=g.getContext('2d');
function drawGantt(){
  const W=g.width,H=g.height;
  gctx.clearRect(0,0,W,H);
  gctx.strokeStyle='#223049'; gctx.strokeRect(0.5,0.5,W-1,H-1);

  if(plan.length===0 && wx.length===0){ return; }

  // —á–∞—Å–æ–≤–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω
  const t0 = wx.length? wx[0].t : (plan.length? plan[0].start : new Date());
  const t1 = wx.length? wx[wx.length-1].t : (plan.length? plan[plan.length-1].end : new Date(t0.getTime()+72*3600000));
  const spanH = Math.max(24, Math.round((t1-t0)/3600000));

  // —Å—ñ—Ç–∫–∞ –¥–Ω—ñ–≤
  const pxPerH = (W-80)/spanH; // –ª—ñ–≤–∏–π –±–æ—Ä–¥—é—Ä –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤
  for(let h=0; h<=spanH; h++){
    const x=80+h*pxPerH;
    gctx.strokeStyle= (h%24===0)? '#2a3a59':'#18243b';
    gctx.beginPath(); gctx.moveTo(x,0); gctx.lineTo(x,H); gctx.stroke();
    if(h%24===0){
      const d=new Date(t0.getTime()+h*3600000);
      gctx.fillStyle='#94a3b8'; gctx.font='12px ui-monospace';
      gctx.fillText(d.toISOString().slice(5,10), x+4, 14);
    }
  }

  // –ø–æ–≥–æ–¥–∞: –ø—Ä–∏–¥–∞—Ç–Ω—ñ –≥–æ–¥–∏–Ω–∏ –¥–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω–Ω—è ‚Äî –ø—ñ–¥—Å–≤—ñ—Ç–∏–º–æ
  const yWx=24;
  gctx.fillStyle='#0f1f39'; gctx.fillRect(80,yWx, W-90, 14);
  wx.forEach(r=>{
    const h=Math.round((r.t-t0)/3600000);
    const x=80+h*pxPerH;
    gctx.fillStyle = wxOK(r)? '#1f6feb' : '#5b2337';
    gctx.fillRect(x, yWx, Math.max(1,pxPerH-1), 14);
  });
  gctx.fillStyle='#94a3b8'; gctx.fillText('–ü–æ–≥–æ–¥–∞ (–æ–∫–Ω–æ –¥–ª—è –æ–±–ø—Ä.)', 4, yWx+11);

  // –ø–ª–∞–Ω ‚Äî —Ä—è–¥–∫–∏
  const rowH=18; let row=0;
  plan.forEach(p=>{
    const y=60+row*rowH; row++;
    const x0=80+ ((p.start - t0)/3600000)*pxPerH;
    const x1=80+ ((p.end   - t0)/3600000)*pxPerH;
    gctx.fillStyle = p.type.includes('–æ–±–ø—Ä')? '#22c55e' : (p.type.includes('—Å–∫–∞—É—Ç')? '#38bdf8' : '#fbbf24');
    gctx.fillRect(x0, y, Math.max(2,x1-x0), rowH-4);
    gctx.fillStyle='#e6eef9'; gctx.font='12px ui-monospace';
    gctx.fillText(p.task.slice(0,28), 6, y+12);
  });
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç–∏ =====
function toICS(){
  if(plan.length===0) return '';
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//EDLab//Agro Planner//UA'];
  plan.forEach((p,i)=>{
    const dt=(d)=>d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
    lines.push('BEGIN:VEVENT');
    lines.push('UID:'+ ('para25-'+i+'-'+Date.now())+'@edlab');
    lines.push('DTSTART:'+dt(p.start));
    lines.push('DTEND:'+dt(p.end));
    lines.push('SUMMARY:'+p.task+' ‚Äî '+p.field);
    lines.push('DESCRIPTION:–¢–∏–ø='+p.type+'; REI='+p.REI+'h; PHI='+p.PHI+'d; –ü—Ä–µ–ø–∞—Ä–∞—Ç='+ (p.product||'-'));
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

function toCSV(){
  const head='id,task,field,type,product,start,end,duration_h,REI_h,PHI_d\n';
  const body=plan.map((p,i)=>[i+1,p.task,p.field,p.type,p.product||'',p.start.toISOString(),p.end.toISOString(),p.durH,p.REI||0,p.PHI||0].map(v=>typeof v==='string'?`"${v.replace(/"/g,'""')}"`:v).join(',')).join('\n');
  return head+body;
}

function toTXT(){
  const lines=[
    '–ü–∞—Ä–∞ 25 ‚Äî –®–Ü-–ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ —Ä–æ–±—ñ—Ç',
    '–ó–∞–≤–¥–∞–Ω—å —É –ø–ª–∞–Ω—ñ: '+plan.length,
    '--- –ü–ª–∞–Ω ---'
  ];
  plan.forEach((p,i)=>lines.push(`${i+1}. ${p.task} (${p.field}) ${fmt(p.start)} ‚Üí ${fmt(p.end)} | ${p.durH} –≥–æ–¥ | REI=${p.REI}h | PHI=${p.PHI}d`));
  lines.push('--- –ö—ñ–Ω–µ—Ü—å ---');
  return lines.join('\n');
}

$('#exportICS').addEventListener('click', ()=>{ const ics=toICS(); if(!ics){alert('–°–ø–µ—Ä—à—É –∑–≥–µ–Ω–µ—Ä—É–π –ø–ª–∞–Ω');return;} download('agro_para25_'+stamp()+'.ics', ics, 'text/calendar'); });
$('#exportCSV').addEventListener('click', ()=>{ const csv=toCSV(); if(!csv){alert('–°–ø–µ—Ä—à—É –∑–≥–µ–Ω–µ—Ä—É–π –ø–ª–∞–Ω');return;} download('agro_para25_'+stamp()+'.csv', csv, 'text/csv'); });
$('#exportTXT').addEventListener('click', ()=>{ const txt=toTXT(); if(!txt){alert('–°–ø–µ—Ä—à—É –∑–≥–µ–Ω–µ—Ä—É–π –ø–ª–∞–Ω');return;} download('agro_para25_'+stamp()+'.txt', txt); });

// 58-–º–º —á–µ–∫ –Ω–∞ –¥–µ–Ω—å (–≤–∏–±–∏—Ä–∞—î–º–æ –¥–∞—Ç—É –ø–µ—Ä—à–æ–≥–æ —ñ–≤–µ–Ω—Ç—É)
$('#dayReceipt').addEventListener('click', ()=>{
  if(plan.length===0){ alert('–ù–µ–º–∞—î –ø–ª–∞–Ω—É'); return; }
  const day = new Date(plan[0].start); day.setHours(0,0,0,0);
  const lines=[];
  lines.push('=== –ß–ï–ö –†–û–ë–Ü–¢ (58–º–º) ===');
  lines.push('–î–∞—Ç–∞: '+day.toISOString().slice(0,10));
  plan.filter(p=>{const d=new Date(p.start); d.setHours(0,0,0,0); return d.getTime()===day.getTime();})
      .forEach(p=>{
        lines.push((p.task+' '+p.field).slice(0,28));
        lines.push(fmt(p.start)+' ‚Üí '+fmt(p.end));
        lines.push('REI:'+ (p.REI||0)+'h PHI:'+ (p.PHI||0)+'d');
        lines.push('---');
      });
  const el=$('#receipt'); el.hidden=false; el.textContent=lines.join('\n');
  download('para25_receipt_'+stamp()+'.txt', lines.join('\n'));
});

// ===== –ü—Ä–æ–º–ø—Ç –¥–æ LLM =====
function buildPrompt(){
  if(plan.length===0) return '// –ó–≥–µ–Ω–µ—Ä—É–π –ø–ª–∞–Ω —Å–ø–æ—á–∞—Ç–∫—É';
  const sprayers = Math.max(0, parseInt($('#sprayers').value||'1',10));
  const rules = `–û–±–º–µ–∂–µ–Ω–Ω—è: –æ–±–ø—Ä–∏—Å–∫—É–≤–∞—á—ñ–≤=${sprayers}, —Ä–æ–±–æ—á—ñ –≥–æ–¥–∏–Ω–∏ ${$('#workStart').value}-${$('#workEnd').value}, –ø–æ–≥–æ–¥–∞: wind‚â§${$('#windMax').value} –º/—Å, rain‚â§${$('#rainMax').value} –º–º/–≥–æ–¥, ${$('#tMin').value}‚â§T‚â§${$('#tMax').value}¬∞C, ${$('#rhMin').value}‚â§RH‚â§${$('#rhMax').value}%. Harvest=${$('#harvest').value}.`;
  const items = plan.map(p=>({task:p.task, field:p.field, start:p.start.toISOString(), end:p.end.toISOString(), REI:p.REI, PHI:p.PHI, type:p.type, product:p.product||''}));
  return `–¢–∏ ‚Äî –∞–≥—Ä–æ–Ω–æ–º-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä. –ü–µ—Ä–µ–≤—ñ—Ä —ñ, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏, –ø–µ—Ä–µ–ø–ª–∞–Ω—É–π –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º REI/PHI, –ø–æ–≥–æ–¥–Ω–∏—Ö –≤—ñ–∫–æ–Ω —ñ —Ä–µ—Å—É—Ä—Å—ñ–≤.
–ü—Ä–∞–≤–∏–ª–∞: ${rules}
–ü–æ—Ç–æ—á–Ω–∏–π –ø–ª–∞–Ω (JSON):
${JSON.stringify(items,null,2)}

–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ:
1) –ü–æ–∑–Ω–∞—á –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ (—Ä–µ—Å—É—Ä—Å–∏, REI, PHI, –ø–æ–≥–æ–¥–∞) —Ç–∞ –ø–æ—è—Å–Ω–∏ —è–∫ —ó—Ö –≤–∏–ø—Ä–∞–≤–∏—Ç–∏.
2) –î–∞–π 2 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ —Ä–æ–∑–∫–ª–∞–¥–∏: a) –º—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è —Ä–∏–∑–∏–∫—ñ–≤; b) –º—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ—Å—Ç–æ—ó–≤/–ø–µ—Ä–µ—ó–∑–¥—ñ–≤.
3) –î–ª—è –æ–±–ø—Ä–∏—Å–∫—É–≤–∞–Ω—å ‚Äî –ø–æ–∑–Ω–∞—á –≤—ñ–∫–Ω–∞ –∑ –∫—Ä–∞—â–∏–º –ø–æ–∫—Ä–∏—Ç—Ç—è–º (RH/–≤—ñ—Ç–µ—Ä) —ñ Z–Ü–ó/REI/PHI.
4) –ü–æ–∫–∞–∂–∏ —Ä—ñ–∑–Ω–∏—Ü—é –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á –ø–æ –¥–Ω—è—Ö.
–§–æ—Ä–º–∞—Ç: —Ç–∞–±–ª–∏—Ü—ñ + –∫–æ—Ä–æ—Ç–∫–∏–π –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å.`;
}

$('#genPrompt').addEventListener('click', ()=>{ $('#prompt').textContent=buildPrompt(); });
$('#copyPrompt').addEventListener('click', ()=>{ const ta=document.createElement('textarea'); ta.value=$('#prompt').textContent; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); });
$('#savePrompt').addEventListener('click', ()=>{ const txt=$('#prompt').textContent||buildPrompt(); download('para25_prompt_'+stamp()+'.txt',txt); });

// ===== –ü–æ–¥—ñ—ó –≥–æ–ª–æ–≤–Ω—ñ =====
function log(msg){ const t=new Date().toLocaleTimeString(); const el=$('.log'); if(el){ el.textContent += `[${t}] ${msg}\n`; el.scrollTop=el.scrollHeight; } }
$('#plan').addEventListener('click', ()=>{ usage.clear(); planTasks(); log('–ü–ª–∞–Ω —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ'); });
$('#check').addEventListener('click', ()=>{ checkConflicts(); log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ'); });
$('#clearPlan').addEventListener('click', ()=>{ plan.length=0; $('#tblPlan tbody').innerHTML=''; $('#tblConf tbody').innerHTML=''; $('#badgePlan').textContent='–ü–ª–∞–Ω: ‚Äî'; drawGantt(); });

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
drawGantt();
if (window.self !== window.top) document.documentElement.classList.add('embedded'); // Moodle-friendly
</script>
</body>
</html>
