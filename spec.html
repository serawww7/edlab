<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EDLab ‚Äî —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–æ–∑–¥—ñ–ª—É</title>
<meta name="color-scheme" content="light dark"/>
<link rel="preload" href="assets/edlab.css" as="style">
<link rel="stylesheet" href="assets/edlab.css"/>
<style>
.header-mini{display:flex;justify-content:space-between;align-items:center;gap:12px}
.grid2{display:grid;gap:16px;grid-template-columns:2fr 1fr}
@media(max-width:980px){.grid2{grid-template-columns:1fr}}
.lesson-list .lesson{position:relative}
.lesson-list .btn{position:relative;z-index:2}
.tester-toolbar{display:flex;justify-content:space-between;gap:8px;align-items:center;background:#0d1a2e;color:#e6eef9;border:1px solid #223049;border-bottom:0;border-radius:12px 12px 0 0;padding:8px 12px}
.tester{border:1px solid #223049;border-radius:0 0 12px 12px;overflow:hidden;background:#0b1220}
.tester iframe{width:100%;height:900px;border:0;background:#fff;display:block}
.btn.ghost{background:transparent;border-color:#334155;color:#cbd5e1}
.btn.ghost:hover{background:#0f1f39}
small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
.note{background:#0c182a;color:#cde1ff;border:1px dashed #274364;padding:10px 12px;border-radius:12px;margin-top:8px}
.note.error{background:#230b0b;color:#ffd4d4;border-color:#8a2b2b}
.debugbox{background:#0c182a;color:#cde1ff;border:1px dashed #274364;padding:10px 12px;border-radius:12px;margin-top:8px;display:none}
.debugbox table{width:100%;border-collapse:collapse;font-size:13px}
.debugbox th,.debugbox td{border-bottom:1px solid #243b55;padding:6px 8px;text-align:left;vertical-align:top;word-break:break-all}
.debug-actions{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.selector{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:12px}
.selector a{display:block;padding:16px;border:1px solid #223049;border-radius:12px;background:#0b1220;text-decoration:none}
.selector a:hover{background:#0f1f39}
.badge2{font-size:12px;padding:2px 6px;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
</style>
</head>
<body>
<div class="wrap">
  <header class="header-mini">
    <div class="logo">
      <span class="emoji">üéì</span><b>EDLab</b>
      <span class="badge">—Ü–∏—Ñ—Ä–æ–≤—ñ –ø–∞—Ä–∏ –¥–ª—è –û–ü–ü –∫–æ–ª–µ–¥–∂—É</span>
    </div>
    <a class="btn" href="index.html">‚¨Ö –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </header>

  <h1 id="specTitle">–†–æ–∑–¥—ñ–ª</h1>
  <p class="muted" id="specDesc">‚Äî</p>

  <div class="grid2">
    <div class="card lesson-list" id="listCard">
      <h2 id="listTitle">–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</h2>
      <div id="lessons"></div>

      <div id="hintBox" class="note" style="display:none">‚Äî</div>

      <div class="debug-actions">
        <button class="btn ghost" type="button" id="toggleDebug">üîç –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ</button>
        <button class="btn ghost" type="button" id="refreshNow">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ (–æ–±—ñ–π—Ç–∏ –∫–µ—à)</button>
        <span class="badge2" id="cacheInfo">–∫–µ—à: ‚Äî</span>
      </div>
      <div id="debugBox" class="debugbox">
        <div><b>–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</b> ‚Äî GitHub API ‚Üí —à–ª—è—Ö–∏ ‚Üí –∞–±—Å–æ–ª—é—Ç–Ω—ñ URL</div>
        <div id="debugTableWrap" style="margin-top:8px"></div>
      </div>

      <div id="previewBox" style="display:none;margin-top:14px">
        <div class="tester-toolbar">
          <div class="row">
            <strong>–®–≤–∏–¥–∫–µ –ø—Ä–µ–≤‚Äô—é</strong>
            <span class="muted mono" id="previewUrl">‚Äî</span>
          </div>
          <div class="row">
            <button class="btn ghost" type="button" id="toGen">‚öôÔ∏è –î–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</button>
            <button class="btn" type="button" id="closePrev">‚úñÔ∏è –ó–∞–∫—Ä–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é</button>
          </div>
        </div>
        <div class="tester">
          <iframe id="previewFrame" src="about:blank"
                  sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-downloads"
                  referrerpolicy="no-referrer"></iframe>
        </div>
      </div>
      <p class="muted" id="previewNote" style="display:none;margin-top:6px">–ü–æ—Ä–∞–¥–∞: –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ iFrame¬ª ‚Äî –∫–æ–¥ —Å–ø—Ä–∞–≤–∞ –≤–∂–µ –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º URL.</p>
    </div>

    <div class="card" id="generator">
      <h2>üîß –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–¥—É –¥–ª—è Moodle (iFrame)</h2>
      <label for="url">URL —Å—Ç–æ—Ä—ñ–Ω–∫–∏</label>
      <input id="url" type="text" value=""/>

      <div class="inline">
        <div>
          <label for="height">–í–∏—Å–æ—Ç–∞ —Ñ—Ä–µ–π–º–∞ (px)</label>
          <input id="height" type="number" value="1600"/>
        </div>
        <div>
          <label for="sandbox">Sandbox —Ç–æ–∫–µ–Ω–∏</label>
          <input id="sandbox" type="text" value="allow-same-origin allow-scripts allow-forms allow-modals allow-downloads"/>
        </div>
      </div>

      <label for="code">HTML-–∫–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —É Moodle</label>
      <textarea id="code" readonly></textarea>

      <div class="row" style="margin-top:8px">
        <button class="btn" type="button" id="btnGen">üîÅ –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–¥</button>
        <button class="btn" type="button" id="btnCopy">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
      </div>
      <p class="muted" style="margin-top:6px">–†–µ–∂–∏–º–∏ –≤—Å—Ç–∞–≤–∫–∏: <b>Page</b> –∞–±–æ <b>URL (Display: Embed)</b>. –Ø–∫—â–æ –∫–Ω–æ–ø–∫–∏ ¬´–Ω—ñ–º—ñ¬ª ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä —Ñ—ñ–ª—å—Ç—Ä–∏ —Ä–µ—Å—É—Ä—Å—É –∞–±–æ –∑–º–µ–Ω—à –Ω–∞–±—ñ—Ä sandbox.</p>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="col brand">
      <div class="brand-line"><span class="emoji">üåæ</span><strong>EDLab</strong></div>
      <p>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ñ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ñ —Ç–∞ –∫–æ—É—á-—Ç—Ä–µ–Ω—ñ–Ω–≥–∏.</p>
    </div>
    <div class="col legal">
      <h3>–ü—Ä–∞–≤–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
      <p>¬© 2025 <b>–°–µ—Ä–≥—ñ–π –ü–û–õ–Ü–©–£–ö</b>. –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∑–∞—Ö–∏—â–µ–Ω—ñ –∞–≤—Ç–æ—Ä—Å—å–∫–∏–º –ø—Ä–∞–≤–æ–º.</p>
    </div>
    <div class="col links">
      <h3>–û—Ñ—ñ—Ü—ñ–π–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏</h3>
      <ul>
        <li><a href="index.html">–ì–æ–ª–æ–≤–Ω–∞ EDLab</a></li>
        <li><a href="https://www.serawww.pp.ua" target="_blank" rel="noopener">serawww.pp.ua</a></li>
        <li><a href="https://www.facebook.com/coach.Sergiy" target="_blank" rel="noopener">facebook.com/coach.Sergiy</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom"><span>–ó—Ä–æ–±–ª–µ–Ω–æ –∑ —Ç—É—Ä–±–æ—Ç–æ—é –ø—Ä–æ –∑—Ä—É—á–Ω—ñ—Å—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ —ñ —Å—Ç—É–¥–µ–Ω—Ç–∞</span></div>
</footer>

<script>
// ========= –ë–ê–ó–ê: —Å–∞–π—Ç –ø—ñ–¥ /edlab =========
const APP_BASE = location.pathname.replace(/\/spec\.html.*$/,''); // –Ω–∞–ø—Ä. '/edlab'
function withBase(p){
  if(/^https?:\/\//i.test(p)) return p;
  if(p.startsWith(APP_BASE + '/')) return location.origin + p;
  if(p.startsWith('/')) return location.origin + APP_BASE + p;
  return location.origin + APP_BASE + '/' + p;
}

// ========= GitHub API –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ =========
const GH_OWNER = 'serawww7';
const GH_REPO  = 'edlab';
const GH_REF   = 'main';

// ========= –ú–µ—Ç–∞–¥–∞–Ω—ñ —Å–µ–∫—Ü—ñ–π =========
const SECTION_META = {
  coach:   { title:"üß† –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω—ñ —Ç—Ä–µ–Ω—ñ–Ω–≥–∏ (coach)", desc:"–ö–æ—É—á–∏–Ω–≥–æ–≤—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏, —Ä–µ—Ñ–ª–µ–∫—Å—ñ—è, soft skills, —Ä–æ–±–æ—Ç–∞ –≤ –≥—Ä—É–ø–∞—Ö.", folder:'coach' },
  electric:{ title:"‚ö° –ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞/–µ–ª–µ–∫—Ç—Ä–∏–∫–∞",    desc:"–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è, –ü–ü–†, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∏ –ø–µ—Ä–µ—Ä—ñ–∑—ñ–≤, –∂—É—Ä–Ω–∞–ª–∏ –û–ü.", folder:'elect_II_kyrs' },
  agro:    { title:"üåæ –ê–≥—Ä–æ–Ω–æ–º—ñ—è",                      desc:"–ü–æ–ª—å–æ–≤—ñ –∂—É—Ä–Ω–∞–ª–∏, –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è, –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥–∏, QR/NFC.", folder:'agro' },
  mech:    { title:"üöú –ú–µ—Ö–∞–Ω—ñ–∑–∞—Ü—ñ—è (–º–µ—Ö–∞–Ω—ñ–∫–∏)",         desc:"–¢–û/–ü–ü–†, –æ–±–ª—ñ–∫ –ø–∞–ª—å–Ω–æ–≥–æ, –∑–∞—è–≤–∫–∏, –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –±–µ–∑–ø–µ–∫–∞.", folder:'mech' },
  tech:    { title:"üêÑ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞",        desc:"HACCP/FSMS, SPC, –ø—Ä–æ—Å—Ç–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å, –∞—É–¥–∏—Ç, CAPA.", folder:'tech' }
};
const SECTION_KEYS = Object.keys(SECTION_META);

// ========= –ö–µ—à (7 –¥–Ω—ñ–≤) =========
const CACHE_KEY = 'edlab_manifest_cache_v2';
const CACHE_TTL_MS = 7*24*60*60*1000;
function readCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||'{}'); }catch{ return {}; } }
function writeCache(obj){ localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
function setCacheInfo(ts){
  const el = document.getElementById('cacheInfo');
  if(!ts){ el.textContent = '–∫–µ—à: ‚Äî'; return; }
  el.textContent = '–∫–µ—à: ' + new Date(ts).toLocaleString();
}

// ========= –£—Ç–∏–ª—ñ—Ç–∏ UI =========
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
function humanizeFromPath(p){
  const name = (p||'').split('/').pop() || p;
  return name.replace(/[-_]/g,' ').replace(/\.html?$/i,'').trim();
}
function lessonCard(item){
  return `
    <div class="lesson">
      <div class="thumb">üìÑ</div>
      <div class="meta">
        <b>${item.title}</b>
        <small class="mono">${item.url}</small>
        <p class="muted" style="margin-top:4px">${item.desc||""}</p>
        <div class="row" style="margin-top:8px">
          <a class="btn" href="${withBase(item.url)}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a>
          <button class="btn secondary js-preview" type="button" data-url="${item.url}">–®–≤–∏–¥–∫–µ –ø—Ä–µ–≤‚Äô—é</button>
          <button class="btn secondary js-iframe"  type="button" data-url="${item.url}">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ iFrame</button>
        </div>
      </div>
    </div>`;
}

// ========= –ö–ª—é—á —Ä–æ–∑–¥—ñ–ª—É –∑ URL =========
function getSpecKey(){
  const sp = new URLSearchParams(location.search).get('spec');
  if (sp && SECTION_KEYS.includes(sp.toLowerCase())) return sp.toLowerCase();
  const h = (location.hash||'').replace(/^#/, '').trim();
  if (h.startsWith('spec=')){
    const v = h.slice(5).toLowerCase();
    if (SECTION_KEYS.includes(v)) return v;
  }
  return null;
}

// ========= GitHub API (–¥–µ—Ä–µ–≤–æ) =========
async function getTreeSha(){
  const u = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/branches/${GH_REF}`;
  const res = await fetch(u, {cache:'no-store'});
  if(!res.ok) throw new Error('GitHub branches: '+res.status);
  const j = await res.json();
  return j.commit?.commit?.tree?.sha;
}
async function getFullTree(treeSha){
  const u = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/git/trees/${treeSha}?recursive=1`;
  const res = await fetch(u, {cache:'no-store'});
  if(!res.ok) throw new Error('GitHub trees: '+res.status);
  const j = await res.json();
  return Array.isArray(j.tree) ? j.tree : [];
}

// **–ê–í–¢–û–î–ï–¢–ï–ö–¢ –ø—Ä–µ—Ñ—ñ–∫—Å–∞ —É –¥–µ—Ä–µ–≤—ñ ('', 'edlab/')**
function detectTreePrefix(tree){
  const has = pfx => tree.some(n => n.type==='blob' && n.path.startsWith(pfx+'coach/'));
  if (has('edlab/')) return 'edlab/';
  return ''; // —Ñ–∞–π–ª–∏ –ª–µ–∂–∞—Ç—å –∑ –∫–æ—Ä–µ–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
}

// –ü–æ–±—É–¥—É–≤–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –∑–∞ –¥–µ—Ä–µ–≤–æ–º –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ø—Ä–µ—Ñ—ñ–∫—Å–∞
function buildListFromTree(tree, key, treePrefix){
  const meta = SECTION_META[key];
  const sectionPrefix = `${treePrefix}${meta.folder}/`;  // 'edlab/coach/' –∞–±–æ 'coach/'
  const files = tree
    .filter(n => n.type === 'blob' && n.path.startsWith(sectionPrefix) && /\.html?$/i.test(n.path))
    .map(n => '/' + ( // –ø—É–±–ª—ñ—á–Ω–∏–π URL –∑–∞–≤–∂–¥–∏ –ø—ñ–¥ /edlab/...
      n.path.startsWith('edlab/') ? n.path : ('edlab/' + n.path)
    ));
  files.sort((a,b)=>a.localeCompare(b,'uk'));
  return files.map(url => ({ url, title: humanizeFromPath(url), desc: url }));
}

// ========= –í–∏–±—ñ—Ä —Ä–æ–∑–¥—ñ–ª—ñ–≤ =========
function renderSelector(){
  byId('specTitle').textContent = '–í–∏–±–µ—Ä–∏ —Ä–æ–∑–¥—ñ–ª';
  byId('specDesc').textContent  = '–û–±–µ—Ä—ñ—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –Ω–∞–ø—Ä—è–º —ñ–∑ –ø–µ—Ä–µ–ª—ñ–∫—É –Ω–∏–∂—á–µ.';
  byId('listTitle').textContent = '–î–æ—Å—Ç—É–ø–Ω—ñ —Ä–æ–∑–¥—ñ–ª–∏';
  byId('lessons').innerHTML = `
    <div class="selector">
      <a href="spec.html?spec=agro">üåæ –ê–≥—Ä–æ–Ω–æ–º—ñ—è</a>
      <a href="spec.html?spec=mech">üöú –ú–µ—Ö–∞–Ω—ñ–∑–∞—Ü—ñ—è (–º–µ—Ö–∞–Ω—ñ–∫–∏)</a>
      <a href="spec.html?spec=tech">üêÑ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞</a>
      <a href="spec.html?spec=electric">‚ö° –ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞/–µ–ª–µ–∫—Ç—Ä–∏–∫–∞</a>
      <a href="spec.html?spec=coach">üß† –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω—ñ —Ç—Ä–µ–Ω—ñ–Ω–≥–∏ (coach)</a>
    </div>`;
}

// ========= –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ =========
let __lastUrls = [];
function renderDebug(urls){
  const wrap = byId('debugTableWrap');
  if(!Array.isArray(urls) || !urls.length){
    wrap.innerHTML = '<div class="muted">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</div>';
    return;
  }
  const rows = urls.map(raw=>{
    const abs = withBase(raw);
    return `<tr><td><small class="mono">${raw}</small></td><td><small class="mono"><a href="${abs}" target="_blank" rel="noopener">${abs}</a></small></td></tr>`;
  }).join('');
  wrap.innerHTML = `<table><thead><tr><th>RAW</th><th>absolute</th></tr></thead><tbody>${rows}</tbody></table>`;
}

// ========= –ü–æ–±—É–¥–æ–≤–∞ —Å–µ–∫—Ü—ñ—ó =========
async function buildSection(key, forceRefresh=false){
  const meta = SECTION_META[key];
  byId('specTitle').textContent = meta.title;
  byId('specDesc').textContent  = meta.desc;
  byId('listTitle').textContent = meta.title + ' ‚Äî –º–∞—Ç–µ—Ä—ñ–∞–ª–∏';

  const hint = byId('hintBox');
  hint.style.display = 'none';
  hint.classList.remove('error');

  const cache = readCache();
  const now = Date.now();
  setCacheInfo(cache.ts);

  if(!forceRefresh && cache.ts && (now - cache.ts) < CACHE_TTL_MS && cache[key] && Array.isArray(cache[key]) && cache[key].length){
    __lastUrls = cache[key].map(i=>i.url);
    byId('lessons').innerHTML = cache[key].map(lessonCard).join('');
    const firstAbs = withBase(cache[key][0].url); byId('url').value = firstAbs; gen();
    return;
  }

  try{
    const treeSha = await getTreeSha();
    const tree    = await getFullTree(treeSha);
    const treePrefix = detectTreePrefix(tree); // '' –∞–±–æ 'edlab/'
    const list    = buildListFromTree(tree, key, treePrefix);

    __lastUrls = list.map(i=>i.url);

    if(!list.length){
      hint.textContent = `–£ —Ä–æ–∑–¥—ñ–ª—ñ "${key}" HTML-—Ñ–∞–π–ª—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–∑–∞ GitHub API). –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ñ–∞–π–ª–∏ –ª–µ–∂–∞—Ç—å —É /${treePrefix}${meta.folder}/ —Ç–∞ –º–∞—é—Ç—å —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è .html/.htm`;
      hint.classList.add('error'); hint.style.display='';
      byId('lessons').innerHTML = '';
      byId('debugBox').style.display = '';
      renderDebug(__lastUrls);
      cache[key] = []; cache.ts = now; writeCache(cache); setCacheInfo(cache.ts);
      return;
    }

    byId('lessons').innerHTML = list.map(lessonCard).join('');
    const firstAbs = withBase(list[0].url); byId('url').value = firstAbs; gen();
    byId('debugBox').style.display = 'none';

    cache[key] = list; cache.ts = now; writeCache(cache); setCacheInfo(cache.ts);

  }catch(e){
    hint.textContent = `–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ GitHub API: ${e?.message||e}. –ú–æ–∂–ª–∏–≤–æ, –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤ (60/–≥–æ–¥).`;
    hint.classList.add('error'); hint.style.display='';
    byId('debugBox').style.display = '';
    renderDebug([]);
  }
}

// ========= –ü—Ä–µ–≤‚Äô—é + –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä =========
function openPreview(u){
  const abs = withBase(u);
  byId('previewUrl').textContent = abs;
  byId('previewFrame').src = abs;
  byId('previewBox').style.display = '';
  byId('previewNote').style.display = '';
  window.scrollTo({top: byId('previewBox').getBoundingClientRect().top + window.scrollY - 20, behavior:'smooth'});
}
function closePreview(){ byId('previewFrame').src='about:blank'; byId('previewBox').style.display='none'; byId('previewNote').style.display='none'; }
function gen(){
  const url = byId('url').value.trim();
  const h   = parseInt(byId('height').value,10) || 1600;
  const sb  = byId('sandbox').value.trim();
  const html =
`<div style="max-width:980px;margin:0 auto;position:relative;z-index:1;">
  <iframe
    src="${url}"
    style="width:100%;height:${h}px;border:0;display:block;pointer-events:auto;background:#fff;"
    loading="eager"
    referrerpolicy="no-referrer"
    sandbox="${sb}">
  </iframe>
</div>`;
  byId('code').value = html;
}
function copyCode(){
  const ta = byId('code'); ta.select(); ta.setSelectionRange(0, ta.value.length);
  document.execCommand('copy');
  const old = document.title; document.title='‚úÖ HTML —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ';
  setTimeout(()=>document.title=old,900);
}

// ========= –ü–æ–¥—ñ—ó =========
document.addEventListener('click', (e)=>{
  const p = e.target.closest('.js-preview'); if(p){ openPreview(p.dataset.url); return; }
  const i = e.target.closest('.js-iframe');  if(i){ const u = i.dataset.url; byId('url').value = withBase(u); gen(); openPreview(u); return; }
  if(e.target.id==='closePrev'){ closePreview(); }
  if(e.target.id==='toGen'){ document.getElementById('generator').scrollIntoView({behavior:'smooth',block:'start'}); }
  if(e.target.id==='btnGen'){ gen(); }
  if(e.target.id==='btnCopy'){ copyCode(); }
  if(e.target.id==='toggleDebug'){
    const box = byId('debugBox');
    box.style.display = (box.style.display==='none'||!box.style.display) ? '' : 'none';
    if(box.style.display!=='none') renderDebug(__lastUrls);
  }
  if(e.target.id==='refreshNow'){
    const key = getSpecKey();
    const cache = readCache(); cache.ts = 0; writeCache(cache); setCacheInfo(null);
    if(key) buildSection(key, true);
  }
});

// ========= –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =========
(async function init(){
  if (window.self !== window.top) document.documentElement.classList.add('embedded');

  const key = getSpecKey();
  if(!key){
    byId('specTitle').textContent = '–í–∏–±–µ—Ä–∏ —Ä–æ–∑–¥—ñ–ª';
    byId('specDesc').textContent  = '–û–±–µ—Ä—ñ—Ç—å –Ω–∞–ø—Ä—è–º —ñ–∑ –ø–µ—Ä–µ–ª—ñ–∫—É –Ω–∏–∂—á–µ.';
    byId('listTitle').textContent = '–î–æ—Å—Ç—É–ø–Ω—ñ —Ä–æ–∑–¥—ñ–ª–∏';
    renderSelector();
    return;
  }

  const meta = SECTION_META[key];
  byId('specTitle').textContent = meta.title;
  byId('specDesc').textContent  = meta.desc;
  byId('listTitle').textContent = meta.title + ' ‚Äî –º–∞—Ç–µ—Ä—ñ–∞–ª–∏';

  await buildSection(key, false);
})();
</script>
</body>
</html>
