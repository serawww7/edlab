<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EDLab ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω—ñ—Ñ–µ—Å—Ç—ñ–≤</title>
<meta name="color-scheme" content="light dark">
<style>
:root{color-scheme:light dark}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#0b1220;color:#e6eef9}
.wrap{max-width:980px;margin:24px auto;padding:0 14px}
h1{font-size:22px;margin:0 0 12px}
.card{border:1px solid #223049;background:#0c182a;border-radius:12px;padding:16px}
label{display:block;margin:10px 0 6px}
input,textarea{width:100%;box-sizing:border-box;background:#0b1220;border:1px solid #223049;color:#e6eef9;border-radius:8px;padding:8px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 260px}
.btn{background:#1b3a6b;color:#e6eef9;border:1px solid #274364;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn:hover{background:#21477f}
small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
.note{background:#0c182a;border:1px dashed #274364;border-radius:10px;padding:10px;margin-top:10px}
.ok{color:#9ef59e}
.err{color:#ffb1b1}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{border-bottom:1px solid #223049;padding:6px 8px;text-align:left;vertical-align:top;word-break:break-all}
.badge{display:inline-block;font-size:12px;border:1px solid #274364;border-radius:999px;padding:2px 8px;margin-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>EDLab ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω—ñ—Ñ–µ—Å—Ç—ñ–≤ <span class="badge">–ø—Ä–∞—Ü—é—î –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ</span></h1>
  <div class="card">
    <div class="row">
      <div class="col">
        <label>GitHub owner</label>
        <input id="owner" value="serawww7">
      </div>
      <div class="col">
        <label>Repo</label>
        <input id="repo" value="edlab">
      </div>
      <div class="col">
        <label>Branch</label>
        <input id="branch" value="main">
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø–∞–ø–∫–∞ —Å–∞–π—Ç—É</label>
        <input id="rootDir" value="edlab">
      </div>
      <div class="col">
        <label>–°–µ–∫—Ü—ñ—ó (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
        <input id="sections" value="coach,elect_II_kyrs,agro_II_kyrs,mech_II_kyrs,tech_II_kyrs">
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>GitHub Token (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ, –∞–ª–µ –∑–Ω—ñ–º–∞—î –ª—ñ–º—ñ—Ç–∏ 60/–≥–æ–¥)</label>
        <input id="token" placeholder="ghp_... –∞–±–æ –ø—É—Å—Ç–æ">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnGen">üîß Generate manifests</button>
    </div>

    <div class="note" id="status">–°—Ç–∞—Ç—É—Å: —á–µ–∫–∞—é –Ω–∞ –∑–∞–ø—É—Å–∫‚Ä¶</div>
    <div id="out"></div>
  </div>
</div>

<script>
// ‚Äî‚Äî‚Äî —É—Ç–∏–ª—ñ—Ç–∞ –∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª–∞
function download(filename, text){
  const blob = new Blob([text], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function log(html){
  const out = document.getElementById('out');
  out.insertAdjacentHTML('beforeend', html);
}
function toTitleFromPath(p){
  const name = (p||'').split('/').pop()||p;
  return name.replace(/[-_]/g,' ').replace(/\.html?$/i,'').trim();
}

async function fetchJson(u, token){
  const headers = token ? {Authorization: `Bearer ${token}`} : {};
  const r = await fetch(u, {headers, cache:'no-store'});
  if(!r.ok){
    const body = await r.text().catch(()=> '');
    throw new Error(`HTTP ${r.status} on ${u}\n${body.slice(0,300)}`);
  }
  return r.json();
}

async function run(){
  const owner = document.getElementById('owner').value.trim();
  const repo  = document.getElementById('repo').value.trim();
  const branch= document.getElementById('branch').value.trim();
  const root  = document.getElementById('rootDir').value.trim().replace(/\/+$/,'');
  const secs  = document.getElementById('sections').value.split(',').map(s=>s.trim()).filter(Boolean);
  const token = document.getElementById('token').value.trim();

  const status = document.getElementById('status');
  status.innerHTML = '–°—Ç–∞—Ç—É—Å: –æ—Ç—Ä–∏–º—É—é SHA –¥–µ—Ä–µ–≤–∞‚Ä¶';

  // 1) sha –¥–µ—Ä–µ–≤–∞
  const brUrl = `https://api.github.com/repos/${owner}/${repo}/branches/${branch}`;
  const br = await fetchJson(brUrl, token);
  const sha = br?.commit?.commit?.tree?.sha;
  if(!sha) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ tree.sha');

  status.innerHTML = '–°—Ç–∞—Ç—É—Å: –≤–∞–Ω—Ç–∞–∂—É –ø–æ–≤–Ω–µ –¥–µ—Ä–µ–≤–æ‚Ä¶';

  // 2) –ø–æ–≤–Ω–µ –¥–µ—Ä–µ–≤–æ
  const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${sha}?recursive=1`;
  const treeResp = await fetchJson(treeUrl, token);
  const tree = Array.isArray(treeResp.tree) ? treeResp.tree : [];

  // 3) –∑—ñ–±—Ä–∞—Ç–∏ —à–ª—è—Ö–∏
  const resultGlobal = {};
  const resultLocal  = {};
  for(const sec of secs){
    const prefix = `${root}/${sec}/`;
    const files = tree
      .filter(n => n.type === 'blob' && n.path.startsWith(prefix) && /\.html?$/i.test(n.path))
      .map(n => '/' + n.path); // –ø—É–±–ª—ñ—á–Ω–∏–π URL

    files.sort((a,b)=>a.localeCompare(b,'uk'));

    resultGlobal[sec] = files;
    resultLocal[sec]  = files;
  }

  // 4) –ø–æ–∫–∞–∑–∞—Ç–∏ –∑–≤–µ–¥–µ–Ω–Ω—è
  const total = Object.values(resultGlobal).reduce((acc,arr)=>acc+arr.length,0);
  status.innerHTML = `‚úÖ –ì–æ—Ç–æ–≤–æ. –ó–Ω–∞–π–¥–µ–Ω–æ HTML: <b>${total}</b> —Ñ–∞–π–ª—ñ–≤. –ó–∞–≤–∞–Ω—Ç–∞–∂ –º–∞–Ω—ñ—Ñ–µ—Å—Ç–∏ –Ω–∏–∂—á–µ —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂ —ó—Ö —É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π.`;

  // 5) –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  const globalJson = JSON.stringify(resultGlobal, null, 2);
  download(`${root}/assets/edlab-manifest.json`, globalJson);
  log(`<div class="note ok"><b>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</b> ${root}/assets/edlab-manifest.json</div>`);

  for(const sec of secs){
    const arr = resultLocal[sec] || [];
    const localJson = JSON.stringify(arr, null, 2);
    download(`${root}/${sec}/manifest.json`, localJson);
    log(`<div class="note ok"><b>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</b> ${root}/${sec}/manifest.json <small class="mono">(${arr.length} —Ñ–∞–π–ª—ñ–≤)</small></div>`);
    if(arr.length){
      const sample = arr.slice(0,5).map(s=>`‚Ä¢ <small class="mono">${s}</small>`).join('<br>');
      log(`<div class="note">${sample}</div>`);
    }
  }

  log(`<div class="note">–î–∞–ª—ñ –∑–∞–π–¥–∏ —É GitHub ‚Üí –ø–∞–ø–∫–∏:<br>
  ‚Äî <b>${root}/assets/</b> ‚Üí –¥–æ–¥–∞–π <code>edlab-manifest.json</code><br>
  ‚Äî <b>${root}/coach/</b> ‚Üí –¥–æ–¥–∞–π <code>manifest.json</code><br>
  ‚Äî <b>${root}/elect_II_kyrs/</b> ‚Üí –¥–æ–¥–∞–π <code>manifest.json</code><br>
  ‚Äî <b>${root}/agro_II_kyrs/</b> ‚Üí –¥–æ–¥–∞–π <code>manifest.json</code><br>
  ‚Äî <b>${root}/mech_II_kyrs/</b> ‚Üí –¥–æ–¥–∞–π <code>manifest.json</code><br>
  ‚Äî <b>${root}/tech_II_kyrs/</b> ‚Üí –¥–æ–¥–∞–π <code>manifest.json</code><br>
  Commit ‚Üí –≤—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫–∏ spec.html?spec=‚Ä¶</div>`);
}

document.getElementById('btnGen').addEventListener('click', async ()=>{
  const status = document.getElementById('status');
  try{
    status.innerHTML = '‚è≥ –ü—Ä–∞—Ü—é—é‚Ä¶';
    document.getElementById('out').innerHTML = '';
    await run();
  }catch(e){
    status.innerHTML = `<span class="err">‚ùå –ü–æ–º–∏–ª–∫–∞:</span> <pre class="mono" style="white-space:pre-wrap">${e?.message||e}</pre>`;
  }
});
</script>
</body>
</html>
