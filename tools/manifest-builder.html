<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EDLab ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω—ñ—Ñ–µ—Å—Ç—ñ–≤ (–∞–≤—Ç–æ–ø—Ä–µ—Ñ—ñ–∫—Å)</title>
<meta name="color-scheme" content="light dark">
<style>
:root{color-scheme:light dark}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#0b1220;color:#e6eef9}
.wrap{max-width:980px;margin:24px auto;padding:0 14px}
h1{font-size:22px;margin:0 0 12px}
.card{border:1px solid #223049;background:#0c182a;border-radius:12px;padding:16px}
label{display:block;margin:10px 0 6px}
input{width:100%;box-sizing:border-box;background:#0b1220;border:1px solid #223049;color:#e6eef9;border-radius:8px;padding:8px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 260px}
.btn{background:#1b3a6b;color:#e6eef9;border:1px solid #274364;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn:hover{background:#21477f}
small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
.note{background:#0c182a;border:1px dashed #274364;border-radius:10px;padding:10px;margin-top:10px}
.ok{color:#9ef59e}
.err{color:#ffb1b1}
pre.dump{max-height:260px;overflow:auto;background:#0b1220;border:1px solid #223049;border-radius:10px;padding:10px}
.badge{display:inline-block;font-size:12px;border:1px solid #274364;border-radius:999px;padding:2px 8px;margin-left:8px}
.kv{display:grid;grid-template-columns:160px 1fr;gap:6px}
.kv b{color:#a8d1ff}
</style>
</head>
<body>
<div class="wrap">
  <h1>EDLab ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω—ñ—Ñ–µ—Å—Ç—ñ–≤ <span class="badge">–∞–≤—Ç–æ–ø—Ä–µ—Ñ—ñ–∫—Å + –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</span></h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>GitHub owner</label>
        <input id="owner" value="serawww7">
      </div>
      <div class="col">
        <label>Repo</label>
        <input id="repo" value="edlab">
      </div>
      <div class="col">
        <label>Branch</label>
        <input id="branch" value="main">
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>–°–µ–∫—Ü—ñ—ó (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
        <input id="sections" value="coach,elect_II_kyrs,agro_II_kyrs,mech_II_kyrs,tech_II_kyrs">
      </div>
      <div class="col">
        <label>GitHub Token (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)</label>
        <input id="token" placeholder="ghp_... –∞–±–æ github_pat_...">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnGen">üîß Generate manifests</button>
      <button class="btn" id="btnOnlyScan">üëÄ –õ–∏—à–µ —Å–∫–∞–Ω –¥–µ—Ä–µ–≤–∞ (–±–µ–∑ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)</button>
    </div>

    <div class="note" id="status">–°—Ç–∞—Ç—É—Å: —á–µ–∫–∞—é –Ω–∞ –∑–∞–ø—É—Å–∫‚Ä¶</div>
    <div id="diag" class="note" style="display:none">
      <div class="kv">
        <b>–ó–Ω–∞–π–¥–µ–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å:</b><span id="pf"></span>
        <b>–ú–∞—Ç—á—ñ (—Å–µ–∫—Ü—ñ—ó):</b><span id="hits"></span>
        <b>–£—Å—å–æ–≥–æ HTML:</b><span id="total"></span>
      </div>
      <div style="margin-top:8px"><b>–ü–µ—Ä—à—ñ 200 —à–ª—è—Ö—ñ–≤ —É –¥–µ—Ä–µ–≤—ñ (–¥–ª—è –¥–µ–±–∞–≥—É):</b></div>
      <pre class="dump" id="dump"></pre>
    </div>

    <div id="out"></div>
  </div>
</div>

<script>
function download(filename, text){
  const blob = new Blob([text], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function txt(x){ return document.createTextNode(x); }
function el(id){ return document.getElementById(id); }

async function fetchJson(u, token){
  const headers = token ? {Authorization: `Bearer ${token}`} : {};
  const r = await fetch(u, {headers, cache:'no-store'});
  if(!r.ok){
    const body = await r.text().catch(()=> '');
    throw new Error(`HTTP ${r.status} on ${u}\n${body.slice(0,500)}`);
  }
  return r.json();
}

// –ê–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–µ—Ñ—ñ–∫—Å–∞: '' –∞–±–æ 'edlab/'
function detectPrefix(tree, sections){
  const cand = ['', 'edlab/'];
  const report = [];
  for(const p of cand){
    let hits = 0;
    for(const s of sections){
      const pref = `${p}${s}/`;
      if (tree.some(n => n.type==='blob' && n.path.startsWith(pref))) hits++;
    }
    report.push({prefix:p, hits});
  }
  // –≤–∏–±–∏—Ä–∞—î–º–æ –∑ –Ω–∞–π–±—ñ–ª—å—à–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –∑–±—ñ–≥—ñ–≤
  report.sort((a,b)=>b.hits - a.hits);
  return {prefix: report[0].prefix, report};
}

function buildLists(tree, prefix, sections){
  const global = {}; let total=0;
  for(const s of sections){
    const matchPrefix = `${prefix}${s}/`;
    const files = tree
      .filter(n => n.type==='blob' && n.path.startsWith(matchPrefix) && /\.html?$/i.test(n.path))
      .map(n => '/' + n.path);
    files.sort((a,b)=>a.localeCompare(b,'uk'));
    global[s] = files;
    total += files.length;
  }
  return {global,total};
}

async function scan(onlyScan=false){
  const owner = el('owner').value.trim();
  const repo  = el('repo').value.trim();
  const branch= el('branch').value.trim();
  const secs  = el('sections').value.split(',').map(s=>s.trim()).filter(Boolean);
  const token = el('token').value.trim();

  el('status').innerHTML = '–°—Ç–∞—Ç—É—Å: –æ—Ç—Ä–∏–º—É—é SHA –¥–µ—Ä–µ–≤–∞‚Ä¶';
  el('diag').style.display='none'; el('out').innerHTML='';

  const brUrl = `https://api.github.com/repos/${owner}/${repo}/branches/${branch}`;
  const br = await fetchJson(brUrl, token);
  const sha = br?.commit?.commit?.tree?.sha;
  if(!sha) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ tree.sha');

  el('status').innerHTML = '–°—Ç–∞—Ç—É—Å: –≤–∞–Ω—Ç–∞–∂—É –ø–æ–≤–Ω–µ –¥–µ—Ä–µ–≤–æ‚Ä¶';

  const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${sha}?recursive=1`;
  const treeResp = await fetchJson(treeUrl, token);
  const tree = Array.isArray(treeResp.tree) ? treeResp.tree : [];

  // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø–æ–∫–∞–∂–µ–º–æ –ø–µ—Ä—à—ñ 200 —à–ª—è—Ö—ñ–≤
  const sample = tree.slice(0,200).map(n=>n.path).join('\n');

  // –ê–≤—Ç–æ–ø—Ä–µ—Ñ—ñ–∫—Å
  const {prefix, report} = detectPrefix(tree, secs);
  const {global,total}   = buildLists(tree, prefix, secs);

  // –ü–æ–∫–∞–∑–∞—Ç–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É
  el('pf').textContent   = prefix || '(–ø–æ—Ä–æ–∂–Ω—å–æ)';
  el('hits').textContent = report.map(r=>`${r.prefix||'(–ø–æ—Ä–æ–∂.)'}: ${r.hits}`).join('  |  ');
  el('total').textContent= String(total);
  el('dump').textContent = sample;
  el('diag').style.display='';

  el('status').innerHTML = total>0
    ? `‚úÖ –ì–æ—Ç–æ–≤–æ. –ó–Ω–∞–π–¥–µ–Ω–æ HTML: <b>${total}</b> —Ñ–∞–π–ª—ñ–≤.`
    : `‚ö†Ô∏è HTML-—Ñ–∞–π–ª—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º). –ü–µ—Ä–µ–≤—ñ—Ä —Å–ø–∏—Å–æ–∫ —à–ª—è—Ö—ñ–≤ —É –¥–∞–º–ø—ñ –≤–∏—â–µ ‚Äî —á–∏ –±–∞—á–∏—à —Ç–∞–º, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "coach/..." –∞–±–æ "edlab/coach/..."?`;

  if (onlyScan) return;

  // –ì–ª–æ–±–∞–ª—å–Ω–∏–π JSON
  const globalJson = JSON.stringify(global, null, 2);
  download(`assets/edlab-manifest.json`, globalJson);
  el('out').insertAdjacentHTML('beforeend', `<div class="note ok"><b>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</b> /assets/edlab-manifest.json</div>`);

  // –õ–æ–∫–∞–ª—å–Ω—ñ JSON
  for(const s of secs){
    const arr = global[s] || [];
    const localJson = JSON.stringify(arr, null, 2);
    download(`${s}/manifest.json`, localJson);
    el('out').insertAdjacentHTML('beforeend', `<div class="note ok"><b>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</b> /${s}/manifest.json <small class="mono">(${arr.length} —Ñ–∞–π–ª—ñ–≤)</small></div>`);
  }

  el('out').insertAdjacentHTML('beforeend', `<div class="note">–î–∞–ª—ñ –∑–∞–π–¥–∏ –≤ GitHub —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª–∏ —Å–∞–º–µ —É —Ü—ñ –ø–∞–ø–∫–∏:
  <br>‚Äî <b>edlab/assets/</b> ‚Üí <code>edlab-manifest.json</code>
  <br>‚Äî <b>edlab/coach/</b> ‚Üí <code>manifest.json</code>
  <br>‚Äî <b>edlab/elect_II_kyrs/</b> ‚Üí <code>manifest.json</code>
  <br>‚Äî <b>edlab/agro_II_kyrs/</b> ‚Üí <code>manifest.json</code>
  <br>‚Äî <b>edlab/mech_II_kyrs/</b> ‚Üí <code>manifest.json</code>
  <br>‚Äî <b>edlab/tech_II_kyrs/</b> ‚Üí <code>manifest.json</code>
  <br>–ü–æ—Ç—ñ–º –≤—ñ–¥–∫—Ä–∏–π <code>https://edlab.pp.ua/edlab/spec.html?spec=...</code> —ñ, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏, –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫¬ª.</div>`);
}

el('btnGen').addEventListener('click', async ()=>{
  try{ await scan(false); }catch(e){
    el('status').innerHTML = `<span class="err">‚ùå –ü–æ–º–∏–ª–∫–∞:</span> <pre class="mono" style="white-space:pre-wrap">${e?.message||e}</pre>`;
  }
});
el('btnOnlyScan').addEventListener('click', async ()=>{
  try{ await scan(true); }catch(e){
    el('status').innerHTML = `<span class="err">‚ùå –ü–æ–º–∏–ª–∫–∞:</span> <pre class="mono" style="white-space:pre-wrap">${e?.message||e}</pre>`;
  }
});
</script>
</body>
</html>
